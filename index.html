<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tavola - Mediterranean Meal Planning</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Dancing+Script:wght@600;700&family=Lora:wght@400;500;600&family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">
    <style>
        :root {
            --cerulean: #007BA7;
            --cerulean-dark: #006691;
            --cerulean-light: #3399bf;
            --seafoam: #7FD8BE;
            --seafoam-light: #b8e8d8;
            --seafoam-dark: #5cb89a;
            --navy: #1A2332;
            --cream: #FFF8E7;
            --white: #FFFFFF;
            --gray-light: #f5f5f5;
            --gray-medium: #e0e0e0;
            --gray-text: #666;
            --warning: #d4a574;
            --danger: #cc4444;
            --success: #4caf50;
            --shadow: 0 2px 8px rgba(26, 35, 50, 0.08);
            --shadow-lg: 0 4px 16px rgba(26, 35, 50, 0.12);
            --radius: 12px;
            --radius-sm: 8px;
            --radius-lg: 16px;
        }

        .dark-mode {
            --cream: #1A1A1A;
            --white: #2A2A2A;
            --navy: #E8E8E8;
            --gray-light: #333;
            --gray-medium: #444;
            --gray-text: #aaa;
            --cerulean: #3399bf;
            --shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
            --shadow-lg: 0 4px 16px rgba(0, 0, 0, 0.4);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background-color: var(--cream);
            color: var(--navy);
            line-height: 1.6;
            min-height: 100vh;
            padding-bottom: 80px;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            padding: 0 16px;
        }

        /* Typography */
        h1, h2, h3 { font-family: 'Lora', serif; font-weight: 500; }
        .logo { font-family: 'Dancing Script', cursive; font-size: 2rem; font-weight: 700; color: var(--cerulean); text-decoration: none; }

        /* Header */
        .header {
            background: var(--white);
            border-bottom: 1px solid var(--gray-medium);
            padding: 12px 0;
            position: sticky;
            top: 0;
            z-index: 100;
        }
        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .header-right {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .icon-btn {
            background: none;
            border: none;
            padding: 8px;
            border-radius: var(--radius-sm);
            cursor: pointer;
            color: var(--navy);
            font-size: 1.2rem;
            transition: background 0.2s;
        }
        .icon-btn:hover { background: var(--gray-light); }

        /* Bottom Navigation */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--white);
            border-top: 1px solid var(--gray-medium);
            display: flex;
            justify-content: space-around;
            padding: 8px 0 max(8px, env(safe-area-inset-bottom));
            z-index: 100;
        }
        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 6px 12px;
            border: none;
            background: none;
            color: var(--gray-text);
            font-size: 0.7rem;
            font-family: inherit;
            cursor: pointer;
            border-radius: var(--radius-sm);
            transition: all 0.2s;
            min-width: 60px;
        }
        .nav-item span.icon { font-size: 1.3rem; margin-bottom: 2px; }
        .nav-item.active { color: var(--cerulean); background: var(--seafoam-light); }
        .nav-item:hover:not(.active) { background: var(--gray-light); }

        /* Buttons */
        .btn {
            padding: 12px 24px;
            border-radius: var(--radius);
            font-family: inherit;
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            border: none;
            min-height: 44px;
        }
        .btn-primary { background: var(--cerulean); color: white; }
        .btn-primary:hover { background: var(--cerulean-dark); }
        .btn-secondary { background: var(--white); color: var(--cerulean); border: 2px solid var(--cerulean); }
        .btn-secondary:hover { background: var(--seafoam-light); }
        .btn-ghost { background: transparent; color: var(--cerulean); }
        .btn-ghost:hover { background: var(--seafoam-light); }
        .btn-sm { padding: 8px 16px; font-size: 0.9rem; }
        .btn-icon { padding: 10px; min-width: 44px; display: flex; align-items: center; justify-content: center; }

        /* Cards */
        .card {
            background: var(--white);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            padding: 20px;
            margin-bottom: 16px;
        }
        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }
        .card-title { font-size: 1.1rem; color: var(--cerulean); }

        /* Forms */
        .form-group { margin-bottom: 16px; }
        .form-group label { display: block; font-weight: 500; margin-bottom: 6px; font-size: 0.95rem; }
        .form-input, .form-select, .form-textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--gray-medium);
            border-radius: var(--radius-sm);
            font-family: inherit;
            font-size: 1rem;
            color: var(--navy);
            background: var(--white);
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        .form-input:focus, .form-select:focus, .form-textarea:focus {
            outline: none;
            border-color: var(--cerulean);
            box-shadow: 0 0 0 3px rgba(0, 123, 167, 0.15);
        }
        .form-textarea { min-height: 80px; resize: vertical; }
        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
        @media (max-width: 600px) { .form-row { grid-template-columns: 1fr; } }

        /* Checkbox & Radio */
        .checkbox-item, .radio-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 0;
            cursor: pointer;
        }
        .checkbox-item input, .radio-item input {
            width: 20px;
            height: 20px;
            accent-color: var(--cerulean);
            cursor: pointer;
        }

        /* Tags */
        .tag {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 500;
            background: var(--seafoam-light);
            color: var(--navy);
            margin-right: 6px;
            margin-bottom: 6px;
        }
        .tag-crohns { background: #e8f5e9; color: #2e7d32; }
        .tag-quick { background: #fff3e0; color: #ef6c00; }
        .tag-mediterranean { background: #e3f2fd; color: #1565c0; }

        /* Sections */
        .section { padding: 20px 0; }
        .section-title {
            font-family: 'Lora', serif;
            font-size: 1.4rem;
            color: var(--cerulean);
            margin-bottom: 16px;
            padding-bottom: 8px;
            border-bottom: 2px solid var(--seafoam);
        }

        /* Views - hide all by default */
        .view { display: none; }
        .view.active { display: block; }

        /* Welcome Screen */
        .welcome-screen {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: calc(100vh - 100px);
            text-align: center;
            padding: 40px 20px;
        }
        .welcome-logo { font-family: 'Dancing Script', cursive; font-size: 4rem; color: var(--cerulean); margin-bottom: 8px; }
        .welcome-subtitle { font-family: 'Lora', serif; font-size: 1.3rem; color: var(--navy); margin-bottom: 8px; }
        .welcome-tagline { color: var(--gray-text); margin-bottom: 32px; max-width: 400px; }

        /* Chat Interface */
        .chat-container { display: flex; flex-direction: column; height: calc(100vh - 140px); }
        .chat-messages { flex: 1; overflow-y: auto; padding: 16px 0; }
        .message { margin-bottom: 16px; animation: fadeIn 0.3s ease; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .message-user { display: flex; justify-content: flex-end; }
        .message-user .message-bubble {
            background: var(--seafoam);
            color: var(--navy);
            border-radius: var(--radius) var(--radius) 4px var(--radius);
            max-width: 85%;
            padding: 12px 16px;
        }
        .message-assistant { display: flex; justify-content: flex-start; }
        .message-assistant .message-bubble {
            background: var(--white);
            border: 1px solid var(--seafoam);
            border-radius: var(--radius) var(--radius) var(--radius) 4px;
            max-width: 90%;
            padding: 16px;
            box-shadow: var(--shadow);
        }
        .chat-input-area {
            background: var(--white);
            border-top: 1px solid var(--gray-medium);
            padding: 12px 0;
        }
        .chat-input-wrapper {
            display: flex;
            gap: 8px;
            align-items: flex-end;
        }
        .chat-input {
            flex: 1;
            border: 1px solid var(--gray-medium);
            border-radius: var(--radius);
            padding: 12px;
            font-family: inherit;
            font-size: 1rem;
            resize: none;
            min-height: 48px;
            max-height: 120px;
        }
        .chat-input:focus { outline: none; border-color: var(--cerulean); }
        .voice-btn {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            border: none;
            background: var(--gray-light);
            color: var(--navy);
            font-size: 1.3rem;
            cursor: pointer;
            transition: all 0.2s;
        }
        .voice-btn:hover { background: var(--gray-medium); }
        .voice-btn.recording { background: var(--danger); color: white; animation: pulse 1s infinite; }
        @keyframes pulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.05); } }
        .send-btn {
            width: 48px;
            height: 48px;
            border-radius: var(--radius);
            border: none;
            background: var(--cerulean);
            color: white;
            font-size: 1.2rem;
            cursor: pointer;
            transition: background 0.2s;
        }
        .send-btn:hover { background: var(--cerulean-dark); }
        .send-btn:disabled { opacity: 0.5; cursor: not-allowed; }

        /* Quick Actions */
        .quick-actions {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 12px;
        }
        .quick-action {
            background: var(--white);
            border: 1px solid var(--seafoam);
            padding: 8px 14px;
            border-radius: 20px;
            font-size: 0.85rem;
            color: var(--navy);
            cursor: pointer;
            transition: all 0.2s;
        }
        .quick-action:hover { background: var(--seafoam-light); border-color: var(--cerulean); }

        /* Thinking Animation */
        .thinking { display: flex; align-items: center; gap: 8px; color: var(--gray-text); font-style: italic; padding: 12px 16px; }
        .thinking-dots { display: flex; gap: 4px; }
        .thinking-dots span {
            width: 6px; height: 6px;
            background: var(--cerulean);
            border-radius: 50%;
            animation: bounce 1.4s infinite ease-in-out;
        }
        .thinking-dots span:nth-child(1) { animation-delay: 0s; }
        .thinking-dots span:nth-child(2) { animation-delay: 0.2s; }
        .thinking-dots span:nth-child(3) { animation-delay: 0.4s; }
        @keyframes bounce { 0%, 80%, 100% { transform: scale(0.8); opacity: 0.5; } 40% { transform: scale(1); opacity: 1; } }

        /* Recipe Card */
        .recipe-card {
            background: var(--white);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-lg);
            overflow: hidden;
            margin: 16px 0;
        }
        .recipe-header {
            background: linear-gradient(135deg, var(--cerulean) 0%, var(--seafoam-dark) 100%);
            color: white;
            padding: 20px;
            position: relative;
        }
        .recipe-title { font-family: 'Lora', serif; font-size: 1.5rem; margin-bottom: 8px; }
        .recipe-actions {
            position: absolute;
            top: 12px;
            right: 12px;
            display: flex;
            gap: 8px;
        }
        .recipe-action-btn {
            background: rgba(255,255,255,0.2);
            border: none;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            color: white;
            cursor: pointer;
            transition: background 0.2s;
            font-size: 1rem;
        }
        .recipe-action-btn:hover { background: rgba(255,255,255,0.3); }
        .recipe-action-btn.favorited { background: var(--danger); }
        .recipe-meta {
            display: flex;
            flex-wrap: wrap;
            gap: 16px;
            margin-top: 12px;
            font-size: 0.9rem;
        }
        .recipe-meta-item { display: flex; align-items: center; gap: 4px; }
        .recipe-tags { padding: 12px 20px; background: var(--gray-light); }
        .recipe-body { padding: 20px; }
        .recipe-section { margin-bottom: 24px; }
        .recipe-section-title {
            font-family: 'Lora', serif;
            font-size: 1.1rem;
            color: var(--cerulean);
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .ingredient-item {
            display: flex;
            align-items: flex-start;
            gap: 10px;
            padding: 8px 0;
            border-bottom: 1px solid var(--gray-light);
        }
        .ingredient-item:last-child { border-bottom: none; }
        .ingredient-checkbox {
            width: 22px;
            height: 22px;
            accent-color: var(--cerulean);
            cursor: pointer;
            flex-shrink: 0;
            margin-top: 2px;
        }
        .ingredient-text.checked { text-decoration: line-through; color: var(--gray-text); }
        .instruction-step {
            display: flex;
            gap: 12px;
            padding: 12px 0;
            border-bottom: 1px solid var(--gray-light);
        }
        .instruction-step:last-child { border-bottom: none; }
        .step-number {
            width: 28px;
            height: 28px;
            background: var(--cerulean);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 0.9rem;
            flex-shrink: 0;
        }
        .recipe-notes {
            background: var(--seafoam-light);
            border-radius: var(--radius);
            padding: 16px;
            margin-top: 16px;
        }
        .recipe-notes-title { font-weight: 600; margin-bottom: 8px; color: var(--cerulean); }

        /* Nonna's Tip */
        .nonna-tip {
            background: linear-gradient(135deg, var(--cream) 0%, var(--seafoam-light) 100%);
            border-left: 4px solid var(--cerulean);
            border-radius: 0 var(--radius) var(--radius) 0;
            padding: 16px;
            margin: 16px 0;
        }
        .nonna-tip-header { display: flex; align-items: center; gap: 8px; margin-bottom: 8px; font-weight: 600; color: var(--cerulean); }
        .nonna-tip-text { font-style: italic; color: var(--navy); }
        .nonna-tip-signature { text-align: right; margin-top: 8px; color: var(--gray-text); font-size: 0.9rem; }

        /* Tabs */
        .tabs {
            display: flex;
            gap: 4px;
            background: var(--gray-light);
            padding: 4px;
            border-radius: var(--radius);
            margin-bottom: 16px;
            overflow-x: auto;
        }
        .tab {
            flex: 1;
            padding: 10px 16px;
            border: none;
            background: transparent;
            font-family: inherit;
            font-size: 0.9rem;
            font-weight: 500;
            color: var(--gray-text);
            cursor: pointer;
            border-radius: var(--radius-sm);
            white-space: nowrap;
            transition: all 0.2s;
        }
        .tab.active { background: var(--white); color: var(--cerulean); box-shadow: var(--shadow); }
        .tab:hover:not(.active) { color: var(--navy); }
        .tab-content { display: none; }
        .tab-content.active { display: block; }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 48px 24px;
            color: var(--gray-text);
        }
        .empty-state-icon { font-size: 3rem; margin-bottom: 16px; }
        .empty-state-title { font-family: 'Lora', serif; font-size: 1.2rem; color: var(--navy); margin-bottom: 8px; }

        /* Grid */
        .grid { display: grid; gap: 16px; }
        .grid-2 { grid-template-columns: repeat(2, 1fr); }
        .grid-3 { grid-template-columns: repeat(3, 1fr); }
        @media (max-width: 768px) { .grid-2, .grid-3 { grid-template-columns: 1fr; } }

        /* Favorites Card */
        .favorite-card {
            background: var(--white);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            overflow: hidden;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .favorite-card:hover { transform: translateY(-2px); box-shadow: var(--shadow-lg); }
        .favorite-card-banner {
            height: 80px;
            background: linear-gradient(135deg, var(--cerulean) 0%, var(--seafoam-dark) 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
        }
        .favorite-card-body { padding: 12px; }
        .favorite-card-title { font-weight: 600; font-size: 0.95rem; margin-bottom: 4px; }
        .favorite-card-meta { font-size: 0.8rem; color: var(--gray-text); }
        .favorite-card-rating { color: #ffc107; font-size: 0.85rem; }

        /* Pantry Item */
        .pantry-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            background: var(--white);
            border-radius: var(--radius-sm);
            margin-bottom: 8px;
            box-shadow: var(--shadow);
        }
        .pantry-item-icon { font-size: 1.5rem; }
        .pantry-item-info { flex: 1; }
        .pantry-item-name { font-weight: 500; }
        .pantry-item-qty { font-size: 0.85rem; color: var(--gray-text); }
        .pantry-status { width: 10px; height: 10px; border-radius: 50%; }
        .pantry-status.fresh { background: var(--success); }
        .pantry-status.soon { background: #ffc107; }
        .pantry-status.expiring { background: var(--danger); }

        /* Shopping List */
        .shopping-section { margin-bottom: 20px; }
        .shopping-section-title {
            font-weight: 600;
            color: var(--cerulean);
            padding: 8px 0;
            border-bottom: 1px solid var(--gray-medium);
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .shopping-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 10px 0;
            border-bottom: 1px solid var(--gray-light);
        }
        .shopping-item.checked { opacity: 0.5; }
        .shopping-item.checked .shopping-item-name { text-decoration: line-through; }
        .shopping-item-checkbox { width: 22px; height: 22px; accent-color: var(--cerulean); }
        .shopping-item-name { flex: 1; }
        .shopping-item-qty { color: var(--gray-text); font-size: 0.9rem; }

        /* Week Planner */
        .week-day {
            background: var(--white);
            border-radius: var(--radius);
            padding: 16px;
            margin-bottom: 12px;
            box-shadow: var(--shadow);
        }
        .week-day-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }
        .week-day-name { font-weight: 600; color: var(--cerulean); }
        .week-day-date { font-size: 0.85rem; color: var(--gray-text); }
        .week-day-meal {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            background: var(--gray-light);
            border-radius: var(--radius-sm);
        }
        .week-day-empty {
            padding: 24px;
            text-align: center;
            color: var(--gray-text);
            border: 2px dashed var(--gray-medium);
            border-radius: var(--radius-sm);
            cursor: pointer;
        }
        .week-day-empty:hover { border-color: var(--cerulean); color: var(--cerulean); }

        /* Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(26, 35, 50, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 20px;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s, visibility 0.3s;
        }
        .modal-overlay.active { opacity: 1; visibility: visible; }
        .modal {
            background: var(--white);
            border-radius: var(--radius-lg);
            width: 100%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: var(--shadow-lg);
        }
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 20px;
            border-bottom: 1px solid var(--gray-medium);
        }
        .modal-title { font-family: 'Lora', serif; font-size: 1.2rem; }
        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            color: var(--gray-text);
            cursor: pointer;
            padding: 4px;
        }
        .modal-body { padding: 20px; }
        .modal-footer {
            padding: 16px 20px;
            border-top: 1px solid var(--gray-medium);
            display: flex;
            justify-content: flex-end;
            gap: 12px;
        }

        /* Toggle Switch */
        .toggle {
            display: flex;
            align-items: center;
            gap: 12px;
            cursor: pointer;
        }
        .toggle-switch {
            width: 50px;
            height: 28px;
            background: var(--gray-medium);
            border-radius: 14px;
            position: relative;
            transition: background 0.3s;
        }
        .toggle-switch::after {
            content: '';
            position: absolute;
            top: 3px;
            left: 3px;
            width: 22px;
            height: 22px;
            background: white;
            border-radius: 50%;
            transition: transform 0.3s;
        }
        .toggle input { display: none; }
        .toggle input:checked + .toggle-switch { background: var(--cerulean); }
        .toggle input:checked + .toggle-switch::after { transform: translateX(22px); }

        /* Flare Mode Banner */
        .flare-banner {
            background: linear-gradient(135deg, #fff3e0 0%, #ffecb3 100%);
            border-left: 4px solid #ff9800;
            padding: 16px;
            margin-bottom: 16px;
            border-radius: 0 var(--radius) var(--radius) 0;
        }
        .flare-banner-title { font-weight: 600; color: #e65100; margin-bottom: 4px; }
        .flare-banner-text { font-size: 0.9rem; color: #bf360c; }

        /* Accordion */
        .accordion-item { border: 1px solid var(--gray-medium); border-radius: var(--radius-sm); margin-bottom: 8px; overflow: hidden; }
        .accordion-header {
            padding: 14px 16px;
            background: var(--gray-light);
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: 500;
        }
        .accordion-header:hover { background: var(--gray-medium); }
        .accordion-icon { transition: transform 0.3s; }
        .accordion-item.open .accordion-icon { transform: rotate(180deg); }
        .accordion-body { padding: 16px; display: none; }
        .accordion-item.open .accordion-body { display: block; }

        /* Utilities */
        .hidden { display: none !important; }
        .text-center { text-align: center; }
        .text-muted { color: var(--gray-text); }
        .mb-0 { margin-bottom: 0; }
        .mb-8 { margin-bottom: 8px; }
        .mb-16 { margin-bottom: 16px; }
        .mt-16 { margin-top: 16px; }
        .flex { display: flex; }
        .flex-between { justify-content: space-between; }
        .flex-center { align-items: center; }
        .gap-8 { gap: 8px; }
        .gap-16 { gap: 16px; }

        /* Print Styles */
        @media print {
            .header, .bottom-nav, .chat-input-area, .recipe-actions, .btn { display: none !important; }
            body { padding: 0; background: white; }
            .recipe-card { box-shadow: none; border: 1px solid #ddd; }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="header hidden" id="app-header">
        <div class="container header-content">
            <a href="#" class="logo" onclick="navigateTo('home'); return false;">Tavola</a>
            <div class="header-right">
                <button class="icon-btn" onclick="navigateTo('settings')" title="Settings">‚öôÔ∏è</button>
            </div>
        </div>
    </header>

    <!-- Welcome Screen -->
    <main class="welcome-screen" id="welcome-screen">
        <h1 class="welcome-logo">Tavola</h1>
        <p class="welcome-subtitle">Mediterranean Meal Planning</p>
        <p class="welcome-tagline">Gentle, delicious meals designed for your health. Meet Nonna, your personal cooking companion.</p>
        <button class="btn btn-primary" onclick="showIntakeForm()">Get Started</button>
    </main>

    <!-- Intake Form -->
    <main class="view" id="intake-form">
        <div class="container section">
            <div class="text-center mb-16">
                <h1 class="section-title" style="border: none; text-align: center;">Let's Get to Know You</h1>
                <p class="text-muted">This helps Nonna suggest meals that work for your body</p>
            </div>
            <form id="profile-form" onsubmit="saveProfile(event)">
                <!-- Health Conditions -->
                <div class="card">
                    <h2 class="card-title">ü©∫ Health Conditions</h2>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Crohn's Severity</label>
                            <select class="form-select" name="crohnsSeverity">
                                <option value="">Select...</option>
                                <option value="mild">Mild</option>
                                <option value="moderate">Moderate</option>
                                <option value="severe">Severe</option>
                                <option value="remission">In Remission</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Crohn's Triggers</label>
                            <input type="text" class="form-input" name="crohnsTriggers" placeholder="e.g., raw veggies, nuts, dairy">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Fibromyalgia Energy</label>
                            <select class="form-select" name="fibroEnergy">
                                <option value="">Select...</option>
                                <option value="low">Low</option>
                                <option value="moderate">Moderate</option>
                                <option value="variable">Variable</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Thyroid Condition</label>
                            <input type="text" class="form-input" name="thyroidType" placeholder="e.g., Hashimoto's">
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Other Conditions or Notes</label>
                        <textarea class="form-textarea" name="otherConditions" placeholder="Anything else Nonna should know..."></textarea>
                    </div>
                </div>

                <!-- Cooking for Two -->
                <div class="card">
                    <h2 class="card-title">üë• Cooking for Two</h2>
                    <label class="toggle mb-16">
                        <input type="checkbox" name="cookingForTwo" id="cookingForTwoToggle" onchange="toggleCookingForTwo()">
                        <span class="toggle-switch"></span>
                        <span>I'm cooking for someone else too</span>
                    </label>
                    <div id="cookingForTwoFields" class="hidden">
                        <div class="form-group">
                            <label>Their Name or Relationship</label>
                            <input type="text" class="form-input" name="partnerName" placeholder="e.g., John, Partner, Mom">
                        </div>
                        <div class="form-group">
                            <label>Their Dietary Restrictions</label>
                            <div class="grid grid-2">
                                <label class="checkbox-item"><input type="checkbox" name="partnerRestrictions" value="diabetes"> Diabetes</label>
                                <label class="checkbox-item"><input type="checkbox" name="partnerRestrictions" value="heart"> Heart Disease</label>
                                <label class="checkbox-item"><input type="checkbox" name="partnerRestrictions" value="glutenFree"> Gluten-Free</label>
                                <label class="checkbox-item"><input type="checkbox" name="partnerRestrictions" value="lactose"> Lactose Intolerant</label>
                                <label class="checkbox-item"><input type="checkbox" name="partnerRestrictions" value="vegetarian"> Vegetarian</label>
                                <label class="checkbox-item"><input type="checkbox" name="partnerRestrictions" value="none"> No Restrictions</label>
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Their Allergies</label>
                            <input type="text" class="form-input" name="partnerAllergies" placeholder="e.g., shellfish, tree nuts">
                        </div>
                        <div class="form-group">
                            <label>Foods They Love</label>
                            <input type="text" class="form-input" name="partnerLoves" placeholder="e.g., spicy food, cheese, garlic">
                        </div>
                    </div>
                </div>

                <!-- Protein Preferences -->
                <div class="card">
                    <h2 class="card-title">ü•© Protein Preferences</h2>
                    <p class="text-muted mb-16">Check all proteins you eat</p>
                    <div class="grid grid-2">
                        <label class="checkbox-item"><input type="checkbox" name="proteins" value="white-fish"> White Fish</label>
                        <label class="checkbox-item"><input type="checkbox" name="proteins" value="fatty-fish"> Fatty Fish (salmon)</label>
                        <label class="checkbox-item"><input type="checkbox" name="proteins" value="shellfish"> Shellfish</label>
                        <label class="checkbox-item"><input type="checkbox" name="proteins" value="chicken"> Chicken</label>
                        <label class="checkbox-item"><input type="checkbox" name="proteins" value="turkey"> Turkey</label>
                        <label class="checkbox-item"><input type="checkbox" name="proteins" value="pork"> Pork</label>
                        <label class="checkbox-item"><input type="checkbox" name="proteins" value="beef"> Beef</label>
                        <label class="checkbox-item"><input type="checkbox" name="proteins" value="lamb"> Lamb</label>
                        <label class="checkbox-item"><input type="checkbox" name="proteins" value="eggs"> Eggs</label>
                        <label class="checkbox-item"><input type="checkbox" name="proteins" value="legumes"> Legumes</label>
                        <label class="checkbox-item"><input type="checkbox" name="proteins" value="tofu"> Tofu/Tempeh</label>
                        <label class="checkbox-item"><input type="checkbox" name="proteins" value="dairy"> Greek Yogurt/Cheese</label>
                    </div>
                </div>

                <!-- Garden -->
                <div class="card">
                    <h2 class="card-title">üå± Your Garden</h2>
                    <div class="form-group">
                        <label>What's Currently Growing?</label>
                        <textarea class="form-textarea" name="currentlyGrowing" placeholder="e.g., tomatoes, zucchini, basil, peppers..."></textarea>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Growing Zone</label>
                            <input type="text" class="form-input" name="growingZone" placeholder="e.g., 7b">
                        </div>
                        <div class="form-group">
                            <label>Current Season</label>
                            <select class="form-select" name="currentSeason">
                                <option value="spring">Spring</option>
                                <option value="summer">Summer</option>
                                <option value="fall">Fall</option>
                                <option value="winter">Winter</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Cooking Capacity -->
                <div class="card">
                    <h2 class="card-title">‚è∞ Cooking Capacity</h2>
                    <div class="form-group">
                        <label>Energy Level for Cooking</label>
                        <select class="form-select" name="energyLevel">
                            <option value="low">Low (simple meals)</option>
                            <option value="moderate">Moderate</option>
                            <option value="good">Good</option>
                            <option value="variable" selected>Variable (changes daily)</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Preferred Cooking Time</label>
                        <select class="form-select" name="cookingTime">
                            <option value="quick">Quick (15-30 min)</option>
                            <option value="standard" selected>Standard (30-60 min)</option>
                            <option value="batch">Batch Cooking</option>
                        </select>
                    </div>
                </div>

                <!-- Budget -->
                <div class="card">
                    <h2 class="card-title">üí∞ Budget</h2>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Weekly Grocery Budget</label>
                            <select class="form-select" name="weeklyBudget">
                                <option value="50-75">$50-75</option>
                                <option value="75-100">$75-100</option>
                                <option value="100-150" selected>$100-150</option>
                                <option value="150-200">$150-200</option>
                                <option value="200+">$200+</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Priority</label>
                            <select class="form-select" name="shoppingPriority">
                                <option value="quality">Quality ingredients</option>
                                <option value="budget">Budget-friendly</option>
                                <option value="balance" selected>Balance both</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Dietary Notes -->
                <div class="card">
                    <h2 class="card-title">üìù Dietary Notes</h2>
                    <div class="form-group">
                        <label>Foods to Avoid</label>
                        <textarea class="form-textarea" name="foodsToAvoid" placeholder="Specific triggers or dislikes..."></textarea>
                    </div>
                    <div class="form-group">
                        <label>Favorite Flavors</label>
                        <textarea class="form-textarea" name="favoriteFlavors" placeholder="e.g., lemon, garlic, fresh herbs..."></textarea>
                    </div>
                </div>

                <button type="submit" class="btn btn-primary" style="width: 100%;">Save & Meet Nonna</button>
            </form>
        </div>
    </main>

    <!-- Main App Container -->
    <main class="view" id="app-main">
        <div class="container">
            <!-- Home/Chat View -->
            <div class="view active" id="view-home">
                <div class="chat-container">
                    <div class="chat-messages" id="chat-messages"></div>
                    <div class="chat-input-area">
                        <div class="chat-input-wrapper">
                            <button class="voice-btn" id="voice-btn" onclick="toggleVoiceInput()" title="Voice input">üé§</button>
                            <textarea class="chat-input" id="chat-input" placeholder="Ask Nonna anything..." rows="1"></textarea>
                            <button class="send-btn" id="send-btn" onclick="sendMessage()">‚û§</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Favorites View -->
            <div class="view" id="view-favorites">
                <h2 class="section-title">‚ù§Ô∏è Your Favorites</h2>
                <div class="flex flex-between flex-center mb-16">
                    <input type="text" class="form-input" id="favorites-search" placeholder="Search recipes..." style="max-width: 300px;" oninput="filterFavorites()">
                    <select class="form-select" id="favorites-sort" style="max-width: 150px;" onchange="sortFavorites()">
                        <option value="recent">Recently Added</option>
                        <option value="rating">Highest Rated</option>
                        <option value="name">Name A-Z</option>
                    </select>
                </div>
                <div class="grid grid-2" id="favorites-grid"></div>
                <div class="empty-state" id="favorites-empty">
                    <div class="empty-state-icon">‚ù§Ô∏è</div>
                    <div class="empty-state-title">No favorites yet!</div>
                    <p>Heart a recipe from Nonna to save it here.</p>
                </div>
            </div>

            <!-- This Week View -->
            <div class="view" id="view-week">
                <div class="flex flex-between flex-center mb-16">
                    <h2 class="section-title mb-0">üìÖ This Week</h2>
                    <button class="btn btn-primary btn-sm" onclick="askNonnaForWeekPlan()">Plan My Week</button>
                </div>
                <div id="week-planner"></div>
                <div class="card mt-16">
                    <h3 class="card-title">üìä Week Summary</h3>
                    <div id="week-summary">
                        <p class="text-muted">Plan some meals to see your weekly summary.</p>
                    </div>
                </div>
            </div>

            <!-- Kitchen View -->
            <div class="view" id="view-kitchen">
                <h2 class="section-title">üç≥ Kitchen</h2>
                <div class="tabs">
                    <button class="tab active" onclick="switchKitchenTab('pantry')">Pantry</button>
                    <button class="tab" onclick="switchKitchenTab('shopping')">Shopping</button>
                    <button class="tab" onclick="switchKitchenTab('batch')">Batch Prep</button>
                    <button class="tab" onclick="switchKitchenTab('subs')">Substitutions</button>
                </div>

                <!-- Pantry Tab -->
                <div class="tab-content active" id="kitchen-pantry">
                    <div class="flex flex-between flex-center mb-16">
                        <span class="text-muted">Track your ingredients</span>
                        <button class="btn btn-sm btn-primary" onclick="openAddPantryModal()">+ Add Item</button>
                    </div>
                    <div id="pantry-list"></div>
                    <div class="empty-state" id="pantry-empty">
                        <div class="empty-state-icon">ü•´</div>
                        <div class="empty-state-title">Pantry is empty</div>
                        <p>Add items to track your inventory.</p>
                    </div>
                    <button class="btn btn-secondary mt-16" onclick="askNonnaWithPantry()" style="width: 100%;">
                        üç≥ What can I make with these?
                    </button>
                </div>

                <!-- Shopping Tab -->
                <div class="tab-content" id="kitchen-shopping">
                    <div class="flex flex-between flex-center mb-16">
                        <select class="form-select" id="shopping-list-select" style="max-width: 200px;" onchange="loadShoppingList()">
                            <option value="weekly">Weekly Groceries</option>
                        </select>
                        <button class="btn btn-sm btn-primary" onclick="openAddShoppingModal()">+ Add Item</button>
                    </div>
                    <div id="shopping-list"></div>
                    <div class="empty-state" id="shopping-empty">
                        <div class="empty-state-icon">üõí</div>
                        <div class="empty-state-title">Shopping list is empty</div>
                        <p>Add items or generate from meal plan.</p>
                    </div>
                    <div class="flex gap-8 mt-16">
                        <button class="btn btn-secondary" onclick="printShoppingList()" style="flex: 1;">üñ®Ô∏è Print</button>
                        <button class="btn btn-secondary" onclick="clearCheckedItems()" style="flex: 1;">Clear Checked</button>
                    </div>
                </div>

                <!-- Batch Prep Tab -->
                <div class="tab-content" id="kitchen-batch">
                    <div class="card">
                        <h3 class="card-title">Plan Batch Cooking Session</h3>
                        <div class="form-group">
                            <label>What do you want to prep?</label>
                            <div class="grid grid-2">
                                <label class="checkbox-item"><input type="checkbox" name="batchItems" value="chicken"> Chicken</label>
                                <label class="checkbox-item"><input type="checkbox" name="batchItems" value="fish"> Fish</label>
                                <label class="checkbox-item"><input type="checkbox" name="batchItems" value="grains"> Grains</label>
                                <label class="checkbox-item"><input type="checkbox" name="batchItems" value="vegetables"> Roasted Veggies</label>
                                <label class="checkbox-item"><input type="checkbox" name="batchItems" value="sauce"> Sauces</label>
                                <label class="checkbox-item"><input type="checkbox" name="batchItems" value="soup"> Soup/Broth</label>
                            </div>
                        </div>
                        <div class="form-group">
                            <label>How much time do you have?</label>
                            <select class="form-select" id="batch-time">
                                <option value="1">1 hour</option>
                                <option value="2" selected>2 hours</option>
                                <option value="3">3+ hours</option>
                            </select>
                        </div>
                        <button class="btn btn-primary" onclick="generateBatchPlan()" style="width: 100%;">Generate Prep Plan</button>
                    </div>
                    <div id="batch-plan-output"></div>
                </div>

                <!-- Substitutions Tab -->
                <div class="tab-content" id="kitchen-subs">
                    <div class="form-group">
                        <input type="text" class="form-input" id="subs-search" placeholder="I'm out of..." oninput="searchSubstitutions()">
                    </div>
                    <div id="subs-results"></div>
                    <div id="subs-categories">
                        <div class="accordion-item">
                            <div class="accordion-header" onclick="toggleAccordion(this)">
                                <span>üßÄ Dairy Substitutions</span>
                                <span class="accordion-icon">‚ñº</span>
                            </div>
                            <div class="accordion-body">
                                <p><strong>Greek Yogurt ‚Üí</strong> Labneh, sour cream, or omit for Crohn's</p>
                                <p><strong>Feta Cheese ‚Üí</strong> Goat cheese, ricotta salata</p>
                                <p><strong>Parmesan ‚Üí</strong> Pecorino Romano, nutritional yeast</p>
                            </div>
                        </div>
                        <div class="accordion-item">
                            <div class="accordion-header" onclick="toggleAccordion(this)">
                                <span>üåø Herb Substitutions</span>
                                <span class="accordion-icon">‚ñº</span>
                            </div>
                            <div class="accordion-body">
                                <p><strong>Fresh herbs ‚Üí</strong> Dried at 1/3 the amount</p>
                                <p><strong>Basil ‚Üí</strong> Oregano, parsley</p>
                                <p><strong>Dill ‚Üí</strong> Fennel fronds, tarragon</p>
                            </div>
                        </div>
                        <div class="accordion-item">
                            <div class="accordion-header" onclick="toggleAccordion(this)">
                                <span>üçã Acid Substitutions</span>
                                <span class="accordion-icon">‚ñº</span>
                            </div>
                            <div class="accordion-body">
                                <p><strong>Lemon juice ‚Üí</strong> White wine vinegar + pinch of sugar</p>
                                <p><strong>Red wine vinegar ‚Üí</strong> Balsamic, sherry vinegar</p>
                                <p><strong>White wine ‚Üí</strong> Chicken broth + splash of vinegar</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Garden View -->
            <div class="view" id="view-garden">
                <h2 class="section-title">üå± Garden</h2>
                <div class="tabs">
                    <button class="tab active" onclick="switchGardenTab('inventory')">My Garden</button>
                    <button class="tab" onclick="switchGardenTab('planting')">Planting Guide</button>
                    <button class="tab" onclick="switchGardenTab('harvest')">Harvest Log</button>
                </div>

                <div class="tab-content active" id="garden-inventory">
                    <div class="flex flex-between flex-center mb-16">
                        <span class="text-muted">What's growing</span>
                        <button class="btn btn-sm btn-primary" onclick="openAddPlantModal()">+ Add Plant</button>
                    </div>
                    <div id="garden-plants"></div>
                    <button class="btn btn-secondary mt-16" onclick="askNonnaWithGarden()" style="width: 100%;">
                        üçÖ What can I make with my harvest?
                    </button>
                </div>

                <div class="tab-content" id="garden-planting">
                    <div class="card">
                        <h3 class="card-title">üå± Plant Now</h3>
                        <p class="text-muted mb-16">Recommendations for your zone and season</p>
                        <div id="planting-suggestions"></div>
                    </div>
                </div>

                <div class="tab-content" id="garden-harvest">
                    <div class="flex flex-between flex-center mb-16">
                        <span class="text-muted">Track what you've picked</span>
                        <button class="btn btn-sm btn-primary" onclick="openLogHarvestModal()">+ Log Harvest</button>
                    </div>
                    <div id="harvest-log"></div>
                </div>
            </div>

            <!-- Crohn's Care View -->
            <div class="view" id="view-crohns">
                <h2 class="section-title">ü©∫ Crohn's Care</h2>

                <button class="btn btn-primary" style="width: 100%; padding: 20px; font-size: 1.1rem; margin-bottom: 20px;" onclick="activateFlareMode()">
                    üòî I'm Having a Flare - Help Me
                </button>

                <div class="flare-banner hidden" id="flare-mode-banner">
                    <div class="flare-banner-title">üå°Ô∏è Flare Mode Active</div>
                    <div class="flare-banner-text">Nonna will only suggest gentle, easy-to-digest meals.</div>
                    <button class="btn btn-sm btn-ghost mt-8" onclick="deactivateFlareMode()">Exit Flare Mode</button>
                </div>

                <div class="card">
                    <h3 class="card-title">üíö Gentle Meal Ideas</h3>
                    <div class="quick-actions">
                        <button class="quick-action" onclick="askNonna('Give me a gentle soup recipe for a flare day')">Soothing Soup</button>
                        <button class="quick-action" onclick="askNonna('What\\'s an easy-to-digest dinner?')">Easy Dinner</button>
                        <button class="quick-action" onclick="askNonna('Simple breakfast for low energy')">Simple Breakfast</button>
                        <button class="quick-action" onclick="askNonna('Gentle smoothie recipe')">Gentle Smoothie</button>
                    </div>
                </div>

                <div class="card">
                    <h3 class="card-title">üö´ Foods to Avoid During Flare</h3>
                    <ul style="padding-left: 20px; color: var(--gray-text);">
                        <li>Raw vegetables (cook them well)</li>
                        <li>High-fiber foods</li>
                        <li>Spicy foods</li>
                        <li>Dairy (if intolerant)</li>
                        <li>Nuts and seeds</li>
                        <li>Fried or greasy foods</li>
                        <li>Alcohol and caffeine</li>
                    </ul>
                </div>

                <div class="nonna-tip">
                    <div class="nonna-tip-header">üí° Nonna's Tip</div>
                    <div class="nonna-tip-text">"During a flare, keep it simple, cara. Plain rice, tender chicken, and well-cooked vegetables. Your body needs rest and gentle nourishment."</div>
                    <div class="nonna-tip-signature">‚Äî Nonna</div>
                </div>

                <p class="text-muted text-center" style="font-size: 0.85rem; margin-top: 20px;">
                    ‚ö†Ô∏è This is not medical advice. Always consult your gastroenterologist about your Crohn's management.
                </p>
            </div>

            <!-- Meal History View -->
            <div class="view" id="view-history">
                <h2 class="section-title">üìñ Meal History</h2>
                <div class="card">
                    <h3 class="card-title">üìä Your Stats</h3>
                    <div class="grid grid-2" id="history-stats">
                        <div><strong>This Week:</strong> <span id="stat-week">0</span> meals</div>
                        <div><strong>This Month:</strong> <span id="stat-month">0</span> meals</div>
                    </div>
                </div>
                <div class="flex flex-between flex-center mb-16 mt-16">
                    <span class="text-muted">Recent meals</span>
                    <button class="btn btn-sm btn-secondary" onclick="openAddMealModal()">+ Add Meal</button>
                </div>
                <div id="history-list"></div>
                <div class="empty-state" id="history-empty">
                    <div class="empty-state-icon">üìñ</div>
                    <div class="empty-state-title">No meals logged yet</div>
                    <p>Mark recipes as cooked to track your history.</p>
                </div>
            </div>

            <!-- Settings View -->
            <div class="view" id="view-settings">
                <h2 class="section-title">‚öôÔ∏è Settings</h2>

                <div class="card">
                    <h3 class="card-title">üé® Appearance</h3>
                    <label class="toggle">
                        <input type="checkbox" id="dark-mode-toggle" onchange="toggleDarkMode()">
                        <span class="toggle-switch"></span>
                        <span>üåô Dark Mode</span>
                    </label>
                </div>

                <div class="card">
                    <h3 class="card-title">üë§ Profile</h3>
                    <button class="btn btn-secondary" onclick="editProfile()" style="width: 100%;">Edit Health Profile</button>
                </div>

                <div class="card">
                    <h3 class="card-title">üíæ Data</h3>
                    <div class="flex flex-between flex-center gap-8" style="flex-wrap: wrap;">
                        <button class="btn btn-secondary btn-sm" onclick="exportAllData()">Export Data</button>
                        <button class="btn btn-secondary btn-sm" onclick="importData()">Import Data</button>
                        <button class="btn btn-sm" style="background: var(--danger); color: white;" onclick="confirmClearAllData()">Clear All Data</button>
                    </div>
                </div>

                <div class="card">
                    <h3 class="card-title">‚ÑπÔ∏è About</h3>
                    <p class="text-muted">Tavola v2.0</p>
                    <p class="text-muted">Mediterranean meal planning with Nonna</p>
                    <p class="text-muted" style="font-size: 0.85rem; margin-top: 8px;">Made with ‚ù§Ô∏è for people managing chronic illness</p>
                </div>
            </div>
        </div>
    </main>

    <!-- Bottom Navigation -->
    <nav class="bottom-nav hidden" id="bottom-nav">
        <button class="nav-item active" onclick="navigateTo('home')">
            <span class="icon">üè†</span>
            <span>Home</span>
        </button>
        <button class="nav-item" onclick="navigateTo('favorites')">
            <span class="icon">‚ù§Ô∏è</span>
            <span>Favorites</span>
        </button>
        <button class="nav-item" onclick="navigateTo('week')">
            <span class="icon">üìÖ</span>
            <span>Week</span>
        </button>
        <button class="nav-item" onclick="navigateTo('kitchen')">
            <span class="icon">üç≥</span>
            <span>Kitchen</span>
        </button>
        <button class="nav-item" onclick="navigateTo('crohns')">
            <span class="icon">ü©∫</span>
            <span>Care</span>
        </button>
    </nav>

    <!-- Modals will be added dynamically -->
    <div class="modal-overlay" id="modal-overlay">
        <div class="modal" id="modal-content"></div>
    </div>

    <script>
        // ========================================
        // STORAGE KEYS
        // ========================================
        const STORAGE = {
            PROFILE: 'tavola_profile',
            CHAT: 'tavola_chat_history',
            FAVORITES: 'tavola_favorites',
            PANTRY: 'tavola_pantry',
            SHOPPING: 'tavola_shopping_lists',
            MEAL_PLANS: 'tavola_meal_plans',
            GARDEN: 'tavola_garden',
            HISTORY: 'tavola_meal_history',
            PREFS: 'tavola_preferences'
        };

        // ========================================
        // APP STATE
        // ========================================
        let state = {
            currentView: 'home',
            chatHistory: [],
            isProcessing: false,
            isRecording: false,
            flareMode: false,
            recognition: null
        };

        // ========================================
        // INITIALIZATION
        // ========================================
        document.addEventListener('DOMContentLoaded', () => {
            initApp();
        });

        function initApp() {
            const profile = getStorage(STORAGE.PROFILE);
            if (profile) {
                showApp();
                loadChatHistory();
                if (state.chatHistory.length === 0) {
                    addWelcomeMessage();
                }
            } else {
                showWelcome();
            }

            initVoiceRecognition();
            initChatInput();
            loadPreferences();
            setCurrentSeason();
        }

        // ========================================
        // STORAGE HELPERS
        // ========================================
        function getStorage(key) {
            try {
                const data = localStorage.getItem(key);
                return data ? JSON.parse(data) : null;
            } catch (e) {
                console.error('Storage read error:', e);
                return null;
            }
        }

        function setStorage(key, value) {
            try {
                localStorage.setItem(key, JSON.stringify(value));
                return true;
            } catch (e) {
                console.error('Storage write error:', e);
                return false;
            }
        }

        // ========================================
        // VIEW MANAGEMENT
        // ========================================
        function showWelcome() {
            document.getElementById('welcome-screen').style.display = 'flex';
            document.getElementById('intake-form').classList.remove('active');
            document.getElementById('app-main').classList.remove('active');
            document.getElementById('app-header').classList.add('hidden');
            document.getElementById('bottom-nav').classList.add('hidden');
        }

        function showIntakeForm() {
            document.getElementById('welcome-screen').style.display = 'none';
            document.getElementById('intake-form').classList.add('active');
            document.getElementById('app-main').classList.remove('active');
        }

        function showApp() {
            document.getElementById('welcome-screen').style.display = 'none';
            document.getElementById('intake-form').classList.remove('active');
            document.getElementById('app-main').classList.add('active');
            document.getElementById('app-header').classList.remove('hidden');
            document.getElementById('bottom-nav').classList.remove('hidden');
            navigateTo('home');
        }

        function navigateTo(view) {
            state.currentView = view;

            // Update views
            document.querySelectorAll('#app-main > .container > .view').forEach(v => v.classList.remove('active'));
            const targetView = document.getElementById(`view-${view}`);
            if (targetView) targetView.classList.add('active');

            // Update nav
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            const navItems = document.querySelectorAll('.nav-item');
            const viewMap = { home: 0, favorites: 1, week: 2, kitchen: 3, crohns: 4, garden: 3, history: 4, settings: -1 };
            if (viewMap[view] >= 0 && navItems[viewMap[view]]) {
                navItems[viewMap[view]].classList.add('active');
            }

            // Load view data
            if (view === 'favorites') renderFavorites();
            if (view === 'week') renderWeekPlanner();
            if (view === 'kitchen') renderPantry();
            if (view === 'garden') renderGarden();
            if (view === 'history') renderHistory();
        }

        // ========================================
        // PROFILE MANAGEMENT
        // ========================================
        function toggleCookingForTwo() {
            const toggle = document.getElementById('cookingForTwoToggle');
            const fields = document.getElementById('cookingForTwoFields');
            fields.classList.toggle('hidden', !toggle.checked);
        }

        function setCurrentSeason() {
            const month = new Date().getMonth();
            let season = 'winter';
            if (month >= 2 && month <= 4) season = 'spring';
            else if (month >= 5 && month <= 7) season = 'summer';
            else if (month >= 8 && month <= 10) season = 'fall';
            const select = document.querySelector('[name="currentSeason"]');
            if (select) select.value = season;
        }

        function saveProfile(e) {
            e.preventDefault();
            const form = e.target;

            const profile = {
                crohnsSeverity: form.crohnsSeverity.value,
                crohnsTriggers: form.crohnsTriggers.value,
                fibroEnergy: form.fibroEnergy.value,
                thyroidType: form.thyroidType.value,
                otherConditions: form.otherConditions.value,
                cookingForTwo: form.cookingForTwo.checked,
                partnerName: form.partnerName?.value || '',
                partnerRestrictions: Array.from(form.querySelectorAll('[name="partnerRestrictions"]:checked')).map(c => c.value),
                partnerAllergies: form.partnerAllergies?.value || '',
                partnerLoves: form.partnerLoves?.value || '',
                proteins: Array.from(form.querySelectorAll('[name="proteins"]:checked')).map(c => c.value),
                currentlyGrowing: form.currentlyGrowing.value,
                growingZone: form.growingZone.value,
                currentSeason: form.currentSeason.value,
                energyLevel: form.energyLevel.value,
                cookingTime: form.cookingTime.value,
                weeklyBudget: form.weeklyBudget.value,
                shoppingPriority: form.shoppingPriority.value,
                foodsToAvoid: form.foodsToAvoid.value,
                favoriteFlavors: form.favoriteFlavors.value,
                createdAt: new Date().toISOString()
            };

            setStorage(STORAGE.PROFILE, profile);
            showApp();
        }

        function editProfile() {
            const profile = getStorage(STORAGE.PROFILE);
            showIntakeForm();

            if (profile) {
                setTimeout(() => {
                    const form = document.getElementById('profile-form');
                    Object.keys(profile).forEach(key => {
                        const el = form.querySelector(`[name="${key}"]`);
                        if (el) {
                            if (el.type === 'checkbox') {
                                el.checked = profile[key];
                                if (key === 'cookingForTwo') toggleCookingForTwo();
                            } else {
                                el.value = profile[key];
                            }
                        }
                    });
                    // Handle checkboxes for proteins
                    if (profile.proteins) {
                        profile.proteins.forEach(p => {
                            const cb = form.querySelector(`[name="proteins"][value="${p}"]`);
                            if (cb) cb.checked = true;
                        });
                    }
                }, 100);
            }
        }

        // ========================================
        // CHAT FUNCTIONALITY
        // ========================================
        function initChatInput() {
            const input = document.getElementById('chat-input');
            input.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            });
            input.addEventListener('input', () => {
                input.style.height = 'auto';
                input.style.height = Math.min(input.scrollHeight, 120) + 'px';
            });
        }

        function loadChatHistory() {
            state.chatHistory = getStorage(STORAGE.CHAT) || [];
            renderChatHistory();
        }

        function saveChatHistory() {
            setStorage(STORAGE.CHAT, state.chatHistory);
        }

        function addWelcomeMessage() {
            const profile = getStorage(STORAGE.PROFILE);
            let text = "Ciao, cara! I'm Nonna, your Mediterranean cooking companion. ";
            if (profile) {
                text += "I've looked at your profile and I'm ready to help you plan delicious, gentle meals. ";
            }
            text += "What would you like to cook today?";

            const msg = { role: 'assistant', content: text, timestamp: new Date().toISOString() };
            state.chatHistory.push(msg);
            saveChatHistory();
            renderMessage(msg, true);
            renderQuickActions();
        }

        function renderChatHistory() {
            const container = document.getElementById('chat-messages');
            container.innerHTML = '';
            state.chatHistory.forEach(msg => renderMessage(msg, false));
            if (state.chatHistory.length === 1) renderQuickActions();
        }

        function renderMessage(message, animate = true) {
            const container = document.getElementById('chat-messages');
            const div = document.createElement('div');
            div.className = `message message-${message.role}`;
            if (!animate) div.style.animation = 'none';

            const bubble = document.createElement('div');
            bubble.className = 'message-bubble';

            // Check if content contains a recipe
            if (message.role === 'assistant' && message.content.includes('RECIPE:')) {
                bubble.innerHTML = parseRecipeToCard(message.content);
            } else {
                bubble.innerHTML = formatMessageContent(message.content);
            }

            div.appendChild(bubble);
            container.appendChild(div);
            scrollToBottom();
        }

        function formatMessageContent(content) {
            return content
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                .replace(/^### (.*$)/gm, '<h3 style="color: var(--cerulean); margin: 12px 0 8px;">$1</h3>')
                .replace(/^## (.*$)/gm, '<h2 style="color: var(--cerulean); margin: 16px 0 8px;">$1</h2>')
                .replace(/^- (.*$)/gm, '<li>$1</li>')
                .replace(/^(\d+)\. (.*$)/gm, '<li>$2</li>')
                .replace(/‚òê (.*$)/gm, '<span style="display: block;">‚òê $1</span>')
                .replace(/\n\n/g, '</p><p>')
                .replace(/\n/g, '<br>');
        }

        function parseRecipeToCard(content) {
            // Extract recipe components
            const titleMatch = content.match(/RECIPE:\s*(.+?)(?:\n|$)/);
            const servesMatch = content.match(/Serves:\s*(\d+)/i);
            const timeMatch = content.match(/Total Time:\s*(\d+)\s*min/i);
            const prepMatch = content.match(/Prep:\s*(\d+)\s*min/i);
            const cookMatch = content.match(/Cook:\s*(\d+)\s*min/i);
            const tagsMatch = content.match(/Tags:\s*(.+?)(?:\n|$)/i);

            // Extract ingredients
            const ingredientsMatch = content.match(/INGREDIENTS:([\s\S]*?)(?=INSTRUCTIONS:|$)/i);
            const ingredients = ingredientsMatch ?
                ingredientsMatch[1].trim().split('\n').filter(l => l.trim().startsWith('-')).map(l => l.replace(/^-\s*/, '').trim()) : [];

            // Extract instructions
            const instructionsMatch = content.match(/INSTRUCTIONS:([\s\S]*?)(?=CROHN'S|NUTRITIONAL|$)/i);
            const instructions = instructionsMatch ?
                instructionsMatch[1].trim().split('\n').filter(l => /^\d+\./.test(l.trim())).map(l => l.replace(/^\d+\.\s*/, '').trim()) : [];

            // Extract Crohn's mods
            const crohnsMatch = content.match(/CROHN'S MODIFICATIONS:([\s\S]*?)(?=NUTRITIONAL|$)/i);
            const crohnsMods = crohnsMatch ? crohnsMatch[1].trim() : '';

            const title = titleMatch ? titleMatch[1].trim() : 'Recipe';
            const serves = servesMatch ? servesMatch[1] : '2';
            const totalTime = timeMatch ? timeMatch[1] : '30';
            const prepTime = prepMatch ? prepMatch[1] : '10';
            const cookTime = cookMatch ? cookMatch[1] : '20';
            const tags = tagsMatch ? tagsMatch[1].split(',').map(t => t.trim()) : ['Mediterranean'];

            const recipeId = 'recipe_' + Date.now();

            return `
                <div class="recipe-card" data-recipe-id="${recipeId}">
                    <div class="recipe-header">
                        <div class="recipe-title">${title}</div>
                        <div class="recipe-actions">
                            <button class="recipe-action-btn" onclick="toggleFavorite('${recipeId}', this)" title="Add to favorites">‚ù§Ô∏è</button>
                            <button class="recipe-action-btn" onclick="printRecipe('${recipeId}')" title="Print">üñ®Ô∏è</button>
                            <button class="recipe-action-btn" onclick="shareRecipe('${recipeId}')" title="Share">üîó</button>
                        </div>
                        <div class="recipe-meta">
                            <div class="recipe-meta-item">‚è±Ô∏è ${totalTime} min</div>
                            <div class="recipe-meta-item">üë®‚Äçüç≥ Prep ${prepTime}m</div>
                            <div class="recipe-meta-item">üî• Cook ${cookTime}m</div>
                            <div class="recipe-meta-item">üçΩÔ∏è Serves ${serves}</div>
                        </div>
                    </div>
                    <div class="recipe-tags">
                        ${tags.map(t => `<span class="tag ${t.toLowerCase().includes('crohn') ? 'tag-crohns' : ''}">${t}</span>`).join('')}
                    </div>
                    <div class="recipe-body">
                        <div class="recipe-section">
                            <div class="recipe-section-title">üìù Ingredients</div>
                            ${ingredients.map((ing, i) => `
                                <div class="ingredient-item">
                                    <input type="checkbox" class="ingredient-checkbox" id="ing_${recipeId}_${i}" onchange="toggleIngredient(this)">
                                    <label class="ingredient-text" for="ing_${recipeId}_${i}">${ing}</label>
                                </div>
                            `).join('')}
                        </div>
                        <div class="recipe-section">
                            <div class="recipe-section-title">üë©‚Äçüç≥ Instructions</div>
                            ${instructions.map((step, i) => `
                                <div class="instruction-step">
                                    <div class="step-number">${i + 1}</div>
                                    <div>${step}</div>
                                </div>
                            `).join('')}
                        </div>
                        ${crohnsMods ? `
                            <div class="recipe-notes">
                                <div class="recipe-notes-title">ü©∫ Crohn's Modifications</div>
                                <p>${crohnsMods.replace(/\n/g, '<br>')}</p>
                            </div>
                        ` : ''}
                        <button class="btn btn-primary mt-16" onclick="markAsCooked('${recipeId}', '${title}')" style="width: 100%;">
                            ‚úÖ Mark as Cooked
                        </button>
                    </div>
                </div>
            `;
        }

        function toggleIngredient(checkbox) {
            const label = checkbox.nextElementSibling;
            label.classList.toggle('checked', checkbox.checked);
        }

        function renderQuickActions() {
            const container = document.getElementById('chat-messages');
            const actions = document.createElement('div');
            actions.className = 'quick-actions';
            actions.innerHTML = `
                <button class="quick-action" onclick="askNonna('Plan my meals for this week')">üóìÔ∏è Plan My Week</button>
                <button class="quick-action" onclick="askNonna('What can I make with what\\'s in my garden?')">üå± Use My Garden</button>
                <button class="quick-action" onclick="askNonna('Give me a quick, easy dinner idea')">‚ö° Quick Dinner</button>
                <button class="quick-action" onclick="askNonna('I need a gentle meal - not feeling great')">ü©∫ Gentle Meal</button>
            `;
            container.appendChild(actions);
            scrollToBottom();
        }

        function scrollToBottom() {
            const container = document.getElementById('chat-messages');
            setTimeout(() => container.scrollTop = container.scrollHeight, 50);
        }

        function showThinking() {
            const container = document.getElementById('chat-messages');
            const div = document.createElement('div');
            div.className = 'message message-assistant';
            div.id = 'thinking-message';
            div.innerHTML = `
                <div class="thinking">
                    <div class="thinking-dots"><span></span><span></span><span></span></div>
                    <span>Nonna is thinking...</span>
                </div>
            `;
            container.appendChild(div);
            scrollToBottom();
        }

        function hideThinking() {
            const el = document.getElementById('thinking-message');
            if (el) el.remove();
        }

        async function sendMessage() {
            if (state.isProcessing) return;

            const input = document.getElementById('chat-input');
            const message = input.value.trim();
            if (!message) return;

            input.value = '';
            input.style.height = 'auto';

            // Remove quick actions
            document.querySelectorAll('.quick-actions').forEach(el => el.remove());

            // Add user message
            const userMsg = { role: 'user', content: message, timestamp: new Date().toISOString() };
            state.chatHistory.push(userMsg);
            saveChatHistory();
            renderMessage(userMsg);

            // Call API
            state.isProcessing = true;
            document.getElementById('send-btn').disabled = true;
            showThinking();

            try {
                const response = await callAPI(message);
                hideThinking();

                const assistantMsg = { role: 'assistant', content: response, timestamp: new Date().toISOString() };
                state.chatHistory.push(assistantMsg);
                saveChatHistory();
                renderMessage(assistantMsg);
            } catch (error) {
                hideThinking();
                const errorMsg = { role: 'assistant', content: `Mi dispiace, I had trouble with that: ${error.message}. Let's try again, cara.`, timestamp: new Date().toISOString() };
                state.chatHistory.push(errorMsg);
                saveChatHistory();
                renderMessage(errorMsg);
            }

            state.isProcessing = false;
            document.getElementById('send-btn').disabled = false;
        }

        function askNonna(text) {
            document.getElementById('chat-input').value = text;
            navigateTo('home');
            setTimeout(() => sendMessage(), 100);
        }

        async function callAPI(userMessage) {
            const profile = getStorage(STORAGE.PROFILE);
            const profileText = formatProfileForAPI(profile);

            const messages = state.chatHistory.slice(-10).map(m => ({
                role: m.role,
                content: m.content
            }));

            if (!messages.length || messages[messages.length - 1].content !== userMessage) {
                messages.push({ role: 'user', content: userMessage });
            }

            const response = await fetch('/.netlify/functions/chat', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ messages, profileText, flareMode: state.flareMode })
            });

            if (!response.ok) {
                const err = await response.json().catch(() => ({}));
                throw new Error(err.error || `API error: ${response.status}`);
            }

            const data = await response.json();
            return data.content;
        }

        function formatProfileForAPI(profile) {
            if (!profile) return 'No profile configured.';

            let text = `
HEALTH PROFILE:
- Crohn's: ${profile.crohnsSeverity || 'Not specified'} severity
- Triggers: ${profile.crohnsTriggers || 'None specified'}
- Fibromyalgia Energy: ${profile.fibroEnergy || 'Not specified'}
- Thyroid: ${profile.thyroidType || 'Not specified'}
- Other: ${profile.otherConditions || 'None'}

PROTEINS: ${profile.proteins?.join(', ') || 'Not specified'}

GARDEN: ${profile.currentlyGrowing || 'Nothing specified'}
Zone: ${profile.growingZone || 'Not specified'}, Season: ${profile.currentSeason}

COOKING: Energy ${profile.energyLevel}, Time preference ${profile.cookingTime}
BUDGET: $${profile.weeklyBudget}, Priority: ${profile.shoppingPriority}
AVOID: ${profile.foodsToAvoid || 'None'}
LOVES: ${profile.favoriteFlavors || 'Not specified'}`;

            if (profile.cookingForTwo) {
                text += `

COOKING FOR TWO:
Partner: ${profile.partnerName || 'Partner'}
Restrictions: ${profile.partnerRestrictions?.join(', ') || 'None'}
Allergies: ${profile.partnerAllergies || 'None'}
Loves: ${profile.partnerLoves || 'Not specified'}`;
            }

            return text.trim();
        }

        // ========================================
        // VOICE INPUT
        // ========================================
        function initVoiceRecognition() {
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            if (SpeechRecognition) {
                state.recognition = new SpeechRecognition();
                state.recognition.continuous = false;
                state.recognition.interimResults = false;
                state.recognition.lang = 'en-US';

                state.recognition.onresult = (event) => {
                    const text = event.results[0][0].transcript;
                    document.getElementById('chat-input').value = text;
                    stopRecording();
                };

                state.recognition.onerror = (event) => {
                    console.error('Speech error:', event.error);
                    stopRecording();
                };

                state.recognition.onend = () => {
                    stopRecording();
                };
            } else {
                document.getElementById('voice-btn').style.display = 'none';
            }
        }

        function toggleVoiceInput() {
            if (state.isRecording) {
                stopRecording();
            } else {
                startRecording();
            }
        }

        function startRecording() {
            if (!state.recognition) return;
            state.isRecording = true;
            document.getElementById('voice-btn').classList.add('recording');
            state.recognition.start();
        }

        function stopRecording() {
            state.isRecording = false;
            document.getElementById('voice-btn').classList.remove('recording');
            if (state.recognition) {
                try { state.recognition.stop(); } catch (e) {}
            }
        }

        // ========================================
        // FAVORITES
        // ========================================
        function getFavorites() {
            return getStorage(STORAGE.FAVORITES) || [];
        }

        function saveFavorites(favorites) {
            setStorage(STORAGE.FAVORITES, favorites);
        }

        function toggleFavorite(recipeId, btn) {
            const card = btn.closest('.recipe-card');
            const title = card.querySelector('.recipe-title').textContent;
            const content = card.outerHTML;

            let favorites = getFavorites();
            const existing = favorites.findIndex(f => f.id === recipeId);

            if (existing >= 0) {
                favorites.splice(existing, 1);
                btn.classList.remove('favorited');
            } else {
                favorites.push({
                    id: recipeId,
                    title: title,
                    content: content,
                    rating: 0,
                    notes: '',
                    addedAt: new Date().toISOString(),
                    lastCooked: null
                });
                btn.classList.add('favorited');
            }

            saveFavorites(favorites);
        }

        function renderFavorites() {
            const favorites = getFavorites();
            const grid = document.getElementById('favorites-grid');
            const empty = document.getElementById('favorites-empty');

            if (favorites.length === 0) {
                grid.innerHTML = '';
                empty.classList.remove('hidden');
                return;
            }

            empty.classList.add('hidden');
            grid.innerHTML = favorites.map(fav => `
                <div class="favorite-card" onclick="viewFavorite('${fav.id}')">
                    <div class="favorite-card-banner">üçΩÔ∏è</div>
                    <div class="favorite-card-body">
                        <div class="favorite-card-title">${fav.title}</div>
                        <div class="favorite-card-meta">
                            ${fav.lastCooked ? `Last cooked: ${formatDate(fav.lastCooked)}` : 'Not cooked yet'}
                        </div>
                        ${fav.rating ? `<div class="favorite-card-rating">${'‚≠ê'.repeat(fav.rating)}</div>` : ''}
                    </div>
                </div>
            `).join('');
        }

        function filterFavorites() {
            const search = document.getElementById('favorites-search').value.toLowerCase();
            const favorites = getFavorites().filter(f => f.title.toLowerCase().includes(search));
            // Re-render with filtered
            const grid = document.getElementById('favorites-grid');
            grid.innerHTML = favorites.map(fav => `
                <div class="favorite-card" onclick="viewFavorite('${fav.id}')">
                    <div class="favorite-card-banner">üçΩÔ∏è</div>
                    <div class="favorite-card-body">
                        <div class="favorite-card-title">${fav.title}</div>
                    </div>
                </div>
            `).join('');
        }

        function sortFavorites() {
            // Implement sorting logic
            renderFavorites();
        }

        function viewFavorite(id) {
            const favorites = getFavorites();
            const fav = favorites.find(f => f.id === id);
            if (fav) {
                openModal(`
                    <div class="modal-header">
                        <h2 class="modal-title">${fav.title}</h2>
                        <button class="modal-close" onclick="closeModal()">√ó</button>
                    </div>
                    <div class="modal-body">
                        ${fav.content}
                    </div>
                `);
            }
        }

        // ========================================
        // WEEK PLANNER
        // ========================================
        function renderWeekPlanner() {
            const container = document.getElementById('week-planner');
            const days = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'];
            const mealPlans = getStorage(STORAGE.MEAL_PLANS) || {};

            const today = new Date();
            const startOfWeek = new Date(today);
            startOfWeek.setDate(today.getDate() - today.getDay() + 1);

            container.innerHTML = days.map((day, i) => {
                const date = new Date(startOfWeek);
                date.setDate(startOfWeek.getDate() + i);
                const dateStr = date.toISOString().split('T')[0];
                const meal = mealPlans[dateStr];

                return `
                    <div class="week-day">
                        <div class="week-day-header">
                            <span class="week-day-name">${day}</span>
                            <span class="week-day-date">${date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' })}</span>
                        </div>
                        ${meal ? `
                            <div class="week-day-meal">
                                <span style="font-size: 1.5rem;">üçΩÔ∏è</span>
                                <div>
                                    <div style="font-weight: 500;">${meal.title}</div>
                                    <div style="font-size: 0.85rem; color: var(--gray-text);">${meal.time || '30'} min</div>
                                </div>
                            </div>
                        ` : `
                            <div class="week-day-empty" onclick="planMealFor('${dateStr}')">
                                + Add Meal
                            </div>
                        `}
                    </div>
                `;
            }).join('');
        }

        function askNonnaForWeekPlan() {
            askNonna('Please plan my meals for this week based on my profile, what I have in my garden, and give me variety in proteins.');
        }

        function planMealFor(date) {
            askNonna(`Suggest a meal for ${new Date(date).toLocaleDateString('en-US', { weekday: 'long', month: 'short', day: 'numeric' })}`);
        }

        // ========================================
        // KITCHEN - PANTRY
        // ========================================
        function renderPantry() {
            const pantry = getStorage(STORAGE.PANTRY) || [];
            const list = document.getElementById('pantry-list');
            const empty = document.getElementById('pantry-empty');

            if (pantry.length === 0) {
                list.innerHTML = '';
                empty.classList.remove('hidden');
                return;
            }

            empty.classList.add('hidden');

            const categories = { proteins: 'ü•©', produce: 'ü•¨', grains: 'üåæ', canned: 'ü•´', spices: 'üßÇ', oils: 'ü´í', dairy: 'üßÄ', frozen: '‚ùÑÔ∏è' };

            list.innerHTML = pantry.map(item => {
                const icon = categories[item.category] || 'üì¶';
                const statusClass = getExpirationStatus(item.expiration);
                return `
                    <div class="pantry-item">
                        <span class="pantry-item-icon">${icon}</span>
                        <div class="pantry-item-info">
                            <div class="pantry-item-name">${item.name}</div>
                            <div class="pantry-item-qty">${item.quantity} ${item.unit} ‚Ä¢ ${item.location}</div>
                        </div>
                        <div class="pantry-status ${statusClass}"></div>
                        <button class="icon-btn" onclick="removePantryItem('${item.id}')">üóëÔ∏è</button>
                    </div>
                `;
            }).join('');
        }

        function getExpirationStatus(expDate) {
            if (!expDate) return '';
            const days = Math.ceil((new Date(expDate) - new Date()) / (1000 * 60 * 60 * 24));
            if (days <= 2) return 'expiring';
            if (days <= 7) return 'soon';
            return 'fresh';
        }

        function openAddPantryModal() {
            openModal(`
                <div class="modal-header">
                    <h2 class="modal-title">Add Pantry Item</h2>
                    <button class="modal-close" onclick="closeModal()">√ó</button>
                </div>
                <div class="modal-body">
                    <div class="form-group">
                        <label>Item Name</label>
                        <input type="text" class="form-input" id="pantry-name" placeholder="e.g., Chicken breast">
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Quantity</label>
                            <input type="text" class="form-input" id="pantry-qty" placeholder="e.g., 2">
                        </div>
                        <div class="form-group">
                            <label>Unit</label>
                            <input type="text" class="form-input" id="pantry-unit" placeholder="e.g., lbs">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Category</label>
                            <select class="form-select" id="pantry-category">
                                <option value="proteins">Proteins</option>
                                <option value="produce">Produce</option>
                                <option value="grains">Grains</option>
                                <option value="canned">Canned</option>
                                <option value="spices">Spices</option>
                                <option value="oils">Oils</option>
                                <option value="dairy">Dairy</option>
                                <option value="frozen">Frozen</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Location</label>
                            <select class="form-select" id="pantry-location">
                                <option value="Fridge">Fridge</option>
                                <option value="Freezer">Freezer</option>
                                <option value="Pantry">Pantry</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Expiration Date (optional)</label>
                        <input type="date" class="form-input" id="pantry-exp">
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
                    <button class="btn btn-primary" onclick="addPantryItem()">Add Item</button>
                </div>
            `);
        }

        function addPantryItem() {
            const item = {
                id: 'pantry_' + Date.now(),
                name: document.getElementById('pantry-name').value,
                quantity: document.getElementById('pantry-qty').value,
                unit: document.getElementById('pantry-unit').value,
                category: document.getElementById('pantry-category').value,
                location: document.getElementById('pantry-location').value,
                expiration: document.getElementById('pantry-exp').value,
                addedAt: new Date().toISOString()
            };

            const pantry = getStorage(STORAGE.PANTRY) || [];
            pantry.push(item);
            setStorage(STORAGE.PANTRY, pantry);
            closeModal();
            renderPantry();
        }

        function removePantryItem(id) {
            let pantry = getStorage(STORAGE.PANTRY) || [];
            pantry = pantry.filter(p => p.id !== id);
            setStorage(STORAGE.PANTRY, pantry);
            renderPantry();
        }

        function askNonnaWithPantry() {
            const pantry = getStorage(STORAGE.PANTRY) || [];
            if (pantry.length === 0) {
                askNonna('I need recipe ideas but my pantry tracker is empty. Can you suggest some staple ingredients I should have?');
            } else {
                const items = pantry.map(p => p.name).join(', ');
                askNonna(`What can I make with these ingredients: ${items}?`);
            }
        }

        // ========================================
        // KITCHEN TABS
        // ========================================
        function switchKitchenTab(tab) {
            document.querySelectorAll('#view-kitchen .tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('#view-kitchen .tab-content').forEach(c => c.classList.remove('active'));

            event.target.classList.add('active');
            document.getElementById(`kitchen-${tab}`).classList.add('active');

            if (tab === 'pantry') renderPantry();
            if (tab === 'shopping') renderShoppingList();
        }

        // ========================================
        // SHOPPING LIST
        // ========================================
        function renderShoppingList() {
            const lists = getStorage(STORAGE.SHOPPING) || { weekly: [] };
            const items = lists.weekly || [];
            const container = document.getElementById('shopping-list');
            const empty = document.getElementById('shopping-empty');

            if (items.length === 0) {
                container.innerHTML = '';
                empty.classList.remove('hidden');
                return;
            }

            empty.classList.add('hidden');

            const sections = { produce: 'ü•¨ Produce', proteins: 'ü•© Proteins', dairy: 'ü•õ Dairy', grains: 'üåæ Grains', pantry: 'ü•´ Pantry', frozen: '‚ùÑÔ∏è Frozen' };

            const grouped = {};
            items.forEach(item => {
                const cat = item.category || 'pantry';
                if (!grouped[cat]) grouped[cat] = [];
                grouped[cat].push(item);
            });

            container.innerHTML = Object.entries(grouped).map(([cat, catItems]) => `
                <div class="shopping-section">
                    <div class="shopping-section-title">${sections[cat] || cat}</div>
                    ${catItems.map(item => `
                        <div class="shopping-item ${item.checked ? 'checked' : ''}">
                            <input type="checkbox" class="shopping-item-checkbox" ${item.checked ? 'checked' : ''} onchange="toggleShoppingItem('${item.id}')">
                            <span class="shopping-item-name">${item.name}</span>
                            <span class="shopping-item-qty">${item.quantity || ''}</span>
                        </div>
                    `).join('')}
                </div>
            `).join('');
        }

        function toggleShoppingItem(id) {
            const lists = getStorage(STORAGE.SHOPPING) || { weekly: [] };
            const item = lists.weekly.find(i => i.id === id);
            if (item) {
                item.checked = !item.checked;
                setStorage(STORAGE.SHOPPING, lists);
                renderShoppingList();
            }
        }

        function openAddShoppingModal() {
            openModal(`
                <div class="modal-header">
                    <h2 class="modal-title">Add Shopping Item</h2>
                    <button class="modal-close" onclick="closeModal()">√ó</button>
                </div>
                <div class="modal-body">
                    <div class="form-group">
                        <label>Item</label>
                        <input type="text" class="form-input" id="shopping-name" placeholder="e.g., Olive oil">
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Quantity</label>
                            <input type="text" class="form-input" id="shopping-qty" placeholder="e.g., 1 bottle">
                        </div>
                        <div class="form-group">
                            <label>Category</label>
                            <select class="form-select" id="shopping-category">
                                <option value="produce">Produce</option>
                                <option value="proteins">Proteins</option>
                                <option value="dairy">Dairy</option>
                                <option value="grains">Grains</option>
                                <option value="pantry">Pantry</option>
                                <option value="frozen">Frozen</option>
                            </select>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
                    <button class="btn btn-primary" onclick="addShoppingItem()">Add</button>
                </div>
            `);
        }

        function addShoppingItem() {
            const item = {
                id: 'shop_' + Date.now(),
                name: document.getElementById('shopping-name').value,
                quantity: document.getElementById('shopping-qty').value,
                category: document.getElementById('shopping-category').value,
                checked: false
            };

            const lists = getStorage(STORAGE.SHOPPING) || { weekly: [] };
            lists.weekly.push(item);
            setStorage(STORAGE.SHOPPING, lists);
            closeModal();
            renderShoppingList();
        }

        function clearCheckedItems() {
            const lists = getStorage(STORAGE.SHOPPING) || { weekly: [] };
            lists.weekly = lists.weekly.filter(i => !i.checked);
            setStorage(STORAGE.SHOPPING, lists);
            renderShoppingList();
        }

        function printShoppingList() {
            window.print();
        }

        // ========================================
        // SUBSTITUTIONS
        // ========================================
        function searchSubstitutions() {
            const query = document.getElementById('subs-search').value.toLowerCase();
            const results = document.getElementById('subs-results');

            if (!query) {
                results.innerHTML = '';
                return;
            }

            const subs = {
                'lemon': { sub: 'White wine vinegar + pinch of sugar', ratio: '1:1', crohns: true },
                'yogurt': { sub: 'Labneh or sour cream', ratio: '1:1', crohns: 'Omit for flare' },
                'greek yogurt': { sub: 'Labneh, sour cream, or cottage cheese', ratio: '1:1', crohns: 'Small amount or omit' },
                'basil': { sub: 'Oregano or parsley', ratio: '1:1 fresh, 1:3 dried', crohns: true },
                'parmesan': { sub: 'Pecorino Romano or nutritional yeast', ratio: '1:1', crohns: true },
                'olive oil': { sub: 'Avocado oil or melted butter', ratio: '1:1', crohns: true },
                'white wine': { sub: 'Chicken broth + splash of vinegar', ratio: '1:1', crohns: true },
                'garlic': { sub: 'Garlic-infused oil (low FODMAP)', ratio: '1 clove = 1 tsp oil', crohns: 'Better tolerated' },
                'onion': { sub: 'Green part of scallions or chives', ratio: 'To taste', crohns: 'Better tolerated' }
            };

            const matches = Object.entries(subs).filter(([key]) => key.includes(query));

            if (matches.length === 0) {
                results.innerHTML = '<p class="text-muted">No substitutions found. Try asking Nonna!</p>';
                return;
            }

            results.innerHTML = matches.map(([key, val]) => `
                <div class="card">
                    <strong>${key.charAt(0).toUpperCase() + key.slice(1)}</strong>
                    <p>‚Üí ${val.sub}</p>
                    <p class="text-muted">Ratio: ${val.ratio}</p>
                    ${val.crohns !== true ? `<p style="color: var(--success);">üíö Crohn's: ${val.crohns}</p>` : ''}
                </div>
            `).join('');
        }

        function toggleAccordion(header) {
            const item = header.parentElement;
            item.classList.toggle('open');
        }

        // ========================================
        // BATCH COOKING
        // ========================================
        function generateBatchPlan() {
            const items = Array.from(document.querySelectorAll('[name="batchItems"]:checked')).map(c => c.value);
            const time = document.getElementById('batch-time').value;

            if (items.length === 0) {
                alert('Please select at least one item to batch cook.');
                return;
            }

            askNonna(`Create a ${time}-hour batch cooking plan for: ${items.join(', ')}. Give me a timeline with what to start when, storage instructions, and how long each will keep.`);
        }

        // ========================================
        // GARDEN
        // ========================================
        function switchGardenTab(tab) {
            document.querySelectorAll('#view-garden .tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('#view-garden .tab-content').forEach(c => c.classList.remove('active'));

            event.target.classList.add('active');
            document.getElementById(`garden-${tab}`).classList.add('active');
        }

        function renderGarden() {
            const garden = getStorage(STORAGE.GARDEN) || { plants: [], harvests: [] };
            const container = document.getElementById('garden-plants');

            if (garden.plants.length === 0) {
                container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üå±</div><div class="empty-state-title">No plants tracked</div><p>Add plants to track your garden.</p></div>';
                return;
            }

            container.innerHTML = garden.plants.map(plant => `
                <div class="pantry-item">
                    <span class="pantry-item-icon">${getPlantEmoji(plant.name)}</span>
                    <div class="pantry-item-info">
                        <div class="pantry-item-name">${plant.name}</div>
                        <div class="pantry-item-qty">${plant.status} ‚Ä¢ Planted ${formatDate(plant.plantedAt)}</div>
                    </div>
                    <button class="btn btn-sm btn-ghost" onclick="harvestPlant('${plant.id}')">‚úÇÔ∏è Harvest</button>
                </div>
            `).join('');
        }

        function getPlantEmoji(name) {
            const emojis = { tomato: 'üçÖ', zucchini: 'ü•í', basil: 'üåø', pepper: 'ü´ë', cucumber: 'ü•í', lettuce: 'ü•¨', carrot: 'ü•ï', onion: 'üßÖ', garlic: 'üßÑ' };
            const lower = name.toLowerCase();
            for (const [key, emoji] of Object.entries(emojis)) {
                if (lower.includes(key)) return emoji;
            }
            return 'üå±';
        }

        function openAddPlantModal() {
            openModal(`
                <div class="modal-header">
                    <h2 class="modal-title">Add Plant</h2>
                    <button class="modal-close" onclick="closeModal()">√ó</button>
                </div>
                <div class="modal-body">
                    <div class="form-group">
                        <label>Plant Name</label>
                        <input type="text" class="form-input" id="plant-name" placeholder="e.g., Tomatoes">
                    </div>
                    <div class="form-group">
                        <label>Status</label>
                        <select class="form-select" id="plant-status">
                            <option value="Just Planted">üå± Just Planted</option>
                            <option value="Growing">üåø Growing</option>
                            <option value="Ready to Harvest">üçÖ Ready to Harvest</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Planting Date</label>
                        <input type="date" class="form-input" id="plant-date">
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
                    <button class="btn btn-primary" onclick="addPlant()">Add Plant</button>
                </div>
            `);
        }

        function addPlant() {
            const plant = {
                id: 'plant_' + Date.now(),
                name: document.getElementById('plant-name').value,
                status: document.getElementById('plant-status').value,
                plantedAt: document.getElementById('plant-date').value || new Date().toISOString()
            };

            const garden = getStorage(STORAGE.GARDEN) || { plants: [], harvests: [] };
            garden.plants.push(plant);
            setStorage(STORAGE.GARDEN, garden);
            closeModal();
            renderGarden();
        }

        function askNonnaWithGarden() {
            const garden = getStorage(STORAGE.GARDEN) || { plants: [] };
            if (garden.plants.length === 0) {
                const profile = getStorage(STORAGE.PROFILE);
                const growing = profile?.currentlyGrowing;
                if (growing) {
                    askNonna(`What can I make with these from my garden: ${growing}?`);
                } else {
                    askNonna('What vegetables should I plant in my Mediterranean garden?');
                }
            } else {
                const ready = garden.plants.filter(p => p.status.includes('Ready')).map(p => p.name);
                if (ready.length > 0) {
                    askNonna(`What can I make with my garden harvest: ${ready.join(', ')}?`);
                } else {
                    askNonna(`I have ${garden.plants.map(p => p.name).join(', ')} growing. Any recipe ideas for when they're ready?`);
                }
            }
        }

        // ========================================
        // CROHN'S CARE
        // ========================================
        function activateFlareMode() {
            state.flareMode = true;
            document.getElementById('flare-mode-banner').classList.remove('hidden');
            askNonna("I'm having a Crohn's flare and need gentle meal suggestions. What should I eat?");
        }

        function deactivateFlareMode() {
            state.flareMode = false;
            document.getElementById('flare-mode-banner').classList.add('hidden');
        }

        // ========================================
        // MEAL HISTORY
        // ========================================
        function renderHistory() {
            const history = getStorage(STORAGE.HISTORY) || [];
            const container = document.getElementById('history-list');
            const empty = document.getElementById('history-empty');

            // Update stats
            const now = new Date();
            const weekAgo = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
            const monthAgo = new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000);

            document.getElementById('stat-week').textContent = history.filter(h => new Date(h.date) >= weekAgo).length;
            document.getElementById('stat-month').textContent = history.filter(h => new Date(h.date) >= monthAgo).length;

            if (history.length === 0) {
                container.innerHTML = '';
                empty.classList.remove('hidden');
                return;
            }

            empty.classList.add('hidden');
            container.innerHTML = history.slice().reverse().slice(0, 20).map(meal => `
                <div class="pantry-item">
                    <span class="pantry-item-icon">üçΩÔ∏è</span>
                    <div class="pantry-item-info">
                        <div class="pantry-item-name">${meal.title}</div>
                        <div class="pantry-item-qty">${formatDate(meal.date)}${meal.rating ? ' ‚Ä¢ ' + '‚≠ê'.repeat(meal.rating) : ''}</div>
                    </div>
                </div>
            `).join('');
        }

        function markAsCooked(recipeId, title) {
            const history = getStorage(STORAGE.HISTORY) || [];
            history.push({
                id: 'meal_' + Date.now(),
                recipeId: recipeId,
                title: title,
                date: new Date().toISOString(),
                rating: 0,
                notes: ''
            });
            setStorage(STORAGE.HISTORY, history);

            // Update favorite if exists
            const favorites = getFavorites();
            const fav = favorites.find(f => f.id === recipeId);
            if (fav) {
                fav.lastCooked = new Date().toISOString();
                saveFavorites(favorites);
            }

            alert('Marked as cooked! üéâ');
        }

        function openAddMealModal() {
            openModal(`
                <div class="modal-header">
                    <h2 class="modal-title">Log a Meal</h2>
                    <button class="modal-close" onclick="closeModal()">√ó</button>
                </div>
                <div class="modal-body">
                    <div class="form-group">
                        <label>What did you make?</label>
                        <input type="text" class="form-input" id="meal-title" placeholder="e.g., Lemon Herb Chicken">
                    </div>
                    <div class="form-group">
                        <label>Date</label>
                        <input type="date" class="form-input" id="meal-date" value="${new Date().toISOString().split('T')[0]}">
                    </div>
                    <div class="form-group">
                        <label>Notes (optional)</label>
                        <textarea class="form-textarea" id="meal-notes" placeholder="How was it?"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
                    <button class="btn btn-primary" onclick="logMeal()">Log Meal</button>
                </div>
            `);
        }

        function logMeal() {
            const meal = {
                id: 'meal_' + Date.now(),
                title: document.getElementById('meal-title').value,
                date: document.getElementById('meal-date').value,
                notes: document.getElementById('meal-notes').value,
                rating: 0
            };

            const history = getStorage(STORAGE.HISTORY) || [];
            history.push(meal);
            setStorage(STORAGE.HISTORY, history);
            closeModal();
            renderHistory();
        }

        // ========================================
        // SETTINGS
        // ========================================
        function loadPreferences() {
            const prefs = getStorage(STORAGE.PREFS) || {};
            if (prefs.darkMode) {
                document.body.classList.add('dark-mode');
                const toggle = document.getElementById('dark-mode-toggle');
                if (toggle) toggle.checked = true;
            }
        }

        function toggleDarkMode() {
            const toggle = document.getElementById('dark-mode-toggle');
            document.body.classList.toggle('dark-mode', toggle.checked);
            const prefs = getStorage(STORAGE.PREFS) || {};
            prefs.darkMode = toggle.checked;
            setStorage(STORAGE.PREFS, prefs);
        }

        function exportAllData() {
            const data = {};
            Object.values(STORAGE).forEach(key => {
                data[key] = getStorage(key);
            });
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `tavola-backup-${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);
        }

        function importData() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = (e) => {
                const file = e.target.files[0];
                const reader = new FileReader();
                reader.onload = (evt) => {
                    try {
                        const data = JSON.parse(evt.target.result);
                        Object.entries(data).forEach(([key, value]) => {
                            if (value) setStorage(key, value);
                        });
                        alert('Data imported successfully!');
                        location.reload();
                    } catch (err) {
                        alert('Error importing data: ' + err.message);
                    }
                };
                reader.readAsText(file);
            };
            input.click();
        }

        function confirmClearAllData() {
            if (confirm('Are you sure you want to clear ALL data? This cannot be undone.')) {
                Object.values(STORAGE).forEach(key => localStorage.removeItem(key));
                location.reload();
            }
        }

        // ========================================
        // MODAL
        // ========================================
        function openModal(content) {
            document.getElementById('modal-content').innerHTML = content;
            document.getElementById('modal-overlay').classList.add('active');
        }

        function closeModal() {
            document.getElementById('modal-overlay').classList.remove('active');
        }

        // Close modal on overlay click
        document.getElementById('modal-overlay').addEventListener('click', (e) => {
            if (e.target === e.currentTarget) closeModal();
        });

        // ========================================
        // UTILITIES
        // ========================================
        function formatDate(dateStr) {
            if (!dateStr) return '';
            const date = new Date(dateStr);
            const now = new Date();
            const diffDays = Math.floor((now - date) / (1000 * 60 * 60 * 24));

            if (diffDays === 0) return 'Today';
            if (diffDays === 1) return 'Yesterday';
            if (diffDays < 7) return `${diffDays} days ago`;
            return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
        }

        function shareRecipe(recipeId) {
            const url = window.location.href.split('?')[0] + '?recipe=' + recipeId;
            if (navigator.share) {
                navigator.share({ title: 'Recipe from Tavola', url: url });
            } else {
                navigator.clipboard.writeText(url);
                alert('Link copied to clipboard!');
            }
        }

        function printRecipe(recipeId) {
            window.print();
        }
    </script>
</body>
</html>
