<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tavola - Mediterranean Meal Planning</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Dancing+Script:wght@600;700&family=Lora:wght@400;500;600&family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">
    <style>
        :root {
            --cerulean: #007BA7;
            --cerulean-dark: #006691;
            --cerulean-light: #3399bf;
            --seafoam: #7FD8BE;
            --seafoam-light: #b8e8d8;
            --seafoam-dark: #5cb89a;
            --navy: #1A2332;
            --cream: #FFF8E7;
            --white: #FFFFFF;
            --gray-light: #f5f5f5;
            --gray-medium: #e0e0e0;
            --gray-text: #666;
            --warning: #ff9800;
            --danger: #cc4444;
            --success: #4caf50;
            --shadow: 0 2px 8px rgba(26, 35, 50, 0.08);
            --shadow-lg: 0 4px 16px rgba(26, 35, 50, 0.12);
            --radius: 12px;
            --radius-sm: 8px;
            --radius-lg: 16px;
        }
        .dark-mode {
            --cream: #1A1A1A;
            --white: #2A2A2A;
            --navy: #E8E8E8;
            --gray-light: #333;
            --gray-medium: #444;
            --gray-text: #aaa;
            --cerulean: #3399bf;
            --shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
            --shadow-lg: 0 4px 16px rgba(0, 0, 0, 0.4);
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background-color: var(--cream);
            color: var(--navy);
            line-height: 1.6;
            min-height: 100vh;
            padding-bottom: 80px;
        }
        .container { max-width: 900px; margin: 0 auto; padding: 0 16px; }
        h1, h2, h3 { font-family: 'Lora', serif; font-weight: 500; }
        .logo { font-family: 'Dancing Script', cursive; font-size: 2rem; font-weight: 700; color: var(--cerulean); text-decoration: none; }

        /* Header */
        .header {
            background: var(--white);
            border-bottom: 1px solid var(--gray-medium);
            padding: 12px 0;
            position: sticky;
            top: 0;
            z-index: 100;
        }
        .header-content { display: flex; justify-content: space-between; align-items: center; }
        .header-right { display: flex; align-items: center; gap: 8px; }
        .header-search {
            display: flex;
            align-items: center;
            background: var(--gray-light);
            border-radius: 20px;
            padding: 6px 12px;
            gap: 8px;
            max-width: 200px;
        }
        .header-search input {
            border: none;
            background: transparent;
            outline: none;
            font-size: 0.9rem;
            width: 100%;
            color: var(--navy);
        }
        .icon-btn {
            background: none;
            border: none;
            padding: 8px;
            border-radius: var(--radius-sm);
            cursor: pointer;
            color: var(--navy);
            font-size: 1.2rem;
            transition: background 0.2s;
        }
        .icon-btn:hover { background: var(--gray-light); }

        /* Bottom Navigation - 5 tabs */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--white);
            border-top: 1px solid var(--gray-medium);
            display: flex;
            justify-content: space-around;
            padding: 6px 0 max(6px, env(safe-area-inset-bottom));
            z-index: 100;
        }
        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 6px 4px;
            border: none;
            background: none;
            color: var(--gray-text);
            font-size: 0.6rem;
            font-family: inherit;
            cursor: pointer;
            border-radius: var(--radius-sm);
            transition: all 0.2s;
            min-width: 48px;
        }
        .nav-item span.icon { font-size: 1.4rem; margin-bottom: 2px; }
        .nav-item.active { color: var(--cerulean); background: var(--seafoam-light); }
        .nav-item:hover:not(.active) { background: var(--gray-light); }

        /* Buttons */
        .btn {
            padding: 12px 24px;
            border-radius: var(--radius);
            font-family: inherit;
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            border: none;
            min-height: 44px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        .btn-primary { background: var(--cerulean); color: white; }
        .btn-primary:hover { background: var(--cerulean-dark); }
        .btn-secondary { background: var(--white); color: var(--cerulean); border: 2px solid var(--cerulean); }
        .btn-secondary:hover { background: var(--seafoam-light); }
        .btn-ghost { background: transparent; color: var(--cerulean); }
        .btn-ghost:hover { background: var(--seafoam-light); }
        .btn-sm { padding: 8px 16px; font-size: 0.9rem; min-height: 36px; }
        .btn-block { width: 100%; }

        /* Cards */
        .card {
            background: var(--white);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            padding: 20px;
            margin-bottom: 16px;
        }
        .card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; }
        .card-title { font-size: 1.1rem; color: var(--cerulean); }

        /* Quick Action Tiles */
        .action-tiles { display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; margin-bottom: 20px; }
        .action-tile {
            background: var(--white);
            border-radius: var(--radius);
            padding: 20px 16px;
            text-align: center;
            cursor: pointer;
            box-shadow: var(--shadow);
            transition: all 0.2s;
            border: 2px solid transparent;
        }
        .action-tile:hover { transform: translateY(-2px); box-shadow: var(--shadow-lg); border-color: var(--cerulean); }
        .action-tile-icon { font-size: 2rem; margin-bottom: 8px; }
        .action-tile-title { font-weight: 600; color: var(--navy); margin-bottom: 4px; }
        .action-tile-desc { font-size: 0.8rem; color: var(--gray-text); }

        /* Stats Bar */
        .stats-bar {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
            background: var(--white);
            border-radius: var(--radius);
            padding: 12px;
            margin-bottom: 16px;
            box-shadow: var(--shadow);
        }
        @media (min-width: 640px) { .stats-bar { grid-template-columns: repeat(4, 1fr); } }
        .stat-item { display: flex; align-items: center; gap: 8px; font-size: 0.85rem; }
        .stat-item .icon { font-size: 1.1rem; }

        /* Forms */
        .form-group { margin-bottom: 16px; }
        .form-group label { display: block; font-weight: 500; margin-bottom: 6px; font-size: 0.95rem; }
        .form-input, .form-select, .form-textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--gray-medium);
            border-radius: var(--radius-sm);
            font-family: inherit;
            font-size: 1rem;
            color: var(--navy);
            background: var(--white);
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        .form-input:focus, .form-select:focus, .form-textarea:focus {
            outline: none;
            border-color: var(--cerulean);
            box-shadow: 0 0 0 3px rgba(0, 123, 167, 0.15);
        }
        .form-textarea { min-height: 80px; resize: vertical; }
        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
        @media (max-width: 600px) { .form-row { grid-template-columns: 1fr; } }
        .checkbox-item, .radio-item { display: flex; align-items: center; gap: 10px; padding: 8px 0; cursor: pointer; }
        .checkbox-item input, .radio-item input { width: 20px; height: 20px; accent-color: var(--cerulean); cursor: pointer; }

        /* Tags */
        .tag {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 500;
            background: var(--seafoam-light);
            color: var(--navy);
            margin-right: 6px;
            margin-bottom: 6px;
        }
        /* Health Tags (Green shades) */
        .tag-crohns { background: #e8f5e9; color: #2e7d32; }
        .tag-heart { background: #ffebee; color: #c62828; }
        .tag-bp { background: #fce4ec; color: #ad1457; }
        .tag-diabetic { background: #fff3e0; color: #e65100; }
        .tag-anti-inflammatory { background: #e8f5e9; color: #1b5e20; }
        .tag-low-sodium { background: #f3e5f5; color: #7b1fa2; }
        .tag-low-carb { background: #fff8e1; color: #ff6f00; }
        .tag-gut-friendly { background: #e0f2f1; color: #00695c; }
        .tag-gluten-free { background: #fbe9e7; color: #bf360c; }

        /* Prep Tags (Orange/Yellow shades) */
        .tag-quick { background: #fff3e0; color: #ef6c00; }
        .tag-meal-prep { background: #fff8e1; color: #f57f17; }
        .tag-freezer { background: #e3f2fd; color: #0277bd; }
        .tag-one-pot { background: #f1f8e9; color: #558b2f; }

        /* Flavor/Style Tags (Blue/Purple shades) */
        .tag-mediterranean { background: #e3f2fd; color: #1565c0; }
        .tag-citrus { background: #fffde7; color: #f9a825; }
        .tag-garlic { background: #efebe9; color: #5d4037; }
        .tag-spicy { background: #ffebee; color: #d32f2f; }
        .tag-comfort { background: #fce4ec; color: #c2185b; }
        .tag-fresh { background: #e8f5e9; color: #388e3c; }

        /* Protein Tags */
        .tag-fish { background: #e1f5fe; color: #0277bd; }
        .tag-chicken { background: #fff8e1; color: #f57c00; }
        .tag-vegetarian { background: #f1f8e9; color: #689f38; }
        .tag-high-protein { background: #ffecb3; color: #ff6f00; }

        /* Tag Filter Chips */
        .tag-filter-section {
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid var(--gray-medium);
        }
        .tag-filter-label {
            font-weight: 500;
            font-size: 0.9rem;
            margin-bottom: 8px;
            display: block;
        }
        .tag-filter-chips {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
        }
        .tag-filter-chip {
            padding: 4px 10px;
            border-radius: 16px;
            font-size: 0.75rem;
            cursor: pointer;
            border: 1px solid var(--gray-medium);
            background: var(--white);
            color: var(--gray-text);
            transition: all 0.2s;
        }
        .tag-filter-chip:hover {
            border-color: var(--cerulean);
            color: var(--cerulean);
        }
        .tag-filter-chip.active {
            background: var(--cerulean);
            color: white;
            border-color: var(--cerulean);
        }
        .tag-filter-clear {
            font-size: 0.75rem;
            color: var(--cerulean);
            cursor: pointer;
            margin-top: 8px;
            display: none;
        }
        .tag-filter-clear.visible {
            display: inline-block;
        }
        .tag-filter-clear:hover {
            text-decoration: underline;
        }

        /* Nutrition Info Box */
        .nutrition-box {
            background: var(--gray-light);
            border-radius: var(--radius-sm);
            padding: 12px 16px;
            margin: 12px 0;
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
            font-size: 0.85rem;
        }
        @media (min-width: 500px) {
            .nutrition-box { grid-template-columns: repeat(6, 1fr); }
        }
        .nutrition-item {
            text-align: center;
        }
        .nutrition-value {
            font-weight: 600;
            color: var(--cerulean);
            font-size: 1rem;
        }
        .nutrition-label {
            font-size: 0.7rem;
            color: var(--gray-text);
            text-transform: uppercase;
        }

        /* Health Benefits Box */
        .health-benefits {
            background: linear-gradient(135deg, var(--seafoam-light) 0%, #e8f5e9 100%);
            border-left: 4px solid var(--success);
            border-radius: 0 var(--radius-sm) var(--radius-sm) 0;
            padding: 12px 16px;
            margin: 12px 0;
        }
        .health-benefits-title {
            font-weight: 600;
            color: var(--success);
            margin-bottom: 6px;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .health-benefits-text {
            font-size: 0.9rem;
            color: var(--navy);
        }

        /* Workout Dashboard */
        .workout-stats {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-bottom: 20px;
        }
        @media (min-width: 500px) {
            .workout-stats { grid-template-columns: repeat(4, 1fr); }
        }
        .workout-stat {
            background: var(--white);
            border-radius: var(--radius);
            padding: 16px;
            text-align: center;
            box-shadow: var(--shadow);
        }
        .workout-stat-value {
            font-size: 1.8rem;
            font-weight: 600;
            color: var(--cerulean);
        }
        .workout-stat-label {
            font-size: 0.75rem;
            color: var(--gray-text);
            text-transform: uppercase;
            margin-top: 4px;
        }
        .workout-stat.positive .workout-stat-value { color: var(--success); }
        .workout-stat.negative .workout-stat-value { color: var(--danger); }
        .workout-stat.balance { grid-column: span 2; }
        @media (min-width: 500px) {
            .workout-stat.balance { grid-column: span 1; }
        }

        /* Calorie Balance Bar */
        .calorie-balance {
            background: var(--white);
            border-radius: var(--radius);
            padding: 16px;
            margin-bottom: 20px;
            box-shadow: var(--shadow);
        }
        .calorie-balance-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }
        .calorie-balance-title {
            font-weight: 600;
            color: var(--cerulean);
        }
        .calorie-balance-net {
            font-weight: 600;
            font-size: 1.1rem;
        }
        .calorie-balance-net.surplus { color: var(--danger); }
        .calorie-balance-net.deficit { color: var(--success); }
        .calorie-balance-net.balanced { color: var(--gray-text); }
        .calorie-bar-container {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 8px;
        }
        .calorie-bar-label {
            font-size: 0.75rem;
            color: var(--gray-text);
            width: 40px;
        }
        .calorie-bar {
            flex: 1;
            height: 20px;
            background: var(--gray-light);
            border-radius: 10px;
            overflow: hidden;
        }
        .calorie-bar-fill {
            height: 100%;
            border-radius: 10px;
            transition: width 0.3s ease;
        }
        .calorie-bar-fill.in { background: linear-gradient(90deg, var(--cerulean), var(--cerulean-light)); }
        .calorie-bar-fill.out { background: linear-gradient(90deg, var(--success), #81c784); }
        .calorie-bar-value {
            font-size: 0.8rem;
            font-weight: 500;
            width: 60px;
            text-align: right;
        }

        /* Workout Calendar */
        .workout-calendar {
            background: var(--white);
            border-radius: var(--radius);
            padding: 16px;
            margin-bottom: 20px;
            box-shadow: var(--shadow);
        }
        .workout-calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }
        .workout-calendar-title {
            font-weight: 600;
            color: var(--cerulean);
        }
        .workout-calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 4px;
        }
        .workout-day-header {
            text-align: center;
            font-size: 0.7rem;
            color: var(--gray-text);
            padding: 4px;
            font-weight: 500;
        }
        .workout-day {
            aspect-ratio: 1;
            border-radius: var(--radius-sm);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.2s;
            background: var(--gray-light);
        }
        .workout-day:hover { background: var(--seafoam-light); }
        .workout-day.today { border: 2px solid var(--cerulean); }
        .workout-day.has-workout { background: var(--seafoam); }
        .workout-day.has-workout .workout-day-indicator { display: block; }
        .workout-day-date { font-weight: 500; }
        .workout-day-indicator {
            font-size: 0.6rem;
            display: none;
        }

        /* Workout List */
        .workout-list {
            background: var(--white);
            border-radius: var(--radius);
            padding: 16px;
            box-shadow: var(--shadow);
        }
        .workout-list-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }
        .workout-list-title {
            font-weight: 600;
            color: var(--cerulean);
        }
        .workout-item {
            display: flex;
            align-items: center;
            padding: 12px;
            background: var(--gray-light);
            border-radius: var(--radius-sm);
            margin-bottom: 8px;
            gap: 12px;
        }
        .workout-item:last-child { margin-bottom: 0; }
        .workout-item-icon {
            font-size: 1.5rem;
            width: 40px;
            text-align: center;
        }
        .workout-item-details { flex: 1; }
        .workout-item-name {
            font-weight: 500;
            margin-bottom: 2px;
        }
        .workout-item-meta {
            font-size: 0.8rem;
            color: var(--gray-text);
        }
        .workout-item-calories {
            font-weight: 600;
            color: var(--success);
            font-size: 0.9rem;
        }
        .workout-item-actions {
            display: flex;
            gap: 4px;
        }

        /* Workout Form */
        .workout-type-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
            margin-bottom: 16px;
        }
        @media (min-width: 500px) {
            .workout-type-grid { grid-template-columns: repeat(4, 1fr); }
        }
        .workout-type-btn {
            padding: 12px 8px;
            border: 2px solid var(--gray-medium);
            border-radius: var(--radius-sm);
            background: var(--white);
            cursor: pointer;
            text-align: center;
            transition: all 0.2s;
        }
        .workout-type-btn:hover { border-color: var(--cerulean); }
        .workout-type-btn.selected {
            border-color: var(--cerulean);
            background: var(--seafoam-light);
        }
        .workout-type-icon { font-size: 1.5rem; display: block; margin-bottom: 4px; }
        .workout-type-name { font-size: 0.75rem; }

        /* Quick Log Presets */
        .quick-log-presets {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 16px;
        }
        .quick-log-btn {
            padding: 8px 16px;
            border-radius: 20px;
            border: 1px solid var(--gray-medium);
            background: var(--white);
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.2s;
        }
        .quick-log-btn:hover {
            border-color: var(--cerulean);
            background: var(--seafoam-light);
        }

        /* Sections */
        .section { padding: 20px 0; }
        .section-title {
            font-family: 'Lora', serif;
            font-size: 1.4rem;
            color: var(--cerulean);
            margin-bottom: 16px;
            padding-bottom: 8px;
            border-bottom: 2px solid var(--seafoam);
        }

        /* Views */
        .view { display: none; }
        .view.active { display: block; }

        /* Welcome Screen */
        .welcome-screen {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: calc(100vh - 100px);
            text-align: center;
            padding: 40px 20px;
        }
        .welcome-logo { font-family: 'Dancing Script', cursive; font-size: 4rem; color: var(--cerulean); margin-bottom: 8px; }
        .welcome-subtitle { font-family: 'Lora', serif; font-size: 1.3rem; color: var(--navy); margin-bottom: 8px; }
        .welcome-tagline { color: var(--gray-text); margin-bottom: 32px; max-width: 400px; }

        /* Chat Interface */
        .chat-container { display: flex; flex-direction: column; height: calc(100vh - 180px); }
        .chat-messages { flex: 1; overflow-y: auto; padding: 16px 0; }
        .message { margin-bottom: 16px; animation: fadeIn 0.3s ease; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .message-user { display: flex; justify-content: flex-end; }
        .message-user .message-bubble {
            background: var(--seafoam);
            color: var(--navy);
            border-radius: var(--radius) var(--radius) 4px var(--radius);
            max-width: 85%;
            padding: 12px 16px;
        }
        .message-assistant { display: flex; justify-content: flex-start; }
        .message-assistant .message-bubble {
            background: var(--white);
            border: 1px solid var(--seafoam);
            border-radius: var(--radius) var(--radius) var(--radius) 4px;
            max-width: 90%;
            padding: 16px;
            box-shadow: var(--shadow);
        }
        .chat-input-area { background: var(--white); border-top: 1px solid var(--gray-medium); padding: 12px 0; }
        .chat-input-wrapper { display: flex; gap: 8px; align-items: flex-end; }
        .chat-input {
            flex: 1;
            border: 1px solid var(--gray-medium);
            border-radius: var(--radius);
            padding: 12px;
            font-family: inherit;
            font-size: 1rem;
            resize: none;
            min-height: 48px;
            max-height: 120px;
        }
        .chat-input:focus { outline: none; border-color: var(--cerulean); }
        .voice-btn {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            border: none;
            background: var(--gray-light);
            color: var(--navy);
            font-size: 1.3rem;
            cursor: pointer;
            transition: all 0.2s;
        }
        .voice-btn:hover { background: var(--gray-medium); }
        .voice-btn.recording { background: var(--danger); color: white; animation: pulse 1s infinite; }
        @keyframes pulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.05); } }
        .send-btn {
            width: 48px;
            height: 48px;
            border-radius: var(--radius);
            border: none;
            background: var(--cerulean);
            color: white;
            font-size: 1.2rem;
            cursor: pointer;
            transition: background 0.2s;
        }
        .send-btn:hover { background: var(--cerulean-dark); }
        .send-btn:disabled { opacity: 0.5; cursor: not-allowed; }

        /* Quick Actions */
        .quick-actions { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 12px; }
        .quick-action {
            background: var(--white);
            border: 1px solid var(--seafoam);
            padding: 8px 14px;
            border-radius: 20px;
            font-size: 0.85rem;
            color: var(--navy);
            cursor: pointer;
            transition: all 0.2s;
        }
        .quick-action:hover { background: var(--seafoam-light); border-color: var(--cerulean); }

        /* Thinking Animation - Nonna themed */
        .thinking { display: flex; align-items: center; gap: 12px; color: var(--gray-text); padding: 16px; }
        .thinking-animation {
            font-size: 2rem;
            animation: cook 1.5s ease-in-out infinite;
        }
        @keyframes cook { 0%, 100% { transform: rotate(-5deg); } 50% { transform: rotate(5deg); } }
        .thinking-text { font-style: italic; }

        /* Recipe Card */
        .recipe-card {
            background: var(--white);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-lg);
            overflow: hidden;
            margin: 16px 0;
        }
        .recipe-header {
            background: linear-gradient(135deg, var(--cerulean) 0%, var(--seafoam-dark) 100%);
            color: white;
            padding: 20px;
            position: relative;
        }
        .recipe-title { font-family: 'Lora', serif; font-size: 1.5rem; margin-bottom: 8px; padding-right: 100px; }
        .recipe-actions { position: absolute; top: 12px; right: 12px; display: flex; gap: 8px; }
        .recipe-action-btn {
            background: rgba(255,255,255,0.2);
            border: none;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            color: white;
            cursor: pointer;
            transition: background 0.2s;
            font-size: 1rem;
        }
        .recipe-action-btn:hover { background: rgba(255,255,255,0.3); }
        .recipe-action-btn.favorited { background: var(--danger); }
        .recipe-meta { display: flex; flex-wrap: wrap; gap: 16px; margin-top: 12px; font-size: 0.9rem; }
        .recipe-meta-item { display: flex; align-items: center; gap: 4px; }
        .recipe-tags { padding: 12px 20px; background: var(--gray-light); }
        .recipe-body { padding: 20px; }
        .recipe-section { margin-bottom: 24px; }
        .recipe-section-title {
            font-family: 'Lora', serif;
            font-size: 1.1rem;
            color: var(--cerulean);
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .ingredient-item {
            display: flex;
            align-items: flex-start;
            gap: 10px;
            padding: 8px 0;
            border-bottom: 1px solid var(--gray-light);
        }
        .ingredient-item:last-child { border-bottom: none; }
        .ingredient-checkbox { width: 22px; height: 22px; accent-color: var(--cerulean); cursor: pointer; flex-shrink: 0; margin-top: 2px; }
        .ingredient-text.checked { text-decoration: line-through; color: var(--gray-text); }
        .instruction-step { display: flex; gap: 12px; padding: 12px 0; border-bottom: 1px solid var(--gray-light); }
        .instruction-step:last-child { border-bottom: none; }
        .step-number {
            width: 28px;
            height: 28px;
            background: var(--cerulean);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 0.9rem;
            flex-shrink: 0;
        }
        .recipe-notes {
            background: var(--seafoam-light);
            border-radius: var(--radius);
            padding: 16px;
            margin-top: 16px;
        }
        .recipe-notes-title { font-weight: 600; margin-bottom: 8px; color: var(--cerulean); }

        /* Recipe Card Actions Bar */
        .recipe-card-actions {
            display: flex;
            gap: 8px;
            padding: 16px 20px;
            border-top: 1px solid var(--gray-light);
            background: var(--gray-light);
        }
        .recipe-card-actions .btn { flex: 1; }

        /* Nonna's Tip */
        .nonna-tip {
            background: linear-gradient(135deg, var(--cream) 0%, var(--seafoam-light) 100%);
            border-left: 4px solid var(--cerulean);
            border-radius: 0 var(--radius) var(--radius) 0;
            padding: 16px;
            margin: 16px 0;
        }
        .nonna-tip-header { display: flex; align-items: center; gap: 8px; margin-bottom: 8px; font-weight: 600; color: var(--cerulean); }
        .nonna-tip-text { font-style: italic; color: var(--navy); }
        .nonna-tip-signature { text-align: right; margin-top: 8px; color: var(--gray-text); font-size: 0.9rem; }

        /* Tabs */
        .tabs {
            display: flex;
            gap: 4px;
            background: var(--gray-light);
            padding: 4px;
            border-radius: var(--radius);
            margin-bottom: 16px;
            overflow-x: auto;
        }
        .tab {
            flex: 1;
            padding: 10px 16px;
            border: none;
            background: transparent;
            font-family: inherit;
            font-size: 0.9rem;
            font-weight: 500;
            color: var(--gray-text);
            cursor: pointer;
            border-radius: var(--radius-sm);
            white-space: nowrap;
            transition: all 0.2s;
        }
        .tab.active { background: var(--white); color: var(--cerulean); box-shadow: var(--shadow); }
        .tab:hover:not(.active) { color: var(--navy); }
        .tab-content { display: none; }
        .tab-content.active { display: block; }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 48px 24px;
            color: var(--gray-text);
        }
        .empty-state-icon { font-size: 3.5rem; margin-bottom: 16px; opacity: 0.7; }
        .empty-state-title { font-family: 'Lora', serif; font-size: 1.3rem; color: var(--navy); margin-bottom: 8px; }
        .empty-state-text { margin-bottom: 20px; max-width: 300px; margin-left: auto; margin-right: auto; }

        /* Grid */
        .grid { display: grid; gap: 16px; }
        .grid-2 { grid-template-columns: repeat(2, 1fr); }
        .grid-3 { grid-template-columns: repeat(3, 1fr); }
        @media (max-width: 768px) { .grid-2, .grid-3 { grid-template-columns: 1fr; } }
        @media (min-width: 769px) and (max-width: 1024px) { .grid-3 { grid-template-columns: repeat(2, 1fr); } }

        /* Recipe Library Card */
        .library-card {
            background: var(--white);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            overflow: hidden;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            position: relative;
        }
        .library-card:hover { transform: translateY(-2px); box-shadow: var(--shadow-lg); }
        .library-card-banner {
            height: 80px;
            background: linear-gradient(135deg, var(--cerulean) 0%, var(--seafoam-dark) 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            position: relative;
        }
        .library-card-favorite {
            position: absolute;
            top: 8px;
            right: 8px;
            font-size: 1.2rem;
        }
        .library-card-body { padding: 12px; }
        .library-card-title { font-weight: 600; font-size: 0.95rem; margin-bottom: 4px; color: var(--navy); }
        .library-card-meta { font-size: 0.75rem; color: var(--gray-text); display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 6px; }
        .library-card-tags { display: flex; flex-wrap: wrap; gap: 4px; margin-top: 8px; }
        .library-card-tags .tag { font-size: 0.65rem; padding: 2px 6px; margin: 0; }
        .library-card-rating { color: #ffc107; font-size: 0.8rem; margin-bottom: 4px; }
        .library-card-cooked { font-size: 0.75rem; color: var(--gray-text); margin-top: 2px; }
        .card-calories {
            position: absolute;
            top: 8px;
            left: 8px;
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
        }
        .card-macros {
            font-size: 0.7rem;
            color: var(--gray-text);
            margin-bottom: 4px;
        }

        /* Star Rating */
        .star-rating {
            display: inline-flex;
            gap: 2px;
            font-size: 1.5rem;
            cursor: pointer;
        }
        .star-rating.readonly { cursor: default; }
        .star-rating.small { font-size: 1rem; }
        .star-rating .star {
            color: var(--gray-medium);
            transition: color 0.15s, transform 0.15s;
        }
        .star-rating .star.filled { color: #ffc107; }
        .star-rating .star.half {
            background: linear-gradient(90deg, #ffc107 50%, var(--gray-medium) 50%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        .star-rating:not(.readonly) .star:hover { transform: scale(1.2); }
        .star-rating-display {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            font-size: 0.85rem;
        }
        .star-rating-display .stars { color: #ffc107; }
        .star-rating-display .rating-text { color: var(--gray-text); }

        /* Rating Section in Recipe Card */
        .recipe-rating-section {
            padding: 16px 20px;
            border-top: 1px solid var(--gray-light);
            background: var(--gray-light);
        }
        .recipe-rating-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }
        .recipe-rating-title { font-weight: 500; color: var(--navy); }
        .recipe-rating-stats { font-size: 0.85rem; color: var(--gray-text); }
        .recipe-notes-input {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--gray-medium);
            border-radius: var(--radius-sm);
            font-family: inherit;
            font-size: 0.9rem;
            resize: vertical;
            min-height: 60px;
            margin-top: 12px;
        }
        .recipe-notes-input:focus {
            outline: none;
            border-color: var(--cerulean);
        }

        /* Cooking History */
        .cooking-history { margin-top: 16px; }
        .cooking-history-item {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            padding: 10px 0;
            border-bottom: 1px solid var(--gray-light);
            font-size: 0.9rem;
        }
        .cooking-history-item:last-child { border-bottom: none; }
        .cooking-history-date { color: var(--gray-text); }
        .cooking-history-rating { color: #ffc107; }
        .cooking-history-notes {
            font-size: 0.85rem;
            color: var(--gray-text);
            font-style: italic;
            margin-top: 4px;
        }

        /* Bulk Actions */
        .bulk-actions-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 16px;
            background: var(--cerulean);
            color: white;
            border-radius: var(--radius);
            margin-bottom: 16px;
            flex-wrap: wrap;
            gap: 12px;
        }
        .bulk-count { font-weight: 500; }
        .bulk-buttons { display: flex; gap: 8px; flex-wrap: wrap; }
        .bulk-buttons .btn { font-size: 0.8rem; padding: 6px 12px; }

        /* Edit Mode Cards */
        .library-card.edit-mode {
            position: relative;
            cursor: pointer;
        }
        .library-card.edit-mode::before {
            content: '';
            position: absolute;
            top: 8px;
            left: 8px;
            width: 24px;
            height: 24px;
            border: 2px solid white;
            border-radius: 4px;
            background: rgba(255,255,255,0.3);
            z-index: 10;
        }
        .library-card.edit-mode.selected::before {
            background: var(--cerulean);
            border-color: var(--cerulean);
        }
        .library-card.edit-mode.selected::after {
            content: 'âœ“';
            position: absolute;
            top: 8px;
            left: 12px;
            color: white;
            font-weight: bold;
            font-size: 1rem;
            z-index: 11;
        }
        .library-card.edit-mode.selected {
            box-shadow: 0 0 0 3px var(--cerulean);
        }

        /* Week Planner */
        .week-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
            flex-wrap: wrap;
            gap: 12px;
        }
        .week-nav { display: flex; align-items: center; gap: 12px; }
        .week-nav-btn { background: var(--gray-light); border: none; padding: 8px 12px; border-radius: var(--radius-sm); cursor: pointer; font-size: 1rem; }
        .week-nav-btn:hover { background: var(--gray-medium); }
        .week-title { font-family: 'Lora', serif; font-size: 1.2rem; color: var(--navy); }
        .week-actions { display: flex; gap: 8px; flex-wrap: wrap; }

        .week-day {
            background: var(--white);
            border-radius: var(--radius);
            padding: 16px;
            margin-bottom: 16px;
            box-shadow: var(--shadow);
        }
        .week-day-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
        .week-day-name { font-weight: 600; color: var(--cerulean); }
        .week-day-date { font-size: 0.85rem; color: var(--gray-text); }
        .week-day-meals { display: flex; flex-direction: column; gap: 8px; }
        .week-meal-slot {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 12px;
            background: var(--gray-light);
            border-radius: var(--radius-sm);
            min-height: 52px;
        }
        .week-meal-slot.empty {
            border: 1px dashed var(--gray-medium);
            background: transparent;
            cursor: pointer;
            transition: all 0.2s;
        }
        .week-meal-slot.empty:hover {
            border-color: var(--cerulean);
            background: var(--seafoam-light);
        }
        .meal-slot-icon { font-size: 1.1rem; width: 24px; text-align: center; }
        .meal-slot-type {
            font-size: 0.7rem;
            text-transform: uppercase;
            color: var(--gray-text);
            font-weight: 500;
            width: 65px;
            flex-shrink: 0;
        }
        .meal-slot-content { flex: 1; min-width: 0; }
        .meal-slot-title {
            font-weight: 500;
            font-size: 0.9rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .meal-slot-calories {
            font-size: 0.75rem;
            color: var(--success);
            font-weight: 500;
        }
        .meal-slot-actions { display: flex; gap: 2px; }
        .meal-slot-actions .icon-btn { padding: 4px; font-size: 0.9rem; }
        .meal-slot-add {
            color: var(--gray-text);
            font-size: 0.85rem;
            flex: 1;
        }
        .week-day-summary {
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid var(--gray-medium);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 8px;
        }
        .day-total-calories {
            font-weight: 600;
            color: var(--cerulean);
        }
        .day-workout-info {
            font-size: 0.85rem;
            color: var(--gray-text);
        }
        .day-net-calories {
            font-size: 0.85rem;
            font-weight: 500;
        }
        .day-net-calories.deficit { color: var(--success); }
        .day-net-calories.surplus { color: var(--danger); }
        .day-net-calories.balanced { color: var(--gray-text); }
        /* Legacy single meal support */
        .week-day-meal {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            background: var(--gray-light);
            border-radius: var(--radius-sm);
        }
        .week-day-meal-info { flex: 1; }
        .week-day-meal-title { font-weight: 500; }
        .week-day-meal-meta { font-size: 0.8rem; color: var(--gray-text); }
        .week-day-meal-actions { display: flex; gap: 4px; }
        .week-day-empty {
            padding: 24px;
            text-align: center;
            color: var(--gray-text);
            border: 2px dashed var(--gray-medium);
            border-radius: var(--radius-sm);
            cursor: pointer;
            transition: all 0.2s;
        }
        .week-day-empty:hover { border-color: var(--cerulean); color: var(--cerulean); }

        /* Week Plan Summary Card */
        .week-plan-card {
            background: linear-gradient(135deg, var(--cerulean) 0%, var(--seafoam-dark) 100%);
            color: white;
            border-radius: var(--radius);
            padding: 20px;
            margin: 16px 0;
        }
        .week-plan-card h3 { margin-bottom: 12px; }
        .week-plan-item { padding: 8px 0; border-bottom: 1px solid rgba(255,255,255,0.2); display: flex; justify-content: space-between; }
        .week-plan-item:last-child { border-bottom: none; }
        .week-plan-actions { display: flex; gap: 12px; margin-top: 16px; }
        .week-plan-actions .btn { flex: 1; background: rgba(255,255,255,0.2); border: none; }
        .week-plan-actions .btn:hover { background: rgba(255,255,255,0.3); }

        /* Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(26, 35, 50, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 20px;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s, visibility 0.3s;
        }
        .modal-overlay.active { opacity: 1; visibility: visible; }
        .modal {
            background: var(--white);
            border-radius: var(--radius-lg);
            width: 100%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: var(--shadow-lg);
        }
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 20px;
            border-bottom: 1px solid var(--gray-medium);
            position: sticky;
            top: 0;
            background: var(--white);
            z-index: 1;
        }
        .modal-title { font-family: 'Lora', serif; font-size: 1.2rem; }
        .modal-close { background: none; border: none; font-size: 1.5rem; color: var(--gray-text); cursor: pointer; padding: 4px; }
        .modal-body { padding: 20px; }
        .modal-footer {
            padding: 16px 20px;
            border-top: 1px solid var(--gray-medium);
            display: flex;
            justify-content: flex-end;
            gap: 12px;
        }

        /* Day Picker */
        .day-picker { display: grid; grid-template-columns: repeat(7, 1fr); gap: 8px; margin: 16px 0; }
        .day-picker-item {
            padding: 12px 8px;
            text-align: center;
            background: var(--gray-light);
            border-radius: var(--radius-sm);
            cursor: pointer;
            transition: all 0.2s;
            border: 2px solid transparent;
        }
        .day-picker-item:hover { border-color: var(--cerulean); }
        .day-picker-item.selected { background: var(--cerulean); color: white; }
        .day-picker-item .day-name { font-size: 0.7rem; text-transform: uppercase; }
        .day-picker-item .day-num { font-weight: 600; }

        /* Toggle Switch */
        .toggle { display: flex; align-items: center; gap: 12px; cursor: pointer; }
        .toggle-switch {
            width: 50px;
            height: 28px;
            background: var(--gray-medium);
            border-radius: 14px;
            position: relative;
            transition: background 0.3s;
        }
        .toggle-switch::after {
            content: '';
            position: absolute;
            top: 3px;
            left: 3px;
            width: 22px;
            height: 22px;
            background: white;
            border-radius: 50%;
            transition: transform 0.3s;
        }
        .toggle input { display: none; }
        .toggle input:checked + .toggle-switch { background: var(--cerulean); }
        .toggle input:checked + .toggle-switch::after { transform: translateX(22px); }

        /* Flare Mode Banner */
        .flare-banner {
            background: linear-gradient(135deg, #fff3e0 0%, #ffecb3 100%);
            border-left: 4px solid #ff9800;
            padding: 16px;
            margin-bottom: 16px;
            border-radius: 0 var(--radius) var(--radius) 0;
        }
        .flare-banner-title { font-weight: 600; color: #e65100; margin-bottom: 4px; }
        .flare-banner-text { font-size: 0.9rem; color: #bf360c; }

        /* More Menu */
        .more-menu { display: grid; gap: 8px; }
        .more-menu-item {
            display: flex;
            align-items: center;
            gap: 16px;
            padding: 16px;
            background: var(--white);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            cursor: pointer;
            transition: all 0.2s;
            border: none;
            width: 100%;
            text-align: left;
            font-family: inherit;
            font-size: 1rem;
            color: var(--navy);
        }
        .more-menu-item:hover { transform: translateX(4px); box-shadow: var(--shadow-lg); }
        .more-menu-item .icon { font-size: 1.5rem; width: 40px; text-align: center; }
        .more-menu-item-content { flex: 1; }
        .more-menu-item-title { font-weight: 500; }
        .more-menu-item-desc { font-size: 0.85rem; color: var(--gray-text); }

        /* Activity List */
        .activity-list { margin-top: 16px; }
        .activity-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 0;
            border-bottom: 1px solid var(--gray-light);
        }
        .activity-item:last-child { border-bottom: none; }
        .activity-icon { font-size: 1.2rem; }
        .activity-content { flex: 1; }
        .activity-title { font-size: 0.9rem; }
        .activity-time { font-size: 0.8rem; color: var(--gray-text); }

        /* Accordion */
        .accordion-item { border: 1px solid var(--gray-medium); border-radius: var(--radius-sm); margin-bottom: 8px; overflow: hidden; }
        .accordion-header {
            padding: 14px 16px;
            background: var(--gray-light);
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: 500;
        }
        .accordion-header:hover { background: var(--gray-medium); }
        .accordion-icon { transition: transform 0.3s; }
        .accordion-item.open .accordion-icon { transform: rotate(180deg); }
        .accordion-body { padding: 16px; display: none; }
        .accordion-item.open .accordion-body { display: block; }

        /* Pantry Items */
        .pantry-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            background: var(--gray-light);
            border-radius: var(--radius-sm);
            margin-bottom: 8px;
        }
        .pantry-item-icon { font-size: 1.3rem; }
        .pantry-item-info { flex: 1; }
        .pantry-item-name { font-weight: 500; }
        .pantry-item-qty { font-size: 0.85rem; color: var(--gray-text); }
        .pantry-status {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: var(--success);
        }
        .pantry-status.fresh { background: var(--success); }
        .pantry-status.use-soon { background: var(--warning); }
        .pantry-status.check { background: var(--danger); }

        /* Smart Shopping Generator */
        .smart-shopping-card {
            background: linear-gradient(135deg, var(--seafoam-light) 0%, #e8f4f8 100%);
            border: 1px solid var(--cerulean);
            padding: 16px;
        }
        .smart-shopping-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 8px;
        }
        .smart-shopping-icon { font-size: 1.5rem; }
        .smart-shopping-title {
            font-size: 1rem;
            font-weight: 600;
            color: var(--navy);
            margin: 0;
        }
        .smart-shopping-features {
            list-style: none;
            padding: 0;
            margin: 0;
            font-size: 0.85rem;
        }
        .smart-shopping-features li {
            padding: 4px 0;
            color: var(--gray-dark);
        }
        .divider-label {
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--gray-text);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            padding-bottom: 8px;
            border-bottom: 1px solid var(--gray-medium);
        }

        /* Pantry Alerts Section */
        .pantry-alerts {
            margin-bottom: 16px;
        }
        .pantry-alert-card {
            background: #fff8e6;
            border: 1px solid #ffc107;
            border-radius: var(--radius);
            padding: 12px;
            margin-bottom: 8px;
        }
        .pantry-alert-card.urgent {
            background: #ffebee;
            border-color: #ef5350;
        }
        .pantry-alert-header {
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 600;
            margin-bottom: 8px;
        }
        .pantry-alert-list {
            list-style: none;
            padding: 0;
            margin: 0;
            font-size: 0.9rem;
        }
        .pantry-alert-list li {
            padding: 4px 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        /* Shopping List Base */
        .shopping-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 10px 0;
            border-bottom: 1px solid var(--gray-light);
        }
        .shopping-item.checked { opacity: 0.5; }
        .shopping-item.checked .shopping-item-name { text-decoration: line-through; }
        .shopping-item-checkbox { width: 22px; height: 22px; accent-color: var(--cerulean); }

        /* Shopping List with Pantry Status */
        .shopping-item-enhanced {
            display: flex;
            align-items: flex-start;
            gap: 12px;
            padding: 12px;
            background: var(--gray-light);
            border-radius: var(--radius-sm);
            margin-bottom: 8px;
        }
        .shopping-item-enhanced.checked {
            opacity: 0.6;
        }
        .shopping-item-enhanced .shopping-item-checkbox {
            margin-top: 2px;
        }
        .shopping-item-content {
            flex: 1;
        }
        .shopping-item-name-row {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
        }
        .shopping-item-name {
            font-weight: 500;
        }
        .shopping-item-qty {
            font-size: 0.85rem;
            color: var(--gray-text);
        }
        .shopping-item-pantry-status {
            font-size: 0.8rem;
            color: var(--gray-text);
            margin-top: 4px;
        }
        .shopping-item-pantry-status.has-some {
            color: var(--cerulean);
        }
        .shopping-item-pantry-status.missing {
            color: var(--warning);
        }
        .shopping-category-header {
            font-weight: 600;
            color: var(--cerulean);
            padding: 12px 0 8px;
            margin-top: 8px;
            border-bottom: 1px solid var(--gray-medium);
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .shopping-list-summary {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            background: var(--seafoam-light);
            border-radius: var(--radius);
            margin-bottom: 16px;
        }
        .shopping-summary-cost {
            font-weight: 600;
            color: var(--navy);
        }
        .shopping-suggestions {
            background: #f5f5f5;
            border-radius: var(--radius);
            padding: 12px;
            margin-bottom: 16px;
        }
        .shopping-suggestions-header {
            font-weight: 600;
            color: var(--gray-dark);
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .shopping-suggestion-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid var(--gray-medium);
        }
        .shopping-suggestion-item:last-child {
            border-bottom: none;
        }
        .suggestion-add-btn {
            font-size: 0.8rem;
            padding: 4px 12px;
            background: var(--cerulean);
            color: white;
            border: none;
            border-radius: var(--radius-sm);
            cursor: pointer;
        }

        /* Quick Add Delivery Section */
        .quick-add-section {
            margin-top: 16px;
        }
        .quick-add-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            padding: 12px;
            background: var(--gray-light);
            border-radius: var(--radius);
        }
        .quick-add-header:hover {
            background: var(--seafoam-light);
        }
        .quick-add-content {
            display: none;
            padding: 16px;
            background: var(--gray-light);
            border-radius: 0 0 var(--radius) var(--radius);
            margin-top: -8px;
        }
        .quick-add-content.open {
            display: block;
        }
        .quick-add-btns {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            margin-top: 8px;
        }
        .quick-add-btn {
            padding: 12px;
            background: white;
            border: 1px solid var(--gray-medium);
            border-radius: var(--radius);
            cursor: pointer;
            text-align: left;
            transition: all 0.2s;
        }
        .quick-add-btn:hover {
            border-color: var(--cerulean);
            background: var(--seafoam-light);
        }

        /* Batch Cooking Pantry Check */
        .batch-ingredient-check {
            margin-top: 16px;
            padding: 16px;
            background: var(--gray-light);
            border-radius: var(--radius);
        }
        .batch-ingredient-header {
            font-weight: 600;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .batch-ingredient-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px 0;
            font-size: 0.9rem;
        }
        .batch-ingredient-status {
            width: 20px;
            text-align: center;
        }
        .batch-missing-items {
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid var(--gray-medium);
        }

        /* Meal Planning Mode Selection */
        .planning-mode-selector {
            margin-bottom: 16px;
        }
        .planning-mode-option {
            display: flex;
            align-items: flex-start;
            gap: 12px;
            padding: 12px;
            background: var(--gray-light);
            border-radius: var(--radius);
            margin-bottom: 8px;
            cursor: pointer;
            border: 2px solid transparent;
            transition: all 0.2s;
        }
        .planning-mode-option:hover {
            background: var(--seafoam-light);
        }
        .planning-mode-option.selected {
            border-color: var(--cerulean);
            background: var(--seafoam-light);
        }
        .planning-mode-option input[type="radio"] {
            margin-top: 4px;
        }
        .planning-mode-content {
            flex: 1;
        }
        .planning-mode-title {
            font-weight: 600;
            margin-bottom: 4px;
        }
        .planning-mode-desc {
            font-size: 0.85rem;
            color: var(--gray-text);
        }
        .planning-pantry-summary {
            background: var(--gray-light);
            border-radius: var(--radius);
            padding: 12px;
            margin-top: 12px;
            font-size: 0.9rem;
        }
        .planning-pantry-summary h4 {
            margin: 0 0 8px 0;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        /* Pantry Scan */
        .scan-upload-area {
            border: 2px dashed var(--gray-medium);
            border-radius: var(--radius);
            padding: 32px 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
            background: var(--gray-light);
        }
        .scan-upload-area:hover { border-color: var(--cerulean); background: var(--seafoam-light); }
        .scan-upload-area.dragover { border-color: var(--cerulean); background: var(--seafoam-light); }
        .scan-upload-icon { font-size: 3rem; margin-bottom: 12px; }
        .scan-upload-text { font-weight: 500; margin-bottom: 4px; }
        .scan-upload-hint { font-size: 0.85rem; color: var(--gray-text); }
        .scan-preview { max-width: 100%; max-height: 200px; border-radius: var(--radius-sm); margin-top: 16px; }
        .scan-loading {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 40px 20px;
            text-align: center;
        }
        .scan-loading-icon {
            font-size: 3rem;
            animation: scanPulse 1.5s ease-in-out infinite;
        }
        @keyframes scanPulse {
            0%, 100% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.1); opacity: 0.7; }
        }
        .scan-loading-text { margin-top: 16px; color: var(--gray-text); }

        /* Scan Results */
        .scan-results-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }
        .scan-results-count { font-weight: 600; color: var(--cerulean); }
        .scan-item {
            display: flex;
            align-items: flex-start;
            gap: 12px;
            padding: 12px;
            background: var(--gray-light);
            border-radius: var(--radius-sm);
            margin-bottom: 8px;
        }
        .scan-item-checkbox { margin-top: 4px; width: 20px; height: 20px; accent-color: var(--cerulean); }
        .scan-item-info { flex: 1; }
        .scan-item-name { font-weight: 500; }
        .scan-item-details { font-size: 0.85rem; color: var(--gray-text); margin-top: 2px; }
        .scan-item-badge {
            display: inline-block;
            font-size: 0.7rem;
            padding: 2px 6px;
            border-radius: 10px;
            margin-right: 4px;
        }
        .scan-item-badge.fresh { background: #e8f5e9; color: #2e7d32; }
        .scan-item-badge.use-soon { background: #fff3e0; color: #ef6c00; }
        .scan-item-badge.check { background: #ffebee; color: #c62828; }
        .scan-item-badge.category { background: var(--seafoam-light); color: var(--navy); }
        .scan-item-actions { display: flex; gap: 4px; }
        .scan-category-header {
            font-weight: 600;
            color: var(--cerulean);
            padding: 8px 0;
            margin-top: 12px;
            border-bottom: 1px solid var(--gray-medium);
        }
        .scan-category-header:first-child { margin-top: 0; }

        /* Toast */
        .toast {
            position: fixed;
            bottom: 100px;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background: var(--navy);
            color: white;
            padding: 12px 24px;
            border-radius: var(--radius);
            box-shadow: var(--shadow-lg);
            z-index: 2000;
            opacity: 0;
            transition: all 0.3s ease;
        }
        .toast.show { transform: translateX(-50%) translateY(0); opacity: 1; }

        /* Onboarding */
        .onboarding-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(26, 35, 50, 0.8);
            z-index: 2000;
            display: none;
        }
        .onboarding-overlay.active { display: flex; align-items: center; justify-content: center; }
        .onboarding-card {
            background: var(--white);
            border-radius: var(--radius-lg);
            max-width: 400px;
            width: 90%;
            padding: 32px 24px;
            text-align: center;
        }
        .onboarding-icon { font-size: 3rem; margin-bottom: 16px; }
        .onboarding-title { font-family: 'Lora', serif; font-size: 1.5rem; margin-bottom: 12px; }
        .onboarding-text { color: var(--gray-text); margin-bottom: 24px; }
        .onboarding-dots { display: flex; justify-content: center; gap: 8px; margin-bottom: 24px; }
        .onboarding-dot { width: 8px; height: 8px; border-radius: 50%; background: var(--gray-medium); }
        .onboarding-dot.active { background: var(--cerulean); }
        .onboarding-actions { display: flex; gap: 12px; justify-content: center; }

        /* Cook Mode */
        .cook-mode-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--cream);
            z-index: 1500;
            display: none;
            flex-direction: column;
        }
        .cook-mode-overlay.active { display: flex; }
        .cook-mode-header {
            background: var(--cerulean);
            color: white;
            padding: 16px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .cook-mode-progress { font-size: 1.1rem; }
        .cook-mode-close { background: rgba(255,255,255,0.2); border: none; padding: 8px 16px; border-radius: var(--radius-sm); color: white; cursor: pointer; }
        .cook-mode-body { flex: 1; overflow-y: auto; padding: 24px 20px; }
        .cook-mode-step {
            background: var(--white);
            border-radius: var(--radius);
            padding: 24px;
            margin-bottom: 16px;
            font-size: 1.2rem;
            line-height: 1.8;
        }
        .cook-mode-step-check {
            display: flex;
            align-items: flex-start;
            gap: 16px;
        }
        .cook-mode-step-check input { width: 28px; height: 28px; margin-top: 4px; }
        .cook-mode-timer {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            background: var(--warning);
            color: white;
            padding: 8px 16px;
            border-radius: var(--radius-sm);
            margin-top: 12px;
            cursor: pointer;
        }
        .cook-mode-ingredients {
            background: var(--white);
            border-radius: var(--radius);
            padding: 16px;
            margin-bottom: 16px;
        }
        .cook-mode-ingredients summary { cursor: pointer; font-weight: 600; color: var(--cerulean); }
        .cook-mode-footer {
            background: var(--white);
            border-top: 1px solid var(--gray-medium);
            padding: 16px 20px;
            display: flex;
            gap: 12px;
        }
        .cook-mode-footer .btn { flex: 1; }

        /* Condition Details */
        .condition-details {
            background: var(--gray-light);
            padding: 12px 16px;
            border-radius: var(--radius-sm);
            margin-top: 8px;
            margin-bottom: 8px;
            border-left: 3px solid var(--cerulean);
        }
        .condition-details .form-group { margin-bottom: 0; }
        .condition-details .form-row { margin-bottom: 0; }

        /* Utilities */
        .hidden { display: none !important; }
        .text-center { text-align: center; }
        .text-muted { color: var(--gray-text); }
        .mb-0 { margin-bottom: 0; }
        .mb-8 { margin-bottom: 8px; }
        .mb-16 { margin-bottom: 16px; }
        .mt-8 { margin-top: 8px; }
        .mt-16 { margin-top: 16px; }
        .flex { display: flex; }
        .flex-between { justify-content: space-between; }
        .flex-center { align-items: center; }
        .gap-8 { gap: 8px; }
        .gap-12 { gap: 12px; }
        .gap-16 { gap: 16px; }

        /* Search Results Highlight */
        .search-highlight { background: yellow; padding: 0 2px; }

        /* Filter Dropdown */
        .filter-dropdown {
            position: relative;
            display: inline-block;
        }
        .filter-dropdown-content {
            display: none;
            position: absolute;
            right: 0;
            top: 100%;
            background: var(--white);
            border-radius: var(--radius);
            box-shadow: var(--shadow-lg);
            min-width: 200px;
            z-index: 100;
            padding: 12px;
        }
        .filter-dropdown.open .filter-dropdown-content { display: block; }

        /* Print Styles */
        @media print {
            .header, .bottom-nav, .chat-input-area, .recipe-actions, .btn, .recipe-card-actions { display: none !important; }
            body { padding: 0; background: white; }
            .recipe-card { box-shadow: none; border: 1px solid #ddd; }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="header hidden" id="app-header">
        <div class="container header-content">
            <a href="#" class="logo" onclick="navigateTo('home'); return false;">Tavola</a>
            <div class="header-right">
                <div class="header-search" id="global-search">
                    <span>ðŸ”</span>
                    <input type="text" placeholder="Search..." id="global-search-input" onkeyup="handleGlobalSearch(event)">
                </div>
            </div>
        </div>
    </header>

    <!-- Welcome Screen -->
    <main class="welcome-screen" id="welcome-screen">
        <h1 class="welcome-logo">Tavola</h1>
        <p class="welcome-subtitle">Mediterranean Meal Planning</p>
        <p class="welcome-tagline">Gentle, delicious meals designed for your health. Meet Nonna, your personal cooking companion.</p>
        <button class="btn btn-primary" onclick="showIntakeForm()">Get Started</button>
    </main>

    <!-- Intake Form -->
    <main class="view" id="intake-form">
        <div class="container section">
            <div class="text-center mb-16">
                <h1 class="section-title" style="border: none; text-align: center;">Let's Get to Know You</h1>
                <p class="text-muted">This helps Nonna suggest meals that work for your body</p>
            </div>
            <form id="profile-form" onsubmit="saveProfile(event)">
                <!-- Health Conditions - Expanded -->
                <div class="card">
                    <h2 class="card-title">ðŸ©º Health Conditions</h2>
                    <p class="text-muted mb-16">Check all that apply. This helps Nonna tailor recipes to your needs.</p>

                    <!-- Digestive Conditions -->
                    <div class="form-group">
                        <label style="font-weight: 600; color: var(--cerulean);">Digestive Conditions</label>
                        <div class="grid grid-2">
                            <label class="checkbox-item"><input type="checkbox" name="conditions" value="crohns" onchange="toggleConditionDetails('crohns')"> Crohn's Disease</label>
                            <label class="checkbox-item"><input type="checkbox" name="conditions" value="uc" onchange="toggleConditionDetails('uc')"> Ulcerative Colitis</label>
                            <label class="checkbox-item"><input type="checkbox" name="conditions" value="ibs" onchange="toggleConditionDetails('ibs')"> IBS</label>
                            <label class="checkbox-item"><input type="checkbox" name="conditions" value="celiac"> Celiac / Gluten Sensitivity</label>
                            <label class="checkbox-item"><input type="checkbox" name="conditions" value="lactose"> Lactose Intolerance</label>
                            <label class="checkbox-item"><input type="checkbox" name="conditions" value="gerd"> GERD / Acid Reflux</label>
                        </div>
                    </div>

                    <!-- Crohn's Details (shown when checked) -->
                    <div class="condition-details hidden" id="crohns-details">
                        <div class="form-row">
                            <div class="form-group">
                                <label>Crohn's Severity</label>
                                <select class="form-select" name="crohnsSeverity">
                                    <option value="">Select...</option>
                                    <option value="mild">Mild</option>
                                    <option value="moderate">Moderate</option>
                                    <option value="severe">Severe</option>
                                    <option value="remission">In Remission</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Known Triggers</label>
                                <input type="text" class="form-input" name="crohnsTriggers" placeholder="e.g., raw veggies, nuts, dairy">
                            </div>
                        </div>
                    </div>

                    <!-- UC Details -->
                    <div class="condition-details hidden" id="uc-details">
                        <div class="form-group">
                            <label>UC Severity</label>
                            <select class="form-select" name="ucSeverity">
                                <option value="">Select...</option>
                                <option value="mild">Mild</option>
                                <option value="moderate">Moderate</option>
                                <option value="severe">Severe</option>
                                <option value="remission">In Remission</option>
                            </select>
                        </div>
                    </div>

                    <!-- IBS Details -->
                    <div class="condition-details hidden" id="ibs-details">
                        <div class="form-group">
                            <label>IBS Type</label>
                            <select class="form-select" name="ibsType">
                                <option value="">Select...</option>
                                <option value="ibs-d">IBS-D (Diarrhea)</option>
                                <option value="ibs-c">IBS-C (Constipation)</option>
                                <option value="ibs-m">IBS-M (Mixed)</option>
                            </select>
                        </div>
                    </div>

                    <!-- Cardiovascular & Metabolic -->
                    <div class="form-group mt-16">
                        <label style="font-weight: 600; color: var(--cerulean);">Cardiovascular & Metabolic</label>
                        <div class="grid grid-2">
                            <label class="checkbox-item"><input type="checkbox" name="conditions" value="highCholesterol" onchange="toggleConditionDetails('cholesterol')"> High Cholesterol</label>
                            <label class="checkbox-item"><input type="checkbox" name="conditions" value="highBP" onchange="toggleConditionDetails('bp')"> High Blood Pressure</label>
                            <label class="checkbox-item"><input type="checkbox" name="conditions" value="diabetes" onchange="toggleConditionDetails('diabetes')"> Type 2 Diabetes</label>
                            <label class="checkbox-item"><input type="checkbox" name="conditions" value="heartDisease"> Heart Disease</label>
                            <label class="checkbox-item"><input type="checkbox" name="conditions" value="kidney" onchange="toggleConditionDetails('kidney')"> Kidney Disease</label>
                        </div>
                    </div>

                    <!-- Cholesterol Details -->
                    <div class="condition-details hidden" id="cholesterol-details">
                        <div class="form-group">
                            <label>Cholesterol Goal</label>
                            <select class="form-select" name="cholesterolGoal">
                                <option value="">Select...</option>
                                <option value="lower-ldl">Lower LDL</option>
                                <option value="raise-hdl">Raise HDL</option>
                                <option value="both">Both</option>
                            </select>
                        </div>
                    </div>

                    <!-- BP Details -->
                    <div class="condition-details hidden" id="bp-details">
                        <div class="form-group">
                            <label>Sodium Restriction</label>
                            <select class="form-select" name="sodiumRestriction">
                                <option value="">Select...</option>
                                <option value="moderate">Moderate (2300mg/day)</option>
                                <option value="strict">Strict (1500mg/day)</option>
                            </select>
                        </div>
                    </div>

                    <!-- Diabetes Details -->
                    <div class="condition-details hidden" id="diabetes-details">
                        <div class="form-group">
                            <label>Carb Management</label>
                            <select class="form-select" name="carbManagement">
                                <option value="">Select...</option>
                                <option value="moderate">Moderate Carb</option>
                                <option value="low-carb">Low Carb</option>
                                <option value="keto">Very Low Carb / Keto</option>
                            </select>
                        </div>
                    </div>

                    <!-- Kidney Details -->
                    <div class="condition-details hidden" id="kidney-details">
                        <div class="form-group">
                            <label>Kidney Restrictions</label>
                            <div class="grid grid-2">
                                <label class="checkbox-item"><input type="checkbox" name="kidneyRestrictions" value="lowProtein"> Low Protein</label>
                                <label class="checkbox-item"><input type="checkbox" name="kidneyRestrictions" value="lowSodium"> Low Sodium</label>
                                <label class="checkbox-item"><input type="checkbox" name="kidneyRestrictions" value="lowPotassium"> Low Potassium</label>
                                <label class="checkbox-item"><input type="checkbox" name="kidneyRestrictions" value="lowPhosphorus"> Low Phosphorus</label>
                            </div>
                        </div>
                    </div>

                    <!-- Autoimmune & Inflammatory -->
                    <div class="form-group mt-16">
                        <label style="font-weight: 600; color: var(--cerulean);">Autoimmune & Inflammatory</label>
                        <div class="grid grid-2">
                            <label class="checkbox-item"><input type="checkbox" name="conditions" value="fibromyalgia" onchange="toggleConditionDetails('fibro')"> Fibromyalgia</label>
                            <label class="checkbox-item"><input type="checkbox" name="conditions" value="rheumatoid"> Rheumatoid Arthritis</label>
                            <label class="checkbox-item"><input type="checkbox" name="conditions" value="lupus"> Lupus</label>
                            <label class="checkbox-item"><input type="checkbox" name="conditions" value="hashimotos" onchange="toggleConditionDetails('thyroid')"> Hashimoto's / Thyroid</label>
                            <label class="checkbox-item"><input type="checkbox" name="conditions" value="psoriatic"> Psoriatic Arthritis</label>
                            <label class="checkbox-item"><input type="checkbox" name="conditions" value="ms"> Multiple Sclerosis</label>
                        </div>
                    </div>

                    <!-- Fibro Details -->
                    <div class="condition-details hidden" id="fibro-details">
                        <div class="form-group">
                            <label>Energy Level</label>
                            <select class="form-select" name="fibroEnergy">
                                <option value="">Select...</option>
                                <option value="low">Usually Low</option>
                                <option value="moderate">Moderate</option>
                                <option value="variable">Highly Variable</option>
                            </select>
                        </div>
                    </div>

                    <!-- Thyroid Details -->
                    <div class="condition-details hidden" id="thyroid-details">
                        <div class="form-group">
                            <label>Thyroid Condition</label>
                            <input type="text" class="form-input" name="thyroidType" placeholder="e.g., Hashimoto's, Hypothyroid">
                        </div>
                    </div>

                    <!-- Food Allergies -->
                    <div class="form-group mt-16">
                        <label style="font-weight: 600; color: var(--cerulean);">Food Allergies</label>
                        <input type="text" class="form-input" name="foodAllergies" placeholder="e.g., shellfish, tree nuts, soy">
                    </div>

                    <!-- Dietary Goals -->
                    <div class="form-group mt-16">
                        <label style="font-weight: 600; color: var(--cerulean);">Dietary Goals (select all that apply)</label>
                        <div class="grid grid-2">
                            <label class="checkbox-item"><input type="checkbox" name="dietaryGoals" value="weightLoss"> Weight Loss</label>
                            <label class="checkbox-item"><input type="checkbox" name="dietaryGoals" value="weightGain"> Weight Gain / Muscle</label>
                            <label class="checkbox-item"><input type="checkbox" name="dietaryGoals" value="antiInflammatory"> Anti-Inflammatory</label>
                            <label class="checkbox-item"><input type="checkbox" name="dietaryGoals" value="heartHealthy"> Heart-Healthy</label>
                            <label class="checkbox-item"><input type="checkbox" name="dietaryGoals" value="bloodSugar"> Blood Sugar Management</label>
                            <label class="checkbox-item"><input type="checkbox" name="dietaryGoals" value="gutHealth"> Gut Health</label>
                            <label class="checkbox-item"><input type="checkbox" name="dietaryGoals" value="energy"> More Energy</label>
                        </div>
                    </div>

                    <!-- Other Notes -->
                    <div class="form-group mt-16">
                        <label>Other Conditions or Notes</label>
                        <textarea class="form-textarea" name="otherConditions" placeholder="Anything else Nonna should know about your health..."></textarea>
                    </div>
                </div>

                <!-- Cooking for Two -->
                <div class="card">
                    <h2 class="card-title">ðŸ‘¥ Cooking for Two</h2>
                    <label class="toggle mb-16">
                        <input type="checkbox" name="cookingForTwo" id="cookingForTwoToggle" onchange="toggleCookingForTwo()">
                        <span class="toggle-switch"></span>
                        <span>I'm cooking for someone else too</span>
                    </label>
                    <div id="cookingForTwoFields" class="hidden">
                        <div class="form-group">
                            <label>Their Name or Relationship</label>
                            <input type="text" class="form-input" name="partnerName" placeholder="e.g., John, Partner, Mom">
                        </div>
                        <div class="form-group">
                            <label>Their Dietary Restrictions</label>
                            <div class="grid grid-2">
                                <label class="checkbox-item"><input type="checkbox" name="partnerRestrictions" value="diabetes"> Diabetes</label>
                                <label class="checkbox-item"><input type="checkbox" name="partnerRestrictions" value="heart"> Heart Disease</label>
                                <label class="checkbox-item"><input type="checkbox" name="partnerRestrictions" value="glutenFree"> Gluten-Free</label>
                                <label class="checkbox-item"><input type="checkbox" name="partnerRestrictions" value="lactose"> Lactose Intolerant</label>
                                <label class="checkbox-item"><input type="checkbox" name="partnerRestrictions" value="vegetarian"> Vegetarian</label>
                                <label class="checkbox-item"><input type="checkbox" name="partnerRestrictions" value="none"> No Restrictions</label>
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Their Allergies</label>
                            <input type="text" class="form-input" name="partnerAllergies" placeholder="e.g., shellfish, tree nuts">
                        </div>
                        <div class="form-group">
                            <label>Foods They Love</label>
                            <input type="text" class="form-input" name="partnerLoves" placeholder="e.g., spicy food, cheese, garlic">
                        </div>
                    </div>
                </div>

                <!-- Protein Preferences -->
                <div class="card">
                    <h2 class="card-title">ðŸ¥© Protein Preferences</h2>
                    <p class="text-muted mb-16">Check all proteins you eat</p>
                    <div class="grid grid-2">
                        <label class="checkbox-item"><input type="checkbox" name="proteins" value="white-fish"> White Fish</label>
                        <label class="checkbox-item"><input type="checkbox" name="proteins" value="fatty-fish"> Fatty Fish (salmon)</label>
                        <label class="checkbox-item"><input type="checkbox" name="proteins" value="shellfish"> Shellfish</label>
                        <label class="checkbox-item"><input type="checkbox" name="proteins" value="chicken"> Chicken</label>
                        <label class="checkbox-item"><input type="checkbox" name="proteins" value="turkey"> Turkey</label>
                        <label class="checkbox-item"><input type="checkbox" name="proteins" value="pork"> Pork</label>
                        <label class="checkbox-item"><input type="checkbox" name="proteins" value="beef"> Beef</label>
                        <label class="checkbox-item"><input type="checkbox" name="proteins" value="lamb"> Lamb</label>
                        <label class="checkbox-item"><input type="checkbox" name="proteins" value="eggs"> Eggs</label>
                        <label class="checkbox-item"><input type="checkbox" name="proteins" value="legumes"> Legumes</label>
                        <label class="checkbox-item"><input type="checkbox" name="proteins" value="tofu"> Tofu/Tempeh</label>
                        <label class="checkbox-item"><input type="checkbox" name="proteins" value="dairy"> Greek Yogurt/Cheese</label>
                    </div>
                </div>

                <!-- Garden -->
                <div class="card">
                    <h2 class="card-title">ðŸŒ± Your Garden</h2>
                    <div class="form-group">
                        <label>What's Currently Growing?</label>
                        <textarea class="form-textarea" name="currentlyGrowing" placeholder="e.g., tomatoes, zucchini, basil, peppers..."></textarea>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Growing Zone</label>
                            <input type="text" class="form-input" name="growingZone" placeholder="e.g., 7b">
                        </div>
                        <div class="form-group">
                            <label>Current Season</label>
                            <select class="form-select" name="currentSeason">
                                <option value="spring">Spring</option>
                                <option value="summer">Summer</option>
                                <option value="fall">Fall</option>
                                <option value="winter">Winter</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Cooking Capacity -->
                <div class="card">
                    <h2 class="card-title">â° Cooking Capacity</h2>
                    <div class="form-group">
                        <label>Energy Level for Cooking</label>
                        <select class="form-select" name="energyLevel">
                            <option value="low">Low (simple meals)</option>
                            <option value="moderate">Moderate</option>
                            <option value="good">Good</option>
                            <option value="variable" selected>Variable (changes daily)</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Preferred Cooking Time</label>
                        <select class="form-select" name="cookingTime">
                            <option value="quick">Quick (15-30 min)</option>
                            <option value="standard" selected>Standard (30-60 min)</option>
                            <option value="batch">Batch Cooking</option>
                        </select>
                    </div>
                </div>

                <!-- Budget -->
                <div class="card">
                    <h2 class="card-title">ðŸ’° Budget</h2>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Weekly Grocery Budget</label>
                            <select class="form-select" name="weeklyBudget">
                                <option value="50-75">$50-75</option>
                                <option value="75-100">$75-100</option>
                                <option value="100-150" selected>$100-150</option>
                                <option value="150-200">$150-200</option>
                                <option value="200+">$200+</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Priority</label>
                            <select class="form-select" name="shoppingPriority">
                                <option value="quality">Quality ingredients</option>
                                <option value="budget">Budget-friendly</option>
                                <option value="balance" selected>Balance both</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Dietary Notes -->
                <div class="card">
                    <h2 class="card-title">ðŸ“ Dietary Notes</h2>
                    <div class="form-group">
                        <label>Foods to Avoid</label>
                        <textarea class="form-textarea" name="foodsToAvoid" placeholder="Specific triggers or dislikes..."></textarea>
                    </div>
                    <div class="form-group">
                        <label>Favorite Flavors</label>
                        <textarea class="form-textarea" name="favoriteFlavors" placeholder="e.g., lemon, garlic, fresh herbs..."></textarea>
                    </div>
                </div>

                <button type="submit" class="btn btn-primary btn-block">Save & Meet Nonna</button>
            </form>
        </div>
    </main>

    <!-- Main App Container -->
    <main class="view" id="app-main">
        <div class="container">
            <!-- HOME/DASHBOARD View (NEW) -->
            <div class="view active" id="view-home">
                <!-- Flare Mode Banner (shown when active) -->
                <div class="flare-banner hidden" id="home-flare-banner">
                    <div class="flare-banner-title">ðŸŒ¡ï¸ Flare Mode Active</div>
                    <div class="flare-banner-text">Nonna will suggest gentle, easy-to-digest meals.</div>
                </div>

                <!-- Stats Bar -->
                <div class="stats-bar" id="dashboard-stats">
                    <div class="stat-item"><span class="icon">ðŸ½ï¸</span> <span>Meals: <strong id="stat-meals-planned">0/7</strong></span></div>
                    <div class="stat-item"><span class="icon">â¤ï¸</span> <span>Favorites: <strong id="stat-favorites">0</strong></span></div>
                    <div class="stat-item"><span class="icon">ðŸŒ±</span> <span>Garden: <strong id="stat-garden">-</strong></span></div>
                    <div class="stat-item"><span class="icon">ðŸ“š</span> <span>Recipes: <strong id="stat-recipes">0</strong></span></div>
                </div>

                <!-- Quick Action Tiles -->
                <div class="action-tiles">
                    <div class="action-tile" onclick="navigateTo('week'); askNonnaForWeekPlan();">
                        <div class="action-tile-icon">ðŸ“…</div>
                        <div class="action-tile-title">Plan This Week</div>
                        <div class="action-tile-desc">Get your weekly meal plan</div>
                    </div>
                    <div class="action-tile" onclick="navigateTo('favorites')">
                        <div class="action-tile-icon">â¤ï¸</div>
                        <div class="action-tile-title">View Favorites</div>
                        <div class="action-tile-desc">Browse saved recipes</div>
                    </div>
                    <div class="action-tile" onclick="navigateTo('chat')">
                        <div class="action-tile-icon">ðŸ’¬</div>
                        <div class="action-tile-title">Chat with Nonna</div>
                        <div class="action-tile-desc">Ask about meals & recipes</div>
                    </div>
                    <div class="action-tile" onclick="navigateTo('more'); switchMoreTab('garden');">
                        <div class="action-tile-icon">ðŸŒ±</div>
                        <div class="action-tile-title">Check Garden</div>
                        <div class="action-tile-desc">What's ready to harvest</div>
                    </div>
                </div>

                <!-- Today's Activity Summary -->
                <div class="card" id="dashboard-workout-card">
                    <div class="card-header">
                        <h3 class="card-title">ðŸ’ª Today's Activity</h3>
                        <button class="btn btn-ghost btn-sm" onclick="navigateTo('workouts')">View All</button>
                    </div>
                    <div class="workout-stats" style="margin-bottom: 0;">
                        <div class="workout-stat">
                            <div class="workout-stat-value" id="dashboard-calories-in">0</div>
                            <div class="workout-stat-label">Calories In</div>
                        </div>
                        <div class="workout-stat">
                            <div class="workout-stat-value" id="dashboard-calories-out">0</div>
                            <div class="workout-stat-label">Calories Out</div>
                        </div>
                        <div class="workout-stat balance">
                            <div class="workout-stat-value" id="dashboard-calorie-net">0</div>
                            <div class="workout-stat-label">Net Balance</div>
                        </div>
                        <div class="workout-stat">
                            <div class="workout-stat-value" id="dashboard-workouts-today">0</div>
                            <div class="workout-stat-label">Workouts Today</div>
                        </div>
                    </div>
                </div>

                <!-- Recent Activity -->
                <div class="card">
                    <h3 class="card-title">ðŸ“‹ Recent Activity</h3>
                    <div class="activity-list" id="recent-activity">
                        <div class="empty-state" style="padding: 24px;">
                            <p class="text-muted">No recent activity yet. Start by chatting with Nonna!</p>
                        </div>
                    </div>
                </div>

                <!-- Nonna's Tip of the Day -->
                <div class="nonna-tip" id="nonna-tip-daily">
                    <div class="nonna-tip-header">ðŸ’¡ Nonna's Tip</div>
                    <div class="nonna-tip-text" id="nonna-tip-text">"Always finish with good olive oil - it makes everything taste better, cara."</div>
                    <div class="nonna-tip-signature">â€” Nonna</div>
                </div>

                <!-- Empty State for New Users -->
                <div class="card hidden" id="new-user-welcome">
                    <div class="text-center" style="padding: 24px;">
                        <div style="font-size: 3rem; margin-bottom: 16px;">ðŸ‘‹</div>
                        <h3 style="color: var(--cerulean); margin-bottom: 8px;">Welcome to Tavola!</h3>
                        <p class="text-muted mb-16">Nonna helps you plan Mediterranean meals tailored to your health needs.</p>
                        <button class="btn btn-primary" onclick="navigateTo('chat')">ðŸ’¬ Start Chatting with Nonna</button>
                    </div>
                </div>
            </div>

            <!-- THIS WEEK View -->
            <div class="view" id="view-week">
                <div class="week-header">
                    <div class="week-nav">
                        <button class="week-nav-btn" onclick="changeWeek(-1)">â—€</button>
                        <span class="week-title" id="week-title">This Week</span>
                        <button class="week-nav-btn" onclick="changeWeek(1)">â–¶</button>
                    </div>
                    <div class="week-actions">
                        <button class="btn btn-primary btn-sm" onclick="askNonnaForWeekPlan()">ðŸ¤– Plan Week</button>
                        <button class="btn btn-secondary btn-sm" onclick="generateWeekShoppingList()">ðŸ›’ Shopping</button>
                        <button class="btn btn-secondary btn-sm" onclick="showPrepChecklist()">ðŸ“‹ Prep</button>
                    </div>
                </div>
                <div id="week-planner"></div>
                <div class="empty-state hidden" id="week-empty">
                    <div class="empty-state-icon">ðŸ“…</div>
                    <div class="empty-state-title">Your week is empty</div>
                    <p class="empty-state-text">Let's fill it with delicious, healthy meals! Nonna can create a complete weekly plan based on your preferences and pantry.</p>
                    <button class="btn btn-primary" onclick="openPlanningModeModal()">ðŸ¤– Plan This Week</button>
                </div>
            </div>

            <!-- RECIPES LIBRARY View (NEW) -->
            <div class="view" id="view-recipes">
                <div class="flex flex-between flex-center mb-16">
                    <h2 class="section-title" style="margin-bottom: 0; border: none;">ðŸ“š Recipe Library</h2>
                    <button class="btn btn-sm btn-ghost" id="recipes-edit-btn" onclick="toggleRecipeEditMode()">Edit</button>
                </div>
                <!-- Bulk Actions Bar (hidden by default) -->
                <div class="bulk-actions-bar hidden" id="recipes-bulk-bar">
                    <span class="bulk-count"><span id="bulk-selected-count">0</span> selected</span>
                    <div class="bulk-buttons">
                        <button class="btn btn-sm btn-ghost" onclick="bulkSelectAll()">Select All</button>
                        <button class="btn btn-sm btn-ghost" onclick="bulkDeselectAll()">Deselect</button>
                        <button class="btn btn-sm btn-secondary" onclick="bulkAddToFavorites()">â¤ï¸ Favorite</button>
                        <button class="btn btn-sm btn-secondary" onclick="bulkRemoveFromFavorites()">ðŸ’” Unfavorite</button>
                        <button class="btn btn-sm" style="background: var(--danger); color: white;" onclick="bulkDeleteRecipes()">ðŸ—‘ï¸ Delete</button>
                    </div>
                </div>
                <div class="flex flex-between flex-center mb-16 gap-8" style="flex-wrap: wrap;">
                    <input type="text" class="form-input" id="recipes-search" placeholder="Search recipes..." style="max-width: 250px; flex: 1;" oninput="filterRecipeLibrary()">
                    <div class="filter-dropdown" id="recipe-filters">
                        <button class="btn btn-secondary btn-sm" onclick="toggleFilterDropdown()">Filters â–¾</button>
                        <div class="filter-dropdown-content">
                            <div class="form-group">
                                <label>Sort by</label>
                                <select class="form-select" id="recipes-sort" onchange="filterRecipeLibrary()">
                                    <option value="recent">Recent</option>
                                    <option value="rating">Highest Rated</option>
                                    <option value="cooked">Most Cooked</option>
                                    <option value="time">Cook Time</option>
                                    <option value="name">Name A-Z</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Protein</label>
                                <select class="form-select" id="recipes-protein" onchange="filterRecipeLibrary()">
                                    <option value="">All</option>
                                    <option value="fish">Fish</option>
                                    <option value="chicken">Chicken</option>
                                    <option value="pork">Pork</option>
                                    <option value="beef">Beef</option>
                                    <option value="vegetarian">Vegetarian</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Time</label>
                                <select class="form-select" id="recipes-time" onchange="filterRecipeLibrary()">
                                    <option value="">All</option>
                                    <option value="quick">Quick (&lt;30min)</option>
                                    <option value="standard">Standard (30-60min)</option>
                                    <option value="long">Long (60+min)</option>
                                </select>
                            </div>
                            <div class="tag-filter-section">
                                <span class="tag-filter-label">Filter by Tags</span>
                                <div class="tag-filter-chips" id="tag-filter-chips"></div>
                                <span class="tag-filter-clear" id="tag-filter-clear" onclick="clearTagFilters()">Clear tag filters</span>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="grid grid-2" id="recipes-grid"></div>
                <div class="empty-state" id="recipes-empty">
                    <div class="empty-state-icon">ðŸ“š</div>
                    <div class="empty-state-title">Your recipe library is empty</div>
                    <p class="empty-state-text">Chat with Nonna to get personalized Mediterranean recipes tailored to your health needs!</p>
                    <button class="btn btn-primary" onclick="navigateTo('chat')">ðŸ’¬ Ask Nonna for Recipe Ideas</button>
                </div>
            </div>

            <!-- CHAT View -->
            <div class="view" id="view-chat">
                <div class="chat-container">
                    <div class="chat-messages" id="chat-messages"></div>
                    <div class="chat-input-area">
                        <div class="chat-input-wrapper">
                            <button class="voice-btn" id="voice-btn" onclick="toggleVoiceInput()" title="Voice input">ðŸŽ¤</button>
                            <textarea class="chat-input" id="chat-input" placeholder="Ask Nonna anything..." rows="1"></textarea>
                            <button class="send-btn" id="send-btn" onclick="sendMessage()">âž¤</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- WORKOUTS View -->
            <div class="view" id="view-workouts">
                <h2 class="section-title">ðŸ’ª Workouts</h2>

                <!-- Calorie Balance -->
                <div class="calorie-balance" id="calorie-balance">
                    <div class="calorie-balance-header">
                        <span class="calorie-balance-title">Today's Calorie Balance</span>
                        <span class="calorie-balance-net balanced" id="calorie-net">0 cal</span>
                    </div>
                    <div class="calorie-bar-container">
                        <span class="calorie-bar-label">In</span>
                        <div class="calorie-bar">
                            <div class="calorie-bar-fill in" id="calories-in-bar" style="width: 0%"></div>
                        </div>
                        <span class="calorie-bar-value" id="calories-in-value">0</span>
                    </div>
                    <div class="calorie-bar-container">
                        <span class="calorie-bar-label">Out</span>
                        <div class="calorie-bar">
                            <div class="calorie-bar-fill out" id="calories-out-bar" style="width: 0%"></div>
                        </div>
                        <span class="calorie-bar-value" id="calories-out-value">0</span>
                    </div>
                </div>

                <!-- Week Stats -->
                <div class="workout-stats">
                    <div class="workout-stat">
                        <div class="workout-stat-value" id="workout-count-week">0</div>
                        <div class="workout-stat-label">Workouts This Week</div>
                    </div>
                    <div class="workout-stat">
                        <div class="workout-stat-value" id="workout-minutes-week">0</div>
                        <div class="workout-stat-label">Minutes Active</div>
                    </div>
                    <div class="workout-stat">
                        <div class="workout-stat-value" id="workout-calories-week">0</div>
                        <div class="workout-stat-label">Calories Burned</div>
                    </div>
                    <div class="workout-stat">
                        <div class="workout-stat-value" id="workout-streak">0</div>
                        <div class="workout-stat-label">Day Streak</div>
                    </div>
                </div>

                <!-- Quick Log -->
                <div class="card">
                    <div class="card-header">
                        <span class="card-title">Quick Log</span>
                    </div>
                    <div class="quick-log-presets" id="quick-log-presets">
                        <button class="quick-log-btn" onclick="quickLogWorkout('vrboxing', 45)">ðŸ¥Š VR Boxing</button>
                        <button class="quick-log-btn" onclick="quickLogWorkout('kettlebells', 30)">ðŸ‹ï¸ Kettlebells</button>
                        <button class="quick-log-btn" onclick="quickLogWorkout('resistancebands', 25)">ðŸ§˜ Resistance Bands</button>
                        <button class="quick-log-btn" onclick="quickLogWorkout('walking', 30)">ðŸš¶ 30min Walk</button>
                        <button class="quick-log-btn" onclick="quickLogWorkout('running', 20)">ðŸƒ 20min Run</button>
                        <button class="quick-log-btn" onclick="quickLogWorkout('cycling', 30)">ðŸš´ 30min Bike</button>
                        <button class="quick-log-btn" onclick="quickLogWorkout('yoga', 30)">ðŸ§˜ 30min Yoga</button>
                        <button class="quick-log-btn" onclick="quickLogWorkout('swimming', 30)">ðŸŠ 30min Swim</button>
                    </div>
                    <button class="btn btn-primary btn-block" onclick="openWorkoutLogModal()">+ Log Custom Workout</button>
                </div>

                <!-- Weekly Calendar -->
                <div class="workout-calendar">
                    <div class="workout-calendar-header">
                        <span class="workout-calendar-title">This Week</span>
                    </div>
                    <div class="workout-calendar-grid" id="workout-calendar-grid"></div>
                </div>

                <!-- Today's Workouts -->
                <div class="workout-list">
                    <div class="workout-list-header">
                        <span class="workout-list-title">Today's Activity</span>
                    </div>
                    <div id="workout-list-today">
                        <div class="empty-state" style="padding: 20px;">
                            <div class="empty-state-icon">ðŸƒ</div>
                            <div class="empty-state-title">No workouts logged today</div>
                            <p class="empty-state-text">Log a workout to track your calorie burn!</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- MORE View -->
            <div class="view" id="view-more">
                <h2 class="section-title">âš™ï¸ More</h2>

                <!-- More Menu Items -->
                <div class="more-menu" id="more-menu-main">
                    <button class="more-menu-item" onclick="switchMoreTab('kitchen')">
                        <span class="icon">ðŸ³</span>
                        <div class="more-menu-item-content">
                            <div class="more-menu-item-title">Kitchen Tools</div>
                            <div class="more-menu-item-desc">Pantry, shopping lists, batch cooking</div>
                        </div>
                    </button>
                    <button class="more-menu-item" onclick="switchMoreTab('garden')">
                        <span class="icon">ðŸŒ±</span>
                        <div class="more-menu-item-content">
                            <div class="more-menu-item-title">Garden</div>
                            <div class="more-menu-item-desc">Track what's growing</div>
                        </div>
                    </button>
                    <button class="more-menu-item" onclick="switchMoreTab('crohns')">
                        <span class="icon">ðŸ©º</span>
                        <div class="more-menu-item-content">
                            <div class="more-menu-item-title">Crohn's Care</div>
                            <div class="more-menu-item-desc">Flare mode & gentle meal options</div>
                        </div>
                    </button>
                    <button class="more-menu-item" onclick="switchMoreTab('history')">
                        <span class="icon">ðŸ“–</span>
                        <div class="more-menu-item-content">
                            <div class="more-menu-item-title">Meal History</div>
                            <div class="more-menu-item-desc">Track what you've cooked</div>
                        </div>
                    </button>
                    <button class="more-menu-item" onclick="switchMoreTab('settings')">
                        <span class="icon">âš™ï¸</span>
                        <div class="more-menu-item-content">
                            <div class="more-menu-item-title">Settings</div>
                            <div class="more-menu-item-desc">Profile, appearance, data</div>
                        </div>
                    </button>
                </div>

                <!-- Kitchen Sub-View -->
                <div class="hidden" id="more-kitchen">
                    <button class="btn btn-ghost mb-16" onclick="showMoreMenu()">â† Back</button>
                    <h2 class="section-title">ðŸ³ Kitchen</h2>
                    <div class="tabs">
                        <button class="tab active" onclick="switchKitchenTab('pantry')">Pantry</button>
                        <button class="tab" onclick="switchKitchenTab('shopping')">Shopping</button>
                        <button class="tab" onclick="switchKitchenTab('batch')">Batch Prep</button>
                        <button class="tab" onclick="switchKitchenTab('subs')">Substitutions</button>
                    </div>
                    <div class="tab-content active" id="kitchen-pantry">
                        <div class="flex flex-between flex-center mb-16">
                            <span class="text-muted">Track your ingredients</span>
                            <div class="flex gap-8">
                                <button class="btn btn-sm btn-secondary" onclick="openPantryScanModal()">ðŸ“· Scan</button>
                                <button class="btn btn-sm btn-primary" onclick="openAddPantryModal()">+ Add</button>
                            </div>
                        </div>

                        <!-- What Can I Make Button -->
                        <button class="btn btn-primary btn-block mb-16" onclick="openWhatCanIMakeModal()" style="padding: 14px; font-size: 1rem;">
                            ðŸ³ What Can I Make Right Now?
                        </button>

                        <!-- Pantry Alerts Section -->
                        <div class="pantry-alerts" id="pantry-alerts"></div>

                        <!-- Quick Add from Delivery -->
                        <div class="quick-add-section" id="quick-add-section">
                            <div class="quick-add-header" onclick="toggleQuickAddSection()">
                                <span>ðŸšš Quick Add from Delivery</span>
                                <span class="accordion-icon">â–¼</span>
                            </div>
                            <div class="quick-add-content" id="quick-add-content">
                                <p class="text-muted" style="font-size: 0.85rem; margin-bottom: 12px;">Just got groceries? Add them quickly:</p>
                                <div class="quick-add-btns">
                                    <button class="quick-add-btn" onclick="openDeliveryQuickAdd('misfits')">
                                        <div style="font-size: 1.2rem;">ðŸ¥¬</div>
                                        <div style="font-weight: 500;">Misfits Market</div>
                                    </button>
                                    <button class="quick-add-btn" onclick="openDeliveryQuickAdd('wholefoods')">
                                        <div style="font-size: 1.2rem;">ðŸ›’</div>
                                        <div style="font-weight: 500;">Whole Foods</div>
                                    </button>
                                    <button class="quick-add-btn" onclick="openDeliveryQuickAdd('csa')">
                                        <div style="font-size: 1.2rem;">ðŸŒ±</div>
                                        <div style="font-weight: 500;">CSA Pickup</div>
                                    </button>
                                    <button class="quick-add-btn" onclick="openDeliveryQuickAdd('custom')">
                                        <div style="font-size: 1.2rem;">âž•</div>
                                        <div style="font-weight: 500;">Custom</div>
                                    </button>
                                </div>
                            </div>
                        </div>

                        <div class="divider-label mb-16 mt-16">Pantry Inventory</div>

                        <div id="pantry-list"></div>
                        <div class="empty-state" id="pantry-empty">
                            <div class="empty-state-icon">ðŸ¥«</div>
                            <div class="empty-state-title">Pantry is empty</div>
                            <p>Add items manually or scan with your camera.</p>
                        </div>
                    </div>
                    <div class="tab-content" id="kitchen-shopping">
                        <!-- Smart Shopping Generator -->
                        <div class="card smart-shopping-card mb-16" id="smart-shopping-generator">
                            <div class="smart-shopping-header">
                                <span class="smart-shopping-icon">ðŸ¤–</span>
                                <h3 class="smart-shopping-title">Generate Smart Shopping List</h3>
                            </div>
                            <p class="text-muted mb-12" style="font-size: 0.85rem;">Automatically creates a list based on:</p>
                            <ul class="smart-shopping-features">
                                <li>ðŸ“… Your weekly meal plan (all meals)</li>
                                <li>ðŸ“¦ Current pantry inventory</li>
                                <li>âš ï¸ Items running low</li>
                                <li>ðŸŒŸ Your typical staples</li>
                            </ul>
                            <button class="btn btn-primary btn-block mt-12" onclick="generateSmartShoppingList()">
                                ðŸŽ¯ Generate from This Week
                            </button>
                        </div>

                        <div class="divider-label mb-16">Your Shopping Lists</div>

                        <div class="flex flex-between flex-center mb-16">
                            <select class="form-select" id="shopping-list-select" style="max-width: 200px;" onchange="loadShoppingList()">
                                <option value="weekly">Weekly Groceries</option>
                            </select>
                            <button class="btn btn-sm btn-primary" onclick="openAddShoppingModal()">+ Add</button>
                        </div>
                        <div id="shopping-list"></div>
                        <div class="empty-state" id="shopping-empty">
                            <div class="empty-state-icon">ðŸ›’</div>
                            <div class="empty-state-title">List is empty</div>
                            <p>Add items or generate from meal plan.</p>
                        </div>
                        <div class="flex gap-8 mt-16">
                            <button class="btn btn-secondary" onclick="printShoppingList()" style="flex: 1;">ðŸ–¨ï¸ Print</button>
                            <button class="btn btn-secondary" onclick="clearCheckedItems()" style="flex: 1;">Clear Done</button>
                        </div>
                    </div>
                    <div class="tab-content" id="kitchen-batch">
                        <div class="card">
                            <h3 class="card-title">ðŸ± Plan Batch Cooking Session</h3>
                            <div class="form-group">
                                <label>What to prep?</label>
                                <div class="grid grid-2">
                                    <label class="checkbox-item"><input type="checkbox" name="batchItems" value="chicken" onchange="checkBatchIngredients()"> Chicken</label>
                                    <label class="checkbox-item"><input type="checkbox" name="batchItems" value="fish" onchange="checkBatchIngredients()"> Fish</label>
                                    <label class="checkbox-item"><input type="checkbox" name="batchItems" value="grains" onchange="checkBatchIngredients()"> Grains</label>
                                    <label class="checkbox-item"><input type="checkbox" name="batchItems" value="vegetables" onchange="checkBatchIngredients()"> Veggies</label>
                                    <label class="checkbox-item"><input type="checkbox" name="batchItems" value="sauce" onchange="checkBatchIngredients()"> Sauces</label>
                                    <label class="checkbox-item"><input type="checkbox" name="batchItems" value="soup" onchange="checkBatchIngredients()"> Soup</label>
                                </div>
                            </div>
                            <div class="form-group">
                                <label>Time available</label>
                                <select class="form-select" id="batch-time">
                                    <option value="1">1 hour</option>
                                    <option value="2" selected>2 hours</option>
                                    <option value="3">3+ hours</option>
                                </select>
                            </div>

                            <!-- Pantry Ingredient Check -->
                            <div class="batch-ingredient-check" id="batch-ingredient-check" style="display: none;">
                                <div class="batch-ingredient-header">
                                    <span>ðŸ“¦</span> Ingredient Check
                                </div>
                                <div id="batch-ingredient-list"></div>
                                <div class="batch-missing-items" id="batch-missing-items" style="display: none;">
                                    <div style="font-weight: 600; margin-bottom: 8px;">Missing Items:</div>
                                    <div id="batch-missing-list"></div>
                                    <button class="btn btn-secondary btn-sm mt-8" onclick="addBatchMissingToShopping()">
                                        ðŸ›’ Add Missing to Shopping List
                                    </button>
                                </div>
                            </div>

                            <button class="btn btn-primary btn-block mt-16" onclick="generateBatchPlan()">Generate Plan</button>
                        </div>
                        <div id="batch-plan-output"></div>
                    </div>
                    <div class="tab-content" id="kitchen-subs">
                        <div class="form-group">
                            <input type="text" class="form-input" id="subs-search" placeholder="I'm out of..." oninput="searchSubstitutions()">
                        </div>
                        <div id="subs-results"></div>
                        <div id="subs-categories">
                            <div class="accordion-item">
                                <div class="accordion-header" onclick="toggleAccordion(this)">
                                    <span>ðŸ§€ Dairy</span><span class="accordion-icon">â–¼</span>
                                </div>
                                <div class="accordion-body">
                                    <p><strong>Greek Yogurt â†’</strong> Labneh, sour cream</p>
                                    <p><strong>Feta â†’</strong> Goat cheese, ricotta salata</p>
                                    <p><strong>Parmesan â†’</strong> Pecorino, nutritional yeast</p>
                                </div>
                            </div>
                            <div class="accordion-item">
                                <div class="accordion-header" onclick="toggleAccordion(this)">
                                    <span>ðŸŒ¿ Herbs</span><span class="accordion-icon">â–¼</span>
                                </div>
                                <div class="accordion-body">
                                    <p><strong>Fresh herbs â†’</strong> Dried at 1/3 amount</p>
                                    <p><strong>Basil â†’</strong> Oregano, parsley</p>
                                    <p><strong>Dill â†’</strong> Fennel fronds, tarragon</p>
                                </div>
                            </div>
                            <div class="accordion-item">
                                <div class="accordion-header" onclick="toggleAccordion(this)">
                                    <span>ðŸ‹ Acids</span><span class="accordion-icon">â–¼</span>
                                </div>
                                <div class="accordion-body">
                                    <p><strong>Lemon juice â†’</strong> White wine vinegar + sugar</p>
                                    <p><strong>Red wine vinegar â†’</strong> Balsamic, sherry vinegar</p>
                                    <p><strong>White wine â†’</strong> Broth + vinegar splash</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Garden Sub-View -->
                <div class="hidden" id="more-garden">
                    <button class="btn btn-ghost mb-16" onclick="showMoreMenu()">â† Back</button>
                    <h2 class="section-title">ðŸŒ± Garden</h2>
                    <div class="tabs">
                        <button class="tab active" onclick="switchGardenTab('inventory')">My Garden</button>
                        <button class="tab" onclick="switchGardenTab('planting')">Planting</button>
                        <button class="tab" onclick="switchGardenTab('harvest')">Harvest</button>
                    </div>
                    <div class="tab-content active" id="garden-inventory">
                        <div class="flex flex-between flex-center mb-16">
                            <span class="text-muted">What's growing</span>
                            <button class="btn btn-sm btn-primary" onclick="openAddPlantModal()">+ Add</button>
                        </div>
                        <div id="garden-plants"></div>
                        <button class="btn btn-secondary mt-16 btn-block" onclick="askNonnaWithGarden()">ðŸ… Recipes with my harvest</button>
                    </div>
                    <div class="tab-content" id="garden-planting">
                        <div class="card">
                            <h3 class="card-title">ðŸŒ± Plant Now</h3>
                            <p class="text-muted mb-16">Recommendations for your zone</p>
                            <div id="planting-suggestions"></div>
                        </div>
                    </div>
                    <div class="tab-content" id="garden-harvest">
                        <div class="flex flex-between flex-center mb-16">
                            <span class="text-muted">Harvest log</span>
                            <button class="btn btn-sm btn-primary" onclick="openLogHarvestModal()">+ Log</button>
                        </div>
                        <div id="harvest-log"></div>
                    </div>
                </div>

                <!-- Crohn's Care Sub-View -->
                <div class="hidden" id="more-crohns">
                    <button class="btn btn-ghost mb-16" onclick="showMoreMenu()">â† Back</button>
                    <h2 class="section-title">ðŸ©º Crohn's Care</h2>
                    <button class="btn btn-primary btn-block" style="padding: 20px; font-size: 1.1rem; margin-bottom: 20px;" onclick="activateFlareMode()">
                        ðŸ˜” I'm Having a Flare - Help Me
                    </button>
                    <div class="flare-banner hidden" id="flare-mode-banner">
                        <div class="flare-banner-title">ðŸŒ¡ï¸ Flare Mode Active</div>
                        <div class="flare-banner-text">Nonna will only suggest gentle meals.</div>
                        <button class="btn btn-sm btn-ghost mt-8" onclick="deactivateFlareMode()">Exit Flare Mode</button>
                    </div>
                    <div class="card">
                        <h3 class="card-title">ðŸ’š Gentle Meal Ideas</h3>
                        <div class="quick-actions">
                            <button class="quick-action" onclick="askNonna('Give me a gentle soup recipe for a flare day')">Soothing Soup</button>
                            <button class="quick-action" onclick="askNonna('Easy-to-digest dinner')">Easy Dinner</button>
                            <button class="quick-action" onclick="askNonna('Simple breakfast for low energy')">Simple Breakfast</button>
                        </div>
                    </div>
                    <div class="card">
                        <h3 class="card-title">ðŸš« Avoid During Flare</h3>
                        <ul style="padding-left: 20px; color: var(--gray-text); font-size: 0.9rem;">
                            <li>Raw vegetables</li>
                            <li>High-fiber foods</li>
                            <li>Spicy foods</li>
                            <li>Dairy (if intolerant)</li>
                            <li>Nuts and seeds</li>
                            <li>Fried foods</li>
                        </ul>
                    </div>
                </div>

                <!-- History Sub-View -->
                <div class="hidden" id="more-history">
                    <button class="btn btn-ghost mb-16" onclick="showMoreMenu()">â† Back</button>
                    <h2 class="section-title">ðŸ“– Meal History</h2>
                    <div class="card">
                        <h3 class="card-title">ðŸ“Š Stats</h3>
                        <div class="grid grid-2">
                            <div><strong>This Week:</strong> <span id="stat-week">0</span> meals</div>
                            <div><strong>This Month:</strong> <span id="stat-month">0</span> meals</div>
                        </div>
                    </div>
                    <div class="flex flex-between flex-center mb-16 mt-16">
                        <span class="text-muted">Recent meals</span>
                        <button class="btn btn-sm btn-secondary" onclick="openAddMealModal()">+ Add</button>
                    </div>
                    <div id="history-list"></div>
                    <div class="empty-state" id="history-empty">
                        <div class="empty-state-icon">ðŸ“–</div>
                        <div class="empty-state-title">No meals logged</div>
                        <p>Mark recipes as cooked to track history.</p>
                    </div>
                </div>

                <!-- Settings Sub-View -->
                <div class="hidden" id="more-settings">
                    <button class="btn btn-ghost mb-16" onclick="showMoreMenu()">â† Back</button>
                    <h2 class="section-title">âš™ï¸ Settings</h2>
                    <div class="card">
                        <h3 class="card-title">ðŸŽ¨ Appearance</h3>
                        <label class="toggle">
                            <input type="checkbox" id="dark-mode-toggle" onchange="toggleDarkMode()">
                            <span class="toggle-switch"></span>
                            <span>ðŸŒ™ Dark Mode</span>
                        </label>
                    </div>
                    <div class="card">
                        <h3 class="card-title">ðŸ‘¤ Profile</h3>
                        <button class="btn btn-secondary btn-block" onclick="editProfile()">Edit Health Profile</button>
                    </div>
                    <div class="card">
                        <h3 class="card-title">ðŸŽ“ Help</h3>
                        <button class="btn btn-secondary btn-block mb-8" onclick="startOnboarding()">Take App Tour</button>
                    </div>
                    <div class="card">
                        <h3 class="card-title">ðŸ’¾ Data</h3>
                        <div class="flex gap-8" style="flex-wrap: wrap;">
                            <button class="btn btn-secondary btn-sm" onclick="exportAllData()">Export</button>
                            <button class="btn btn-secondary btn-sm" onclick="importData()">Import</button>
                            <button class="btn btn-sm" style="background: var(--danger); color: white;" onclick="confirmClearAllData()">Clear All</button>
                        </div>
                    </div>
                    <div class="card">
                        <h3 class="card-title">â„¹ï¸ About</h3>
                        <p class="text-muted">Tavola v3.0</p>
                        <p class="text-muted" style="font-size: 0.85rem;">Made with â¤ï¸ for chronic illness warriors</p>
                    </div>
                </div>
            </div>

            <!-- FAVORITES View -->
            <div class="view" id="view-favorites">
                <h2 class="section-title">â¤ï¸ Favorites</h2>
                <div class="flex flex-between flex-center mb-16">
                    <input type="text" class="form-input" id="favorites-search" placeholder="Search..." style="max-width: 200px;" oninput="filterFavorites()">
                    <select class="form-select" id="favorites-sort" style="max-width: 140px;" onchange="sortFavorites()">
                        <option value="recent">Recent</option>
                        <option value="rating">Rating</option>
                        <option value="name">Name A-Z</option>
                    </select>
                </div>
                <div class="grid grid-2" id="favorites-grid"></div>
                <div class="empty-state" id="favorites-empty">
                    <div class="empty-state-icon">â¤ï¸</div>
                    <div class="empty-state-title">No favorites yet</div>
                    <p class="empty-state-text">Browse your recipe library or ask Nonna for suggestions, then tap â¤ï¸ to save favorites here!</p>
                    <button class="btn btn-primary" onclick="navigateTo('recipes')">ðŸ“š Browse Recipe Library</button>
                </div>
            </div>
        </div>
    </main>

    <!-- Bottom Navigation (5 tabs) -->
    <nav class="bottom-nav hidden" id="bottom-nav">
        <button class="nav-item active" onclick="navigateTo('home')" data-view="home">
            <span class="icon">ðŸ </span>
            <span>Home</span>
        </button>
        <button class="nav-item" onclick="navigateTo('week')" data-view="week">
            <span class="icon">ðŸ“…</span>
            <span>Week</span>
        </button>
        <button class="nav-item" onclick="navigateTo('recipes')" data-view="recipes">
            <span class="icon">ðŸ“š</span>
            <span>Recipes</span>
        </button>
        <button class="nav-item" onclick="navigateTo('chat')" data-view="chat">
            <span class="icon">ðŸ’¬</span>
            <span>Chat</span>
        </button>
        <button class="nav-item" onclick="navigateTo('workouts')" data-view="workouts">
            <span class="icon">ðŸ’ª</span>
            <span>Workouts</span>
        </button>
        <button class="nav-item" onclick="navigateTo('more')" data-view="more">
            <span class="icon">â‹®</span>
            <span>More</span>
        </button>
    </nav>

    <!-- Modal Container -->
    <div class="modal-overlay" id="modal-overlay" onclick="closeModalOnOverlay(event)">
        <div class="modal" id="modal-content"></div>
    </div>

    <!-- Toast -->
    <div class="toast" id="toast"></div>

    <!-- Onboarding Overlay -->
    <div class="onboarding-overlay" id="onboarding-overlay">
        <div class="onboarding-card" id="onboarding-card"></div>
    </div>

    <!-- Cook Mode Overlay -->
    <div class="cook-mode-overlay" id="cook-mode-overlay">
        <div class="cook-mode-header">
            <span class="cook-mode-progress" id="cook-mode-progress">Step 1 of 5</span>
            <button class="cook-mode-close" onclick="exitCookMode()">âœ• Exit</button>
        </div>
        <div class="cook-mode-body" id="cook-mode-body"></div>
        <div class="cook-mode-footer">
            <button class="btn btn-secondary" id="cook-prev-btn" onclick="cookModePrev()">â† Previous</button>
            <button class="btn btn-primary" id="cook-next-btn" onclick="cookModeNext()">Next â†’</button>
        </div>
    </div>

<!-- HTML STRUCTURE COMPLETE - JavaScript follows -->
<script>
// ========================================
// STORAGE KEYS
// ========================================
const STORAGE = {
    PROFILE: 'tavola_profile',
    CHAT: 'tavola_chat_history',
    FAVORITES: 'tavola_favorites',
    RECIPES: 'tavola_recipe_library',
    PANTRY: 'tavola_pantry',
    SHOPPING: 'tavola_shopping_lists',
    MEAL_PLANS: 'tavola_meal_plans',
    GARDEN: 'tavola_garden',
    HISTORY: 'tavola_meal_history',
    PREFS: 'tavola_preferences',
    ONBOARDING: 'tavola_onboarding_done',
    WORKOUTS: 'tavola_workouts'
};

// ========================================
// APP STATE
// ========================================
let state = {
    currentView: 'home',
    currentWeekOffset: 0,
    chatHistory: [],
    isProcessing: false,
    isRecording: false,
    flareMode: false,
    recognition: null,
    cookMode: { active: false, recipe: null, currentStep: 0 },
    recipeEditMode: false,
    selectedRecipes: new Set(),
    selectedTagFilters: new Set()
};

// Nonna's Tips
const NONNA_TIPS = [
    "Always finish with good olive oil - it makes everything taste better, cara.",
    "Cook with love, and the food will love you back.",
    "A little lemon brightens everything - just like a smile!",
    "Rest is an ingredient too. Take breaks when you need them.",
    "Fresh herbs are medicine for the soul and the body.",
    "Simple food, made well, is the best food of all.",
    "Batch cooking on good days saves you on hard days.",
    "The Mediterranean way is not a diet - it's a way of life.",
    "Olive oil, garlic, lemon - the holy trinity of healing.",
    "Gentle on the stomach, generous with flavor."
];

// ========================================
// INITIALIZATION
// ========================================
document.addEventListener('DOMContentLoaded', () => {
    initApp();
});

function initApp() {
    // Clean up duplicate recipes on startup
    cleanupDuplicateRecipes();

    const profile = getStorage(STORAGE.PROFILE);
    if (profile) {
        showApp();
        loadChatHistory();
        if (state.chatHistory.length === 0) {
            addWelcomeMessage();
        }
        checkOnboarding();
    } else {
        showWelcome();
    }
    initVoiceRecognition();
    initChatInput();
    loadPreferences();
    setDailyTip();
}

function cleanupDuplicateRecipes() {
    const library = getStorage(STORAGE.RECIPES) || [];
    if (library.length === 0) return;

    const seen = new Map(); // normalized title -> best recipe
    const duplicatesRemoved = [];

    // Sort by date (newest first) so we keep the most recent version
    library.sort((a, b) => new Date(b.dateGenerated) - new Date(a.dateGenerated));

    library.forEach(recipe => {
        const normalized = normalizeRecipeTitle(recipe.title);

        if (!seen.has(normalized)) {
            // First occurrence (newest) - keep it
            seen.set(normalized, recipe);
        } else {
            // Duplicate found - merge important data into the kept one
            const kept = seen.get(normalized);

            // Preserve cooking history, ratings, and favorites from duplicates
            if (recipe.timesCooked > (kept.timesCooked || 0)) {
                kept.timesCooked = recipe.timesCooked;
            }
            if (recipe.averageRating > (kept.averageRating || 0)) {
                kept.averageRating = recipe.averageRating;
            }
            if (recipe.favorited) {
                kept.favorited = true;
            }
            if (recipe.cookingHistory?.length > 0) {
                kept.cookingHistory = kept.cookingHistory || [];
                kept.cookingHistory = [...kept.cookingHistory, ...recipe.cookingHistory];
            }

            duplicatesRemoved.push(recipe.title);
        }
    });

    if (duplicatesRemoved.length > 0) {
        // Save cleaned library
        const cleanedLibrary = Array.from(seen.values());
        setStorage(STORAGE.RECIPES, cleanedLibrary);
        console.log(`Cleaned up ${duplicatesRemoved.length} duplicate recipes:`, duplicatesRemoved);
    }
}

function checkOnboarding() {
    const done = getStorage(STORAGE.ONBOARDING);
    if (!done) {
        setTimeout(() => startOnboarding(), 500);
    }
}

// ========================================
// STORAGE HELPERS
// ========================================
function getStorage(key) {
    try {
        const data = localStorage.getItem(key);
        return data ? JSON.parse(data) : null;
    } catch (e) {
        console.error('Storage read error:', e);
        return null;
    }
}

function setStorage(key, value) {
    try {
        localStorage.setItem(key, JSON.stringify(value));
        return true;
    } catch (e) {
        console.error('Storage write error:', e);
        return false;
    }
}

// ========================================
// VIEW MANAGEMENT
// ========================================
function showWelcome() {
    document.getElementById('welcome-screen').style.display = 'flex';
    document.getElementById('intake-form').classList.remove('active');
    document.getElementById('app-main').classList.remove('active');
    document.getElementById('app-header').classList.add('hidden');
    document.getElementById('bottom-nav').classList.add('hidden');
}

function showIntakeForm() {
    document.getElementById('welcome-screen').style.display = 'none';
    document.getElementById('intake-form').classList.add('active');
    document.getElementById('app-main').classList.remove('active');
}

function showApp() {
    document.getElementById('welcome-screen').style.display = 'none';
    document.getElementById('intake-form').classList.remove('active');
    document.getElementById('app-main').classList.add('active');
    document.getElementById('app-header').classList.remove('hidden');
    document.getElementById('bottom-nav').classList.remove('hidden');
    navigateTo('home');
}

function navigateTo(view) {
    state.currentView = view;

    // Update views
    document.querySelectorAll('#app-main > .container > .view').forEach(v => v.classList.remove('active'));
    const targetView = document.getElementById(`view-${view}`);
    if (targetView) targetView.classList.add('active');

    // Update bottom nav
    document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
    const navItem = document.querySelector(`.nav-item[data-view="${view}"]`);
    if (navItem) navItem.classList.add('active');

    // Show More menu if going to more
    if (view === 'more') showMoreMenu();

    // Load view-specific data
    if (view === 'home') updateDashboard();
    if (view === 'favorites') renderFavorites();
    if (view === 'week') renderWeekPlanner();
    if (view === 'recipes') renderRecipeLibrary();
    if (view === 'workouts') renderWorkoutsView();
}

function showMoreMenu() {
    document.getElementById('more-menu-main').classList.remove('hidden');
    document.getElementById('more-kitchen').classList.add('hidden');
    document.getElementById('more-garden').classList.add('hidden');
    document.getElementById('more-crohns').classList.add('hidden');
    document.getElementById('more-history').classList.add('hidden');
    document.getElementById('more-settings').classList.add('hidden');
}

function switchMoreTab(tab) {
    document.getElementById('more-menu-main').classList.add('hidden');
    document.querySelectorAll('[id^="more-"]').forEach(el => el.classList.add('hidden'));
    document.getElementById(`more-${tab}`).classList.remove('hidden');

    // Load data
    if (tab === 'kitchen') renderPantry();
    if (tab === 'garden') renderGarden();
    if (tab === 'history') renderHistory();
    if (tab === 'crohns') updateFlareUI();
}

// ========================================
// DASHBOARD
// ========================================
function updateDashboard() {
    const favorites = getStorage(STORAGE.FAVORITES) || [];
    const recipes = getStorage(STORAGE.RECIPES) || [];
    const mealPlans = getStorage(STORAGE.MEAL_PLANS) || {};
    const profile = getStorage(STORAGE.PROFILE);

    // Count planned meals this week
    const weekDates = getWeekDates(0);
    let plannedCount = 0;
    weekDates.forEach(d => {
        if (mealPlans[d]) plannedCount++;
    });

    document.getElementById('stat-meals-planned').textContent = `${plannedCount}/7`;
    document.getElementById('stat-favorites').textContent = favorites.length;
    document.getElementById('stat-recipes').textContent = recipes.length;

    // Garden stat
    if (profile && profile.currentlyGrowing) {
        const plants = profile.currentlyGrowing.split(',').filter(p => p.trim());
        document.getElementById('stat-garden').textContent = plants.length > 0 ? `${plants.length} plants` : '-';
    }

    // Recent activity
    updateRecentActivity();

    // Update workout dashboard card
    updateDashboardWorkoutCard();

    // Flare mode indicator
    const flareBanner = document.getElementById('home-flare-banner');
    if (state.flareMode) {
        flareBanner.classList.remove('hidden');
    } else {
        flareBanner.classList.add('hidden');
    }
}

function updateDashboardWorkoutCard() {
    const caloriesIn = getTodaysCaloriesIn();
    const caloriesOut = getTodaysCaloriesOut();
    const netCalories = caloriesIn - caloriesOut;
    const todaysWorkouts = getTodaysWorkouts();

    document.getElementById('dashboard-calories-in').textContent = caloriesIn;
    document.getElementById('dashboard-calories-out').textContent = caloriesOut;
    document.getElementById('dashboard-calorie-net').textContent = `${netCalories > 0 ? '+' : ''}${netCalories}`;
    document.getElementById('dashboard-workouts-today').textContent = todaysWorkouts.length;

    // Update net balance color
    const netEl = document.getElementById('dashboard-calorie-net');
    if (netCalories > 200) {
        netEl.style.color = 'var(--danger)';
    } else if (netCalories < -200) {
        netEl.style.color = 'var(--success)';
    } else {
        netEl.style.color = 'var(--cerulean)';
    }
}

function updateRecentActivity() {
    const history = getStorage(STORAGE.HISTORY) || [];
    const container = document.getElementById('recent-activity');

    if (history.length === 0) {
        container.innerHTML = '<div class="empty-state" style="padding: 24px;"><p class="text-muted">No recent activity. Start chatting with Nonna!</p></div>';
        return;
    }

    const recent = history.slice(0, 3);
    container.innerHTML = recent.map(item => `
        <div class="activity-item">
            <span class="activity-icon">${item.type === 'cooked' ? 'ðŸ½ï¸' : 'ðŸ’¬'}</span>
            <div class="activity-content">
                <div class="activity-title">${item.title}</div>
                <div class="activity-time">${formatRelativeDate(item.date)}</div>
            </div>
        </div>
    `).join('');
}

function setDailyTip() {
    const dayOfYear = Math.floor((new Date() - new Date(new Date().getFullYear(), 0, 0)) / 86400000);
    const tip = NONNA_TIPS[dayOfYear % NONNA_TIPS.length];
    document.getElementById('nonna-tip-text').textContent = `"${tip}"`;
}

// ========================================
// PROFILE MANAGEMENT
// ========================================
function toggleCookingForTwo() {
    const toggle = document.getElementById('cookingForTwoToggle');
    const fields = document.getElementById('cookingForTwoFields');
    fields.classList.toggle('hidden', !toggle.checked);
}

function toggleConditionDetails(conditionId) {
    const detailsEl = document.getElementById(`${conditionId}-details`);
    if (!detailsEl) return;

    // Find the checkbox that controls this
    const checkboxMap = {
        'crohns': 'crohns',
        'uc': 'uc',
        'ibs': 'ibs',
        'cholesterol': 'highCholesterol',
        'bp': 'highBP',
        'diabetes': 'diabetes',
        'kidney': 'kidney',
        'fibro': 'fibromyalgia',
        'thyroid': 'hashimotos'
    };

    const checkboxValue = checkboxMap[conditionId];
    const checkbox = document.querySelector(`[name="conditions"][value="${checkboxValue}"]`);

    if (checkbox) {
        detailsEl.classList.toggle('hidden', !checkbox.checked);
    }
}

function saveProfile(e) {
    e.preventDefault();
    const form = e.target;

    const profile = {
        // Health conditions (checkboxes)
        conditions: Array.from(form.querySelectorAll('[name="conditions"]:checked')).map(c => c.value),

        // Condition-specific details
        crohnsSeverity: form.crohnsSeverity?.value || '',
        crohnsTriggers: form.crohnsTriggers?.value || '',
        ucSeverity: form.ucSeverity?.value || '',
        ibsType: form.ibsType?.value || '',
        cholesterolGoal: form.cholesterolGoal?.value || '',
        sodiumRestriction: form.sodiumRestriction?.value || '',
        carbManagement: form.carbManagement?.value || '',
        kidneyRestrictions: Array.from(form.querySelectorAll('[name="kidneyRestrictions"]:checked')).map(c => c.value),
        fibroEnergy: form.fibroEnergy?.value || '',
        thyroidType: form.thyroidType?.value || '',

        // Food allergies
        foodAllergies: form.foodAllergies?.value || '',

        // Dietary goals
        dietaryGoals: Array.from(form.querySelectorAll('[name="dietaryGoals"]:checked')).map(c => c.value),

        // Other notes
        otherConditions: form.otherConditions?.value || '',

        // Cooking for two
        cookingForTwo: form.cookingForTwo?.checked || false,
        partnerName: form.partnerName?.value || '',
        partnerRestrictions: Array.from(form.querySelectorAll('[name="partnerRestrictions"]:checked')).map(c => c.value),
        partnerAllergies: form.partnerAllergies?.value || '',
        partnerLoves: form.partnerLoves?.value || '',

        // Proteins
        proteins: Array.from(form.querySelectorAll('[name="proteins"]:checked')).map(c => c.value),

        // Garden
        currentlyGrowing: form.currentlyGrowing?.value || '',
        growingZone: form.growingZone?.value || '',
        currentSeason: form.currentSeason?.value || '',

        // Cooking preferences
        energyLevel: form.energyLevel?.value || '',
        cookingTime: form.cookingTime?.value || '',
        weeklyBudget: form.weeklyBudget?.value || '',
        shoppingPriority: form.shoppingPriority?.value || '',
        foodsToAvoid: form.foodsToAvoid?.value || '',
        favoriteFlavors: form.favoriteFlavors?.value || '',

        createdAt: new Date().toISOString()
    };

    setStorage(STORAGE.PROFILE, profile);
    showApp();
}

function editProfile() {
    const profile = getStorage(STORAGE.PROFILE);
    showIntakeForm();

    if (profile) {
        setTimeout(() => {
            const form = document.getElementById('profile-form');

            // Restore simple fields
            const simpleFields = ['crohnsSeverity', 'crohnsTriggers', 'ucSeverity', 'ibsType',
                'cholesterolGoal', 'sodiumRestriction', 'carbManagement', 'fibroEnergy',
                'thyroidType', 'foodAllergies', 'otherConditions', 'partnerName',
                'partnerAllergies', 'partnerLoves', 'currentlyGrowing', 'growingZone',
                'currentSeason', 'energyLevel', 'cookingTime', 'weeklyBudget',
                'shoppingPriority', 'foodsToAvoid', 'favoriteFlavors'];

            simpleFields.forEach(key => {
                const el = form.querySelector(`[name="${key}"]`);
                if (el && profile[key]) el.value = profile[key];
            });

            // Restore cookingForTwo toggle
            if (profile.cookingForTwo) {
                const toggle = form.querySelector('[name="cookingForTwo"]');
                if (toggle) {
                    toggle.checked = true;
                    toggleCookingForTwo();
                }
            }

            // Restore condition checkboxes and show details
            if (profile.conditions) {
                profile.conditions.forEach(c => {
                    const cb = form.querySelector(`[name="conditions"][value="${c}"]`);
                    if (cb) {
                        cb.checked = true;
                        // Trigger details show
                        const detailsMap = {
                            'crohns': 'crohns', 'uc': 'uc', 'ibs': 'ibs',
                            'highCholesterol': 'cholesterol', 'highBP': 'bp',
                            'diabetes': 'diabetes', 'kidney': 'kidney',
                            'fibromyalgia': 'fibro', 'hashimotos': 'thyroid'
                        };
                        if (detailsMap[c]) toggleConditionDetails(detailsMap[c]);
                    }
                });
            }

            // Restore dietary goals
            if (profile.dietaryGoals) {
                profile.dietaryGoals.forEach(g => {
                    const cb = form.querySelector(`[name="dietaryGoals"][value="${g}"]`);
                    if (cb) cb.checked = true;
                });
            }

            // Restore proteins
            if (profile.proteins) {
                profile.proteins.forEach(p => {
                    const cb = form.querySelector(`[name="proteins"][value="${p}"]`);
                    if (cb) cb.checked = true;
                });
            }

            // Restore partner restrictions
            if (profile.partnerRestrictions) {
                profile.partnerRestrictions.forEach(r => {
                    const cb = form.querySelector(`[name="partnerRestrictions"][value="${r}"]`);
                    if (cb) cb.checked = true;
                });
            }

            // Restore kidney restrictions
            if (profile.kidneyRestrictions) {
                profile.kidneyRestrictions.forEach(r => {
                    const cb = form.querySelector(`[name="kidneyRestrictions"][value="${r}"]`);
                    if (cb) cb.checked = true;
                });
            }
        }, 100);
    }
}

function loadPreferences() {
    const prefs = getStorage(STORAGE.PREFS) || {};
    if (prefs.darkMode) {
        document.body.classList.add('dark-mode');
        const toggle = document.getElementById('dark-mode-toggle');
        if (toggle) toggle.checked = true;
    }
    state.flareMode = prefs.flareMode || false;
}

function toggleDarkMode() {
    const toggle = document.getElementById('dark-mode-toggle');
    document.body.classList.toggle('dark-mode', toggle.checked);
    const prefs = getStorage(STORAGE.PREFS) || {};
    prefs.darkMode = toggle.checked;
    setStorage(STORAGE.PREFS, prefs);
}

// ========================================
// CHAT FUNCTIONALITY
// ========================================
function initChatInput() {
    const input = document.getElementById('chat-input');
    if (!input) return;
    input.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            sendMessage();
        }
    });
    input.addEventListener('input', () => {
        input.style.height = 'auto';
        input.style.height = Math.min(input.scrollHeight, 120) + 'px';
    });
}

function loadChatHistory() {
    state.chatHistory = getStorage(STORAGE.CHAT) || [];
    renderChatHistory();
}

function saveChatHistory() {
    setStorage(STORAGE.CHAT, state.chatHistory);
}

function addWelcomeMessage() {
    const profile = getStorage(STORAGE.PROFILE);
    let text = "Ciao, cara! I'm Nonna, your Mediterranean cooking companion. ";
    if (profile) {
        text += "I've looked at your profile and I'm ready to help you plan delicious, gentle meals. ";
    }
    text += "What would you like to cook today?";

    const msg = { role: 'assistant', content: text, timestamp: new Date().toISOString() };
    state.chatHistory.push(msg);
    saveChatHistory();
    renderMessage(msg, true);
    renderQuickActions();
}

function renderChatHistory() {
    const container = document.getElementById('chat-messages');
    if (!container) return;
    container.innerHTML = '';
    state.chatHistory.forEach(msg => renderMessage(msg, false));
    if (state.chatHistory.length <= 1) renderQuickActions();
}

function renderMessage(message, animate = true) {
    const container = document.getElementById('chat-messages');
    if (!container) return;

    const div = document.createElement('div');
    div.className = `message message-${message.role}`;
    if (!animate) div.style.animation = 'none';

    const bubble = document.createElement('div');
    bubble.className = 'message-bubble';

    // Check for recipe or weekly plan
    if (message.role === 'assistant') {
        if (message.content.includes('=== RECIPE:') || message.content.includes('RECIPE:')) {
            bubble.innerHTML = parseRecipeToCard(message.content);
        } else if (message.content.includes('Your Week is Planned') || message.content.includes('WEEKLY MEAL PLAN')) {
            bubble.innerHTML = parseWeekPlanToCard(message.content);
        } else {
            bubble.innerHTML = formatMessageContent(message.content);
        }
    } else {
        bubble.innerHTML = formatMessageContent(message.content);
    }

    div.appendChild(bubble);
    container.appendChild(div);
    scrollToBottom();
}

function formatMessageContent(content) {
    return content
        .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
        .replace(/^### (.*$)/gm, '<h3 style="color: var(--cerulean); margin: 12px 0 8px;">$1</h3>')
        .replace(/^## (.*$)/gm, '<h2 style="color: var(--cerulean); margin: 16px 0 8px;">$1</h2>')
        .replace(/^- (.*$)/gm, '<li>$1</li>')
        .replace(/^(\d+)\. (.*$)/gm, '<li>$2</li>')
        .replace(/â˜ (.*$)/gm, '<span style="display: block;">â˜ $1</span>')
        .replace(/\n\n/g, '</p><p>')
        .replace(/\n/g, '<br>');
}

function parseRecipeToCard(content) {
    // Extract recipe components
    const titleMatch = content.match(/(?:===\s*)?RECIPE:\s*(.+?)(?:\s*===|\n|$)/i);
    const servesMatch = content.match(/Serves:\s*(\d+)/i);
    const timeMatch = content.match(/Total(?:\s*Time)?:\s*(\d+)\s*min/i);
    const prepMatch = content.match(/Prep:\s*(\d+)\s*min/i);
    const cookMatch = content.match(/Cook:\s*(\d+)\s*min/i);

    // Extract tags from content
    const tagsMatch = content.match(/\*?\*?TAGS\*?\*?:?\s*(.+?)(?:\n|$)/i);
    const rawTags = tagsMatch ? tagsMatch[1].split(/[,;]/).map(t => t.trim()).filter(t => t) : [];

    // Extract nutrition
    const nutritionMatch = content.match(/\*?\*?NUTRITION[^:]*\*?\*?:?([\s\S]*?)(?=\*?\*?INGREDIENTS|$)/i);
    const nutrition = parseNutrition(nutritionMatch ? nutritionMatch[1] : '');

    // Extract health benefits
    const healthMatch = content.match(/\*?\*?WHY THIS HELPS[^:]*\*?\*?:?([\s\S]*?)(?=\*?\*?MODIFICATIONS|FLARE|GARDEN|---|$)/i);
    const healthBenefits = healthMatch ? healthMatch[1].trim() : '';

    // Extract ingredients
    const ingredientsMatch = content.match(/\*?\*?INGREDIENTS\*?\*?:?([\s\S]*?)(?=\*?\*?INSTRUCTIONS|$)/i);
    const ingredients = ingredientsMatch ?
        ingredientsMatch[1].trim().split('\n').filter(l => l.trim().startsWith('-')).map(l => l.replace(/^-\s*/, '').trim()) : [];

    // Extract instructions
    const instructionsMatch = content.match(/\*?\*?INSTRUCTIONS\*?\*?:?([\s\S]*?)(?=\*?\*?WHY THIS|FLARE|GARDEN|STORAGE|MODIFICATIONS|CROHN|---|$)/i);
    const instructions = instructionsMatch ?
        instructionsMatch[1].trim().split('\n').filter(l => /^\d+\./.test(l.trim())).map(l => l.replace(/^\d+\.\s*/, '').trim()) : [];

    // Extract modifications (combined flare mods and other modifications)
    const modsMatch = content.match(/\*?\*?(?:FLARE\s*)?MODIFICATIONS?\*?\*?:?([\s\S]*?)(?=\*?\*?GARDEN|STORAGE|---|$)/i);
    const modifications = modsMatch ? modsMatch[1].trim() : '';

    const title = titleMatch ? titleMatch[1].trim().replace(/===\s*$/, '').trim() : 'Recipe';
    const serves = servesMatch ? servesMatch[1] : '2';
    const totalTime = timeMatch ? timeMatch[1] : '30';
    const prepTime = prepMatch ? prepMatch[1] : '10';
    const cookTime = cookMatch ? cookMatch[1] : '20';

    // Generate unique ID
    const recipeId = 'recipe_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);

    // Determine protein type
    const proteinTypes = { fish: /fish|cod|salmon|tilapia|shrimp|tuna|halibut/i, chicken: /chicken/i, pork: /pork/i, beef: /beef/i, vegetarian: /vegetarian|vegan|tofu|tempeh/i };
    let proteinType = 'other';
    for (const [type, regex] of Object.entries(proteinTypes)) {
        if (regex.test(content)) { proteinType = type; break; }
    }

    // Process tags - combine extracted tags with auto-detected ones
    const tags = processRecipeTags(rawTags, content, parseInt(totalTime), proteinType);

    // Store recipe data temporarily (NOT auto-saved to library)
    const recipeData = {
        id: recipeId,
        title: title,
        ingredients: ingredients,
        instructions: instructions,
        modifications: modifications,
        healthBenefits: healthBenefits,
        nutrition: nutrition,
        metadata: {
            prepTime: parseInt(prepTime),
            cookTime: parseInt(cookTime),
            totalTime: parseInt(totalTime),
            serves: parseInt(serves),
            proteinType: proteinType,
            tags: tags
        },
        dateGenerated: new Date().toISOString(),
        timesCooked: 0,
        rating: 0,
        favorited: false,
        rawContent: content
    };
    // Store in temporary cache for explicit saving later
    window.pendingRecipes = window.pendingRecipes || {};
    window.pendingRecipes[recipeId] = recipeData;

    // Build tags HTML
    const tagsHtml = tags.map(tag => {
        const tagClass = getTagClass(tag);
        return `<span class="tag ${tagClass}">${tag}</span>`;
    }).join('');

    // Build nutrition HTML
    const nutritionHtml = nutrition.calories ? `
        <div class="nutrition-box">
            <div class="nutrition-item"><div class="nutrition-value">${nutrition.calories}</div><div class="nutrition-label">Calories</div></div>
            <div class="nutrition-item"><div class="nutrition-value">${nutrition.protein}g</div><div class="nutrition-label">Protein</div></div>
            <div class="nutrition-item"><div class="nutrition-value">${nutrition.carbs}g</div><div class="nutrition-label">Carbs</div></div>
            <div class="nutrition-item"><div class="nutrition-value">${nutrition.fat}g</div><div class="nutrition-label">Fat</div></div>
            <div class="nutrition-item"><div class="nutrition-value">${nutrition.fiber}g</div><div class="nutrition-label">Fiber</div></div>
            <div class="nutrition-item"><div class="nutrition-value">${nutrition.sodium}mg</div><div class="nutrition-label">Sodium</div></div>
        </div>
    ` : '';

    // Build health benefits HTML
    const healthHtml = healthBenefits ? `
        <div class="health-benefits">
            <div class="health-benefits-title">ðŸ’š Why This Helps Your Health</div>
            <div class="health-benefits-text">${healthBenefits.replace(/\n/g, '<br>')}</div>
        </div>
    ` : '';

    return `
        <div class="recipe-card" data-recipe-id="${recipeId}">
            <div class="recipe-header">
                <div class="recipe-title">${title}</div>
                <div class="recipe-actions">
                    <button class="recipe-action-btn ${recipeData.favorited ? 'favorited' : ''}" onclick="toggleFavoriteFromCard('${recipeId}', this)" title="Favorite">â¤ï¸</button>
                    <button class="recipe-action-btn" onclick="printRecipe('${recipeId}')" title="Print">ðŸ–¨ï¸</button>
                </div>
                <div class="recipe-meta">
                    <div class="recipe-meta-item">â±ï¸ ${totalTime} min</div>
                    <div class="recipe-meta-item">ðŸ½ï¸ Serves ${serves}</div>
                    ${nutrition.calories ? `<div class="recipe-meta-item">ðŸ”¥ ${nutrition.calories} cal</div>` : ''}
                </div>
            </div>
            <div class="recipe-tags">
                ${tagsHtml || '<span class="tag tag-mediterranean">Mediterranean</span>'}
            </div>
            ${nutritionHtml}
            ${healthHtml}
            <div class="recipe-body">
                <div class="recipe-section">
                    <div class="recipe-section-title">ðŸ“ Ingredients</div>
                    ${ingredients.map((ing, i) => `
                        <div class="ingredient-item">
                            <input type="checkbox" class="ingredient-checkbox" id="ing_${recipeId}_${i}" onchange="toggleIngredient(this)">
                            <label class="ingredient-text" for="ing_${recipeId}_${i}">${ing}</label>
                        </div>
                    `).join('')}
                </div>
                <div class="recipe-section">
                    <div class="recipe-section-title">ðŸ‘©â€ðŸ³ Instructions</div>
                    ${instructions.map((step, i) => `
                        <div class="instruction-step">
                            <div class="step-number">${i + 1}</div>
                            <div>${step}</div>
                        </div>
                    `).join('')}
                </div>
                ${modifications ? `
                    <div class="recipe-notes">
                        <div class="recipe-notes-title">ðŸ”„ Modifications</div>
                        <p>${modifications.replace(/\n/g, '<br>').replace(/^-\s*/gm, 'â€¢ ')}</p>
                    </div>
                ` : ''}
            </div>
            <div class="recipe-card-actions">
                <button class="btn btn-primary btn-sm" onclick="saveRecipeFromChat('${recipeId}')" id="save-btn-${recipeId}">ðŸ’¾ Save Recipe</button>
                <button class="btn btn-secondary btn-sm" onclick="favoriteRecipeFromChat('${recipeId}')">â¤ï¸ Favorite</button>
                <button class="btn btn-secondary btn-sm" onclick="addToWeekFromChat('${recipeId}')">ðŸ“… Add to Week</button>
            </div>
        </div>
    `;
}

function parseNutrition(text) {
    const nutrition = { calories: '', protein: '', carbs: '', fat: '', fiber: '', sodium: '' };
    if (!text) return nutrition;

    const caloriesMatch = text.match(/Calories?[:\s]*~?(\d+)/i);
    const proteinMatch = text.match(/Protein[:\s]*(\d+)/i);
    const carbsMatch = text.match(/Carbs?[:\s]*(\d+)/i);
    const fatMatch = text.match(/Fat[:\s]*(\d+)/i);
    const fiberMatch = text.match(/Fiber[:\s]*(\d+)/i);
    const sodiumMatch = text.match(/Sodium[:\s]*(\d+)/i);

    if (caloriesMatch) nutrition.calories = caloriesMatch[1];
    if (proteinMatch) nutrition.protein = proteinMatch[1];
    if (carbsMatch) nutrition.carbs = carbsMatch[1];
    if (fatMatch) nutrition.fat = fatMatch[1];
    if (fiberMatch) nutrition.fiber = fiberMatch[1];
    if (sodiumMatch) nutrition.sodium = sodiumMatch[1];

    return nutrition;
}

function processRecipeTags(rawTags, content, totalTime, proteinType) {
    const tags = new Set();

    // Add raw tags from content
    rawTags.forEach(tag => tags.add(tag));

    // Auto-detect tags based on content
    if (totalTime <= 30) tags.add('Quick');
    if (/mediterranean/i.test(content)) tags.add('Mediterranean');
    if (/anti.?inflammatory/i.test(content)) tags.add('Anti-Inflammatory');
    if (/crohn|ibd|digestive/i.test(content)) tags.add("Crohn's-Friendly");
    if (/heart.?healthy|cardiovascular/i.test(content)) tags.add('Heart-Healthy');
    if (/low.?sodium/i.test(content)) tags.add('Low-Sodium');
    if (/low.?carb|keto/i.test(content)) tags.add('Low-Carb');
    if (/diabetic|blood.?sugar/i.test(content)) tags.add('Diabetic-Friendly');
    if (/gluten.?free/i.test(content)) tags.add('Gluten-Free');
    if (/high.?protein/i.test(content)) tags.add('High-Protein');
    if (/one.?pot|sheet.?pan/i.test(content)) tags.add('One-Pot');
    if (/meal.?prep|batch/i.test(content)) tags.add('Meal Prep');
    if (/freezer/i.test(content)) tags.add('Freezer-Friendly');

    // Protein-based tags
    if (proteinType === 'fish') tags.add('Fish');
    if (proteinType === 'chicken') tags.add('Chicken');
    if (proteinType === 'vegetarian') tags.add('Vegetarian');

    // Ensure at least Mediterranean tag
    if (tags.size === 0 || (tags.size === 1 && tags.has('Quick'))) {
        tags.add('Mediterranean');
    }

    return Array.from(tags).slice(0, 6); // Limit to 6 tags
}

function getTagClass(tag) {
    const tagClasses = {
        "Crohn's-Friendly": 'tag-crohns',
        'Heart-Healthy': 'tag-heart',
        'BP-Friendly': 'tag-bp',
        'Diabetic-Friendly': 'tag-diabetic',
        'Anti-Inflammatory': 'tag-anti-inflammatory',
        'Low-Sodium': 'tag-low-sodium',
        'Low-Carb': 'tag-low-carb',
        'Gut-Friendly': 'tag-gut-friendly',
        'Gluten-Free': 'tag-gluten-free',
        'Quick': 'tag-quick',
        'Meal Prep': 'tag-meal-prep',
        'Freezer-Friendly': 'tag-freezer',
        'One-Pot': 'tag-one-pot',
        'Mediterranean': 'tag-mediterranean',
        'Citrus': 'tag-citrus',
        'Garlic': 'tag-garlic',
        'Spicy': 'tag-spicy',
        'Comfort': 'tag-comfort',
        'Fresh': 'tag-fresh',
        'Fish': 'tag-fish',
        'Chicken': 'tag-chicken',
        'Vegetarian': 'tag-vegetarian',
        'High-Protein': 'tag-high-protein'
    };
    return tagClasses[tag] || 'tag-mediterranean';
}

function parseWeekPlanToCard(content) {
    // Extract days and meals from the content (supports multi-meal format)
    const days = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'];
    const mealPlan = {};

    days.forEach(day => {
        mealPlan[day.toLowerCase()] = { breakfast: null, lunch: null, dinner: null, snacks: null };

        // Try to extract multi-meal format first
        // Pattern: **MONDAY** or MONDAY: followed by meal lines
        const daySection = content.match(new RegExp(`\\*?\\*?${day}\\*?\\*?[:\\s]*([\\s\\S]*?)(?=\\*?\\*?(?:${days.join('|')})|$)`, 'i'));

        if (daySection) {
            const section = daySection[1];

            // Extract individual meals with calorie info
            const breakfastMatch = section.match(/ðŸŒ…?\s*Breakfast[:\s]*([^(~\n]+)(?:\s*[~(]?\s*(\d+)\s*cal)?/i);
            const lunchMatch = section.match(/ðŸŒž?\s*Lunch[:\s]*([^(~\n]+)(?:\s*[~(]?\s*(\d+)\s*cal)?/i);
            const dinnerMatch = section.match(/ðŸŒ™?\s*Dinner[:\s]*([^(~\n]+)(?:\s*[~(]?\s*(\d+)\s*cal)?/i);
            const snacksMatch = section.match(/ðŸŽ?\s*Snacks?[:\s]*([^(~\n]+)(?:\s*[~(]?\s*(\d+)\s*cal)?/i);

            if (breakfastMatch) mealPlan[day.toLowerCase()].breakfast = { title: breakfastMatch[1].trim().replace(/[-*]+$/, '').trim(), calories: breakfastMatch[2] ? parseInt(breakfastMatch[2]) : null };
            if (lunchMatch) mealPlan[day.toLowerCase()].lunch = { title: lunchMatch[1].trim().replace(/[-*]+$/, '').trim(), calories: lunchMatch[2] ? parseInt(lunchMatch[2]) : null };
            if (dinnerMatch) mealPlan[day.toLowerCase()].dinner = { title: dinnerMatch[1].trim().replace(/[-*]+$/, '').trim(), calories: dinnerMatch[2] ? parseInt(dinnerMatch[2]) : null };
            if (snacksMatch) mealPlan[day.toLowerCase()].snacks = { title: snacksMatch[1].trim().replace(/[-*]+$/, '').trim(), calories: snacksMatch[2] ? parseInt(snacksMatch[2]) : null };

            // Fallback: if no specific meals found, treat first line as dinner
            if (!breakfastMatch && !lunchMatch && !dinnerMatch && !snacksMatch) {
                const simpleMeal = section.match(/^[-\s]*([^(\n]+)/);
                if (simpleMeal) {
                    const mealTitle = simpleMeal[1].replace(/^[-:*\s]+/, '').replace(/[-*]+$/, '').trim();
                    if (mealTitle && mealTitle.length > 2 && !/^\d+$/.test(mealTitle)) {
                        mealPlan[day.toLowerCase()].dinner = { title: mealTitle, calories: null };
                    }
                }
            }
        }
    });

    // Save to meal plans in new format
    const weekDates = getWeekDates(state.currentWeekOffset);
    const savedPlans = getStorage(STORAGE.MEAL_PLANS) || {};

    days.forEach((day, i) => {
        const dateStr = weekDates[i];
        const dayData = mealPlan[day.toLowerCase()];
        const hasMeals = dayData.breakfast || dayData.lunch || dayData.dinner || dayData.snacks;

        if (hasMeals) {
            savedPlans[dateStr] = {};
            if (dayData.breakfast) savedPlans[dateStr].breakfast = { ...dayData.breakfast, recipeId: null, status: 'planned' };
            if (dayData.lunch) savedPlans[dateStr].lunch = { ...dayData.lunch, recipeId: null, status: 'planned' };
            if (dayData.dinner) savedPlans[dateStr].dinner = { ...dayData.dinner, recipeId: null, status: 'planned' };
            if (dayData.snacks) savedPlans[dateStr].snacks = { ...dayData.snacks, recipeId: null, status: 'planned' };
        }
    });
    setStorage(STORAGE.MEAL_PLANS, savedPlans);

    // Build display card
    const planItems = days.map(day => {
        const d = mealPlan[day.toLowerCase()];
        const meals = [];
        if (d.breakfast) meals.push(`ðŸŒ… ${d.breakfast.title}`);
        if (d.lunch) meals.push(`ðŸŒž ${d.lunch.title}`);
        if (d.dinner) meals.push(`ðŸŒ™ ${d.dinner.title}`);
        if (d.snacks) meals.push(`ðŸŽ ${d.snacks.title}`);
        return meals.length > 0 ? `<div class="week-plan-item"><span><strong>${day}</strong></span><span>${meals.join(' Â· ')}</span></div>` : '';
    }).filter(x => x).join('');

    return `
        <div class="week-plan-card">
            <h3>âœ… Your Week is Planned!</h3>
            ${planItems || '<p>No meals extracted - check the format above.</p>'}
            <div class="week-plan-actions">
                <button class="btn" onclick="navigateTo('week')">ðŸ“… View This Week</button>
                <button class="btn" onclick="generateWeekShoppingList()">ðŸ›’ Shopping List</button>
            </div>
        </div>
    `;
}

function toggleIngredient(checkbox) {
    const label = checkbox.nextElementSibling;
    label.classList.toggle('checked', checkbox.checked);
}

function renderQuickActions() {
    const container = document.getElementById('chat-messages');
    if (!container) return;

    const existing = container.querySelector('.quick-actions');
    if (existing) existing.remove();

    const actions = document.createElement('div');
    actions.className = 'quick-actions';
    actions.innerHTML = `
        <button class="quick-action" onclick="askNonna('Plan my meals for this week')">ðŸ—“ï¸ Plan My Week</button>
        <button class="quick-action" onclick="askNonna('What can I make with what\\'s in my garden?')">ðŸŒ± Use My Garden</button>
        <button class="quick-action" onclick="askNonna('Give me a quick, easy dinner idea')">âš¡ Quick Dinner</button>
        <button class="quick-action" onclick="askNonna('I need a gentle meal - not feeling great')">ðŸ©º Gentle Meal</button>
    `;
    container.appendChild(actions);
    scrollToBottom();
}

function scrollToBottom() {
    const container = document.getElementById('chat-messages');
    if (container) setTimeout(() => container.scrollTop = container.scrollHeight, 50);
}

function showThinking() {
    const container = document.getElementById('chat-messages');
    if (!container) return;

    const animations = ['ðŸ¥˜', 'ðŸ«’', 'ðŸ‹', 'ðŸŒ¿', 'ðŸ“–'];
    const texts = ['Nonna is cooking up ideas...', 'Drizzling olive oil on thoughts...', 'Squeezing fresh inspiration...', 'Chopping fresh ideas...', 'Flipping through recipes...'];
    const idx = Math.floor(Math.random() * animations.length);

    const div = document.createElement('div');
    div.className = 'message message-assistant';
    div.id = 'thinking-message';
    div.innerHTML = `
        <div class="thinking">
            <div class="thinking-animation">${animations[idx]}</div>
            <span class="thinking-text">${texts[idx]}</span>
        </div>
    `;
    container.appendChild(div);
    scrollToBottom();
}

function hideThinking() {
    const el = document.getElementById('thinking-message');
    if (el) el.remove();
}

async function sendMessage() {
    if (state.isProcessing) return;

    const input = document.getElementById('chat-input');
    const message = input.value.trim();
    if (!message) return;

    input.value = '';
    input.style.height = 'auto';

    // Remove quick actions
    document.querySelectorAll('.quick-actions').forEach(el => el.remove());

    // Add user message
    const userMsg = { role: 'user', content: message, timestamp: new Date().toISOString() };
    state.chatHistory.push(userMsg);
    saveChatHistory();
    renderMessage(userMsg);

    // Call API
    state.isProcessing = true;
    document.getElementById('send-btn').disabled = true;
    showThinking();

    try {
        const response = await callAPI(message);
        hideThinking();

        const assistantMsg = { role: 'assistant', content: response, timestamp: new Date().toISOString() };
        state.chatHistory.push(assistantMsg);
        saveChatHistory();
        renderMessage(assistantMsg);

        // Add to activity
        addActivity('chat', `Chat: ${message.substring(0, 30)}...`);
    } catch (error) {
        hideThinking();
        const errorMsg = { role: 'assistant', content: `Mi dispiace, I had trouble: ${error.message}. Let's try again, cara.`, timestamp: new Date().toISOString() };
        state.chatHistory.push(errorMsg);
        saveChatHistory();
        renderMessage(errorMsg);
    }

    state.isProcessing = false;
    document.getElementById('send-btn').disabled = false;
}

function askNonna(text) {
    navigateTo('chat');
    document.getElementById('chat-input').value = text;
    setTimeout(() => sendMessage(), 100);
}

async function callAPI(userMessage) {
    const profile = getStorage(STORAGE.PROFILE);
    const profileText = formatProfileForAPI(profile);
    const history = getStorage(STORAGE.HISTORY) || [];
    const recentMeals = history.slice(0, 5).map(h => `${h.title} (${formatRelativeDate(h.date)})`).join(', ');
    const recipeRatings = formatRecipeRatingsForAPI();
    const workoutData = formatWorkoutDataForAPI();
    const pantryData = formatPantryForAPI();
    const gardenData = formatGardenForAPI();

    const messages = state.chatHistory.slice(-10).map(m => ({
        role: m.role,
        content: m.content
    }));

    if (!messages.length || messages[messages.length - 1].content !== userMessage) {
        messages.push({ role: 'user', content: userMessage });
    }

    const response = await fetch('/.netlify/functions/chat', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ messages, profileText, flareMode: state.flareMode, recentMeals, recipeRatings, workoutData, pantryData, gardenData })
    });

    if (!response.ok) {
        const err = await response.json().catch(() => ({}));
        throw new Error(err.error || `API error: ${response.status}`);
    }

    const data = await response.json();
    return data.content;
}

function formatProfileForAPI(profile) {
    if (!profile) return 'No profile configured.';

    const conditions = profile.conditions || [];
    let text = 'HEALTH CONDITIONS:\n';

    // Digestive conditions
    if (conditions.includes('crohns')) {
        text += `- Crohn's Disease: ${profile.crohnsSeverity || 'severity not specified'}`;
        if (profile.crohnsTriggers) text += `. Triggers: ${profile.crohnsTriggers}`;
        text += '\n  â†’ Prioritize: low-fiber when flaring, well-cooked vegetables, lean proteins, bone broth\n  â†’ Avoid: raw vegetables, nuts, seeds, high-fiber foods during flares\n';
    }
    if (conditions.includes('uc')) {
        text += `- Ulcerative Colitis: ${profile.ucSeverity || 'severity not specified'}\n  â†’ Similar to Crohn's: low-fiber during flares, gentle foods\n`;
    }
    if (conditions.includes('ibs')) {
        text += `- IBS: ${profile.ibsType || 'type not specified'}\n  â†’ Consider low-FODMAP options, avoid trigger foods\n`;
    }
    if (conditions.includes('celiac')) {
        text += '- Celiac/Gluten Sensitivity: ALL recipes must be gluten-free\n';
    }
    if (conditions.includes('lactose')) {
        text += '- Lactose Intolerance: Avoid or limit dairy, suggest lactose-free alternatives\n';
    }
    if (conditions.includes('gerd')) {
        text += '- GERD/Acid Reflux: Avoid tomatoes, citrus, spicy foods, large meals. Smaller portions.\n';
    }

    // Cardiovascular conditions
    if (conditions.includes('highCholesterol')) {
        text += `- High Cholesterol: Goal is ${profile.cholesterolGoal || 'general improvement'}\n  â†’ Prioritize: olive oil, fish (omega-3), oats, nuts, legumes, vegetables\n  â†’ Limit: saturated fat, red meat, full-fat dairy\n`;
    }
    if (conditions.includes('highBP')) {
        text += `- High Blood Pressure: Sodium restriction ${profile.sodiumRestriction || 'moderate'}\n  â†’ Prioritize: DASH diet, potassium-rich foods, herbs instead of salt\n  â†’ Limit: salt, processed foods, canned goods (unless low-sodium)\n`;
    }
    if (conditions.includes('diabetes')) {
        text += `- Type 2 Diabetes: Carb management ${profile.carbManagement || 'moderate'}\n  â†’ Prioritize: complex carbs, high fiber, protein, healthy fats, low-glycemic foods\n  â†’ Always include carb counts in recipes, note glycemic impact\n`;
    }
    if (conditions.includes('heartDisease')) {
        text += '- Heart Disease: Heart-healthy focus, limit sodium and saturated fat\n';
    }
    if (conditions.includes('kidney')) {
        const kidneyRestrictions = profile.kidneyRestrictions?.join(', ') || 'general';
        text += `- Kidney Disease: Restrictions: ${kidneyRestrictions}\n  â†’ May need to limit: protein, sodium, potassium, phosphorus based on stage\n`;
    }

    // Autoimmune conditions
    if (conditions.includes('fibromyalgia')) {
        text += `- Fibromyalgia: Energy level ${profile.fibroEnergy || 'variable'}\n  â†’ Suggest easy, low-effort recipes on low-energy days. Anti-inflammatory focus.\n`;
    }
    if (conditions.includes('rheumatoid') || conditions.includes('lupus') || conditions.includes('psoriatic') || conditions.includes('ms')) {
        const autoimmune = [];
        if (conditions.includes('rheumatoid')) autoimmune.push('Rheumatoid Arthritis');
        if (conditions.includes('lupus')) autoimmune.push('Lupus');
        if (conditions.includes('psoriatic')) autoimmune.push('Psoriatic Arthritis');
        if (conditions.includes('ms')) autoimmune.push('MS');
        text += `- Autoimmune (${autoimmune.join(', ')}): Anti-inflammatory diet essential\n  â†’ Prioritize: omega-3 rich fish, colorful vegetables, turmeric, ginger, olive oil\n  â†’ Limit: processed foods, refined sugars, potential inflammatory triggers\n`;
    }
    if (conditions.includes('hashimotos')) {
        text += `- Hashimoto's/Thyroid: ${profile.thyroidType || 'thyroid condition'}\n  â†’ Consider: selenium-rich foods, limit goitrogens if indicated\n`;
    }

    // Food allergies
    if (profile.foodAllergies) {
        text += `\nFOOD ALLERGIES (CRITICAL - NEVER include these): ${profile.foodAllergies}\n`;
    }

    // Dietary goals
    if (profile.dietaryGoals?.length > 0) {
        const goalDescriptions = {
            'weightLoss': 'Weight Loss (calorie-conscious, high protein)',
            'weightGain': 'Weight Gain/Muscle Building (calorie-dense, high protein)',
            'antiInflammatory': 'Anti-Inflammatory Focus',
            'heartHealthy': 'Heart-Healthy (Mediterranean)',
            'bloodSugar': 'Blood Sugar Management',
            'gutHealth': 'Gut Health Restoration',
            'energy': 'Increased Energy'
        };
        text += `\nDIETARY GOALS: ${profile.dietaryGoals.map(g => goalDescriptions[g] || g).join(', ')}\n`;
    }

    // Other notes
    if (profile.otherConditions) {
        text += `\nOTHER NOTES: ${profile.otherConditions}\n`;
    }

    // Standard profile info
    text += `
PROTEINS EATEN: ${profile.proteins?.join(', ') || 'Not specified'}
FOODS TO AVOID: ${profile.foodsToAvoid || 'None specified'}
FAVORITE FLAVORS: ${profile.favoriteFlavors || 'Not specified'}

GARDEN: ${profile.currentlyGrowing || 'Nothing growing'}
Zone: ${profile.growingZone || 'Not specified'}, Season: ${profile.currentSeason || 'Not specified'}

COOKING PREFERENCES:
- Energy Level: ${profile.energyLevel || 'Not specified'}
- Time Available: ${profile.cookingTime || 'Not specified'}
- Budget: $${profile.weeklyBudget || 'Not specified'}/week
- Shopping Priority: ${profile.shoppingPriority || 'Not specified'}`;

    if (profile.cookingForTwo) {
        text += `

COOKING FOR TWO:
Partner: ${profile.partnerName || 'Partner'}
Their Restrictions: ${profile.partnerRestrictions?.join(', ') || 'None'}
Their Allergies: ${profile.partnerAllergies || 'None'}
Foods They Love: ${profile.partnerLoves || 'Not specified'}`;
    }

    return text.trim();
}

function formatRecipeRatingsForAPI() {
    const library = getRecipeLibrary();
    if (!library || library.length === 0) return 'No recipes saved yet.';

    // Get favorites and highly rated recipes
    const favorites = library.filter(r => r.favorited);
    const highRated = library.filter(r => (r.averageRating || r.rating || 0) >= 4);
    const lowRated = library.filter(r => (r.averageRating || r.rating || 0) > 0 && (r.averageRating || r.rating || 0) <= 2);
    const mostCooked = library.filter(r => (r.timesCooked || 0) >= 3).sort((a, b) => b.timesCooked - a.timesCooked);

    let text = '';

    if (favorites.length > 0) {
        text += `FAVORITES (${favorites.length}): ${favorites.slice(0, 5).map(r => r.title).join(', ')}`;
        if (favorites.length > 5) text += `, and ${favorites.length - 5} more`;
        text += '\n';
    }

    if (highRated.length > 0) {
        text += `HIGHLY RATED (4-5 stars): ${highRated.slice(0, 5).map(r => `${r.title} (${r.averageRating || r.rating}â˜…)`).join(', ')}\n`;
    }

    if (mostCooked.length > 0) {
        text += `FREQUENTLY COOKED: ${mostCooked.slice(0, 3).map(r => `${r.title} (${r.timesCooked}x)`).join(', ')}\n`;
    }

    if (lowRated.length > 0) {
        text += `LOWER RATED (avoid suggesting unless asked): ${lowRated.map(r => r.title).join(', ')}\n`;
    }

    return text || 'No recipes rated yet.';
}

function formatPantryForAPI() {
    const pantry = getStorage(STORAGE.PANTRY) || [];
    if (!pantry || pantry.length === 0) return 'Pantry is empty - no ingredients tracked.';

    // Group by category
    const categories = {};
    pantry.forEach(item => {
        const cat = item.category || 'Other';
        if (!categories[cat]) categories[cat] = [];
        categories[cat].push(item);
    });

    let text = 'Available ingredients:\n';

    // Sort categories for consistent output
    const catOrder = ['Proteins', 'Produce', 'Dairy', 'Grains', 'Pantry Staples', 'Frozen', 'Other'];
    catOrder.forEach(cat => {
        if (categories[cat] && categories[cat].length > 0) {
            text += `**${cat}:** `;
            text += categories[cat].map(item => {
                let itemText = item.name;
                if (item.quantity) itemText += ` (${item.quantity})`;
                if (item.expirationConcern) itemText += ' âš ï¸USE SOON';
                return itemText;
            }).join(', ');
            text += '\n';
        }
    });

    // Check for items expiring soon
    const expiringItems = pantry.filter(i => i.expirationConcern);
    if (expiringItems.length > 0) {
        text += `\nâš ï¸ USE SOON: ${expiringItems.map(i => i.name).join(', ')}`;
    }

    return text;
}

function formatGardenForAPI() {
    const profile = getStorage(STORAGE.PROFILE);
    const garden = getStorage(STORAGE.GARDEN) || [];

    let text = '';

    // Check profile for currently growing
    if (profile?.currentlyGrowing) {
        const growing = profile.currentlyGrowing.split(',').map(s => s.trim()).filter(s => s);
        if (growing.length > 0) {
            text += `Currently growing: ${growing.join(', ')}\n`;
        }
    }

    // Check garden data for ready to harvest
    const readyToHarvest = garden.filter(g => g.status === 'ready' || g.readyToHarvest);
    if (readyToHarvest.length > 0) {
        text += `ðŸŒ± READY TO HARVEST: ${readyToHarvest.map(g => g.name).join(', ')}\n`;
        text += '(Prioritize these fresh ingredients in recipes!)';
    }

    return text || 'No garden data available.';
}

// ========================================
// VOICE INPUT
// ========================================
function initVoiceRecognition() {
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    if (SpeechRecognition) {
        state.recognition = new SpeechRecognition();
        state.recognition.continuous = false;
        state.recognition.interimResults = false;
        state.recognition.lang = 'en-US';

        state.recognition.onresult = (event) => {
            const text = event.results[0][0].transcript;
            document.getElementById('chat-input').value = text;
            stopRecording();
        };
        state.recognition.onerror = () => stopRecording();
        state.recognition.onend = () => stopRecording();
    } else {
        const btn = document.getElementById('voice-btn');
        if (btn) btn.style.display = 'none';
    }
}

function toggleVoiceInput() {
    if (state.isRecording) stopRecording();
    else startRecording();
}

function startRecording() {
    if (!state.recognition) return;
    state.isRecording = true;
    document.getElementById('voice-btn').classList.add('recording');
    state.recognition.start();
}

function stopRecording() {
    state.isRecording = false;
    const btn = document.getElementById('voice-btn');
    if (btn) btn.classList.remove('recording');
    if (state.recognition) {
        try { state.recognition.stop(); } catch (e) {}
    }
}

// ========================================
// RECIPE LIBRARY
// ========================================
function saveRecipeToLibrary(recipe) {
    const library = getStorage(STORAGE.RECIPES) || [];

    // Check for exact ID match first
    const existingById = library.findIndex(r => r.id === recipe.id);
    if (existingById >= 0) {
        library[existingById] = { ...library[existingById], ...recipe };
        setStorage(STORAGE.RECIPES, library);
        return { updated: true, id: recipe.id };
    }

    // Check for duplicate by normalized title (fuzzy matching)
    const normalizedTitle = normalizeRecipeTitle(recipe.title);
    const duplicateIdx = library.findIndex(r => normalizeRecipeTitle(r.title) === normalizedTitle);

    if (duplicateIdx >= 0) {
        // Update existing recipe instead of creating duplicate
        const existingRecipe = library[duplicateIdx];
        library[duplicateIdx] = {
            ...existingRecipe,
            ...recipe,
            id: existingRecipe.id, // Keep original ID
            timesCooked: existingRecipe.timesCooked || 0,
            rating: existingRecipe.rating || recipe.rating || 0,
            averageRating: existingRecipe.averageRating || 0,
            cookingHistory: existingRecipe.cookingHistory || [],
            favorited: existingRecipe.favorited || recipe.favorited,
            dateGenerated: existingRecipe.dateGenerated // Keep original date
        };
        setStorage(STORAGE.RECIPES, library);
        return { updated: true, id: existingRecipe.id };
    }

    // No duplicate found, add as new
    library.unshift(recipe);
    setStorage(STORAGE.RECIPES, library);
    return { updated: false, id: recipe.id };
}

function normalizeRecipeTitle(title) {
    if (!title) return '';
    // Remove common suffixes like (COMPLETE), (UPDATED), (FINAL), (PERFECT VERSION), etc.
    return title
        .replace(/\s*\((?:COMPLETE|UPDATED|FINAL|PERFECT|NEW|REVISED|V\d+|VERSION\s*\d*)\)\s*$/i, '')
        .replace(/\s*-\s*(?:COMPLETE|UPDATED|FINAL|PERFECT|NEW|REVISED)$/i, '')
        .replace(/\s+/g, ' ')
        .trim()
        .toLowerCase();
}

// Save recipe explicitly from chat (when user clicks Save button)
function saveRecipeFromChat(recipeId) {
    const pendingRecipe = window.pendingRecipes?.[recipeId];
    if (!pendingRecipe) {
        showToast('Recipe not found');
        return;
    }

    const result = saveRecipeToLibrary(pendingRecipe);

    // Update button to show saved state
    const saveBtn = document.getElementById(`save-btn-${recipeId}`);
    if (saveBtn) {
        saveBtn.textContent = 'âœ… Saved!';
        saveBtn.disabled = true;
        saveBtn.classList.remove('btn-primary');
        saveBtn.classList.add('btn-ghost');
    }

    if (result.updated) {
        showToast('Recipe updated in library!');
    } else {
        showToast('Recipe saved to library!');
    }
}

// Favorite recipe from chat (saves and favorites)
function favoriteRecipeFromChat(recipeId) {
    const pendingRecipe = window.pendingRecipes?.[recipeId];
    if (!pendingRecipe) {
        // Maybe already saved, try to favorite existing
        toggleFavoriteFromCard(recipeId, null);
        return;
    }

    pendingRecipe.favorited = true;
    saveRecipeToLibrary(pendingRecipe);

    // Update save button
    const saveBtn = document.getElementById(`save-btn-${recipeId}`);
    if (saveBtn) {
        saveBtn.textContent = 'âœ… Saved!';
        saveBtn.disabled = true;
        saveBtn.classList.remove('btn-primary');
        saveBtn.classList.add('btn-ghost');
    }

    showToast('â¤ï¸ Recipe favorited and saved!');
}

// Add to week from chat (saves and opens week modal)
function addToWeekFromChat(recipeId) {
    const pendingRecipe = window.pendingRecipes?.[recipeId];
    if (pendingRecipe) {
        saveRecipeToLibrary(pendingRecipe);

        // Update save button
        const saveBtn = document.getElementById(`save-btn-${recipeId}`);
        if (saveBtn) {
            saveBtn.textContent = 'âœ… Saved!';
            saveBtn.disabled = true;
            saveBtn.classList.remove('btn-primary');
            saveBtn.classList.add('btn-ghost');
        }
    }

    openAddToWeekModal(recipeId);
}

function getRecipeLibrary() {
    return getStorage(STORAGE.RECIPES) || [];
}

function renderRecipeLibrary() {
    const library = getRecipeLibrary();
    const grid = document.getElementById('recipes-grid');
    const empty = document.getElementById('recipes-empty');

    // Populate tag filter chips
    populateTagFilterChips();

    if (library.length === 0) {
        grid.innerHTML = '';
        empty.classList.remove('hidden');
        return;
    }

    empty.classList.add('hidden');
    filterRecipeLibrary(); // Use filter function to respect any active filters
}

function renderLibraryCard(recipe) {
    const meta = recipe.metadata || {};
    const avgRating = recipe.averageRating || recipe.rating || 0;
    const timesCooked = recipe.timesCooked || 0;
    const nutrition = recipe.nutrition || {};

    // Generate star display
    const starDisplay = avgRating > 0 ? renderStarsDisplay(avgRating) : '';
    const cookedText = timesCooked > 0 ? `Cooked ${timesCooked}x` : '';

    // Get tags and apply styling
    const tags = meta.tags || [];
    const tagsHtml = tags.slice(0, 4).map(tag => {
        const tagClass = getTagClass(tag);
        return `<span class="tag ${tagClass}">${tag}</span>`;
    }).join('');

    // Nutrition display
    const caloriesHtml = nutrition.calories ? `<span class="card-calories">ðŸ”¥ ${nutrition.calories} cal</span>` : '';
    const macrosHtml = (nutrition.protein || nutrition.carbs || nutrition.fat) ?
        `<div class="card-macros">${nutrition.protein ? nutrition.protein + 'g protein' : ''}${nutrition.carbs ? ' Â· ' + nutrition.carbs + 'g carbs' : ''}${nutrition.fat ? ' Â· ' + nutrition.fat + 'g fat' : ''}</div>` : '';

    const isEditMode = state.recipeEditMode;
    const isSelected = state.selectedRecipes?.has(recipe.id);
    const editModeClass = isEditMode ? 'edit-mode' : '';
    const selectedClass = isSelected ? 'selected' : '';
    const clickHandler = isEditMode ? `toggleRecipeSelection('${recipe.id}')` : `viewRecipeDetail('${recipe.id}')`;

    return `
        <div class="library-card ${editModeClass} ${selectedClass}" onclick="${clickHandler}" data-recipe-id="${recipe.id}">
            <div class="library-card-banner">
                ðŸ½ï¸
                ${recipe.favorited ? '<span class="library-card-favorite">â¤ï¸</span>' : ''}
                ${caloriesHtml}
            </div>
            <div class="library-card-body">
                <div class="library-card-title">${recipe.title}</div>
                ${starDisplay ? `<div class="library-card-rating">${starDisplay}</div>` : ''}
                <div class="library-card-meta">
                    <span>â±ï¸ ${meta.totalTime || 30}min</span>
                    <span>ðŸ½ï¸ ${meta.serves || 2}</span>
                    ${cookedText ? `<span>ðŸ‘¨â€ðŸ³ ${cookedText}</span>` : ''}
                </div>
                ${macrosHtml}
                <div class="library-card-tags">
                    ${tagsHtml || '<span class="tag tag-mediterranean">Mediterranean</span>'}
                </div>
            </div>
        </div>
    `;
}

function renderStarsDisplay(rating) {
    const fullStars = Math.floor(rating);
    const hasHalf = rating % 1 >= 0.5;
    const emptyStars = 5 - fullStars - (hasHalf ? 1 : 0);

    let stars = 'â˜…'.repeat(fullStars);
    if (hasHalf) stars += 'Â½';
    stars += 'â˜†'.repeat(emptyStars);

    return `${stars} (${rating.toFixed(1)})`;
}

function filterRecipeLibrary() {
    const search = document.getElementById('recipes-search').value.toLowerCase();
    const sort = document.getElementById('recipes-sort').value;
    const protein = document.getElementById('recipes-protein').value;
    const time = document.getElementById('recipes-time').value;

    let library = getRecipeLibrary();

    // Filter by search
    if (search) {
        library = library.filter(r => r.title.toLowerCase().includes(search) ||
            r.ingredients?.some(i => i.toLowerCase().includes(search)));
    }

    // Filter by protein
    if (protein) {
        library = library.filter(r => r.metadata?.proteinType === protein);
    }

    // Filter by time
    if (time) {
        library = library.filter(r => {
            const t = r.metadata?.totalTime || 30;
            if (time === 'quick') return t < 30;
            if (time === 'standard') return t >= 30 && t <= 60;
            if (time === 'long') return t > 60;
            return true;
        });
    }

    // Filter by tags
    if (state.selectedTagFilters.size > 0) {
        library = library.filter(r => {
            const recipeTags = r.metadata?.tags || [];
            // Recipe must have ALL selected tags
            return Array.from(state.selectedTagFilters).every(tag =>
                recipeTags.some(t => t.toLowerCase() === tag.toLowerCase())
            );
        });
    }

    // Sort
    if (sort === 'rating') {
        // Use averageRating first, then single rating for backwards compatibility
        library.sort((a, b) => (b.averageRating || b.rating || 0) - (a.averageRating || a.rating || 0));
    } else if (sort === 'cooked') {
        library.sort((a, b) => (b.timesCooked || 0) - (a.timesCooked || 0));
    } else if (sort === 'time') {
        library.sort((a, b) => (a.metadata?.totalTime || 30) - (b.metadata?.totalTime || 30));
    } else if (sort === 'name') {
        library.sort((a, b) => a.title.localeCompare(b.title));
    } else {
        library.sort((a, b) => new Date(b.dateGenerated) - new Date(a.dateGenerated));
    }

    const grid = document.getElementById('recipes-grid');
    grid.innerHTML = library.map(recipe => renderLibraryCard(recipe)).join('');

    const empty = document.getElementById('recipes-empty');
    empty.classList.toggle('hidden', library.length > 0);
}

function populateTagFilterChips() {
    const library = getRecipeLibrary();
    const allTags = new Map(); // tag -> count

    // Collect all tags from all recipes
    library.forEach(recipe => {
        const tags = recipe.metadata?.tags || [];
        tags.forEach(tag => {
            allTags.set(tag, (allTags.get(tag) || 0) + 1);
        });
    });

    // Sort by frequency, then alphabetically
    const sortedTags = Array.from(allTags.entries())
        .sort((a, b) => b[1] - a[1] || a[0].localeCompare(b[0]))
        .slice(0, 15); // Limit to 15 most common tags

    const container = document.getElementById('tag-filter-chips');
    if (!container) return;

    container.innerHTML = sortedTags.map(([tag, count]) => {
        const isActive = state.selectedTagFilters.has(tag);
        return `<span class="tag-filter-chip ${isActive ? 'active' : ''}" onclick="toggleTagFilter('${tag}')">${tag} (${count})</span>`;
    }).join('');

    // Show/hide clear button
    const clearBtn = document.getElementById('tag-filter-clear');
    if (clearBtn) {
        clearBtn.classList.toggle('visible', state.selectedTagFilters.size > 0);
    }
}

function toggleTagFilter(tag) {
    if (state.selectedTagFilters.has(tag)) {
        state.selectedTagFilters.delete(tag);
    } else {
        state.selectedTagFilters.add(tag);
    }
    populateTagFilterChips();
    filterRecipeLibrary();
}

function clearTagFilters() {
    state.selectedTagFilters.clear();
    populateTagFilterChips();
    filterRecipeLibrary();
}

function toggleFilterDropdown() {
    document.getElementById('recipe-filters').classList.toggle('open');
}

// ========================================
// BULK RECIPE MANAGEMENT
// ========================================
function toggleRecipeEditMode() {
    state.recipeEditMode = !state.recipeEditMode;
    state.selectedRecipes = new Set();

    const editBtn = document.getElementById('recipes-edit-btn');
    const bulkBar = document.getElementById('recipes-bulk-bar');

    if (state.recipeEditMode) {
        editBtn.textContent = 'Done';
        editBtn.classList.add('btn-primary');
        editBtn.classList.remove('btn-ghost');
        bulkBar.classList.remove('hidden');
    } else {
        editBtn.textContent = 'Edit';
        editBtn.classList.remove('btn-primary');
        editBtn.classList.add('btn-ghost');
        bulkBar.classList.add('hidden');
    }

    filterRecipeLibrary(); // Re-render cards with edit mode
    updateBulkCount();
}

function toggleRecipeSelection(recipeId) {
    if (state.selectedRecipes.has(recipeId)) {
        state.selectedRecipes.delete(recipeId);
    } else {
        state.selectedRecipes.add(recipeId);
    }

    // Update card visual
    const card = document.querySelector(`.library-card[data-recipe-id="${recipeId}"]`);
    if (card) {
        card.classList.toggle('selected', state.selectedRecipes.has(recipeId));
    }

    updateBulkCount();
}

function updateBulkCount() {
    const countEl = document.getElementById('bulk-selected-count');
    if (countEl) {
        countEl.textContent = state.selectedRecipes.size;
    }
}

function bulkSelectAll() {
    const library = getRecipeLibrary();
    library.forEach(r => state.selectedRecipes.add(r.id));
    filterRecipeLibrary();
    updateBulkCount();
}

function bulkDeselectAll() {
    state.selectedRecipes.clear();
    filterRecipeLibrary();
    updateBulkCount();
}

function bulkAddToFavorites() {
    if (state.selectedRecipes.size === 0) {
        showToast('No recipes selected');
        return;
    }

    const library = getRecipeLibrary();
    let count = 0;
    state.selectedRecipes.forEach(id => {
        const recipe = library.find(r => r.id === id);
        if (recipe && !recipe.favorited) {
            recipe.favorited = true;
            count++;
        }
    });

    setStorage(STORAGE.RECIPES, library);
    filterRecipeLibrary();
    renderFavorites();
    showToast(`â¤ï¸ ${count} recipe${count !== 1 ? 's' : ''} added to favorites`);
}

function bulkRemoveFromFavorites() {
    if (state.selectedRecipes.size === 0) {
        showToast('No recipes selected');
        return;
    }

    const library = getRecipeLibrary();
    let count = 0;
    state.selectedRecipes.forEach(id => {
        const recipe = library.find(r => r.id === id);
        if (recipe && recipe.favorited) {
            recipe.favorited = false;
            count++;
        }
    });

    setStorage(STORAGE.RECIPES, library);
    filterRecipeLibrary();
    renderFavorites();
    showToast(`${count} recipe${count !== 1 ? 's' : ''} removed from favorites`);
}

function bulkDeleteRecipes() {
    if (state.selectedRecipes.size === 0) {
        showToast('No recipes selected');
        return;
    }

    const count = state.selectedRecipes.size;

    // Check if any are planned
    const mealPlans = getStorage(STORAGE.MEAL_PLANS) || {};
    const weekDates = getWeekDates(state.currentWeekOffset);
    const plannedIds = new Set(weekDates.map(d => mealPlans[d]?.recipeId).filter(Boolean));

    const plannedSelection = [...state.selectedRecipes].filter(id => plannedIds.has(id));

    if (plannedSelection.length > 0) {
        openModal(`
            <div class="modal-header">
                <h2 class="modal-title">Cannot Delete All</h2>
                <button class="modal-close" onclick="closeModal()">Ã—</button>
            </div>
            <div class="modal-body">
                <p>${plannedSelection.length} of the selected recipes are planned for this week. Remove them from your meal plan first.</p>
            </div>
            <div class="modal-footer">
                <button class="btn btn-primary" onclick="closeModal()">OK</button>
            </div>
        `);
        return;
    }

    openModal(`
        <div class="modal-header">
            <h2 class="modal-title">Delete ${count} Recipe${count !== 1 ? 's' : ''}?</h2>
            <button class="modal-close" onclick="closeModal()">Ã—</button>
        </div>
        <div class="modal-body">
            <p>This will permanently delete <strong>${count} recipe${count !== 1 ? 's' : ''}</strong> from your library.</p>
            <p class="text-muted mt-8">This action cannot be undone. All ratings and cooking history will be lost.</p>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
            <button class="btn btn-primary" style="background: var(--danger);" onclick="confirmBulkDelete()">Delete ${count} Recipe${count !== 1 ? 's' : ''}</button>
        </div>
    `);
}

function confirmBulkDelete() {
    let library = getRecipeLibrary();
    const deletedCount = state.selectedRecipes.size;

    // Store for potential undo
    const deletedRecipes = library.filter(r => state.selectedRecipes.has(r.id));

    library = library.filter(r => !state.selectedRecipes.has(r.id));
    setStorage(STORAGE.RECIPES, library);

    state.selectedRecipes.clear();
    closeModal();
    filterRecipeLibrary();
    renderFavorites();
    updateBulkCount();

    showToast(`ðŸ—‘ï¸ ${deletedCount} recipe${deletedCount !== 1 ? 's' : ''} deleted`);
}

function viewRecipeDetail(recipeId) {
    const library = getRecipeLibrary();
    const recipe = library.find(r => r.id === recipeId);
    if (!recipe) return;

    openModal(`
        <div class="modal-header">
            <h2 class="modal-title">${recipe.title}</h2>
            <button class="modal-close" onclick="closeModal()">Ã—</button>
        </div>
        <div class="modal-body" style="padding: 0;">
            ${recipe.rawContent ? parseRecipeToCard(recipe.rawContent) : `
                <div class="recipe-card">
                    <div class="recipe-header">
                        <div class="recipe-title">${recipe.title}</div>
                    </div>
                    <div class="recipe-body">
                        <p>Recipe details not available.</p>
                    </div>
                </div>
            `}
        </div>
    `);
}

// ========================================
// FAVORITES
// ========================================
function getFavorites() {
    const library = getRecipeLibrary();
    return library.filter(r => r.favorited);
}

function toggleFavoriteFromCard(recipeId, btn) {
    const library = getRecipeLibrary();
    const recipe = library.find(r => r.id === recipeId);
    if (!recipe) return;

    recipe.favorited = !recipe.favorited;
    setStorage(STORAGE.RECIPES, library);

    if (btn) btn.classList.toggle('favorited', recipe.favorited);

    showToast(recipe.favorited ? 'â¤ï¸ Added to favorites!' : 'Removed from favorites');
}

function renderFavorites() {
    const favorites = getFavorites();
    const grid = document.getElementById('favorites-grid');
    const empty = document.getElementById('favorites-empty');

    if (favorites.length === 0) {
        grid.innerHTML = '';
        empty.classList.remove('hidden');
        return;
    }

    empty.classList.add('hidden');
    grid.innerHTML = favorites.map(recipe => renderLibraryCard(recipe)).join('');
}

function filterFavorites() {
    const search = document.getElementById('favorites-search').value.toLowerCase();
    let favorites = getFavorites();
    if (search) {
        favorites = favorites.filter(f => f.title.toLowerCase().includes(search));
    }
    const grid = document.getElementById('favorites-grid');
    grid.innerHTML = favorites.map(recipe => renderLibraryCard(recipe)).join('');
}

function sortFavorites() {
    renderFavorites();
}

// ========================================
// WEEK PLANNER - DATE BUG FIX
// ========================================
function getWeekDates(offset = 0) {
    const dates = [];
    const today = new Date();

    // Get Monday of current week - FIX: Use local date properly
    const dayOfWeek = today.getDay();
    const mondayOffset = dayOfWeek === 0 ? -6 : 1 - dayOfWeek; // Sunday is 0

    const monday = new Date(today);
    monday.setDate(today.getDate() + mondayOffset + (offset * 7));

    for (let i = 0; i < 7; i++) {
        const date = new Date(monday);
        date.setDate(monday.getDate() + i);
        // FIX: Format date in local timezone, not UTC
        const year = date.getFullYear();
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const day = String(date.getDate()).padStart(2, '0');
        dates.push(`${year}-${month}-${day}`);
    }
    return dates;
}

function getWeekTitle(offset = 0) {
    const dates = getWeekDates(offset);
    const start = new Date(dates[0] + 'T12:00:00'); // Add noon to avoid timezone issues
    const end = new Date(dates[6] + 'T12:00:00');

    const options = { month: 'short', day: 'numeric' };
    const startStr = start.toLocaleDateString('en-US', options);
    const endStr = end.toLocaleDateString('en-US', { ...options, year: 'numeric' });

    if (offset === 0) return `This Week (${startStr} - ${endStr})`;
    if (offset === -1) return `Last Week (${startStr} - ${endStr})`;
    if (offset === 1) return `Next Week (${startStr} - ${endStr})`;
    return `${startStr} - ${endStr}`;
}

function changeWeek(direction) {
    state.currentWeekOffset += direction;
    renderWeekPlanner();
}

function renderWeekPlanner() {
    const container = document.getElementById('week-planner');
    const empty = document.getElementById('week-empty');
    const days = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'];
    const mealPlans = getStorage(STORAGE.MEAL_PLANS) || {};
    const workouts = getStorage(STORAGE.WORKOUTS) || [];
    const weekDates = getWeekDates(state.currentWeekOffset);

    // Update title
    document.getElementById('week-title').textContent = getWeekTitle(state.currentWeekOffset);

    const mealTypes = [
        { key: 'breakfast', icon: 'ðŸŒ…', label: 'Breakfast' },
        { key: 'lunch', icon: 'ðŸŒž', label: 'Lunch' },
        { key: 'dinner', icon: 'ðŸŒ™', label: 'Dinner' },
        { key: 'snacks', icon: 'ðŸŽ', label: 'Snacks' }
    ];

    let hasAnyMeals = false;
    let html = '';

    days.forEach((day, i) => {
        const dateStr = weekDates[i];
        const dateObj = new Date(dateStr + 'T12:00:00');
        let dayMeals = mealPlans[dateStr] || {};

        // Support legacy single-meal format (migrate to dinner)
        // Legacy format has title directly on the object, not in a meal slot
        if (dayMeals.title && typeof dayMeals.title === 'string' && !dayMeals.dinner && !dayMeals.breakfast && !dayMeals.lunch) {
            // This is legacy format - migrate it
            const legacyTitle = dayMeals.title;
            const legacyCalories = dayMeals.calories;
            const legacyRecipeId = dayMeals.recipeId;
            const legacyStatus = dayMeals.status;

            // Create new format
            dayMeals = {
                dinner: {
                    title: legacyTitle,
                    calories: legacyCalories || null,
                    recipeId: legacyRecipeId || null,
                    status: legacyStatus || 'planned'
                }
            };

            // Save migrated data
            mealPlans[dateStr] = dayMeals;
            setStorage(STORAGE.MEAL_PLANS, mealPlans);
        }

        const dateDisplay = dateObj.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });

        // Calculate day totals - also try to get calories from linked recipes
        let dayCalories = 0;
        mealTypes.forEach(mt => {
            const meal = dayMeals[mt.key];
            if (meal?.title) {
                hasAnyMeals = true;
                // First try meal's stored calories
                if (meal.calories) {
                    dayCalories += parseInt(meal.calories) || 0;
                } else if (meal.recipeId) {
                    // Try to get calories from linked recipe
                    const library = getRecipeLibrary();
                    const recipe = library.find(r => r.id === meal.recipeId);
                    if (recipe?.nutrition?.calories) {
                        dayCalories += parseInt(recipe.nutrition.calories) || 0;
                    }
                }
            }
        });

        // Get workout calories for this day
        const dayWorkouts = workouts.filter(w => w.date === dateStr);
        const workoutCalories = dayWorkouts.reduce((sum, w) => sum + (w.caloriesBurned || 0), 0);
        const netCalories = dayCalories - workoutCalories;

        // Build meal slots
        let mealSlotsHtml = '';
        mealTypes.forEach(mt => {
            const meal = dayMeals[mt.key];
            if (meal?.title) {
                // Get calories from meal or linked recipe
                let displayCalories = meal.calories;
                if (!displayCalories && meal.recipeId) {
                    const library = getRecipeLibrary();
                    const recipe = library.find(r => r.id === meal.recipeId);
                    displayCalories = recipe?.nutrition?.calories;
                }

                mealSlotsHtml += `
                    <div class="week-meal-slot">
                        <span class="meal-slot-icon">${mt.icon}</span>
                        <span class="meal-slot-type">${mt.label}</span>
                        <div class="meal-slot-content">
                            <div class="meal-slot-title">${meal.title}</div>
                            ${displayCalories ? `<span class="meal-slot-calories">${displayCalories} cal</span>` : ''}
                        </div>
                        <div class="meal-slot-actions">
                            ${meal.recipeId ? `<button class="icon-btn" onclick="viewRecipeDetail('${meal.recipeId}')" title="View">ðŸ‘ï¸</button>` : ''}
                            <button class="icon-btn" onclick="openAddMealSlot('${dateStr}', '${mt.key}', '${day}')" title="Change">âœï¸</button>
                            <button class="icon-btn" onclick="removeMealSlot('${dateStr}', '${mt.key}')" title="Remove">ðŸ—‘ï¸</button>
                        </div>
                    </div>
                `;
            } else {
                mealSlotsHtml += `
                    <div class="week-meal-slot empty" onclick="openAddMealSlot('${dateStr}', '${mt.key}', '${day}')">
                        <span class="meal-slot-icon">${mt.icon}</span>
                        <span class="meal-slot-type">${mt.label}</span>
                        <span class="meal-slot-add">+ Add ${mt.label}</span>
                    </div>
                `;
            }
        });

        // Day summary with improved display
        const netClass = netCalories > 200 ? 'surplus' : netCalories < -200 ? 'deficit' : 'balanced';
        const netLabel = netCalories > 200 ? 'surplus' : netCalories < -200 ? 'deficit' : 'balanced';
        const summaryHtml = (dayCalories > 0 || workoutCalories > 0) ? `
            <div class="week-day-summary">
                <span class="day-total-calories">ðŸ”¥ ${dayCalories} cal in</span>
                ${workoutCalories > 0 ? `<span class="day-workout-info">ðŸ’ª ${workoutCalories} cal burned</span>` : ''}
                ${dayCalories > 0 || workoutCalories > 0 ? `<span class="day-net-calories ${netClass}">Net: ${netCalories} (${netLabel})</span>` : ''}
            </div>
        ` : '';

        html += `
            <div class="week-day">
                <div class="week-day-header">
                    <span class="week-day-name">${day}</span>
                    <span class="week-day-date">${dateDisplay}</span>
                </div>
                <div class="week-day-meals">
                    ${mealSlotsHtml}
                </div>
                ${summaryHtml}
            </div>
        `;
    });

    container.innerHTML = html;
    empty.classList.toggle('hidden', hasAnyMeals || state.currentWeekOffset !== 0);
}

function openAddMealSlot(dateStr, mealType, dayName) {
    const mealLabels = { breakfast: 'Breakfast', lunch: 'Lunch', dinner: 'Dinner', snacks: 'Snacks' };
    const label = mealLabels[mealType] || mealType;

    openModal(`
        <div class="modal-header">
            <h2 class="modal-title">Add ${label} for ${dayName}</h2>
            <button class="modal-close" onclick="closeModal()">Ã—</button>
        </div>
        <div class="modal-body">
            <div class="more-menu">
                <button class="more-menu-item" onclick="closeModal(); askNonnaForMealSlot('${dateStr}', '${mealType}', '${dayName}');">
                    <span class="icon">ðŸ¤–</span>
                    <div class="more-menu-item-content">
                        <div class="more-menu-item-title">Ask Nonna</div>
                        <div class="more-menu-item-desc">Get a ${label.toLowerCase()} suggestion</div>
                    </div>
                </button>
                <button class="more-menu-item" onclick="closeModal(); openChooseFromLibraryForSlot('${dateStr}', '${mealType}');">
                    <span class="icon">ðŸ“š</span>
                    <div class="more-menu-item-content">
                        <div class="more-menu-item-title">From Library</div>
                        <div class="more-menu-item-desc">Choose a saved recipe</div>
                    </div>
                </button>
                <button class="more-menu-item" onclick="closeModal(); openManualMealSlotEntry('${dateStr}', '${mealType}');">
                    <span class="icon">âœï¸</span>
                    <div class="more-menu-item-content">
                        <div class="more-menu-item-title">Quick Entry</div>
                        <div class="more-menu-item-desc">Type meal name & calories</div>
                    </div>
                </button>
            </div>
        </div>
    `);
}

function askNonnaForMealSlot(dateStr, mealType, dayName) {
    const mealLabels = { breakfast: 'breakfast', lunch: 'lunch', dinner: 'dinner', snacks: 'snack ideas' };
    navigateTo('chat');
    setTimeout(() => {
        const input = document.getElementById('chat-input');
        input.value = `Suggest a healthy ${mealLabels[mealType]} for ${dayName}. Check my pantry and use ingredients I have.`;
        sendMessage();
    }, 100);
}

function openChooseFromLibraryForSlot(dateStr, mealType) {
    const library = getRecipeLibrary();
    if (library.length === 0) {
        showToast('No recipes in library yet. Ask Nonna for suggestions!');
        return;
    }

    const recipeList = library.slice(0, 20).map(r => `
        <button class="more-menu-item" onclick="assignRecipeToSlot('${r.id}', '${dateStr}', '${mealType}')">
            <span class="icon">ðŸ½ï¸</span>
            <div class="more-menu-item-content">
                <div class="more-menu-item-title">${r.title}</div>
                <div class="more-menu-item-desc">${r.nutrition?.calories ? r.nutrition.calories + ' cal' : ''} ${r.metadata?.totalTime ? 'Â· ' + r.metadata.totalTime + 'min' : ''}</div>
            </div>
        </button>
    `).join('');

    openModal(`
        <div class="modal-header">
            <h2 class="modal-title">Choose Recipe</h2>
            <button class="modal-close" onclick="closeModal()">Ã—</button>
        </div>
        <div class="modal-body" style="max-height: 60vh; overflow-y: auto;">
            <div class="more-menu">
                ${recipeList}
            </div>
        </div>
    `);
}

function assignRecipeToSlot(recipeId, dateStr, mealType) {
    const library = getRecipeLibrary();
    const recipe = library.find(r => r.id === recipeId);
    if (!recipe) return;

    const mealPlans = getStorage(STORAGE.MEAL_PLANS) || {};
    if (!mealPlans[dateStr]) mealPlans[dateStr] = {};

    mealPlans[dateStr][mealType] = {
        title: recipe.title,
        recipeId: recipe.id,
        calories: recipe.nutrition?.calories || null,
        status: 'planned'
    };

    setStorage(STORAGE.MEAL_PLANS, mealPlans);
    closeModal();
    showToast(`Added ${recipe.title} to ${mealType}`);
    renderWeekPlanner();
}

function openManualMealSlotEntry(dateStr, mealType) {
    const mealLabels = { breakfast: 'Breakfast', lunch: 'Lunch', dinner: 'Dinner', snacks: 'Snacks' };
    openModal(`
        <div class="modal-header">
            <h2 class="modal-title">Add ${mealLabels[mealType]}</h2>
            <button class="modal-close" onclick="closeModal()">Ã—</button>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label>Meal Name</label>
                <input type="text" class="form-input" id="manual-meal-name" placeholder="e.g., Greek Yogurt with Berries">
            </div>
            <div class="form-group">
                <label>Calories (optional)</label>
                <input type="number" class="form-input" id="manual-meal-calories" placeholder="e.g., 350">
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
            <button class="btn btn-primary" onclick="saveManualMealSlot('${dateStr}', '${mealType}')">Add</button>
        </div>
    `);
    setTimeout(() => document.getElementById('manual-meal-name')?.focus(), 100);
}

function saveManualMealSlot(dateStr, mealType) {
    const title = document.getElementById('manual-meal-name')?.value.trim();
    const calories = document.getElementById('manual-meal-calories')?.value;

    if (!title) {
        showToast('Please enter a meal name');
        return;
    }

    const mealPlans = getStorage(STORAGE.MEAL_PLANS) || {};
    if (!mealPlans[dateStr]) mealPlans[dateStr] = {};

    mealPlans[dateStr][mealType] = {
        title: title,
        calories: calories ? parseInt(calories) : null,
        recipeId: null,
        status: 'planned'
    };

    setStorage(STORAGE.MEAL_PLANS, mealPlans);
    closeModal();
    showToast(`Added ${title}`);
    renderWeekPlanner();
}

function removeMealSlot(dateStr, mealType) {
    const mealPlans = getStorage(STORAGE.MEAL_PLANS) || {};
    if (mealPlans[dateStr] && mealPlans[dateStr][mealType]) {
        delete mealPlans[dateStr][mealType];
        // Clean up empty day
        if (Object.keys(mealPlans[dateStr]).length === 0) {
            delete mealPlans[dateStr];
        }
        setStorage(STORAGE.MEAL_PLANS, mealPlans);
        renderWeekPlanner();
        showToast('Meal removed');
    }
}

function openAddMealForDay(dateStr, dayName) {
    openModal(`
        <div class="modal-header">
            <h2 class="modal-title">Add Meal for ${dayName}</h2>
            <button class="modal-close" onclick="closeModal()">Ã—</button>
        </div>
        <div class="modal-body">
            <div class="more-menu">
                <button class="more-menu-item" onclick="closeModal(); askNonna('Suggest a meal for ${dayName}');">
                    <span class="icon">ðŸ¤–</span>
                    <div class="more-menu-item-content">
                        <div class="more-menu-item-title">Ask Nonna</div>
                        <div class="more-menu-item-desc">Get a suggestion</div>
                    </div>
                </button>
                <button class="more-menu-item" onclick="closeModal(); openChooseFromFavorites('${dateStr}');">
                    <span class="icon">â¤ï¸</span>
                    <div class="more-menu-item-content">
                        <div class="more-menu-item-title">From Favorites</div>
                        <div class="more-menu-item-desc">Choose a saved recipe</div>
                    </div>
                </button>
                <button class="more-menu-item" onclick="closeModal(); openChooseFromLibrary('${dateStr}');">
                    <span class="icon">ðŸ“š</span>
                    <div class="more-menu-item-content">
                        <div class="more-menu-item-title">From Library</div>
                        <div class="more-menu-item-desc">Browse all recipes</div>
                    </div>
                </button>
                <button class="more-menu-item" onclick="closeModal(); openManualMealEntry('${dateStr}');">
                    <span class="icon">âœï¸</span>
                    <div class="more-menu-item-content">
                        <div class="more-menu-item-title">Manual Entry</div>
                        <div class="more-menu-item-desc">Type a meal name</div>
                    </div>
                </button>
            </div>
        </div>
    `);
}

function openManualMealEntry(dateStr) {
    openModal(`
        <div class="modal-header">
            <h2 class="modal-title">Add Meal</h2>
            <button class="modal-close" onclick="closeModal()">Ã—</button>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label>Meal Name</label>
                <input type="text" class="form-input" id="manual-meal-input" placeholder="e.g., Grilled Salmon">
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
            <button class="btn btn-primary" onclick="saveManualMeal('${dateStr}')">Add</button>
        </div>
    `);
    setTimeout(() => document.getElementById('manual-meal-input').focus(), 100);
}

function saveManualMeal(dateStr) {
    const input = document.getElementById('manual-meal-input');
    const title = input.value.trim();
    if (!title) return;

    const mealPlans = getStorage(STORAGE.MEAL_PLANS) || {};
    mealPlans[dateStr] = { title, recipeId: null, status: 'planned' };
    setStorage(STORAGE.MEAL_PLANS, mealPlans);
    closeModal();
    renderWeekPlanner();
    showToast('âœ… Meal added!');
}

function openChooseFromLibrary(dateStr) {
    const library = getRecipeLibrary();
    if (library.length === 0) {
        showToast('No recipes in library. Chat with Nonna first!');
        return;
    }

    openModal(`
        <div class="modal-header">
            <h2 class="modal-title">Choose Recipe</h2>
            <button class="modal-close" onclick="closeModal()">Ã—</button>
        </div>
        <div class="modal-body" style="max-height: 60vh; overflow-y: auto;">
            ${library.map(r => `
                <div class="more-menu-item" style="margin-bottom: 8px;" onclick="addRecipeToDay('${dateStr}', '${r.id}')">
                    <span class="icon">ðŸ½ï¸</span>
                    <div class="more-menu-item-content">
                        <div class="more-menu-item-title">${r.title}</div>
                        <div class="more-menu-item-desc">${r.metadata?.totalTime || 30} min</div>
                    </div>
                </div>
            `).join('')}
        </div>
    `);
}

function openChooseFromFavorites(dateStr) {
    const favorites = getFavorites();
    if (favorites.length === 0) {
        showToast('No favorites yet. Heart some recipes first!');
        return;
    }
    openModal(`
        <div class="modal-header">
            <h2 class="modal-title">Choose Favorite</h2>
            <button class="modal-close" onclick="closeModal()">Ã—</button>
        </div>
        <div class="modal-body" style="max-height: 60vh; overflow-y: auto;">
            ${favorites.map(r => `
                <div class="more-menu-item" style="margin-bottom: 8px;" onclick="addRecipeToDay('${dateStr}', '${r.id}')">
                    <span class="icon">â¤ï¸</span>
                    <div class="more-menu-item-content">
                        <div class="more-menu-item-title">${r.title}</div>
                    </div>
                </div>
            `).join('')}
        </div>
    `);
}

function addRecipeToDay(dateStr, recipeId) {
    const library = getRecipeLibrary();
    const recipe = library.find(r => r.id === recipeId);
    if (!recipe) return;

    const mealPlans = getStorage(STORAGE.MEAL_PLANS) || {};
    mealPlans[dateStr] = { title: recipe.title, recipeId: recipeId, status: 'planned' };
    setStorage(STORAGE.MEAL_PLANS, mealPlans);
    closeModal();
    renderWeekPlanner();
    showToast('âœ… Added to plan!');
}

function openAddToWeekModal(recipeId) {
    const library = getRecipeLibrary();
    const recipe = library.find(r => r.id === recipeId);
    if (!recipe) return;

    const weekDates = getWeekDates(state.currentWeekOffset);
    const days = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];

    openModal(`
        <div class="modal-header">
            <h2 class="modal-title">Add to Week</h2>
            <button class="modal-close" onclick="closeModal()">Ã—</button>
        </div>
        <div class="modal-body">
            <p class="mb-16">Add "${recipe.title}" to which day?</p>
            <div class="day-picker">
                ${weekDates.map((dateStr, i) => {
                    const d = new Date(dateStr + 'T12:00:00');
                    return `
                        <div class="day-picker-item" onclick="addRecipeToDay('${dateStr}', '${recipeId}')">
                            <div class="day-name">${days[i]}</div>
                            <div class="day-num">${d.getDate()}</div>
                        </div>
                    `;
                }).join('')}
            </div>
        </div>
    `);
}

function removeMealForDay(dateStr) {
    const mealPlans = getStorage(STORAGE.MEAL_PLANS) || {};
    delete mealPlans[dateStr];
    setStorage(STORAGE.MEAL_PLANS, mealPlans);
    renderWeekPlanner();
    showToast('Meal removed');
}

function viewMealForDay(dateStr) {
    const mealPlans = getStorage(STORAGE.MEAL_PLANS) || {};
    const meal = mealPlans[dateStr];
    if (!meal) return;

    if (meal.recipeId) {
        viewRecipeDetail(meal.recipeId);
    } else {
        showToast(`Planned: ${meal.title}`);
    }
}

function changeMealForDay(dateStr) {
    const d = new Date(dateStr + 'T12:00:00');
    const dayName = d.toLocaleDateString('en-US', { weekday: 'long' });
    openAddMealForDay(dateStr, dayName);
}

function askNonnaForWeekPlan() {
    // Open planning mode selection modal
    openPlanningModeModal();
}

function openPlanningModeModal() {
    const pantry = getStorage(STORAGE.PANTRY) || [];
    const garden = getStorage(STORAGE.GARDEN) || [];
    const profile = getStorage(STORAGE.PROFILE) || {};

    // Build pantry summary
    let pantrySummary = '';
    if (pantry.length > 0) {
        const categories = {};
        pantry.forEach(item => {
            const cat = item.category || categorizeIngredient(item.name);
            if (!categories[cat]) categories[cat] = [];
            categories[cat].push(item.name);
        });

        const categoryList = Object.entries(categories).map(([cat, items]) =>
            `<strong>${cat}:</strong> ${items.slice(0, 4).join(', ')}${items.length > 4 ? '...' : ''}`
        ).join('<br>');

        pantrySummary = categoryList;
    } else {
        pantrySummary = '<em>Pantry is empty. Add items to enable pantry-aware planning.</em>';
    }

    // Garden summary
    let gardenSummary = '';
    if (garden && garden.length > 0) {
        const gardenItems = garden.map(g => typeof g === 'string' ? g : g.name).slice(0, 5);
        gardenSummary = `<br><strong>ðŸŒ± Garden Ready:</strong> ${gardenItems.join(', ')}${garden.length > 5 ? '...' : ''}`;
    }

    openModal(`
        <div class="modal-header">
            <h2 class="modal-title">ðŸ“… Plan This Week</h2>
            <button class="modal-close" onclick="closeModal()">Ã—</button>
        </div>
        <div class="modal-body">
            <p class="text-muted mb-16">How should Nonna plan your meals?</p>

            <div class="planning-mode-selector">
                <label class="planning-mode-option" onclick="selectPlanningMode('use-pantry')">
                    <input type="radio" name="planning-mode" value="use-pantry">
                    <div class="planning-mode-content">
                        <div class="planning-mode-title">ðŸ  Use What I Have</div>
                        <div class="planning-mode-desc">Minimize shopping - prioritize pantry ingredients. Best when you want to use up what you have.</div>
                    </div>
                </label>

                <label class="planning-mode-option selected" onclick="selectPlanningMode('balanced')">
                    <input type="radio" name="planning-mode" value="balanced" checked>
                    <div class="planning-mode-content">
                        <div class="planning-mode-title">âš–ï¸ Balanced (Recommended)</div>
                        <div class="planning-mode-desc">Mix pantry items + fresh ingredients. Good variety with moderate shopping.</div>
                    </div>
                </label>

                <label class="planning-mode-option" onclick="selectPlanningMode('shop-freely')">
                    <input type="radio" name="planning-mode" value="shop-freely">
                    <div class="planning-mode-content">
                        <div class="planning-mode-title">ðŸ›’ Shop Freely</div>
                        <div class="planning-mode-desc">Ignore pantry - suggest optimal recipes based only on health goals and preferences.</div>
                    </div>
                </label>
            </div>

            <div class="planning-pantry-summary">
                <h4>ðŸ“¦ Currently in your pantry:</h4>
                <div style="font-size: 0.85rem; color: var(--gray-dark);">
                    ${pantrySummary}
                    ${gardenSummary}
                </div>
            </div>

            <div class="form-group mt-16">
                <label>Meals to plan</label>
                <div class="grid grid-2" style="gap: 8px;">
                    <label class="checkbox-item"><input type="checkbox" id="plan-breakfast"> Breakfast</label>
                    <label class="checkbox-item"><input type="checkbox" id="plan-lunch"> Lunch</label>
                    <label class="checkbox-item"><input type="checkbox" id="plan-dinner" checked> Dinner</label>
                    <label class="checkbox-item"><input type="checkbox" id="plan-snacks"> Snacks</label>
                </div>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
            <button class="btn btn-primary" onclick="executePlanningMode()">Ask Nonna to Plan</button>
        </div>
    `);
}

function selectPlanningMode(mode) {
    // Update visual selection
    document.querySelectorAll('.planning-mode-option').forEach(opt => {
        opt.classList.remove('selected');
    });
    document.querySelector(`input[value="${mode}"]`).closest('.planning-mode-option').classList.add('selected');
    document.querySelector(`input[value="${mode}"]`).checked = true;
}

function executePlanningMode() {
    const mode = document.querySelector('input[name="planning-mode"]:checked').value;
    const weekDates = getWeekDates(state.currentWeekOffset);
    const startDate = new Date(weekDates[0] + 'T12:00:00');
    const endDate = new Date(weekDates[6] + 'T12:00:00');
    const startStr = startDate.toLocaleDateString('en-US', { month: 'long', day: 'numeric' });
    const endStr = endDate.toLocaleDateString('en-US', { month: 'long', day: 'numeric' });

    // Get selected meal types
    const mealTypes = [];
    if (document.getElementById('plan-breakfast')?.checked) mealTypes.push('breakfast');
    if (document.getElementById('plan-lunch')?.checked) mealTypes.push('lunch');
    if (document.getElementById('plan-dinner')?.checked) mealTypes.push('dinner');
    if (document.getElementById('plan-snacks')?.checked) mealTypes.push('snacks');

    if (mealTypes.length === 0) {
        mealTypes.push('dinner'); // Default to dinner
    }

    const pantry = getStorage(STORAGE.PANTRY) || [];
    const garden = getStorage(STORAGE.GARDEN) || [];
    const profile = getStorage(STORAGE.PROFILE) || {};

    // Build the prompt based on mode
    let prompt = `Plan my meals for the week of ${startStr} to ${endStr}. Give me a complete 7-day plan for ${mealTypes.join(', ')}.`;

    if (mode === 'use-pantry') {
        const pantryItems = pantry.map(p => `${p.name} (${p.qty || 'some'})`).join(', ');
        const gardenItems = garden.length > 0
            ? garden.map(g => typeof g === 'string' ? g : g.name).join(', ')
            : '';

        prompt += `

IMPORTANT: I want to minimize shopping this week. Please create meals using primarily these pantry items:
${pantryItems}
${gardenItems ? `\nGarden ready to harvest: ${gardenItems}` : ''}

Goal: Use at least 70% of ingredients from my current inventory. Only suggest buying 5-10 fresh items maximum.`;
    } else if (mode === 'balanced') {
        const pantryItems = pantry.map(p => p.name).join(', ');
        const gardenItems = garden.length > 0
            ? garden.map(g => typeof g === 'string' ? g : g.name).join(', ')
            : '';

        prompt += `

I'd like a balanced plan that uses some of my pantry items while adding fresh ingredients.
Current pantry: ${pantryItems || 'minimal pantry staples'}
${gardenItems ? `Garden ready: ${gardenItems}` : ''}

Goal: Good variety with moderate shopping (15-20 items). Use some pantry items to reduce waste.`;
    } else {
        // shop-freely mode
        prompt += `

Create optimal meal plans based on health goals and variety. Don't worry about what I currently have - suggest the best recipes for my goals.`;
    }

    // Add health context if available
    if (profile.healthConditions) {
        prompt += `\n\nHealth note: I have ${profile.healthConditions}, so please keep meals appropriate.`;
    }
    if (profile.dietaryPrefs) {
        prompt += `\nDietary preferences: ${profile.dietaryPrefs}`;
    }

    closeModal();
    askNonna(prompt);
}

function generateWeekShoppingList() {
    const mealPlans = getStorage(STORAGE.MEAL_PLANS) || {};
    const weekDates = getWeekDates(state.currentWeekOffset);
    const library = getRecipeLibrary();
    const ingredients = [];

    weekDates.forEach(dateStr => {
        const meal = mealPlans[dateStr];
        if (meal && meal.recipeId) {
            const recipe = library.find(r => r.id === meal.recipeId);
            if (recipe && recipe.ingredients) {
                ingredients.push(...recipe.ingredients);
            }
        }
    });

    if (ingredients.length === 0) {
        showToast('No recipes with ingredients in your plan');
        return;
    }

    // Save as shopping list
    const shoppingLists = getStorage(STORAGE.SHOPPING) || { weekly: [] };
    shoppingLists['week-plan'] = ingredients.map(ing => ({ name: ing, checked: false }));
    setStorage(STORAGE.SHOPPING, shoppingLists);

    navigateTo('more');
    switchMoreTab('kitchen');
    setTimeout(() => {
        document.getElementById('shopping-list-select').value = 'week-plan';
        loadShoppingList();
    }, 100);
    showToast('ðŸ›’ Shopping list created from meal plan!');
}

function showPrepChecklist() {
    askNonna('Create a batch cooking prep checklist for my planned meals this week. What can I prepare ahead of time on Sunday?');
}

// ========================================
// KITCHEN - PANTRY
// ========================================
function renderPantry() {
    const pantry = getStorage(STORAGE.PANTRY) || [];
    const container = document.getElementById('pantry-list');
    const empty = document.getElementById('pantry-empty');

    // Render alerts first
    if (typeof renderPantryAlerts === 'function') {
        renderPantryAlerts();
    }

    if (pantry.length === 0) {
        container.innerHTML = '';
        empty.classList.remove('hidden');
        return;
    }

    empty.classList.add('hidden');
    container.innerHTML = pantry.map((item, i) => `
        <div class="pantry-item">
            <span class="pantry-item-icon">${item.icon || 'ðŸ¥«'}</span>
            <div class="pantry-item-info">
                <div class="pantry-item-name">${item.name}</div>
                <div class="pantry-item-qty">${item.qty || ''}</div>
            </div>
            <span class="pantry-status ${item.status || 'fresh'}"></span>
            <button class="icon-btn" onclick="removePantryItem(${i})">ðŸ—‘ï¸</button>
        </div>
    `).join('');
}

function openAddPantryModal() {
    openModal(`
        <div class="modal-header">
            <h2 class="modal-title">Add Pantry Item</h2>
            <button class="modal-close" onclick="closeModal()">Ã—</button>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label>Item Name</label>
                <input type="text" class="form-input" id="pantry-item-name" placeholder="e.g., Olive oil">
            </div>
            <div class="form-group">
                <label>Quantity (optional)</label>
                <input type="text" class="form-input" id="pantry-item-qty" placeholder="e.g., 1 bottle">
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
            <button class="btn btn-primary" onclick="savePantryItem()">Add</button>
        </div>
    `);
}

function savePantryItem() {
    const name = document.getElementById('pantry-item-name').value.trim();
    const qty = document.getElementById('pantry-item-qty').value.trim();
    if (!name) return;

    const pantry = getStorage(STORAGE.PANTRY) || [];
    pantry.push({ name, qty, icon: 'ðŸ¥«', status: 'fresh' });
    setStorage(STORAGE.PANTRY, pantry);
    closeModal();
    renderPantry();
    showToast('Item added!');
}

function removePantryItem(index) {
    const pantry = getStorage(STORAGE.PANTRY) || [];
    pantry.splice(index, 1);
    setStorage(STORAGE.PANTRY, pantry);
    renderPantry();
}

function askNonnaWithPantry() {
    const pantry = getStorage(STORAGE.PANTRY) || [];
    if (pantry.length === 0) {
        askNonna('What are some pantry staples I should keep for Mediterranean cooking?');
    } else {
        const items = pantry.map(p => p.name).join(', ');
        askNonna(`What can I make with these pantry items: ${items}?`);
    }
}

// ========================================
// PANTRY ALERTS & STATUS
// ========================================

function checkPantryStatus() {
    const pantry = getStorage(STORAGE.PANTRY) || [];
    const needsAttention = {
        runningLow: [],
        expiringSoon: [],
        outOfStock: []
    };

    // Define typical quantities for staples
    const stapleThresholds = {
        'olive oil': { min: 0.25, unit: 'bottles' },
        'lemons': { min: 2, unit: 'count' },
        'garlic': { min: 4, unit: 'cloves' },
        'cherry tomatoes': { min: 1, unit: 'containers' },
        'eggs': { min: 4, unit: 'count' },
        'butter': { min: 0.5, unit: 'sticks' }
    };

    pantry.forEach(item => {
        // Check if staple and quantity indicator suggests low
        const qtyStr = (item.qty || '').toLowerCase();
        const isLow = qtyStr.includes('low') ||
                      qtyStr.includes('running') ||
                      qtyStr.includes('almost') ||
                      qtyStr.includes('last') ||
                      qtyStr === '0' ||
                      qtyStr === '';

        // Check expiration/status
        if (item.status === 'use-soon') {
            needsAttention.expiringSoon.push(item);
        } else if (item.status === 'check') {
            needsAttention.expiringSoon.push(item);
        }

        // Check for low quantities based on common patterns
        if (isLow && !needsAttention.expiringSoon.includes(item)) {
            needsAttention.runningLow.push(item);
        }
    });

    return needsAttention;
}

function renderPantryAlerts() {
    const alertsContainer = document.getElementById('pantry-alerts');
    if (!alertsContainer) return;

    const status = checkPantryStatus();
    const hasAlerts = status.runningLow.length > 0 || status.expiringSoon.length > 0;

    if (!hasAlerts) {
        alertsContainer.innerHTML = '';
        return;
    }

    let html = '';

    // Expiring soon (urgent)
    if (status.expiringSoon.length > 0) {
        html += `
            <div class="pantry-alert-card urgent">
                <div class="pantry-alert-header">
                    <span>ðŸ”´</span> Use Soon / Expiring (${status.expiringSoon.length})
                </div>
                <ul class="pantry-alert-list">
                    ${status.expiringSoon.map(item => `
                        <li>
                            <span>${item.name}${item.qty ? ` (${item.qty})` : ''}</span>
                            <span style="font-size: 0.8rem; color: var(--gray-text);">${item.status === 'check' ? 'Check date' : 'Use soon'}</span>
                        </li>
                    `).join('')}
                </ul>
            </div>
        `;
    }

    // Running low
    if (status.runningLow.length > 0) {
        html += `
            <div class="pantry-alert-card">
                <div class="pantry-alert-header">
                    <span>ðŸŸ¡</span> Running Low (${status.runningLow.length})
                </div>
                <ul class="pantry-alert-list">
                    ${status.runningLow.map(item => `
                        <li>
                            <span>${item.name}${item.qty ? ` (${item.qty})` : ''}</span>
                        </li>
                    `).join('')}
                </ul>
            </div>
        `;
    }

    // Add to shopping list button
    const allAlertItems = [...status.expiringSoon, ...status.runningLow];
    if (allAlertItems.length > 0) {
        html += `
            <button class="btn btn-secondary btn-block mt-8" onclick="addPantryAlertsToShopping()">
                ðŸ›’ Add All to Shopping List
            </button>
        `;
    }

    alertsContainer.innerHTML = html;
}

function addPantryAlertsToShopping() {
    const status = checkPantryStatus();
    const allItems = [...status.expiringSoon, ...status.runningLow];

    if (allItems.length === 0) {
        showToast('No items need restocking');
        return;
    }

    const lists = getStorage(STORAGE.SHOPPING) || { weekly: [] };
    const listId = 'pantry-restock';

    // Create or update the restock list
    lists[listId] = {
        name: 'Pantry Restock',
        generatedFrom: 'pantry-alerts',
        createdAt: new Date().toISOString(),
        items: allItems.map(item => ({
            name: item.name,
            quantity: 'Restock',
            category: item.category || categorizeIngredient(item.name),
            checked: false,
            pantryStatus: item.status === 'use-soon' || item.status === 'check' ? 'Expiring soon' : 'Running low',
            pantryStatusType: 'missing'
        }))
    };

    setStorage(STORAGE.SHOPPING, lists);

    // Navigate to shopping list
    switchKitchenTab('shopping');
    setTimeout(() => {
        updateShoppingListDropdown();
        document.getElementById('shopping-list-select').value = listId;
        loadEnhancedShoppingList(listId);
    }, 100);

    showToast(`Added ${allItems.length} items to Pantry Restock list`);
}

// ========================================
// WHAT CAN I MAKE? (Enhanced)
// ========================================

function openWhatCanIMakeModal() {
    const pantry = getStorage(STORAGE.PANTRY) || [];
    const garden = getStorage(STORAGE.GARDEN) || [];

    if (pantry.length === 0) {
        showToast('Add items to your pantry first!');
        openAddPantryModal();
        return;
    }

    // Build ingredient summary
    const categories = {};
    pantry.forEach(item => {
        const cat = item.category || categorizeIngredient(item.name);
        if (!categories[cat]) categories[cat] = [];
        categories[cat].push(item.name);
    });

    let inventorySummary = '';
    Object.keys(categories).forEach(cat => {
        inventorySummary += `<strong>${cat}:</strong> ${categories[cat].join(', ')}<br>`;
    });

    // Add garden items if available
    if (garden && garden.length > 0) {
        const gardenItems = garden.map(g => typeof g === 'string' ? g : g.name).join(', ');
        inventorySummary += `<strong>Garden Ready:</strong> ${gardenItems}<br>`;
    }

    openModal(`
        <div class="modal-header">
            <h2 class="modal-title">ðŸ³ What Can I Make?</h2>
            <button class="modal-close" onclick="closeModal()">Ã—</button>
        </div>
        <div class="modal-body">
            <p class="text-muted mb-16">Nonna will suggest recipes using only what you have on hand.</p>

            <div class="card" style="padding: 12px; margin-bottom: 16px; background: var(--seafoam-light);">
                <div style="font-weight: 600; margin-bottom: 8px;">ðŸ“¦ Your Current Inventory</div>
                <div style="font-size: 0.85rem; color: var(--gray-dark);">
                    ${inventorySummary}
                </div>
            </div>

            <div class="form-group">
                <label>Recipe preferences (optional)</label>
                <div class="grid grid-2" style="gap: 8px;">
                    <label class="checkbox-item"><input type="checkbox" id="wcim-quick" value="quick"> Quick (under 30 min)</label>
                    <label class="checkbox-item"><input type="checkbox" id="wcim-easy" value="easy"> Easy prep</label>
                    <label class="checkbox-item"><input type="checkbox" id="wcim-lowcal" value="lowcal"> Low calorie</label>
                    <label class="checkbox-item"><input type="checkbox" id="wcim-protein" value="protein"> High protein</label>
                </div>
            </div>

            <div class="form-group">
                <label>Meal type</label>
                <select class="form-select" id="wcim-meal-type">
                    <option value="any">Any meal</option>
                    <option value="breakfast">Breakfast</option>
                    <option value="lunch">Lunch</option>
                    <option value="dinner">Dinner</option>
                    <option value="snack">Snack</option>
                </select>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
            <button class="btn btn-primary" onclick="askWhatCanIMake()">Ask Nonna</button>
        </div>
    `);
}

function askWhatCanIMake() {
    const pantry = getStorage(STORAGE.PANTRY) || [];
    const garden = getStorage(STORAGE.GARDEN) || [];
    const profile = getStorage(STORAGE.PROFILE) || {};

    // Get preferences
    const isQuick = document.getElementById('wcim-quick')?.checked;
    const isEasy = document.getElementById('wcim-easy')?.checked;
    const isLowCal = document.getElementById('wcim-lowcal')?.checked;
    const isHighProtein = document.getElementById('wcim-protein')?.checked;
    const mealType = document.getElementById('wcim-meal-type')?.value || 'any';

    // Build ingredient list
    const ingredients = pantry.map(item => `${item.name} (${item.qty || 'some'})`).join(', ');
    const gardenItems = garden.length > 0
        ? garden.map(g => typeof g === 'string' ? g : g.name).join(', ')
        : '';

    // Build preferences string
    const prefs = [];
    if (isQuick) prefs.push('quick (under 30 minutes)');
    if (isEasy) prefs.push('easy to prepare');
    if (isLowCal) prefs.push('lower calorie');
    if (isHighProtein) prefs.push('high protein');

    let prompt = `I want to cook using only what I have in my pantry. Here's my current inventory:

PANTRY: ${ingredients}
${gardenItems ? `GARDEN (ready to harvest): ${gardenItems}` : ''}

Suggest 5-7 recipes I can make using ONLY these ingredients (plus common staples like olive oil, salt, pepper, basic spices).

${mealType !== 'any' ? `Looking specifically for ${mealType} ideas.` : ''}
${prefs.length > 0 ? `Preferences: ${prefs.join(', ')}.` : ''}
${profile.healthConditions ? `Note: I have ${profile.healthConditions}, so keep recipes appropriate.` : ''}

For each recipe:
1. Recipe name
2. Brief description (1-2 sentences)
3. Which of my pantry items it uses
4. Estimated prep + cook time
5. Calorie estimate per serving

Present as a numbered list. Make them Mediterranean-focused when possible.`;

    closeModal();
    askNonna(prompt);
}

// ========================================
// QUICK ADD FROM DELIVERY
// ========================================

function toggleQuickAddSection() {
    const content = document.getElementById('quick-add-content');
    const header = document.querySelector('.quick-add-header .accordion-icon');
    if (content) {
        content.classList.toggle('open');
        if (header) {
            header.style.transform = content.classList.contains('open') ? 'rotate(180deg)' : 'rotate(0deg)';
        }
    }
}

const DELIVERY_TEMPLATES = {
    misfits: {
        name: 'Misfits Market Box',
        icon: 'ðŸ¥¬',
        items: [
            { name: 'Cherry tomatoes', qty: '1 container', category: 'Produce' },
            { name: 'Mixed greens', qty: '1 bag', category: 'Produce' },
            { name: 'Bell peppers', qty: '3-4', category: 'Produce' },
            { name: 'Zucchini', qty: '2-3', category: 'Produce' },
            { name: 'Lemons', qty: '4-6', category: 'Produce' },
            { name: 'Carrots', qty: '1 bag', category: 'Produce' },
            { name: 'Potatoes', qty: '2 lbs', category: 'Produce' },
            { name: 'Onions', qty: '3-4', category: 'Produce' },
            { name: 'Apples', qty: '4-5', category: 'Produce' },
            { name: 'Sweet potatoes', qty: '2-3', category: 'Produce' }
        ]
    },
    wholefoods: {
        name: 'Whole Foods Order',
        icon: 'ðŸ›’',
        items: [
            { name: 'Salmon fillet', qty: '1 lb', category: 'Proteins' },
            { name: 'Chicken breast', qty: '1.5 lbs', category: 'Proteins' },
            { name: 'Greek yogurt', qty: '32 oz', category: 'Dairy' },
            { name: 'Feta cheese', qty: '8 oz', category: 'Dairy' },
            { name: 'Baby spinach', qty: '1 container', category: 'Produce' },
            { name: 'Avocados', qty: '3-4', category: 'Produce' },
            { name: 'Olive oil', qty: '1 bottle', category: 'Pantry' },
            { name: 'Hummus', qty: '1 container', category: 'Pantry' },
            { name: 'Whole grain bread', qty: '1 loaf', category: 'Grains' },
            { name: 'Eggs', qty: '1 dozen', category: 'Proteins' }
        ]
    },
    csa: {
        name: 'CSA Pickup',
        icon: 'ðŸŒ±',
        items: [
            { name: 'Tomatoes', qty: '1 lb', category: 'Produce' },
            { name: 'Lettuce', qty: '1 head', category: 'Produce' },
            { name: 'Cucumbers', qty: '2-3', category: 'Produce' },
            { name: 'Kale', qty: '1 bunch', category: 'Produce' },
            { name: 'Fresh herbs', qty: '1 bunch', category: 'Produce' },
            { name: 'Squash', qty: '2-3', category: 'Produce' },
            { name: 'Beets', qty: '1 bunch', category: 'Produce' },
            { name: 'Green beans', qty: '1/2 lb', category: 'Produce' }
        ]
    },
    custom: {
        name: 'Custom Delivery',
        icon: 'âž•',
        items: []
    }
};

function openDeliveryQuickAdd(deliveryType) {
    const template = DELIVERY_TEMPLATES[deliveryType];
    if (!template) return;

    if (deliveryType === 'custom') {
        // Open custom multi-add modal
        openCustomDeliveryModal();
        return;
    }

    const itemsHtml = template.items.map((item, i) => `
        <label class="scan-item" style="cursor: pointer;">
            <input type="checkbox" class="scan-item-checkbox" id="delivery-item-${i}" checked>
            <div class="scan-item-info">
                <div class="scan-item-name">${item.name}</div>
                <div class="scan-item-details">${item.qty} | ${item.category}</div>
            </div>
        </label>
    `).join('');

    openModal(`
        <div class="modal-header">
            <h2 class="modal-title">${template.icon} Add ${template.name} Items</h2>
            <button class="modal-close" onclick="closeModal()">Ã—</button>
        </div>
        <div class="modal-body" style="max-height: 400px; overflow-y: auto;">
            <p class="text-muted mb-16">Check what you received:</p>

            <div class="flex gap-8 mb-16">
                <button class="btn btn-sm btn-secondary" onclick="selectAllDeliveryItems(true)">Select All</button>
                <button class="btn btn-sm btn-secondary" onclick="selectAllDeliveryItems(false)">Clear</button>
            </div>

            <div id="delivery-items-list">
                ${itemsHtml}
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
            <button class="btn btn-primary" onclick="saveDeliveryItems('${deliveryType}')">Add to Pantry</button>
        </div>
        <div class="modal-footer" style="border-top: none; padding-top: 0;">
            <button class="btn btn-secondary btn-block" onclick="whatCanIMakeWithDelivery('${deliveryType}')">
                ðŸ³ What Can I Make With These?
            </button>
        </div>
    `);
}

function selectAllDeliveryItems(selectAll) {
    document.querySelectorAll('[id^="delivery-item-"]').forEach(checkbox => {
        checkbox.checked = selectAll;
    });
}

function saveDeliveryItems(deliveryType) {
    const template = DELIVERY_TEMPLATES[deliveryType];
    if (!template) return;

    const pantry = getStorage(STORAGE.PANTRY) || [];
    let addedCount = 0;

    const categoryIcons = {
        'Produce': 'ðŸ¥¬',
        'Proteins': 'ðŸ¥©',
        'Dairy': 'ðŸ§€',
        'Pantry': 'ðŸ¥«',
        'Grains': 'ðŸŒ¾'
    };

    template.items.forEach((item, i) => {
        const checkbox = document.getElementById(`delivery-item-${i}`);
        if (checkbox && checkbox.checked) {
            // Check for duplicates
            const existing = pantry.find(p =>
                p.name.toLowerCase() === item.name.toLowerCase()
            );

            if (!existing) {
                pantry.push({
                    name: item.name,
                    qty: item.qty,
                    icon: categoryIcons[item.category] || 'ðŸ¥«',
                    status: 'fresh',
                    category: item.category
                });
                addedCount++;
            } else {
                // Update quantity
                existing.qty = item.qty;
                existing.status = 'fresh';
            }
        }
    });

    setStorage(STORAGE.PANTRY, pantry);
    closeModal();
    renderPantry();
    renderPantryAlerts();

    showToast(`Added ${addedCount} items to pantry!`);
}

function whatCanIMakeWithDelivery(deliveryType) {
    const template = DELIVERY_TEMPLATES[deliveryType];
    if (!template) return;

    // Get selected items
    const selectedItems = [];
    template.items.forEach((item, i) => {
        const checkbox = document.getElementById(`delivery-item-${i}`);
        if (checkbox && checkbox.checked) {
            selectedItems.push(item.name);
        }
    });

    if (selectedItems.length === 0) {
        showToast('Select some items first');
        return;
    }

    closeModal();

    const prompt = `I just received these ingredients in my ${template.name}:

${selectedItems.join(', ')}

Suggest 3-5 quick Mediterranean recipes I can make this week using these fresh items. Focus on using them before they spoil. Include:
1. Recipe name
2. Which delivery items it uses
3. What else I might need (staples only)
4. Prep + cook time
5. Calorie estimate`;

    askNonna(prompt);
}

function openCustomDeliveryModal() {
    openModal(`
        <div class="modal-header">
            <h2 class="modal-title">âž• Add Multiple Items</h2>
            <button class="modal-close" onclick="closeModal()">Ã—</button>
        </div>
        <div class="modal-body">
            <p class="text-muted mb-16">Enter items one per line (name, quantity - optional):</p>

            <textarea class="form-input" id="custom-delivery-items" rows="10" placeholder="Example:
Tomatoes, 2 lbs
Chicken breast
Olive oil, 1 bottle
Feta cheese, 8 oz"></textarea>

            <div class="form-group mt-16">
                <label>Default category</label>
                <select class="form-select" id="custom-delivery-category">
                    <option value="Produce">Produce</option>
                    <option value="Proteins">Proteins</option>
                    <option value="Dairy">Dairy</option>
                    <option value="Pantry">Pantry</option>
                    <option value="Grains">Grains</option>
                    <option value="Other">Other</option>
                </select>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
            <button class="btn btn-primary" onclick="saveCustomDeliveryItems()">Add to Pantry</button>
        </div>
    `);
}

function saveCustomDeliveryItems() {
    const textarea = document.getElementById('custom-delivery-items');
    const defaultCategory = document.getElementById('custom-delivery-category').value;

    if (!textarea || !textarea.value.trim()) {
        showToast('Enter some items first');
        return;
    }

    const lines = textarea.value.trim().split('\n');
    const pantry = getStorage(STORAGE.PANTRY) || [];
    let addedCount = 0;

    const categoryIcons = {
        'Produce': 'ðŸ¥¬',
        'Proteins': 'ðŸ¥©',
        'Dairy': 'ðŸ§€',
        'Pantry': 'ðŸ¥«',
        'Grains': 'ðŸŒ¾',
        'Other': 'ðŸ“¦'
    };

    lines.forEach(line => {
        const trimmed = line.trim();
        if (!trimmed) return;

        // Parse "name, qty" or just "name"
        const parts = trimmed.split(',').map(p => p.trim());
        const name = parts[0];
        const qty = parts[1] || '';

        if (name) {
            const category = categorizeIngredient(name) || defaultCategory;
            const existing = pantry.find(p =>
                p.name.toLowerCase() === name.toLowerCase()
            );

            if (!existing) {
                pantry.push({
                    name: name,
                    qty: qty,
                    icon: categoryIcons[category] || 'ðŸ“¦',
                    status: 'fresh',
                    category: category
                });
                addedCount++;
            }
        }
    });

    setStorage(STORAGE.PANTRY, pantry);
    closeModal();
    renderPantry();
    renderPantryAlerts();

    showToast(`Added ${addedCount} items to pantry!`);
}

// Update renderPantry to also render alerts
const originalRenderPantry = renderPantry;

// ========================================
// PANTRY PHOTO SCANNING
// ========================================
let pantryScanState = {
    imageData: null,
    imageType: null,
    detectedItems: [],
    selectedItems: new Set()
};

function openPantryScanModal() {
    pantryScanState = {
        imageData: null,
        imageType: null,
        detectedItems: [],
        selectedItems: new Set()
    };

    openModal(`
        <div class="modal-header">
            <h2 class="modal-title">ðŸ“· Scan Your Pantry</h2>
            <button class="modal-close" onclick="closeModal()">Ã—</button>
        </div>
        <div class="modal-body" id="scan-modal-body">
            <p class="text-muted mb-16">Take a photo or upload an image of your fridge, pantry, or spice rack. Nonna will identify the items for you!</p>

            <div class="scan-upload-area" id="scan-upload-area" onclick="document.getElementById('pantry-image-input').click()">
                <div class="scan-upload-icon">ðŸ“¸</div>
                <div class="scan-upload-text">Tap to take photo or upload</div>
                <div class="scan-upload-hint">Supports: JPG, PNG, WebP</div>
            </div>

            <input type="file" id="pantry-image-input" accept="image/*" capture="environment" style="display: none;" onchange="handlePantryImageSelect(event)">

            <img id="scan-preview" class="scan-preview hidden" alt="Preview">

            <div class="nonna-tip mt-16">
                <div class="nonna-tip-header">ðŸ’¡ Tips for best results</div>
                <div class="nonna-tip-text">
                    â€¢ Use good lighting<br>
                    â€¢ Capture labels when possible<br>
                    â€¢ Take multiple photos for different areas
                </div>
            </div>

            <p class="text-muted mt-16" style="font-size: 0.8rem;">ðŸ”’ Photos are analyzed securely and not stored.</p>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
            <button class="btn btn-primary" id="scan-analyze-btn" onclick="analyzePantryImage()" disabled>Analyze Photo</button>
        </div>
    `);

    // Set up drag and drop
    setTimeout(() => {
        const uploadArea = document.getElementById('scan-upload-area');
        if (uploadArea) {
            uploadArea.addEventListener('dragover', handleDragOver);
            uploadArea.addEventListener('dragleave', handleDragLeave);
            uploadArea.addEventListener('drop', handleDrop);
        }
    }, 100);
}

function handleDragOver(e) {
    e.preventDefault();
    e.currentTarget.classList.add('dragover');
}

function handleDragLeave(e) {
    e.currentTarget.classList.remove('dragover');
}

function handleDrop(e) {
    e.preventDefault();
    e.currentTarget.classList.remove('dragover');

    const files = e.dataTransfer.files;
    if (files.length > 0 && files[0].type.startsWith('image/')) {
        processImageFile(files[0]);
    }
}

function handlePantryImageSelect(event) {
    const file = event.target.files[0];
    if (file) {
        processImageFile(file);
    }
}

function processImageFile(file) {
    // Validate file type
    const allowedTypes = ['image/jpeg', 'image/png', 'image/gif', 'image/webp'];
    if (!allowedTypes.includes(file.type)) {
        showToast('Please use JPG, PNG, or WebP images');
        return;
    }

    // Validate file size (max 10MB)
    if (file.size > 10 * 1024 * 1024) {
        showToast('Image too large. Max 10MB.');
        return;
    }

    pantryScanState.imageType = file.type;

    const reader = new FileReader();
    reader.onload = (e) => {
        const base64Full = e.target.result;
        pantryScanState.imageData = base64Full.split(',')[1]; // Remove data:image/xxx;base64, prefix

        // Show preview
        const preview = document.getElementById('scan-preview');
        if (preview) {
            preview.src = base64Full;
            preview.classList.remove('hidden');
        }

        // Update upload area
        const uploadArea = document.getElementById('scan-upload-area');
        if (uploadArea) {
            uploadArea.innerHTML = `
                <div class="scan-upload-icon">âœ…</div>
                <div class="scan-upload-text">Photo ready!</div>
                <div class="scan-upload-hint">Tap to change photo</div>
            `;
        }

        // Enable analyze button
        const btn = document.getElementById('scan-analyze-btn');
        if (btn) {
            btn.disabled = false;
        }
    };
    reader.readAsDataURL(file);
}

async function analyzePantryImage() {
    if (!pantryScanState.imageData) {
        showToast('Please select an image first');
        return;
    }

    // Show loading state
    const modalBody = document.getElementById('scan-modal-body');
    modalBody.innerHTML = `
        <div class="scan-loading">
            <div class="scan-loading-icon">ðŸ”</div>
            <div class="scan-loading-text">
                <strong>Nonna is scanning your kitchen...</strong><br>
                <span class="text-muted">Identifying items and quantities</span>
            </div>
        </div>
    `;

    // Disable buttons during processing
    const analyzeBtn = document.getElementById('scan-analyze-btn');
    if (analyzeBtn) analyzeBtn.disabled = true;

    try {
        const response = await fetch('/.netlify/functions/analyze-pantry-image', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                image: pantryScanState.imageData,
                imageType: pantryScanState.imageType
            })
        });

        const data = await response.json();

        if (!response.ok) {
            throw new Error(data.error || 'Failed to analyze image');
        }

        if (data.items && data.items.length > 0) {
            pantryScanState.detectedItems = data.items;
            // Select all items by default
            pantryScanState.selectedItems = new Set(data.items.map((_, i) => i));
            showScanResults();
        } else {
            showScanError(data.message || 'No items detected. Try a clearer photo with better lighting.');
        }

    } catch (error) {
        console.error('Scan error:', error);
        showScanError(error.message || 'Failed to analyze image. Please try again.');
    }
}

function showScanError(message) {
    const modalBody = document.getElementById('scan-modal-body');
    modalBody.innerHTML = `
        <div class="empty-state">
            <div class="empty-state-icon">ðŸ˜•</div>
            <div class="empty-state-title">Couldn't detect items</div>
            <p>${message}</p>
            <button class="btn btn-primary mt-16" onclick="openPantryScanModal()">Try Again</button>
        </div>
    `;

    // Update footer
    const modal = document.querySelector('.modal');
    const footer = modal.querySelector('.modal-footer');
    if (footer) {
        footer.innerHTML = `
            <button class="btn btn-secondary" onclick="closeModal()">Close</button>
        `;
    }
}

function showScanResults() {
    const items = pantryScanState.detectedItems;

    // Group items by category
    const categories = {};
    items.forEach((item, index) => {
        const cat = item.category || 'Other';
        if (!categories[cat]) categories[cat] = [];
        categories[cat].push({ ...item, index });
    });

    // Category icons
    const categoryIcons = {
        'Produce': 'ðŸ¥¬',
        'Proteins': 'ðŸ¥©',
        'Dairy': 'ðŸ§€',
        'Grains': 'ðŸŒ¾',
        'Canned Goods': 'ðŸ¥«',
        'Spices': 'ðŸ§‚',
        'Condiments': 'ðŸ«™',
        'Frozen': 'â„ï¸',
        'Beverages': 'ðŸ¥¤',
        'Snacks': 'ðŸ¿',
        'Other': 'ðŸ“¦'
    };

    // Status badge helper
    const getStatusBadge = (status) => {
        const statusMap = {
            'Fresh': { class: 'fresh', text: 'ðŸŸ¢ Fresh' },
            'Use Soon': { class: 'use-soon', text: 'ðŸŸ¡ Use Soon' },
            'Check Date': { class: 'check', text: 'ðŸ”´ Check Date' }
        };
        const s = statusMap[status] || statusMap['Fresh'];
        return `<span class="scan-item-badge ${s.class}">${s.text}</span>`;
    };

    // Build HTML
    let html = `
        <div class="scan-results-header">
            <span class="scan-results-count">âœ“ Found ${items.length} items!</span>
            <div>
                <button class="btn btn-sm btn-ghost" onclick="selectAllScanItems(true)">Select All</button>
                <button class="btn btn-sm btn-ghost" onclick="selectAllScanItems(false)">Deselect All</button>
            </div>
        </div>
        <p class="text-muted mb-16">Review and uncheck any incorrect items before adding.</p>
    `;

    // Render by category
    Object.keys(categories).sort().forEach(cat => {
        const catItems = categories[cat];
        html += `<div class="scan-category-header">${categoryIcons[cat] || 'ðŸ“¦'} ${cat} (${catItems.length})</div>`;

        catItems.forEach(item => {
            const checked = pantryScanState.selectedItems.has(item.index) ? 'checked' : '';
            html += `
                <div class="scan-item" id="scan-item-${item.index}">
                    <input type="checkbox" class="scan-item-checkbox" ${checked} onchange="toggleScanItem(${item.index})">
                    <div class="scan-item-info">
                        <div class="scan-item-name">${item.name}</div>
                        <div class="scan-item-details">
                            ${item.quantity} Â· ${item.location || 'Pantry'}
                            ${getStatusBadge(item.expirationConcern)}
                            ${item.confidence === 'low' ? '<span class="scan-item-badge">â“ Verify</span>' : ''}
                        </div>
                    </div>
                    <div class="scan-item-actions">
                        <button class="icon-btn" onclick="editScanItem(${item.index})" title="Edit">âœï¸</button>
                        <button class="icon-btn" onclick="removeScanItem(${item.index})" title="Remove">ðŸ—‘ï¸</button>
                    </div>
                </div>
            `;
        });
    });

    html += `
        <button class="btn btn-ghost btn-block mt-16" onclick="addManualScanItem()">+ Add item manually</button>
    `;

    const modalBody = document.getElementById('scan-modal-body');
    modalBody.innerHTML = html;

    // Update footer
    const modal = document.querySelector('.modal');
    const footer = modal.querySelector('.modal-footer');
    if (footer) {
        footer.innerHTML = `
            <button class="btn btn-secondary" onclick="openPantryScanModal()">Scan Another</button>
            <button class="btn btn-primary" onclick="addScannedItemsToPantry()">Add ${pantryScanState.selectedItems.size} Items</button>
        `;
    }
}

function toggleScanItem(index) {
    if (pantryScanState.selectedItems.has(index)) {
        pantryScanState.selectedItems.delete(index);
    } else {
        pantryScanState.selectedItems.add(index);
    }
    updateScanFooter();
}

function selectAllScanItems(selectAll) {
    if (selectAll) {
        pantryScanState.detectedItems.forEach((_, i) => pantryScanState.selectedItems.add(i));
    } else {
        pantryScanState.selectedItems.clear();
    }

    // Update checkboxes
    document.querySelectorAll('.scan-item-checkbox').forEach((cb, i) => {
        cb.checked = selectAll;
    });

    updateScanFooter();
}

function updateScanFooter() {
    const addBtn = document.querySelector('.modal-footer .btn-primary');
    if (addBtn) {
        addBtn.textContent = `Add ${pantryScanState.selectedItems.size} Items`;
        addBtn.disabled = pantryScanState.selectedItems.size === 0;
    }
}

function editScanItem(index) {
    const item = pantryScanState.detectedItems[index];

    openModal(`
        <div class="modal-header">
            <h2 class="modal-title">Edit Item</h2>
            <button class="modal-close" onclick="showScanResultsModal()">Ã—</button>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label>Name</label>
                <input type="text" class="form-input" id="edit-scan-name" value="${item.name}">
            </div>
            <div class="form-group">
                <label>Quantity</label>
                <input type="text" class="form-input" id="edit-scan-qty" value="${item.quantity}">
            </div>
            <div class="form-group">
                <label>Category</label>
                <select class="form-select" id="edit-scan-category">
                    <option value="Produce" ${item.category === 'Produce' ? 'selected' : ''}>Produce</option>
                    <option value="Proteins" ${item.category === 'Proteins' ? 'selected' : ''}>Proteins</option>
                    <option value="Dairy" ${item.category === 'Dairy' ? 'selected' : ''}>Dairy</option>
                    <option value="Grains" ${item.category === 'Grains' ? 'selected' : ''}>Grains</option>
                    <option value="Canned Goods" ${item.category === 'Canned Goods' ? 'selected' : ''}>Canned Goods</option>
                    <option value="Spices" ${item.category === 'Spices' ? 'selected' : ''}>Spices</option>
                    <option value="Condiments" ${item.category === 'Condiments' ? 'selected' : ''}>Condiments</option>
                    <option value="Frozen" ${item.category === 'Frozen' ? 'selected' : ''}>Frozen</option>
                    <option value="Beverages" ${item.category === 'Beverages' ? 'selected' : ''}>Beverages</option>
                    <option value="Snacks" ${item.category === 'Snacks' ? 'selected' : ''}>Snacks</option>
                    <option value="Other" ${item.category === 'Other' ? 'selected' : ''}>Other</option>
                </select>
            </div>
            <div class="form-group">
                <label>Location</label>
                <select class="form-select" id="edit-scan-location">
                    <option value="Fridge" ${item.location === 'Fridge' ? 'selected' : ''}>Fridge</option>
                    <option value="Pantry" ${item.location === 'Pantry' ? 'selected' : ''}>Pantry</option>
                    <option value="Freezer" ${item.location === 'Freezer' ? 'selected' : ''}>Freezer</option>
                    <option value="Spice Rack" ${item.location === 'Spice Rack' ? 'selected' : ''}>Spice Rack</option>
                </select>
            </div>
            <div class="form-group">
                <label>Status</label>
                <select class="form-select" id="edit-scan-status">
                    <option value="Fresh" ${item.expirationConcern === 'Fresh' ? 'selected' : ''}>Fresh</option>
                    <option value="Use Soon" ${item.expirationConcern === 'Use Soon' ? 'selected' : ''}>Use Soon</option>
                    <option value="Check Date" ${item.expirationConcern === 'Check Date' ? 'selected' : ''}>Check Date</option>
                </select>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="showScanResultsModal()">Cancel</button>
            <button class="btn btn-primary" onclick="saveScanItemEdit(${index})">Save</button>
        </div>
    `);
}

function saveScanItemEdit(index) {
    const item = pantryScanState.detectedItems[index];
    item.name = document.getElementById('edit-scan-name').value.trim();
    item.quantity = document.getElementById('edit-scan-qty').value.trim();
    item.category = document.getElementById('edit-scan-category').value;
    item.location = document.getElementById('edit-scan-location').value;
    item.expirationConcern = document.getElementById('edit-scan-status').value;

    showScanResultsModal();
}

function removeScanItem(index) {
    pantryScanState.detectedItems.splice(index, 1);
    pantryScanState.selectedItems.delete(index);

    // Reindex selected items
    const newSelected = new Set();
    pantryScanState.selectedItems.forEach(i => {
        if (i < index) newSelected.add(i);
        else if (i > index) newSelected.add(i - 1);
    });
    pantryScanState.selectedItems = newSelected;

    if (pantryScanState.detectedItems.length === 0) {
        showScanError('All items removed. Scan another photo or add manually.');
    } else {
        showScanResults();
    }
}

function addManualScanItem() {
    openModal(`
        <div class="modal-header">
            <h2 class="modal-title">Add Item</h2>
            <button class="modal-close" onclick="showScanResultsModal()">Ã—</button>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label>Name</label>
                <input type="text" class="form-input" id="add-scan-name" placeholder="e.g., Roma tomatoes">
            </div>
            <div class="form-group">
                <label>Quantity</label>
                <input type="text" class="form-input" id="add-scan-qty" placeholder="e.g., 4 tomatoes">
            </div>
            <div class="form-group">
                <label>Category</label>
                <select class="form-select" id="add-scan-category">
                    <option value="Produce">Produce</option>
                    <option value="Proteins">Proteins</option>
                    <option value="Dairy">Dairy</option>
                    <option value="Grains">Grains</option>
                    <option value="Canned Goods">Canned Goods</option>
                    <option value="Spices">Spices</option>
                    <option value="Condiments">Condiments</option>
                    <option value="Frozen">Frozen</option>
                    <option value="Beverages">Beverages</option>
                    <option value="Snacks">Snacks</option>
                    <option value="Other" selected>Other</option>
                </select>
            </div>
            <div class="form-group">
                <label>Location</label>
                <select class="form-select" id="add-scan-location">
                    <option value="Pantry" selected>Pantry</option>
                    <option value="Fridge">Fridge</option>
                    <option value="Freezer">Freezer</option>
                    <option value="Spice Rack">Spice Rack</option>
                </select>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="showScanResultsModal()">Cancel</button>
            <button class="btn btn-primary" onclick="saveManualScanItem()">Add</button>
        </div>
    `);
}

function saveManualScanItem() {
    const name = document.getElementById('add-scan-name').value.trim();
    const qty = document.getElementById('add-scan-qty').value.trim() || '1';
    const category = document.getElementById('add-scan-category').value;
    const location = document.getElementById('add-scan-location').value;

    if (!name) {
        showToast('Please enter an item name');
        return;
    }

    const newIndex = pantryScanState.detectedItems.length;
    pantryScanState.detectedItems.push({
        name,
        quantity: qty,
        category,
        location,
        expirationConcern: 'Fresh',
        confidence: 'high'
    });
    pantryScanState.selectedItems.add(newIndex);

    showScanResultsModal();
}

function showScanResultsModal() {
    openModal(`
        <div class="modal-header">
            <h2 class="modal-title">ðŸ“· Scan Results</h2>
            <button class="modal-close" onclick="closeModal()">Ã—</button>
        </div>
        <div class="modal-body" id="scan-modal-body"></div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="openPantryScanModal()">Scan Another</button>
            <button class="btn btn-primary" onclick="addScannedItemsToPantry()">Add ${pantryScanState.selectedItems.size} Items</button>
        </div>
    `);

    setTimeout(() => showScanResults(), 50);
}

function addScannedItemsToPantry() {
    if (pantryScanState.selectedItems.size === 0) {
        showToast('No items selected');
        return;
    }

    const pantry = getStorage(STORAGE.PANTRY) || [];

    // Category to icon mapping
    const categoryIcons = {
        'Produce': 'ðŸ¥¬',
        'Proteins': 'ðŸ¥©',
        'Dairy': 'ðŸ§€',
        'Grains': 'ðŸŒ¾',
        'Canned Goods': 'ðŸ¥«',
        'Spices': 'ðŸ§‚',
        'Condiments': 'ðŸ«™',
        'Frozen': 'â„ï¸',
        'Beverages': 'ðŸ¥¤',
        'Snacks': 'ðŸ¿',
        'Other': 'ðŸ“¦'
    };

    // Status mapping
    const statusMap = {
        'Fresh': 'fresh',
        'Use Soon': 'use-soon',
        'Check Date': 'check'
    };

    let addedCount = 0;
    let duplicateCount = 0;

    pantryScanState.selectedItems.forEach(index => {
        const item = pantryScanState.detectedItems[index];

        // Check for duplicates (case-insensitive name match)
        const existingIndex = pantry.findIndex(p =>
            p.name.toLowerCase() === item.name.toLowerCase()
        );

        if (existingIndex >= 0) {
            // Update existing item's quantity
            pantry[existingIndex].qty = item.quantity;
            pantry[existingIndex].status = statusMap[item.expirationConcern] || 'fresh';
            duplicateCount++;
        } else {
            // Add new item
            pantry.push({
                name: item.name,
                qty: item.quantity,
                icon: categoryIcons[item.category] || 'ðŸ¥«',
                status: statusMap[item.expirationConcern] || 'fresh',
                category: item.category,
                location: item.location
            });
            addedCount++;
        }
    });

    setStorage(STORAGE.PANTRY, pantry);
    closeModal();
    renderPantry();

    // Show confirmation
    let message = `âœ… ${addedCount} items added to pantry!`;
    if (duplicateCount > 0) {
        message += ` (${duplicateCount} updated)`;
    }
    showToast(message);
}

// ========================================
// KITCHEN - SHOPPING
// ========================================
function loadShoppingList() {
    const listName = document.getElementById('shopping-list-select').value;
    const lists = getStorage(STORAGE.SHOPPING) || { weekly: [] };
    const items = lists[listName] || [];
    const container = document.getElementById('shopping-list');
    const empty = document.getElementById('shopping-empty');

    if (items.length === 0) {
        container.innerHTML = '';
        empty.classList.remove('hidden');
        return;
    }

    empty.classList.add('hidden');
    container.innerHTML = items.map((item, i) => `
        <div class="shopping-item ${item.checked ? 'checked' : ''}">
            <input type="checkbox" class="shopping-item-checkbox" ${item.checked ? 'checked' : ''} onchange="toggleShoppingItem('${listName}', ${i})">
            <span class="shopping-item-name">${item.name}</span>
        </div>
    `).join('');
}

function toggleShoppingItem(listName, index) {
    const lists = getStorage(STORAGE.SHOPPING) || {};
    if (lists[listName] && lists[listName][index]) {
        lists[listName][index].checked = !lists[listName][index].checked;
        setStorage(STORAGE.SHOPPING, lists);
        loadShoppingList();
    }
}

function openAddShoppingModal() {
    openModal(`
        <div class="modal-header">
            <h2 class="modal-title">Add Item</h2>
            <button class="modal-close" onclick="closeModal()">Ã—</button>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label>Item</label>
                <input type="text" class="form-input" id="shopping-item-input" placeholder="e.g., 2 lbs salmon">
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
            <button class="btn btn-primary" onclick="saveShoppingItem()">Add</button>
        </div>
    `);
}

function saveShoppingItem() {
    const name = document.getElementById('shopping-item-input').value.trim();
    if (!name) return;

    const listName = document.getElementById('shopping-list-select').value;
    const lists = getStorage(STORAGE.SHOPPING) || { weekly: [] };
    if (!lists[listName]) lists[listName] = [];
    lists[listName].push({ name, checked: false });
    setStorage(STORAGE.SHOPPING, lists);
    closeModal();
    loadShoppingList();
}

function clearCheckedItems() {
    const listName = document.getElementById('shopping-list-select').value;
    const lists = getStorage(STORAGE.SHOPPING) || {};
    if (lists[listName]) {
        lists[listName] = lists[listName].filter(item => !item.checked);
        setStorage(STORAGE.SHOPPING, lists);
        loadShoppingList();
    }
}

function printShoppingList() {
    window.print();
}

// ========================================
// SMART SHOPPING LIST GENERATOR
// ========================================

// Price database for Asheville area (estimated prices)
const PRICE_DATABASE = {
    // Produce
    'tomatoes': { price: 3.99, unit: 'lb', category: 'Produce' },
    'roma tomatoes': { price: 2.99, unit: 'lb', category: 'Produce' },
    'cherry tomatoes': { price: 4.99, unit: 'container', category: 'Produce' },
    'spinach': { price: 4.99, unit: 'bag', category: 'Produce' },
    'baby spinach': { price: 5.99, unit: 'bag', category: 'Produce' },
    'bell peppers': { price: 1.49, unit: 'each', category: 'Produce' },
    'red bell pepper': { price: 1.49, unit: 'each', category: 'Produce' },
    'onion': { price: 0.99, unit: 'each', category: 'Produce' },
    'onions': { price: 0.99, unit: 'each', category: 'Produce' },
    'garlic': { price: 0.79, unit: 'bulb', category: 'Produce' },
    'lemons': { price: 0.79, unit: 'each', category: 'Produce' },
    'lemon': { price: 0.79, unit: 'each', category: 'Produce' },
    'zucchini': { price: 1.99, unit: 'each', category: 'Produce' },
    'cucumber': { price: 1.29, unit: 'each', category: 'Produce' },
    'carrots': { price: 2.49, unit: 'bag', category: 'Produce' },
    'avocado': { price: 1.99, unit: 'each', category: 'Produce' },
    'potatoes': { price: 3.99, unit: 'bag', category: 'Produce' },
    'sweet potato': { price: 1.49, unit: 'each', category: 'Produce' },
    'kale': { price: 2.99, unit: 'bunch', category: 'Produce' },
    'mixed greens': { price: 5.99, unit: 'container', category: 'Produce' },
    'herbs': { price: 2.99, unit: 'bunch', category: 'Produce' },
    'basil': { price: 2.99, unit: 'bunch', category: 'Produce' },
    'parsley': { price: 1.99, unit: 'bunch', category: 'Produce' },
    'cilantro': { price: 1.49, unit: 'bunch', category: 'Produce' },

    // Proteins
    'chicken breast': { price: 6.99, unit: 'lb', category: 'Proteins' },
    'chicken breasts': { price: 6.99, unit: 'lb', category: 'Proteins' },
    'chicken thighs': { price: 4.99, unit: 'lb', category: 'Proteins' },
    'salmon': { price: 12.99, unit: 'lb', category: 'Proteins' },
    'salmon fillet': { price: 12.99, unit: 'lb', category: 'Proteins' },
    'cod': { price: 10.99, unit: 'lb', category: 'Proteins' },
    'cod fillet': { price: 10.99, unit: 'lb', category: 'Proteins' },
    'shrimp': { price: 11.99, unit: 'lb', category: 'Proteins' },
    'ground beef': { price: 7.99, unit: 'lb', category: 'Proteins' },
    'ground turkey': { price: 6.99, unit: 'lb', category: 'Proteins' },
    'eggs': { price: 4.99, unit: 'dozen', category: 'Proteins' },
    'tofu': { price: 3.49, unit: 'block', category: 'Proteins' },

    // Dairy
    'greek yogurt': { price: 5.99, unit: 'container', category: 'Dairy' },
    'feta cheese': { price: 5.99, unit: 'container', category: 'Dairy' },
    'parmesan': { price: 7.99, unit: 'wedge', category: 'Dairy' },
    'mozzarella': { price: 4.99, unit: 'ball', category: 'Dairy' },
    'milk': { price: 4.49, unit: 'gallon', category: 'Dairy' },
    'butter': { price: 5.49, unit: 'lb', category: 'Dairy' },

    // Pantry Items
    'olive oil': { price: 12.99, unit: 'bottle', category: 'Pantry' },
    'chickpeas': { price: 1.49, unit: 'can', category: 'Pantry' },
    'canned tomatoes': { price: 1.99, unit: 'can', category: 'Pantry' },
    'diced tomatoes': { price: 1.99, unit: 'can', category: 'Pantry' },
    'pasta': { price: 2.49, unit: 'box', category: 'Pantry' },
    'rice': { price: 3.99, unit: 'bag', category: 'Pantry' },
    'quinoa': { price: 6.99, unit: 'bag', category: 'Pantry' },
    'lentils': { price: 2.99, unit: 'bag', category: 'Pantry' },
    'beans': { price: 1.49, unit: 'can', category: 'Pantry' },
    'black beans': { price: 1.49, unit: 'can', category: 'Pantry' },
    'white beans': { price: 1.49, unit: 'can', category: 'Pantry' },
    'tahini': { price: 7.99, unit: 'jar', category: 'Pantry' },
    'honey': { price: 8.99, unit: 'jar', category: 'Pantry' },
    'maple syrup': { price: 12.99, unit: 'bottle', category: 'Pantry' },
    'bread': { price: 4.99, unit: 'loaf', category: 'Pantry' },
    'pita': { price: 3.49, unit: 'pack', category: 'Pantry' },
    'tortillas': { price: 3.99, unit: 'pack', category: 'Pantry' }
};

// Category icons for shopping list display
const CATEGORY_ICONS = {
    'Produce': 'ðŸ¥¬',
    'Proteins': 'ðŸ¥©',
    'Dairy': 'ðŸ§€',
    'Pantry': 'ðŸ¥«',
    'Grains': 'ðŸŒ¾',
    'Canned Goods': 'ðŸ¥«',
    'Frozen': 'ðŸ§Š',
    'Spices': 'ðŸ§‚',
    'Condiments': 'ðŸ¯',
    'Beverages': 'ðŸ¥¤',
    'Snacks': 'ðŸª',
    'Other': 'ðŸ“¦'
};

// Typical Mediterranean staples to suggest
const TYPICAL_STAPLES = [
    { name: 'Lemons', category: 'Produce', quantity: '4-6' },
    { name: 'Olive oil', category: 'Pantry', quantity: '1 bottle' },
    { name: 'Garlic', category: 'Produce', quantity: '2 bulbs' },
    { name: 'Cherry tomatoes', category: 'Produce', quantity: '1 container' },
    { name: 'Fresh herbs (basil/parsley)', category: 'Produce', quantity: '1 bunch' },
    { name: 'Greek yogurt', category: 'Dairy', quantity: '1 container' },
    { name: 'Feta cheese', category: 'Dairy', quantity: '1 container' }
];

// Categorize an ingredient based on name
function categorizeIngredient(ingredientName) {
    const name = ingredientName.toLowerCase();

    // Proteins
    if (/chicken|salmon|cod|fish|shrimp|beef|turkey|pork|lamb|tofu|eggs?|protein/.test(name)) {
        return 'Proteins';
    }
    // Dairy
    if (/milk|cheese|yogurt|butter|cream|feta|parmesan|mozzarella/.test(name)) {
        return 'Dairy';
    }
    // Produce - Vegetables
    if (/tomato|spinach|pepper|onion|garlic|zucchini|cucumber|carrot|potato|kale|lettuce|greens|celery|broccoli|cauliflower|mushroom|eggplant|squash|cabbage|asparagus/.test(name)) {
        return 'Produce';
    }
    // Produce - Fruits
    if (/lemon|lime|orange|apple|banana|berry|grape|melon|avocado/.test(name)) {
        return 'Produce';
    }
    // Produce - Herbs
    if (/basil|parsley|cilantro|mint|dill|rosemary|thyme|oregano|sage|herb/.test(name)) {
        return 'Produce';
    }
    // Grains
    if (/rice|pasta|quinoa|bread|tortilla|pita|oat|wheat|grain|flour|couscous/.test(name)) {
        return 'Grains';
    }
    // Canned Goods
    if (/canned|can of|chickpea|bean|lentil|diced tomato/.test(name)) {
        return 'Canned Goods';
    }
    // Spices
    if (/spice|cumin|paprika|turmeric|cinnamon|pepper|salt|seasoning/.test(name)) {
        return 'Spices';
    }
    // Condiments/Oils
    if (/oil|vinegar|sauce|tahini|honey|maple|mustard|mayo/.test(name)) {
        return 'Pantry';
    }

    return 'Other';
}

// Parse quantity from string (returns number or null)
function parseQuantityNumber(qtyStr) {
    if (!qtyStr) return null;
    const str = qtyStr.toString().toLowerCase();

    // Extract first number found
    const match = str.match(/(\d+\.?\d*)/);
    if (match) {
        return parseFloat(match[1]);
    }

    // Handle text quantities
    if (str.includes('running low') || str.includes('low')) return 0.25;
    if (str.includes('half') || str.includes('1/2')) return 0.5;
    if (str.includes('quarter') || str.includes('1/4')) return 0.25;

    return null;
}

// Check if ingredient names match (fuzzy match)
function ingredientsMatch(ing1, ing2) {
    const name1 = ing1.toLowerCase().trim();
    const name2 = ing2.toLowerCase().trim();

    // Direct match
    if (name1 === name2) return true;

    // One contains the other
    if (name1.includes(name2) || name2.includes(name1)) return true;

    // Remove common suffixes/prefixes and compare
    const clean1 = name1.replace(/\b(fresh|dried|chopped|diced|minced|sliced|whole|large|small|medium)\b/g, '').trim();
    const clean2 = name2.replace(/\b(fresh|dried|chopped|diced|minced|sliced|whole|large|small|medium)\b/g, '').trim();

    if (clean1 === clean2) return true;
    if (clean1.includes(clean2) || clean2.includes(clean1)) return true;

    return false;
}

// Estimate cost for an item
function estimateItemCost(itemName, quantity) {
    const name = itemName.toLowerCase();

    // Try to find a match in the price database
    for (const [key, priceInfo] of Object.entries(PRICE_DATABASE)) {
        if (name.includes(key) || key.includes(name)) {
            const qty = parseQuantityNumber(quantity) || 1;
            return {
                unitPrice: priceInfo.price,
                unit: priceInfo.unit,
                totalCost: Math.round(priceInfo.price * qty * 100) / 100
            };
        }
    }

    // Default estimate based on category
    const category = categorizeIngredient(itemName);
    const defaults = {
        'Produce': 3.99,
        'Proteins': 8.99,
        'Dairy': 5.99,
        'Pantry': 3.99,
        'Grains': 3.99,
        'Canned Goods': 1.99,
        'Spices': 4.99,
        'Other': 4.99
    };

    return {
        unitPrice: defaults[category] || 4.99,
        unit: 'item',
        totalCost: defaults[category] || 4.99
    };
}

// Get week dates for current week offset
function getCurrentWeekDates() {
    const today = new Date();
    const dayOfWeek = today.getDay();
    const monday = new Date(today);
    monday.setDate(today.getDate() - dayOfWeek + (dayOfWeek === 0 ? -6 : 1) + (state.currentWeekOffset * 7));

    const dates = [];
    for (let i = 0; i < 7; i++) {
        const date = new Date(monday);
        date.setDate(monday.getDate() + i);
        dates.push(date.toISOString().split('T')[0]);
    }
    return dates;
}

// Main smart shopping list generator
function generateSmartShoppingList() {
    const mealPlans = getStorage(STORAGE.MEAL_PLANS) || {};
    const pantry = getStorage(STORAGE.PANTRY) || [];
    const library = getRecipeLibrary();
    const garden = getStorage(STORAGE.GARDEN) || [];

    // Get current week dates
    const weekDates = getCurrentWeekDates();

    // 1. Extract all ingredients from all planned meals
    const allIngredients = [];
    const mealTypes = ['breakfast', 'lunch', 'dinner', 'snacks'];

    weekDates.forEach(dateStr => {
        const dayPlan = mealPlans[dateStr];
        if (!dayPlan) return;

        // Handle both old format (single meal) and new format (multi-meal)
        if (dayPlan.recipeId) {
            // Old format - single meal
            const recipe = library.find(r => r.id === dayPlan.recipeId);
            if (recipe && recipe.ingredients) {
                recipe.ingredients.forEach(ing => {
                    allIngredients.push({
                        name: typeof ing === 'string' ? ing : ing.name || ing,
                        source: recipe.title,
                        date: dateStr
                    });
                });
            }
        } else {
            // New format - multi-meal
            mealTypes.forEach(mealType => {
                if (dayPlan[mealType]?.recipeId) {
                    const recipe = library.find(r => r.id === dayPlan[mealType].recipeId);
                    if (recipe && recipe.ingredients) {
                        recipe.ingredients.forEach(ing => {
                            allIngredients.push({
                                name: typeof ing === 'string' ? ing : ing.name || ing,
                                source: recipe.title,
                                date: dateStr,
                                mealType: mealType
                            });
                        });
                    }
                }
            });
        }
    });

    if (allIngredients.length === 0) {
        showToast('No recipes with ingredients in your meal plan. Plan some meals first!');
        return;
    }

    // 2. Consolidate duplicate ingredients
    const consolidatedIngredients = [];
    allIngredients.forEach(ing => {
        const existing = consolidatedIngredients.find(ci => ingredientsMatch(ci.name, ing.name));
        if (existing) {
            existing.sources.push(ing.source);
            existing.count++;
        } else {
            consolidatedIngredients.push({
                name: ing.name,
                sources: [ing.source],
                count: 1
            });
        }
    });

    // 3. Cross-reference with pantry
    const shoppingItems = [];
    const skippedItems = []; // Items already in pantry

    consolidatedIngredients.forEach(ingredient => {
        const inPantry = pantry.find(item => ingredientsMatch(item.name, ingredient.name));
        const inGarden = garden.find && garden.find(item => ingredientsMatch(item.name || item, ingredient.name));

        if (inGarden) {
            skippedItems.push({
                name: ingredient.name,
                reason: 'Available in garden'
            });
        } else if (!inPantry) {
            // Not in pantry - add to shopping list
            const category = categorizeIngredient(ingredient.name);
            const costInfo = estimateItemCost(ingredient.name, '1');

            shoppingItems.push({
                name: ingredient.name,
                quantity: ingredient.count > 1 ? `Need for ${ingredient.count} recipes` : '',
                category: category,
                pantryStatus: 'Not in pantry',
                pantryStatusType: 'missing',
                needed: true,
                sources: ingredient.sources,
                estimatedCost: costInfo.totalCost
            });
        } else {
            // In pantry - check status
            const status = inPantry.status || 'fresh';
            if (status === 'use-soon' || status === 'check') {
                shoppingItems.push({
                    name: ingredient.name,
                    quantity: 'Restock recommended',
                    category: categorizeIngredient(ingredient.name),
                    pantryStatus: `Have ${inPantry.qty || 'some'}, running low`,
                    pantryStatusType: 'has-some',
                    needed: true,
                    sources: ingredient.sources,
                    estimatedCost: estimateItemCost(ingredient.name, '1').totalCost
                });
            } else {
                skippedItems.push({
                    name: ingredient.name,
                    reason: `In pantry: ${inPantry.qty || 'available'}`
                });
            }
        }
    });

    // 4. Add items running low from pantry (even if not in meal plan)
    pantry.forEach(item => {
        if ((item.status === 'use-soon' || item.status === 'check') &&
            !shoppingItems.find(si => ingredientsMatch(si.name, item.name))) {
            shoppingItems.push({
                name: item.name,
                quantity: 'Restock',
                category: item.category || categorizeIngredient(item.name),
                pantryStatus: 'Running low in pantry',
                pantryStatusType: 'missing',
                needed: true,
                sources: ['Pantry restock'],
                estimatedCost: estimateItemCost(item.name, '1').totalCost
            });
        }
    });

    // 5. Generate suggestions (staples not in list or pantry)
    const suggestions = [];
    TYPICAL_STAPLES.forEach(staple => {
        const inList = shoppingItems.find(si => ingredientsMatch(si.name, staple.name));
        const inPantry = pantry.find(pi => ingredientsMatch(pi.name, staple.name));

        if (!inList && !inPantry) {
            suggestions.push({
                name: staple.name,
                quantity: staple.quantity,
                category: staple.category,
                pantryStatus: 'Typical staple - consider adding',
                pantryStatusType: 'suggestion',
                needed: false,
                estimatedCost: estimateItemCost(staple.name, staple.quantity).totalCost
            });
        }
    });

    // 6. Calculate estimated total
    const estimatedTotal = shoppingItems.reduce((sum, item) => sum + (item.estimatedCost || 0), 0);

    // 7. Group by category
    const groupedItems = {};
    shoppingItems.forEach(item => {
        if (!groupedItems[item.category]) {
            groupedItems[item.category] = [];
        }
        groupedItems[item.category].push(item);
    });

    // 8. Create list name with date
    const startDate = new Date(weekDates[0]);
    const listName = `Week of ${startDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric' })}`;

    // 9. Save to localStorage
    const lists = getStorage(STORAGE.SHOPPING) || { weekly: [] };
    const listId = `smart-${Date.now()}`;

    lists[listId] = {
        name: listName,
        generatedFrom: 'meal-plan',
        createdAt: new Date().toISOString(),
        estimatedTotal: Math.round(estimatedTotal * 100) / 100,
        suggestions: suggestions,
        skippedItems: skippedItems,
        items: shoppingItems.map(item => ({
            ...item,
            checked: false
        }))
    };

    setStorage(STORAGE.SHOPPING, lists);

    // 10. Update the dropdown and display
    updateShoppingListDropdown();
    document.getElementById('shopping-list-select').value = listId;
    loadEnhancedShoppingList(listId);

    showToast(`Shopping list created with ${shoppingItems.length} items!`);
}

// Update the shopping list dropdown with all lists
function updateShoppingListDropdown() {
    const lists = getStorage(STORAGE.SHOPPING) || { weekly: [] };
    const select = document.getElementById('shopping-list-select');

    // Clear existing options
    select.innerHTML = '<option value="weekly">Weekly Groceries</option>';

    // Add other lists
    Object.keys(lists).forEach(key => {
        if (key !== 'weekly') {
            const list = lists[key];
            const name = list.name || key;
            const option = document.createElement('option');
            option.value = key;
            option.textContent = name;
            select.appendChild(option);
        }
    });
}

// Enhanced shopping list display with pantry status
function loadEnhancedShoppingList(listId) {
    const lists = getStorage(STORAGE.SHOPPING) || { weekly: [] };
    const listData = lists[listId];

    if (!listData || !listData.items) {
        // Fall back to regular loading for simple lists
        loadShoppingList();
        return;
    }

    const container = document.getElementById('shopping-list');
    const empty = document.getElementById('shopping-empty');
    const items = listData.items;

    if (items.length === 0) {
        container.innerHTML = '';
        empty.classList.remove('hidden');
        return;
    }

    empty.classList.add('hidden');

    let html = '';

    // Summary section
    if (listData.estimatedTotal) {
        html += `
            <div class="shopping-list-summary">
                <span>Estimated Total</span>
                <span class="shopping-summary-cost">$${listData.estimatedTotal.toFixed(2)}</span>
            </div>
        `;
    }

    // Suggestions section
    if (listData.suggestions && listData.suggestions.length > 0) {
        html += `
            <div class="shopping-suggestions">
                <div class="shopping-suggestions-header">
                    <span>ðŸ’¡</span> Smart Suggestions (optional)
                </div>
                ${listData.suggestions.map((sug, i) => `
                    <div class="shopping-suggestion-item">
                        <div>
                            <div style="font-weight: 500;">${sug.name}</div>
                            <div style="font-size: 0.8rem; color: var(--gray-text);">${sug.quantity} - ${sug.pantryStatus}</div>
                        </div>
                        <button class="suggestion-add-btn" onclick="addSuggestionToList('${listId}', ${i})">+ Add</button>
                    </div>
                `).join('')}
            </div>
        `;
    }

    // Group items by category
    const grouped = {};
    items.forEach((item, index) => {
        const cat = item.category || 'Other';
        if (!grouped[cat]) grouped[cat] = [];
        grouped[cat].push({ ...item, index });
    });

    // Render by category
    const categoryOrder = ['Produce', 'Proteins', 'Dairy', 'Grains', 'Canned Goods', 'Pantry', 'Spices', 'Other'];
    categoryOrder.forEach(category => {
        if (grouped[category] && grouped[category].length > 0) {
            const icon = CATEGORY_ICONS[category] || 'ðŸ“¦';
            html += `
                <div class="shopping-category-header">
                    <span>${icon}</span>
                    <span>${category.toUpperCase()}</span>
                    <span style="font-weight: normal; color: var(--gray-text);">(${grouped[category].length})</span>
                </div>
            `;

            grouped[category].forEach(item => {
                const statusClass = item.pantryStatusType || '';
                html += `
                    <div class="shopping-item-enhanced ${item.checked ? 'checked' : ''}">
                        <input type="checkbox" class="shopping-item-checkbox"
                            ${item.checked ? 'checked' : ''}
                            onchange="toggleEnhancedShoppingItem('${listId}', ${item.index})">
                        <div class="shopping-item-content">
                            <div class="shopping-item-name-row">
                                <span class="shopping-item-name">${item.name}</span>
                                ${item.estimatedCost ? `<span class="shopping-item-qty">~$${item.estimatedCost.toFixed(2)}</span>` : ''}
                            </div>
                            ${item.pantryStatus ? `<div class="shopping-item-pantry-status ${statusClass}">${item.pantryStatusType === 'missing' ? 'âš ï¸' : 'ðŸ“'} ${item.pantryStatus}</div>` : ''}
                        </div>
                    </div>
                `;
            });
        }
    });

    // Handle categories not in the order list
    Object.keys(grouped).forEach(category => {
        if (!categoryOrder.includes(category) && grouped[category].length > 0) {
            const icon = CATEGORY_ICONS[category] || 'ðŸ“¦';
            html += `
                <div class="shopping-category-header">
                    <span>${icon}</span>
                    <span>${category.toUpperCase()}</span>
                    <span style="font-weight: normal; color: var(--gray-text);">(${grouped[category].length})</span>
                </div>
            `;

            grouped[category].forEach(item => {
                html += `
                    <div class="shopping-item-enhanced ${item.checked ? 'checked' : ''}">
                        <input type="checkbox" class="shopping-item-checkbox"
                            ${item.checked ? 'checked' : ''}
                            onchange="toggleEnhancedShoppingItem('${listId}', ${item.index})">
                        <div class="shopping-item-content">
                            <div class="shopping-item-name-row">
                                <span class="shopping-item-name">${item.name}</span>
                            </div>
                            ${item.pantryStatus ? `<div class="shopping-item-pantry-status">${item.pantryStatus}</div>` : ''}
                        </div>
                    </div>
                `;
            });
        }
    });

    container.innerHTML = html;
}

// Toggle item in enhanced shopping list
function toggleEnhancedShoppingItem(listId, index) {
    const lists = getStorage(STORAGE.SHOPPING) || {};
    if (lists[listId] && lists[listId].items && lists[listId].items[index]) {
        lists[listId].items[index].checked = !lists[listId].items[index].checked;
        setStorage(STORAGE.SHOPPING, lists);
        loadEnhancedShoppingList(listId);
    }
}

// Add a suggestion to the shopping list
function addSuggestionToList(listId, suggestionIndex) {
    const lists = getStorage(STORAGE.SHOPPING) || {};
    if (lists[listId] && lists[listId].suggestions) {
        const suggestion = lists[listId].suggestions[suggestionIndex];
        if (suggestion) {
            // Add to items
            lists[listId].items.push({
                ...suggestion,
                checked: false,
                needed: true
            });

            // Remove from suggestions
            lists[listId].suggestions.splice(suggestionIndex, 1);

            // Update estimated total
            lists[listId].estimatedTotal = (lists[listId].estimatedTotal || 0) + (suggestion.estimatedCost || 0);

            setStorage(STORAGE.SHOPPING, lists);
            loadEnhancedShoppingList(listId);
            showToast(`Added ${suggestion.name} to list`);
        }
    }
}

// Override loadShoppingList to handle both old and new format
const originalLoadShoppingList = loadShoppingList;
function loadShoppingList() {
    const listId = document.getElementById('shopping-list-select').value;
    const lists = getStorage(STORAGE.SHOPPING) || { weekly: [] };

    // Check if this is an enhanced list (has items array with objects)
    if (lists[listId] && lists[listId].items && typeof lists[listId].items[0] === 'object' && lists[listId].items[0] !== null && lists[listId].items[0].category) {
        loadEnhancedShoppingList(listId);
    } else {
        // Use original simple list rendering
        const items = Array.isArray(lists[listId]) ? lists[listId] : (lists[listId]?.items || []);
        const container = document.getElementById('shopping-list');
        const empty = document.getElementById('shopping-empty');

        if (!items || items.length === 0) {
            container.innerHTML = '';
            empty.classList.remove('hidden');
            return;
        }

        empty.classList.add('hidden');
        container.innerHTML = items.map((item, i) => {
            const name = typeof item === 'string' ? item : (item.name || item);
            const checked = typeof item === 'object' ? item.checked : false;
            return `
                <div class="shopping-item ${checked ? 'checked' : ''}">
                    <input type="checkbox" class="shopping-item-checkbox" ${checked ? 'checked' : ''} onchange="toggleShoppingItem('${listId}', ${i})">
                    <span class="shopping-item-name">${name}</span>
                </div>
            `;
        }).join('');
    }
}

// ========================================
// KITCHEN - BATCH COOKING
// ========================================

// Typical ingredients needed for each batch cooking category
const BATCH_COOKING_INGREDIENTS = {
    chicken: [
        { name: 'Chicken breast', qty: '2 lbs', alternatives: ['Chicken thighs'] },
        { name: 'Olive oil', qty: '2 tbsp', alternatives: [] },
        { name: 'Garlic', qty: '4 cloves', alternatives: ['Garlic powder'] },
        { name: 'Lemon', qty: '1', alternatives: ['Lemon juice'] },
        { name: 'Herbs (rosemary/thyme)', qty: '1 bunch', alternatives: ['Dried herbs'] }
    ],
    fish: [
        { name: 'Salmon or Cod', qty: '1.5 lbs', alternatives: ['Any white fish'] },
        { name: 'Olive oil', qty: '2 tbsp', alternatives: [] },
        { name: 'Lemon', qty: '2', alternatives: ['Lemon juice'] },
        { name: 'Dill or parsley', qty: '1 bunch', alternatives: ['Dried herbs'] },
        { name: 'Capers', qty: '2 tbsp', alternatives: [] }
    ],
    grains: [
        { name: 'Quinoa or Rice', qty: '2 cups dry', alternatives: ['Farro', 'Couscous'] },
        { name: 'Broth', qty: '4 cups', alternatives: ['Water + salt'] },
        { name: 'Olive oil', qty: '1 tbsp', alternatives: ['Butter'] }
    ],
    vegetables: [
        { name: 'Bell peppers', qty: '3-4', alternatives: [] },
        { name: 'Zucchini', qty: '2-3', alternatives: ['Yellow squash'] },
        { name: 'Onion', qty: '2', alternatives: ['Shallots'] },
        { name: 'Cherry tomatoes', qty: '1 container', alternatives: ['Roma tomatoes'] },
        { name: 'Olive oil', qty: '3 tbsp', alternatives: [] },
        { name: 'Garlic', qty: '4 cloves', alternatives: [] }
    ],
    sauce: [
        { name: 'Canned tomatoes', qty: '2 cans', alternatives: ['Fresh tomatoes'] },
        { name: 'Onion', qty: '1', alternatives: [] },
        { name: 'Garlic', qty: '6 cloves', alternatives: [] },
        { name: 'Olive oil', qty: '3 tbsp', alternatives: [] },
        { name: 'Basil', qty: '1 bunch', alternatives: ['Dried basil'] },
        { name: 'Red wine', qty: '1/2 cup', alternatives: ['Balsamic vinegar'] }
    ],
    soup: [
        { name: 'Chicken or vegetable broth', qty: '6 cups', alternatives: [] },
        { name: 'Onion', qty: '1', alternatives: [] },
        { name: 'Carrots', qty: '3', alternatives: [] },
        { name: 'Celery', qty: '3 stalks', alternatives: [] },
        { name: 'Garlic', qty: '4 cloves', alternatives: [] },
        { name: 'Potatoes or beans', qty: '2 cups', alternatives: ['Lentils'] }
    ]
};

// State to track missing items for batch cooking
let batchMissingItems = [];

function checkBatchIngredients() {
    const selectedItems = Array.from(document.querySelectorAll('[name="batchItems"]:checked')).map(c => c.value);
    const checkContainer = document.getElementById('batch-ingredient-check');
    const listContainer = document.getElementById('batch-ingredient-list');
    const missingContainer = document.getElementById('batch-missing-items');
    const missingList = document.getElementById('batch-missing-list');

    if (selectedItems.length === 0) {
        checkContainer.style.display = 'none';
        return;
    }

    checkContainer.style.display = 'block';

    const pantry = getStorage(STORAGE.PANTRY) || [];
    const results = [];
    batchMissingItems = [];

    // Check each selected category
    selectedItems.forEach(category => {
        const ingredients = BATCH_COOKING_INGREDIENTS[category] || [];

        ingredients.forEach(ing => {
            // Check if ingredient or any alternative is in pantry
            const inPantry = pantry.find(p =>
                ingredientsMatch(p.name, ing.name) ||
                ing.alternatives.some(alt => ingredientsMatch(p.name, alt))
            );

            const status = inPantry ? 'have' : 'missing';
            const pantryInfo = inPantry ? `Have ${inPantry.qty || 'some'}` : 'Need to buy';

            // Avoid duplicates
            const existing = results.find(r => ingredientsMatch(r.name, ing.name));
            if (!existing) {
                results.push({
                    name: ing.name,
                    qty: ing.qty,
                    status: status,
                    pantryInfo: pantryInfo,
                    category: category
                });

                if (status === 'missing') {
                    batchMissingItems.push({
                        name: ing.name,
                        qty: ing.qty,
                        category: categorizeIngredient(ing.name)
                    });
                }
            }
        });
    });

    // Render ingredient list
    listContainer.innerHTML = results.map(item => `
        <div class="batch-ingredient-item">
            <span class="batch-ingredient-status">${item.status === 'have' ? 'âœ…' : 'âŒ'}</span>
            <span style="flex: 1;">${item.name} (${item.qty})</span>
            <span style="font-size: 0.8rem; color: var(--gray-text);">${item.pantryInfo}</span>
        </div>
    `).join('');

    // Show missing items section if any
    if (batchMissingItems.length > 0) {
        missingContainer.style.display = 'block';
        missingList.innerHTML = batchMissingItems.map(item => `
            <div style="font-size: 0.9rem; padding: 4px 0;">â€¢ ${item.name} (${item.qty})</div>
        `).join('');
    } else {
        missingContainer.style.display = 'none';
    }
}

function addBatchMissingToShopping() {
    if (batchMissingItems.length === 0) {
        showToast('No missing items to add');
        return;
    }

    const lists = getStorage(STORAGE.SHOPPING) || { weekly: [] };
    const listId = 'batch-prep';

    lists[listId] = {
        name: 'Batch Prep Shopping',
        generatedFrom: 'batch-cooking',
        createdAt: new Date().toISOString(),
        items: batchMissingItems.map(item => ({
            name: item.name,
            quantity: item.qty,
            category: item.category,
            checked: false,
            pantryStatus: 'Needed for batch cooking',
            pantryStatusType: 'missing'
        }))
    };

    setStorage(STORAGE.SHOPPING, lists);

    // Navigate to shopping
    switchKitchenTab('shopping');
    setTimeout(() => {
        updateShoppingListDropdown();
        document.getElementById('shopping-list-select').value = listId;
        loadEnhancedShoppingList(listId);
    }, 100);

    showToast(`Added ${batchMissingItems.length} items to Batch Prep Shopping list`);
}

function generateBatchPlan() {
    const items = Array.from(document.querySelectorAll('[name="batchItems"]:checked')).map(c => c.value);
    const time = document.getElementById('batch-time').value;

    if (items.length === 0) {
        showToast('Select items to prep');
        return;
    }

    // Include pantry context in the request
    const pantry = getStorage(STORAGE.PANTRY) || [];
    const pantryContext = pantry.length > 0
        ? `\n\nMy current pantry includes: ${pantry.map(p => p.name).join(', ')}.`
        : '';

    // Check for missing items warning
    const missingWarning = batchMissingItems.length > 0
        ? `\n\nNote: I may need to buy these items first: ${batchMissingItems.map(i => i.name).join(', ')}.`
        : '';

    askNonna(`Create a batch cooking plan for: ${items.join(', ')}. I have ${time} hours available. Give me a step-by-step timeline with specific recipes and instructions.${pantryContext}${missingWarning}`);
}

// ========================================
// KITCHEN - SUBSTITUTIONS
// ========================================
function searchSubstitutions() {
    const query = document.getElementById('subs-search').value.toLowerCase();
    const resultsDiv = document.getElementById('subs-results');

    if (!query) {
        resultsDiv.innerHTML = '';
        return;
    }

    const subs = {
        'butter': 'Olive oil (use 3/4 the amount), coconut oil, or avocado',
        'milk': 'Oat milk, almond milk, or coconut milk',
        'cream': 'Coconut cream or cashew cream',
        'lemon': 'Lime juice or white wine vinegar with a pinch of sugar',
        'garlic': '1/4 tsp garlic powder per clove, or shallots',
        'onion': 'Shallots, leeks, or 1 tsp onion powder',
        'tomato': 'Red bell pepper puree or pumpkin puree',
        'basil': 'Oregano, parsley, or mint',
        'chicken broth': 'Vegetable broth or water with miso',
        'wine': 'Broth + splash of vinegar',
        'parmesan': 'Pecorino romano or nutritional yeast',
        'feta': 'Goat cheese or ricotta salata',
        'egg': 'Flax egg (1 tbsp ground flax + 3 tbsp water)'
    };

    const matches = Object.entries(subs).filter(([key]) => key.includes(query));

    if (matches.length > 0) {
        resultsDiv.innerHTML = matches.map(([key, value]) => `
            <div class="card" style="padding: 12px; margin-bottom: 8px;">
                <strong>${key}</strong> â†’ ${value}
            </div>
        `).join('');
    } else {
        resultsDiv.innerHTML = '<p class="text-muted">No substitution found. Ask Nonna!</p>';
    }
}

function toggleAccordion(header) {
    header.parentElement.classList.toggle('open');
}

function switchKitchenTab(tab) {
    document.querySelectorAll('#more-kitchen .tab').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('#more-kitchen .tab-content').forEach(c => c.classList.remove('active'));

    const tabBtn = Array.from(document.querySelectorAll('#more-kitchen .tab')).find(t => t.textContent.toLowerCase().includes(tab));
    if (tabBtn) tabBtn.classList.add('active');

    document.getElementById(`kitchen-${tab}`).classList.add('active');

    if (tab === 'pantry') renderPantry();
    if (tab === 'shopping') loadShoppingList();
}

// ========================================
// GARDEN
// ========================================
function renderGarden() {
    const profile = getStorage(STORAGE.PROFILE);
    const container = document.getElementById('garden-plants');

    if (!profile || !profile.currentlyGrowing) {
        container.innerHTML = '<p class="text-muted">No plants added. Update your profile or add plants here.</p>';
        return;
    }

    const plants = profile.currentlyGrowing.split(',').map(p => p.trim()).filter(p => p);
    container.innerHTML = plants.map(plant => `
        <div class="pantry-item">
            <span class="pantry-item-icon">ðŸŒ±</span>
            <div class="pantry-item-info">
                <div class="pantry-item-name">${plant}</div>
            </div>
        </div>
    `).join('');
}

function openAddPlantModal() {
    openModal(`
        <div class="modal-header">
            <h2 class="modal-title">Add Plant</h2>
            <button class="modal-close" onclick="closeModal()">Ã—</button>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label>Plant Name</label>
                <input type="text" class="form-input" id="plant-name-input" placeholder="e.g., Tomatoes">
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
            <button class="btn btn-primary" onclick="savePlant()">Add</button>
        </div>
    `);
}

function savePlant() {
    const name = document.getElementById('plant-name-input').value.trim();
    if (!name) return;

    const profile = getStorage(STORAGE.PROFILE) || {};
    const current = profile.currentlyGrowing || '';
    profile.currentlyGrowing = current ? `${current}, ${name}` : name;
    setStorage(STORAGE.PROFILE, profile);
    closeModal();
    renderGarden();
    showToast('Plant added!');
}

function askNonnaWithGarden() {
    const profile = getStorage(STORAGE.PROFILE);
    if (profile && profile.currentlyGrowing) {
        askNonna(`What recipes can I make with these garden items: ${profile.currentlyGrowing}?`);
    } else {
        askNonna('What should I plant in my Mediterranean herb garden?');
    }
}

function switchGardenTab(tab) {
    document.querySelectorAll('#more-garden .tab').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('#more-garden .tab-content').forEach(c => c.classList.remove('active'));

    const tabBtn = Array.from(document.querySelectorAll('#more-garden .tab')).find(t => t.textContent.toLowerCase().includes(tab.substring(0, 4)));
    if (tabBtn) tabBtn.classList.add('active');

    document.getElementById(`garden-${tab}`).classList.add('active');
}

function openLogHarvestModal() {
    openModal(`
        <div class="modal-header">
            <h2 class="modal-title">Log Harvest</h2>
            <button class="modal-close" onclick="closeModal()">Ã—</button>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label>What did you harvest?</label>
                <input type="text" class="form-input" id="harvest-item" placeholder="e.g., Tomatoes">
            </div>
            <div class="form-group">
                <label>Amount</label>
                <input type="text" class="form-input" id="harvest-amount" placeholder="e.g., 2 lbs">
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
            <button class="btn btn-primary" onclick="saveHarvest()">Log</button>
        </div>
    `);
}

function saveHarvest() {
    const item = document.getElementById('harvest-item').value.trim();
    const amount = document.getElementById('harvest-amount').value.trim();
    if (!item) return;

    const garden = getStorage(STORAGE.GARDEN) || { harvests: [] };
    garden.harvests.push({ item, amount, date: new Date().toISOString() });
    setStorage(STORAGE.GARDEN, garden);
    closeModal();
    showToast('Harvest logged!');
}

// ========================================
// CROHN'S CARE
// ========================================
function activateFlareMode() {
    state.flareMode = true;
    const prefs = getStorage(STORAGE.PREFS) || {};
    prefs.flareMode = true;
    setStorage(STORAGE.PREFS, prefs);
    updateFlareUI();
    showToast('ðŸŒ¡ï¸ Flare mode activated. Nonna will suggest gentle meals.');
    navigateTo('chat');
    askNonna("I'm having a Crohn's flare. Give me some gentle meal options for today.");
}

function deactivateFlareMode() {
    state.flareMode = false;
    const prefs = getStorage(STORAGE.PREFS) || {};
    prefs.flareMode = false;
    setStorage(STORAGE.PREFS, prefs);
    updateFlareUI();
    showToast('Flare mode deactivated');
}

function updateFlareUI() {
    const banner = document.getElementById('flare-mode-banner');
    const homeBanner = document.getElementById('home-flare-banner');
    if (banner) banner.classList.toggle('hidden', !state.flareMode);
    if (homeBanner) homeBanner.classList.toggle('hidden', !state.flareMode);
}

// ========================================
// MEAL HISTORY
// ========================================
function renderHistory() {
    const history = getStorage(STORAGE.HISTORY) || [];
    const container = document.getElementById('history-list');
    const empty = document.getElementById('history-empty');

    // Stats
    const now = new Date();
    const weekAgo = new Date(now - 7 * 24 * 60 * 60 * 1000);
    const monthAgo = new Date(now - 30 * 24 * 60 * 60 * 1000);

    const weekCount = history.filter(h => new Date(h.date) > weekAgo).length;
    const monthCount = history.filter(h => new Date(h.date) > monthAgo).length;

    document.getElementById('stat-week').textContent = weekCount;
    document.getElementById('stat-month').textContent = monthCount;

    if (history.length === 0) {
        container.innerHTML = '';
        empty.classList.remove('hidden');
        return;
    }

    empty.classList.add('hidden');
    container.innerHTML = history.slice(0, 20).map(item => `
        <div class="activity-item">
            <span class="activity-icon">ðŸ½ï¸</span>
            <div class="activity-content">
                <div class="activity-title">${item.title}</div>
                <div class="activity-time">${formatRelativeDate(item.date)}</div>
            </div>
            ${item.rating ? `<span style="color: #ffc107;">${'â­'.repeat(item.rating)}</span>` : ''}
        </div>
    `).join('');
}

function markAsCooked(recipeId, title) {
    // Open rating modal instead of directly marking
    openRatingModal(recipeId, title);
}

function openRatingModal(recipeId, title) {
    openModal(`
        <div class="modal-header">
            <h2 class="modal-title">How was it?</h2>
            <button class="modal-close" onclick="closeModal()">Ã—</button>
        </div>
        <div class="modal-body text-center">
            <p style="margin-bottom: 8px; font-size: 1.1rem;">${title}</p>
            <p class="text-muted mb-16">Rate this recipe so Nonna can remember your favorites!</p>

            <div class="star-rating" id="rating-stars" data-rating="0">
                <span class="star" data-value="1" onclick="setRatingStars(1)" onmouseover="previewRating(1)" onmouseout="resetRatingPreview()">â˜…</span>
                <span class="star" data-value="2" onclick="setRatingStars(2)" onmouseover="previewRating(2)" onmouseout="resetRatingPreview()">â˜…</span>
                <span class="star" data-value="3" onclick="setRatingStars(3)" onmouseover="previewRating(3)" onmouseout="resetRatingPreview()">â˜…</span>
                <span class="star" data-value="4" onclick="setRatingStars(4)" onmouseover="previewRating(4)" onmouseout="resetRatingPreview()">â˜…</span>
                <span class="star" data-value="5" onclick="setRatingStars(5)" onmouseover="previewRating(5)" onmouseout="resetRatingPreview()">â˜…</span>
            </div>

            <div class="form-group mt-16">
                <label style="text-align: left; display: block;">Notes (optional)</label>
                <textarea class="recipe-notes-input" id="rating-notes" placeholder="Any thoughts? Modifications you made? Tips for next time..."></textarea>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-ghost" onclick="submitRating('${recipeId}', '${title.replace(/'/g, "\\'")}', true)">Skip</button>
            <button class="btn btn-primary" onclick="submitRating('${recipeId}', '${title.replace(/'/g, "\\'")}', false)">Save Rating</button>
        </div>
    `);
}

let currentRatingValue = 0;

function setRatingStars(value) {
    currentRatingValue = value;
    const container = document.getElementById('rating-stars');
    container.dataset.rating = value;
    updateStarDisplay(value);
}

function previewRating(value) {
    updateStarDisplay(value);
}

function resetRatingPreview() {
    updateStarDisplay(currentRatingValue);
}

function updateStarDisplay(value) {
    const stars = document.querySelectorAll('#rating-stars .star');
    stars.forEach((star, index) => {
        star.classList.toggle('filled', index < value);
    });
}

function submitRating(recipeId, title, skipped) {
    const rating = skipped ? 0 : currentRatingValue;
    const notes = document.getElementById('rating-notes')?.value.trim() || '';
    const now = new Date().toISOString();

    // Add to meal history
    const history = getStorage(STORAGE.HISTORY) || [];
    history.unshift({
        type: 'cooked',
        title: title,
        recipeId: recipeId,
        date: now,
        rating: rating,
        notes: notes
    });
    setStorage(STORAGE.HISTORY, history);

    // Update recipe with cooking history and rating
    const library = getRecipeLibrary();
    const recipe = library.find(r => r.id === recipeId);
    if (recipe) {
        // Initialize cooking history if needed
        if (!recipe.cookingHistory) {
            recipe.cookingHistory = [];
        }

        // Add this cook to history
        recipe.cookingHistory.unshift({
            date: now,
            rating: rating,
            notes: notes
        });

        // Update aggregate stats
        recipe.timesCooked = (recipe.timesCooked || 0) + 1;
        recipe.lastCooked = now;

        // Calculate average rating from all rated cooks
        const ratedCooks = recipe.cookingHistory.filter(c => c.rating > 0);
        if (ratedCooks.length > 0) {
            const sum = ratedCooks.reduce((acc, c) => acc + c.rating, 0);
            recipe.averageRating = Math.round((sum / ratedCooks.length) * 10) / 10;
        }

        // Also keep single rating field for backwards compatibility
        if (rating > 0) {
            recipe.rating = rating;
        }

        setStorage(STORAGE.RECIPES, library);
    }

    closeModal();
    currentRatingValue = 0;

    if (skipped) {
        showToast('âœ… Marked as cooked!');
    } else if (rating >= 4) {
        showToast('âœ… Wonderful! Glad you enjoyed it, cara! ðŸ');
    } else if (rating >= 2) {
        showToast('âœ… Thanks for the feedback! Nonna will remember.');
    } else {
        showToast('âœ… Noted. Nonna will suggest something better next time!');
    }

    // Refresh views if they're visible
    renderRecipeLibrary();
    renderFavorites();
    renderHistory();
}

function openAddMealModal() {
    openModal(`
        <div class="modal-header">
            <h2 class="modal-title">Log Meal</h2>
            <button class="modal-close" onclick="closeModal()">Ã—</button>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label>What did you eat?</label>
                <input type="text" class="form-input" id="log-meal-input" placeholder="e.g., Grilled chicken salad">
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
            <button class="btn btn-primary" onclick="logMealManual()">Log</button>
        </div>
    `);
}

function logMealManual() {
    const title = document.getElementById('log-meal-input').value.trim();
    if (!title) return;

    const history = getStorage(STORAGE.HISTORY) || [];
    history.unshift({
        type: 'cooked',
        title: title,
        date: new Date().toISOString()
    });
    setStorage(STORAGE.HISTORY, history);
    closeModal();
    renderHistory();
    showToast('Meal logged!');
}

function addActivity(type, title) {
    const history = getStorage(STORAGE.HISTORY) || [];
    history.unshift({ type, title, date: new Date().toISOString() });
    setStorage(STORAGE.HISTORY, history.slice(0, 100)); // Keep last 100
}

// ========================================
// MODALS
// ========================================
function openModal(content) {
    document.getElementById('modal-content').innerHTML = content;
    document.getElementById('modal-overlay').classList.add('active');
}

function closeModal() {
    document.getElementById('modal-overlay').classList.remove('active');
}

function closeModalOnOverlay(event) {
    if (event.target.id === 'modal-overlay') closeModal();
}

// ========================================
// TOAST
// ========================================
function showToast(message) {
    const toast = document.getElementById('toast');
    toast.textContent = message;
    toast.classList.add('show');
    setTimeout(() => toast.classList.remove('show'), 3000);
}

// ========================================
// HELPERS
// ========================================
function formatDate(dateStr) {
    const date = new Date(dateStr);
    return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
}

function formatRelativeDate(dateStr) {
    const date = new Date(dateStr);
    const now = new Date();
    const diffMs = now - date;
    const diffDays = Math.floor(diffMs / (24 * 60 * 60 * 1000));

    if (diffDays === 0) return 'Today';
    if (diffDays === 1) return 'Yesterday';
    if (diffDays < 7) return `${diffDays} days ago`;
    return formatDate(dateStr);
}

// ========================================
// GLOBAL SEARCH
// ========================================
function handleGlobalSearch(event) {
    if (event.key === 'Enter') {
        const query = event.target.value.trim();
        if (query) {
            navigateTo('recipes');
            document.getElementById('recipes-search').value = query;
            filterRecipeLibrary();
        }
    }
}

// ========================================
// DATA MANAGEMENT
// ========================================
function exportAllData() {
    const data = {
        profile: getStorage(STORAGE.PROFILE),
        recipes: getStorage(STORAGE.RECIPES),
        favorites: getStorage(STORAGE.FAVORITES),
        mealPlans: getStorage(STORAGE.MEAL_PLANS),
        history: getStorage(STORAGE.HISTORY),
        pantry: getStorage(STORAGE.PANTRY),
        shopping: getStorage(STORAGE.SHOPPING),
        garden: getStorage(STORAGE.GARDEN),
        prefs: getStorage(STORAGE.PREFS),
        exportDate: new Date().toISOString()
    };

    const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `tavola-backup-${new Date().toISOString().split('T')[0]}.json`;
    a.click();
    URL.revokeObjectURL(url);
    showToast('Data exported!');
}

function importData() {
    const input = document.createElement('input');
    input.type = 'file';
    input.accept = '.json';
    input.onchange = async (e) => {
        const file = e.target.files[0];
        if (!file) return;

        try {
            const text = await file.text();
            const data = JSON.parse(text);

            if (data.profile) setStorage(STORAGE.PROFILE, data.profile);
            if (data.recipes) setStorage(STORAGE.RECIPES, data.recipes);
            if (data.mealPlans) setStorage(STORAGE.MEAL_PLANS, data.mealPlans);
            if (data.history) setStorage(STORAGE.HISTORY, data.history);
            if (data.pantry) setStorage(STORAGE.PANTRY, data.pantry);
            if (data.shopping) setStorage(STORAGE.SHOPPING, data.shopping);
            if (data.garden) setStorage(STORAGE.GARDEN, data.garden);
            if (data.prefs) setStorage(STORAGE.PREFS, data.prefs);

            showToast('Data imported! Refreshing...');
            setTimeout(() => location.reload(), 1000);
        } catch (err) {
            showToast('Error importing data');
        }
    };
    input.click();
}

function confirmClearAllData() {
    openModal(`
        <div class="modal-header">
            <h2 class="modal-title">âš ï¸ Clear All Data?</h2>
            <button class="modal-close" onclick="closeModal()">Ã—</button>
        </div>
        <div class="modal-body">
            <p>This will delete all your recipes, meal plans, history, and settings. This cannot be undone.</p>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
            <button class="btn" style="background: var(--danger); color: white;" onclick="clearAllData()">Delete Everything</button>
        </div>
    `);
}

function clearAllData() {
    Object.values(STORAGE).forEach(key => localStorage.removeItem(key));
    closeModal();
    location.reload();
}

// ========================================
// ONBOARDING
// ========================================
const onboardingSteps = [
    { icon: 'ðŸ‘‹', title: 'Welcome to Tavola!', text: 'Let me show you around - it\'ll just take a minute!' },
    { icon: 'ðŸ ', title: 'Dashboard', text: 'This is your home base. Quick access to everything you need.' },
    { icon: 'ðŸ“…', title: 'This Week', text: 'Plan your weekly meals here. Nonna can generate a complete plan based on your health profile.' },
    { icon: 'ðŸ“š', title: 'Recipe Library', text: 'Every recipe Nonna creates is saved here. Favorite the ones you love!' },
    { icon: 'ðŸ’¬', title: 'Chat with Nonna', text: 'Ask me anything! "What should I make with my tomatoes?" or "I\'m having a flare, give me gentle meals."' }
];

let onboardingStep = 0;

function startOnboarding() {
    onboardingStep = 0;
    document.getElementById('onboarding-overlay').classList.add('active');
    renderOnboardingStep();
}

function renderOnboardingStep() {
    const step = onboardingSteps[onboardingStep];
    const card = document.getElementById('onboarding-card');

    card.innerHTML = `
        <div class="onboarding-icon">${step.icon}</div>
        <h2 class="onboarding-title">${step.title}</h2>
        <p class="onboarding-text">${step.text}</p>
        <div class="onboarding-dots">
            ${onboardingSteps.map((_, i) => `<div class="onboarding-dot ${i === onboardingStep ? 'active' : ''}"></div>`).join('')}
        </div>
        <div class="onboarding-actions">
            ${onboardingStep > 0 ? '<button class="btn btn-ghost" onclick="prevOnboarding()">Back</button>' : ''}
            ${onboardingStep < onboardingSteps.length - 1 ?
                '<button class="btn btn-primary" onclick="nextOnboarding()">Next â†’</button>' :
                '<button class="btn btn-primary" onclick="finishOnboarding()">Get Started!</button>'
            }
        </div>
        <button class="btn btn-ghost" onclick="skipOnboarding()" style="margin-top: 12px; font-size: 0.85rem;">Skip tour</button>
    `;
}

function nextOnboarding() {
    if (onboardingStep < onboardingSteps.length - 1) {
        onboardingStep++;
        renderOnboardingStep();
    }
}

function prevOnboarding() {
    if (onboardingStep > 0) {
        onboardingStep--;
        renderOnboardingStep();
    }
}

function finishOnboarding() {
    setStorage(STORAGE.ONBOARDING, true);
    document.getElementById('onboarding-overlay').classList.remove('active');
}

function skipOnboarding() {
    setStorage(STORAGE.ONBOARDING, true);
    document.getElementById('onboarding-overlay').classList.remove('active');
}

// ========================================
// COOK MODE
// ========================================
function startCookMode(recipeId) {
    const library = getRecipeLibrary();
    const recipe = library.find(r => r.id === recipeId);
    if (!recipe || !recipe.instructions || recipe.instructions.length === 0) {
        showToast('No instructions available for cook mode');
        return;
    }

    state.cookMode = { active: true, recipe, currentStep: 0 };
    document.getElementById('cook-mode-overlay').classList.add('active');
    renderCookModeStep();
}

function renderCookModeStep() {
    const { recipe, currentStep } = state.cookMode;
    const body = document.getElementById('cook-mode-body');
    const progress = document.getElementById('cook-mode-progress');

    progress.textContent = `Step ${currentStep + 1} of ${recipe.instructions.length}`;

    body.innerHTML = `
        <details class="cook-mode-ingredients">
            <summary>ðŸ“ Ingredients (tap to expand)</summary>
            <ul style="margin-top: 12px; padding-left: 20px;">
                ${recipe.ingredients.map(i => `<li>${i}</li>`).join('')}
            </ul>
        </details>
        <div class="cook-mode-step">
            <div class="cook-mode-step-check">
                <input type="checkbox" id="step-check-${currentStep}">
                <label for="step-check-${currentStep}">${recipe.instructions[currentStep]}</label>
            </div>
            ${recipe.instructions[currentStep].match(/\d+\s*(min|minute)/i) ?
                `<div class="cook-mode-timer" onclick="startTimer()">â±ï¸ Start Timer</div>` : ''}
        </div>
    `;

    // Update nav buttons
    document.getElementById('cook-prev-btn').disabled = currentStep === 0;
    document.getElementById('cook-next-btn').textContent = currentStep === recipe.instructions.length - 1 ? 'Finish' : 'Next â†’';
}

function cookModeNext() {
    const { recipe, currentStep } = state.cookMode;
    if (currentStep < recipe.instructions.length - 1) {
        state.cookMode.currentStep++;
        renderCookModeStep();
    } else {
        exitCookMode();
        markAsCooked(recipe.id, recipe.title);
    }
}

function cookModePrev() {
    if (state.cookMode.currentStep > 0) {
        state.cookMode.currentStep--;
        renderCookModeStep();
    }
}

function exitCookMode() {
    state.cookMode = { active: false, recipe: null, currentStep: 0 };
    document.getElementById('cook-mode-overlay').classList.remove('active');
}

function startTimer() {
    showToast('â±ï¸ Timer feature coming soon!');
}

// ========================================
// RECIPE CARD MORE MENU
// ========================================
function openRecipeMoreMenu(recipeId) {
    const library = getRecipeLibrary();
    const recipe = library.find(r => r.id === recipeId);
    const isFavorited = recipe?.favorited;

    openModal(`
        <div class="modal-header">
            <h2 class="modal-title">Recipe Options</h2>
            <button class="modal-close" onclick="closeModal()">Ã—</button>
        </div>
        <div class="modal-body">
            <div class="more-menu">
                <button class="more-menu-item" onclick="closeModal(); openRatingModal('${recipeId}', '${recipe?.title?.replace(/'/g, "\\'") || 'Recipe'}');">
                    <span class="icon">â­</span>
                    <div class="more-menu-item-content">
                        <div class="more-menu-item-title">Rate Recipe</div>
                        <div class="more-menu-item-desc">Mark as cooked and rate</div>
                    </div>
                </button>
                <button class="more-menu-item" onclick="closeModal(); viewCookingHistory('${recipeId}');">
                    <span class="icon">ðŸ“‹</span>
                    <div class="more-menu-item-content">
                        <div class="more-menu-item-title">Cooking History</div>
                        <div class="more-menu-item-desc">View past ratings and notes</div>
                    </div>
                </button>
                <button class="more-menu-item" onclick="closeModal(); addIngredientsToShopping('${recipeId}');">
                    <span class="icon">ðŸ›’</span>
                    <div class="more-menu-item-content">
                        <div class="more-menu-item-title">Add to Shopping List</div>
                    </div>
                </button>
                <button class="more-menu-item" onclick="closeModal(); startCookMode('${recipeId}');">
                    <span class="icon">ðŸ‘¨â€ðŸ³</span>
                    <div class="more-menu-item-content">
                        <div class="more-menu-item-title">Start Cook Mode</div>
                    </div>
                </button>
                <button class="more-menu-item" onclick="closeModal(); printRecipe('${recipeId}');">
                    <span class="icon">ðŸ–¨ï¸</span>
                    <div class="more-menu-item-content">
                        <div class="more-menu-item-title">Print Recipe</div>
                    </div>
                </button>
                ${isFavorited ? `
                <button class="more-menu-item" onclick="closeModal(); removeFromFavorites('${recipeId}');">
                    <span class="icon">ðŸ’”</span>
                    <div class="more-menu-item-content">
                        <div class="more-menu-item-title">Remove from Favorites</div>
                        <div class="more-menu-item-desc">Keep in library</div>
                    </div>
                </button>
                ` : ''}
                <button class="more-menu-item" onclick="closeModal(); confirmDeleteRecipe('${recipeId}');">
                    <span class="icon">ðŸ—‘ï¸</span>
                    <div class="more-menu-item-content">
                        <div class="more-menu-item-title">Delete from Library</div>
                        <div class="more-menu-item-desc">Permanently remove</div>
                    </div>
                </button>
            </div>
        </div>
    `);
}

function viewCookingHistory(recipeId) {
    const library = getRecipeLibrary();
    const recipe = library.find(r => r.id === recipeId);
    if (!recipe) return;

    const history = recipe.cookingHistory || [];

    let historyHtml = '';
    if (history.length === 0) {
        historyHtml = `
            <div class="empty-state">
                <div class="empty-state-icon">ðŸ“–</div>
                <div class="empty-state-title">No cooking history yet</div>
                <p>Rate this recipe after cooking to track your history.</p>
            </div>
        `;
    } else {
        historyHtml = history.map(entry => {
            const date = new Date(entry.date).toLocaleDateString('en-US', {
                month: 'short', day: 'numeric', year: 'numeric'
            });
            const stars = entry.rating > 0 ? 'â˜…'.repeat(entry.rating) + 'â˜†'.repeat(5 - entry.rating) : 'Not rated';

            return `
                <div class="cooking-history-item">
                    <div>
                        <div class="cooking-history-date">${date}</div>
                        ${entry.notes ? `<div class="cooking-history-notes">"${entry.notes}"</div>` : ''}
                    </div>
                    <div class="cooking-history-rating">${stars}</div>
                </div>
            `;
        }).join('');
    }

    const avgRating = recipe.averageRating ? `${recipe.averageRating.toFixed(1)} average` : '';
    const timesCooked = recipe.timesCooked || 0;

    openModal(`
        <div class="modal-header">
            <h2 class="modal-title">Cooking History</h2>
            <button class="modal-close" onclick="closeModal()">Ã—</button>
        </div>
        <div class="modal-body">
            <h3 style="margin-bottom: 8px;">${recipe.title}</h3>
            <p class="text-muted mb-16">
                Cooked ${timesCooked} time${timesCooked !== 1 ? 's' : ''}
                ${avgRating ? ` Â· ${avgRating}` : ''}
            </p>
            <div class="cooking-history">
                ${historyHtml}
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeModal()">Close</button>
            <button class="btn btn-primary" onclick="closeModal(); openRatingModal('${recipeId}', '${recipe.title.replace(/'/g, "\\'")}')">Rate Again</button>
        </div>
    `);
}

function removeFromFavorites(recipeId) {
    const library = getRecipeLibrary();
    const recipe = library.find(r => r.id === recipeId);
    if (recipe) {
        recipe.favorited = false;
        setStorage(STORAGE.RECIPES, library);
        showToast('Removed from favorites');
        renderRecipeLibrary();
        renderFavorites();
    }
}

function confirmDeleteRecipe(recipeId) {
    const library = getRecipeLibrary();
    const recipe = library.find(r => r.id === recipeId);
    if (!recipe) return;

    // Check if recipe is in current week's meal plan
    const mealPlans = getStorage(STORAGE.MEAL_PLANS) || {};
    const weekDates = getWeekDates(state.currentWeekOffset);
    const isPlanned = weekDates.some(date => mealPlans[date]?.recipeId === recipeId);

    if (isPlanned) {
        openModal(`
            <div class="modal-header">
                <h2 class="modal-title">Cannot Delete</h2>
                <button class="modal-close" onclick="closeModal()">Ã—</button>
            </div>
            <div class="modal-body">
                <p>This recipe is planned for this week. Remove it from your meal plan first before deleting.</p>
            </div>
            <div class="modal-footer">
                <button class="btn btn-primary" onclick="closeModal()">OK</button>
            </div>
        `);
        return;
    }

    openModal(`
        <div class="modal-header">
            <h2 class="modal-title">Delete Recipe?</h2>
            <button class="modal-close" onclick="closeModal()">Ã—</button>
        </div>
        <div class="modal-body">
            <p><strong>${recipe.title}</strong> will be permanently deleted from your library.</p>
            <p class="text-muted mt-8">This action cannot be undone. All ratings and cooking history will be lost.</p>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
            <button class="btn btn-primary" style="background: var(--danger);" onclick="deleteRecipe('${recipeId}')">Delete</button>
        </div>
    `);
}

function addIngredientsToShopping(recipeId) {
    const library = getRecipeLibrary();
    const recipe = library.find(r => r.id === recipeId);
    if (!recipe || !recipe.ingredients) return;

    const lists = getStorage(STORAGE.SHOPPING) || { weekly: [] };
    recipe.ingredients.forEach(ing => {
        lists.weekly.push({ name: ing, checked: false });
    });
    setStorage(STORAGE.SHOPPING, lists);
    showToast('ðŸ›’ Ingredients added to shopping list!');
}

function printRecipe(recipeId) {
    window.print();
}

let lastDeletedRecipe = null;

function deleteRecipe(recipeId) {
    const library = getRecipeLibrary();
    const index = library.findIndex(r => r.id === recipeId);
    if (index >= 0) {
        // Store for undo
        lastDeletedRecipe = { ...library[index] };

        library.splice(index, 1);
        setStorage(STORAGE.RECIPES, library);
        closeModal();
        renderRecipeLibrary();
        renderFavorites();

        // Show toast with undo option
        showUndoToast('Recipe deleted', undoDeleteRecipe);
    }
}

function undoDeleteRecipe() {
    if (lastDeletedRecipe) {
        const library = getRecipeLibrary();
        library.unshift(lastDeletedRecipe);
        setStorage(STORAGE.RECIPES, library);
        lastDeletedRecipe = null;
        renderRecipeLibrary();
        renderFavorites();
        showToast('Recipe restored!');
    }
}

function showUndoToast(message, undoCallback) {
    // Remove existing toast
    const existingToast = document.querySelector('.toast');
    if (existingToast) existingToast.remove();

    const toast = document.createElement('div');
    toast.className = 'toast';
    toast.innerHTML = `
        ${message}
        <button onclick="this.parentElement.remove(); (${undoCallback.toString()})();" style="margin-left: 12px; background: none; border: none; color: var(--seafoam); cursor: pointer; font-weight: 600;">Undo</button>
    `;
    document.body.appendChild(toast);

    setTimeout(() => toast.classList.add('show'), 10);
    setTimeout(() => {
        toast.classList.remove('show');
        setTimeout(() => toast.remove(), 300);
    }, 5000);
}

// Close filter dropdown when clicking outside
document.addEventListener('click', (e) => {
    const dropdown = document.getElementById('recipe-filters');
    if (dropdown && !dropdown.contains(e.target)) {
        dropdown.classList.remove('open');
    }
});

// ========================================
// WORKOUT TRACKING
// ========================================

// MET values for calorie calculations (Metabolic Equivalent of Task)
const WORKOUT_TYPES = {
    vrboxing: { name: 'VR Boxing', icon: 'ðŸ¥Š', met: 8.5 },
    kettlebells: { name: 'Kettlebells', icon: 'ðŸ‹ï¸', met: 7.0 },
    resistancebands: { name: 'Resistance Bands', icon: 'ðŸ§˜', met: 4.0 },
    walking: { name: 'Walking', icon: 'ðŸš¶', met: 3.5 },
    running: { name: 'Running', icon: 'ðŸƒ', met: 9.8 },
    cycling: { name: 'Cycling', icon: 'ðŸš´', met: 7.5 },
    swimming: { name: 'Swimming', icon: 'ðŸŠ', met: 8.0 },
    strength: { name: 'Strength Training', icon: 'ðŸ‹ï¸', met: 6.0 },
    yoga: { name: 'Yoga', icon: 'ðŸ§˜', met: 3.0 },
    hiit: { name: 'HIIT', icon: 'âš¡', met: 12.0 },
    dancing: { name: 'Dancing', icon: 'ðŸ’ƒ', met: 6.5 },
    hiking: { name: 'Hiking', icon: 'ðŸ¥¾', met: 6.0 },
    pilates: { name: 'Pilates', icon: 'ðŸ¤¸', met: 3.5 },
    rowing: { name: 'Rowing', icon: 'ðŸš£', met: 7.0 },
    other: { name: 'Other', icon: 'ðŸ…', met: 5.0 }
};

function getWorkouts() {
    return getStorage(STORAGE.WORKOUTS) || [];
}

function saveWorkout(workout) {
    const workouts = getWorkouts();
    workouts.push(workout);
    setStorage(STORAGE.WORKOUTS, workouts);
}

function calculateCaloriesBurned(workoutType, durationMinutes, userWeight = 70) {
    // Get user weight from profile if available
    const profile = getStorage(STORAGE.PROFILE);
    const weight = profile?.weight || userWeight; // in kg

    const met = WORKOUT_TYPES[workoutType]?.met || 5.0;
    // Formula: Calories = MET Ã— weight (kg) Ã— duration (hours)
    return Math.round(met * weight * (durationMinutes / 60));
}

function getTodayStr() {
    return new Date().toISOString().split('T')[0];
}

function getWeekStartStr() {
    const now = new Date();
    const dayOfWeek = now.getDay();
    const diff = dayOfWeek === 0 ? 6 : dayOfWeek - 1; // Monday as start
    const weekStart = new Date(now);
    weekStart.setDate(now.getDate() - diff);
    return weekStart.toISOString().split('T')[0];
}

function getTodaysWorkouts() {
    const today = getTodayStr();
    return getWorkouts().filter(w => w.date === today);
}

function getWeekWorkouts() {
    const weekStart = getWeekStartStr();
    return getWorkouts().filter(w => w.date >= weekStart);
}

function getTodaysCaloriesIn() {
    // Get calories from today's logged meals
    const today = getTodayStr();
    const mealHistory = getStorage(STORAGE.HISTORY) || [];
    const todaysMeals = mealHistory.filter(m => m.date?.startsWith(today));

    // Sum up calories from meals
    let totalCalories = 0;
    todaysMeals.forEach(meal => {
        // Try to get calories from the linked recipe
        if (meal.recipeId) {
            const library = getRecipeLibrary();
            const recipe = library.find(r => r.id === meal.recipeId);
            if (recipe?.nutrition?.calories) {
                totalCalories += parseInt(recipe.nutrition.calories) || 0;
            }
        }
    });

    // Also check meal plans for today if meals are marked as cooked
    const mealPlans = getStorage(STORAGE.MEAL_PLANS) || {};
    if (mealPlans[today]?.status === 'cooked' && mealPlans[today]?.recipeId) {
        const library = getRecipeLibrary();
        const recipe = library.find(r => r.id === mealPlans[today].recipeId);
        if (recipe?.nutrition?.calories) {
            totalCalories += parseInt(recipe.nutrition.calories) || 0;
        }
    }

    return totalCalories;
}

function getTodaysCaloriesOut() {
    return getTodaysWorkouts().reduce((sum, w) => sum + (w.caloriesBurned || 0), 0);
}

function calculateStreak() {
    const workouts = getWorkouts();
    if (workouts.length === 0) return 0;

    // Get unique workout dates
    const workoutDates = [...new Set(workouts.map(w => w.date))].sort().reverse();

    const today = getTodayStr();
    const yesterday = new Date();
    yesterday.setDate(yesterday.getDate() - 1);
    const yesterdayStr = yesterday.toISOString().split('T')[0];

    // Check if there's a workout today or yesterday to continue streak
    if (workoutDates[0] !== today && workoutDates[0] !== yesterdayStr) {
        return 0;
    }

    let streak = 0;
    let currentDate = new Date(workoutDates[0]);

    for (const dateStr of workoutDates) {
        const checkDate = currentDate.toISOString().split('T')[0];
        if (dateStr === checkDate) {
            streak++;
            currentDate.setDate(currentDate.getDate() - 1);
        } else {
            break;
        }
    }

    return streak;
}

function renderWorkoutsView() {
    renderCalorieBalance();
    renderWeekStats();
    renderWorkoutCalendar();
    renderTodaysWorkouts();
}

function renderCalorieBalance() {
    const caloriesIn = getTodaysCaloriesIn();
    const caloriesOut = getTodaysCaloriesOut();
    const netCalories = caloriesIn - caloriesOut;

    // Update values
    document.getElementById('calories-in-value').textContent = caloriesIn;
    document.getElementById('calories-out-value').textContent = caloriesOut;

    // Update net display
    const netEl = document.getElementById('calorie-net');
    netEl.textContent = `${netCalories > 0 ? '+' : ''}${netCalories} cal`;
    netEl.className = 'calorie-balance-net';
    if (netCalories > 200) netEl.classList.add('surplus');
    else if (netCalories < -200) netEl.classList.add('deficit');
    else netEl.classList.add('balanced');

    // Update bars (scale to reasonable daily intake ~2000 cal)
    const maxCal = 2000;
    const inPercent = Math.min((caloriesIn / maxCal) * 100, 100);
    const outPercent = Math.min((caloriesOut / maxCal) * 100, 100);

    document.getElementById('calories-in-bar').style.width = `${inPercent}%`;
    document.getElementById('calories-out-bar').style.width = `${outPercent}%`;
}

function renderWeekStats() {
    const weekWorkouts = getWeekWorkouts();

    // Count unique workout days
    const workoutDays = new Set(weekWorkouts.map(w => w.date)).size;

    // Total minutes
    const totalMinutes = weekWorkouts.reduce((sum, w) => sum + (w.duration || 0), 0);

    // Total calories burned
    const totalCalories = weekWorkouts.reduce((sum, w) => sum + (w.caloriesBurned || 0), 0);

    // Streak
    const streak = calculateStreak();

    document.getElementById('workout-count-week').textContent = workoutDays;
    document.getElementById('workout-minutes-week').textContent = totalMinutes;
    document.getElementById('workout-calories-week').textContent = totalCalories;
    document.getElementById('workout-streak').textContent = streak;
}

function renderWorkoutCalendar() {
    const container = document.getElementById('workout-calendar-grid');
    const today = new Date();
    const dayOfWeek = today.getDay();
    const diff = dayOfWeek === 0 ? 6 : dayOfWeek - 1;
    const weekStart = new Date(today);
    weekStart.setDate(today.getDate() - diff);

    const workouts = getWorkouts();
    const days = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];

    let html = days.map(d => `<div class="workout-day-header">${d}</div>`).join('');

    for (let i = 0; i < 7; i++) {
        const date = new Date(weekStart);
        date.setDate(weekStart.getDate() + i);
        const dateStr = date.toISOString().split('T')[0];
        const isToday = dateStr === getTodayStr();
        const dayWorkouts = workouts.filter(w => w.date === dateStr);
        const hasWorkout = dayWorkouts.length > 0;

        html += `
            <div class="workout-day ${isToday ? 'today' : ''} ${hasWorkout ? 'has-workout' : ''}" onclick="showDayWorkouts('${dateStr}')">
                <span class="workout-day-date">${date.getDate()}</span>
                <span class="workout-day-indicator">${dayWorkouts.length > 0 ? dayWorkouts.length + ' ðŸ‹ï¸' : ''}</span>
            </div>
        `;
    }

    container.innerHTML = html;
}

function renderTodaysWorkouts() {
    const container = document.getElementById('workout-list-today');
    const todaysWorkouts = getTodaysWorkouts();

    if (todaysWorkouts.length === 0) {
        container.innerHTML = `
            <div class="empty-state" style="padding: 20px;">
                <div class="empty-state-icon">ðŸƒ</div>
                <div class="empty-state-title">No workouts logged today</div>
                <p class="empty-state-text">Log a workout to track your calorie burn!</p>
            </div>
        `;
        return;
    }

    container.innerHTML = todaysWorkouts.map(workout => {
        const type = WORKOUT_TYPES[workout.type] || WORKOUT_TYPES.other;
        return `
            <div class="workout-item">
                <div class="workout-item-icon">${type.icon}</div>
                <div class="workout-item-details">
                    <div class="workout-item-name">${type.name}</div>
                    <div class="workout-item-meta">${workout.duration} min${workout.notes ? ' Â· ' + workout.notes : ''}</div>
                </div>
                <div class="workout-item-calories">-${workout.caloriesBurned} cal</div>
                <div class="workout-item-actions">
                    <button class="icon-btn" onclick="deleteWorkout('${workout.id}')" title="Delete">ðŸ—‘ï¸</button>
                </div>
            </div>
        `;
    }).join('');
}

function quickLogWorkout(type, duration) {
    const workout = {
        id: 'workout_' + Date.now(),
        type: type,
        duration: duration,
        caloriesBurned: calculateCaloriesBurned(type, duration),
        date: getTodayStr(),
        time: new Date().toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' }),
        notes: ''
    };

    saveWorkout(workout);
    showToast(`${WORKOUT_TYPES[type]?.icon || 'ðŸ…'} Logged ${duration}min ${WORKOUT_TYPES[type]?.name || type}! (-${workout.caloriesBurned} cal)`);
    renderWorkoutsView();
}

function openWorkoutLogModal() {
    const typeButtons = Object.entries(WORKOUT_TYPES).map(([key, val]) => `
        <button type="button" class="workout-type-btn" data-type="${key}" onclick="selectWorkoutType('${key}')">
            <span class="workout-type-icon">${val.icon}</span>
            <span class="workout-type-name">${val.name}</span>
        </button>
    `).join('');

    openModal(`
        <div class="modal-header">
            <h2 class="modal-title">Log Workout</h2>
            <button class="modal-close" onclick="closeModal()">Ã—</button>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label>Workout Type</label>
                <div class="workout-type-grid">${typeButtons}</div>
            </div>
            <div class="form-group">
                <label>Duration (minutes)</label>
                <input type="number" class="form-input" id="workout-duration" value="30" min="1" max="300">
            </div>
            <div class="form-group">
                <label>Notes (optional)</label>
                <input type="text" class="form-input" id="workout-notes" placeholder="e.g., Morning jog, felt great">
            </div>
            <div id="workout-calorie-preview" class="text-center text-muted mb-16">
                Select a workout type to see estimated calories
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
            <button class="btn btn-primary" onclick="submitWorkoutLog()">Log Workout</button>
        </div>
    `);
}

let selectedWorkoutType = null;

function selectWorkoutType(type) {
    selectedWorkoutType = type;

    // Update button styles
    document.querySelectorAll('.workout-type-btn').forEach(btn => {
        btn.classList.toggle('selected', btn.dataset.type === type);
    });

    // Update calorie preview
    updateCaloriePreview();
}

function updateCaloriePreview() {
    const preview = document.getElementById('workout-calorie-preview');
    const duration = parseInt(document.getElementById('workout-duration')?.value) || 30;

    if (selectedWorkoutType && preview) {
        const calories = calculateCaloriesBurned(selectedWorkoutType, duration);
        preview.innerHTML = `<strong style="color: var(--success);">Estimated burn: ~${calories} calories</strong>`;
    }
}

// Update preview when duration changes
document.addEventListener('input', (e) => {
    if (e.target.id === 'workout-duration') {
        updateCaloriePreview();
    }
});

function submitWorkoutLog() {
    if (!selectedWorkoutType) {
        showToast('Please select a workout type');
        return;
    }

    const duration = parseInt(document.getElementById('workout-duration').value);
    const notes = document.getElementById('workout-notes').value.trim();

    if (!duration || duration < 1) {
        showToast('Please enter a valid duration');
        return;
    }

    const workout = {
        id: 'workout_' + Date.now(),
        type: selectedWorkoutType,
        duration: duration,
        caloriesBurned: calculateCaloriesBurned(selectedWorkoutType, duration),
        date: getTodayStr(),
        time: new Date().toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' }),
        notes: notes
    };

    saveWorkout(workout);
    selectedWorkoutType = null;
    closeModal();
    showToast(`${WORKOUT_TYPES[workout.type]?.icon || 'ðŸ…'} Workout logged! (-${workout.caloriesBurned} cal)`);
    renderWorkoutsView();
}

function deleteWorkout(workoutId) {
    const workouts = getWorkouts();
    const index = workouts.findIndex(w => w.id === workoutId);
    if (index >= 0) {
        workouts.splice(index, 1);
        setStorage(STORAGE.WORKOUTS, workouts);
        showToast('Workout deleted');
        renderWorkoutsView();
    }
}

function showDayWorkouts(dateStr) {
    const workouts = getWorkouts().filter(w => w.date === dateStr);
    const date = new Date(dateStr + 'T12:00:00'); // Add time to avoid timezone issues
    const dateDisplay = date.toLocaleDateString('en-US', { weekday: 'long', month: 'short', day: 'numeric' });

    const totalCalories = workouts.reduce((sum, w) => sum + (w.caloriesBurned || 0), 0);
    const totalMinutes = workouts.reduce((sum, w) => sum + (w.duration || 0), 0);

    const workoutList = workouts.length > 0 ? workouts.map(w => {
        const type = WORKOUT_TYPES[w.type] || WORKOUT_TYPES.other;
        return `
            <div class="workout-item">
                <div class="workout-item-icon">${type.icon}</div>
                <div class="workout-item-details">
                    <div class="workout-item-name">${type.name}</div>
                    <div class="workout-item-meta">${w.duration} min${w.time ? ' at ' + w.time : ''}${w.notes ? ' Â· ' + w.notes : ''}</div>
                </div>
                <div class="workout-item-calories">-${w.caloriesBurned} cal</div>
                <button class="icon-btn" onclick="deleteDayWorkout('${w.id}', '${dateStr}')" title="Delete">ðŸ—‘ï¸</button>
            </div>
        `;
    }).join('') : '<p class="text-center text-muted" style="padding: 16px 0;">No workouts logged yet.</p>';

    const statsHtml = workouts.length > 0 ? `
        <div class="workout-stats" style="margin-bottom: 16px;">
            <div class="workout-stat">
                <div class="workout-stat-value">${workouts.length}</div>
                <div class="workout-stat-label">Workouts</div>
            </div>
            <div class="workout-stat">
                <div class="workout-stat-value">${totalMinutes}</div>
                <div class="workout-stat-label">Minutes</div>
            </div>
            <div class="workout-stat">
                <div class="workout-stat-value">${totalCalories}</div>
                <div class="workout-stat-label">Calories</div>
            </div>
        </div>
    ` : '';

    openModal(`
        <div class="modal-header">
            <h2 class="modal-title">${dateDisplay}</h2>
            <button class="modal-close" onclick="closeModal()">Ã—</button>
        </div>
        <div class="modal-body">
            ${statsHtml}
            ${workoutList}
            <hr style="margin: 16px 0; border: none; border-top: 1px solid var(--gray-medium);">
            <button class="btn btn-primary btn-block" onclick="openWorkoutLogModalForDate('${dateStr}')">+ Log Workout for This Day</button>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeModal()">Close</button>
        </div>
    `);
}

function deleteDayWorkout(workoutId, dateStr) {
    const workouts = getWorkouts();
    const index = workouts.findIndex(w => w.id === workoutId);
    if (index >= 0) {
        workouts.splice(index, 1);
        setStorage(STORAGE.WORKOUTS, workouts);
        showToast('Workout deleted');
        showDayWorkouts(dateStr); // Refresh the modal
        renderWorkoutsView();
    }
}

function openWorkoutLogModalForDate(dateStr) {
    const date = new Date(dateStr + 'T12:00:00');
    const dateDisplay = date.toLocaleDateString('en-US', { weekday: 'long', month: 'short', day: 'numeric' });

    const typeButtons = Object.entries(WORKOUT_TYPES).map(([key, val]) => `
        <button type="button" class="workout-type-btn" data-type="${key}" onclick="selectWorkoutType('${key}')">
            <span class="workout-type-icon">${val.icon}</span>
            <span class="workout-type-name">${val.name}</span>
        </button>
    `).join('');

    openModal(`
        <div class="modal-header">
            <h2 class="modal-title">Log Workout - ${dateDisplay}</h2>
            <button class="modal-close" onclick="closeModal()">Ã—</button>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label>Workout Type</label>
                <div class="workout-type-grid">${typeButtons}</div>
            </div>
            <div class="form-group">
                <label>Duration (minutes)</label>
                <input type="number" class="form-input" id="workout-duration" value="30" min="1" max="300">
            </div>
            <div class="form-group">
                <label>Notes (optional)</label>
                <input type="text" class="form-input" id="workout-notes" placeholder="e.g., Morning session, felt great">
            </div>
            <div id="workout-calorie-preview" class="text-center text-muted mb-16">
                Select a workout type to see estimated calories
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="showDayWorkouts('${dateStr}')">Back</button>
            <button class="btn btn-primary" onclick="submitWorkoutLogForDate('${dateStr}')">Log Workout</button>
        </div>
    `);
}

function submitWorkoutLogForDate(dateStr) {
    if (!selectedWorkoutType) {
        showToast('Please select a workout type');
        return;
    }

    const duration = parseInt(document.getElementById('workout-duration').value);
    const notes = document.getElementById('workout-notes').value.trim();

    if (!duration || duration < 1) {
        showToast('Please enter a valid duration');
        return;
    }

    const workout = {
        id: 'workout_' + Date.now(),
        type: selectedWorkoutType,
        duration: duration,
        caloriesBurned: calculateCaloriesBurned(selectedWorkoutType, duration),
        date: dateStr,
        time: '',
        notes: notes
    };

    saveWorkout(workout);
    selectedWorkoutType = null;
    showToast(`${WORKOUT_TYPES[workout.type]?.icon || 'ðŸ…'} Workout logged! (-${workout.caloriesBurned} cal)`);
    showDayWorkouts(dateStr); // Go back to the day view
    renderWorkoutsView();
}

// ========================================
// WORKOUT INTEGRATION WITH NONNA
// ========================================
function formatWorkoutDataForAPI() {
    const weekWorkouts = getWeekWorkouts();
    if (weekWorkouts.length === 0) return '';

    const totalCalories = weekWorkouts.reduce((sum, w) => sum + (w.caloriesBurned || 0), 0);
    const totalMinutes = weekWorkouts.reduce((sum, w) => sum + (w.duration || 0), 0);
    const workoutDays = new Set(weekWorkouts.map(w => w.date)).size;
    const streak = calculateStreak();

    // Get activity breakdown
    const activityCounts = {};
    weekWorkouts.forEach(w => {
        activityCounts[w.type] = (activityCounts[w.type] || 0) + 1;
    });

    const activities = Object.entries(activityCounts)
        .map(([type, count]) => `${WORKOUT_TYPES[type]?.name || type}: ${count}x`)
        .join(', ');

    return `
## Workout Activity This Week
- Workouts: ${workoutDays} days, ${weekWorkouts.length} sessions
- Total active time: ${totalMinutes} minutes
- Estimated calories burned: ${totalCalories} cal
- Activities: ${activities}
- Current streak: ${streak} days
${streak >= 3 ? '(Great consistency! Consider celebrating this with a nutritious reward.)' : ''}
${totalCalories > 1500 ? '(High activity level - may need extra protein and calories for recovery.)' : ''}`;
}
</script>
</body>
</html>
