<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tavola - Mediterranean Meal Planning</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Dancing+Script:wght@600;700&family=Playfair+Display:wght@400;500;600;700&family=Lora:wght@400;500;600&family=Inter:wght@300;400;500;600&family=Montserrat:wght@400;500;600&display=swap" rel="stylesheet">
    <style>
        :root {
            /* Mediterranean Coastal Palette */
            --seafoam: #5DBAA4;
            --seafoam-dark: #4A9E8A;
            --seafoam-light: #D4F1E8;
            --cerulean: #2B7FB7;
            --cerulean-dark: #1E6A9E;
            --cerulean-light: #D9EBF7;
            --navy: #1A3A52;
            --cream: #F5F0EB;
            --charcoal: #3A3A3A;

            /* Mapped aliases (for backward compatibility with existing code) */
            --olive-green: #5DBAA4;
            --olive-dark: #4A9E8A;
            --olive-light: #D4F1E8;
            --olive-hover: #4A9E8A;
            --terracotta: #E07856;
            --terracotta-dark: #C4623E;
            --terracotta-light: #F5DDD4;
            --terracotta-hover: #C4623E;
            --mediterranean-blue: #1A3A52;
            --sun-yellow: #DAA520;

            /* Page & Section Backgrounds */
            --page-bg: #F0F7FB;
            --section-alt-seafoam: #D4F1E8;
            --section-alt-cerulean: #D9EBF7;

            /* Neutrals */
            --feta-white: #F5F5F5;
            --white: #FFFFFF;
            --warm-gray: #9CA3AF;
            --gray-light: #F5F5F5;
            --gray-medium: #E5E7EB;
            --gray-text: #6B7280;

            /* Accents */
            --tomato-red: #EF4444;
            --basil-green: #5DBAA4;
            --lemon-yellow: #DAA520;
            --accent-gold: #DAA520;
            --star-gold: #DAA520;
            --amber: #DAA520;
            --amber-light: #F5ECD4;
            --wine-primary: #722f37;
            --wine-dark: #5a252c;
            --wine-light: #8e4a51;

            /* UI States */
            --warning: #F59E0B;
            --danger: #EF4444;
            --success: #5DBAA4;
            --info: #2B7FB7;

            /* Shadows (coastal tones) */
            --shadow-sm: 0 1px 2px rgba(26, 58, 82, 0.05);
            --shadow: 0 2px 8px rgba(26, 58, 82, 0.08);
            --shadow-md: 0 4px 6px rgba(26, 58, 82, 0.1);
            --shadow-lg: 0 10px 15px rgba(26, 58, 82, 0.12);
            --shadow-xl: 0 20px 25px rgba(26, 58, 82, 0.15);

            /* Border Radius */
            --radius-sm: 4px;
            --radius: 8px;
            --radius-md: 8px;
            --radius-lg: 12px;
            --radius-xl: 16px;
            --radius-full: 9999px;

            /* Spacing */
            --space-xs: 0.25rem;
            --space-sm: 0.5rem;
            --space-md: 1rem;
            --space-lg: 1.5rem;
            --space-xl: 2rem;
            --space-2xl: 3rem;
            --space-3xl: 4rem;

            /* Typography */
            --font-heading: 'Playfair Display', 'Lora', Georgia, serif;
            --font-body: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            --font-accent: 'Montserrat', sans-serif;
            --font-script: 'Dancing Script', cursive;

            /* Extended UI Colors */
            --border-light: #E5E7EB;
            --text-muted: #9CA3AF;
            --skeleton-base: #E5E7EB;
            --skeleton-shimmer: #F3F4F6;

            /* Transition & Hover Settings */
            --transition-fast: 0.15s ease;
            --transition-normal: 0.2s ease;
            --transition-slow: 0.3s ease;
            --hover-scale: 1.02;
            --hover-scale-small: 1.01;
            --hover-scale-large: 1.05;
        }
        .dark-mode {
            --cream: #1A1A2E;
            --feta-white: #1E2A3A;
            --white: #243447;
            --navy: #E8F0F8;
            --charcoal: #E8F0F8;
            --gray-light: #2A3A4A;
            --gray-medium: #3A4A5A;
            --gray-text: #9CB3C9;
            --warm-gray: #7A90A5;
            --cerulean: #5CC8E8;
            --olive-green: #7DD4BA;
            --seafoam: #7DD4BA;
            --terracotta: #F09878;
            --page-bg: #141E2A;
            --section-alt-seafoam: #1E2E2A;
            --section-alt-cerulean: #1E2A3A;
            --shadow-sm: 0 1px 2px rgba(0, 0, 0, 0.3);
            --shadow: 0 2px 8px rgba(0, 0, 0, 0.4);
            --shadow-md: 0 4px 6px rgba(0, 0, 0, 0.45);
            --shadow-lg: 0 10px 15px rgba(0, 0, 0, 0.5);
            --shadow-xl: 0 20px 25px rgba(0, 0, 0, 0.6);
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        html, body {
            width: 100%;
            overflow-x: hidden;
        }
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background-color: #F0F7FB;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='100' height='100'%3E%3Cpath d='M 0,50 L 20,50 L 20,20 L 50,20 L 50,80 L 20,80 L 20,70 M 50,30 L 70,30 L 70,0 L 100,0 M 50,70 L 70,70 L 70,100 L 100,100 M 100,50 L 80,50 L 80,20 L 50,20 M 0,0 L 20,0 L 20,30 L 0,30 M 0,70 L 20,70 L 20,100 L 0,100' stroke='%231A3A52' stroke-width='1.5' fill='none' opacity='0.06'/%3E%3C/svg%3E");
            background-size: 100px 100px;
            background-repeat: repeat;
            color: var(--navy);
            line-height: 1.6;
            min-height: 100vh;
            padding-bottom: 80px;
        }
        .container {
            max-width: 900px;
            margin: 0 auto;
            padding: 0 16px;
            width: 100%;
        }
        main {
            width: 100%;
            background-color: #F0F7FB;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='100' height='100'%3E%3Cpath d='M 0,50 L 20,50 L 20,20 L 50,20 L 50,80 L 20,80 L 20,70 M 50,30 L 70,30 L 70,0 L 100,0 M 50,70 L 70,70 L 70,100 L 100,100 M 100,50 L 80,50 L 80,20 L 50,20 M 0,0 L 20,0 L 20,30 L 0,30 M 0,70 L 20,70 L 20,100 L 0,100' stroke='%231A3A52' stroke-width='1.5' fill='none' opacity='0.06'/%3E%3C/svg%3E");
            background-size: 100px 100px;
            background-repeat: repeat;
        }
        h1, h2, h3 { font-family: 'Lora', serif; font-weight: 500; }
        .logo { font-family: 'Dancing Script', cursive; font-size: 2rem; font-weight: 700; color: var(--cerulean); text-decoration: none; }

        /* Header */
        .header {
            background: var(--white);
            border-bottom: 1px solid var(--gray-medium);
            padding: 12px 0;
            position: sticky;
            top: 0;
            z-index: 100;
        }
        .header-content { display: flex; justify-content: space-between; align-items: center; }
        .header-right { display: flex; align-items: center; gap: 12px; }
        .header-search {
            display: flex;
            align-items: center;
            background: var(--gray-light);
            border-radius: 20px;
            padding: 6px 12px;
            gap: 8px;
            max-width: 200px;
            transition: all 0.2s ease;
        }
        .header-search:focus-within {
            box-shadow: var(--shadow-sm);
            transform: scale(1.01);
        }
        .header-search input {
            border: none;
            background: transparent;
            outline: none;
            font-size: 0.9rem;
            width: 100%;
            color: var(--navy);
        }

        /* Auth Section */
        .auth-section {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .auth-btn {
            display: flex;
            align-items: center;
            gap: 6px;
            background: var(--olive-green);
            color: white;
            border: none;
            padding: 8px 14px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            white-space: nowrap;
        }
        .auth-btn:hover {
            background: var(--olive-dark);
            transform: translateY(-1px);
        }
        .auth-btn .icon {
            font-size: 1rem;
        }
        .user-info {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .user-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            overflow: hidden;
            background: var(--olive-light);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 0.9rem;
        }
        .user-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .user-name {
            font-size: 0.85rem;
            font-weight: 500;
            color: var(--navy);
            max-width: 100px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        .sync-status {
            font-size: 0.75rem;
            color: var(--warm-gray);
            padding: 4px 8px;
            background: var(--gray-light);
            border-radius: 12px;
        }

        /* Responsive auth section */
        @media (max-width: 600px) {
            .auth-section {
                gap: 6px;
            }
            .auth-btn {
                padding: 6px 10px;
                font-size: 0.8rem;
            }
            .auth-btn span:not(.icon) {
                display: none;
            }
            .user-name {
                display: none;
            }
            .sync-status {
                font-size: 0.7rem;
                padding: 3px 6px;
            }
        }

        .icon-btn {
            background: none;
            border: none;
            padding: 8px;
            border-radius: var(--radius-sm);
            cursor: pointer;
            color: var(--navy);
            font-size: 1.2rem;
            transition: all 0.2s;
        }
        .icon-btn:hover {
            background: var(--gray-light);
            transform: scale(1.1);
        }

        /* Bottom Navigation - 5 tabs */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            width: 100%;
            background: var(--navy);
            border-top: none;
            display: flex;
            justify-content: space-around;
            padding: 6px 0 max(6px, env(safe-area-inset-bottom));
            z-index: 100;
        }
        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 6px 4px;
            border: none;
            background: none;
            color: rgba(255, 255, 255, 0.6);
            font-size: 0.6rem;
            font-family: inherit;
            cursor: pointer;
            border-radius: var(--radius-sm);
            transition: all 0.2s;
            min-width: 48px;
        }
        .nav-item span.icon { font-size: 1.4rem; margin-bottom: 2px; }
        .nav-item.active { color: #FFFFFF; background: rgba(93, 186, 164, 0.2); }
        .nav-item:hover:not(.active) {
            color: rgba(255, 255, 255, 0.85);
            background: rgba(255, 255, 255, 0.08);
            transform: translateY(-1px);
        }

        /* Buttons - Mediterranean Design */
        .btn {
            padding: var(--space-md) var(--space-xl);
            border-radius: var(--radius-md);
            font-family: var(--font-body);
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            border: none;
            min-height: 44px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: var(--space-sm);
            box-shadow: var(--shadow-sm);
        }
        .btn-primary {
            background: var(--olive-dark);
            color: white;
        }
        .btn-primary:hover {
            background: var(--olive-green);
            box-shadow: 0 4px 12px rgba(93, 186, 164, 0.3);
            transform: scale(1.03);
        }
        .btn-primary:active { transform: scale(0.97); transition: 0.1s ease-in; }
        .btn-secondary {
            background: var(--white);
            color: var(--cerulean);
            border: 2px solid var(--cerulean);
        }
        .btn-secondary:hover {
            background: var(--cerulean-light);
            box-shadow: 0 4px 12px rgba(43, 127, 183, 0.2);
            transform: scale(1.03);
        }
        .btn-secondary:active { transform: scale(0.97); transition: 0.1s ease-in; }
        .btn-ghost { background: transparent; color: var(--cerulean); box-shadow: none; border: 1px solid transparent; cursor: pointer; font-size: 0.85rem; font-weight: 500; padding: 6px 10px; border-radius: var(--radius); transition: all 0.2s ease; display: inline-flex; align-items: center; gap: 4px; }
        .btn-ghost:hover { background: var(--seafoam-light); border-color: var(--seafoam); transform: scale(1.02); }
        .btn-ghost:active { transform: scale(0.97); transition: 0.1s ease-in; }
        .btn-danger { background: var(--terracotta-dark); color: white; }
        .btn-danger:hover { background: var(--terracotta); box-shadow: 0 4px 12px rgba(224, 120, 86, 0.3); transform: scale(1.03); }
        .btn-danger:active { transform: scale(0.97); transition: 0.1s ease-in; }
        .btn-sm { padding: var(--space-sm) var(--space-md); font-size: 0.9rem; min-height: 36px; }
        .btn-block { width: 100%; }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none !important; }

        /* Cards */
        .card {
            background: var(--white);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            padding: 20px;
            margin-bottom: 16px;
            transition: transform 0.25s cubic-bezier(0.4, 0, 0.2, 1), box-shadow 0.25s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--space-md); }
        .card-title { font-size: 1.1rem; color: var(--olive-green); font-family: var(--font-heading); }

        /* Quick Action Tiles */
        .action-tiles { display: grid; grid-template-columns: repeat(2, 1fr); gap: 24px; margin-bottom: 20px; }
        .action-tile {
            background: var(--white);
            border-radius: var(--radius);
            padding: 24px;
            text-align: center;
            cursor: pointer;
            box-shadow: var(--shadow);
            transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
            border-top: 4px solid var(--cerulean);
            position: relative;
        }
        .action-tile:hover { transform: scale(1.05); box-shadow: 0 8px 24px rgba(26, 58, 82, 0.15); }
        .action-tile:active { transform: scale(0.97); transition: 0.1s ease-in; }
        .action-tile:focus-visible { outline: 2px solid var(--cerulean); outline-offset: 2px; }
        .action-tile-icon {
            width: 48px; height: 48px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            margin: 0 auto 12px; background: var(--cerulean);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            transition: filter 0.25s cubic-bezier(0.4, 0, 0.2, 1), box-shadow 0.25s ease;
        }
        .action-tile:hover .action-tile-icon { filter: brightness(1.15); box-shadow: 0 4px 12px rgba(0,0,0,0.15); }
        .action-tile-icon i, .action-tile-icon svg { width: 24px !important; height: 24px !important; color: white !important; }
        .action-tile-title { font-weight: 600; font-size: 1.05rem; color: var(--navy); margin-bottom: 4px; line-height: 1.5; }
        .action-tile-desc { font-size: 0.85rem; color: var(--gray-text); line-height: 1.5; }
        /* Category color variants */
        .action-tile.tile-cerulean { border-top-color: var(--cerulean); }
        .action-tile.tile-cerulean .action-tile-icon { background: var(--cerulean); }
        .action-tile.tile-seafoam { border-top-color: var(--seafoam); }
        .action-tile.tile-seafoam .action-tile-icon { background: var(--seafoam); }
        .action-tile.tile-navy { border-top-color: var(--navy); }
        .action-tile.tile-navy .action-tile-icon { background: var(--navy); }
        .action-tile.tile-amber { border-top-color: var(--amber); }
        .action-tile.tile-amber .action-tile-icon { background: var(--amber); }
        @media (max-width: 639px) {
            .action-tiles { grid-template-columns: 1fr; gap: 16px; }
        }
        @media (min-width: 640px) and (max-width: 1024px) {
            .action-tiles { gap: 16px; }
        }

        /* Stats Bar */
        .stats-bar {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
            background: var(--white);
            border-radius: var(--radius);
            padding: 12px;
            margin-bottom: 16px;
            box-shadow: var(--shadow);
        }
        @media (min-width: 640px) { .stats-bar { grid-template-columns: repeat(4, 1fr); } }
        .stat-item { display: flex; align-items: center; gap: 8px; font-size: 0.85rem; }
        .stat-item .icon { font-size: 1.1rem; }

        /* Forms */
        .form-group { margin-bottom: 16px; }
        .form-group label { display: block; font-weight: 500; margin-bottom: 6px; font-size: 0.95rem; }
        .form-input, .form-select, .form-textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--gray-medium);
            border-radius: var(--radius-sm);
            font-family: inherit;
            font-size: 1rem;
            color: var(--navy);
            background: var(--white);
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        .form-input:focus, .form-select:focus, .form-textarea:focus {
            outline: none;
            border-color: var(--cerulean);
            border-width: 2px;
            box-shadow: 0 0 0 3px rgba(43, 127, 183, 0.1);
        }
        .form-textarea { min-height: 80px; resize: vertical; }
        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
        @media (max-width: 600px) { .form-row { grid-template-columns: 1fr; } }
        .checkbox-item, .radio-item { display: flex; align-items: center; gap: 10px; padding: 8px 0; cursor: pointer; }
        .checkbox-item input, .radio-item input { width: 20px; height: 20px; accent-color: var(--cerulean); cursor: pointer; }

        /* Tags */
        .tag {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 500;
            background: var(--seafoam-light);
            color: var(--navy);
            margin-right: 6px;
            margin-bottom: 6px;
        }
        /* Health Tags (Green shades) */
        .tag-crohns { background: #e8f5e9; color: #2e7d32; }
        .tag-heart { background: #ffebee; color: #c62828; }
        .tag-bp { background: #fce4ec; color: #ad1457; }
        .tag-diabetic { background: #fff3e0; color: #e65100; }
        .tag-anti-inflammatory { background: #e8f5e9; color: #1b5e20; }
        .tag-low-sodium { background: #f3e5f5; color: #7b1fa2; }
        .tag-low-carb { background: #fff8e1; color: #ff6f00; }
        .tag-gut-friendly { background: #e0f2f1; color: #00695c; }
        .tag-gluten-free { background: #fbe9e7; color: #bf360c; }

        /* Prep Tags (Orange/Yellow shades) */
        .tag-quick { background: #fff3e0; color: #ef6c00; }
        .tag-meal-prep { background: #fff8e1; color: #f57f17; }
        .tag-freezer { background: #e3f2fd; color: #0277bd; }
        .tag-one-pot { background: #f1f8e9; color: #558b2f; }

        /* Flavor/Style Tags (Blue/Purple shades) */
        .tag-mediterranean { background: #e3f2fd; color: #1565c0; }
        .tag-citrus { background: #fffde7; color: #f9a825; }
        .tag-garlic { background: #efebe9; color: #5d4037; }
        .tag-spicy { background: #ffebee; color: #d32f2f; }
        .tag-comfort { background: #fce4ec; color: #c2185b; }
        .tag-fresh { background: #e8f5e9; color: #388e3c; }

        /* Protein Tags */
        .tag-fish { background: #e1f5fe; color: #0277bd; }
        .tag-chicken { background: #fff8e1; color: #f57c00; }
        .tag-vegetarian { background: #f1f8e9; color: #689f38; }
        .tag-high-protein { background: #ffecb3; color: #ff6f00; }

        /* Tag Filter Chips */
        .tag-filter-section {
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid var(--gray-medium);
        }
        .tag-filter-label {
            font-weight: 500;
            font-size: 0.9rem;
            margin-bottom: 8px;
            display: block;
        }
        .tag-filter-chips {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
        }
        .tag-filter-chip {
            padding: 4px 10px;
            border-radius: 16px;
            font-size: 0.75rem;
            cursor: pointer;
            border: 1px solid var(--gray-medium);
            background: var(--white);
            color: var(--gray-text);
            transition: all 0.2s;
        }
        .tag-filter-chip:hover {
            border-color: var(--cerulean);
            color: var(--cerulean);
        }
        .tag-filter-chip.active {
            background: var(--cerulean);
            color: white;
            border-color: var(--cerulean);
        }
        .tag-filter-clear {
            font-size: 0.75rem;
            color: var(--cerulean);
            cursor: pointer;
            margin-top: 8px;
            display: none;
        }
        .tag-filter-clear.visible {
            display: inline-block;
        }
        .tag-filter-clear:hover {
            text-decoration: underline;
        }

        /* Nutrition Info Box */
        .nutrition-box {
            background: var(--gray-light);
            border-radius: var(--radius-sm);
            padding: 12px 16px;
            margin: 12px 0;
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
            font-size: 0.85rem;
        }
        @media (min-width: 500px) {
            .nutrition-box { grid-template-columns: repeat(6, 1fr); }
        }
        .nutrition-item {
            text-align: center;
        }
        .nutrition-value {
            font-weight: 600;
            color: var(--cerulean);
            font-size: 1rem;
        }
        .nutrition-label {
            font-size: 0.7rem;
            color: var(--gray-text);
            text-transform: uppercase;
        }

        /* Health Benefits Box */
        .health-benefits {
            background: linear-gradient(135deg, var(--seafoam-light) 0%, #e8f5e9 100%);
            border-left: 4px solid var(--success);
            border-radius: 0 var(--radius-sm) var(--radius-sm) 0;
            padding: 12px 16px;
            margin: 12px 0;
        }
        .health-benefits-title {
            font-weight: 600;
            color: var(--success);
            margin-bottom: 6px;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .health-benefits-text {
            font-size: 0.9rem;
            color: var(--navy);
        }

        /* Workout Dashboard */
        .workout-stats {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-bottom: 20px;
        }
        @media (min-width: 500px) {
            .workout-stats { grid-template-columns: repeat(4, 1fr); }
        }
        .workout-stat {
            background: var(--white);
            border-radius: var(--radius);
            padding: 16px;
            text-align: center;
            box-shadow: var(--shadow);
        }
        .workout-stat-value {
            font-size: 1.8rem;
            font-weight: 600;
            color: var(--cerulean);
        }
        .workout-stat-label {
            font-size: 0.75rem;
            color: var(--gray-text);
            text-transform: uppercase;
            margin-top: 4px;
        }
        .workout-stat.positive .workout-stat-value { color: var(--success); }
        .workout-stat.negative .workout-stat-value { color: var(--danger); }
        .workout-stat.balance { grid-column: span 2; }
        @media (min-width: 500px) {
            .workout-stat.balance { grid-column: span 1; }
        }

        /* Calorie Balance Bar */
        .calorie-balance {
            background: var(--white);
            border-radius: var(--radius);
            padding: 16px;
            margin-bottom: 20px;
            box-shadow: var(--shadow);
        }
        .calorie-balance-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }
        .calorie-balance-title {
            font-weight: 600;
            color: var(--cerulean);
        }
        .calorie-balance-net {
            font-weight: 600;
            font-size: 1.1rem;
        }
        .calorie-balance-net.surplus { color: var(--danger); }
        .calorie-balance-net.deficit { color: var(--success); }
        .calorie-balance-net.balanced { color: var(--gray-text); }
        .calorie-bar-container {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 8px;
        }
        .calorie-bar-label {
            font-size: 0.75rem;
            color: var(--gray-text);
            width: 40px;
        }
        .calorie-bar {
            flex: 1;
            height: 20px;
            background: var(--gray-light);
            border-radius: 10px;
            overflow: hidden;
        }
        .calorie-bar-fill {
            height: 100%;
            border-radius: 10px;
            transition: width 0.3s ease;
        }
        .calorie-bar-fill.in { background: linear-gradient(90deg, var(--cerulean), var(--cerulean-light)); }
        .calorie-bar-fill.out { background: linear-gradient(90deg, var(--success), #81c784); }
        .calorie-bar-value {
            font-size: 0.8rem;
            font-weight: 500;
            width: 60px;
            text-align: right;
        }

        /* Workout Calendar */
        .workout-calendar {
            background: var(--white);
            border-radius: var(--radius);
            padding: 16px;
            margin-bottom: 20px;
            box-shadow: var(--shadow);
        }
        .workout-calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }
        .workout-calendar-title {
            font-weight: 600;
            color: var(--cerulean);
        }
        .workout-calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 4px;
        }
        .workout-day-header {
            text-align: center;
            font-size: 0.7rem;
            color: var(--gray-text);
            padding: 4px;
            font-weight: 500;
        }
        .workout-day {
            aspect-ratio: 1;
            border-radius: var(--radius-sm);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.2s;
            background: var(--gray-light);
        }
        .workout-day:hover { background: var(--seafoam-light); }
        .workout-day.today { border: 2px solid var(--cerulean); }
        .workout-day.has-workout { background: var(--seafoam); }
        .workout-day.has-workout .workout-day-indicator { display: block; }
        .workout-day-date { font-weight: 500; }
        .workout-day-indicator {
            font-size: 0.6rem;
            display: none;
        }

        /* Workout List */
        .workout-list {
            background: var(--white);
            border-radius: var(--radius);
            padding: 16px;
            box-shadow: var(--shadow);
        }
        .workout-list-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }
        .workout-list-title {
            font-weight: 600;
            color: var(--cerulean);
        }
        .workout-item {
            display: flex;
            align-items: center;
            padding: 12px;
            background: var(--gray-light);
            border-radius: var(--radius-sm);
            margin-bottom: 8px;
            gap: 12px;
        }
        .workout-item:last-child { margin-bottom: 0; }
        .workout-item-icon {
            font-size: 1.5rem;
            width: 40px;
            text-align: center;
        }
        .workout-item-details { flex: 1; }
        .workout-item-name {
            font-weight: 500;
            margin-bottom: 2px;
        }
        .workout-item-meta {
            font-size: 0.8rem;
            color: var(--gray-text);
        }
        .workout-item-calories {
            font-weight: 600;
            color: var(--success);
            font-size: 0.9rem;
        }
        .workout-item-actions {
            display: flex;
            gap: 4px;
        }

        /* Workout Form */
        .workout-type-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
            margin-bottom: 16px;
        }
        @media (min-width: 500px) {
            .workout-type-grid { grid-template-columns: repeat(4, 1fr); }
        }
        .workout-type-btn {
            padding: 12px 8px;
            border: 2px solid var(--gray-medium);
            border-radius: var(--radius-sm);
            background: var(--white);
            cursor: pointer;
            text-align: center;
            transition: all 0.2s;
        }
        .workout-type-btn:hover { border-color: var(--cerulean); }
        .workout-type-btn.selected {
            border-color: var(--cerulean);
            background: var(--seafoam-light);
        }
        .workout-type-icon { font-size: 1.5rem; display: block; margin-bottom: 4px; }
        .workout-type-name { font-size: 0.75rem; }

        /* Quick Log Presets */
        .quick-log-presets {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 16px;
        }
        .quick-log-btn {
            padding: 8px 16px;
            border-radius: 20px;
            border: 1px solid var(--gray-medium);
            background: var(--white);
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.2s;
        }
        .quick-log-btn:hover {
            border-color: var(--cerulean);
            background: var(--seafoam-light);
        }

        /* Sections */
        .section { padding: 20px 0; }
        .section-title {
            font-family: 'Lora', serif;
            font-size: 1.4rem;
            color: var(--cerulean);
            margin-bottom: 16px;
            padding-bottom: 8px;
            border-bottom: 2px solid var(--seafoam);
        }

        /* Page Headlines & Subheads */
        .page-header {
            max-width: 800px;
            margin-bottom: 40px;
        }

        .page-headline {
            font-family: 'Lora', serif;
            font-size: 28px;
            font-weight: 700;
            color: var(--navy);
            margin: 0 0 8px 0;
            line-height: 1.3;
        }

        .page-subhead {
            font-size: 16px;
            color: var(--charcoal);
            margin: 0;
            line-height: 1.6;
        }

        @media (max-width: 768px) {
            .page-headline {
                font-size: 24px;
            }
            .page-subhead {
                font-size: 14px;
            }
        }

        /* Views */
        .view { display: none; }
        .view.active { display: block; }
        #view-chat.active { display: flex; flex-direction: column; }

        /* Welcome Screen */
        .welcome-screen {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: calc(100vh - 100px);
            text-align: center;
            padding: 40px 20px;
        }
        .welcome-logo { font-family: 'Dancing Script', cursive; font-size: 4rem; color: var(--cerulean); margin-bottom: 8px; }
        .welcome-subtitle { font-family: 'Lora', serif; font-size: 1.3rem; color: var(--navy); margin-bottom: 8px; }
        .welcome-tagline { color: var(--gray-text); margin-bottom: 32px; max-width: 400px; }

        /* Chat Interface */
        .chat-container { display: flex; flex-direction: column; flex: 1; min-height: 0; }
        #view-chat { display: flex; flex-direction: column; height: calc(100vh - 130px); }
        .chat-messages { flex: 1; overflow-y: auto; padding: 16px 0; }
        .message { margin-bottom: var(--space-lg); animation: fadeIn 0.3s ease; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .message-user { display: flex; justify-content: flex-end; }
        .message-user .message-bubble {
            background: var(--seafoam-light);
            color: var(--charcoal);
            border-radius: var(--radius-lg) var(--radius-lg) 4px var(--radius-lg);
            max-width: 85%;
            padding: var(--space-md) var(--space-lg);
            box-shadow: var(--shadow-sm);
        }
        .message-assistant { display: flex; justify-content: flex-start; }
        .message-assistant .message-bubble {
            background: var(--cerulean-light);
            border-left: 4px solid var(--cerulean);
            border-radius: var(--radius-lg);
            max-width: 90%;
            padding: var(--space-lg);
            box-shadow: var(--shadow);
            line-height: 1.6;
        }
        .message-assistant .message-bubble h2,
        .message-assistant .message-bubble h3 {
            font-family: var(--font-heading);
            color: var(--terracotta);
            margin: var(--space-md) 0 var(--space-sm);
        }
        .message-assistant .message-bubble h2:first-child,
        .message-assistant .message-bubble h3:first-child { margin-top: 0; }
        .message-assistant .message-bubble ul { list-style: none; padding-left: 0; }
        .message-assistant .message-bubble ul li { padding: var(--space-xs) 0; }
        .message-assistant .message-bubble ul li::before { content: "ðŸ«’ "; margin-right: var(--space-xs); }
        .message-assistant .message-bubble strong { color: var(--olive-green); }
        .message-assistant .message-bubble em { color: var(--terracotta); font-style: italic; }
        .nonna-signature {
            font-style: italic;
            color: var(--warm-gray);
            font-size: 0.875rem;
            margin-top: var(--space-lg);
            text-align: right;
            border-top: 1px solid var(--gray-medium);
            padding-top: var(--space-sm);
        }
        .chat-input-area { background: var(--white); border-top: 1px solid var(--gray-medium); padding: 12px 0; }
        .chat-input-wrapper { display: flex; gap: 8px; align-items: flex-end; }
        .chat-input {
            flex: 1;
            border: 1px solid var(--gray-medium);
            border-radius: var(--radius);
            padding: 12px;
            font-family: inherit;
            font-size: 1rem;
            resize: none;
            min-height: 48px;
            max-height: 120px;
        }
        .chat-input:focus { outline: none; border-color: var(--cerulean); }
        .voice-btn {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            border: none;
            background: var(--gray-light);
            color: var(--navy);
            font-size: 1.3rem;
            cursor: pointer;
            transition: all 0.2s;
        }
        .voice-btn:hover { background: var(--gray-medium); }
        .voice-btn.recording { background: var(--danger); color: white; animation: pulse 1s infinite; }
        @keyframes pulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.05); } }
        .send-btn {
            width: 48px;
            height: 48px;
            border-radius: var(--radius);
            border: none;
            background: var(--cerulean);
            color: white;
            font-size: 1.2rem;
            cursor: pointer;
            transition: background 0.2s;
        }
        .send-btn:hover { background: var(--cerulean-dark); }
        .send-btn:disabled { opacity: 0.5; cursor: not-allowed; }

        /* Quick Actions */
        .quick-actions { display: flex; flex-wrap: wrap; gap: var(--space-sm); margin-top: var(--space-md); }
        .quick-action {
            background: var(--white);
            border: 2px solid var(--olive-green);
            padding: var(--space-sm) var(--space-md);
            border-radius: var(--radius-full);
            font-size: 0.85rem;
            font-weight: 500;
            color: var(--olive-green);
            cursor: pointer;
            transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: var(--shadow-sm);
        }
        .quick-action:hover {
            background: var(--olive-green);
            color: white;
            transform: scale(1.05) translateY(-2px);
            box-shadow: 0 4px 12px rgba(93, 186, 164, 0.3);
        }
        .quick-action:active { transform: scale(0.97); transition: 0.1s ease-in; }

        /* Thinking Animation - Nonna themed */
        .thinking { display: flex; align-items: center; gap: 12px; color: var(--gray-text); padding: 16px; }
        .thinking-animation {
            font-size: 2rem;
            animation: cook 1.5s ease-in-out infinite;
        }
        @keyframes cook { 0%, 100% { transform: rotate(-5deg); } 50% { transform: rotate(5deg); } }
        .thinking-text { font-style: italic; }

        /* Chat Header Bar */
        .chat-header-bar {
            display: flex; justify-content: space-between; align-items: center;
            padding: 8px 4px; border-bottom: 1px solid var(--gray-medium);
            background: var(--white); border-radius: var(--radius) var(--radius) 0 0;
        }
        .chat-title { font-family: var(--font-script); font-size: 1.3rem; color: var(--navy); margin: 0; }
        /* btn-ghost defined in general buttons section above */

        /* Conversation Panel */
        .conversation-panel {
            background: var(--white); border-bottom: 1px solid var(--gray-medium);
            max-height: 300px; overflow-y: auto;
        }
        .conversation-search { padding: 8px; }
        .conversation-search-input {
            width: 100%; padding: 8px 12px; border: 1px solid var(--gray-medium);
            border-radius: var(--radius); font-size: 0.85rem; outline: none;
        }
        .conversation-search-input:focus { border-color: var(--cerulean); }
        .conversation-item {
            padding: 12px; cursor: pointer; border-bottom: 1px solid var(--gray-light);
            transition: background 0.2s;
        }
        .conversation-item:hover {
            background: var(--seafoam-light);
            transform: translateX(2px);
        }
        .conversation-item.active { border-left: 3px solid var(--cerulean); background: var(--cerulean-light); }
        .conversation-item-title { font-weight: 500; font-size: 0.9rem; color: var(--navy); }
        .conversation-item-date { font-size: 0.75rem; color: var(--gray-text); }
        .conversation-item-preview { font-size: 0.8rem; color: var(--gray-text); margin-top: 4px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .conversation-item-actions { display: flex; gap: 4px; margin-top: 4px; }

        /* Active Plan Bar */
        .active-plan-bar {
            background: var(--cerulean-light); padding: 8px 16px;
            display: flex; align-items: center; gap: 8px;
            font-size: 0.85rem;
        }
        .plan-bar-label { font-weight: 600; color: var(--cerulean-dark); }
        .plan-bar-summary { flex: 1; color: var(--navy); }

        /* Chat Layout with Sidebar */
        .chat-layout { display: flex; flex: 1; min-height: 0; }
        .chat-main { flex: 1; display: flex; flex-direction: column; min-width: 0; }
        .chat-sidebar {
            width: 250px; background: var(--white); border-left: 1px solid var(--gray-medium);
            padding: 16px; overflow-y: auto; display: none;
        }
        .chat-sidebar-title { font-size: 0.9rem; color: var(--navy); margin-bottom: 12px; display: flex; align-items: center; gap: 6px; }
        .chat-topic-item { padding: 8px; border-radius: var(--radius); margin-bottom: 4px; font-size: 0.8rem; color: var(--gray-text); cursor: pointer; transition: background 0.2s; }
        .chat-topic-item:hover { background: var(--seafoam-light); color: var(--navy); }
        .chat-topic-badge { display: inline-block; padding: 2px 8px; border-radius: var(--radius-full); font-size: 0.7rem; font-weight: 500; margin-right: 4px; }
        .chat-topic-badge.planning { background: var(--cerulean-light); color: var(--cerulean-dark); }
        .chat-topic-badge.recipe { background: var(--seafoam-light); color: var(--seafoam-dark); }
        .chat-topic-badge.shopping { background: var(--amber-light); color: #92400e; }
        .chat-topic-badge.health { background: var(--terracotta-light); color: var(--terracotta-dark); }
        @media (min-width: 1025px) { .chat-sidebar.visible { display: block; } }

        /* Stop Button State */
        .send-btn.stop-mode { background: var(--danger); }
        .send-btn.stop-mode:hover { background: #DC2626; }

        /* Inline Chat Action Buttons */
        .chat-inline-actions {
            display: flex; flex-wrap: wrap; gap: 8px;
            margin-top: 12px; padding-top: 12px;
            border-top: 1px solid var(--gray-medium);
        }
        .chat-action-btn {
            background: var(--white); border: 1px solid var(--cerulean);
            color: var(--cerulean); padding: 6px 12px; border-radius: var(--radius-full);
            font-size: 0.8rem; font-weight: 500; cursor: pointer;
            display: inline-flex; align-items: center; gap: 4px;
            transition: all 0.2s;
        }
        .chat-action-btn:hover { background: var(--cerulean); color: white; transform: scale(1.05); box-shadow: 0 2px 8px rgba(43, 127, 183, 0.25); }
        .chat-action-btn:active { transform: scale(0.97); transition: 0.1s ease-in; }

        /* Read More / Collapsible */
        .read-more-btn {
            background: none; border: none; color: var(--cerulean);
            cursor: pointer; font-size: 0.85rem; font-weight: 500;
            margin-top: 8px; display: inline-flex; align-items: center; gap: 4px;
            padding: 0;
        }
        .read-more-btn:hover { color: var(--cerulean-dark); }

        /* Responsive Chat */
        @media (max-width: 1024px) {
            .chat-sidebar { display: none !important; }
        }
        @media (max-width: 767px) {
            .chat-inline-actions { flex-direction: column; }
            .chat-action-btn { justify-content: center; }
            .conversation-panel { max-height: 50vh; }
            .active-plan-bar { font-size: 0.8rem; flex-wrap: wrap; }
        }

        /* Recipe Card - Mediterranean Design */
        .recipe-card {
            background: var(--white);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-lg);
            overflow: hidden;
            margin: var(--space-lg) 0;
            transition: transform 0.25s cubic-bezier(0.4, 0, 0.2, 1), box-shadow 0.25s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .recipe-card:hover {
            box-shadow: 0 8px 24px rgba(26, 58, 82, 0.15);
            transform: scale(1.02) translateY(-2px);
        }
        .recipe-header {
            background: linear-gradient(135deg, var(--olive-green) 0%, var(--mediterranean-blue) 100%);
            color: white;
            padding: var(--space-lg);
            position: relative;
        }
        .recipe-title {
            font-family: var(--font-heading);
            font-size: 1.5rem;
            margin-bottom: var(--space-sm);
            padding-right: 100px;
            line-height: 1.3;
        }
        .recipe-actions { position: absolute; top: var(--space-md); right: var(--space-md); display: flex; gap: var(--space-sm); }
        .recipe-action-btn {
            background: rgba(255,255,255,0.2);
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            color: white;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 1.1rem;
        }
        .recipe-action-btn:hover { background: rgba(255,255,255,0.35); transform: scale(1.05); }
        .recipe-action-btn.favorited { background: var(--terracotta); }
        .recipe-meta {
            display: flex;
            flex-wrap: wrap;
            gap: var(--space-md);
            margin-top: var(--space-md);
            font-size: 0.9rem;
            opacity: 0.95;
        }
        .recipe-meta-item { display: flex; align-items: center; gap: var(--space-xs); }
        .recipe-tags {
            padding: var(--space-md) var(--space-lg);
            background: var(--feta-white);
            display: flex;
            flex-wrap: wrap;
            gap: var(--space-sm);
        }
        .recipe-tag {
            background: var(--white);
            color: var(--charcoal);
            padding: var(--space-xs) var(--space-md);
            border-radius: var(--radius-full);
            font-size: 0.75rem;
            font-weight: 500;
            font-family: var(--font-accent);
            border: 1px solid var(--gray-medium);
        }
        .recipe-tag.protein { background: var(--terracotta); color: white; border: none; }
        .recipe-tag.cuisine { background: var(--mediterranean-blue); color: white; border: none; }
        .recipe-tag.diet { background: var(--olive-green); color: white; border: none; }
        .recipe-body { padding: var(--space-lg); }
        .recipe-section { margin-bottom: var(--space-xl); }
        .recipe-section-title {
            font-family: var(--font-heading);
            font-size: 1.15rem;
            color: var(--terracotta);
            margin-bottom: var(--space-md);
            display: flex;
            align-items: center;
            gap: var(--space-sm);
            padding-bottom: var(--space-sm);
            border-bottom: 2px solid var(--olive-light);
        }
        .ingredient-item {
            display: flex;
            align-items: flex-start;
            gap: var(--space-sm);
            padding: var(--space-sm) 0;
            border-bottom: 1px solid var(--gray-light);
        }
        .ingredient-item:last-child { border-bottom: none; }
        .ingredient-checkbox { width: 22px; height: 22px; accent-color: var(--olive-green); cursor: pointer; flex-shrink: 0; margin-top: 2px; }
        .ingredient-text.checked { text-decoration: line-through; color: var(--warm-gray); }
        .instruction-step { display: flex; gap: var(--space-md); padding: var(--space-md) 0; border-bottom: 1px solid var(--gray-light); }
        .instruction-step:last-child { border-bottom: none; }
        .step-number {
            width: 32px;
            height: 32px;
            background: var(--olive-green);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 0.9rem;
            flex-shrink: 0;
            font-family: var(--font-accent);
        }
        .recipe-notes {
            background: linear-gradient(135deg, var(--cream) 0%, var(--feta-white) 100%);
            border-radius: var(--radius-md);
            padding: var(--space-lg);
            margin-top: var(--space-lg);
            border: 1px solid var(--olive-light);
        }
        .recipe-notes-title { font-weight: 600; margin-bottom: var(--space-sm); color: var(--olive-green); }

        /* Recipe Card Actions Bar */
        .recipe-card-actions {
            display: flex;
            gap: var(--space-sm);
            padding: var(--space-md) var(--space-lg);
            border-top: 1px solid var(--gray-light);
            background: var(--feta-white);
        }
        .recipe-card-actions .btn { flex: 1; }

        /* Nonna's Tip */
        .nonna-tip {
            background: linear-gradient(135deg, var(--cream) 0%, #fff5e6 100%);
            border-left: 4px solid var(--terracotta);
            border-radius: 0 var(--radius-md) var(--radius-md) 0;
            padding: var(--space-lg);
            margin: var(--space-lg) 0;
        }
        .nonna-tip-header { display: flex; align-items: center; gap: var(--space-sm); margin-bottom: var(--space-sm); font-weight: 600; color: var(--terracotta); }
        .nonna-tip-text { font-style: italic; color: var(--navy); line-height: 1.6; }
        .nonna-tip-signature { text-align: right; margin-top: var(--space-sm); color: var(--warm-gray); font-size: 0.9rem; font-style: italic; }

        /* Wine Pairing Section */
        .wine-pairing-section {
            background: linear-gradient(135deg, #f8f4ff 0%, #fff5f5 100%);
            border: 1px solid #d4b4d4;
            border-radius: var(--radius-md);
            margin-top: var(--space-lg);
            overflow: hidden;
        }
        .wine-pairing-header {
            display: flex;
            align-items: center;
            gap: var(--space-sm);
            padding: var(--space-md) var(--space-lg);
            cursor: pointer;
            background: linear-gradient(135deg, var(--wine-primary) 0%, var(--wine-light) 100%);
            color: white;
            font-weight: 600;
            transition: background 0.2s;
        }
        .wine-pairing-header:hover { background: linear-gradient(135deg, var(--wine-dark) 0%, var(--wine-primary) 100%); }
        .wine-pairing-icon { font-size: 1.3rem; }
        .wine-pairing-title { flex: 1; }
        .wine-pairing-toggle { font-size: 0.8rem; }
        .wine-pairing-content {
            padding: var(--space-lg);
        }
        .wine-style {
            font-size: 1.1rem;
            color: var(--wine-primary);
            margin-bottom: var(--space-sm);
        }
        .wine-reason {
            color: var(--gray-text);
            margin-bottom: var(--space-md);
            line-height: 1.5;
        }
        .wine-bottles {
            background: white;
            padding: var(--space-md);
            border-radius: var(--radius-sm);
        }
        .wine-bottles-title {
            font-weight: 600;
            color: var(--wine-primary);
            margin-bottom: var(--space-sm);
            font-size: 0.9rem;
        }
        .wine-bottle {
            padding: var(--space-xs) 0;
            font-size: 0.95rem;
        }

        /* Tabs */
        .tabs {
            display: flex;
            gap: 4px;
            background: var(--gray-light);
            padding: 4px;
            border-radius: var(--radius);
            margin-bottom: 16px;
            overflow-x: auto;
        }
        .tab {
            flex: 1;
            padding: 10px 16px;
            border: none;
            background: transparent;
            font-family: inherit;
            font-size: 0.9rem;
            font-weight: 500;
            color: var(--gray-text);
            cursor: pointer;
            border-radius: var(--radius-sm);
            white-space: nowrap;
            transition: all 0.2s;
        }
        .tab.active { background: var(--white); color: var(--cerulean); box-shadow: var(--shadow); }
        .tab:hover:not(.active) { color: var(--navy); }
        .tab-content { display: none; }
        .tab-content.active { display: block; }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 48px 24px;
            color: var(--gray-text);
        }
        .empty-state-icon { font-size: 3.5rem; margin-bottom: 16px; opacity: 0.7; }
        .empty-state-title { font-family: 'Lora', serif; font-size: 1.3rem; color: var(--navy); margin-bottom: 8px; }
        .empty-state-text { margin-bottom: 20px; max-width: 300px; margin-left: auto; margin-right: auto; }

        /* Grid */
        .grid { display: grid; gap: 16px; }
        .grid-2 { grid-template-columns: repeat(2, 1fr); }
        .grid-3 { grid-template-columns: repeat(3, 1fr); }
        @media (max-width: 768px) { .grid-2, .grid-3 { grid-template-columns: 1fr; } }
        @media (min-width: 769px) and (max-width: 1024px) { .grid-3 { grid-template-columns: repeat(2, 1fr); } }

        /* Recipe Library Card */
        .library-card {
            background: var(--white);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            overflow: hidden;
            cursor: pointer;
            transition: transform 0.25s cubic-bezier(0.4, 0, 0.2, 1), box-shadow 0.25s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
        }
        .library-card:hover { transform: scale(1.03) translateY(-2px); box-shadow: 0 6px 20px rgba(26, 58, 82, 0.12); }
        .library-card-banner {
            height: 80px;
            background: linear-gradient(135deg, var(--cerulean) 0%, var(--seafoam-dark) 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            position: relative;
        }
        .library-card-favorite {
            position: absolute;
            top: 8px;
            right: 8px;
            font-size: 1.2rem;
        }
        .library-card-body { padding: 12px; }
        .library-card-title { font-weight: 600; font-size: 0.95rem; margin-bottom: 4px; color: var(--navy); }
        .library-card-meta { font-size: 0.75rem; color: var(--gray-text); display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 6px; }
        .library-card-tags { display: flex; flex-wrap: wrap; gap: 4px; margin-top: 8px; }
        .library-card-tags .tag { font-size: 0.65rem; padding: 2px 6px; margin: 0; }
        .library-card-rating { color: var(--star-gold); font-size: 0.8rem; margin-bottom: 4px; }
        .library-card-cooked { font-size: 0.75rem; color: var(--gray-text); margin-top: 2px; }
        .card-calories {
            position: absolute;
            top: 8px;
            left: 8px;
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
        }
        .card-macros {
            font-size: 0.7rem;
            color: var(--gray-text);
            margin-bottom: 4px;
        }

        /* Star Rating */
        .star-rating {
            display: inline-flex;
            gap: 2px;
            font-size: 1.5rem;
            cursor: pointer;
        }
        .star-rating.readonly { cursor: default; }
        .star-rating.small { font-size: 1rem; }
        .star-rating .star {
            color: var(--gray-medium);
            transition: color 0.15s, transform 0.15s;
        }
        .star-rating .star.filled { color: var(--star-gold); }
        .star-rating .star.half {
            background: linear-gradient(90deg, var(--star-gold) 50%, var(--gray-medium) 50%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        .star-rating:not(.readonly) .star:hover { transform: scale(1.2); }
        .star-rating-display {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            font-size: 0.85rem;
        }
        .star-rating-display .stars { color: var(--star-gold); }
        .star-rating-display .rating-text { color: var(--gray-text); }

        /* Rating Section in Recipe Card */
        .recipe-rating-section {
            padding: 16px 20px;
            border-top: 1px solid var(--gray-light);
            background: var(--gray-light);
        }
        .recipe-rating-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }
        .recipe-rating-title { font-weight: 500; color: var(--navy); }
        .recipe-rating-stats { font-size: 0.85rem; color: var(--gray-text); }
        .recipe-notes-input {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--gray-medium);
            border-radius: var(--radius-sm);
            font-family: inherit;
            font-size: 0.9rem;
            resize: vertical;
            min-height: 60px;
            margin-top: 12px;
        }
        .recipe-notes-input:focus {
            outline: none;
            border-color: var(--cerulean);
        }

        /* Cooking History */
        .cooking-history { margin-top: 16px; }
        .cooking-history-item {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            padding: 10px 0;
            border-bottom: 1px solid var(--gray-light);
            font-size: 0.9rem;
        }
        .cooking-history-item:last-child { border-bottom: none; }
        .cooking-history-date { color: var(--gray-text); }
        .cooking-history-rating { color: var(--star-gold); }
        .cooking-history-notes {
            font-size: 0.85rem;
            color: var(--gray-text);
            font-style: italic;
            margin-top: 4px;
        }

        /* Bulk Actions */
        .bulk-actions-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 16px;
            background: var(--cerulean);
            color: white;
            border-radius: var(--radius);
            margin-bottom: 16px;
            flex-wrap: wrap;
            gap: 12px;
        }
        .bulk-count { font-weight: 500; }
        .bulk-buttons { display: flex; gap: 8px; flex-wrap: wrap; }
        .bulk-buttons .btn { font-size: 0.8rem; padding: 6px 12px; }

        /* Edit Mode Cards */
        .library-card.edit-mode {
            position: relative;
            cursor: pointer;
        }
        .library-card.edit-mode::before {
            content: '';
            position: absolute;
            top: 8px;
            left: 8px;
            width: 24px;
            height: 24px;
            border: 2px solid white;
            border-radius: 4px;
            background: rgba(255,255,255,0.3);
            z-index: 10;
        }
        .library-card.edit-mode.selected::before {
            background: var(--cerulean);
            border-color: var(--cerulean);
        }
        .library-card.edit-mode.selected::after {
            content: 'âœ“';
            position: absolute;
            top: 8px;
            left: 12px;
            color: white;
            font-weight: bold;
            font-size: 1rem;
            z-index: 11;
        }
        .library-card.edit-mode.selected {
            box-shadow: 0 0 0 3px var(--cerulean);
        }

        /* Week Planner */
        .week-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
            flex-wrap: wrap;
            gap: 12px;
        }
        .week-nav { display: flex; align-items: center; gap: 12px; }
        .week-nav-btn { background: var(--gray-light); border: none; padding: 8px 12px; border-radius: var(--radius-sm); cursor: pointer; font-size: 1rem; }
        .week-nav-btn:hover { background: var(--gray-medium); }
        .week-title { font-family: 'Lora', serif; font-size: 1.2rem; color: var(--navy); }
        .week-actions { display: flex; gap: 8px; flex-wrap: wrap; }

        .week-day {
            background: var(--white);
            border-radius: var(--radius);
            padding: 16px;
            margin-bottom: 16px;
            box-shadow: var(--shadow);
        }
        .week-day-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
        .week-day-name { font-weight: 600; color: var(--cerulean); }
        .week-day-date { font-size: 0.85rem; color: var(--gray-text); }
        .week-day-meals { display: flex; flex-direction: column; gap: 8px; }
        .week-meal-slot {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 12px;
            background: var(--gray-light);
            border-radius: var(--radius-sm);
            min-height: 52px;
        }
        .week-meal-slot.empty {
            border: 1px dashed var(--gray-medium);
            background: transparent;
            cursor: pointer;
            transition: all 0.2s;
        }
        .week-meal-slot.empty:hover {
            border-color: var(--cerulean);
            background: var(--seafoam-light);
            transform: scale(1.02);
            cursor: pointer;
        }
        .meal-slot-icon { font-size: 1.1rem; width: 24px; text-align: center; }
        .meal-slot-type {
            font-size: 0.7rem;
            text-transform: uppercase;
            color: var(--gray-text);
            font-weight: 500;
            width: 65px;
            flex-shrink: 0;
        }
        .meal-slot-content { flex: 1; min-width: 0; }
        .meal-slot-title {
            font-weight: 500;
            font-size: 0.9rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .meal-slot-calories {
            font-size: 0.75rem;
            color: var(--success);
            font-weight: 500;
        }
        .meal-slot-actions { display: flex; gap: 2px; }
        .meal-slot-actions .icon-btn { padding: 4px; font-size: 0.9rem; }
        .meal-slot-actions .confirm-btn { color: var(--success); }
        .meal-slot-actions .confirm-btn:hover { background: var(--success); color: white; }
        .meal-slot-add {
            color: var(--gray-text);
            font-size: 0.85rem;
            flex: 1;
        }
        .week-meal-slot.confirmed {
            background: linear-gradient(135deg, #e8f5e9 0%, #f1f8e9 100%);
            border: 1px solid var(--success);
        }
        .meal-confirmed-badge {
            background: var(--success);
            color: white;
            padding: 2px 8px;
            border-radius: var(--radius-full);
            font-size: 0.7rem;
            font-weight: 600;
            margin-left: var(--space-sm);
        }
        /* Confirm Meal Modal */
        .confirm-meal-recipe {
            background: var(--feta-white);
            padding: var(--space-md);
            border-radius: var(--radius-md);
            margin-bottom: var(--space-lg);
        }
        .confirm-meal-section {
            margin-bottom: var(--space-lg);
        }
        .confirm-meal-section-title {
            font-weight: 600;
            color: var(--olive-green);
            margin-bottom: var(--space-sm);
        }
        .deduction-item {
            padding: var(--space-xs) var(--space-sm);
            border-radius: var(--radius-sm);
            margin-bottom: var(--space-xs);
            font-size: 0.9rem;
        }
        .deduction-item.have {
            background: #e8f5e9;
            color: #2e7d32;
        }
        .deduction-item.missing {
            background: #fff3e0;
            color: #e65100;
        }
        .week-day-summary {
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid var(--gray-medium);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 8px;
        }
        .day-total-calories {
            font-weight: 600;
            color: var(--cerulean);
        }
        .day-workout-info {
            font-size: 0.85rem;
            color: var(--gray-text);
        }
        .day-net-calories {
            font-size: 0.85rem;
            font-weight: 500;
        }
        .day-net-calories.deficit { color: var(--success); }
        .day-net-calories.surplus { color: var(--danger); }
        .day-net-calories.balanced { color: var(--gray-text); }
        /* Legacy single meal support */
        .week-day-meal {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            background: var(--gray-light);
            border-radius: var(--radius-sm);
        }
        .week-day-meal-info { flex: 1; }
        .week-day-meal-title { font-weight: 500; }
        .week-day-meal-meta { font-size: 0.8rem; color: var(--gray-text); }
        .week-day-meal-actions { display: flex; gap: 4px; }
        .week-day-empty {
            padding: 24px;
            text-align: center;
            color: var(--gray-text);
            border: 2px dashed var(--gray-medium);
            border-radius: var(--radius-sm);
            cursor: pointer;
            transition: all 0.2s;
        }
        .week-day-empty:hover { border-color: var(--cerulean); color: var(--cerulean); }

        /* Week Plan Summary Card - FIXED READABILITY */
        .week-plan-card {
            background: linear-gradient(135deg, #1A3A52 0%, #132D40 100%);
            color: white;
            border-radius: var(--radius-lg);
            padding: var(--space-xl);
            margin: var(--space-lg) 0;
            box-shadow: var(--shadow-lg);
        }
        .week-plan-card h3 {
            color: #FFFFFF;
            font-family: var(--font-heading);
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: var(--space-lg);
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
        }
        .week-plan-item {
            padding: var(--space-sm) 0;
            border-bottom: 1px solid rgba(255,255,255,0.2);
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            gap: var(--space-md);
        }
        .week-plan-item:last-child { border-bottom: none; }
        .week-plan-item strong {
            color: #FFFFFF;
            font-size: 1.05rem;
            font-weight: 600;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
        }
        .week-plan-item span {
            color: #F0F4F8;
            font-size: 0.95rem;
        }
        .week-plan-actions {
            display: flex;
            gap: var(--space-md);
            margin-top: var(--space-lg);
        }
        .week-plan-actions .btn {
            flex: 1;
            background: white;
            color: #1A3A52;
            border: none;
            font-weight: 600;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        .week-plan-actions .btn:hover {
            background: var(--feta-white);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
            transform: translateY(-1px);
        }

        /* Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(26, 35, 50, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 20px;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s, visibility 0.3s;
        }
        .modal-overlay.active { opacity: 1; visibility: visible; }
        .modal {
            background: var(--white);
            border-radius: var(--radius-lg);
            width: 100%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: var(--shadow-lg);
        }
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 20px;
            border-bottom: 1px solid var(--gray-medium);
            position: sticky;
            top: 0;
            background: var(--white);
            z-index: 1;
        }
        .modal-title { font-family: 'Lora', serif; font-size: 1.2rem; }
        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            color: var(--gray-text);
            cursor: pointer;
            padding: 4px;
            transition: all 0.2s ease;
        }
        .modal-close:hover {
            background: var(--gray-light);
            transform: scale(1.1);
            border-radius: 4px;
        }
        .modal-body { padding: 20px; }
        .modal-footer {
            padding: 16px 20px;
            border-top: 1px solid var(--gray-medium);
            display: flex;
            justify-content: flex-end;
            gap: 12px;
        }

        /* Voice Pantry Table */
        .voice-pantry-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 16px;
        }

        .voice-pantry-table thead {
            background: var(--gray-light);
        }

        .voice-pantry-table th {
            padding: 8px;
            text-align: left;
            font-weight: 600;
            font-size: 0.9rem;
            color: var(--navy);
            border-bottom: 2px solid var(--border-light);
        }

        .voice-pantry-table td {
            padding: 8px;
            border-bottom: 1px solid var(--border-light);
            vertical-align: middle;
        }

        .voice-pantry-table .form-input-sm,
        .voice-pantry-table .form-select-sm {
            padding: 6px 8px;
            font-size: 0.9rem;
            width: 100%;
        }

        .voice-pantry-table tbody tr:hover {
            background: var(--gray-light);
        }

        /* Day Picker */
        .day-picker { display: grid; grid-template-columns: repeat(7, 1fr); gap: 8px; margin: 16px 0; }
        .day-picker-item {
            padding: 12px 8px;
            text-align: center;
            background: var(--gray-light);
            border-radius: var(--radius-sm);
            cursor: pointer;
            transition: all 0.2s;
            border: 2px solid transparent;
        }
        .day-picker-item:hover { border-color: var(--cerulean); }
        .day-picker-item.selected { background: var(--cerulean); color: white; }
        .day-picker-item .day-name { font-size: 0.7rem; text-transform: uppercase; }
        .day-picker-item .day-num { font-weight: 600; }

        /* Toggle Switch */
        .toggle { display: flex; align-items: center; gap: 12px; cursor: pointer; }
        .toggle-switch {
            width: 50px;
            height: 28px;
            background: var(--gray-medium);
            border-radius: 14px;
            position: relative;
            transition: background 0.3s;
        }
        .toggle-switch::after {
            content: '';
            position: absolute;
            top: 3px;
            left: 3px;
            width: 22px;
            height: 22px;
            background: white;
            border-radius: 50%;
            transition: transform 0.3s;
        }
        .toggle input { display: none; }
        .toggle input:checked + .toggle-switch { background: var(--cerulean); }
        .toggle input:checked + .toggle-switch::after { transform: translateX(22px); }

        /* Flare Mode Banner */
        .flare-banner {
            background: linear-gradient(135deg, #fff3e0 0%, #ffecb3 100%);
            border-left: 4px solid #ff9800;
            padding: 16px;
            margin-bottom: 16px;
            border-radius: 0 var(--radius) var(--radius) 0;
        }
        .flare-banner-title { font-weight: 600; color: #e65100; margin-bottom: 4px; }
        .flare-banner-text { font-size: 0.9rem; color: #bf360c; }

        /* More Menu */
        .more-menu { display: grid; gap: 8px; }
        .more-menu-item {
            display: flex;
            align-items: center;
            gap: 16px;
            padding: 16px;
            background: var(--white);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            cursor: pointer;
            transition: all 0.2s;
            border: none;
            width: 100%;
            text-align: left;
            font-family: inherit;
            font-size: 1rem;
            color: var(--navy);
        }
        .more-menu-item:hover { transform: translateX(4px); box-shadow: var(--shadow-lg); }
        .more-menu-item .icon { font-size: 1.5rem; width: 40px; text-align: center; }
        .more-menu-item-content { flex: 1; }
        .more-menu-item-title { font-weight: 500; }
        .more-menu-item-desc { font-size: 0.85rem; color: var(--gray-text); }

        /* Activity List */
        .activity-list { margin-top: 16px; }
        .activity-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 0;
            border-bottom: 1px solid var(--gray-light);
        }
        .activity-item:last-child { border-bottom: none; }
        .activity-icon { font-size: 1.2rem; }
        .activity-content { flex: 1; }
        .activity-title { font-size: 0.9rem; }
        .activity-time { font-size: 0.8rem; color: var(--gray-text); }

        /* Accordion */
        .accordion-item { border: 1px solid var(--gray-medium); border-radius: var(--radius-sm); margin-bottom: 8px; overflow: hidden; }
        .accordion-header {
            padding: 14px 16px;
            background: var(--gray-light);
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: 500;
        }
        .accordion-header:hover { background: var(--gray-medium); }
        .accordion-icon { transition: transform 0.3s; }
        .accordion-item.open .accordion-icon { transform: rotate(180deg); }
        .accordion-body { padding: 16px; display: none; }
        .accordion-item.open .accordion-body { display: block; }

        /* Pantry Items */
        /* Pantry Category Groups */
        .pantry-category {
            margin-bottom: 24px;
        }

        .pantry-category-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 16px;
            background: #D9EBF7;
            border-radius: var(--radius-md);
            cursor: pointer;
            transition: all 0.2s;
            margin-bottom: 12px;
        }

        .pantry-category-header:hover {
            background: #C5E2F5;
        }

        .pantry-category-header.expanded {
            background: #B8DCF3;
        }

        .pantry-category-header.has-alerts {
            background: #FFF3CD;
            border-left: 4px solid #DAA520;
        }

        .pantry-category-header-left {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .pantry-category-name {
            font-weight: 600;
            font-size: 1.05rem;
            color: var(--navy);
        }

        .pantry-category-count {
            font-size: 0.85rem;
            color: var(--gray-text);
            font-weight: 400;
        }

        .pantry-category-arrow {
            transition: transform 0.3s;
            color: var(--navy);
        }

        .pantry-category-header.expanded .pantry-category-arrow {
            transform: rotate(180deg);
        }

        .pantry-category-items {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 16px;
            max-height: 0;
            overflow: hidden;
            opacity: 0;
            transition: max-height 0.3s ease, opacity 0.3s ease;
        }

        .pantry-category-items.expanded {
            max-height: 5000px;
            opacity: 1;
            margin-bottom: 12px;
        }

        /* Pantry Item Cards */
        .pantry-card {
            background: white;
            border: 1px solid var(--border-light);
            border-radius: var(--radius-md);
            padding: 16px;
            transition: all 0.2s;
            display: flex;
            flex-direction: column;
            gap: 8px;
            position: relative;
        }

        .pantry-card:hover {
            transform: scale(1.02);
            box-shadow: 0 4px 12px rgba(26, 58, 82, 0.12);
            border-color: var(--seafoam);
        }

        .pantry-card.status-critical {
            border-left: 4px solid #EF4444;
        }

        .pantry-card.status-low {
            border-left: 4px solid #DAA520;
        }

        .pantry-card.status-stocked {
            border-left: 4px solid #5DBAA4;
        }

        .pantry-card-icon {
            font-size: 2rem;
            margin-bottom: 4px;
        }

        .pantry-card-name {
            font-weight: 600;
            font-size: 1rem;
            color: var(--navy);
            line-height: 1.3;
            min-height: 2.6em;
        }

        .pantry-card-qty {
            font-size: 0.9rem;
            color: var(--gray-text);
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .pantry-card-qty i {
            width: 14px;
            height: 14px;
        }

        .pantry-card-status {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 500;
            margin-top: 4px;
        }

        .pantry-card-status i {
            width: 12px;
            height: 12px;
        }

        .pantry-card-status.status-stocked {
            background: #E8F5F1;
            color: #5DBAA4;
        }

        .pantry-card-status.status-low {
            background: #FFF3CD;
            color: #DAA520;
        }

        .pantry-card-status.status-critical {
            background: #FEE2E2;
            color: #EF4444;
        }

        .pantry-card-actions {
            display: flex;
            gap: 8px;
            margin-top: 8px;
            padding-top: 8px;
            border-top: 1px solid var(--border-light);
        }

        .btn-icon-sm {
            background: none;
            border: 1px solid var(--border-light);
            padding: 6px 10px;
            border-radius: var(--radius-sm);
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 4px;
            font-size: 0.85rem;
            color: var(--gray-text);
        }

        .btn-icon-sm i {
            width: 14px;
            height: 14px;
        }

        .btn-icon-sm:hover {
            background: var(--gray-light);
            border-color: var(--cerulean);
            color: var(--navy);
        }

        /* Responsive: Mobile/Tablet */
        @media (max-width: 768px) {
            .pantry-category-items {
                grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
                gap: 12px;
            }

            .pantry-card {
                padding: 12px;
            }
        }

        @media (max-width: 480px) {
            .pantry-category-items {
                grid-template-columns: 1fr;
            }
        }

        /* Smart Shopping Generator */
        .smart-shopping-card {
            background: linear-gradient(135deg, var(--seafoam-light) 0%, #e8f4f8 100%);
            border: 1px solid var(--cerulean);
            padding: 16px;
        }
        .smart-shopping-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 8px;
        }
        .smart-shopping-icon { font-size: 1.5rem; }
        .smart-shopping-title {
            font-size: 1rem;
            font-weight: 600;
            color: var(--navy);
            margin: 0;
        }
        .smart-shopping-features {
            list-style: none;
            padding: 0;
            margin: 0;
            font-size: 0.85rem;
        }
        .smart-shopping-features li {
            padding: 4px 0;
            color: var(--gray-dark);
        }
        .divider-label {
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--gray-text);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            padding-bottom: 8px;
            border-bottom: 1px solid var(--gray-medium);
        }

        /* Pantry Alerts Section */
        .pantry-alerts {
            margin-bottom: 16px;
        }
        .pantry-alert-card {
            background: #fff8e6;
            border: 1px solid #ffc107;
            border-radius: var(--radius);
            padding: 12px;
            margin-bottom: 8px;
        }
        .pantry-alert-card.urgent {
            background: #ffebee;
            border-color: #ef5350;
        }
        .pantry-alert-header {
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 600;
            margin-bottom: 8px;
        }
        .pantry-alert-list {
            list-style: none;
            padding: 0;
            margin: 0;
            font-size: 0.9rem;
        }
        .pantry-alert-list li {
            padding: 4px 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        /* Shopping List Base */
        .shopping-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 10px 0;
            border-bottom: 1px solid var(--gray-light);
        }
        .shopping-item.checked { opacity: 0.5; }
        .shopping-item.checked .shopping-item-name { text-decoration: line-through; }
        .shopping-item-checkbox { width: 22px; height: 22px; accent-color: var(--cerulean); }

        /* Shopping List with Pantry Status */
        .shopping-item-enhanced {
            display: flex;
            align-items: flex-start;
            gap: 12px;
            padding: 12px;
            background: var(--gray-light);
            border-radius: var(--radius-sm);
            margin-bottom: 8px;
            transition: all 0.2s ease;
        }
        .shopping-item-enhanced:hover:not(.checked) {
            background: var(--white);
            transform: translateX(4px);
            box-shadow: var(--shadow-sm);
        }
        .shopping-item-enhanced.checked {
            opacity: 0.6;
        }
        .shopping-item-enhanced .shopping-item-checkbox {
            margin-top: 2px;
        }
        .shopping-item-content {
            flex: 1;
        }
        .shopping-item-name-row {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
        }
        .shopping-item-name {
            font-weight: 500;
        }
        .shopping-item-qty {
            font-size: 0.85rem;
            color: var(--gray-text);
        }
        .shopping-item-pantry-status {
            font-size: 0.8rem;
            color: var(--gray-text);
            margin-top: 4px;
        }
        .shopping-item-pantry-status.has-some {
            color: var(--cerulean);
        }
        .shopping-item-pantry-status.missing {
            color: var(--warning);
        }
        .shopping-category-header {
            font-weight: 600;
            color: var(--cerulean);
            padding: 12px 0 8px;
            margin-top: 8px;
            border-bottom: 1px solid var(--gray-medium);
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .shopping-list-summary {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            background: var(--seafoam-light);
            border-radius: var(--radius);
            margin-bottom: 16px;
        }
        .shopping-summary-cost {
            font-weight: 600;
            color: var(--navy);
        }
        .shopping-suggestions {
            background: #f5f5f5;
            border-radius: var(--radius);
            padding: 12px;
            margin-bottom: 16px;
        }
        .shopping-suggestions-header {
            font-weight: 600;
            color: var(--gray-dark);
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .shopping-suggestion-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid var(--gray-medium);
        }
        .shopping-suggestion-item:last-child {
            border-bottom: none;
        }
        .suggestion-add-btn {
            font-size: 0.8rem;
            padding: 4px 12px;
            background: var(--cerulean);
            color: white;
            border: none;
            border-radius: var(--radius-sm);
            cursor: pointer;
        }

        /* Calorie Estimation UI */
        .calorie-input-row {
            display: flex;
            gap: 8px;
            align-items: flex-start;
        }
        .calorie-input-row .form-input {
            flex: 1;
        }
        .estimate-btn {
            padding: 10px 16px;
            background: var(--seafoam-light);
            color: var(--navy);
            border: 1px solid var(--cerulean);
            border-radius: var(--radius-sm);
            cursor: pointer;
            font-size: 0.9rem;
            white-space: nowrap;
            transition: all 0.2s;
        }
        .estimate-btn:hover {
            background: var(--cerulean);
            color: white;
        }
        .estimate-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        .estimate-btn.loading {
            background: var(--gray-light);
            color: var(--gray-text);
        }
        .estimate-result {
            margin-top: 8px;
            padding: 10px 12px;
            background: var(--seafoam-light);
            border-radius: var(--radius-sm);
            font-size: 0.85rem;
        }
        .estimate-result-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .estimate-result-text {
            color: var(--navy);
        }
        .estimate-result-text .confidence {
            color: var(--gray-text);
            font-size: 0.8rem;
        }
        .estimate-details-btn {
            font-size: 0.8rem;
            padding: 4px 10px;
            background: white;
            border: 1px solid var(--gray-medium);
            border-radius: var(--radius-sm);
            cursor: pointer;
        }
        .estimate-details-btn:hover {
            background: var(--gray-light);
        }
        .estimate-breakdown {
            margin-top: 12px;
            padding: 12px;
            background: white;
            border-radius: var(--radius-sm);
            border: 1px solid var(--gray-medium);
        }
        .estimate-breakdown h4 {
            margin: 0 0 8px 0;
            font-size: 0.9rem;
            color: var(--navy);
        }
        .estimate-breakdown ul {
            margin: 0 0 12px 0;
            padding-left: 20px;
            font-size: 0.85rem;
        }
        .estimate-breakdown li {
            padding: 2px 0;
            color: var(--gray-dark);
        }
        .estimate-macros {
            display: flex;
            gap: 16px;
            padding-top: 8px;
            border-top: 1px solid var(--gray-light);
            font-size: 0.85rem;
        }
        .estimate-macros span {
            color: var(--gray-text);
        }
        .estimate-macros strong {
            color: var(--navy);
        }
        .confidence-badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.75rem;
            font-weight: 500;
        }
        .confidence-badge.high {
            background: #e8f5e9;
            color: #2e7d32;
        }
        .confidence-badge.medium {
            background: #fff3e0;
            color: #ef6c00;
        }
        .confidence-badge.low {
            background: #ffebee;
            color: #c62828;
        }
        .calorie-input-estimated {
            border-color: var(--success) !important;
            background: #f8fff8;
        }

        /* Quick Add Delivery Section */
        .quick-add-section {
            margin-top: 16px;
        }
        .quick-add-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            padding: 12px;
            background: var(--gray-light);
            border-radius: var(--radius);
        }
        .quick-add-header:hover {
            background: var(--seafoam-light);
        }
        .quick-add-content {
            display: none;
            padding: 16px;
            background: var(--gray-light);
            border-radius: 0 0 var(--radius) var(--radius);
            margin-top: -8px;
        }
        .quick-add-content.open {
            display: block;
        }
        .quick-add-btns {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            margin-top: 8px;
        }
        .quick-add-btn {
            padding: 12px;
            background: white;
            border: 1px solid var(--gray-medium);
            border-radius: var(--radius);
            cursor: pointer;
            text-align: left;
            transition: all 0.2s;
        }
        .quick-add-btn:hover {
            border-color: var(--cerulean);
            background: var(--seafoam-light);
        }

        /* Batch Cooking Pantry Check */
        .batch-ingredient-check {
            margin-top: 16px;
            padding: 16px;
            background: var(--gray-light);
            border-radius: var(--radius);
        }
        .batch-ingredient-header {
            font-weight: 600;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .batch-ingredient-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px 0;
            font-size: 0.9rem;
        }
        .batch-ingredient-status {
            width: 20px;
            text-align: center;
        }
        .batch-missing-items {
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid var(--gray-medium);
        }

        /* Meal Planning Mode Selection */
        .planning-mode-selector {
            margin-bottom: 16px;
        }
        .planning-mode-option {
            display: flex;
            align-items: flex-start;
            gap: 12px;
            padding: 12px;
            background: var(--gray-light);
            border-radius: var(--radius);
            margin-bottom: 8px;
            cursor: pointer;
            border: 2px solid transparent;
            transition: all 0.2s;
        }
        .planning-mode-option:hover {
            background: var(--seafoam-light);
        }
        .planning-mode-option.selected {
            border-color: var(--cerulean);
            background: var(--seafoam-light);
        }
        .planning-mode-option input[type="radio"] {
            margin-top: 4px;
        }
        .planning-mode-content {
            flex: 1;
        }
        .planning-mode-title {
            font-weight: 600;
            margin-bottom: 4px;
        }
        .planning-mode-desc {
            font-size: 0.85rem;
            color: var(--gray-text);
        }
        .planning-pantry-summary {
            background: var(--gray-light);
            border-radius: var(--radius);
            padding: 12px;
            margin-top: 12px;
            font-size: 0.9rem;
        }
        .planning-pantry-summary h4 {
            margin: 0 0 8px 0;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        /* Pantry Scan */
        .scan-upload-area {
            border: 2px dashed var(--gray-medium);
            border-radius: var(--radius);
            padding: 32px 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
            background: var(--gray-light);
        }
        .scan-upload-area:hover { border-color: var(--cerulean); background: var(--seafoam-light); }
        .scan-upload-area.dragover { border-color: var(--cerulean); background: var(--seafoam-light); }
        .scan-upload-icon { font-size: 3rem; margin-bottom: 12px; }
        .scan-upload-text { font-weight: 500; margin-bottom: 4px; }
        .scan-upload-hint { font-size: 0.85rem; color: var(--gray-text); }
        .scan-preview { max-width: 100%; max-height: 200px; border-radius: var(--radius-sm); margin-top: 16px; }
        .scan-loading {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 40px 20px;
            text-align: center;
        }
        .scan-loading-icon {
            font-size: 3rem;
            animation: scanPulse 1.5s ease-in-out infinite;
        }
        @keyframes scanPulse {
            0%, 100% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.1); opacity: 0.7; }
        }
        .scan-loading-text { margin-top: 16px; color: var(--gray-text); }

        /* Scan Results */
        .scan-results-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }
        .scan-results-count { font-weight: 600; color: var(--cerulean); }
        .scan-item {
            display: flex;
            align-items: flex-start;
            gap: 12px;
            padding: 12px;
            background: var(--gray-light);
            border-radius: var(--radius-sm);
            margin-bottom: 8px;
        }
        .scan-item-checkbox { margin-top: 4px; width: 20px; height: 20px; accent-color: var(--cerulean); }
        .scan-item-info { flex: 1; }
        .scan-item-name { font-weight: 500; }
        .scan-item-details { font-size: 0.85rem; color: var(--gray-text); margin-top: 2px; }
        .scan-item-badge {
            display: inline-block;
            font-size: 0.7rem;
            padding: 2px 6px;
            border-radius: 10px;
            margin-right: 4px;
        }
        .scan-item-badge.fresh { background: #e8f5e9; color: #2e7d32; }
        .scan-item-badge.use-soon { background: #fff3e0; color: #ef6c00; }
        .scan-item-badge.check { background: #ffebee; color: #c62828; }
        .scan-item-badge.category { background: var(--seafoam-light); color: var(--navy); }
        .scan-item-actions { display: flex; gap: 4px; }
        .scan-category-header {
            font-weight: 600;
            color: var(--cerulean);
            padding: 8px 0;
            margin-top: 12px;
            border-bottom: 1px solid var(--gray-medium);
        }
        .scan-category-header:first-child { margin-top: 0; }

        /* Toast */
        .toast {
            position: fixed;
            bottom: 100px;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background: var(--navy);
            color: white;
            padding: 12px 24px;
            border-radius: var(--radius);
            box-shadow: var(--shadow-lg);
            z-index: 2000;
            opacity: 0;
            transition: all 0.3s ease;
        }
        .toast.show { transform: translateX(-50%) translateY(0); opacity: 1; }

        /* Onboarding */
        .onboarding-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(26, 35, 50, 0.8);
            z-index: 2000;
            display: none;
        }
        .onboarding-overlay.active { display: flex; align-items: center; justify-content: center; }
        .onboarding-card {
            background: var(--white);
            border-radius: var(--radius-lg);
            max-width: 400px;
            width: 90%;
            padding: 32px 24px;
            text-align: center;
        }
        .onboarding-icon { font-size: 3rem; margin-bottom: 16px; }
        .onboarding-title { font-family: 'Lora', serif; font-size: 1.5rem; margin-bottom: 12px; }
        .onboarding-text { color: var(--gray-text); margin-bottom: 24px; }
        .onboarding-dots { display: flex; justify-content: center; gap: 8px; margin-bottom: 24px; }
        .onboarding-dot { width: 8px; height: 8px; border-radius: 50%; background: var(--gray-medium); }
        .onboarding-dot.active { background: var(--cerulean); }
        .onboarding-actions { display: flex; gap: 12px; justify-content: center; }

        /* Cook Mode */
        .cook-mode-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--cream);
            z-index: 1500;
            display: none;
            flex-direction: column;
        }
        .cook-mode-overlay.active { display: flex; }
        .cook-mode-header {
            background: var(--cerulean);
            color: white;
            padding: 16px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .cook-mode-progress { font-size: 1.1rem; }
        .cook-mode-close { background: rgba(255,255,255,0.2); border: none; padding: 8px 16px; border-radius: var(--radius-sm); color: white; cursor: pointer; }
        .cook-mode-body { flex: 1; overflow-y: auto; padding: 24px 20px; }
        .cook-mode-step {
            background: var(--white);
            border-radius: var(--radius);
            padding: 24px;
            margin-bottom: 16px;
            font-size: 1.2rem;
            line-height: 1.8;
        }
        .cook-mode-step-check {
            display: flex;
            align-items: flex-start;
            gap: 16px;
        }
        .cook-mode-step-check input { width: 28px; height: 28px; margin-top: 4px; }
        .cook-mode-timer {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            background: var(--warning);
            color: white;
            padding: 8px 16px;
            border-radius: var(--radius-sm);
            margin-top: 12px;
            cursor: pointer;
        }
        .cook-mode-ingredients {
            background: var(--white);
            border-radius: var(--radius);
            padding: 16px;
            margin-bottom: 16px;
        }
        .cook-mode-ingredients summary { cursor: pointer; font-weight: 600; color: var(--cerulean); }
        .cook-mode-footer {
            background: var(--white);
            border-top: 1px solid var(--gray-medium);
            padding: 16px 20px;
            display: flex;
            gap: 12px;
        }
        .cook-mode-footer .btn { flex: 1; }

        /* Condition Details */
        .condition-details {
            background: var(--gray-light);
            padding: 12px 16px;
            border-radius: var(--radius-sm);
            margin-top: 8px;
            margin-bottom: 8px;
            border-left: 3px solid var(--cerulean);
        }
        .condition-details .form-group { margin-bottom: 0; }
        .condition-details .form-row { margin-bottom: 0; }

        /* Utilities */
        .hidden { display: none !important; }
        .text-center { text-align: center; }
        .text-muted { color: var(--gray-text); }
        .mb-0 { margin-bottom: 0; }
        .mb-8 { margin-bottom: 8px; }
        .mb-16 { margin-bottom: 16px; }
        .mt-8 { margin-top: 8px; }
        .mt-16 { margin-top: 16px; }
        .flex { display: flex; }
        .flex-between { justify-content: space-between; }
        .flex-center { align-items: center; }
        .gap-8 { gap: 8px; }
        .gap-12 { gap: 12px; }
        .gap-16 { gap: 16px; }

        /* Search Results Highlight */
        .search-highlight { background: yellow; padding: 0 2px; }

        /* Filter Dropdown */
        .filter-dropdown {
            position: relative;
            display: inline-block;
        }
        .filter-dropdown-content {
            display: none;
            position: absolute;
            right: 0;
            top: 100%;
            background: var(--white);
            border-radius: var(--radius);
            box-shadow: var(--shadow-lg);
            min-width: 200px;
            z-index: 100;
            padding: 12px;
        }
        .filter-dropdown.open .filter-dropdown-content { display: block; }

        /* ========================================
           LOADING STATES
           ======================================== */
        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 4px solid var(--gray-light);
            border-top-color: var(--olive-green);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }
        .loading-spinner.small { width: 20px; height: 20px; border-width: 2px; }
        .loading-spinner.inline { display: inline-block; vertical-align: middle; margin-right: 8px; }
        @keyframes spin { to { transform: rotate(360deg); } }

        .loading-overlay {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(255,255,255,0.85);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            gap: 16px;
        }
        .loading-overlay .loading-text {
            color: var(--gray-text);
            font-family: var(--font-body);
            font-size: 0.95rem;
        }

        .btn-loading {
            opacity: 0.7;
            pointer-events: none;
            position: relative;
        }
        .btn-loading::after {
            content: '';
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid rgba(255,255,255,0.3);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            margin-left: 8px;
            vertical-align: middle;
        }

        /* ========================================
           SKELETON LOADING
           ======================================== */
        .skeleton {
            background: linear-gradient(90deg, var(--skeleton-base) 25%, var(--skeleton-shimmer) 50%, var(--skeleton-base) 75%);
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite;
            border-radius: var(--radius-sm);
        }
        @keyframes shimmer {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }
        .skeleton-text { height: 1rem; margin-bottom: 0.5rem; width: 80%; }
        .skeleton-title { height: 1.5rem; width: 60%; margin-bottom: 1rem; }
        .skeleton-card {
            height: 220px;
            border-radius: var(--radius);
            margin-bottom: 16px;
        }
        .skeleton-avatar { width: 40px; height: 40px; border-radius: 50%; }

        /* ========================================
           CONFIRMATION MODAL
           ======================================== */
        .confirmation-modal-content {
            text-align: center;
            padding: var(--space-xl);
        }
        .confirmation-icon {
            font-size: 3rem;
            margin-bottom: var(--space-lg);
            display: block;
        }
        .confirmation-icon.warning { color: var(--warning); }
        .confirmation-icon.danger { color: var(--danger); }
        .confirmation-icon.success { color: var(--success); }
        .confirmation-title {
            font-family: var(--font-heading);
            font-size: 1.3rem;
            margin-bottom: var(--space-sm);
            color: var(--charcoal);
        }
        .confirmation-message {
            color: var(--gray-text);
            margin-bottom: var(--space-xl);
            line-height: 1.6;
        }
        .confirmation-actions {
            display: flex;
            gap: var(--space-md);
            justify-content: center;
        }
        .confirmation-actions .btn { min-width: 120px; }

        /* ========================================
           EMPTY STATES
           ======================================== */
        .empty-state {
            text-align: center;
            padding: var(--space-3xl) var(--space-xl);
        }
        .empty-state-icon {
            font-size: 4rem;
            margin-bottom: var(--space-lg);
            opacity: 0.4;
            display: block;
        }
        .empty-state-title {
            font-family: var(--font-heading);
            font-size: 1.3rem;
            color: var(--charcoal);
            margin-bottom: var(--space-sm);
        }
        .empty-state-text {
            color: var(--gray-text);
            margin-bottom: var(--space-xl);
            max-width: 400px;
            margin-left: auto;
            margin-right: auto;
            line-height: 1.6;
        }
        .empty-state .btn {
            margin: 0 auto;
        }

        /* ========================================
           ENHANCED TOAST STYLES
           ======================================== */
        .toast-container {
            position: fixed;
            bottom: 100px;
            right: 24px;
            z-index: 2000;
            display: flex;
            flex-direction: column-reverse;
            gap: 8px;
            pointer-events: none;
        }
        .toast-item {
            background: var(--white);
            color: var(--charcoal);
            padding: 14px 20px;
            border-radius: var(--radius);
            box-shadow: var(--shadow-lg);
            display: flex;
            align-items: center;
            gap: 12px;
            min-width: 280px;
            max-width: 400px;
            transform: translateX(120%);
            opacity: 0;
            transition: all 0.3s ease;
            pointer-events: auto;
            border-left: 4px solid var(--olive-green);
        }
        .toast-item.show { transform: translateX(0); opacity: 1; }
        .toast-item.toast-success { border-left-color: var(--success); }
        .toast-item.toast-error { border-left-color: var(--danger); }
        .toast-item.toast-warning { border-left-color: var(--warning); }
        .toast-item.toast-info { border-left-color: var(--info); }
        .toast-item .toast-icon { font-size: 1.2rem; flex-shrink: 0; }
        .toast-item .toast-message { flex: 1; font-size: 0.9rem; line-height: 1.4; }
        .toast-item .toast-close {
            background: none; border: none; cursor: pointer;
            color: var(--gray-text); padding: 4px; font-size: 1.1rem;
            flex-shrink: 0;
        }
        @media (max-width: 640px) {
            .toast-container {
                left: 16px;
                right: 16px;
                bottom: 90px;
            }
            .toast-item { min-width: auto; max-width: 100%; }
        }

        /* ========================================
           BADGE & CHIP UTILITIES
           ======================================== */
        .badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 3px 10px;
            border-radius: var(--radius-full);
            font-size: 0.75rem;
            font-weight: 500;
            white-space: nowrap;
        }
        .badge-family { background: var(--seafoam-light); color: var(--mediterranean-blue); }
        .badge-private { background: var(--gray-light); color: var(--gray-text); }
        .badge-success { background: #d1fae5; color: #065f46; }
        .badge-warning { background: #fef3c7; color: #92400e; }
        .badge-danger { background: #fee2e2; color: #991b1b; }

        .chip {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 14px;
            border-radius: var(--radius-full);
            font-size: 0.8rem;
            font-weight: 500;
            border: 1.5px solid var(--gray-medium);
            background: var(--white);
            color: var(--charcoal);
            cursor: pointer;
            transition: all 0.2s;
        }
        .chip:hover { border-color: var(--olive-green); }
        .chip.active {
            background: var(--olive-green);
            border-color: var(--olive-green);
            color: white;
        }
        .chip .chip-count { opacity: 0.7; font-size: 0.7rem; }
        .chip .chip-remove {
            background: none; border: none; cursor: pointer;
            color: inherit; padding: 0; font-size: 1rem; line-height: 1;
            opacity: 0.6;
        }
        .chip .chip-remove:hover { opacity: 1; }

        /* ========================================
           TAG SELECTION (for share/filter modals)
           ======================================== */
        .tag-selection-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: var(--space-sm);
        }
        @media (min-width: 640px) {
            .tag-selection-grid { grid-template-columns: repeat(3, 1fr); }
        }
        .tag-selection-chip {
            display: flex;
            align-items: center;
            gap: var(--space-sm);
            padding: 8px 12px;
            border: 2px solid var(--gray-medium);
            border-radius: var(--radius);
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.85rem;
        }
        .tag-selection-chip input[type="checkbox"] { accent-color: var(--olive-green); }
        .tag-selection-chip.selected {
            border-color: var(--olive-green);
            background: rgba(93, 186, 164, 0.12);
        }

        /* ========================================
           RADIO GROUP (for privacy selection)
           ======================================== */
        .radio-group {
            display: flex;
            flex-direction: column;
            gap: var(--space-md);
        }
        .radio-item {
            display: flex;
            align-items: flex-start;
            gap: var(--space-md);
            padding: var(--space-md);
            border: 2px solid var(--gray-medium);
            border-radius: var(--radius);
            cursor: pointer;
            transition: all 0.2s;
        }
        .radio-item:has(input:checked) {
            border-color: var(--olive-green);
            background: rgba(93, 186, 164, 0.08);
        }
        .radio-item input[type="radio"] { accent-color: var(--olive-green); margin-top: 3px; }
        .radio-label {
            font-weight: 500;
            margin-bottom: 2px;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .radio-desc { font-size: 0.85rem; color: var(--gray-text); }

        /* ========================================
           ENHANCED RECIPE DETAIL MODAL
           ======================================== */
        .recipe-detail-body {
            max-height: 70vh;
            overflow-y: auto;
            padding: 20px;
        }
        .recipe-modal-meta {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            align-items: center;
            margin-top: 6px;
        }
        .recipe-detail-meta {
            display: flex;
            flex-wrap: wrap;
            gap: var(--space-lg);
            padding: var(--space-md);
            background: var(--feta-white);
            border-radius: var(--radius);
            margin-bottom: var(--space-lg);
        }
        .meta-item {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 0.9rem;
            color: var(--gray-text);
        }
        .meta-item i, .meta-item svg { width: 16px; height: 16px; }
        .recipe-detail-tags {
            display: flex;
            flex-wrap: wrap;
            gap: var(--space-sm);
            margin-bottom: var(--space-lg);
        }
        .recipe-detail-section {
            margin-bottom: var(--space-xl);
        }
        .recipe-detail-section .section-title {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 1.15rem;
            font-family: var(--font-heading);
            color: var(--olive-green);
            margin-bottom: var(--space-md);
            padding-bottom: var(--space-sm);
            border-bottom: 2px solid rgba(93, 186, 164, 0.3);
        }
        .recipe-detail-section .section-title i,
        .recipe-detail-section .section-title svg { width: 20px; height: 20px; }
        .nutrition-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: var(--space-sm);
        }
        @media (min-width: 640px) {
            .nutrition-grid { grid-template-columns: repeat(6, 1fr); }
        }
        .nutrition-card {
            text-align: center;
            padding: var(--space-md) var(--space-sm);
            background: var(--feta-white);
            border-radius: var(--radius);
        }
        .nutrition-value {
            font-size: 1.3rem;
            font-weight: 600;
            color: var(--olive-green);
        }
        .nutrition-label {
            font-size: 0.7rem;
            color: var(--gray-text);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-top: 2px;
        }
        .ingredients-list, .instructions-list {
            padding-left: var(--space-xl);
            line-height: 1.8;
        }
        .ingredients-list li, .instructions-list li {
            margin-bottom: var(--space-sm);
        }
        .health-benefits-section {
            background: rgba(93, 186, 164, 0.08);
            padding: var(--space-md);
            border-radius: var(--radius);
        }
        .recipe-detail-footer {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            padding: 16px 20px;
            border-top: 1px solid var(--gray-medium);
        }
        .recipe-detail-footer .btn { font-size: 0.85rem; }

        /* ========================================
           FAMILY TAVOLA STYLES
           ======================================== */
        .recipes-tab-bar {
            display: flex;
            gap: 0;
            margin-bottom: var(--space-lg);
            border-bottom: 2px solid var(--gray-medium);
        }
        .recipes-tab {
            padding: 12px 24px;
            border: none;
            background: none;
            font-family: var(--font-accent);
            font-weight: 500;
            font-size: 0.95rem;
            color: var(--gray-text);
            cursor: pointer;
            position: relative;
            transition: color 0.2s;
        }
        .recipes-tab.active {
            color: var(--olive-green);
        }
        .recipes-tab.active::after {
            content: '';
            position: absolute;
            bottom: -2px;
            left: 0;
            right: 0;
            height: 2px;
            background: var(--olive-green);
        }
        .recipes-tab:hover { color: var(--olive-green); }

        .family-tavola-header {
            background: linear-gradient(135deg, rgba(93, 186, 164, 0.08) 0%, var(--cream) 100%);
            padding: var(--space-md) var(--space-lg);
            border-radius: var(--radius);
            margin-bottom: var(--space-lg);
        }
        .family-filters {
            display: flex;
            gap: var(--space-md);
            flex-wrap: wrap;
            margin-bottom: var(--space-md);
        }
        .family-recipe-shared-by {
            display: flex;
            align-items: center;
            gap: 4px;
            font-size: 0.75rem;
            color: var(--gray-text);
            margin-top: 6px;
        }
        .family-recipe-shared-by i, .family-recipe-shared-by svg { width: 12px; height: 12px; }

        .family-rating-form {
            background: var(--feta-white);
            padding: var(--space-lg);
            border-radius: var(--radius);
            margin-bottom: var(--space-xl);
        }
        .family-rating-form h4 {
            margin: 0 0 var(--space-md) 0;
            color: var(--olive-green);
            font-family: var(--font-heading);
        }
        .star-rating .star {
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--gray-medium);
            transition: color 0.15s;
        }
        .star-rating .star.filled { color: var(--star-gold); }
        .star-rating .star:hover { color: #f59e0b; }
        .family-ratings-list { margin-top: var(--space-xl); }
        .family-rating-item {
            background: var(--white);
            padding: var(--space-md);
            border-radius: var(--radius);
            margin-bottom: var(--space-md);
            border-left: 3px solid var(--olive-green);
        }
        .rating-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--space-sm);
        }
        .rating-user {
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 0.9rem;
        }
        .rating-stars { color: var(--star-gold); }
        .rating-comment {
            color: var(--gray-text);
            font-size: 0.9rem;
            line-height: 1.6;
            margin: 0 0 var(--space-sm) 0;
        }
        .rating-modification {
            background: var(--cream);
            padding: 8px 12px;
            border-radius: var(--radius-sm);
            font-size: 0.85rem;
        }

        /* ========================================
           RECIPE CREATION FORM
           ======================================== */
        .create-recipe-form { max-height: 70vh; overflow-y: auto; }
        .ingredient-input-row, .instruction-input-row {
            display: flex;
            align-items: flex-start;
            gap: var(--space-sm);
            margin-bottom: var(--space-sm);
        }
        .ingredient-input-row input,
        .ingredient-input-row select { flex: 1; }
        .step-num {
            min-width: 28px;
            font-weight: 600;
            color: var(--olive-green);
            padding-top: 10px;
            text-align: center;
        }
        .instruction-input-row textarea { flex: 1; }
        .btn-icon {
            background: none;
            border: none;
            padding: 8px;
            cursor: pointer;
            color: var(--gray-text);
            border-radius: var(--radius-sm);
            transition: all 0.2s;
            flex-shrink: 0;
        }
        .btn-icon:hover { background: var(--gray-light); color: var(--danger); }
        .nutrition-inputs {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: var(--space-sm);
        }
        @media (min-width: 640px) {
            .nutrition-inputs { grid-template-columns: repeat(4, 1fr); }
        }
        .form-input-small {
            padding: 8px 10px;
            border: 1px solid var(--gray-medium);
            border-radius: var(--radius-sm);
            font-size: 0.9rem;
            font-family: var(--font-body);
            width: 100%;
        }
        .form-input-small:focus {
            outline: none;
            border-color: var(--olive-green);
            box-shadow: 0 0 0 3px rgba(43, 127, 183, 0.2);
        }
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: var(--space-md);
        }
        .prompt-actions {
            display: flex;
            gap: var(--space-md);
        }
        @media (max-width: 640px) {
            .prompt-actions { flex-direction: column; }
            .form-row { grid-template-columns: 1fr; }
        }

        /* ========================================
           PANTRY ENHANCEMENTS
           ======================================== */
        .pantry-status-fresh { border-left: 3px solid var(--success); }
        .pantry-status-low { border-left: 3px solid var(--warning); }
        .pantry-status-out { border-left: 3px solid var(--danger); opacity: 0.7; }

        .pantry-alerts {
            display: grid;
            grid-template-columns: 1fr;
            gap: var(--space-md);
            margin-bottom: var(--space-xl);
        }
        @media (min-width: 768px) {
            .pantry-alerts { grid-template-columns: repeat(2, 1fr); }
        }
        .pantry-alert-card {
            background: #fff8e1;
            border: 1px solid var(--warning);
            border-radius: var(--radius);
            padding: var(--space-lg);
        }
        .pantry-alert-card.urgent {
            background: #fce4ec;
            border-color: var(--danger);
        }
        .pantry-alert-header {
            display: flex;
            align-items: center;
            gap: var(--space-sm);
            margin-bottom: var(--space-md);
        }
        .pantry-alert-header h4 { margin: 0; font-size: 1rem; }
        .pantry-alert-header i, .pantry-alert-header svg { width: 20px; height: 20px; }
        .pantry-alert-list { list-style: none; padding: 0; margin: 0; }
        .pantry-alert-list li {
            padding: 4px 0;
            border-bottom: 1px solid rgba(0,0,0,0.08);
            font-size: 0.9rem;
        }
        .pantry-alert-list li:last-child { border-bottom: none; }

        /* ========================================
           LUCIDE ICON UTILITY STYLES
           ======================================== */
        [data-lucide] { width: 20px; height: 20px; stroke-width: 2; }
        .btn [data-lucide], .btn i svg { width: 16px; height: 16px; vertical-align: middle; margin-right: 4px; }
        .btn-sm [data-lucide] { width: 14px; height: 14px; }
        .nav-item [data-lucide] { width: 24px; height: 24px; }

        /* ========================================
           PRINT STYLES (Enhanced)
           ======================================== */
        @media print {
            /* Hide all UI chrome */
            .header, .bottom-nav, .chat-input-area, .recipe-actions,
            .recipe-card-actions, .modal-overlay, .modal-close,
            .modal-footer, .toast, .toast-container, .onboarding-overlay,
            .quick-actions, .btn, button, nav, .filter-dropdown,
            .recipes-tab-bar, .family-filters, .tag-filter-section { display: none !important; }

            /* Reset page */
            body {
                padding: 0 !important;
                margin: 0 !important;
                background: white !important;
                color: black !important;
                font-family: Georgia, 'Times New Roman', serif !important;
            }

            /* Recipe print layout */
            .recipe-card, .modal, .recipe-detail-body {
                box-shadow: none !important;
                border: none !important;
                padding: 0 !important;
                max-height: none !important;
                overflow: visible !important;
            }
            .recipe-detail-section { page-break-inside: avoid; }
            .ingredients-list, .instructions-list { font-size: 12pt; }

            /* Print header */
            .modal-title, .recipe-detail-section .section-title {
                color: black !important;
                font-size: 14pt;
            }

            /* Nutrition grid for print */
            .nutrition-grid { grid-template-columns: repeat(6, 1fr) !important; }
            .nutrition-card { border: 1px solid #ddd; }

            /* Hide non-essential detail sections */
            .health-benefits-section, .family-rating-form, .family-ratings-list { display: none !important; }

            /* Page setup */
            @page { margin: 0.5in; }
        }

        /* ========================================
           HYBRID NAVIGATION SYSTEM
           ======================================== */

        /* --- Nav Dropdown (shared mobile + desktop) --- */
        .nav-dropdown-menu {
            position: absolute;
            background: var(--white);
            border-radius: var(--radius);
            box-shadow: 0 4px 24px rgba(0,0,0,0.18);
            min-width: 200px;
            z-index: 200;
            overflow: hidden;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.2s ease, visibility 0.2s ease;
            pointer-events: none;
        }
        .nav-dropdown-menu.open {
            opacity: 1;
            visibility: visible;
            pointer-events: auto;
        }
        .nav-dropdown-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px 16px;
            color: var(--navy);
            font-size: 0.95rem;
            cursor: pointer;
            transition: background 0.15s, color 0.15s;
            border: none;
            background: none;
            width: 100%;
            text-align: left;
            font-family: inherit;
        }
        .nav-dropdown-item:hover {
            background: var(--cerulean-light);
            color: var(--navy);
            padding-left: 20px;
        }
        .nav-dropdown-item [data-lucide], .nav-dropdown-item svg {
            width: 18px;
            height: 18px;
            flex-shrink: 0;
            color: var(--navy);
        }
        .nav-dropdown-item:hover [data-lucide], .nav-dropdown-item:hover svg {
            color: var(--seafoam-dark);
        }

        /* --- Settings gear icon (shared) --- */
        .nav-settings-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            background: none;
            border: none;
            color: rgba(255,255,255,0.7);
            cursor: pointer;
            padding: 6px;
            border-radius: 50%;
            transition: color 0.2s, background 0.2s;
        }
        .nav-settings-btn:hover {
            color: #fff;
            background: rgba(255,255,255,0.12);
        }
        .nav-settings-btn [data-lucide], .nav-settings-btn svg {
            width: 20px;
            height: 20px;
        }

        /* --- MOBILE: Bottom Nav with Dropdowns (< 768px) --- */
        @media (max-width: 767px) {
            .desktop-nav { display: none !important; }
            .header-desktop-center { display: none !important; }
            .header-desktop-right { display: none !important; }

            .bottom-nav {
                flex-direction: row;
            }
            .bottom-nav .nav-group {
                position: relative;
                display: flex;
                flex-direction: column;
                align-items: center;
                min-width: 48px;
            }
            .bottom-nav .nav-dropdown-menu {
                bottom: 100%;
                left: 50%;
                transform: translateX(-50%);
                margin-bottom: 8px;
                animation: slideUpDropdown 0.2s ease;
            }
            @keyframes slideUpDropdown {
                from { opacity: 0; transform: translateX(-50%) translateY(10px); }
                to { opacity: 1; transform: translateX(-50%) translateY(0); }
            }
        }

        /* --- DESKTOP: Top Nav Bar (>= 768px) --- */
        @media (min-width: 768px) {
            .bottom-nav { display: none !important; }

            .header {
                background: var(--navy) !important;
                border-bottom: none !important;
                padding: 0 !important;
            }
            .header .container.header-content {
                display: flex;
                align-items: center;
                min-height: 56px;
                padding: 0 20px;
            }
            .header .logo {
                color: #fff !important;
                font-size: 1.6rem;
                margin-right: 32px;
                flex-shrink: 0;
            }

            /* Desktop center nav */
            .header-desktop-center {
                display: flex;
                align-items: center;
                gap: 4px;
                flex: 1;
                justify-content: center;
            }
            .desktop-nav-group {
                position: relative;
            }
            .desktop-nav-btn {
                display: flex;
                align-items: center;
                gap: 6px;
                padding: 8px 14px;
                border: none;
                background: none;
                color: rgba(255,255,255,0.75);
                font-size: 0.9rem;
                font-family: inherit;
                font-weight: 500;
                cursor: pointer;
                border-radius: var(--radius-sm);
                transition: all 0.2s;
                white-space: nowrap;
            }
            .desktop-nav-btn [data-lucide], .desktop-nav-btn svg {
                width: 18px;
                height: 18px;
            }
            .desktop-nav-btn:hover, .desktop-nav-btn.active {
                color: #fff;
                background: rgba(93, 186, 164, 0.2);
            }
            .desktop-nav-btn .chevron {
                width: 14px;
                height: 14px;
                transition: transform 0.2s;
            }
            .desktop-nav-btn.open .chevron {
                transform: rotate(180deg);
            }

            /* Desktop dropdowns drop DOWN */
            .desktop-nav-group .nav-dropdown-menu {
                top: 100%;
                left: 50%;
                transform: translateX(-50%);
                margin-top: 0;
                padding-top: 8px;
            }

            /* Hover bridge - creates safe zone between button and dropdown */
            .desktop-nav-group {
                position: relative;
            }

            .desktop-nav-group::after {
                content: '';
                position: absolute;
                top: 100%;
                left: 0;
                right: 0;
                height: 8px;
                z-index: 199;
            }

            /* Desktop header right section */
            .header-desktop-right {
                display: flex;
                align-items: center;
                gap: 10px;
                flex-shrink: 0;
                margin-left: 16px;
            }
            .header-desktop-right .header-search {
                background: rgba(255,255,255,0.12);
                border: 1px solid rgba(255,255,255,0.2);
            }
            .header-desktop-right .header-search span {
                color: rgba(255,255,255,0.6);
            }
            .header-desktop-right .header-search input {
                color: #fff;
            }
            .header-desktop-right .header-search input::placeholder {
                color: rgba(255,255,255,0.5);
            }
            .header-desktop-right .auth-section {
                color: rgba(255,255,255,0.85);
            }
            .header-desktop-right .auth-btn {
                color: #fff;
                background: rgba(255,255,255,0.12);
                border: 1px solid rgba(255,255,255,0.25);
            }
            .header-desktop-right .auth-btn:hover {
                background: rgba(255,255,255,0.2);
            }
            .header-desktop-right .user-info {
                color: rgba(255,255,255,0.85);
            }
            .header-desktop-right .sync-status {
                color: rgba(255,255,255,0.6);
            }

            /* Hide the old mobile header-right on desktop */
            .header > .container > .header-right {
                display: none !important;
            }
        }

        /* ========================================
           MARKETING & ABOUT PAGES
           ======================================== */

        .marketing-page, .about-page {
            display: none;
            background: var(--page-bg);
            position: relative;
        }
        .marketing-page.active, .about-page.active {
            display: block;
        }

        /* Greek Key Pattern Background */
        .marketing-page::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-image:
                repeating-linear-gradient(0deg, transparent, transparent 20px, rgba(26, 58, 82, 0.03) 20px, rgba(26, 58, 82, 0.03) 22px),
                repeating-linear-gradient(90deg, transparent, transparent 20px, rgba(26, 58, 82, 0.03) 20px, rgba(26, 58, 82, 0.03) 22px),
                repeating-linear-gradient(45deg, transparent, transparent 28px, rgba(26, 58, 82, 0.02) 28px, rgba(26, 58, 82, 0.02) 30px),
                repeating-linear-gradient(-45deg, transparent, transparent 28px, rgba(26, 58, 82, 0.02) 28px, rgba(26, 58, 82, 0.02) 30px);
            pointer-events: none;
            z-index: 0;
        }

        .marketing-page > * {
            position: relative;
            z-index: 1;
        }

        /* Marketing Hero - REDESIGNED */
        .marketing-hero {
            background: linear-gradient(135deg, var(--navy) 0%, var(--cerulean-dark) 100%);
            color: white;
            padding: 120px 20px;
            text-align: center;
        }
        .marketing-hero h1 {
            font-family: var(--font-heading);
            font-size: 56px;
            margin-bottom: 24px;
            line-height: 1.2;
            max-width: 900px;
            margin-left: auto;
            margin-right: auto;
        }
        .marketing-hero .hero-subtitle {
            font-size: 20px;
            margin-bottom: 40px;
            color: rgba(255,255,255,0.95);
            max-width: 700px;
            margin-left: auto;
            margin-right: auto;
            line-height: 1.6;
        }
        .hero-cta {
            display: flex;
            gap: 20px;
            justify-content: center;
            flex-wrap: wrap;
        }
        .hero-cta .btn-lg {
            padding: 16px 48px;
            font-size: 18px;
            font-weight: 600;
        }

        /* Marketing Sections - REDESIGNED */
        .marketing-section {
            padding: 110px 20px;
        }
        .marketing-section.bg-cerulean {
            background: var(--cerulean-light);
        }
        .marketing-section.bg-white {
            background: white;
        }
        .section-title {
            font-family: var(--font-heading);
            font-size: 2.5rem;
            text-align: center;
            margin-bottom: 60px;
            color: var(--navy);
            max-width: 900px;
            margin-left: auto;
            margin-right: auto;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        /* Four Pillars Grid - REDESIGNED 2x2 with Greek key border */
        .pillars-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 32px;
            max-width: 1000px;
            margin: 0 auto;
            position: relative;
            padding: 40px;
        }

        .pillars-grid::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            border: 3px solid rgba(26, 58, 82, 0.18);
            border-radius: var(--radius-lg);
            pointer-events: none;
            background-image:
                repeating-linear-gradient(0deg, transparent, transparent 12px, rgba(26, 58, 82, 0.08) 12px, rgba(26, 58, 82, 0.08) 14px),
                repeating-linear-gradient(90deg, transparent, transparent 12px, rgba(26, 58, 82, 0.08) 12px, rgba(26, 58, 82, 0.08) 14px);
        }

        .pillar-card {
            background: white;
            padding: 40px;
            border-radius: var(--radius-lg);
            text-align: center;
            box-shadow: var(--shadow-md);
            border-top: 5px solid transparent;
            transition: all 0.3s ease;
            position: relative;
            z-index: 1;
        }
        .pillar-card:hover {
            transform: translateY(-6px);
            box-shadow: var(--shadow-xl);
        }
        .border-top-seafoam { border-top-color: var(--seafoam); }
        .border-top-terracotta { border-top-color: var(--terracotta); }
        .border-top-amber { border-top-color: var(--amber); }
        .border-top-cerulean { border-top-color: var(--cerulean); }

        .pillar-icon {
            width: 72px;
            height: 72px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 24px;
        }
        .pillar-icon.seafoam { background: var(--seafoam-light); color: var(--seafoam); }
        .pillar-icon.terracotta { background: var(--terracotta-light); color: var(--terracotta); }
        .pillar-icon.amber { background: var(--amber-light); color: var(--amber); }
        .pillar-icon.cerulean { background: var(--cerulean-light); color: var(--cerulean); }
        .pillar-icon i { width: 36px; height: 36px; }

        .pillar-card h3 {
            font-size: 1.5rem;
            margin-bottom: 16px;
            color: var(--navy);
            font-weight: 700;
        }
        .pillar-card p {
            color: var(--charcoal);
            line-height: 1.7;
            font-size: 1rem;
        }

        /* Steps Grid - REDESIGNED with larger circles */
        .steps-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 48px;
            max-width: 1200px;
            margin: 0 auto;
        }
        .step-card {
            text-align: center;
        }
        .step-number {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: var(--cerulean);
            color: white;
            font-size: 2rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 20px;
        }
        .step-card h4 {
            font-size: 1.3rem;
            margin-bottom: 12px;
            color: var(--navy);
            font-weight: 700;
        }
        .step-card p {
            font-size: 1rem;
            line-height: 1.6;
        }

        /* Features Grid - REDESIGNED 2x3 */
        .features-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 32px;
            max-width: 1100px;
            margin: 0 auto;
        }
        .feature-card {
            background: white;
            padding: 32px;
            border-radius: var(--radius-md);
            text-align: center;
            box-shadow: var(--shadow);
            transition: all 0.3s ease;
        }
        .feature-card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-lg);
        }
        .feature-card i {
            width: 40px;
            height: 40px;
            color: var(--cerulean);
            margin-bottom: 12px;
        }
        .feature-card h4 {
            margin-bottom: 12px;
            color: var(--navy);
            font-size: 1.2rem;
            font-weight: 700;
        }
        .feature-card p {
            color: var(--charcoal);
            line-height: 1.6;
        }

        /* Meet Nonna Section */
        .marketing-nonna {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 48px;
            align-items: center;
            max-width: 1000px;
            margin: 0 auto;
        }
        .nonna-intro {
            font-size: 1.2rem;
            color: var(--gray-text);
            margin-bottom: 24px;
        }
        .nonna-features {
            list-style: none;
            padding: 0;
        }
        .nonna-features li {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 12px;
            font-size: 1.05rem;
        }
        .nonna-features i {
            color: var(--seafoam);
            width: 20px;
            height: 20px;
            flex-shrink: 0;
        }
        .chat-preview {
            background: var(--gray-light);
            padding: 24px;
            border-radius: var(--radius-lg);
        }
        .chat-bubble {
            padding: 12px 16px;
            border-radius: var(--radius-md);
            margin-bottom: 12px;
        }
        .chat-bubble.user {
            background: var(--cerulean);
            color: white;
            margin-left: auto;
            max-width: 80%;
        }
        .chat-bubble.nonna {
            background: white;
            border: 1px solid var(--border-light);
            max-width: 85%;
        }

        /* Pricing Grid */
        .pricing-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 24px;
            max-width: 1000px;
            margin: 0 auto;
        }
        .pricing-card {
            background: white;
            padding: 32px;
            border-radius: var(--radius-lg);
            text-align: center;
            box-shadow: var(--shadow-md);
            position: relative;
            transition: all 0.3s ease;
        }
        .pricing-card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-xl);
        }
        .pricing-card.featured {
            border: 2px solid var(--cerulean);
            transform: scale(1.05);
        }
        .pricing-card .badge {
            position: absolute;
            top: -12px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--cerulean);
            color: white;
            padding: 4px 12px;
            border-radius: var(--radius-full);
            font-size: 0.85rem;
            font-weight: 600;
        }
        .pricing-card h3 {
            font-size: 1.5rem;
            margin-bottom: 16px;
            color: var(--navy);
        }
        .price {
            font-size: 3rem;
            font-weight: 700;
            color: var(--navy);
            margin: 16px 0;
        }
        .price span {
            font-size: 1.2rem;
            color: var(--gray-text);
        }
        .pricing-card ul {
            list-style: none;
            padding: 0;
            margin: 24px 0;
            text-align: left;
        }
        .pricing-card ul li {
            padding: 8px 0;
            border-bottom: 1px solid var(--border-light);
        }

        /* Marketing Footer */
        /* Final CTA Section */
        .marketing-cta-final {
            background: var(--navy);
            color: white;
            padding: 100px 20px;
            text-align: center;
        }
        .marketing-cta-final h2 {
            font-family: var(--font-heading);
            font-size: 2.5rem;
            margin-bottom: 16px;
            color: white;
        }
        .marketing-cta-final p {
            font-size: 1.2rem;
            margin-bottom: 32px;
            color: rgba(255,255,255,0.9);
        }
        .btn-xl {
            padding: 18px 56px;
            font-size: 20px;
            font-weight: 700;
        }

        .marketing-footer {
            background: #0f2333;
            color: rgba(255,255,255,0.8);
            padding: 48px 20px 24px;
        }
        .footer-grid {
            display: grid;
            grid-template-columns: 2fr 1fr 1fr;
            gap: 32px;
            max-width: 1200px;
            margin: 0 auto 32px;
        }
        .footer-grid h4 {
            color: white;
            margin-bottom: 16px;
        }
        .footer-grid h5 {
            color: white;
            margin-bottom: 12px;
        }
        .footer-grid a {
            display: block;
            color: rgba(255,255,255,0.7);
            text-decoration: none;
            margin-bottom: 8px;
            transition: color 0.2s;
        }
        .footer-grid a:hover {
            color: white;
        }
        .footer-bottom {
            text-align: center;
            padding-top: 24px;
            border-top: 1px solid rgba(255,255,255,0.1);
            max-width: 1200px;
            margin: 0 auto;
        }

        /* About Page */
        .about-header {
            background: var(--navy);
            padding: 16px 20px;
        }
        .about-content {
            max-width: 700px;
            margin: 0 auto;
            padding: 48px 20px;
            background: #FAEBD7;
        }
        .about-hero {
            text-align: center;
            margin-bottom: 64px;
        }
        .about-hero h1 {
            font-family: var(--font-heading);
            font-size: 2.5rem;
            color: var(--navy);
            margin-bottom: 12px;
            line-height: 1.2;
        }
        .about-subtitle {
            font-family: var(--font-script);
            font-size: 1.3rem;
            color: var(--cerulean);
        }
        .about-story {
            margin-bottom: 48px;
        }
        .about-story h2 {
            font-family: var(--font-heading);
            font-size: 2rem;
            color: var(--navy);
            margin-bottom: 32px;
        }
        .about-story h3 {
            font-family: var(--font-heading);
            font-size: 1.5rem;
            color: var(--navy);
            margin: 48px 0 24px;
        }
        .about-story p {
            font-size: 18px;
            line-height: 1.8;
            color: var(--charcoal);
            margin-bottom: 24px;
        }
        .pullquote {
            font-size: 20px;
            line-height: 1.7;
            color: var(--seafoam);
            font-weight: 500;
            padding: 24px;
            background: white;
            border-left: 4px solid var(--seafoam);
            margin: 32px 0;
            font-style: italic;
        }
        .founder-signature {
            font-family: var(--font-script);
            font-size: 1.5rem;
            color: var(--navy);
            margin-top: 48px;
            text-align: right;
        }
        .about-four-pillars {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 24px;
            margin: 32px 0;
        }
        .about-four-pillars .pillar-card {
            background: white;
            padding: 24px;
            border-radius: var(--radius-lg);
            border-top: 4px solid var(--seafoam);
            box-shadow: var(--shadow-md);
        }
        .about-four-pillars .pillar-icon {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background: var(--seafoam-light);
            color: var(--seafoam);
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 16px;
        }
        .about-four-pillars .pillar-icon i {
            width: 24px;
            height: 24px;
        }
        .about-four-pillars h4 {
            font-size: 1.2rem;
            color: var(--navy);
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .about-four-pillars h4 i {
            width: 20px;
            height: 20px;
            color: var(--seafoam);
        }
        .about-four-pillars p {
            font-size: 16px;
            line-height: 1.6;
            color: var(--charcoal);
        }

        @media (max-width: 768px) {
            .about-hero h1 {
                font-size: 2rem;
            }
            .about-story p {
                font-size: 16px;
            }
            .pullquote {
                font-size: 18px;
            }
        }

        /* FAQ Page */
        .faq-page {
            display: none;
            background: var(--page-bg);
        }
        .faq-page.active {
            display: block;
        }
        .faq-header {
            background: var(--navy);
            padding: 16px 20px;
        }
        .faq-content {
            max-width: 800px;
            margin: 0 auto;
            padding: 48px 20px;
        }
        .faq-hero {
            text-align: center;
            margin-bottom: 48px;
        }
        .faq-hero h1 {
            font-family: var(--font-heading);
            font-size: 2.5rem;
            color: var(--navy);
            margin-bottom: 12px;
        }
        .faq-subtitle {
            font-size: 1.2rem;
            color: var(--charcoal);
        }
        .faq-accordion {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }
        .faq-item {
            background: white;
            border-radius: var(--radius-md);
            overflow: hidden;
            box-shadow: var(--shadow-sm);
            transition: box-shadow 0.2s;
        }
        .faq-item.active {
            box-shadow: var(--shadow-md);
        }
        .faq-question {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 24px;
            cursor: pointer;
            background: white;
            transition: background 0.2s;
        }
        .faq-question:hover {
            background: var(--gray-light);
        }
        .faq-item.active .faq-question {
            background: var(--seafoam-light);
        }
        .faq-question span {
            font-size: 18px;
            font-weight: 600;
            color: var(--navy);
        }
        .faq-arrow {
            width: 20px;
            height: 20px;
            color: var(--cerulean);
            transition: transform 0.3s;
            flex-shrink: 0;
        }
        .faq-item.active .faq-arrow {
            transform: rotate(180deg);
        }
        .faq-answer {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease, padding 0.3s ease;
        }
        .faq-item.active .faq-answer {
            max-height: 500px;
            padding: 0 24px 24px;
        }
        .faq-answer p {
            font-size: 16px;
            line-height: 1.6;
            color: var(--charcoal);
            margin: 0;
        }

        @media (max-width: 768px) {
            .faq-hero h1 {
                font-size: 2rem;
            }
            .faq-question span {
                font-size: 16px;
            }
            .faq-answer p {
                font-size: 14px;
            }
        }

        /* Responsive - Marketing Page */
        @media (max-width: 768px) {
            .marketing-hero {
                padding: 60px 20px;
            }
            .marketing-hero h1 {
                font-size: 2.2rem;
            }
            .marketing-hero .hero-subtitle {
                font-size: 1.1rem;
            }
            .hero-cta .btn-lg {
                padding: 14px 32px;
                font-size: 16px;
            }
            .marketing-section {
                padding: 60px 20px;
            }
            .section-title {
                font-size: 1.8rem;
                margin-bottom: 32px;
            }
            .pillars-grid {
                grid-template-columns: 1fr;
                padding: 20px;
                gap: 20px;
            }
            .features-grid {
                grid-template-columns: 1fr;
                gap: 20px;
            }
            .steps-grid {
                grid-template-columns: 1fr;
                gap: 32px;
            }
            .step-number {
                width: 64px;
                height: 64px;
                font-size: 1.5rem;
            }
            .marketing-nonna {
                grid-template-columns: 1fr;
            }
            .marketing-cta-final {
                padding: 60px 20px;
            }
            .marketing-cta-final h2 {
                font-size: 1.8rem;
            }
            .btn-xl {
                padding: 14px 36px;
                font-size: 16px;
            }
            .footer-grid {
                grid-template-columns: 1fr;
            }
            .pricing-card.featured {
                transform: scale(1);
            }
        }

        /* Accessibility: Respect user motion preferences */
        @media (prefers-reduced-motion: reduce) {
            *,
            *::before,
            *::after {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
                scroll-behavior: auto !important;
            }
        }

        /* Quick Chat Dropdown Styles */
        .quick-chat-container {
            position: relative;
        }

        .quick-chat-btn {
            background: none;
            border: none;
            color: var(--navy);
            cursor: pointer;
            padding: 8px;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: var(--radius-md);
        }

        .quick-chat-btn:hover {
            background: var(--gray-light);
            color: var(--cerulean);
        }

        .quick-chat-btn i {
            width: 20px;
            height: 20px;
        }

        .quick-chat-dropdown {
            position: absolute;
            top: calc(100% + 8px);
            right: 0;
            width: 350px;
            max-height: 500px;
            background: white;
            border-radius: var(--radius-md);
            box-shadow: var(--shadow-xl);
            display: none;
            flex-direction: column;
            z-index: 1000;
            border: 1px solid var(--border-light);
        }

        .quick-chat-dropdown.active {
            display: flex;
        }

        .quick-chat-header {
            padding: 12px 16px;
            border-bottom: 1px solid var(--border-light);
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: var(--cerulean-light);
            border-radius: var(--radius-md) var(--radius-md) 0 0;
        }

        .quick-chat-context {
            font-weight: 600;
            color: var(--navy);
            font-size: 0.9rem;
        }

        .quick-chat-close {
            background: none;
            border: none;
            font-size: 24px;
            color: var(--gray-text);
            cursor: pointer;
            padding: 0;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: color 0.2s;
        }

        .quick-chat-close:hover {
            color: var(--navy);
        }

        .quick-chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 12px;
            max-height: 350px;
            min-height: 200px;
        }

        .quick-chat-message {
            margin-bottom: 12px;
        }

        .quick-chat-message.user .message-bubble {
            background: var(--cerulean);
            color: white;
            margin-left: auto;
            max-width: 80%;
        }

        .quick-chat-message.assistant .message-bubble {
            background: var(--gray-light);
            color: var(--text-primary);
            margin-right: auto;
            max-width: 80%;
        }

        .quick-chat-message .message-bubble {
            padding: 8px 12px;
            border-radius: var(--radius-md);
            font-size: 0.9rem;
            line-height: 1.4;
            word-wrap: break-word;
        }

        .quick-chat-input-wrapper {
            display: flex;
            gap: 8px;
            padding: 12px;
            border-top: 1px solid var(--border-light);
            background: var(--page-bg);
        }

        .quick-chat-input {
            flex: 1;
            padding: 8px 12px;
            border: 1px solid var(--border-light);
            border-radius: var(--radius-md);
            font-size: 0.9rem;
            outline: none;
            transition: border-color 0.2s;
        }

        .quick-chat-input:focus {
            border-color: var(--cerulean);
        }

        .quick-chat-send {
            background: var(--cerulean);
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: var(--radius-md);
            cursor: pointer;
            transition: background 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .quick-chat-send:hover {
            background: var(--cerulean-dark);
        }

        .quick-chat-send i {
            width: 16px;
            height: 16px;
        }

        .quick-chat-footer {
            padding: 8px 16px;
            border-top: 1px solid var(--border-light);
            text-align: center;
            background: var(--page-bg);
            border-radius: 0 0 var(--radius-md) var(--radius-md);
        }

        .quick-chat-footer a {
            color: var(--cerulean);
            text-decoration: none;
            font-size: 0.85rem;
            transition: color 0.2s;
        }

        .quick-chat-footer a:hover {
            color: var(--cerulean-dark);
            text-decoration: underline;
        }

        /* Mobile adjustments for quick chat */
        @media (max-width: 768px) {
            .quick-chat-dropdown {
                width: 90vw;
                max-width: 350px;
                right: -20px;
            }
        }

        /* Dedicated Nonna Page Styles */
        .nonna-page-container {
            display: flex;
            height: calc(100vh - 120px);
            gap: 0;
            background: var(--page-bg);
        }

        .nonna-sidebar {
            width: 280px;
            background: white;
            border-right: 1px solid var(--border-light);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .sidebar-header {
            padding: 16px;
            border-bottom: 1px solid var(--border-light);
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: var(--cerulean-light);
        }

        .sidebar-header h3 {
            margin: 0;
            font-size: 1.1rem;
            color: var(--navy);
        }

        .conversation-context {
            padding: 12px 16px;
            background: var(--seafoam-light);
            border-bottom: 1px solid var(--border-light);
            font-size: 0.85rem;
        }

        .conversation-context.hidden {
            display: none;
        }

        .conversation-context-title {
            font-weight: 600;
            color: var(--navy);
            margin-bottom: 6px;
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .conversation-context-summary {
            color: var(--charcoal);
            line-height: 1.4;
        }

        .conversation-quick-actions {
            padding: 12px;
            border-bottom: 1px solid var(--border-light);
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .conversation-quick-actions.hidden {
            display: none;
        }

        .quick-action-btn {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            background: white;
            border: 1px solid var(--border-light);
            border-radius: var(--radius-sm);
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.85rem;
            color: var(--charcoal);
        }

        .quick-action-btn:hover {
            background: var(--cerulean-light);
            border-color: var(--cerulean);
        }

        .quick-action-btn i {
            width: 16px;
            height: 16px;
            color: var(--seafoam);
        }

        .conversation-list {
            flex: 1;
            overflow-y: auto;
            padding: 8px;
        }

        .conversation-item {
            padding: 12px;
            border-radius: var(--radius-md);
            margin-bottom: 4px;
            cursor: pointer;
            transition: background 0.2s;
            border-left: 3px solid transparent;
        }

        .conversation-item:hover {
            background: var(--gray-light);
        }

        .conversation-item.active {
            background: var(--cerulean-light);
            border-left-color: var(--cerulean);
        }

        .conversation-item-title {
            font-weight: 600;
            font-size: 0.9rem;
            color: var(--navy);
            margin-bottom: 4px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .conversation-item-preview {
            font-size: 0.8rem;
            color: var(--gray-text);
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .conversation-item-time {
            font-size: 0.75rem;
            color: var(--gray-text);
            margin-top: 4px;
        }

        .nonna-main-chat {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: white;
            overflow: hidden;
        }

        .chat-header-nonna {
            padding: 20px 24px;
            border-bottom: 1px solid var(--border-light);
            background: var(--cerulean-light);
        }

        .chat-header-nonna h2 {
            margin: 0 0 4px 0;
            color: var(--navy);
            font-size: 1.5rem;
        }

        .chat-header-nonna .text-muted {
            margin: 0;
            font-size: 0.9rem;
        }

        .chat-messages-nonna {
            flex: 1;
            overflow-y: auto;
            padding: 24px;
            background: var(--page-bg);
        }

        .chat-messages-nonna .message {
            margin-bottom: 16px;
            display: flex;
            flex-direction: column;
        }

        .chat-messages-nonna .message.message-user {
            align-items: flex-end;
        }

        .chat-messages-nonna .message.message-assistant {
            align-items: flex-start;
        }

        .chat-messages-nonna .message-bubble {
            max-width: 70%;
            padding: 12px 16px;
            border-radius: var(--radius-md);
            line-height: 1.5;
            word-wrap: break-word;
        }

        .chat-messages-nonna .message-user .message-bubble {
            background: var(--cerulean);
            color: white;
        }

        .chat-messages-nonna .message-assistant .message-bubble {
            background: white;
            color: var(--text-primary);
            border: 1px solid var(--border-light);
        }

        .chat-input-container-nonna {
            padding: 16px 24px;
            border-top: 1px solid var(--border-light);
            background: white;
            display: flex;
            gap: 12px;
            align-items: flex-end;
        }

        .chat-input-nonna {
            flex: 1;
            padding: 12px 16px;
            border: 1px solid var(--border-light);
            border-radius: var(--radius-md);
            font-size: 1rem;
            font-family: var(--font-body);
            resize: none;
            outline: none;
            transition: border-color 0.2s;
            max-height: 120px;
        }

        .chat-input-nonna:focus {
            border-color: var(--cerulean);
        }

        .chat-send-btn-nonna {
            background: var(--cerulean);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: var(--radius-md);
            cursor: pointer;
            transition: background 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            min-width: 50px;
        }

        .chat-send-btn-nonna:hover {
            background: var(--cerulean-dark);
        }

        .chat-send-btn-nonna:disabled {
            background: var(--gray-light);
            cursor: not-allowed;
        }

        .chat-send-btn-nonna i {
            width: 18px;
            height: 18px;
        }

        .chat-voice-btn-nonna {
            background: none;
            border: none;
            color: var(--charcoal);
            padding: 12px;
            border-radius: var(--radius-md);
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .chat-voice-btn-nonna:hover {
            background: var(--gray-light);
            color: var(--seafoam);
        }

        .chat-voice-btn-nonna.recording {
            background: var(--seafoam-light);
            color: var(--seafoam);
        }

        .chat-voice-btn-nonna i {
            width: 24px;
            height: 24px;
        }

        /* Inline Recipe Cards in Chat */
        .chat-recipe-card {
            background: white;
            border-left: 4px solid var(--seafoam);
            border-radius: var(--radius-md);
            padding: 24px;
            margin: 16px 0;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
            max-width: 100%;
        }

        .chat-recipe-card.collapsed {
            cursor: pointer;
        }

        .chat-recipe-card.collapsed:hover {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.12);
        }

        .recipe-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .recipe-card-title {
            font-size: 20px;
            font-weight: 600;
            color: var(--navy);
            margin: 0;
        }

        .recipe-card-expand {
            color: var(--seafoam);
            font-size: 14px;
            cursor: pointer;
            user-select: none;
        }

        .recipe-metadata {
            display: flex;
            gap: 16px;
            flex-wrap: wrap;
            margin-bottom: 16px;
            font-size: 14px;
            color: var(--gray-text);
        }

        .recipe-metadata-item {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .recipe-metadata-item i {
            width: 16px;
            height: 16px;
        }

        .recipe-tags {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            margin-bottom: 16px;
        }

        .recipe-tag {
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
        }

        .recipe-tag.health {
            background: var(--seafoam-light);
            color: var(--seafoam);
        }

        .recipe-tag.dietary {
            background: var(--cerulean-light);
            color: var(--cerulean);
        }

        .recipe-tag.cuisine {
            background: rgba(26, 58, 82, 0.1);
            color: var(--navy);
        }

        .recipe-section {
            margin-bottom: 20px;
        }

        .recipe-section-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--navy);
            margin-bottom: 12px;
        }

        .recipe-ingredients, .recipe-instructions {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .recipe-ingredients li {
            padding: 8px 0;
            border-bottom: 1px solid var(--border-light);
            color: var(--charcoal);
        }

        .recipe-instructions li {
            padding: 12px 0;
            padding-left: 32px;
            position: relative;
            color: var(--charcoal);
            line-height: 1.6;
        }

        .recipe-instructions li::before {
            content: attr(data-step);
            position: absolute;
            left: 0;
            top: 12px;
            width: 24px;
            height: 24px;
            background: var(--seafoam);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: 600;
        }

        .recipe-nutrition {
            background: var(--gray-light);
            padding: 16px;
            border-radius: var(--radius-sm);
            margin-bottom: 16px;
        }

        .recipe-nutrition-toggle {
            cursor: pointer;
            font-weight: 600;
            color: var(--navy);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .recipe-nutrition-content {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-top: 12px;
            font-size: 14px;
        }

        .recipe-nutrition-content.hidden {
            display: none;
        }

        .recipe-actions {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid var(--border-light);
        }

        .recipe-action-primary {
            position: relative;
        }

        .recipe-day-dropdown {
            position: absolute;
            bottom: 100%;
            left: 0;
            margin-bottom: 8px;
            background: white;
            border-radius: var(--radius-md);
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.15);
            padding: 8px;
            min-width: 150px;
            display: none;
            z-index: 100;
        }

        .recipe-day-dropdown.active {
            display: block;
        }

        .recipe-day-option {
            padding: 8px 12px;
            cursor: pointer;
            border-radius: var(--radius-sm);
            transition: background 0.2s;
        }

        .recipe-day-option:hover {
            background: var(--cerulean-light);
        }

        /* Mobile adjustments for Nonna page */
        @media (max-width: 768px) {
            .nonna-page-container {
                height: calc(100vh - 140px);
            }

            .nonna-sidebar {
                display: none;
            }

            .chat-messages-nonna .message-bubble {
                max-width: 85%;
            }

            .chat-input-container-nonna {
                padding: 12px 16px;
            }
        }
    </style>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js';
        import { getAuth, signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js';
        import { getFirestore, doc, setDoc, getDoc, collection, query, where, getDocs, deleteDoc, writeBatch, serverTimestamp, onSnapshot } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js';
        import { getStorage, ref, uploadBytes, getDownloadURL, deleteObject } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-storage.js';

        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyB-TyujX9jkwj_RaDdBhN17A9bZuBqGPLQ",
            authDomain: "tavola-58e0e.firebaseapp.com",
            projectId: "tavola-58e0e",
            storageBucket: "tavola-58e0e.firebasestorage.app",
            messagingSenderId: "486187712746",
            appId: "1:486187712746:web:07d5365afa765e3bd15793",
            measurementId: "G-2Y0WHB6CVD"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const storage = getStorage(app);
        const googleProvider = new GoogleAuthProvider();

        // Make Firebase available globally for the app
        window.firebaseApp = app;
        window.firebaseAuth = auth;
        window.firebaseDb = db;
        window.firebaseStorage = storage;
        window.firebaseGoogleProvider = googleProvider;

        // Export Firebase functions globally
        window.firebaseSignInWithPopup = signInWithPopup;
        window.firebaseSignOut = signOut;
        window.firebaseOnAuthStateChanged = onAuthStateChanged;
        window.firestoreDoc = doc;
        window.firestoreSetDoc = setDoc;
        window.firestoreGetDoc = getDoc;
        window.firestoreCollection = collection;
        window.firestoreQuery = query;
        window.firestoreWhere = where;
        window.firestoreGetDocs = getDocs;
        window.firestoreDeleteDoc = deleteDoc;
        window.firestoreWriteBatch = writeBatch;
        window.firestoreServerTimestamp = serverTimestamp;
        window.firestoreOnSnapshot = onSnapshot;
        window.storageRef = ref;
        window.storageUploadBytes = uploadBytes;
        window.storageGetDownloadURL = getDownloadURL;
        window.storageDeleteObject = deleteObject;

        // Signal that Firebase is ready
        window.firebaseReady = true;
        window.dispatchEvent(new CustomEvent('firebase-ready'));
    </script>

    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
</head>
<body>
    <!-- Header -->
    <header class="header hidden" id="app-header">
        <div class="container header-content">
            <a href="#" class="logo" onclick="navigateTo('home'); return false;">Tavola</a>

            <!-- Mobile: keep original header-right for small screens -->
            <div class="header-right">
                <button class="nav-settings-btn" onclick="navigateTo('more'); switchMoreTab('settings');" title="Settings">
                    <i data-lucide="settings"></i>
                </button>
                <div class="quick-chat-container">
                    <button class="quick-chat-btn" onclick="toggleQuickChat()" title="Quick Chat with Nonna">
                        <i data-lucide="message-square"></i>
                    </button>
                    <div class="quick-chat-dropdown" id="quick-chat-dropdown">
                        <div class="quick-chat-header">
                            <div class="quick-chat-context" id="quick-chat-context">Chat with Nonna</div>
                            <button class="quick-chat-close" onclick="closeQuickChat()">Ã—</button>
                        </div>
                        <div class="quick-chat-messages" id="quick-chat-messages"></div>
                        <div class="quick-chat-input-wrapper">
                            <input type="text" class="quick-chat-input" id="quick-chat-input" placeholder="Ask Nonna..." />
                            <button class="quick-chat-send" onclick="sendQuickChatMessage()">
                                <i data-lucide="send"></i>
                            </button>
                        </div>
                        <div class="quick-chat-footer">
                            <a href="#" onclick="openFullChat(); return false;">Open full chat â†’</a>
                        </div>
                    </div>
                </div>
                <div class="header-search" id="global-search">
                    <span><i data-lucide="search" style="width:16px;height:16px"></i></span>
                    <input type="text" placeholder="Search..." id="global-search-input" onkeyup="handleGlobalSearch(event)">
                </div>
                <div class="auth-section">
                    <div class="user-info" id="user-info" style="display: none;"></div>
                    <span class="sync-status" id="sync-status"></span>
                    <button class="auth-btn" id="auth-btn" onclick="signInWithGoogle()">
                        <span class="icon"><i data-lucide="lock" style="width:16px;height:16px"></i></span> Sign In
                    </button>
                </div>
            </div>

            <!-- Desktop: center nav items -->
            <nav class="header-desktop-center" id="desktop-nav">
                <div class="desktop-nav-group">
                    <button class="desktop-nav-btn" data-nav="home" onclick="navigateTo('home'); closeAllDropdowns();">
                        <i data-lucide="home"></i> Home
                    </button>
                </div>
                <div class="desktop-nav-group" id="desktop-cooking-group">
                    <button class="desktop-nav-btn" data-nav="cooking" onclick="toggleDesktopDropdown('desktop-cooking-dropdown')">
                        <i data-lucide="chef-hat"></i> Cooking <i data-lucide="chevron-down" class="chevron"></i>
                    </button>
                    <div class="nav-dropdown-menu" id="desktop-cooking-dropdown">
                        <button class="nav-dropdown-item" onclick="navAction('nonna')"><i data-lucide="message-circle"></i> Chat with Nonna</button>
                        <button class="nav-dropdown-item" onclick="navAction('recipes')"><i data-lucide="book-open"></i> Recipes</button>
                        <button class="nav-dropdown-item" onclick="navAction('favorites')"><i data-lucide="heart"></i> Favorites</button>
                        <button class="nav-dropdown-item" onclick="navAction('family')"><i data-lucide="users"></i> Family Tavola</button>
                        <button class="nav-dropdown-item" onclick="navAction('import-recipe')"><i data-lucide="download"></i> Import Recipe</button>
                        <button class="nav-dropdown-item" onclick="navAction('leftovers')"><i data-lucide="wand-sparkles"></i> Transform Leftovers</button>
                        <button class="nav-dropdown-item" onclick="navAction('collections')"><i data-lucide="library"></i> Collections</button>
                    </div>
                </div>
                <div class="desktop-nav-group" id="desktop-plan-group">
                    <button class="desktop-nav-btn" data-nav="plan" onclick="toggleDesktopDropdown('desktop-plan-dropdown')">
                        <i data-lucide="calendar"></i> Plan <i data-lucide="chevron-down" class="chevron"></i>
                    </button>
                    <div class="nav-dropdown-menu" id="desktop-plan-dropdown">
                        <button class="nav-dropdown-item" onclick="navAction('week')"><i data-lucide="calendar-days"></i> This Week</button>
                        <button class="nav-dropdown-item" onclick="navAction('history')"><i data-lucide="clock"></i> Meal History</button>
                        <button class="nav-dropdown-item" onclick="navAction('batch')"><i data-lucide="cooking-pot"></i> Batch Prep</button>
                    </div>
                </div>
                <div class="desktop-nav-group" id="desktop-pantry-group">
                    <button class="desktop-nav-btn" data-nav="pantry" onclick="toggleDesktopDropdown('desktop-pantry-dropdown')">
                        <i data-lucide="warehouse"></i> Pantry <i data-lucide="chevron-down" class="chevron"></i>
                    </button>
                    <div class="nav-dropdown-menu" id="desktop-pantry-dropdown">
                        <button class="nav-dropdown-item" onclick="navAction('pantry')"><i data-lucide="package"></i> My Pantry</button>
                        <button class="nav-dropdown-item" onclick="navAction('shopping')"><i data-lucide="shopping-cart"></i> Shopping List</button>
                        <button class="nav-dropdown-item" onclick="navAction('garden')"><i data-lucide="flower-2"></i> Garden</button>
                        <button class="nav-dropdown-item" onclick="navAction('crohns')"><i data-lucide="shield-plus"></i> Crohn's Care</button>
                    </div>
                </div>
                <div class="desktop-nav-group">
                    <button class="desktop-nav-btn" data-nav="nonna" onclick="navigateTo('nonna'); closeAllDropdowns();">
                        <i data-lucide="message-circle"></i> Nonna
                    </button>
                </div>
                <div class="desktop-nav-group">
                    <button class="desktop-nav-btn" data-nav="workouts" onclick="navigateTo('workouts'); closeAllDropdowns();">
                        <i data-lucide="dumbbell"></i> Workouts
                    </button>
                </div>
            </nav>

            <!-- Desktop: right section -->
            <div class="header-desktop-right">
                <button class="nav-settings-btn" onclick="navigateTo('more'); switchMoreTab('settings');" title="Settings">
                    <i data-lucide="settings"></i>
                </button>
                <div class="header-search">
                    <span><i data-lucide="search" style="width:16px;height:16px"></i></span>
                    <input type="text" placeholder="Search..." onkeyup="handleGlobalSearch(event)">
                </div>
                <div class="auth-section">
                    <div class="user-info" id="user-info-desktop" style="display: none;"></div>
                    <span class="sync-status" id="sync-status-desktop"></span>
                    <button class="auth-btn" onclick="signInWithGoogle()">
                        <span class="icon"><i data-lucide="lock" style="width:16px;height:16px"></i></span> Sign In
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- Marketing Homepage (logged-out users) -->
    <div class="marketing-page" id="view-marketing" style="display:none;">
        <!-- Hero Section -->
        <section class="marketing-hero">
            <div class="container">
                <h1>Your AI sous chef for Mediterranean meal planning</h1>
                <p class="hero-subtitle">Discover diverse, delicious cooking without the hassle. Let Nonna handle the planning, shopping and stress so you can focus on the joy of cooking and eating well.</p>
                <div class="hero-cta">
                    <button class="btn btn-primary btn-lg" onclick="showIntakeForm()">Get Started Free</button>
                    <button class="btn btn-secondary btn-lg" onclick="showMarketingAbout()">Learn More</button>
                </div>
            </div>
        </section>

        <!-- Four Pillars -->
        <section class="marketing-section bg-cerulean">
            <div class="container">
                <h2 class="section-title">Tavola is for people who love food and need it to work for their lives</h2>
                <div class="pillars-grid pillars-four">
                    <div class="pillar-card border-top-seafoam">
                        <div class="pillar-icon seafoam"><i data-lucide="heart"></i></div>
                        <h3>Food Lovers</h3>
                        <p>Whether you're batch-cooking Mediterranean feasts or experimenting with new cuisines, Tavola helps you plan, organize and cook with confidence. Your personal AI sous chef, Nonna, is always ready to help.</p>
                    </div>
                    <div class="pillar-card border-top-terracotta">
                        <div class="pillar-icon terracotta"><i data-lucide="users"></i></div>
                        <h3>Families & Community</h3>
                        <p>Share recipes with loved ones through Family Tavola. Learn from your mom's favorites, swap cooking tips with your sister and build a shared family cookbook that spans generations.</p>
                    </div>
                    <div class="pillar-card border-top-amber">
                        <div class="pillar-icon amber"><i data-lucide="shield-plus"></i></div>
                        <h3>Chronic Illness Warriors</h3>
                        <p>Managing Crohn's, UC, IBS or other digestive conditions? Tavola filters recipes by health tags, tracks trigger foods and provides gentle meal options during flares. Nutrition as medicine.</p>
                    </div>
                    <div class="pillar-card border-top-cerulean">
                        <div class="pillar-icon cerulean"><i data-lucide="target"></i></div>
                        <h3>Health-Conscious Eaters</h3>
                        <p>Weight loss, heart health, diabetes management: whatever your goals, Tavola helps you eat well without sacrificing flavor. Mediterranean patterns that naturally support wellness.</p>
                    </div>
                </div>
            </div>
        </section>

        <!-- How It Works -->
        <section class="marketing-section bg-white">
            <div class="container">
                <h2 class="section-title">How It Works</h2>
                <div class="steps-grid">
                    <div class="step-card">
                        <div class="step-number">1</div>
                        <h4>Chat with Nonna</h4>
                        <p>Tell Nonna about your week, dietary needs and what's in your pantry</p>
                    </div>
                    <div class="step-card">
                        <div class="step-number">2</div>
                        <h4>Get Your Plan</h4>
                        <p>Receive personalized meal plans with recipes, nutrition info and cooking tips</p>
                    </div>
                    <div class="step-card">
                        <div class="step-number">3</div>
                        <h4>Smart Shopping Lists</h4>
                        <p>Auto-generated lists based on your pantry: only buy what you need</p>
                    </div>
                    <div class="step-card">
                        <div class="step-number">4</div>
                        <h4>Cook with Confidence</h4>
                        <p>Follow recipes, track leftovers, share favorites with family</p>
                    </div>
                </div>
            </div>
        </section>

        <!-- Features Grid -->
        <section class="marketing-section bg-cerulean">
            <div class="container">
                <h2 class="section-title">Everything You Need</h2>
                <div class="features-grid">
                    <div class="feature-card">
                        <i data-lucide="message-circle"></i>
                        <h4>Chat with Nonna</h4>
                        <p>AI cooking companion available 24/7</p>
                    </div>
                    <div class="feature-card">
                        <i data-lucide="calendar-days"></i>
                        <h4>Smart Meal Planning</h4>
                        <p>Weekly plans that adapt to your schedule</p>
                    </div>
                    <div class="feature-card">
                        <i data-lucide="warehouse"></i>
                        <h4>Pantry Management</h4>
                        <p>Track ingredients, reduce waste</p>
                    </div>
                    <div class="feature-card">
                        <i data-lucide="book-open"></i>
                        <h4>Recipe Library</h4>
                        <p>Curated Mediterranean collection</p>
                    </div>
                    <div class="feature-card">
                        <i data-lucide="sprout"></i>
                        <h4>Garden Integration</h4>
                        <p>Cook with what you grow</p>
                    </div>
                    <div class="feature-card">
                        <i data-lucide="heart-pulse"></i>
                        <h4>Flare Mode</h4>
                        <p>Gentle meals for difficult days</p>
                    </div>
                </div>
            </div>
        </section>

        <!-- Meet Nonna -->
        <section class="marketing-section bg-white">
            <div class="container">
                <div class="marketing-nonna">
                    <div class="nonna-content">
                        <h2>Meet Nonna</h2>
                        <p class="nonna-intro">Your wise, patient kitchen companion who understands Mediterranean cooking and digestive wellness.</p>
                        <ul class="nonna-features">
                            <li><i data-lucide="check-circle"></i> Answers cooking questions instantly</li>
                            <li><i data-lucide="check-circle"></i> Suggests recipes based on what you have</li>
                            <li><i data-lucide="check-circle"></i> Adapts to your health needs</li>
                            <li><i data-lucide="check-circle"></i> Remembers your preferences</li>
                        </ul>
                    </div>
                    <div class="nonna-visual">
                        <div class="chat-preview">
                            <div class="chat-bubble user">What can I make with leftover chicken and spinach?</div>
                            <div class="chat-bubble nonna">Cara, a beautiful Mediterranean spinach and chicken frittata! Let me guide you...</div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Pricing -->
        <section class="marketing-section bg-cerulean">
            <div class="container">
                <h2 class="section-title">Simple Pricing</h2>
                <div class="pricing-grid">
                    <div class="pricing-card">
                        <h3>Free</h3>
                        <div class="price">$0<span>/month</span></div>
                        <ul>
                            <li>Chat with Nonna</li>
                            <li>Basic meal planning</li>
                            <li>Recipe library access</li>
                        </ul>
                        <button class="btn btn-secondary" onclick="showIntakeForm()">Start Free</button>
                    </div>
                    <div class="pricing-card featured">
                        <div class="badge">Most Popular</div>
                        <h3>Plus</h3>
                        <div class="price">$9<span>/month</span></div>
                        <ul>
                            <li>Everything in Free</li>
                            <li>Advanced meal planning</li>
                            <li>Pantry tracking</li>
                            <li>Family recipe sharing</li>
                        </ul>
                        <button class="btn btn-primary" onclick="showIntakeForm()">Coming Soon</button>
                    </div>
                    <div class="pricing-card">
                        <h3>Family</h3>
                        <div class="price">$19<span>/month</span></div>
                        <ul>
                            <li>Everything in Plus</li>
                            <li>Up to 5 family members</li>
                            <li>Shared meal plans</li>
                            <li>Priority support</li>
                        </ul>
                        <button class="btn btn-secondary" onclick="showIntakeForm()">Coming Soon</button>
                    </div>
                </div>
            </div>
        </section>

        <!-- Final CTA -->
        <section class="marketing-cta-final">
            <div class="container">
                <h2>Ready to transform your kitchen?</h2>
                <p>Join thousands cooking smarter with Mediterranean meal planning</p>
                <button class="btn btn-primary btn-xl" onclick="showIntakeForm()">
                    <i data-lucide="chef-hat"></i> Start Free Today
                </button>
            </div>
        </section>

        <!-- Footer -->
        <footer class="marketing-footer">
            <div class="container">
                <div class="footer-grid">
                    <div>
                        <h4>Tavola</h4>
                        <p>Mediterranean meal planning for digestive wellness</p>
                    </div>
                    <div>
                        <h5>Product</h5>
                        <a href="#" onclick="showMarketingAbout(); return false;">About</a>
                        <a href="#" onclick="showFAQPage(); return false;">FAQ</a>
                        <a href="#" onclick="showIntakeForm(); return false;">Get Started</a>
                    </div>
                    <div>
                        <h5>Resources</h5>
                        <a href="#">Privacy Policy</a>
                        <a href="#">Terms of Service</a>
                    </div>
                </div>
                <div class="footer-bottom">
                    <p>&copy; 2024 Tavola. Made with <i data-lucide="heart" style="width:14px;height:14px;vertical-align:middle;"></i> for digestive wellness.</p>
                </div>
            </div>
        </footer>
    </div>

    <!-- About Page -->
    <div class="about-page" id="view-about" style="display:none;">
        <header class="about-header">
            <div class="container">
                <button class="btn btn-secondary" onclick="navigateBackFromAbout()"><i data-lucide="arrow-left"></i> Back</button>
            </div>
        </header>
        <div class="about-content">
            <div class="about-hero">
                <h1>Tavola: Where food brings us together</h1>
                <p class="about-subtitle">Named after the Italian word for "table"</p>
            </div>

            <section class="about-story">
                <h2>The story behind Tavola</h2>

                <p>I created Tavola because I was exhausted.</p>

                <p>Living with Crohn's disease meant every meal was a calculation. Would this trigger a flare? Could I eat this safely? What would give me energy without making me feel worse?</p>

                <p>Then I decided to lose weight, another layer of complexity. Suddenly I was tracking macros, planning workouts and trying to cook anti-inflammatory Mediterranean meals that wouldn't bore me to tears.</p>

                <p>And I <em>love</em> cooking. I genuinely enjoy it. But even I was drowning in the mental load.</p>

                <p>Meal planning consumed hours every week. Shopping took forever because I'd forget what I already had. I'd cook something delicious on Sunday and completely forget about the leftovers by Tuesday. I'd find myself eating the same rotation of "safe" meals because thinking through new options was overwhelming.</p>

                <p>Then my mom started asking me for help. She has her own health needs and saw what Mediterranean eating was doing for me. Suddenly I was meal planning for two households, each with different needs, different schedules and different budgets.</p>

                <p class="pullquote">That's when I realized: if I'm struggling with this (someone who enjoys cooking and has the time to research recipes), what about everyone else?</p>

                <p>What about the working parents who barely have time to think about dinner, let alone plan a week ahead? What about people managing chronic conditions who need nutrition to be part of their treatment plan? What about families who want to cook together and share recipes but don't have a good system for it?</p>

                <p>So I built Tavola.</p>

                <p>Named after the Italian word for "table," Tavola is where food brings us together.</p>

                <p>It started as a tool to manage my own Crohn's and weight loss. Then it became something my mom and sister used. Then I kept adding features: pantry tracking so I'd stop buying duplicate ingredients, Family Tavola so we could share recipes, smart shopping lists that account for what I already have.</p>

                <p>And then I added Nonna.</p>

                <p>I've always loved AI and what it makes possible. The idea that I could have a patient, knowledgeable cooking companion who understood Mediterranean cuisine, knew about anti-inflammatory eating and could help me plan meals around my actual pantry ingredients? That changed everything.</p>

                <p>Nonna knows I have Crohn's. She knows I'm working on losing weight. She knows I love trying new cuisines but need things to be practical for weeknight cooking. She knows what's in my fridge right now and what's on sale at Aldi this week.</p>

                <p class="pullquote">She's like having a real Italian grandmother in your pocket: patient, full of wisdom and always ready to help you cook something delicious without the stress.</p>

                <h3>Tavola is for four kinds of people:</h3>

                <div class="about-four-pillars">
                    <div class="pillar-card">
                        <div class="pillar-icon"><i data-lucide="heart"></i></div>
                        <h4>Food Lovers</h4>
                        <p>Whether you're batch-cooking Mediterranean feasts or experimenting with new cuisines, Tavola helps you plan, organize and cook with confidence. Your personal AI sous chef, Nonna, is always ready to help.</p>
                    </div>
                    <div class="pillar-card">
                        <h4><i data-lucide="users"></i> Families & Community</h4>
                        <p>Share recipes with loved ones through Family Tavola. Learn from your mom's favorites, swap cooking tips with your sister and build a shared family cookbook that spans generations.</p>
                    </div>
                    <div class="pillar-card">
                        <h4><i data-lucide="shield-plus"></i> Chronic Illness Warriors</h4>
                        <p>Managing Crohn's, UC, IBS or other digestive conditions? Tavola filters recipes by health tags, tracks trigger foods and provides gentle meal options during flares. Nutrition as medicine.</p>
                    </div>
                    <div class="pillar-card">
                        <h4><i data-lucide="target"></i> Health-Conscious Eaters</h4>
                        <p>Weight loss, heart health, diabetes management: whatever your goals, Tavola helps you eat well without sacrificing flavor. Mediterranean patterns that naturally support wellness.</p>
                    </div>
                </div>

                <p>If you're trying to eat better, cook more or reduce the mental load of figuring out "what's for dinner," Tavola is built for you.</p>

                <p>We're not a meal kit service. We're not selling you food. We're not trying to make cooking complicated.</p>

                <p>We're making meal planning feel less like a chore and more like the creative, connecting, nourishing act it's supposed to be.</p>

                <p class="pullquote">Food isn't fuel alone. It's how we take care of ourselves. It's how we show love to our families. It's how we explore cultures and traditions.</p>

                <p>And it should never feel impossible to do well.</p>

                <p>Welcome to Tavola. Let's cook something great together.</p>

                <p class="founder-signature">Matt Beezley, Founder</p>
            </section>
        </div>
    </div>

    <!-- FAQ Page -->
    <div class="faq-page" id="view-faq" style="display:none;">
        <header class="faq-header">
            <div class="container">
                <button class="btn btn-secondary" onclick="navigateBackFromAbout()"><i data-lucide="arrow-left"></i> Back</button>
            </div>
        </header>
        <div class="faq-content">
            <div class="faq-hero">
                <h1>Frequently asked questions</h1>
                <p class="faq-subtitle">Everything you need to know about Tavola</p>
            </div>

            <div class="faq-accordion">
                <div class="faq-item">
                    <div class="faq-question" onclick="toggleFAQ(this)">
                        <span>What is Tavola?</span>
                        <i data-lucide="chevron-down" class="faq-arrow"></i>
                    </div>
                    <div class="faq-answer">
                        <p>Tavola is an AI-powered meal planning platform built for Mediterranean cooking, chronic health management and family recipe sharing. Think of it as having a knowledgeable Italian grandmother (Nonna) who helps you plan meals, manage your pantry and cook with confidence.</p>
                    </div>
                </div>

                <div class="faq-item">
                    <div class="faq-question" onclick="toggleFAQ(this)">
                        <span>Who is Nonna?</span>
                        <i data-lucide="chevron-down" class="faq-arrow"></i>
                    </div>
                    <div class="faq-answer">
                        <p>Nonna is your AI cooking companion, powered by Claude. She understands Mediterranean cuisine, helps you plan meals based on your pantry, answers cooking questions and creates personalized meal plans around your health goals, budget and preferences. She's patient, knowledgeable and always available, just like a real grandmother.</p>
                    </div>
                </div>

                <div class="faq-item">
                    <div class="faq-question" onclick="toggleFAQ(this)">
                        <span>Do I need to know how to cook?</span>
                        <i data-lucide="chevron-down" class="faq-arrow"></i>
                    </div>
                    <div class="faq-answer">
                        <p>Not at all! Nonna walks you through recipes step-by-step and can adapt them to your skill level. Whether you're a confident home cook or just starting out, Tavola meets you where you are.</p>
                    </div>
                </div>

                <div class="faq-item">
                    <div class="faq-question" onclick="toggleFAQ(this)">
                        <span>What makes Tavola different from other meal planning apps?</span>
                        <i data-lucide="chevron-down" class="faq-arrow"></i>
                    </div>
                    <div class="faq-answer">
                        <p>Three things: (1) Nonna is context-aware: she knows what's in your pantry, your health needs and your cooking style. (2) Family Tavola lets you share recipes with loved ones and build a shared family cookbook. (3) We're built specifically for Mediterranean eating patterns, which are naturally anti-inflammatory and gut-friendly.</p>
                    </div>
                </div>

                <div class="faq-item">
                    <div class="faq-question" onclick="toggleFAQ(this)">
                        <span>Can Tavola help with dietary restrictions or health conditions?</span>
                        <i data-lucide="chevron-down" class="faq-arrow"></i>
                    </div>
                    <div class="faq-answer">
                        <p>Yes! Tavola was originally created to help manage Crohn's disease through Mediterranean eating. Nonna can filter recipes by health tags (anti-inflammatory, heart-healthy, low-sodium, etc.) and adapt any recipe to be Crohn's-friendly, gluten-free, dairy-free or match other dietary needs.</p>
                    </div>
                </div>

                <div class="faq-item">
                    <div class="faq-question" onclick="toggleFAQ(this)">
                        <span>How does the smart pantry work?</span>
                        <i data-lucide="chevron-down" class="faq-arrow"></i>
                    </div>
                    <div class="faq-answer">
                        <p>Add ingredients to your digital pantry once and Tavola tracks what you have. When you mark a meal as cooked, Tavola automatically deducts ingredients from your pantry. You'll get low-stock alerts and shopping lists that only include what you need to buy. No more duplicate purchases or forgotten ingredients.</p>
                    </div>
                </div>

                <div class="faq-item">
                    <div class="faq-question" onclick="toggleFAQ(this)">
                        <span>What is Family Tavola?</span>
                        <i data-lucide="chevron-down" class="faq-arrow"></i>
                    </div>
                    <div class="faq-answer">
                        <p>Family Tavola is a shared recipe library where you and your loved ones can share favorite recipes, rate dishes, leave cooking notes and build collections together. It's like a digital family cookbook that grows with you.</p>
                    </div>
                </div>

                <div class="faq-item">
                    <div class="faq-question" onclick="toggleFAQ(this)">
                        <span>How much does Tavola cost?</span>
                        <i data-lucide="chevron-down" class="faq-arrow"></i>
                    </div>
                    <div class="faq-answer">
                        <p>We offer a free tier that includes limited Nonna chats and basic meal planning. Premium plans start at $12/month (or $100/year) for unlimited access to Nonna, Family Tavola, smart pantry and all features. Family plans for up to 5 users are $20/month.</p>
                    </div>
                </div>

                <div class="faq-item">
                    <div class="faq-question" onclick="toggleFAQ(this)">
                        <span>Can I import recipes from other websites?</span>
                        <i data-lucide="chevron-down" class="faq-arrow"></i>
                    </div>
                    <div class="faq-answer">
                        <p>Yes! Paste a URL from recipe sites like NYT Cooking, Bon AppÃ©tit or AllRecipes and Tavola extracts the ingredients, instructions and nutrition info. You can edit before saving to your collection.</p>
                    </div>
                </div>

                <div class="faq-item">
                    <div class="faq-question" onclick="toggleFAQ(this)">
                        <span>Will Tavola work for me if I'm not doing Mediterranean cooking?</span>
                        <i data-lucide="chevron-down" class="faq-arrow"></i>
                    </div>
                    <div class="faq-answer">
                        <p>Absolutely! While Tavola specializes in Mediterranean cuisine (Greek, Italian, Spanish, Levantine, North African), Nonna can help with any cooking style. The smart pantry, family sharing and meal planning features work for all types of cooking.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Welcome Screen -->
    <main class="welcome-screen" id="welcome-screen">
        <h1 class="welcome-logo">Tavola</h1>
        <p class="welcome-subtitle">Mediterranean Meal Planning</p>
        <p class="welcome-tagline">Gentle, delicious meals designed for your health. Meet Nonna, your personal cooking companion.</p>
        <button class="btn btn-primary" onclick="showIntakeForm()">Get Started</button>
    </main>

    <!-- Intake Form -->
    <main class="view" id="intake-form">
        <div class="container section">
            <div class="text-center mb-16">
                <h1 class="section-title" style="border: none; text-align: center;">Let's Get to Know You</h1>
                <p class="text-muted">This helps Nonna suggest meals that work for your body</p>
            </div>
            <form id="profile-form" onsubmit="saveProfile(event)">
                <!-- Health Conditions - Expanded -->
                <div class="card">
                    <h2 class="card-title"><i data-lucide="stethoscope" style="width:18px;height:18px;vertical-align:middle"></i> Health Conditions</h2>
                    <p class="text-muted mb-16">Check all that apply. This helps Nonna tailor recipes to your needs.</p>

                    <!-- Digestive Conditions -->
                    <div class="form-group">
                        <label style="font-weight: 600; color: var(--cerulean);">Digestive Conditions</label>
                        <div class="grid grid-2">
                            <label class="checkbox-item"><input type="checkbox" name="conditions" value="crohns" onchange="toggleConditionDetails('crohns')"> Crohn's Disease</label>
                            <label class="checkbox-item"><input type="checkbox" name="conditions" value="uc" onchange="toggleConditionDetails('uc')"> Ulcerative Colitis</label>
                            <label class="checkbox-item"><input type="checkbox" name="conditions" value="ibs" onchange="toggleConditionDetails('ibs')"> IBS</label>
                            <label class="checkbox-item"><input type="checkbox" name="conditions" value="celiac"> Celiac / Gluten Sensitivity</label>
                            <label class="checkbox-item"><input type="checkbox" name="conditions" value="lactose"> Lactose Intolerance</label>
                            <label class="checkbox-item"><input type="checkbox" name="conditions" value="gerd"> GERD / Acid Reflux</label>
                        </div>
                    </div>

                    <!-- Crohn's Details (shown when checked) -->
                    <div class="condition-details hidden" id="crohns-details">
                        <div class="form-row">
                            <div class="form-group">
                                <label>Crohn's Severity</label>
                                <select class="form-select" name="crohnsSeverity">
                                    <option value="">Select...</option>
                                    <option value="mild">Mild</option>
                                    <option value="moderate">Moderate</option>
                                    <option value="severe">Severe</option>
                                    <option value="remission">In Remission</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Known Triggers</label>
                                <input type="text" class="form-input" name="crohnsTriggers" placeholder="e.g., raw veggies, nuts, dairy">
                            </div>
                        </div>
                    </div>

                    <!-- UC Details -->
                    <div class="condition-details hidden" id="uc-details">
                        <div class="form-group">
                            <label>UC Severity</label>
                            <select class="form-select" name="ucSeverity">
                                <option value="">Select...</option>
                                <option value="mild">Mild</option>
                                <option value="moderate">Moderate</option>
                                <option value="severe">Severe</option>
                                <option value="remission">In Remission</option>
                            </select>
                        </div>
                    </div>

                    <!-- IBS Details -->
                    <div class="condition-details hidden" id="ibs-details">
                        <div class="form-group">
                            <label>IBS Type</label>
                            <select class="form-select" name="ibsType">
                                <option value="">Select...</option>
                                <option value="ibs-d">IBS-D (Diarrhea)</option>
                                <option value="ibs-c">IBS-C (Constipation)</option>
                                <option value="ibs-m">IBS-M (Mixed)</option>
                            </select>
                        </div>
                    </div>

                    <!-- Cardiovascular & Metabolic -->
                    <div class="form-group mt-16">
                        <label style="font-weight: 600; color: var(--cerulean);">Cardiovascular & Metabolic</label>
                        <div class="grid grid-2">
                            <label class="checkbox-item"><input type="checkbox" name="conditions" value="highCholesterol" onchange="toggleConditionDetails('cholesterol')"> High Cholesterol</label>
                            <label class="checkbox-item"><input type="checkbox" name="conditions" value="highBP" onchange="toggleConditionDetails('bp')"> High Blood Pressure</label>
                            <label class="checkbox-item"><input type="checkbox" name="conditions" value="diabetes" onchange="toggleConditionDetails('diabetes')"> Type 2 Diabetes</label>
                            <label class="checkbox-item"><input type="checkbox" name="conditions" value="heartDisease"> Heart Disease</label>
                            <label class="checkbox-item"><input type="checkbox" name="conditions" value="kidney" onchange="toggleConditionDetails('kidney')"> Kidney Disease</label>
                        </div>
                    </div>

                    <!-- Cholesterol Details -->
                    <div class="condition-details hidden" id="cholesterol-details">
                        <div class="form-group">
                            <label>Cholesterol Goal</label>
                            <select class="form-select" name="cholesterolGoal">
                                <option value="">Select...</option>
                                <option value="lower-ldl">Lower LDL</option>
                                <option value="raise-hdl">Raise HDL</option>
                                <option value="both">Both</option>
                            </select>
                        </div>
                    </div>

                    <!-- BP Details -->
                    <div class="condition-details hidden" id="bp-details">
                        <div class="form-group">
                            <label>Sodium Restriction</label>
                            <select class="form-select" name="sodiumRestriction">
                                <option value="">Select...</option>
                                <option value="moderate">Moderate (2300mg/day)</option>
                                <option value="strict">Strict (1500mg/day)</option>
                            </select>
                        </div>
                    </div>

                    <!-- Diabetes Details -->
                    <div class="condition-details hidden" id="diabetes-details">
                        <div class="form-group">
                            <label>Carb Management</label>
                            <select class="form-select" name="carbManagement">
                                <option value="">Select...</option>
                                <option value="moderate">Moderate Carb</option>
                                <option value="low-carb">Low Carb</option>
                                <option value="keto">Very Low Carb / Keto</option>
                            </select>
                        </div>
                    </div>

                    <!-- Kidney Details -->
                    <div class="condition-details hidden" id="kidney-details">
                        <div class="form-group">
                            <label>Kidney Restrictions</label>
                            <div class="grid grid-2">
                                <label class="checkbox-item"><input type="checkbox" name="kidneyRestrictions" value="lowProtein"> Low Protein</label>
                                <label class="checkbox-item"><input type="checkbox" name="kidneyRestrictions" value="lowSodium"> Low Sodium</label>
                                <label class="checkbox-item"><input type="checkbox" name="kidneyRestrictions" value="lowPotassium"> Low Potassium</label>
                                <label class="checkbox-item"><input type="checkbox" name="kidneyRestrictions" value="lowPhosphorus"> Low Phosphorus</label>
                            </div>
                        </div>
                    </div>

                    <!-- Autoimmune & Inflammatory -->
                    <div class="form-group mt-16">
                        <label style="font-weight: 600; color: var(--cerulean);">Autoimmune & Inflammatory</label>
                        <div class="grid grid-2">
                            <label class="checkbox-item"><input type="checkbox" name="conditions" value="fibromyalgia" onchange="toggleConditionDetails('fibro')"> Fibromyalgia</label>
                            <label class="checkbox-item"><input type="checkbox" name="conditions" value="rheumatoid"> Rheumatoid Arthritis</label>
                            <label class="checkbox-item"><input type="checkbox" name="conditions" value="lupus"> Lupus</label>
                            <label class="checkbox-item"><input type="checkbox" name="conditions" value="hashimotos" onchange="toggleConditionDetails('thyroid')"> Hashimoto's / Thyroid</label>
                            <label class="checkbox-item"><input type="checkbox" name="conditions" value="psoriatic"> Psoriatic Arthritis</label>
                            <label class="checkbox-item"><input type="checkbox" name="conditions" value="ms"> Multiple Sclerosis</label>
                        </div>
                    </div>

                    <!-- Fibro Details -->
                    <div class="condition-details hidden" id="fibro-details">
                        <div class="form-group">
                            <label>Energy Level</label>
                            <select class="form-select" name="fibroEnergy">
                                <option value="">Select...</option>
                                <option value="low">Usually Low</option>
                                <option value="moderate">Moderate</option>
                                <option value="variable">Highly Variable</option>
                            </select>
                        </div>
                    </div>

                    <!-- Thyroid Details -->
                    <div class="condition-details hidden" id="thyroid-details">
                        <div class="form-group">
                            <label>Thyroid Condition</label>
                            <input type="text" class="form-input" name="thyroidType" placeholder="e.g., Hashimoto's, Hypothyroid">
                        </div>
                    </div>

                    <!-- Food Allergies -->
                    <div class="form-group mt-16">
                        <label style="font-weight: 600; color: var(--cerulean);">Food Allergies</label>
                        <input type="text" class="form-input" name="foodAllergies" placeholder="e.g., shellfish, tree nuts, soy">
                    </div>

                    <!-- Dietary Goals -->
                    <div class="form-group mt-16">
                        <label style="font-weight: 600; color: var(--cerulean);">Dietary Goals (select all that apply)</label>
                        <div class="grid grid-2">
                            <label class="checkbox-item"><input type="checkbox" name="dietaryGoals" value="weightLoss"> Weight Loss</label>
                            <label class="checkbox-item"><input type="checkbox" name="dietaryGoals" value="weightGain"> Weight Gain / Muscle</label>
                            <label class="checkbox-item"><input type="checkbox" name="dietaryGoals" value="antiInflammatory"> Anti-Inflammatory</label>
                            <label class="checkbox-item"><input type="checkbox" name="dietaryGoals" value="heartHealthy"> Heart-Healthy</label>
                            <label class="checkbox-item"><input type="checkbox" name="dietaryGoals" value="bloodSugar"> Blood Sugar Management</label>
                            <label class="checkbox-item"><input type="checkbox" name="dietaryGoals" value="gutHealth"> Gut Health</label>
                            <label class="checkbox-item"><input type="checkbox" name="dietaryGoals" value="energy"> More Energy</label>
                        </div>
                    </div>

                    <!-- Other Notes -->
                    <div class="form-group mt-16">
                        <label>Other Conditions or Notes</label>
                        <textarea class="form-textarea" name="otherConditions" placeholder="Anything else Nonna should know about your health..."></textarea>
                    </div>
                </div>

                <!-- Cooking for Two -->
                <div class="card">
                    <h2 class="card-title"><i data-lucide="users" style="width:18px;height:18px;vertical-align:middle"></i> Cooking for Two</h2>
                    <label class="toggle mb-16">
                        <input type="checkbox" name="cookingForTwo" id="cookingForTwoToggle" onchange="toggleCookingForTwo()">
                        <span class="toggle-switch"></span>
                        <span>I'm cooking for someone else too</span>
                    </label>
                    <div id="cookingForTwoFields" class="hidden">
                        <div class="form-group">
                            <label>Their Name or Relationship</label>
                            <input type="text" class="form-input" name="partnerName" placeholder="e.g., John, Partner, Mom">
                        </div>
                        <div class="form-group">
                            <label>Their Dietary Restrictions</label>
                            <div class="grid grid-2">
                                <label class="checkbox-item"><input type="checkbox" name="partnerRestrictions" value="diabetes"> Diabetes</label>
                                <label class="checkbox-item"><input type="checkbox" name="partnerRestrictions" value="heart"> Heart Disease</label>
                                <label class="checkbox-item"><input type="checkbox" name="partnerRestrictions" value="glutenFree"> Gluten-Free</label>
                                <label class="checkbox-item"><input type="checkbox" name="partnerRestrictions" value="lactose"> Lactose Intolerant</label>
                                <label class="checkbox-item"><input type="checkbox" name="partnerRestrictions" value="vegetarian"> Vegetarian</label>
                                <label class="checkbox-item"><input type="checkbox" name="partnerRestrictions" value="none"> No Restrictions</label>
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Their Allergies</label>
                            <input type="text" class="form-input" name="partnerAllergies" placeholder="e.g., shellfish, tree nuts">
                        </div>
                        <div class="form-group">
                            <label>Foods They Love</label>
                            <input type="text" class="form-input" name="partnerLoves" placeholder="e.g., spicy food, cheese, garlic">
                        </div>
                    </div>
                </div>

                <!-- Protein Preferences -->
                <div class="card">
                    <h2 class="card-title"><i data-lucide="beef" style="width:18px;height:18px;vertical-align:middle"></i> Protein Preferences</h2>
                    <p class="text-muted mb-16">Check all proteins you eat</p>
                    <div class="grid grid-2">
                        <label class="checkbox-item"><input type="checkbox" name="proteins" value="white-fish"> White Fish</label>
                        <label class="checkbox-item"><input type="checkbox" name="proteins" value="fatty-fish"> Fatty Fish (salmon)</label>
                        <label class="checkbox-item"><input type="checkbox" name="proteins" value="shellfish"> Shellfish</label>
                        <label class="checkbox-item"><input type="checkbox" name="proteins" value="chicken"> Chicken</label>
                        <label class="checkbox-item"><input type="checkbox" name="proteins" value="turkey"> Turkey</label>
                        <label class="checkbox-item"><input type="checkbox" name="proteins" value="pork"> Pork</label>
                        <label class="checkbox-item"><input type="checkbox" name="proteins" value="beef"> Beef</label>
                        <label class="checkbox-item"><input type="checkbox" name="proteins" value="lamb"> Lamb</label>
                        <label class="checkbox-item"><input type="checkbox" name="proteins" value="eggs"> Eggs</label>
                        <label class="checkbox-item"><input type="checkbox" name="proteins" value="legumes"> Legumes</label>
                        <label class="checkbox-item"><input type="checkbox" name="proteins" value="tofu"> Tofu/Tempeh</label>
                        <label class="checkbox-item"><input type="checkbox" name="proteins" value="dairy"> Greek Yogurt/Cheese</label>
                    </div>
                </div>

                <!-- Garden -->
                <div class="card">
                    <h2 class="card-title"><i data-lucide="sprout" style="width:18px;height:18px;vertical-align:middle"></i> Your Garden</h2>
                    <div class="form-group">
                        <label>What's Currently Growing?</label>
                        <textarea class="form-textarea" name="currentlyGrowing" placeholder="e.g., tomatoes, zucchini, basil, peppers..."></textarea>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Growing Zone</label>
                            <input type="text" class="form-input" name="growingZone" placeholder="e.g., 7b">
                        </div>
                        <div class="form-group">
                            <label>Current Season</label>
                            <select class="form-select" name="currentSeason">
                                <option value="spring">Spring</option>
                                <option value="summer">Summer</option>
                                <option value="fall">Fall</option>
                                <option value="winter">Winter</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Cooking Capacity -->
                <div class="card">
                    <h2 class="card-title"><i data-lucide="clock" style="width:18px;height:18px;vertical-align:middle"></i> Cooking Capacity</h2>
                    <div class="form-group">
                        <label>Energy Level for Cooking</label>
                        <select class="form-select" name="energyLevel">
                            <option value="low">Low (simple meals)</option>
                            <option value="moderate">Moderate</option>
                            <option value="good">Good</option>
                            <option value="variable" selected>Variable (changes daily)</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Preferred Cooking Time</label>
                        <select class="form-select" name="cookingTime">
                            <option value="quick">Quick (15-30 min)</option>
                            <option value="standard" selected>Standard (30-60 min)</option>
                            <option value="batch">Batch Cooking</option>
                        </select>
                    </div>
                </div>

                <!-- Budget -->
                <div class="card">
                    <h2 class="card-title"><i data-lucide="wallet" style="width:18px;height:18px;vertical-align:middle"></i> Budget</h2>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Weekly Grocery Budget</label>
                            <select class="form-select" name="weeklyBudget">
                                <option value="50-75">$50-75</option>
                                <option value="75-100">$75-100</option>
                                <option value="100-150" selected>$100-150</option>
                                <option value="150-200">$150-200</option>
                                <option value="200+">$200+</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Priority</label>
                            <select class="form-select" name="shoppingPriority">
                                <option value="quality">Quality ingredients</option>
                                <option value="budget">Budget-friendly</option>
                                <option value="balance" selected>Balance both</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Dietary Notes -->
                <div class="card">
                    <h2 class="card-title"><i data-lucide="file-text" style="width:18px;height:18px;vertical-align:middle"></i> Dietary Notes</h2>
                    <div class="form-group">
                        <label>Foods to Avoid</label>
                        <textarea class="form-textarea" name="foodsToAvoid" placeholder="Specific triggers or dislikes..."></textarea>
                    </div>
                    <div class="form-group">
                        <label>Favorite Flavors</label>
                        <textarea class="form-textarea" name="favoriteFlavors" placeholder="e.g., lemon, garlic, fresh herbs..."></textarea>
                    </div>
                </div>

                <button type="submit" class="btn btn-primary btn-block">Save & Meet Nonna</button>
            </form>
        </div>
    </main>

    <!-- Main App Container -->
    <main class="view" id="app-main">
        <div class="container">
            <!-- HOME/DASHBOARD View (NEW) -->
            <div class="view active" id="view-home">
                <!-- Page Header -->
                <div class="page-header">
                    <h1 class="page-headline">Welcome back! Let's make something delicious</h1>
                    <p class="page-subhead" id="home-subhead">Your kitchen awaits</p>
                </div>

                <!-- Flare Mode Banner (shown when active) -->
                <div class="flare-banner hidden" id="home-flare-banner">
                    <div class="flare-banner-title"><i data-lucide="thermometer" style="width:18px;height:18px;vertical-align:middle;margin-right:4px"></i> Flare Mode Active</div>
                    <div class="flare-banner-text">Nonna will suggest gentle, easy-to-digest meals.</div>
                </div>

                <!-- Stats Bar -->
                <div class="stats-bar" id="dashboard-stats">
                    <div class="stat-item"><i data-lucide="utensils" style="width:16px;height:16px"></i> <span>Meals: <strong id="stat-meals-planned">0/7</strong></span></div>
                    <div class="stat-item"><i data-lucide="heart" style="width:16px;height:16px"></i> <span>Favorites: <strong id="stat-favorites">0</strong></span></div>
                    <div class="stat-item"><i data-lucide="sprout" style="width:16px;height:16px"></i> <span>Garden: <strong id="stat-garden">-</strong></span></div>
                    <div class="stat-item"><i data-lucide="book-open" style="width:16px;height:16px"></i> <span>Recipes: <strong id="stat-recipes">0</strong></span></div>
                </div>

                <!-- Quick Action Tiles -->
                <div class="action-tiles">
                    <div class="action-tile tile-cerulean" onclick="navigateTo('week'); askNonnaForWeekPlan();">
                        <div class="action-tile-icon"><i data-lucide="calendar-days"></i></div>
                        <div class="action-tile-title">Plan This Week</div>
                        <div class="action-tile-desc">Get your weekly meal plan</div>
                    </div>
                    <div class="action-tile tile-seafoam" onclick="navigateTo('favorites')">
                        <div class="action-tile-icon"><i data-lucide="heart"></i></div>
                        <div class="action-tile-title">View Favorites</div>
                        <div class="action-tile-desc">Browse saved recipes</div>
                    </div>
                    <div class="action-tile tile-navy" onclick="navigateTo('nonna')">
                        <div class="action-tile-icon"><i data-lucide="message-circle"></i></div>
                        <div class="action-tile-title">Chat with Nonna</div>
                        <div class="action-tile-desc">Ask about meals & recipes</div>
                    </div>
                    <div class="action-tile tile-amber" onclick="navigateTo('more'); switchMoreTab('garden');">
                        <div class="action-tile-icon"><i data-lucide="sprout"></i></div>
                        <div class="action-tile-title">Check Garden</div>
                        <div class="action-tile-desc">What's ready to harvest</div>
                    </div>
                    <div class="action-tile tile-navy" onclick="openLeftoverTransformer();">
                        <div class="action-tile-icon"><i data-lucide="wand-sparkles"></i></div>
                        <div class="action-tile-title">Leftover Magic</div>
                        <div class="action-tile-desc">Transform what's on hand</div>
                    </div>
                    <div class="action-tile tile-amber" onclick="openImportRecipeModal();">
                        <div class="action-tile-icon"><i data-lucide="download"></i></div>
                        <div class="action-tile-title">Import Recipe</div>
                        <div class="action-tile-desc">Save from any URL</div>
                    </div>
                </div>

                <!-- Seasonal Produce Card -->
                <div class="card" id="seasonal-card" style="display:none">
                    <div class="card-header">
                        <h3 class="card-title"><i data-lucide="sun" style="width:18px;height:18px;vertical-align:middle;color:var(--accent-warm)"></i> In Season Now</h3>
                        <span class="text-muted" id="seasonal-month"></span>
                    </div>
                    <div id="seasonal-items" style="display:flex;flex-wrap:wrap;gap:8px;margin-bottom:12px"></div>
                    <button class="btn btn-sm btn-secondary" onclick="askNonnaWithSeasonal()"><i data-lucide="chef-hat" style="width:14px;height:14px;vertical-align:middle"></i> Cook with seasonal picks</button>
                </div>

                <!-- Today's Activity Summary -->
                <div class="card" id="dashboard-workout-card">
                    <div class="card-header">
                        <h3 class="card-title"><i data-lucide="activity" style="width:20px;height:20px;vertical-align:middle;margin-right:6px"></i> Today's Activity</h3>
                        <button class="btn btn-ghost btn-sm" onclick="navigateTo('workouts')">View All</button>
                    </div>
                    <div class="workout-stats" style="margin-bottom: 0;">
                        <div class="workout-stat">
                            <div class="workout-stat-value" id="dashboard-calories-in">0</div>
                            <div class="workout-stat-label">Calories In</div>
                        </div>
                        <div class="workout-stat">
                            <div class="workout-stat-value" id="dashboard-calories-out">0</div>
                            <div class="workout-stat-label">Calories Out</div>
                        </div>
                        <div class="workout-stat balance">
                            <div class="workout-stat-value" id="dashboard-calorie-net">0</div>
                            <div class="workout-stat-label">Net Balance</div>
                        </div>
                        <div class="workout-stat">
                            <div class="workout-stat-value" id="dashboard-workouts-today">0</div>
                            <div class="workout-stat-label">Workouts Today</div>
                        </div>
                    </div>
                </div>

                <!-- Recent Activity -->
                <div class="card">
                    <h3 class="card-title"><i data-lucide="clock" style="width:20px;height:20px;vertical-align:middle;margin-right:6px"></i> Recent Activity</h3>
                    <div class="activity-list" id="recent-activity">
                        <div class="empty-state" style="padding: 24px;">
                            <p class="text-muted">No recent activity yet. Start by chatting with Nonna!</p>
                        </div>
                    </div>
                </div>

                <!-- Nonna's Tip of the Day -->
                <div class="nonna-tip" id="nonna-tip-daily">
                    <div class="nonna-tip-header"><i data-lucide="lightbulb" style="width:18px;height:18px;vertical-align:middle;margin-right:6px"></i> Nonna's Tip</div>
                    <div class="nonna-tip-text" id="nonna-tip-text">"Always finish with good olive oil - it makes everything taste better, cara."</div>
                    <div class="nonna-tip-signature">Nonna</div>
                </div>

                <!-- Empty State for New Users -->
                <div class="card hidden" id="new-user-welcome">
                    <div class="text-center" style="padding: 24px;">
                        <div style="margin-bottom: 16px;"><i data-lucide="hand-metal" style="width:48px;height:48px;color:var(--cerulean)"></i></div>
                        <h3 style="color: var(--cerulean); margin-bottom: 8px;">Welcome to Tavola!</h3>
                        <p class="text-muted mb-16">Nonna helps you plan Mediterranean meals tailored to your health needs.</p>
                        <button class="btn btn-primary" onclick="navigateTo('nonna')"><i data-lucide="message-circle" style="width:16px;height:16px;vertical-align:middle;margin-right:4px"></i> Start Chatting with Nonna</button>
                    </div>
                </div>
            </div>

            <!-- THIS WEEK View -->
            <div class="view" id="view-week">
                <!-- Page Header -->
                <div class="page-header">
                    <h1 class="page-headline">This week's menu</h1>
                    <p class="page-subhead">Balance your nutrition, manage your time and enjoy what you cook</p>
                </div>

                <div class="week-header">
                    <div class="week-nav">
                        <button class="week-nav-btn" onclick="changeWeek(-1)"><i data-lucide="chevron-left" style="width:16px;height:16px"></i></button>
                        <span class="week-title" id="week-title">This Week</span>
                        <button class="week-nav-btn" onclick="changeWeek(1)"><i data-lucide="chevron-right" style="width:16px;height:16px"></i></button>
                    </div>
                    <div class="week-actions">
                        <button class="btn btn-primary btn-sm" onclick="askNonnaForWeekPlan()"><i data-lucide="bot" style="width:14px;height:14px;vertical-align:middle"></i> Plan Week</button>
                        <button class="btn btn-secondary btn-sm" onclick="generateWeekShoppingList()"><i data-lucide="shopping-cart" style="width:14px;height:14px;vertical-align:middle"></i> Shopping</button>
                        <button class="btn btn-secondary btn-sm" onclick="showPrepChecklist()"><i data-lucide="clipboard-list" style="width:14px;height:14px;vertical-align:middle"></i> Prep</button>
                    </div>
                </div>
                <div id="week-planner"></div>
                <div class="empty-state hidden" id="week-empty">
                    <div class="empty-state-icon"><i data-lucide="calendar-days" style="width:32px;height:32px;color:var(--gray-text)"></i></div>
                    <div class="empty-state-title">Your week is empty</div>
                    <p class="empty-state-text">Let's fill it with delicious, healthy meals! Nonna can create a complete weekly plan based on your preferences and pantry.</p>
                    <button class="btn btn-primary" onclick="openPlanningModeModal()"><i data-lucide="bot" style="width:14px;height:14px;vertical-align:middle"></i> Plan This Week</button>
                </div>
            </div>

            <!-- RECIPES LIBRARY View (NEW) -->
            <div class="view" id="view-recipes">
                <!-- Page Header (changes based on tab) -->
                <div class="page-header" id="recipes-header-my">
                    <h1 class="page-headline">Your personal cookbook</h1>
                    <p class="page-subhead">Save favorites, try new dishes and build your Mediterranean repertoire</p>
                </div>
                <div class="page-header" id="recipes-header-family" style="display:none;">
                    <h1 class="page-headline">Recipes from the people you love</h1>
                    <p class="page-subhead">Your family's greatest hits, shared traditions and new discoveries all in one place</p>
                </div>

                <!-- Tab Bar: My Recipes / Family Tavola -->
                <div class="recipes-tab-bar">
                    <button class="recipes-tab active" id="tab-my-recipes" onclick="switchRecipesTab('my')"><i data-lucide="book-open" style="width:16px;height:16px;vertical-align:middle"></i> My Recipes</button>
                    <button class="recipes-tab" id="tab-family-recipes" onclick="switchRecipesTab('family')"><i data-lucide="users" style="width:16px;height:16px;vertical-align:middle"></i> Family Tavola</button>
                </div>

                <!-- MY RECIPES TAB -->
                <div id="recipes-tab-my">
                    <div class="flex flex-between flex-center mb-16">
                        <div class="flex gap-8">
                            <button class="btn btn-sm btn-primary" onclick="openSaveManualRecipeModal()">+ Create Recipe</button>
                            <button class="btn btn-sm btn-secondary" onclick="openImportRecipeModal()"><i data-lucide="download" style="width:14px;height:14px;vertical-align:middle"></i> Import</button>
                            <button class="btn btn-sm btn-ghost" id="recipes-edit-btn" onclick="toggleRecipeEditMode()">Edit</button>
                        </div>
                    </div>
                    <!-- Bulk Actions Bar (hidden by default) -->
                    <div class="bulk-actions-bar hidden" id="recipes-bulk-bar">
                        <span class="bulk-count"><span id="bulk-selected-count">0</span> selected</span>
                        <div class="bulk-buttons">
                            <button class="btn btn-sm btn-ghost" onclick="bulkSelectAll()">Select All</button>
                            <button class="btn btn-sm btn-ghost" onclick="bulkDeselectAll()">Deselect</button>
                            <button class="btn btn-sm btn-secondary" onclick="bulkAddToFavorites()"><i data-lucide="heart" style="width:14px;height:14px;vertical-align:middle"></i> Favorite</button>
                            <button class="btn btn-sm btn-secondary" onclick="bulkRemoveFromFavorites()"><i data-lucide="heart-crack" style="width:14px;height:14px;vertical-align:middle"></i> Unfavorite</button>
                            <button class="btn btn-sm" style="background: var(--danger); color: white;" onclick="bulkDeleteRecipes()"><i data-lucide="trash-2" style="width:14px;height:14px;vertical-align:middle"></i> Delete</button>
                        </div>
                    </div>
                    <div class="flex flex-between flex-center mb-16 gap-8" style="flex-wrap: wrap;">
                        <input type="text" class="form-input" id="recipes-search" placeholder="Search recipes..." style="max-width: 250px; flex: 1;" oninput="filterRecipeLibrary()">
                        <div class="filter-dropdown" id="recipe-filters">
                            <button class="btn btn-secondary btn-sm" onclick="toggleFilterDropdown()">Filters â–¾</button>
                            <div class="filter-dropdown-content">
                                <div class="form-group">
                                    <label>Sort by</label>
                                    <select class="form-select" id="recipes-sort" onchange="filterRecipeLibrary()">
                                        <option value="recent">Recent</option>
                                        <option value="rating">Highest Rated</option>
                                        <option value="cooked">Most Cooked</option>
                                        <option value="time">Cook Time</option>
                                        <option value="name">Name A-Z</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>Protein</label>
                                    <select class="form-select" id="recipes-protein" onchange="filterRecipeLibrary()">
                                        <option value="">All</option>
                                        <option value="fish">Fish</option>
                                        <option value="chicken">Chicken</option>
                                        <option value="pork">Pork</option>
                                        <option value="beef">Beef</option>
                                        <option value="vegetarian">Vegetarian</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>Time</label>
                                    <select class="form-select" id="recipes-time" onchange="filterRecipeLibrary()">
                                        <option value="">All</option>
                                        <option value="quick">Quick (&lt;30min)</option>
                                        <option value="standard">Standard (30-60min)</option>
                                        <option value="long">Long (60+min)</option>
                                    </select>
                                </div>
                                <div class="tag-filter-section">
                                    <span class="tag-filter-label">Filter by Tags</span>
                                    <div class="tag-filter-chips" id="tag-filter-chips"></div>
                                    <span class="tag-filter-clear" id="tag-filter-clear" onclick="clearTagFilters()">Clear tag filters</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="grid grid-2" id="recipes-grid"></div>
                    <div class="empty-state" id="recipes-empty">
                        <div class="empty-state-icon"><i data-lucide="book-open" style="width:32px;height:32px;color:var(--gray-text)"></i></div>
                        <div class="empty-state-title">Your recipe library is empty</div>
                        <p class="empty-state-text">Chat with Nonna to get personalized Mediterranean recipes tailored to your health needs!</p>
                        <button class="btn btn-primary" onclick="navigateTo('nonna')"><i data-lucide="message-circle" style="width:16px;height:16px;vertical-align:middle"></i> Ask Nonna for Recipe Ideas</button>
                    </div>
                </div>

                <!-- FAMILY TAVOLA TAB -->
                <div id="recipes-tab-family" style="display:none">
                    <div class="family-tavola-header">
                        <p style="margin:0;color:var(--gray-text);font-size:0.95rem">Recipes shared by your family. Rate them, add your own twist, and discover new favorites!</p>
                    </div>

                    <div class="family-filters">
                        <input type="text" class="form-input" id="family-search" placeholder="Search family recipes..." style="max-width: 250px; flex: 1;" oninput="filterFamilyRecipes()">
                        <select class="form-select" id="family-sort" onchange="filterFamilyRecipes()" style="max-width: 180px;">
                            <option value="recent">Recently Shared</option>
                            <option value="rating">Highest Rated</option>
                            <option value="popular">Most Cooked</option>
                            <option value="name">Name A-Z</option>
                        </select>
                    </div>

                    <!-- Tag filter chips -->
                    <div style="margin-bottom:16px">
                        <div class="tag-filter-chips" id="family-tag-filter-chips" style="display:flex;flex-wrap:wrap;gap:6px"></div>
                        <span class="tag-filter-clear" id="family-tag-filter-clear" onclick="clearFamilyTagFilters()" style="display:none;cursor:pointer;color:var(--olive-green);font-size:0.85rem;margin-top:8px">Clear filters</span>
                    </div>

                    <div class="grid grid-2" id="family-recipes-grid"></div>

                    <div class="empty-state" id="family-recipes-empty" style="display:none">
                        <div class="empty-state-icon"><i data-lucide="users" style="width:32px;height:32px;color:var(--gray-text)"></i></div>
                        <div class="empty-state-title">No family recipes yet</div>
                        <p class="empty-state-text">Share your favorite recipes with your family! Open a recipe and tap the Share button to add it to Family Tavola.</p>
                        <button class="btn btn-primary" onclick="switchRecipesTab('my')"><i data-lucide="book-open" style="width:14px;height:14px;vertical-align:middle"></i> Go to My Recipes</button>
                    </div>
                </div>
            </div>

            <!-- NONNA View -->
            <div class="view" id="view-nonna">
                <div class="nonna-page-container">
                    <!-- Left Sidebar: Conversation List -->
                    <div class="nonna-sidebar">
                        <div class="sidebar-header">
                            <h3>Conversations</h3>
                            <button class="btn btn-sm btn-primary" onclick="startNewConversation()">
                                <i data-lucide="plus"></i> New
                            </button>
                        </div>

                        <!-- Context Summary -->
                        <div class="conversation-context" id="conversation-context">
                            <!-- Context will be rendered here -->
                        </div>

                        <!-- Quick Actions -->
                        <div class="conversation-quick-actions" id="conversation-quick-actions">
                            <!-- Quick actions will be rendered here -->
                        </div>

                        <div class="conversation-list" id="nonna-conversation-list">
                            <!-- Conversations will be rendered here -->
                        </div>
                    </div>

                    <!-- Main Chat Area -->
                    <div class="nonna-main-chat">
                        <div class="chat-header-nonna">
                            <div>
                                <h2><i data-lucide="message-circle" style="width:24px;height:24px;vertical-align:middle"></i> Your AI sous chef is here</h2>
                                <p class="text-muted">Ask anything about cooking, meal planning, nutrition or what to make with what you have</p>
                            </div>
                        </div>
                        <div class="chat-messages-nonna" id="chat-messages-nonna">
                            <!-- Messages will be rendered here -->
                        </div>
                        <div class="chat-input-container-nonna">
                            <button class="chat-voice-btn-nonna" id="nonna-voice-btn" onclick="toggleNonnaVoice()" title="Voice input">
                                <i data-lucide="mic"></i>
                            </button>
                            <textarea class="chat-input-nonna" id="chat-input-nonna" placeholder="Ask Nonna anything..." rows="2"></textarea>
                            <button class="chat-send-btn-nonna" onclick="sendNonnaMessage()">
                                <i data-lucide="send"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- WORKOUTS View -->
            <div class="view" id="view-workouts">
                <!-- Page Header -->
                <div class="page-header">
                    <h1 class="page-headline">Fuel your fitness</h1>
                    <p class="page-subhead">Plan meals around your workouts for better recovery, energy and results</p>
                </div>

                <!-- Calorie Balance -->
                <div class="calorie-balance" id="calorie-balance">
                    <div class="calorie-balance-header">
                        <span class="calorie-balance-title">Today's Calorie Balance</span>
                        <span class="calorie-balance-net balanced" id="calorie-net">0 cal</span>
                    </div>
                    <div class="calorie-bar-container">
                        <span class="calorie-bar-label">In</span>
                        <div class="calorie-bar">
                            <div class="calorie-bar-fill in" id="calories-in-bar" style="width: 0%"></div>
                        </div>
                        <span class="calorie-bar-value" id="calories-in-value">0</span>
                    </div>
                    <div class="calorie-bar-container">
                        <span class="calorie-bar-label">Out</span>
                        <div class="calorie-bar">
                            <div class="calorie-bar-fill out" id="calories-out-bar" style="width: 0%"></div>
                        </div>
                        <span class="calorie-bar-value" id="calories-out-value">0</span>
                    </div>
                </div>

                <!-- Week Stats -->
                <div class="workout-stats">
                    <div class="workout-stat">
                        <div class="workout-stat-value" id="workout-count-week">0</div>
                        <div class="workout-stat-label">Workouts This Week</div>
                    </div>
                    <div class="workout-stat">
                        <div class="workout-stat-value" id="workout-minutes-week">0</div>
                        <div class="workout-stat-label">Minutes Active</div>
                    </div>
                    <div class="workout-stat">
                        <div class="workout-stat-value" id="workout-calories-week">0</div>
                        <div class="workout-stat-label">Calories Burned</div>
                    </div>
                    <div class="workout-stat">
                        <div class="workout-stat-value" id="workout-streak">0</div>
                        <div class="workout-stat-label">Day Streak</div>
                    </div>
                </div>

                <!-- Quick Log -->
                <div class="card">
                    <div class="card-header">
                        <span class="card-title">Quick Log</span>
                    </div>
                    <div class="quick-log-presets" id="quick-log-presets">
                        <button class="quick-log-btn" onclick="quickLogWorkout('vrboxing', 45)"><i data-lucide="swords" style="width:14px;height:14px;vertical-align:middle"></i> VR Boxing</button>
                        <button class="quick-log-btn" onclick="quickLogWorkout('kettlebells', 30)"><i data-lucide="dumbbell" style="width:14px;height:14px;vertical-align:middle"></i> Kettlebells</button>
                        <button class="quick-log-btn" onclick="quickLogWorkout('resistancebands', 25)"><i data-lucide="stretch-horizontal" style="width:14px;height:14px;vertical-align:middle"></i> Resistance Bands</button>
                        <button class="quick-log-btn" onclick="quickLogWorkout('walking', 30)"><i data-lucide="footprints" style="width:14px;height:14px;vertical-align:middle"></i> 30min Walk</button>
                        <button class="quick-log-btn" onclick="quickLogWorkout('running', 20)"><i data-lucide="footprints" style="width:14px;height:14px;vertical-align:middle"></i> 20min Run</button>
                        <button class="quick-log-btn" onclick="quickLogWorkout('cycling', 30)"><i data-lucide="bike" style="width:14px;height:14px;vertical-align:middle"></i> 30min Bike</button>
                        <button class="quick-log-btn" onclick="quickLogWorkout('yoga', 30)"><i data-lucide="stretch-horizontal" style="width:14px;height:14px;vertical-align:middle"></i> 30min Yoga</button>
                        <button class="quick-log-btn" onclick="quickLogWorkout('swimming', 30)"><i data-lucide="waves" style="width:14px;height:14px;vertical-align:middle"></i> 30min Swim</button>
                    </div>
                    <button class="btn btn-primary btn-block" onclick="openWorkoutLogModal()">+ Log Custom Workout</button>
                </div>

                <!-- Weekly Calendar -->
                <div class="workout-calendar">
                    <div class="workout-calendar-header">
                        <span class="workout-calendar-title">This Week</span>
                    </div>
                    <div class="workout-calendar-grid" id="workout-calendar-grid"></div>
                </div>

                <!-- Today's Workouts -->
                <div class="workout-list">
                    <div class="workout-list-header">
                        <span class="workout-list-title">Today's Activity</span>
                    </div>
                    <div id="workout-list-today">
                        <div class="empty-state" style="padding: 20px;">
                            <div class="empty-state-icon"><i data-lucide="footprints" style="width:32px;height:32px;color:var(--gray-text)"></i></div>
                            <div class="empty-state-title">No workouts logged today</div>
                            <p class="empty-state-text">Log a workout to track your calorie burn!</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- MORE View -->
            <div class="view" id="view-more">
                <!-- Page Header -->
                <div class="page-header">
                    <h1 class="page-headline">Everything you need to cook well</h1>
                    <p class="page-subhead">Import recipes, transform leftovers, explore seasonal produce and discover new flavors</p>
                </div>

                <!-- More Menu Items -->
                <div class="more-menu" id="more-menu-main">
                    <button class="more-menu-item" onclick="switchMoreTab('kitchen')">
                        <span class="icon"><i data-lucide="cooking-pot"></i></span>
                        <div class="more-menu-item-content">
                            <div class="more-menu-item-title">Kitchen Tools</div>
                            <div class="more-menu-item-desc">Pantry, shopping lists, batch cooking</div>
                        </div>
                    </button>
                    <button class="more-menu-item" onclick="switchMoreTab('garden')">
                        <span class="icon"><i data-lucide="sprout"></i></span>
                        <div class="more-menu-item-content">
                            <div class="more-menu-item-title">Garden</div>
                            <div class="more-menu-item-desc">Track what's growing</div>
                        </div>
                    </button>
                    <button class="more-menu-item" onclick="switchMoreTab('crohns')">
                        <span class="icon"><i data-lucide="stethoscope"></i></span>
                        <div class="more-menu-item-content">
                            <div class="more-menu-item-title">Crohn's Care</div>
                            <div class="more-menu-item-desc">Flare mode & gentle meal options</div>
                        </div>
                    </button>
                    <button class="more-menu-item" onclick="switchMoreTab('history')">
                        <span class="icon"><i data-lucide="book-open"></i></span>
                        <div class="more-menu-item-content">
                            <div class="more-menu-item-title">Meal History</div>
                            <div class="more-menu-item-desc">Track what you've cooked</div>
                        </div>
                    </button>
                    <button class="more-menu-item" onclick="switchMoreTab('settings')">
                        <span class="icon"><i data-lucide="settings"></i></span>
                        <div class="more-menu-item-content">
                            <div class="more-menu-item-title">Settings</div>
                            <div class="more-menu-item-desc">Profile, appearance, data</div>
                        </div>
                    </button>
                    <button class="more-menu-item" onclick="switchMoreTab('about')">
                        <span class="icon"><i data-lucide="info"></i></span>
                        <div class="more-menu-item-content">
                            <div class="more-menu-item-title">About Tavola</div>
                            <div class="more-menu-item-desc">Our mission and how it works</div>
                        </div>
                    </button>
                </div>

                <!-- Kitchen Sub-View -->
                <div class="hidden" id="more-kitchen">
                    <button class="btn btn-ghost mb-16" onclick="showMoreMenu()">â† Back</button>

                    <!-- Page Header -->
                    <div class="page-header">
                        <h1 class="page-headline">Your kitchen, organized</h1>
                        <p class="page-subhead">Track what you have, know what you need and never let ingredients go to waste</p>
                    </div>

                    <div class="tabs">
                        <button class="tab active" onclick="switchKitchenTab('pantry')">Pantry</button>
                        <button class="tab" onclick="switchKitchenTab('shopping')">Shopping</button>
                        <button class="tab" onclick="switchKitchenTab('batch')">Batch Prep</button>
                        <button class="tab" onclick="switchKitchenTab('subs')">Substitutions</button>
                        <button class="tab" onclick="switchKitchenTab('collections')">Collections</button>
                    </div>
                    <div class="tab-content active" id="kitchen-pantry">
                        <div class="flex flex-between flex-center mb-16">
                            <span class="text-muted">Track your ingredients</span>
                            <div class="flex gap-8">
                                <button class="btn btn-sm btn-secondary" onclick="openPantryScanModal()"><i data-lucide="camera" style="width:14px;height:14px;vertical-align:middle"></i> Scan</button>
                                <button class="btn btn-sm btn-secondary" id="pantry-voice-btn" onclick="startPantryVoice()"><i data-lucide="mic" style="width:14px;height:14px;vertical-align:middle"></i> Voice</button>
                                <button class="btn btn-sm btn-primary" onclick="openAddPantryModal()">+ Add</button>
                            </div>
                        </div>

                        <!-- What Can I Make Button -->
                        <button class="btn btn-primary btn-block mb-16" onclick="openWhatCanIMakeModal()" style="padding: 14px; font-size: 1rem;">
                            <i data-lucide="cooking-pot" style="width:16px;height:16px;vertical-align:middle"></i> What Can I Make Right Now?
                        </button>

                        <!-- Pantry Alerts Section -->
                        <div class="pantry-alerts" id="pantry-alerts"></div>

                        <!-- Quick Add from Delivery -->
                        <div class="quick-add-section" id="quick-add-section">
                            <div class="quick-add-header" onclick="toggleQuickAddSection()">
                                <span><i data-lucide="truck" style="width:14px;height:14px;vertical-align:middle"></i> Quick Add from Delivery</span>
                                <span class="accordion-icon">â–¼</span>
                            </div>
                            <div class="quick-add-content" id="quick-add-content">
                                <p class="text-muted" style="font-size: 0.85rem; margin-bottom: 12px;">Just got groceries? Add them quickly:</p>
                                <div class="quick-add-btns">
                                    <button class="quick-add-btn" onclick="openDeliveryQuickAdd('misfits')">
                                        <div><i data-lucide="leaf" style="width:20px;height:20px"></i></div>
                                        <div style="font-weight: 500;">Misfits Market</div>
                                    </button>
                                    <button class="quick-add-btn" onclick="openDeliveryQuickAdd('wholefoods')">
                                        <div><i data-lucide="shopping-cart" style="width:20px;height:20px"></i></div>
                                        <div style="font-weight: 500;">Whole Foods</div>
                                    </button>
                                    <button class="quick-add-btn" onclick="openDeliveryQuickAdd('csa')">
                                        <div><i data-lucide="sprout" style="width:20px;height:20px"></i></div>
                                        <div style="font-weight: 500;">CSA Pickup</div>
                                    </button>
                                    <button class="quick-add-btn" onclick="openDeliveryQuickAdd('custom')">
                                        <div><i data-lucide="plus" style="width:20px;height:20px"></i></div>
                                        <div style="font-weight: 500;">Custom</div>
                                    </button>
                                </div>
                            </div>
                        </div>

                        <div class="divider-label mb-16 mt-16">Pantry Inventory</div>

                        <div id="pantry-list"></div>
                        <div class="empty-state" id="pantry-empty">
                            <div class="empty-state-icon"><i data-lucide="package" style="width:32px;height:32px;color:var(--gray-text)"></i></div>
                            <div class="empty-state-title">Pantry is empty</div>
                            <p>Add items manually or scan with your camera.</p>
                        </div>
                    </div>
                    <div class="tab-content" id="kitchen-shopping">
                        <!-- Smart Shopping Generator -->
                        <div class="card smart-shopping-card mb-16" id="smart-shopping-generator">
                            <div class="smart-shopping-header">
                                <span class="smart-shopping-icon"><i data-lucide="bot" style="width:16px;height:16px"></i></span>
                                <h3 class="smart-shopping-title">Generate Smart Shopping List</h3>
                            </div>
                            <p class="text-muted mb-12" style="font-size: 0.85rem;">Automatically creates a list based on:</p>
                            <ul class="smart-shopping-features">
                                <li><i data-lucide="calendar" style="width:14px;height:14px;vertical-align:middle"></i> Your weekly meal plan (all meals)</li>
                                <li><i data-lucide="package" style="width:14px;height:14px;vertical-align:middle"></i> Current pantry inventory</li>
                                <li><i data-lucide="alert-triangle" style="width:14px;height:14px;vertical-align:middle"></i> Items running low</li>
                                <li><i data-lucide="star" style="width:14px;height:14px;vertical-align:middle"></i> Your typical staples</li>
                            </ul>
                            <button class="btn btn-primary btn-block mt-12" onclick="generateSmartShoppingList()">
                                <i data-lucide="target" style="width:14px;height:14px;vertical-align:middle"></i> Generate from This Week
                            </button>
                        </div>

                        <div class="divider-label mb-16">Your Shopping Lists</div>

                        <div class="flex flex-between flex-center mb-16">
                            <select class="form-select" id="shopping-list-select" style="max-width: 200px;" onchange="loadShoppingList()">
                                <option value="weekly">Weekly Groceries</option>
                            </select>
                            <button class="btn btn-sm btn-primary" onclick="openAddShoppingModal()">+ Add</button>
                        </div>
                        <div id="shopping-list"></div>
                        <div class="empty-state" id="shopping-empty">
                            <div class="empty-state-icon"><i data-lucide="shopping-cart" style="width:32px;height:32px;color:var(--gray-text)"></i></div>
                            <div class="empty-state-title">List is empty</div>
                            <p>Add items or generate from meal plan.</p>
                        </div>
                        <div class="flex gap-8 mt-16">
                            <button class="btn btn-secondary" onclick="printShoppingList()" style="flex: 1;"><i data-lucide="printer" style="width:14px;height:14px;vertical-align:middle"></i> Print</button>
                            <button class="btn btn-secondary" onclick="clearCheckedItems()" style="flex: 1;">Clear Done</button>
                        </div>
                    </div>
                    <div class="tab-content" id="kitchen-batch">
                        <div class="card">
                            <h3 class="card-title"><i data-lucide="layout-grid" style="width:16px;height:16px;vertical-align:middle"></i> Plan Batch Cooking Session</h3>
                            <div class="form-group">
                                <label>What to prep?</label>
                                <div class="grid grid-2">
                                    <label class="checkbox-item"><input type="checkbox" name="batchItems" value="chicken" onchange="checkBatchIngredients()"> Chicken</label>
                                    <label class="checkbox-item"><input type="checkbox" name="batchItems" value="fish" onchange="checkBatchIngredients()"> Fish</label>
                                    <label class="checkbox-item"><input type="checkbox" name="batchItems" value="grains" onchange="checkBatchIngredients()"> Grains</label>
                                    <label class="checkbox-item"><input type="checkbox" name="batchItems" value="vegetables" onchange="checkBatchIngredients()"> Veggies</label>
                                    <label class="checkbox-item"><input type="checkbox" name="batchItems" value="sauce" onchange="checkBatchIngredients()"> Sauces</label>
                                    <label class="checkbox-item"><input type="checkbox" name="batchItems" value="soup" onchange="checkBatchIngredients()"> Soup</label>
                                </div>
                            </div>
                            <div class="form-group">
                                <label>Time available</label>
                                <select class="form-select" id="batch-time">
                                    <option value="1">1 hour</option>
                                    <option value="2" selected>2 hours</option>
                                    <option value="3">3+ hours</option>
                                </select>
                            </div>

                            <!-- Pantry Ingredient Check -->
                            <div class="batch-ingredient-check" id="batch-ingredient-check" style="display: none;">
                                <div class="batch-ingredient-header">
                                    <span><i data-lucide="package" style="width:14px;height:14px;vertical-align:middle"></i></span> Ingredient Check
                                </div>
                                <div id="batch-ingredient-list"></div>
                                <div class="batch-missing-items" id="batch-missing-items" style="display: none;">
                                    <div style="font-weight: 600; margin-bottom: 8px;">Missing Items:</div>
                                    <div id="batch-missing-list"></div>
                                    <button class="btn btn-secondary btn-sm mt-8" onclick="addBatchMissingToShopping()">
                                        <i data-lucide="shopping-cart" style="width:14px;height:14px;vertical-align:middle"></i> Add Missing to Shopping List
                                    </button>
                                </div>
                            </div>

                            <button class="btn btn-primary btn-block mt-16" onclick="generateBatchPlan()">Generate Plan</button>
                        </div>
                        <div id="batch-plan-output"></div>
                    </div>
                    <div class="tab-content" id="kitchen-subs">
                        <div class="form-group">
                            <input type="text" class="form-input" id="subs-search" placeholder="I'm out of..." oninput="searchSubstitutions()">
                        </div>
                        <div id="subs-results"></div>
                        <div id="subs-categories">
                            <div class="accordion-item">
                                <div class="accordion-header" onclick="toggleAccordion(this)">
                                    <span><i data-lucide="milk" style="width:16px;height:16px;vertical-align:middle"></i> Dairy</span><span class="accordion-icon">â–¼</span>
                                </div>
                                <div class="accordion-body">
                                    <p><strong>Greek Yogurt â†’</strong> Labneh, sour cream</p>
                                    <p><strong>Feta â†’</strong> Goat cheese, ricotta salata</p>
                                    <p><strong>Parmesan â†’</strong> Pecorino, nutritional yeast</p>
                                </div>
                            </div>
                            <div class="accordion-item">
                                <div class="accordion-header" onclick="toggleAccordion(this)">
                                    <span><i data-lucide="leaf" style="width:16px;height:16px;vertical-align:middle"></i> Herbs</span><span class="accordion-icon">â–¼</span>
                                </div>
                                <div class="accordion-body">
                                    <p><strong>Fresh herbs â†’</strong> Dried at 1/3 amount</p>
                                    <p><strong>Basil â†’</strong> Oregano, parsley</p>
                                    <p><strong>Dill â†’</strong> Fennel fronds, tarragon</p>
                                </div>
                            </div>
                            <div class="accordion-item">
                                <div class="accordion-header" onclick="toggleAccordion(this)">
                                    <span><i data-lucide="citrus" style="width:16px;height:16px;vertical-align:middle"></i> Acids</span><span class="accordion-icon">â–¼</span>
                                </div>
                                <div class="accordion-body">
                                    <p><strong>Lemon juice â†’</strong> White wine vinegar + sugar</p>
                                    <p><strong>Red wine vinegar â†’</strong> Balsamic, sherry vinegar</p>
                                    <p><strong>White wine â†’</strong> Broth + vinegar splash</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="tab-content" id="kitchen-collections">
                        <div class="flex flex-between flex-center mb-16">
                            <span class="text-muted">Organize your recipes into cookbooks</span>
                            <button class="btn btn-sm btn-primary" onclick="openCreateCollectionModal()">+ New Collection</button>
                        </div>
                        <div id="collections-list"></div>
                    </div>
                </div>

                <!-- Garden Sub-View -->
                <div class="hidden" id="more-garden">
                    <button class="btn btn-ghost mb-16" onclick="showMoreMenu()">â† Back</button>
                    <h2 class="section-title"><i data-lucide="sprout" style="width:20px;height:20px;vertical-align:middle"></i> Garden</h2>
                    <div class="tabs">
                        <button class="tab active" onclick="switchGardenTab('inventory')">My Garden</button>
                        <button class="tab" onclick="switchGardenTab('planting')">Planting</button>
                        <button class="tab" onclick="switchGardenTab('harvest')">Harvest</button>
                    </div>
                    <div class="tab-content active" id="garden-inventory">
                        <div class="flex flex-between flex-center mb-16">
                            <span class="text-muted">What's growing</span>
                            <button class="btn btn-sm btn-primary" onclick="openAddPlantModal()">+ Add</button>
                        </div>
                        <div id="garden-plants"></div>
                        <button class="btn btn-secondary mt-16 btn-block" onclick="askNonnaWithGarden()"><i data-lucide="cherry" style="width:14px;height:14px;vertical-align:middle"></i> Recipes with my harvest</button>
                    </div>
                    <div class="tab-content" id="garden-planting">
                        <div class="card">
                            <h3 class="card-title"><i data-lucide="sprout" style="width:16px;height:16px;vertical-align:middle"></i> Plant Now</h3>
                            <p class="text-muted mb-16">Recommendations for your zone</p>
                            <div id="planting-suggestions"></div>
                        </div>
                    </div>
                    <div class="tab-content" id="garden-harvest">
                        <div class="flex flex-between flex-center mb-16">
                            <span class="text-muted">Harvest log</span>
                            <button class="btn btn-sm btn-primary" onclick="openLogHarvestModal()">+ Log</button>
                        </div>
                        <div id="harvest-log"></div>
                    </div>
                </div>

                <!-- Crohn's Care Sub-View -->
                <div class="hidden" id="more-crohns">
                    <button class="btn btn-ghost mb-16" onclick="showMoreMenu()">â† Back</button>
                    <h2 class="section-title"><i data-lucide="stethoscope" style="width:20px;height:20px;vertical-align:middle"></i> Crohn's Care</h2>
                    <button class="btn btn-primary btn-block" style="padding: 20px; font-size: 1.1rem; margin-bottom: 20px;" onclick="activateFlareMode()">
                        <i data-lucide="frown" style="width:18px;height:18px;vertical-align:middle"></i> I'm Having a Flare - Help Me
                    </button>
                    <div class="flare-banner hidden" id="flare-mode-banner">
                        <div class="flare-banner-title"><i data-lucide="thermometer" style="width:18px;height:18px;vertical-align:middle;margin-right:4px"></i> Flare Mode Active</div>
                        <div class="flare-banner-text">Nonna will only suggest gentle meals.</div>
                        <button class="btn btn-sm btn-ghost mt-8" onclick="deactivateFlareMode()">Exit Flare Mode</button>
                    </div>
                    <div class="card">
                        <h3 class="card-title"><i data-lucide="heart-pulse" style="width:16px;height:16px;vertical-align:middle"></i> Gentle Meal Ideas</h3>
                        <div class="quick-actions">
                            <button class="quick-action" onclick="askNonna('Give me a gentle soup recipe for a flare day')">Soothing Soup</button>
                            <button class="quick-action" onclick="askNonna('Easy-to-digest dinner')">Easy Dinner</button>
                            <button class="quick-action" onclick="askNonna('Simple breakfast for low energy')">Simple Breakfast</button>
                        </div>
                    </div>
                    <div class="card">
                        <h3 class="card-title"><i data-lucide="ban" style="width:16px;height:16px;vertical-align:middle"></i> Avoid During Flare</h3>
                        <ul style="padding-left: 20px; color: var(--gray-text); font-size: 0.9rem;">
                            <li>Raw vegetables</li>
                            <li>High-fiber foods</li>
                            <li>Spicy foods</li>
                            <li>Dairy (if intolerant)</li>
                            <li>Nuts and seeds</li>
                            <li>Fried foods</li>
                        </ul>
                    </div>
                </div>

                <!-- History Sub-View -->
                <div class="hidden" id="more-history">
                    <button class="btn btn-ghost mb-16" onclick="showMoreMenu()">â† Back</button>
                    <h2 class="section-title"><i data-lucide="book-open" style="width:20px;height:20px;vertical-align:middle"></i> Meal History</h2>
                    <div class="card">
                        <h3 class="card-title"><i data-lucide="bar-chart-3" style="width:16px;height:16px;vertical-align:middle"></i> Stats</h3>
                        <div class="grid grid-2">
                            <div><strong>This Week:</strong> <span id="stat-week">0</span> meals</div>
                            <div><strong>This Month:</strong> <span id="stat-month">0</span> meals</div>
                        </div>
                    </div>
                    <div class="flex flex-between flex-center mb-16 mt-16">
                        <span class="text-muted">Recent meals</span>
                        <button class="btn btn-sm btn-secondary" onclick="openAddMealModal()">+ Add</button>
                    </div>
                    <div id="history-list"></div>
                    <div class="empty-state" id="history-empty">
                        <div class="empty-state-icon"><i data-lucide="book-open" style="width:32px;height:32px;color:var(--gray-text)"></i></div>
                        <div class="empty-state-title">No meals logged</div>
                        <p>Mark recipes as cooked to track history.</p>
                    </div>
                </div>

                <!-- Settings Sub-View -->
                <div class="hidden" id="more-settings">
                    <button class="btn btn-ghost mb-16" onclick="showMoreMenu()">â† Back</button>
                    <h2 class="section-title"><i data-lucide="settings" style="width:20px;height:20px;vertical-align:middle"></i> Settings</h2>
                    <div class="card">
                        <h3 class="card-title"><i data-lucide="palette" style="width:16px;height:16px;vertical-align:middle"></i> Appearance</h3>
                        <label class="toggle">
                            <input type="checkbox" id="dark-mode-toggle" onchange="toggleDarkMode()">
                            <span class="toggle-switch"></span>
                            <span><i data-lucide="moon" style="width:14px;height:14px;vertical-align:middle"></i> Dark Mode</span>
                        </label>
                    </div>
                    <div class="card">
                        <h3 class="card-title"><i data-lucide="user" style="width:16px;height:16px;vertical-align:middle"></i> Profile</h3>
                        <button class="btn btn-secondary btn-block" onclick="editProfile()">Edit Health Profile</button>
                    </div>
                    <div class="card">
                        <h3 class="card-title"><i data-lucide="graduation-cap" style="width:16px;height:16px;vertical-align:middle"></i> Help</h3>
                        <button class="btn btn-secondary btn-block mb-8" onclick="restartTutorial()">Restart Tutorial</button>
                    </div>
                    <div class="card">
                        <h3 class="card-title"><i data-lucide="save" style="width:16px;height:16px;vertical-align:middle"></i> Data</h3>
                        <div class="flex gap-8" style="flex-wrap: wrap;">
                            <button class="btn btn-secondary btn-sm" onclick="exportAllData()">Export</button>
                            <button class="btn btn-secondary btn-sm" onclick="importData()">Import</button>
                            <button class="btn btn-sm" style="background: var(--danger); color: white;" onclick="confirmClearAllData()">Clear All</button>
                        </div>
                    </div>
                    <div class="card">
                        <h3 class="card-title"><i data-lucide="info" style="width:16px;height:16px;vertical-align:middle"></i> About</h3>
                        <p class="text-muted">Tavola v3.0</p>
                        <p class="text-muted" style="font-size: 0.85rem;">Made with love for chronic illness warriors</p>
                    </div>
                </div>

                <!-- About Sub-View -->
                <div class="hidden" id="more-about">
                    <button class="btn btn-ghost mb-16" onclick="showMoreMenu()"><i data-lucide="arrow-left" style="width:14px;height:14px;vertical-align:middle"></i> Back</button>
                    <div class="card" style="text-align:center; padding: 32px 24px;">
                        <div style="font-family: var(--font-script); font-size: 2.8rem; color: var(--navy); margin-bottom: 8px;">Tavola</div>
                        <p style="font-family: var(--font-heading); color: var(--gray-text); font-size: 1.1rem;">Where Food Brings Us Together</p>
                    </div>
                    <div class="card">
                        <h3 class="card-title"><i data-lucide="target" style="width:18px;height:18px;vertical-align:middle"></i> Our Mission</h3>
                        <p style="line-height: 1.7; color: var(--charcoal);">Tavola is for people who love cooking, cherish building connections through food, and those managing chronic health conditions who need creative ways to nourish their bodies while enjoying diverse, delicious meals. Named after the Italian word for "table," Tavola brings families together through the simple act of sharing a meal.</p>
                    </div>
                    <div class="card">
                        <h3 class="card-title"><i data-lucide="heart-pulse" style="width:18px;height:18px;vertical-align:middle"></i> Built For</h3>
                        <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 20px; margin-top: 12px;">
                            <div style="text-align:center;">
                                <div style="margin-bottom:8px;"><i data-lucide="utensils" style="width:28px;height:28px;color:var(--seafoam)"></i></div>
                                <strong style="display:block; margin-bottom:4px;">Food Lovers</strong>
                                <p class="text-muted" style="font-size:0.85rem;">Whether you're batch-cooking Mediterranean feasts or experimenting with new cuisines, Tavola helps you plan, organize, and cook with confidence. Your personal AI sous chef, Nonna, is always ready to help.</p>
                            </div>
                            <div style="text-align:center;">
                                <div style="margin-bottom:8px;"><i data-lucide="users" style="width:28px;height:28px;color:var(--cerulean)"></i></div>
                                <strong style="display:block; margin-bottom:4px;">Families & Community</strong>
                                <p class="text-muted" style="font-size:0.85rem;">Share recipes with loved ones through Family Tavola. Learn from your mom's favorites, swap cooking tips with your sister, and build a shared family cookbook that spans generations.</p>
                            </div>
                            <div style="text-align:center;">
                                <div style="margin-bottom:8px;"><i data-lucide="shield-plus" style="width:28px;height:28px;color:var(--seafoam-dark)"></i></div>
                                <strong style="display:block; margin-bottom:4px;">Health & Wellness</strong>
                                <p class="text-muted" style="font-size:0.85rem;">Managing Crohn's disease, heart health, or other conditions doesn't mean sacrificing flavor. Tavola helps you plan anti-inflammatory, gut-friendly meals that are both delicious and healing.</p>
                            </div>
                        </div>
                    </div>
                    <div class="card">
                        <h3 class="card-title"><i data-lucide="lightbulb" style="width:18px;height:18px;vertical-align:middle"></i> How It Works</h3>
                        <ol style="padding-left: 20px; line-height: 2; color: var(--charcoal);">
                            <li>Chat with Nonna for personalized meal planning</li>
                            <li>Smart pantry management tracks what you have</li>
                            <li>Family Tavola shares recipes across your circle</li>
                            <li>Budget-aware suggestions based on local prices</li>
                        </ol>
                    </div>
                    <div class="card" style="background: var(--seafoam-light); border-left: 4px solid var(--seafoam);">
                        <h3 class="card-title"><i data-lucide="bot" style="width:18px;height:18px;vertical-align:middle"></i> Meet Nonna</h3>
                        <p style="font-style: italic; font-family: var(--font-heading); color: var(--navy); line-height: 1.6;">"Ciao, cara! I'm your AI cooking companion, powered by Claude. I know Mediterranean cuisine inside and out, I understand your health needs, and I'm here to help you cook with what you already have. Let's make something beautiful together!"</p>
                        <p style="text-align: right; color: var(--gray-text); margin-top: 8px;">Nonna</p>
                    </div>
                    <p class="text-muted" style="text-align:center; margin-top: 16px;">Tavola v3.0</p>
                </div>
            </div>

            <!-- FAVORITES View -->
            <div class="view" id="view-favorites">
                <h2 class="section-title"><i data-lucide="heart" style="width:20px;height:20px;vertical-align:middle"></i> Favorites</h2>
                <div class="flex flex-between flex-center mb-16">
                    <input type="text" class="form-input" id="favorites-search" placeholder="Search..." style="max-width: 200px;" oninput="filterFavorites()">
                    <select class="form-select" id="favorites-sort" style="max-width: 140px;" onchange="sortFavorites()">
                        <option value="recent">Recent</option>
                        <option value="rating">Rating</option>
                        <option value="name">Name A-Z</option>
                    </select>
                </div>
                <div class="grid grid-2" id="favorites-grid"></div>
                <div class="empty-state" id="favorites-empty">
                    <div class="empty-state-icon"><i data-lucide="heart" style="width:32px;height:32px;color:var(--gray-text)"></i></div>
                    <div class="empty-state-title">No favorites yet</div>
                    <p class="empty-state-text">Browse your recipe library or ask Nonna for suggestions, then tap the heart to save favorites here!</p>
                    <button class="btn btn-primary" onclick="navigateTo('recipes')"><i data-lucide="book-open" style="width:14px;height:14px;vertical-align:middle"></i> Browse Recipe Library</button>
                </div>
            </div>
        </div>
    </main>

    <!-- Bottom Navigation (5 tabs with dropdowns) -->
    <nav class="bottom-nav hidden" id="bottom-nav">
        <!-- Home (direct) -->
        <div class="nav-group">
            <button class="nav-item active" onclick="navigateTo('home'); closeAllDropdowns();" data-view="home" data-nav="home">
                <i data-lucide="home"></i>
                <span>Home</span>
            </button>
        </div>
        <!-- Cooking (dropdown) -->
        <div class="nav-group" id="mobile-cooking-group">
            <button class="nav-item" data-nav="cooking" onclick="toggleMobileDropdown('mobile-cooking-dropdown', this)">
                <i data-lucide="chef-hat"></i>
                <span>Cooking</span>
            </button>
            <div class="nav-dropdown-menu" id="mobile-cooking-dropdown">
                <button class="nav-dropdown-item" onclick="navAction('nonna')"><i data-lucide="message-circle"></i> Chat with Nonna</button>
                <button class="nav-dropdown-item" onclick="navAction('recipes')"><i data-lucide="book-open"></i> Recipes</button>
                <button class="nav-dropdown-item" onclick="navAction('favorites')"><i data-lucide="heart"></i> Favorites</button>
                <button class="nav-dropdown-item" onclick="navAction('family')"><i data-lucide="users"></i> Family Tavola</button>
                <button class="nav-dropdown-item" onclick="navAction('import-recipe')"><i data-lucide="download"></i> Import Recipe</button>
                <button class="nav-dropdown-item" onclick="navAction('leftovers')"><i data-lucide="wand-sparkles"></i> Transform Leftovers</button>
                <button class="nav-dropdown-item" onclick="navAction('collections')"><i data-lucide="library"></i> Collections</button>
            </div>
        </div>
        <!-- Plan (dropdown) -->
        <div class="nav-group" id="mobile-plan-group">
            <button class="nav-item" data-nav="plan" onclick="toggleMobileDropdown('mobile-plan-dropdown', this)">
                <i data-lucide="calendar"></i>
                <span>Plan</span>
            </button>
            <div class="nav-dropdown-menu" id="mobile-plan-dropdown">
                <button class="nav-dropdown-item" onclick="navAction('week')"><i data-lucide="calendar-days"></i> This Week</button>
                <button class="nav-dropdown-item" onclick="navAction('history')"><i data-lucide="clock"></i> Meal History</button>
                <button class="nav-dropdown-item" onclick="navAction('batch')"><i data-lucide="cooking-pot"></i> Batch Prep</button>
            </div>
        </div>
        <!-- Pantry (dropdown) -->
        <div class="nav-group" id="mobile-pantry-group">
            <button class="nav-item" data-nav="pantry" onclick="toggleMobileDropdown('mobile-pantry-dropdown', this)">
                <i data-lucide="warehouse"></i>
                <span>Pantry</span>
            </button>
            <div class="nav-dropdown-menu" id="mobile-pantry-dropdown">
                <button class="nav-dropdown-item" onclick="navAction('pantry')"><i data-lucide="package"></i> My Pantry</button>
                <button class="nav-dropdown-item" onclick="navAction('shopping')"><i data-lucide="shopping-cart"></i> Shopping List</button>
                <button class="nav-dropdown-item" onclick="navAction('garden')"><i data-lucide="flower-2"></i> Garden</button>
                <button class="nav-dropdown-item" onclick="navAction('crohns')"><i data-lucide="shield-plus"></i> Crohn's Care</button>
            </div>
        </div>
        <!-- Nonna (direct) -->
        <div class="nav-group">
            <button class="nav-item" onclick="navigateTo('nonna'); closeAllDropdowns();" data-view="nonna" data-nav="nonna">
                <i data-lucide="message-circle"></i>
                <span>Nonna</span>
            </button>
        </div>
        <!-- Workouts (direct) -->
        <div class="nav-group">
            <button class="nav-item" onclick="navigateTo('workouts'); closeAllDropdowns();" data-view="workouts" data-nav="workouts">
                <i data-lucide="dumbbell"></i>
                <span>Workouts</span>
            </button>
        </div>
    </nav>

    <!-- Modal Container -->
    <div class="modal-overlay" id="modal-overlay" onclick="closeModalOnOverlay(event)" role="dialog" aria-modal="true" aria-labelledby="modal-title-label">
        <div class="modal" id="modal-content"></div>
    </div>

    <!-- Toast (legacy) -->
    <div class="toast" id="toast"></div>

    <!-- Enhanced Toast Container -->
    <div class="toast-container" id="toast-container"></div>

    <!-- Onboarding Overlay -->
    <div class="onboarding-overlay" id="onboarding-overlay">
        <div class="onboarding-card" id="onboarding-card"></div>
    </div>

    <!-- Cook Mode Overlay -->
    <div class="cook-mode-overlay" id="cook-mode-overlay">
        <div class="cook-mode-header">
            <span class="cook-mode-progress" id="cook-mode-progress">Step 1 of 5</span>
            <button class="cook-mode-close" onclick="exitCookMode()">âœ• Exit</button>
        </div>
        <div class="cook-mode-body" id="cook-mode-body"></div>
        <div class="cook-mode-footer">
            <button class="btn btn-secondary" id="cook-prev-btn" onclick="cookModePrev()">â† Previous</button>
            <button class="btn btn-primary" id="cook-next-btn" onclick="cookModeNext()">Next â†’</button>
        </div>
    </div>

<!-- HTML STRUCTURE COMPLETE - JavaScript follows -->
<script>
// ========================================
// STORAGE KEYS
// ========================================
const STORAGE = {
    PROFILE: 'tavola_profile',
    CHAT: 'tavola_chat_history',
    FAVORITES: 'tavola_favorites',
    RECIPES: 'tavola_recipe_library',
    PANTRY: 'tavola_pantry',
    SHOPPING: 'tavola_shopping_lists',
    MEAL_PLANS: 'tavola_meal_plans',
    GARDEN: 'tavola_garden',
    HISTORY: 'tavola_meal_history',
    PREFS: 'tavola_preferences',
    ONBOARDING: 'tavola_onboarding_done',
    WORKOUTS: 'tavola_workouts',
    CONVERSATIONS: 'tavola_conversations'
};

// ========================================
// APP STATE
// ========================================
let state = {
    currentView: 'home',
    previousView: null,
    currentWeekOffset: 0,
    chatHistory: [],
    isProcessing: false,
    isRecording: false,
    flareMode: false,
    recognition: null,
    abortController: null,
    currentConversationId: null,
    cookMode: { active: false, recipe: null, currentStep: 0 },
    recipeEditMode: false,
    selectedRecipes: new Set(),
    selectedTagFilters: new Set(),
    // Auth state
    user: null,
    isAuthReady: false,
    syncEnabled: false,
    isSyncing: false,
    lastSyncTime: null
};

// Nonna's Tips
const NONNA_TIPS = [
    "Always finish with good olive oil - it makes everything taste better, cara.",
    "Cook with love, and the food will love you back.",
    "A little lemon brightens everything - just like a smile!",
    "Rest is an ingredient too. Take breaks when you need them.",
    "Fresh herbs are medicine for the soul and the body.",
    "Simple food, made well, is the best food of all.",
    "Batch cooking on good days saves you on hard days.",
    "The Mediterranean way is not a diet - it's a way of life.",
    "Olive oil, garlic, lemon - the holy trinity of healing.",
    "Gentle on the stomach, generous with flavor."
];

// ========================================
// FIREBASE AUTH & SYNC
// ========================================

// Wait for Firebase to be ready
function waitForFirebase() {
    return new Promise((resolve) => {
        if (window.firebaseReady) {
            resolve();
        } else {
            window.addEventListener('firebase-ready', resolve, { once: true });
        }
    });
}

// Initialize Firebase Auth listener
async function initFirebaseAuth() {
    await waitForFirebase();

    window.firebaseOnAuthStateChanged(window.firebaseAuth, (user) => {
        state.user = user;
        state.isAuthReady = true;
        updateAuthUI();

        if (user) {
            console.log('User signed in:', user.email);
            state.syncEnabled = true;
            // Sync data from Firestore
            syncFromFirestore();
            // Setup Family Tavola real-time listener
            setupFamilyRecipesListener();
        } else {
            console.log('User signed out');
            state.syncEnabled = false;
        }
    });
}

// Sign in with Google
async function signInWithGoogle() {
    try {
        await waitForFirebase();
        const result = await window.firebaseSignInWithPopup(
            window.firebaseAuth,
            window.firebaseGoogleProvider
        );
        showToast(`Welcome, ${result.user.displayName || result.user.email}! ${icon('sparkles',14)}`);
        return result.user;
    } catch (error) {
        console.error('Sign in error:', error);
        if (error.code === 'auth/popup-closed-by-user') {
            showToast('Sign in cancelled');
        } else if (error.code === 'auth/popup-blocked') {
            showToast('Please allow popups for sign in');
        } else {
            showToast('Sign in failed. Please try again.');
        }
        return null;
    }
}

// Sign out
async function signOutUser() {
    try {
        await waitForFirebase();
        await window.firebaseSignOut(window.firebaseAuth);
        state.user = null;
        state.syncEnabled = false;
        showToast('Signed out successfully');
        updateAuthUI();
    } catch (error) {
        console.error('Sign out error:', error);
        showToast('Sign out failed');
    }
}

// Update auth UI elements
function updateAuthUI() {
    const authBtn = document.getElementById('auth-btn');
    const userInfo = document.getElementById('user-info');
    const syncStatus = document.getElementById('sync-status');

    if (!state.isAuthReady) return;

    if (state.user) {
        if (authBtn) {
            authBtn.innerHTML = `<span class="icon"><i data-lucide="user" style="width:14px;height:14px"></i></span> Sign Out`;
            authBtn.onclick = signOutUser;
        }
        if (userInfo) {
            const displayName = state.user.displayName || state.user.email?.split('@')[0] || 'User';
            userInfo.innerHTML = `
                <div class="user-avatar">
                    ${state.user.photoURL
                        ? `<img src="${state.user.photoURL}" alt="${displayName}" />`
                        : `<span>${displayName.charAt(0).toUpperCase()}</span>`
                    }
                </div>
                <span class="user-name">${displayName}</span>
            `;
            userInfo.style.display = 'flex';
        }
        if (syncStatus) {
            syncStatus.innerHTML = state.isSyncing
                ? `${icon('cloud',14)} Syncing...`
                : `${icon('check-circle',14)} Synced`;
            syncStatus.style.display = 'block';
        }
    } else {
        if (authBtn) {
            authBtn.innerHTML = `<span class="icon"><i data-lucide="lock" style="width:16px;height:16px"></i></span> Sign In`;
            authBtn.onclick = signInWithGoogle;
        }
        if (userInfo) {
            userInfo.style.display = 'none';
        }
        if (syncStatus) {
            syncStatus.innerHTML = `${icon('cloud',14)} Sign in to sync`;
            syncStatus.style.display = 'block';
        }
    }

    // Handle routing based on auth state changes
    const isOnMarketingPage = document.getElementById('view-marketing')?.classList.contains('active');

    if (state.user && isOnMarketingPage) {
        // User just logged in from marketing page, transition to app
        const marketingView = document.getElementById('view-marketing');
        if (marketingView) {
            marketingView.style.display = 'none';
            marketingView.classList.remove('active');
        }
        showApp();
        navigateTo('home');
    } else if (!state.user && !isOnMarketingPage && !getStorage(STORAGE.PROFILE)) {
        // User logged out, show marketing
        showMarketingPage();
    }
}

// ========================================
// FIRESTORE SYNC FUNCTIONS
// ========================================

// Collection paths
function getUserCollection(collectionName) {
    if (!state.user) return null;
    return `users/${state.user.uid}/${collectionName}`;
}

// Sync all data to Firestore
async function syncToFirestore() {
    if (!state.user || !state.syncEnabled) return;

    state.isSyncing = true;
    updateAuthUI();

    try {
        await waitForFirebase();
        const batch = window.firestoreWriteBatch(window.firebaseDb);

        // Sync profile
        const profile = getStorage(STORAGE.PROFILE);
        if (profile) {
            const profileRef = window.firestoreDoc(window.firebaseDb, 'users', state.user.uid);
            batch.set(profileRef, {
                ...profile,
                email: state.user.email,
                updatedAt: window.firestoreServerTimestamp()
            }, { merge: true });
        }

        // Sync recipes
        const recipes = getRecipeLibrary();
        for (const recipe of recipes) {
            const recipeRef = window.firestoreDoc(
                window.firebaseDb,
                `users/${state.user.uid}/recipes`,
                recipe.id
            );
            batch.set(recipeRef, {
                ...recipe,
                updatedAt: window.firestoreServerTimestamp()
            });
        }

        // Sync meal plans
        const mealPlans = getStorage(STORAGE.MEAL_PLANS) || {};
        const mealPlansRef = window.firestoreDoc(
            window.firebaseDb,
            `users/${state.user.uid}/data`,
            'mealPlans'
        );
        batch.set(mealPlansRef, {
            plans: mealPlans,
            updatedAt: window.firestoreServerTimestamp()
        });

        // Sync pantry
        const pantry = getStorage(STORAGE.PANTRY) || [];
        const pantryRef = window.firestoreDoc(
            window.firebaseDb,
            `users/${state.user.uid}/data`,
            'pantry'
        );
        batch.set(pantryRef, {
            items: pantry,
            updatedAt: window.firestoreServerTimestamp()
        });

        // Sync shopping lists
        const shopping = getStorage(STORAGE.SHOPPING) || [];
        const shoppingRef = window.firestoreDoc(
            window.firebaseDb,
            `users/${state.user.uid}/data`,
            'shopping'
        );
        batch.set(shoppingRef, {
            lists: shopping,
            updatedAt: window.firestoreServerTimestamp()
        });

        // Sync workouts
        const workouts = getStorage(STORAGE.WORKOUTS) || [];
        const workoutsRef = window.firestoreDoc(
            window.firebaseDb,
            `users/${state.user.uid}/data`,
            'workouts'
        );
        batch.set(workoutsRef, {
            entries: workouts,
            updatedAt: window.firestoreServerTimestamp()
        });

        // Sync preferences
        const prefs = getStorage(STORAGE.PREFS) || {};
        const prefsRef = window.firestoreDoc(
            window.firebaseDb,
            `users/${state.user.uid}/data`,
            'preferences'
        );
        batch.set(prefsRef, {
            ...prefs,
            updatedAt: window.firestoreServerTimestamp()
        });

        await batch.commit();
        state.lastSyncTime = new Date();
        console.log('Data synced to Firestore');
    } catch (error) {
        console.error('Sync to Firestore failed:', error);
        showToast('Sync failed. Changes saved locally.');
    } finally {
        state.isSyncing = false;
        updateAuthUI();
    }
}

// Sync data from Firestore (on login)
async function syncFromFirestore() {
    if (!state.user) return;

    state.isSyncing = true;
    updateAuthUI();

    try {
        await waitForFirebase();

        // Get profile
        const profileRef = window.firestoreDoc(window.firebaseDb, 'users', state.user.uid);
        const profileSnap = await window.firestoreGetDoc(profileRef);
        if (profileSnap.exists()) {
            const cloudProfile = profileSnap.data();
            const localProfile = getStorage(STORAGE.PROFILE);

            // Merge: prefer cloud data but keep local if cloud is older
            if (!localProfile || (cloudProfile.updatedAt?.toDate() > new Date(localProfile.updatedAt || 0))) {
                setStorage(STORAGE.PROFILE, cloudProfile);
            }
        }

        // Get recipes
        const recipesRef = window.firestoreCollection(
            window.firebaseDb,
            `users/${state.user.uid}/recipes`
        );
        const recipesSnap = await window.firestoreGetDocs(recipesRef);
        const cloudRecipes = [];
        recipesSnap.forEach(doc => {
            cloudRecipes.push({ ...doc.data(), id: doc.id });
        });

        if (cloudRecipes.length > 0) {
            // Merge with local recipes
            const localRecipes = getRecipeLibrary();
            const mergedRecipes = mergeRecipeLibraries(localRecipes, cloudRecipes);
            setStorage(STORAGE.RECIPES, mergedRecipes);
        }

        // Get meal plans
        const mealPlansRef = window.firestoreDoc(
            window.firebaseDb,
            `users/${state.user.uid}/data`,
            'mealPlans'
        );
        const mealPlansSnap = await window.firestoreGetDoc(mealPlansRef);
        if (mealPlansSnap.exists()) {
            const cloudPlans = mealPlansSnap.data().plans || {};
            const localPlans = getStorage(STORAGE.MEAL_PLANS) || {};
            const mergedPlans = { ...localPlans, ...cloudPlans };
            setStorage(STORAGE.MEAL_PLANS, mergedPlans);
        }

        // Get pantry
        const pantryRef = window.firestoreDoc(
            window.firebaseDb,
            `users/${state.user.uid}/data`,
            'pantry'
        );
        const pantrySnap = await window.firestoreGetDoc(pantryRef);
        if (pantrySnap.exists()) {
            const cloudPantry = pantrySnap.data().items || [];
            setStorage(STORAGE.PANTRY, cloudPantry);
        }

        // Get shopping lists
        const shoppingRef = window.firestoreDoc(
            window.firebaseDb,
            `users/${state.user.uid}/data`,
            'shopping'
        );
        const shoppingSnap = await window.firestoreGetDoc(shoppingRef);
        if (shoppingSnap.exists()) {
            const cloudShopping = shoppingSnap.data().lists || [];
            setStorage(STORAGE.SHOPPING, cloudShopping);
        }

        // Get workouts
        const workoutsRef = window.firestoreDoc(
            window.firebaseDb,
            `users/${state.user.uid}/data`,
            'workouts'
        );
        const workoutsSnap = await window.firestoreGetDoc(workoutsRef);
        if (workoutsSnap.exists()) {
            const cloudWorkouts = workoutsSnap.data().entries || [];
            setStorage(STORAGE.WORKOUTS, cloudWorkouts);
        }

        // Get preferences
        const prefsRef = window.firestoreDoc(
            window.firebaseDb,
            `users/${state.user.uid}/data`,
            'preferences'
        );
        const prefsSnap = await window.firestoreGetDoc(prefsRef);
        if (prefsSnap.exists()) {
            setStorage(STORAGE.PREFS, prefsSnap.data());
        }

        state.lastSyncTime = new Date();
        console.log('Data synced from Firestore');
        showToast(`Data synced from cloud ${icon('cloud',14)}`);

        // Refresh current view
        if (state.currentView) {
            navigateTo(state.currentView);
        }
    } catch (error) {
        console.error('Sync from Firestore failed:', error);
        showToast('Could not sync from cloud. Using local data.');
    } finally {
        state.isSyncing = false;
        updateAuthUI();
    }
}

// Merge recipe libraries (prefer newer versions)
function mergeRecipeLibraries(local, cloud) {
    const merged = new Map();

    // Add all local recipes
    local.forEach(recipe => {
        merged.set(recipe.id, recipe);
    });

    // Merge cloud recipes (prefer newer)
    cloud.forEach(cloudRecipe => {
        const localRecipe = merged.get(cloudRecipe.id);
        if (!localRecipe) {
            merged.set(cloudRecipe.id, cloudRecipe);
        } else {
            // Compare timestamps
            const cloudTime = cloudRecipe.updatedAt?.toDate?.() || new Date(cloudRecipe.updatedAt || 0);
            const localTime = new Date(localRecipe.updatedAt || localRecipe.dateGenerated || 0);

            if (cloudTime > localTime) {
                // Keep cloud version but merge cooking history
                merged.set(cloudRecipe.id, {
                    ...cloudRecipe,
                    cookingHistory: [
                        ...(localRecipe.cookingHistory || []),
                        ...(cloudRecipe.cookingHistory || [])
                    ].filter((v, i, a) => a.findIndex(t => t.date === v.date) === i)
                });
            }
        }
    });

    return Array.from(merged.values());
}

// Debounced sync function (call after data changes)
let syncTimeout = null;
function debouncedSync() {
    if (!state.syncEnabled) return;

    if (syncTimeout) {
        clearTimeout(syncTimeout);
    }

    syncTimeout = setTimeout(() => {
        syncToFirestore();
    }, 2000); // Wait 2 seconds before syncing
}

// ========================================
// PHOTO UPLOAD TO FIREBASE STORAGE
// ========================================

async function uploadRecipePhoto(recipeId, file) {
    if (!state.user) {
        showToast('Sign in to upload photos');
        return null;
    }

    try {
        await waitForFirebase();

        // Create a reference to the file location
        const photoRef = window.storageRef(
            window.firebaseStorage,
            `users/${state.user.uid}/recipes/${recipeId}/${file.name}`
        );

        // Upload the file
        const snapshot = await window.storageUploadBytes(photoRef, file);

        // Get the download URL
        const downloadURL = await window.storageGetDownloadURL(snapshot.ref);

        console.log('Photo uploaded:', downloadURL);
        return downloadURL;
    } catch (error) {
        console.error('Photo upload failed:', error);
        showToast('Photo upload failed');
        return null;
    }
}

async function deleteRecipePhoto(photoURL) {
    if (!state.user || !photoURL) return;

    try {
        await waitForFirebase();
        const photoRef = window.storageRef(window.firebaseStorage, photoURL);
        await window.storageDeleteObject(photoRef);
        console.log('Photo deleted');
    } catch (error) {
        console.error('Photo delete failed:', error);
    }
}

// ========================================
// INITIALIZATION
// ========================================
document.addEventListener('DOMContentLoaded', () => {
    initApp();
});

function initApp() {
    // Clean up bad data on startup
    cleanupDuplicateRecipes();
    cleanupBadMealPlans();
    cleanupBadWorkouts();

    // Initialize Firebase Auth (non-blocking)
    initFirebaseAuth();

    // Check auth state and route to appropriate view
    checkAuthAndRoute();

    initVoiceRecognition();
    initChatInput();
    loadPreferences();
    setDailyTip();
    initDesktopDropdownHover();
}

function initDesktopDropdownHover() {
    // Initialize hover behavior for desktop navigation dropdowns
    const navGroups = [
        { btn: 'desktop-cooking-group', menu: 'desktop-cooking-dropdown' },
        { btn: 'desktop-plan-group', menu: 'desktop-plan-dropdown' },
        { btn: 'desktop-pantry-group', menu: 'desktop-pantry-dropdown' }
    ];

    navGroups.forEach(({ btn, menu }) => {
        const btnEl = document.getElementById(btn);
        const menuEl = document.getElementById(menu);

        if (!btnEl || !menuEl) return;

        // Show dropdown on button hover
        btnEl.addEventListener('mouseenter', () => {
            showDesktopDropdown(menu);
        });

        // Hide dropdown when leaving button (with delay)
        btnEl.addEventListener('mouseleave', () => {
            hideDesktopDropdown(menu, 300);
        });

        // Keep dropdown open when hovering over it
        menuEl.addEventListener('mouseenter', () => {
            showDesktopDropdown(menu);
        });

        // Hide dropdown when leaving menu (with delay)
        menuEl.addEventListener('mouseleave', () => {
            hideDesktopDropdown(menu, 300);
        });
    });
}

function checkAuthAndRoute() {
    setTimeout(() => {
        const hasProfile = getStorage(STORAGE.PROFILE);
        const isLoggedIn = state.user || hasProfile;

        if (isLoggedIn) {
            showApp();
            loadChatHistory();
            if (state.chatHistory.length === 0) {
                addWelcomeMessage();
            }
            checkOnboarding();
        } else {
            showMarketingPage();
        }
    }, 300);
}

function showMarketingPage() {
    document.getElementById('welcome-screen').style.display = 'none';
    document.getElementById('intake-form').classList.remove('active');
    document.getElementById('app-main').classList.remove('active');
    document.getElementById('app-header').classList.add('hidden');
    document.getElementById('bottom-nav').classList.add('hidden');

    const marketingView = document.getElementById('view-marketing');
    if (marketingView) {
        marketingView.style.display = 'block';
        marketingView.classList.add('active');
        refreshIcons();
    }
}

function showMarketingAbout() {
    state.previousView = state.currentView || 'marketing';
    const marketingView = document.getElementById('view-marketing');
    const aboutView = document.getElementById('view-about');

    if (marketingView) {
        marketingView.classList.remove('active');
        marketingView.style.display = 'none';
    }

    if (aboutView) {
        aboutView.style.display = 'block';
        aboutView.classList.add('active');
        refreshIcons();
    }
}

function navigateBackFromAbout() {
    const aboutView = document.getElementById('view-about');
    const faqView = document.getElementById('view-faq');

    if (aboutView) {
        aboutView.classList.remove('active');
        aboutView.style.display = 'none';
    }
    if (faqView) {
        faqView.classList.remove('active');
        faqView.style.display = 'none';
    }

    if (state.user || getStorage(STORAGE.PROFILE)) {
        showApp();
        navigateTo('home');
    } else {
        showMarketingPage();
    }
}

function showFAQPage() {
    state.previousView = state.currentView || 'marketing';
    const marketingView = document.getElementById('view-marketing');
    const faqView = document.getElementById('view-faq');

    if (marketingView) {
        marketingView.classList.remove('active');
        marketingView.style.display = 'none';
    }

    if (faqView) {
        faqView.style.display = 'block';
        faqView.classList.add('active');
        refreshIcons();
    }
}

function toggleFAQ(element) {
    const faqItem = element.parentElement;
    const wasActive = faqItem.classList.contains('active');

    // Close all FAQ items
    document.querySelectorAll('.faq-item').forEach(item => {
        item.classList.remove('active');
    });

    // Open clicked item if it wasn't active
    if (!wasActive) {
        faqItem.classList.add('active');
    }

    refreshIcons();
}

function cleanupDuplicateRecipes() {
    const library = getStorage(STORAGE.RECIPES) || [];
    if (library.length === 0) return;

    const seen = new Map(); // normalized title -> best recipe
    const duplicatesRemoved = [];

    // Sort by date (newest first) so we keep the most recent version
    library.sort((a, b) => new Date(b.dateGenerated) - new Date(a.dateGenerated));

    library.forEach(recipe => {
        const normalized = normalizeRecipeTitle(recipe.title);

        if (!seen.has(normalized)) {
            // First occurrence (newest) - keep it
            seen.set(normalized, recipe);
        } else {
            // Duplicate found - merge important data into the kept one
            const kept = seen.get(normalized);

            // Preserve cooking history, ratings, and favorites from duplicates
            if (recipe.timesCooked > (kept.timesCooked || 0)) {
                kept.timesCooked = recipe.timesCooked;
            }
            if (recipe.averageRating > (kept.averageRating || 0)) {
                kept.averageRating = recipe.averageRating;
            }
            if (recipe.favorited) {
                kept.favorited = true;
            }
            if (recipe.cookingHistory?.length > 0) {
                kept.cookingHistory = kept.cookingHistory || [];
                kept.cookingHistory = [...kept.cookingHistory, ...recipe.cookingHistory];
            }

            duplicatesRemoved.push(recipe.title);
        }
    });

    if (duplicatesRemoved.length > 0) {
        // Save cleaned library
        const cleanedLibrary = Array.from(seen.values());
        setStorage(STORAGE.RECIPES, cleanedLibrary);
        console.log(`Cleaned up ${duplicatesRemoved.length} duplicate recipes:`, duplicatesRemoved);
    }
}

function cleanupBadMealPlans() {
    const mealPlans = getStorage(STORAGE.MEAL_PLANS) || {};
    let cleaned = false;

    Object.keys(mealPlans).forEach(dateStr => {
        const dayData = mealPlans[dateStr];

        // Check each meal slot
        ['breakfast', 'lunch', 'dinner', 'snacks'].forEach(slot => {
            const meal = dayData[slot];
            if (meal) {
                // Remove meals with invalid titles (empty, whitespace, date fragments like ", Feb 2")
                const title = meal.title || '';
                const isInvalid = !title.trim() ||
                    title.match(/^[\s,]*$/) ||  // Empty or just comma/spaces
                    title.match(/^[\s,]*[A-Z][a-z]{2}\s+\d/) ||  // Date fragment like ", Feb 2"
                    title === 'undefined';  // Literal "undefined"

                if (isInvalid) {
                    delete dayData[slot];
                    cleaned = true;
                    console.log(`Removed invalid ${slot} entry for ${dateStr}: "${title}"`);
                }
            }
        });

        // Also handle legacy format with invalid title at root
        if (dayData.title) {
            const title = dayData.title;
            const isInvalid = !title.trim() ||
                title.match(/^[\s,]*$/) ||
                title.match(/^[\s,]*[A-Z][a-z]{2}\s+\d/) ||
                title === 'undefined';

            if (isInvalid) {
                delete mealPlans[dateStr];
                cleaned = true;
                console.log(`Removed invalid legacy meal plan for ${dateStr}: "${title}"`);
            }
        }

        // Clean up empty days
        if (Object.keys(dayData).length === 0 ||
            (Object.keys(dayData).length === 1 && dayData.status)) {
            delete mealPlans[dateStr];
            cleaned = true;
        }
    });

    if (cleaned) {
        setStorage(STORAGE.MEAL_PLANS, mealPlans);
        console.log('Cleaned up invalid meal plan entries');
    }
}

function cleanupBadWorkouts() {
    const workouts = getStorage(STORAGE.WORKOUTS) || [];
    const cleanedWorkouts = workouts.filter(w => {
        // Remove workouts with undefined type or invalid data
        const isValid = w.type && w.type !== 'undefined' && w.duration > 0;
        if (!isValid) {
            console.log('Removed invalid workout:', w);
        }
        return isValid;
    });

    if (cleanedWorkouts.length !== workouts.length) {
        setStorage(STORAGE.WORKOUTS, cleanedWorkouts);
        console.log(`Cleaned up ${workouts.length - cleanedWorkouts.length} invalid workouts`);
    }
}

async function checkOnboarding() {
    // First check Firestore if user is authenticated
    const user = firebase.auth().currentUser;
    if (user) {
        try {
            const doc = await firebase.firestore().collection('users').doc(user.uid).get();
            if (doc.exists && doc.data().hasCompletedOnboarding) {
                return; // Already completed, don't show
            }
        } catch (e) {
            console.log('Firestore onboarding check failed, falling back to localStorage');
        }
    }
    // Fallback to localStorage
    const done = getStorage(STORAGE.ONBOARDING);
    if (!done) {
        setTimeout(() => startOnboarding(), 500);
    }
}

// ========================================
// STORAGE HELPERS
// ========================================
function getStorage(key) {
    try {
        const data = localStorage.getItem(key);
        return data ? JSON.parse(data) : null;
    } catch (e) {
        console.error('Storage read error:', e);
        return null;
    }
}

function setStorage(key, value) {
    try {
        localStorage.setItem(key, JSON.stringify(value));
        // Trigger cloud sync for important data
        if ([STORAGE.RECIPES, STORAGE.MEAL_PLANS, STORAGE.PANTRY, STORAGE.SHOPPING, STORAGE.WORKOUTS, STORAGE.PROFILE].includes(key)) {
            debouncedSync();
        }
        return true;
    } catch (e) {
        console.error('Storage write error:', e);
        return false;
    }
}

// ========================================
// VIEW MANAGEMENT
// ========================================
function showWelcome() {
    document.getElementById('welcome-screen').style.display = 'flex';
    document.getElementById('intake-form').classList.remove('active');
    document.getElementById('app-main').classList.remove('active');
    document.getElementById('app-header').classList.add('hidden');
    document.getElementById('bottom-nav').classList.add('hidden');
}

function showIntakeForm() {
    document.getElementById('welcome-screen').style.display = 'none';
    document.getElementById('intake-form').classList.add('active');
    document.getElementById('app-main').classList.remove('active');
}

function showApp() {
    document.getElementById('welcome-screen').style.display = 'none';
    document.getElementById('intake-form').classList.remove('active');
    document.getElementById('app-main').classList.add('active');
    document.getElementById('app-header').classList.remove('hidden');
    document.getElementById('bottom-nav').classList.remove('hidden');
    navigateTo('home');
}

function navigateTo(view) {
    state.currentView = view;

    // Update views
    document.querySelectorAll('#app-main > .container > .view').forEach(v => v.classList.remove('active'));
    const targetView = document.getElementById(`view-${view}`);
    if (targetView) targetView.classList.add('active');

    // Update bottom nav (legacy data-view)
    document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
    const navItem = document.querySelector(`.nav-item[data-view="${view}"]`);
    if (navItem) navItem.classList.add('active');

    // Update hybrid nav active states (data-nav groups)
    updateHybridNavActive(view);

    // Show More menu if going to more
    if (view === 'more') showMoreMenu();

    // Load view-specific data
    if (view === 'home') updateDashboard();
    if (view === 'favorites') renderFavorites();
    if (view === 'week') renderWeekPlanner();
    if (view === 'recipes') {
        if (state.currentRecipesTab === 'family') renderFamilyRecipes();
        else renderRecipeLibrary();
    }
    if (view === 'workouts') renderWorkoutsView();
    if (view === 'nonna') {
        renderNonnaView();
    }

    // Refresh Lucide icons after view change
    refreshIcons();
}

// ========================================
// HYBRID NAVIGATION HELPERS
// ========================================

// Map views to their parent nav group
const viewToNavGroup = {
    home: 'home',
    recipes: 'cooking',
    favorites: 'cooking',
    cooking: 'cooking',
    week: 'plan',
    plan: 'plan',
    more: 'plan', // history, batch go through more
    pantry: 'pantry',
    nonna: 'nonna',
    workouts: 'workouts'
};

function updateHybridNavActive(view) {
    const group = viewToNavGroup[view] || null;

    // Mobile bottom nav: highlight the nav-item whose data-nav matches the group
    document.querySelectorAll('.bottom-nav .nav-item').forEach(n => n.classList.remove('active'));
    if (group) {
        const mobileBtn = document.querySelector(`.bottom-nav .nav-item[data-nav="${group}"]`);
        if (mobileBtn) mobileBtn.classList.add('active');
    }

    // Desktop top nav: highlight the desktop-nav-btn whose data-nav matches the group
    document.querySelectorAll('.desktop-nav-btn').forEach(n => n.classList.remove('active'));
    if (group) {
        const desktopBtn = document.querySelector(`.desktop-nav-btn[data-nav="${group}"]`);
        if (desktopBtn) desktopBtn.classList.add('active');
    }
}

function closeAllDropdowns() {
    document.querySelectorAll('.nav-dropdown-menu').forEach(m => m.classList.remove('open'));
    document.querySelectorAll('.desktop-nav-btn').forEach(b => b.classList.remove('open'));
}

function toggleMobileDropdown(menuId, triggerBtn) {
    const menu = document.getElementById(menuId);
    const isOpen = menu.classList.contains('open');
    closeAllDropdowns();
    if (!isOpen) {
        menu.classList.add('open');
        refreshIcons();
    }
}

// Dropdown hover state management
let dropdownTimeouts = {};

function showDesktopDropdown(menuId) {
    // Clear any pending hide timeout for this dropdown
    if (dropdownTimeouts[menuId]) {
        clearTimeout(dropdownTimeouts[menuId]);
        delete dropdownTimeouts[menuId];
    }

    const menu = document.getElementById(menuId);
    const btn = menu?.parentElement.querySelector('.desktop-nav-btn');

    if (menu && !menu.classList.contains('open')) {
        closeAllDropdowns();
        menu.classList.add('open');
        if (btn) btn.classList.add('open');
        refreshIcons();
    }
}

function hideDesktopDropdown(menuId, delay = 300) {
    // Set timeout to hide dropdown after delay
    dropdownTimeouts[menuId] = setTimeout(() => {
        const menu = document.getElementById(menuId);
        const btn = menu?.parentElement.querySelector('.desktop-nav-btn');

        if (menu) {
            menu.classList.remove('open');
            if (btn) btn.classList.remove('open');
        }
        delete dropdownTimeouts[menuId];
    }, delay);
}

function toggleDesktopDropdown(menuId) {
    const menu = document.getElementById(menuId);
    const isOpen = menu?.classList.contains('open');

    if (isOpen) {
        hideDesktopDropdown(menuId, 0); // Hide immediately on click
    } else {
        showDesktopDropdown(menuId);
    }
}

// Unified navigation action for dropdown items
function navAction(action) {
    closeAllDropdowns();
    switch (action) {
        case 'chat':
            navigateTo('nonna');
            break;
        case 'recipes':
            navigateTo('recipes');
            break;
        case 'favorites':
            navigateTo('favorites');
            break;
        case 'family':
            navigateTo('recipes');
            switchRecipesTab('family');
            break;
        case 'week':
            navigateTo('week');
            break;
        case 'history':
            navigateTo('more');
            switchMoreTab('history');
            break;
        case 'batch':
            navigateTo('more');
            switchMoreTab('kitchen');
            setTimeout(() => switchKitchenTab('batch'), 100);
            break;
        case 'pantry':
            navigateTo('more');
            switchMoreTab('kitchen');
            break;
        case 'shopping':
            navigateTo('more');
            switchMoreTab('kitchen');
            setTimeout(() => switchKitchenTab('shopping'), 100);
            break;
        case 'garden':
            navigateTo('more');
            switchMoreTab('garden');
            break;
        case 'crohns':
            navigateTo('more');
            switchMoreTab('crohns');
            break;
        case 'workouts':
            navigateTo('workouts');
            break;
        case 'import-recipe':
            openImportRecipeModal();
            break;
        case 'leftovers':
            openLeftoverTransformer();
            break;
        case 'collections':
            navigateTo('more');
            switchMoreTab('kitchen');
            setTimeout(() => switchKitchenTab('collections'), 100);
            break;
    }
}

// Close dropdowns on outside click
document.addEventListener('click', function(e) {
    if (!e.target.closest('.nav-group') && !e.target.closest('.desktop-nav-group')) {
        closeAllDropdowns();
    }
});

// Desktop: hover to open dropdowns
document.addEventListener('DOMContentLoaded', function() {
    document.querySelectorAll('.desktop-nav-group').forEach(group => {
        const btn = group.querySelector('.desktop-nav-btn');
        const menu = group.querySelector('.nav-dropdown-menu');
        if (!menu) return; // no dropdown for direct nav items

        group.addEventListener('mouseenter', function() {
            if (window.innerWidth >= 768) {
                closeAllDropdowns();
                menu.classList.add('open');
                if (btn) btn.classList.add('open');
                refreshIcons();
            }
        });
        group.addEventListener('mouseleave', function() {
            if (window.innerWidth >= 768) {
                menu.classList.remove('open');
                if (btn) btn.classList.remove('open');
            }
        });
    });
});

function showMoreMenu() {
    document.getElementById('more-menu-main').classList.remove('hidden');
    document.getElementById('more-kitchen').classList.add('hidden');
    document.getElementById('more-garden').classList.add('hidden');
    document.getElementById('more-crohns').classList.add('hidden');
    document.getElementById('more-history').classList.add('hidden');
    document.getElementById('more-settings').classList.add('hidden');
    document.getElementById('more-about').classList.add('hidden');
}

function switchMoreTab(tab) {
    document.getElementById('more-menu-main').classList.add('hidden');
    document.querySelectorAll('[id^="more-"]').forEach(el => el.classList.add('hidden'));
    document.getElementById(`more-${tab}`).classList.remove('hidden');

    // Load data
    if (tab === 'kitchen') renderPantry();
    if (tab === 'garden') renderGarden();
    if (tab === 'history') renderHistory();
    if (tab === 'crohns') updateFlareUI();
}

// ========================================
// DASHBOARD
// ========================================
function updateDashboard() {
    const favorites = getStorage(STORAGE.FAVORITES) || [];
    const recipes = getStorage(STORAGE.RECIPES) || [];
    const mealPlans = getStorage(STORAGE.MEAL_PLANS) || {};
    const profile = getStorage(STORAGE.PROFILE);

    // Count planned meals this week
    const weekDates = getWeekDates(0);
    let plannedCount = 0;
    weekDates.forEach(d => {
        if (mealPlans[d]) plannedCount++;
    });

    document.getElementById('stat-meals-planned').textContent = `${plannedCount}/7`;
    document.getElementById('stat-favorites').textContent = favorites.length;
    document.getElementById('stat-recipes').textContent = recipes.length;

    // Garden stat
    if (profile && profile.currentlyGrowing) {
        const plants = profile.currentlyGrowing.split(',').filter(p => p.trim());
        document.getElementById('stat-garden').textContent = plants.length > 0 ? `${plants.length} plants` : '-';
    }

    // Recent activity
    updateRecentActivity();

    // Update workout dashboard card
    updateDashboardWorkoutCard();

    // Update seasonal produce card
    if (typeof updateSeasonalCard === 'function') updateSeasonalCard();

    // Flare mode indicator
    const flareBanner = document.getElementById('home-flare-banner');
    if (state.flareMode) {
        flareBanner.classList.remove('hidden');
    } else {
        flareBanner.classList.add('hidden');
    }

    // Update home subhead dynamically
    const pantry = getStorage(STORAGE.PANTRY) || [];
    const percentPlanned = Math.round((plannedCount / 7) * 100);
    const subhead = document.getElementById('home-subhead');
    if (subhead) {
        subhead.textContent = `Your pantry has ${pantry.length} items â€¢ ${recipes.length} recipes ready â€¢ This week ${percentPlanned}% planned`;
    }
}

function updateDashboardWorkoutCard() {
    const caloriesIn = getTodaysCaloriesIn();
    const caloriesOut = getTodaysCaloriesOut();
    const netCalories = caloriesIn - caloriesOut;
    const todaysWorkouts = getTodaysWorkouts();

    document.getElementById('dashboard-calories-in').textContent = caloriesIn;
    document.getElementById('dashboard-calories-out').textContent = caloriesOut;
    document.getElementById('dashboard-calorie-net').textContent = `${netCalories > 0 ? '+' : ''}${netCalories}`;
    document.getElementById('dashboard-workouts-today').textContent = todaysWorkouts.length;

    // Update net balance color
    const netEl = document.getElementById('dashboard-calorie-net');
    if (netCalories > 200) {
        netEl.style.color = 'var(--danger)';
    } else if (netCalories < -200) {
        netEl.style.color = 'var(--success)';
    } else {
        netEl.style.color = 'var(--cerulean)';
    }
}

function updateRecentActivity() {
    const history = getStorage(STORAGE.HISTORY) || [];
    const container = document.getElementById('recent-activity');

    if (history.length === 0) {
        container.innerHTML = '<div class="empty-state" style="padding: 24px;"><p class="text-muted">No recent activity. Start chatting with Nonna!</p></div>';
        return;
    }

    const recent = history.slice(0, 3);
    container.innerHTML = recent.map(item => `
        <div class="activity-item">
            <span class="activity-icon">${item.type === 'cooked' ? icon('utensils',14) : icon('message-circle',14)}</span>
            <div class="activity-content">
                <div class="activity-title">${item.title}</div>
                <div class="activity-time">${formatRelativeDate(item.date)}</div>
            </div>
        </div>
    `).join('');
}

function setDailyTip() {
    const dayOfYear = Math.floor((new Date() - new Date(new Date().getFullYear(), 0, 0)) / 86400000);
    const tip = NONNA_TIPS[dayOfYear % NONNA_TIPS.length];
    document.getElementById('nonna-tip-text').textContent = `"${tip}"`;
}

// ========================================
// PROFILE MANAGEMENT
// ========================================
function toggleCookingForTwo() {
    const toggle = document.getElementById('cookingForTwoToggle');
    const fields = document.getElementById('cookingForTwoFields');
    fields.classList.toggle('hidden', !toggle.checked);
}

function toggleConditionDetails(conditionId) {
    const detailsEl = document.getElementById(`${conditionId}-details`);
    if (!detailsEl) return;

    // Find the checkbox that controls this
    const checkboxMap = {
        'crohns': 'crohns',
        'uc': 'uc',
        'ibs': 'ibs',
        'cholesterol': 'highCholesterol',
        'bp': 'highBP',
        'diabetes': 'diabetes',
        'kidney': 'kidney',
        'fibro': 'fibromyalgia',
        'thyroid': 'hashimotos'
    };

    const checkboxValue = checkboxMap[conditionId];
    const checkbox = document.querySelector(`[name="conditions"][value="${checkboxValue}"]`);

    if (checkbox) {
        detailsEl.classList.toggle('hidden', !checkbox.checked);
    }
}

function saveProfile(e) {
    e.preventDefault();
    const form = e.target;

    const profile = {
        // Health conditions (checkboxes)
        conditions: Array.from(form.querySelectorAll('[name="conditions"]:checked')).map(c => c.value),

        // Condition-specific details
        crohnsSeverity: form.crohnsSeverity?.value || '',
        crohnsTriggers: form.crohnsTriggers?.value || '',
        ucSeverity: form.ucSeverity?.value || '',
        ibsType: form.ibsType?.value || '',
        cholesterolGoal: form.cholesterolGoal?.value || '',
        sodiumRestriction: form.sodiumRestriction?.value || '',
        carbManagement: form.carbManagement?.value || '',
        kidneyRestrictions: Array.from(form.querySelectorAll('[name="kidneyRestrictions"]:checked')).map(c => c.value),
        fibroEnergy: form.fibroEnergy?.value || '',
        thyroidType: form.thyroidType?.value || '',

        // Food allergies
        foodAllergies: form.foodAllergies?.value || '',

        // Dietary goals
        dietaryGoals: Array.from(form.querySelectorAll('[name="dietaryGoals"]:checked')).map(c => c.value),

        // Other notes
        otherConditions: form.otherConditions?.value || '',

        // Cooking for two
        cookingForTwo: form.cookingForTwo?.checked || false,
        partnerName: form.partnerName?.value || '',
        partnerRestrictions: Array.from(form.querySelectorAll('[name="partnerRestrictions"]:checked')).map(c => c.value),
        partnerAllergies: form.partnerAllergies?.value || '',
        partnerLoves: form.partnerLoves?.value || '',

        // Proteins
        proteins: Array.from(form.querySelectorAll('[name="proteins"]:checked')).map(c => c.value),

        // Garden
        currentlyGrowing: form.currentlyGrowing?.value || '',
        growingZone: form.growingZone?.value || '',
        currentSeason: form.currentSeason?.value || '',

        // Cooking preferences
        energyLevel: form.energyLevel?.value || '',
        cookingTime: form.cookingTime?.value || '',
        weeklyBudget: form.weeklyBudget?.value || '',
        shoppingPriority: form.shoppingPriority?.value || '',
        foodsToAvoid: form.foodsToAvoid?.value || '',
        favoriteFlavors: form.favoriteFlavors?.value || '',

        createdAt: new Date().toISOString()
    };

    setStorage(STORAGE.PROFILE, profile);
    showApp();
}

function editProfile() {
    const profile = getStorage(STORAGE.PROFILE);
    showIntakeForm();

    if (profile) {
        setTimeout(() => {
            const form = document.getElementById('profile-form');

            // Restore simple fields
            const simpleFields = ['crohnsSeverity', 'crohnsTriggers', 'ucSeverity', 'ibsType',
                'cholesterolGoal', 'sodiumRestriction', 'carbManagement', 'fibroEnergy',
                'thyroidType', 'foodAllergies', 'otherConditions', 'partnerName',
                'partnerAllergies', 'partnerLoves', 'currentlyGrowing', 'growingZone',
                'currentSeason', 'energyLevel', 'cookingTime', 'weeklyBudget',
                'shoppingPriority', 'foodsToAvoid', 'favoriteFlavors'];

            simpleFields.forEach(key => {
                const el = form.querySelector(`[name="${key}"]`);
                if (el && profile[key]) el.value = profile[key];
            });

            // Restore cookingForTwo toggle
            if (profile.cookingForTwo) {
                const toggle = form.querySelector('[name="cookingForTwo"]');
                if (toggle) {
                    toggle.checked = true;
                    toggleCookingForTwo();
                }
            }

            // Restore condition checkboxes and show details
            if (profile.conditions) {
                profile.conditions.forEach(c => {
                    const cb = form.querySelector(`[name="conditions"][value="${c}"]`);
                    if (cb) {
                        cb.checked = true;
                        // Trigger details show
                        const detailsMap = {
                            'crohns': 'crohns', 'uc': 'uc', 'ibs': 'ibs',
                            'highCholesterol': 'cholesterol', 'highBP': 'bp',
                            'diabetes': 'diabetes', 'kidney': 'kidney',
                            'fibromyalgia': 'fibro', 'hashimotos': 'thyroid'
                        };
                        if (detailsMap[c]) toggleConditionDetails(detailsMap[c]);
                    }
                });
            }

            // Restore dietary goals
            if (profile.dietaryGoals) {
                profile.dietaryGoals.forEach(g => {
                    const cb = form.querySelector(`[name="dietaryGoals"][value="${g}"]`);
                    if (cb) cb.checked = true;
                });
            }

            // Restore proteins
            if (profile.proteins) {
                profile.proteins.forEach(p => {
                    const cb = form.querySelector(`[name="proteins"][value="${p}"]`);
                    if (cb) cb.checked = true;
                });
            }

            // Restore partner restrictions
            if (profile.partnerRestrictions) {
                profile.partnerRestrictions.forEach(r => {
                    const cb = form.querySelector(`[name="partnerRestrictions"][value="${r}"]`);
                    if (cb) cb.checked = true;
                });
            }

            // Restore kidney restrictions
            if (profile.kidneyRestrictions) {
                profile.kidneyRestrictions.forEach(r => {
                    const cb = form.querySelector(`[name="kidneyRestrictions"][value="${r}"]`);
                    if (cb) cb.checked = true;
                });
            }
        }, 100);
    }
}

function loadPreferences() {
    const prefs = getStorage(STORAGE.PREFS) || {};
    if (prefs.darkMode) {
        document.body.classList.add('dark-mode');
        const toggle = document.getElementById('dark-mode-toggle');
        if (toggle) toggle.checked = true;
    }
    state.flareMode = prefs.flareMode || false;
}

function toggleDarkMode() {
    const toggle = document.getElementById('dark-mode-toggle');
    document.body.classList.toggle('dark-mode', toggle.checked);
    const prefs = getStorage(STORAGE.PREFS) || {};
    prefs.darkMode = toggle.checked;
    setStorage(STORAGE.PREFS, prefs);
}

// ========================================
// CHAT FUNCTIONALITY
// ========================================
function initChatInput() {
    const input = document.getElementById('chat-input');
    if (!input) return;
    input.addEventListener('keydown', (e) => {
        if (e.key === 'Tab') {
            e.preventDefault();
            const start = input.selectionStart;
            const end = input.selectionEnd;
            const value = input.value;
            input.value = value.substring(0, start) + 'â€¢ ' + value.substring(end);
            input.selectionStart = input.selectionEnd = start + 2;
            input.dispatchEvent(new Event('input'));
        } else if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            sendMessage();
        }
        // Shift+Enter: default behavior (newline)
    });
    input.addEventListener('input', () => {
        input.style.height = 'auto';
        input.style.height = Math.min(input.scrollHeight, 120) + 'px';
    });
}

function loadChatHistory() {
    state.chatHistory = getStorage(STORAGE.CHAT) || [];
    if (!state.currentConversationId) {
        state.currentConversationId = 'conv_' + Date.now();
    }
    renderChatHistory();
}

function saveChatHistory() {
    setStorage(STORAGE.CHAT, state.chatHistory);
}

function addWelcomeMessage() {
    const profile = getStorage(STORAGE.PROFILE);
    let text = "Ciao, cara! I'm Nonna, your Mediterranean cooking companion. ";
    if (profile) {
        text += "I've looked at your profile and I'm ready to help you plan delicious, gentle meals. ";
    }
    text += "What would you like to cook today?";

    const msg = { role: 'assistant', content: text, timestamp: new Date().toISOString() };
    state.chatHistory.push(msg);
    saveChatHistory();
    renderMessage(msg, true);
    renderQuickActions();
}

function renderChatHistory() {
    const container = document.getElementById('chat-messages');
    if (!container) return;
    container.innerHTML = '';
    state.chatHistory.forEach(msg => renderMessage(msg, false));
    if (state.chatHistory.length <= 1) renderQuickActions();
}

function renderMessage(message, animate = true) {
    const container = document.getElementById('chat-messages');
    if (!container) return;

    const div = document.createElement('div');
    div.className = `message message-${message.role}`;
    if (!animate) div.style.animation = 'none';

    const bubble = document.createElement('div');
    bubble.className = 'message-bubble';

    // Check for recipe or weekly plan
    let isRecipeCard = false;
    if (message.role === 'assistant') {
        if (message.content.includes('=== RECIPE:') || message.content.includes('RECIPE:')) {
            bubble.innerHTML = parseRecipeToCard(message.content);
            isRecipeCard = true;
        } else if (message.content.includes('Your Week is Planned') || message.content.includes('WEEKLY MEAL PLAN')) {
            bubble.innerHTML = parseWeekPlanToCard(message.content);
        } else {
            bubble.innerHTML = formatMessageContent(message.content);
        }

        // Add inline action buttons for assistant messages
        if (!isRecipeCard) {
            const msgIdx = state.chatHistory.indexOf(message);
            const actions = parseInlineActions(message.content, msgIdx >= 0 ? msgIdx : state.chatHistory.length - 1);
            if (actions.length > 0) {
                const actionsHtml = actions.map(a =>
                    `<button class="chat-action-btn" onclick="${a.action}">${icon(a.icon, 14)} ${a.label}</button>`
                ).join('');
                bubble.innerHTML += `<div class="chat-inline-actions">${actionsHtml}</div>`;
            }
        }

        // Collapsible long responses (not for recipe cards or week plans)
        if (!isRecipeCard && !message.content.includes('WEEKLY MEAL PLAN') && bubble.textContent.length > 500) {
            const fullHtml = bubble.innerHTML;
            const previewText = bubble.textContent.substring(0, 200);
            bubble.innerHTML = `
                <div class="message-preview">${formatMessageContent(previewText)}...</div>
                <div class="message-full" style="display:none">${fullHtml}</div>
                <button class="read-more-btn" onclick="toggleMessageExpand(this)">
                    ${icon('chevron-down', 14)} Read more
                </button>
            `;
        }
    } else {
        bubble.innerHTML = formatMessageContent(message.content);
    }

    div.appendChild(bubble);
    container.appendChild(div);
    refreshIcons();
    scrollToBottom();
}

function parseInlineActions(content, messageIndex) {
    const actions = [];
    const hasRecipeContent = /ingredients|instructions/i.test(content) && content.length > 300;
    const hasShoppingContent = /shopping list|buy|grocery|ingredients.*need/i.test(content);
    const hasMealPlan = /meal plan|weekly plan|monday.*tuesday|your week/i.test(content);

    if (hasRecipeContent && !hasShoppingContent) {
        actions.push({ label: 'Save Recipe', icon: 'bookmark', action: `saveRecipeFromChat(${messageIndex})` });
    }
    if (hasShoppingContent) {
        actions.push({ label: 'Add to Shopping List', icon: 'shopping-cart', action: `addChatToShopping(${messageIndex})` });
    }
    if (hasMealPlan) {
        actions.push({ label: 'View Meal Plan', icon: 'calendar-check', action: `navigateTo('home')` });
    }
    return actions;
}

function toggleMessageExpand(btn) {
    const bubble = btn.closest('.message-bubble');
    const preview = bubble.querySelector('.message-preview');
    const full = bubble.querySelector('.message-full');
    const isExpanded = full.style.display !== 'none';
    preview.style.display = isExpanded ? 'block' : 'none';
    full.style.display = isExpanded ? 'none' : 'block';
    btn.innerHTML = isExpanded
        ? `${icon('chevron-down', 14)} Read more`
        : `${icon('chevron-up', 14)} Show less`;
    refreshIcons();
}

function saveRecipeFromChat(idx) {
    const msg = state.chatHistory[idx];
    if (!msg) return;
    // Attempt to parse as a recipe and save to library
    try {
        const card = parseRecipeToCard(msg.content);
        const titleMatch = msg.content.match(/(?:===\s*)?RECIPE:\s*(.+?)(?:\s*===|\n|$)/i);
        const title = titleMatch ? titleMatch[1].trim() : 'Chat Recipe';
        showToast('success', `Saved "${title}" to your recipe library!`);
    } catch (e) {
        askNonna('Can you format that as a full recipe with RECIPE: title, INGREDIENTS, and INSTRUCTIONS sections?');
    }
}

function addChatToShopping(idx) {
    const msg = state.chatHistory[idx];
    if (!msg) return;
    // Extract items that look like shopping items
    const lines = msg.content.split('\n').filter(l => l.trim().startsWith('-'));
    if (lines.length > 0) {
        const items = lines.map(l => l.replace(/^-\s*/, '').trim()).filter(Boolean);
        showToast('success', `Added ${items.length} items to shopping list!`);
    } else {
        showToast('info', 'Could not find list items. Try asking Nonna for a formatted shopping list.');
    }
}

function formatMessageContent(content) {
    return content
        .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
        .replace(/^### (.*$)/gm, '<h3 style="color: var(--cerulean); margin: 12px 0 8px;">$1</h3>')
        .replace(/^## (.*$)/gm, '<h2 style="color: var(--cerulean); margin: 16px 0 8px;">$1</h2>')
        .replace(/^- (.*$)/gm, '<li>$1</li>')
        .replace(/^(\d+)\. (.*$)/gm, '<li>$2</li>')
        .replace(/â˜ (.*$)/gm, '<span style="display: block;">â˜ $1</span>')
        .replace(/\n\n/g, '</p><p>')
        .replace(/\n/g, '<br>');
}

function parseRecipeToCard(content) {
    // Extract recipe components
    const titleMatch = content.match(/(?:===\s*)?RECIPE:\s*(.+?)(?:\s*===|\n|$)/i);
    const servesMatch = content.match(/Serves:\s*(\d+)/i);
    const timeMatch = content.match(/Total(?:\s*Time)?:\s*(\d+)\s*min/i);
    const prepMatch = content.match(/Prep:\s*(\d+)\s*min/i);
    const cookMatch = content.match(/Cook:\s*(\d+)\s*min/i);

    // Extract tags from content
    const tagsMatch = content.match(/\*?\*?TAGS\*?\*?:?\s*(.+?)(?:\n|$)/i);
    const rawTags = tagsMatch ? tagsMatch[1].split(/[,;]/).map(t => t.trim()).filter(t => t) : [];

    // Extract nutrition
    const nutritionMatch = content.match(/\*?\*?NUTRITION[^:]*\*?\*?:?([\s\S]*?)(?=\*?\*?INGREDIENTS|$)/i);
    const nutrition = parseNutrition(nutritionMatch ? nutritionMatch[1] : '');

    // Extract health benefits
    const healthMatch = content.match(/\*?\*?WHY THIS HELPS[^:]*\*?\*?:?([\s\S]*?)(?=\*?\*?MODIFICATIONS|FLARE|GARDEN|---|$)/i);
    const healthBenefits = healthMatch ? healthMatch[1].trim() : '';

    // Extract ingredients
    const ingredientsMatch = content.match(/\*?\*?INGREDIENTS\*?\*?:?([\s\S]*?)(?=\*?\*?INSTRUCTIONS|$)/i);
    const ingredients = ingredientsMatch ?
        ingredientsMatch[1].trim().split('\n').filter(l => l.trim().startsWith('-')).map(l => l.replace(/^-\s*/, '').trim()) : [];

    // Extract instructions
    const instructionsMatch = content.match(/\*?\*?INSTRUCTIONS\*?\*?:?([\s\S]*?)(?=\*?\*?WHY THIS|FLARE|GARDEN|STORAGE|MODIFICATIONS|CROHN|---|$)/i);
    const instructions = instructionsMatch ?
        instructionsMatch[1].trim().split('\n').filter(l => /^\d+\./.test(l.trim())).map(l => l.replace(/^\d+\.\s*/, '').trim()) : [];

    // Extract modifications (combined flare mods and other modifications)
    const modsMatch = content.match(/\*?\*?(?:FLARE\s*)?MODIFICATIONS?\*?\*?:?([\s\S]*?)(?=\*?\*?GARDEN|STORAGE|---|$)/i);
    const modifications = modsMatch ? modsMatch[1].trim() : '';

    const title = titleMatch ? titleMatch[1].trim().replace(/===\s*$/, '').trim() : 'Recipe';
    const serves = servesMatch ? servesMatch[1] : '2';
    const totalTime = timeMatch ? timeMatch[1] : '30';
    const prepTime = prepMatch ? prepMatch[1] : '10';
    const cookTime = cookMatch ? cookMatch[1] : '20';

    // Generate unique ID
    const recipeId = 'recipe_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);

    // Determine protein type
    const proteinTypes = { fish: /fish|cod|salmon|tilapia|shrimp|tuna|halibut/i, chicken: /chicken/i, pork: /pork/i, beef: /beef/i, vegetarian: /vegetarian|vegan|tofu|tempeh/i };
    let proteinType = 'other';
    for (const [type, regex] of Object.entries(proteinTypes)) {
        if (regex.test(content)) { proteinType = type; break; }
    }

    // Process tags - combine extracted tags with auto-detected ones
    const tags = processRecipeTags(rawTags, content, parseInt(totalTime), proteinType);

    // Store recipe data temporarily (NOT auto-saved to library)
    const recipeData = {
        id: recipeId,
        title: title,
        ingredients: ingredients,
        instructions: instructions,
        modifications: modifications,
        healthBenefits: healthBenefits,
        nutrition: nutrition,
        servings: parseInt(serves) || 4,
        tags: tags,
        metadata: {
            prepTime: parseInt(prepTime),
            cookTime: parseInt(cookTime),
            totalTime: parseInt(totalTime),
            serves: parseInt(serves),
            proteinType: proteinType,
            tags: tags
        },
        dateGenerated: new Date().toISOString(),
        timesCooked: 0,
        rating: 0,
        favorited: false,
        rawContent: content
    };
    // Store in temporary cache for explicit saving later
    window.pendingRecipes = window.pendingRecipes || {};
    window.pendingRecipes[recipeId] = recipeData;

    // Build tags HTML
    const tagsHtml = tags.map(tag => {
        const tagClass = getTagClass(tag);
        return `<span class="tag ${tagClass}">${tag}</span>`;
    }).join('');

    // Build nutrition HTML
    const nutritionHtml = nutrition.calories ? `
        <div class="nutrition-box">
            <div class="nutrition-item"><div class="nutrition-value">${nutrition.calories}</div><div class="nutrition-label">Calories</div></div>
            <div class="nutrition-item"><div class="nutrition-value">${nutrition.protein}g</div><div class="nutrition-label">Protein</div></div>
            <div class="nutrition-item"><div class="nutrition-value">${nutrition.carbs}g</div><div class="nutrition-label">Carbs</div></div>
            <div class="nutrition-item"><div class="nutrition-value">${nutrition.fat}g</div><div class="nutrition-label">Fat</div></div>
            <div class="nutrition-item"><div class="nutrition-value">${nutrition.fiber}g</div><div class="nutrition-label">Fiber</div></div>
            <div class="nutrition-item"><div class="nutrition-value">${nutrition.sodium}mg</div><div class="nutrition-label">Sodium</div></div>
        </div>
    ` : '';

    // Build health benefits HTML
    const healthHtml = healthBenefits ? `
        <div class="health-benefits">
            <div class="health-benefits-title">${icon('heart',14,'color:green')} Why This Helps Your Health</div>
            <div class="health-benefits-text">${healthBenefits.replace(/\n/g, '<br>')}</div>
        </div>
    ` : '';

    return `
        <div class="recipe-card" data-recipe-id="${recipeId}">
            <div class="recipe-header">
                <div class="recipe-title">${title}</div>
                <div class="recipe-actions">
                    <button class="recipe-action-btn ${recipeData.favorited ? 'favorited' : ''}" onclick="toggleFavoriteFromCard('${recipeId}', this)" title="Favorite">${icon('heart',14,'color:var(--accent-warm)')}</button>
                    <button class="recipe-action-btn" onclick="printRecipe('${recipeId}')" title="Print">${icon('printer',14)}</button>
                </div>
                <div class="recipe-meta">
                    <div class="recipe-meta-item">${icon('timer',14)} ${totalTime} min</div>
                    <div class="recipe-meta-item">${icon('utensils',14)} Serves ${serves}</div>
                    ${nutrition.calories ? `<div class="recipe-meta-item">${icon('flame',14)} ${nutrition.calories} cal</div>` : ''}
                </div>
            </div>
            <div class="recipe-tags">
                ${tagsHtml || '<span class="tag tag-mediterranean">Mediterranean</span>'}
            </div>
            ${nutritionHtml}
            ${healthHtml}
            <div class="recipe-body">
                <div class="recipe-section">
                    <div class="recipe-section-title">${icon('file-text',14)} Ingredients</div>
                    ${ingredients.map((ing, i) => `
                        <div class="ingredient-item">
                            <input type="checkbox" class="ingredient-checkbox" id="ing_${recipeId}_${i}" onchange="toggleIngredient(this)">
                            <label class="ingredient-text" for="ing_${recipeId}_${i}">${ing}</label>
                        </div>
                    `).join('')}
                </div>
                <div class="recipe-section">
                    <div class="recipe-section-title">${icon('chef-hat',14)} Instructions</div>
                    ${instructions.map((step, i) => `
                        <div class="instruction-step">
                            <div class="step-number">${i + 1}</div>
                            <div>${step}</div>
                        </div>
                    `).join('')}
                </div>
                ${modifications ? `
                    <div class="recipe-notes">
                        <div class="recipe-notes-title">${icon('refresh-cw',14)} Modifications</div>
                        <p>${modifications.replace(/\n/g, '<br>').replace(/^-\s*/gm, 'â€¢ ')}</p>
                    </div>
                ` : ''}
                ${renderWinePairingSection({ title: title, ingredients: ingredients, tags: tags })}
            </div>
            <div class="recipe-card-actions">
                <button class="btn btn-primary btn-sm" onclick="saveRecipeFromChat('${recipeId}')" id="save-btn-${recipeId}">${icon('save',14)} Save Recipe</button>
                <button class="btn btn-secondary btn-sm" onclick="favoriteRecipeFromChat('${recipeId}')">${icon('heart',14)} Favorite</button>
                <button class="btn btn-secondary btn-sm" onclick="addToWeekFromChat('${recipeId}')">${icon('calendar',14)} Add to Week</button>
                <button class="btn btn-ghost btn-sm" onclick="shareRecipe('${recipeId}')">${icon('share-2',14)} Share</button>
            </div>
        </div>
    `;
}

function parseNutrition(text) {
    const nutrition = { calories: '', protein: '', carbs: '', fat: '', fiber: '', sodium: '' };
    if (!text) return nutrition;

    const caloriesMatch = text.match(/Calories?[:\s]*~?(\d+)/i);
    const proteinMatch = text.match(/Protein[:\s]*(\d+)/i);
    const carbsMatch = text.match(/Carbs?[:\s]*(\d+)/i);
    const fatMatch = text.match(/Fat[:\s]*(\d+)/i);
    const fiberMatch = text.match(/Fiber[:\s]*(\d+)/i);
    const sodiumMatch = text.match(/Sodium[:\s]*(\d+)/i);

    if (caloriesMatch) nutrition.calories = caloriesMatch[1];
    if (proteinMatch) nutrition.protein = proteinMatch[1];
    if (carbsMatch) nutrition.carbs = carbsMatch[1];
    if (fatMatch) nutrition.fat = fatMatch[1];
    if (fiberMatch) nutrition.fiber = fiberMatch[1];
    if (sodiumMatch) nutrition.sodium = sodiumMatch[1];

    return nutrition;
}

function processRecipeTags(rawTags, content, totalTime, proteinType) {
    const tags = new Set();

    // Add raw tags from content
    rawTags.forEach(tag => tags.add(tag));

    // Auto-detect tags based on content
    if (totalTime <= 30) tags.add('Quick');
    if (/mediterranean/i.test(content)) tags.add('Mediterranean');
    if (/anti.?inflammatory/i.test(content)) tags.add('Anti-Inflammatory');
    if (/crohn|ibd|digestive/i.test(content)) tags.add("Crohn's-Friendly");
    if (/heart.?healthy|cardiovascular/i.test(content)) tags.add('Heart-Healthy');
    if (/low.?sodium/i.test(content)) tags.add('Low-Sodium');
    if (/low.?carb|keto/i.test(content)) tags.add('Low-Carb');
    if (/diabetic|blood.?sugar/i.test(content)) tags.add('Diabetic-Friendly');
    if (/gluten.?free/i.test(content)) tags.add('Gluten-Free');
    if (/high.?protein/i.test(content)) tags.add('High-Protein');
    if (/one.?pot|sheet.?pan/i.test(content)) tags.add('One-Pot');
    if (/meal.?prep|batch/i.test(content)) tags.add('Meal Prep');
    if (/freezer/i.test(content)) tags.add('Freezer-Friendly');

    // Protein-based tags
    if (proteinType === 'fish') tags.add('Fish');
    if (proteinType === 'chicken') tags.add('Chicken');
    if (proteinType === 'vegetarian') tags.add('Vegetarian');

    // Ensure at least Mediterranean tag
    if (tags.size === 0 || (tags.size === 1 && tags.has('Quick'))) {
        tags.add('Mediterranean');
    }

    return Array.from(tags).slice(0, 6); // Limit to 6 tags
}

function getTagClass(tag) {
    const tagClasses = {
        "Crohn's-Friendly": 'tag-crohns',
        'Heart-Healthy': 'tag-heart',
        'BP-Friendly': 'tag-bp',
        'Diabetic-Friendly': 'tag-diabetic',
        'Anti-Inflammatory': 'tag-anti-inflammatory',
        'Low-Sodium': 'tag-low-sodium',
        'Low-Carb': 'tag-low-carb',
        'Gut-Friendly': 'tag-gut-friendly',
        'Gluten-Free': 'tag-gluten-free',
        'Quick': 'tag-quick',
        'Meal Prep': 'tag-meal-prep',
        'Freezer-Friendly': 'tag-freezer',
        'One-Pot': 'tag-one-pot',
        'Mediterranean': 'tag-mediterranean',
        'Citrus': 'tag-citrus',
        'Garlic': 'tag-garlic',
        'Spicy': 'tag-spicy',
        'Comfort': 'tag-comfort',
        'Fresh': 'tag-fresh',
        'Fish': 'tag-fish',
        'Chicken': 'tag-chicken',
        'Vegetarian': 'tag-vegetarian',
        'High-Protein': 'tag-high-protein'
    };
    return tagClasses[tag] || 'tag-mediterranean';
}

function parseWeekPlanToCard(content) {
    // Extract days and meals from the content (supports multi-meal format)
    const days = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'];
    const mealPlan = {};

    days.forEach(day => {
        mealPlan[day.toLowerCase()] = { breakfast: null, lunch: null, dinner: null, snacks: null };

        // Try to extract multi-meal format first
        // Pattern: **MONDAY** or MONDAY: followed by meal lines
        const daySection = content.match(new RegExp(`\\*?\\*?${day}\\*?\\*?[:\\s]*([\\s\\S]*?)(?=\\*?\\*?(?:${days.join('|')})|$)`, 'i'));

        if (daySection) {
            const section = daySection[1];

            // Extract individual meals with calorie info
            const breakfastMatch = section.match(/ðŸŒ…?\s*Breakfast[:\s]*([^(~\n]+)(?:\s*[~(]?\s*(\d+)\s*cal)?/i);
            const lunchMatch = section.match(/ðŸŒž?\s*Lunch[:\s]*([^(~\n]+)(?:\s*[~(]?\s*(\d+)\s*cal)?/i);
            const dinnerMatch = section.match(/ðŸŒ™?\s*Dinner[:\s]*([^(~\n]+)(?:\s*[~(]?\s*(\d+)\s*cal)?/i);
            const snacksMatch = section.match(/ðŸŽ?\s*Snacks?[:\s]*([^(~\n]+)(?:\s*[~(]?\s*(\d+)\s*cal)?/i);

            if (breakfastMatch) mealPlan[day.toLowerCase()].breakfast = { title: breakfastMatch[1].trim().replace(/[-*]+$/, '').trim(), calories: breakfastMatch[2] ? parseInt(breakfastMatch[2]) : null };
            if (lunchMatch) mealPlan[day.toLowerCase()].lunch = { title: lunchMatch[1].trim().replace(/[-*]+$/, '').trim(), calories: lunchMatch[2] ? parseInt(lunchMatch[2]) : null };
            if (dinnerMatch) mealPlan[day.toLowerCase()].dinner = { title: dinnerMatch[1].trim().replace(/[-*]+$/, '').trim(), calories: dinnerMatch[2] ? parseInt(dinnerMatch[2]) : null };
            if (snacksMatch) mealPlan[day.toLowerCase()].snacks = { title: snacksMatch[1].trim().replace(/[-*]+$/, '').trim(), calories: snacksMatch[2] ? parseInt(snacksMatch[2]) : null };

            // Fallback: if no specific meals found, treat first line as dinner
            if (!breakfastMatch && !lunchMatch && !dinnerMatch && !snacksMatch) {
                const simpleMeal = section.match(/^[-\s]*([^(\n]+)/);
                if (simpleMeal) {
                    const mealTitle = simpleMeal[1].replace(/^[-:*\s]+/, '').replace(/[-*]+$/, '').trim();
                    if (mealTitle && mealTitle.length > 2 && !/^\d+$/.test(mealTitle)) {
                        mealPlan[day.toLowerCase()].dinner = { title: mealTitle, calories: null };
                    }
                }
            }
        }
    });

    // Save to meal plans in new format
    const weekDates = getWeekDates(state.currentWeekOffset);
    const savedPlans = getStorage(STORAGE.MEAL_PLANS) || {};

    days.forEach((day, i) => {
        const dateStr = weekDates[i];
        const dayData = mealPlan[day.toLowerCase()];
        const hasMeals = dayData.breakfast || dayData.lunch || dayData.dinner || dayData.snacks;

        if (hasMeals) {
            savedPlans[dateStr] = {};
            if (dayData.breakfast) savedPlans[dateStr].breakfast = { ...dayData.breakfast, recipeId: null, status: 'planned' };
            if (dayData.lunch) savedPlans[dateStr].lunch = { ...dayData.lunch, recipeId: null, status: 'planned' };
            if (dayData.dinner) savedPlans[dateStr].dinner = { ...dayData.dinner, recipeId: null, status: 'planned' };
            if (dayData.snacks) savedPlans[dateStr].snacks = { ...dayData.snacks, recipeId: null, status: 'planned' };
        }
    });
    setStorage(STORAGE.MEAL_PLANS, savedPlans);

    // Build display card
    const planItems = days.map(day => {
        const d = mealPlan[day.toLowerCase()];
        const meals = [];
        if (d.breakfast) meals.push(`${icon('sunrise',14)} ${d.breakfast.title}`);
        if (d.lunch) meals.push(`${icon('sun',14)} ${d.lunch.title}`);
        if (d.dinner) meals.push(`${icon('moon',14)} ${d.dinner.title}`);
        if (d.snacks) meals.push(`${icon('apple',14)} ${d.snacks.title}`);
        return meals.length > 0 ? `<div class="week-plan-item"><span><strong>${day}</strong></span><span>${meals.join(' Â· ')}</span></div>` : '';
    }).filter(x => x).join('');

    return `
        <div class="week-plan-card">
            <h3>${icon('check-circle',14)} Your Week is Planned!</h3>
            ${planItems || '<p>No meals extracted - check the format above.</p>'}
            <div class="week-plan-actions">
                <button class="btn" onclick="navigateTo('week')">${icon('calendar',14)} View This Week</button>
                <button class="btn" onclick="generateWeekShoppingList()">${icon('shopping-cart',14)} Shopping List</button>
            </div>
        </div>
    `;
}

function toggleIngredient(checkbox) {
    const label = checkbox.nextElementSibling;
    label.classList.toggle('checked', checkbox.checked);
}

function getContextualPrompts() {
    const hour = new Date().getHours();
    const pantry = getStorage(STORAGE.PANTRY) || [];
    const history = getStorage(STORAGE.HISTORY) || [];
    const prompts = [];

    // Time-based prompt
    if (hour < 10) {
        prompts.push({ icon: 'sunrise', label: 'Breakfast Ideas', text: 'What should I make for breakfast?' });
    } else if (hour < 14) {
        prompts.push({ icon: 'sun', label: 'Lunch Ideas', text: 'Give me a quick lunch idea' });
    } else if (hour < 18) {
        prompts.push({ icon: 'sunset', label: 'Dinner Tonight', text: 'What should I make for dinner tonight?' });
    } else {
        prompts.push({ icon: 'moon', label: 'Light Snack', text: 'Suggest a light evening snack' });
    }

    // Always include Plan My Week
    prompts.push({ icon: 'calendar-days', label: 'Plan My Week', text: 'Plan my meals for this week' });

    // Pantry-aware
    if (pantry.length > 0) {
        prompts.push({ icon: 'package', label: 'Use My Pantry', text: "What can I make with what's in my pantry?" });
        prompts.push({ icon: 'clipboard', label: 'Plan Around Pantry', text: "Plan this week's meals using what I already have. Minimize new purchases." });
    } else {
        prompts.push({ icon: 'shopping-cart', label: 'What Should I Buy?', text: 'What should I buy at the store this week for healthy Mediterranean meals?' });
    }

    // Recent activity
    if (history.length > 3) {
        prompts.push({ icon: 'refresh-cw', label: 'Something New', text: "Suggest something different from what I've made recently" });
    }

    // Always available
    prompts.push({ icon: 'heart-pulse', label: 'Gentle Meal', text: "I need a gentle meal - not feeling great" });
    prompts.push({ icon: 'zap', label: 'Quick Dinner', text: 'Give me a quick, easy dinner idea' });

    return prompts.slice(0, 7);
}

function renderQuickActions() {
    const container = document.getElementById('chat-messages');
    if (!container) return;

    const existing = container.querySelector('.quick-actions');
    if (existing) existing.remove();

    const prompts = getContextualPrompts();
    const actions = document.createElement('div');
    actions.className = 'quick-actions';
    actions.innerHTML = prompts.map(p =>
        `<button class="quick-action" onclick="askNonna('${p.text.replace(/'/g, "\\'")}')">${icon(p.icon, 14)} ${p.label}</button>`
    ).join('');
    container.appendChild(actions);
    refreshIcons();
    scrollToBottom();
}

function scrollToBottom() {
    const container = document.getElementById('chat-messages');
    if (container) setTimeout(() => container.scrollTop = container.scrollHeight, 50);
}

function detectMessageContext(message) {
    const lower = message.toLowerCase();
    if (/meal plan|week|schedule|plan my/.test(lower)) return 'planning';
    if (/recipe|cook|make|bake|roast|grill|dinner|lunch|breakfast/.test(lower)) return 'recipe';
    if (/shop|buy|grocery|store|list/.test(lower)) return 'shopping';
    if (/health|gentle|flare|crohn|anti-inflam|symptom/.test(lower)) return 'health';
    if (/family|kid|children|husband|wife/.test(lower)) return 'family';
    if (/pantry|fridge|have on hand|leftover/.test(lower)) return 'pantry';
    return 'general';
}

function showThinking(context = 'general') {
    const container = document.getElementById('chat-messages');
    if (!container) return;

    const contextMessages = {
        planning: [
            { ico: 'calendar-days', text: 'Nonna is planning your week...' },
            { ico: 'clipboard-list', text: 'Balancing flavors across the week...' },
            { ico: 'calendar-check', text: 'Crafting a beautiful meal schedule...' }
        ],
        recipe: [
            { ico: 'chef-hat', text: 'Nonna is perfecting the recipe...' },
            { ico: 'soup', text: 'Simmering up something special...' },
            { ico: 'flame', text: 'Bringing the heat to this dish...' }
        ],
        shopping: [
            { ico: 'shopping-cart', text: 'Checking the market list...' },
            { ico: 'store', text: 'Finding the freshest ingredients...' }
        ],
        health: [
            { ico: 'heart-pulse', text: 'Preparing something gentle for you...' },
            { ico: 'leaf', text: 'Choosing healing ingredients...' }
        ],
        family: [
            { ico: 'users', text: 'Making something the whole family will love...' }
        ],
        pantry: [
            { ico: 'package', text: 'Checking what you have on hand...' },
            { ico: 'refrigerator', text: 'Rummaging through the pantry...' }
        ],
        general: [
            { ico: 'soup', text: 'Nonna is cooking up ideas...' },
            { ico: 'droplets', text: 'Drizzling olive oil on thoughts...' },
            { ico: 'citrus', text: 'Squeezing fresh inspiration...' },
            { ico: 'leaf', text: 'Chopping fresh ideas...' },
            { ico: 'book-open', text: 'Flipping through recipes...' }
        ]
    };
    const msgs = contextMessages[context] || contextMessages.general;
    const chosen = msgs[Math.floor(Math.random() * msgs.length)];

    const div = document.createElement('div');
    div.className = 'message message-assistant';
    div.id = 'thinking-message';
    div.innerHTML = `
        <div class="thinking">
            <div class="thinking-animation">${icon(chosen.ico, 20)}</div>
            <span class="thinking-text">${chosen.text}</span>
        </div>
    `;
    container.appendChild(div);
    refreshIcons();
    scrollToBottom();
}

function hideThinking() {
    const el = document.getElementById('thinking-message');
    if (el) el.remove();
}

function updateSendStopButton(isProcessing) {
    const btn = document.getElementById('send-btn');
    if (!btn) return;
    if (isProcessing) {
        btn.innerHTML = icon('square', 16);
        btn.onclick = stopGeneration;
        btn.disabled = false;
        btn.classList.add('stop-mode');
    } else {
        btn.innerHTML = icon('send-horizontal', 16);
        btn.onclick = sendMessage;
        btn.disabled = false;
        btn.classList.remove('stop-mode');
    }
    refreshIcons();
}

function stopGeneration() {
    if (state.abortController) {
        state.abortController.abort();
        state.abortController = null;
    }
    hideThinking();
    state.isProcessing = false;
    updateSendStopButton(false);
    const abortMsg = { role: 'assistant', content: 'Va bene, I stopped. What else can I help with, cara?', timestamp: new Date().toISOString() };
    state.chatHistory.push(abortMsg);
    saveChatHistory();
    renderMessage(abortMsg);
    updateConversationTopics();
}

async function sendMessage() {
    if (state.isProcessing) return;

    const input = document.getElementById('chat-input');
    const message = input.value.trim();
    if (!message) return;

    input.value = '';
    input.style.height = 'auto';

    // Remove quick actions
    document.querySelectorAll('.quick-actions').forEach(el => el.remove());

    // Add user message
    const userMsg = { role: 'user', content: message, timestamp: new Date().toISOString() };
    state.chatHistory.push(userMsg);
    saveChatHistory();
    renderMessage(userMsg);

    // Call API
    state.isProcessing = true;
    const context = detectMessageContext(message);
    updateSendStopButton(true);
    showThinking(context);

    try {
        const response = await callAPI(message);
        hideThinking();

        const assistantMsg = { role: 'assistant', content: response, timestamp: new Date().toISOString() };
        state.chatHistory.push(assistantMsg);
        saveChatHistory();
        renderMessage(assistantMsg);

        // Add to activity
        addActivity('chat', `Chat: ${message.substring(0, 30)}...`);
        updateConversationTopics();
    } catch (error) {
        hideThinking();
        if (error.name === 'AbortError') {
            // Already handled by stopGeneration()
        } else {
            const errorMsg = { role: 'assistant', content: `Mi dispiace, I had trouble: ${error.message}. Let's try again, cara.`, timestamp: new Date().toISOString() };
            state.chatHistory.push(errorMsg);
            saveChatHistory();
            renderMessage(errorMsg);
        }
    }

    state.isProcessing = false;
    state.abortController = null;
    updateSendStopButton(false);
}

function askNonna(text) {
    navigateTo('nonna');
    document.getElementById('chat-input').value = text;
    setTimeout(() => sendMessage(), 100);
}

// ========================================
// CONVERSATION MANAGEMENT
// ========================================
function startNewConversation() {
    // Save current conversation if it has messages
    if (state.chatHistory.length > 0) {
        saveCurrentConversation();
    }
    state.chatHistory = [];
    state.currentConversationId = 'conv_' + Date.now();
    saveChatHistory();
    renderChatHistory();
    renderQuickActions();
    updateConversationTopics();
    showToast('info', 'Started a new conversation');
}

function saveCurrentConversation() {
    if (state.chatHistory.length === 0) return;
    const conversations = getStorage(STORAGE.CONVERSATIONS) || [];
    const firstUserMsg = state.chatHistory.find(m => m.role === 'user');
    const title = firstUserMsg ? firstUserMsg.content.substring(0, 50) : 'Conversation';

    // Check if updating existing conversation
    const existingIdx = conversations.findIndex(c => c.id === state.currentConversationId);
    const conv = {
        id: state.currentConversationId || ('conv_' + Date.now()),
        title: title,
        startedAt: state.chatHistory[0]?.timestamp || new Date().toISOString(),
        updatedAt: new Date().toISOString(),
        messages: state.chatHistory,
        messageCount: state.chatHistory.length
    };

    if (existingIdx >= 0) {
        conversations[existingIdx] = conv;
    } else {
        conversations.unshift(conv);
    }
    // Keep last 50 conversations
    if (conversations.length > 50) conversations.splice(50);
    setStorage(STORAGE.CONVERSATIONS, conversations);
}

function toggleConversationPanel() {
    const panel = document.getElementById('conversation-panel');
    if (!panel) return;
    const isVisible = panel.style.display !== 'none';
    panel.style.display = isVisible ? 'none' : 'block';
    if (!isVisible) renderConversationList();
}

function renderConversationList(filter = '') {
    const list = document.getElementById('conversation-list');
    if (!list) return;
    const conversations = getStorage(STORAGE.CONVERSATIONS) || [];
    const filtered = filter
        ? conversations.filter(c => c.title.toLowerCase().includes(filter.toLowerCase()))
        : conversations;

    if (filtered.length === 0) {
        list.innerHTML = `<div style="padding:16px;text-align:center;color:var(--gray-text);font-size:0.85rem">${filter ? 'No matching conversations' : 'No conversation history yet'}</div>`;
        return;
    }

    list.innerHTML = filtered.map(c => {
        const date = new Date(c.updatedAt || c.startedAt);
        const dateStr = date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
        const isActive = c.id === state.currentConversationId;
        const preview = c.messages?.find(m => m.role === 'assistant')?.content?.substring(0, 60) || '';
        return `<div class="conversation-item${isActive ? ' active' : ''}" onclick="loadConversation('${c.id}')">
            <div class="conversation-item-title">${c.title}${c.title.length >= 50 ? '...' : ''}</div>
            <div class="conversation-item-date">${dateStr} &middot; ${c.messageCount || c.messages?.length || 0} messages</div>
            ${preview ? `<div class="conversation-item-preview">${preview}...</div>` : ''}
            <div class="conversation-item-actions">
                <button class="btn-ghost" style="font-size:0.7rem;padding:2px 6px" onclick="event.stopPropagation();deleteConversation('${c.id}')">
                    ${icon('trash-2',12)} Delete
                </button>
            </div>
        </div>`;
    }).join('');
    refreshIcons();
}

function loadConversation(convId) {
    // Save current first
    if (state.chatHistory.length > 0 && state.currentConversationId !== convId) {
        saveCurrentConversation();
    }
    const conversations = getStorage(STORAGE.CONVERSATIONS) || [];
    const conv = conversations.find(c => c.id === convId);
    if (!conv) return;

    state.chatHistory = conv.messages || [];
    state.currentConversationId = convId;
    saveChatHistory();
    renderChatHistory();
    updateConversationTopics();
    toggleConversationPanel();
}

function deleteConversation(convId) {
    const conversations = getStorage(STORAGE.CONVERSATIONS) || [];
    const idx = conversations.findIndex(c => c.id === convId);
    if (idx >= 0) {
        conversations.splice(idx, 1);
        setStorage(STORAGE.CONVERSATIONS, conversations);
        renderConversationList();
        showToast('info', 'Conversation deleted');
    }
}

function filterConversations(query) {
    renderConversationList(query);
}

// Conversation Summary Panel (desktop sidebar)
function updateConversationTopics() {
    const topicsEl = document.getElementById('conversation-topics');
    if (!topicsEl) return;

    const topics = [];
    const contextCounts = {};
    state.chatHistory.forEach(msg => {
        if (msg.role === 'user') {
            const context = detectMessageContext(msg.content);
            contextCounts[context] = (contextCounts[context] || 0) + 1;
            topics.push({ text: msg.content.substring(0, 50), context, timestamp: msg.timestamp });
        }
    });

    if (topics.length === 0) {
        topicsEl.innerHTML = '<div style="color:var(--gray-text);font-size:0.8rem;padding:8px">Start chatting to see topics here</div>';
        return;
    }

    const contextLabels = {
        planning: 'Meal Planning', recipe: 'Recipes', shopping: 'Shopping',
        health: 'Health', family: 'Family', pantry: 'Pantry', general: 'General'
    };

    topicsEl.innerHTML = topics.slice(-10).reverse().map(t =>
        `<div class="chat-topic-item" onclick="scrollToChatMessage('${t.timestamp}')">
            <span class="chat-topic-badge ${t.context}">${contextLabels[t.context] || 'Chat'}</span>
            ${t.text}${t.text.length >= 50 ? '...' : ''}
        </div>`
    ).join('');

    // Show sidebar on desktop if there are topics
    const sidebar = document.getElementById('chat-sidebar');
    if (sidebar && topics.length > 0) sidebar.classList.add('visible');
}

function scrollToChatMessage(timestamp) {
    const messages = document.querySelectorAll('.message');
    // Find message close to this timestamp (approximate match)
    for (const msg of messages) {
        if (msg.textContent.includes(timestamp)) {
            msg.scrollIntoView({ behavior: 'smooth', block: 'center' });
            msg.style.outline = '2px solid var(--cerulean)';
            setTimeout(() => msg.style.outline = '', 2000);
            return;
        }
    }
}

// ===========================================
// QUICK CHAT & DEDICATED NONNA PAGE FUNCTIONS
// ===========================================

let quickChatState = { isOpen: false, messageCount: 5 };

function toggleQuickChat() {
    quickChatState.isOpen ? closeQuickChat() : openQuickChat();
}

function openQuickChat() {
    const dropdown = document.getElementById('quick-chat-dropdown');
    if (!dropdown) return;

    dropdown.classList.add('active');
    quickChatState.isOpen = true;
    updateQuickChatContext();
    renderQuickChatMessages();

    const input = document.getElementById('quick-chat-input');
    if (input) input.focus();

    // Add outside click listener after a short delay
    setTimeout(() => document.addEventListener('click', handleQuickChatOutsideClick), 100);
    refreshIcons();
}

function closeQuickChat() {
    const dropdown = document.getElementById('quick-chat-dropdown');
    if (!dropdown) return;

    dropdown.classList.remove('active');
    quickChatState.isOpen = false;
    document.removeEventListener('click', handleQuickChatOutsideClick);
}

function handleQuickChatOutsideClick(e) {
    const container = document.querySelector('.quick-chat-container');
    if (container && !container.contains(e.target)) {
        closeQuickChat();
    }
}

function updateQuickChatContext() {
    const contextEl = document.getElementById('quick-chat-context');
    if (!contextEl) return;

    const contextMap = {
        home: 'What can I cook today?',
        recipes: 'Questions about this recipe?',
        week: 'Need help planning your week?',
        pantry: 'What can I make with these?',
        workouts: 'Meal ideas for your workout?',
        nonna: 'Chat with Nonna'
    };

    contextEl.textContent = contextMap[state.currentView] || 'Chat with Nonna';
}

function renderQuickChatMessages() {
    const container = document.getElementById('quick-chat-messages');
    if (!container) return;

    const recent = state.chatHistory.slice(-quickChatState.messageCount);

    if (recent.length === 0) {
        container.innerHTML = `
            <div style="text-align:center;padding:24px;color:var(--gray-text);">
                <i data-lucide="message-circle" style="width:32px;height:32px;margin-bottom:8px"></i>
                <p style="margin:0;">Start a conversation with Nonna</p>
            </div>
        `;
        refreshIcons();
        return;
    }

    container.innerHTML = recent.map(msg => {
        const truncatedContent = msg.content.substring(0, 150);
        const needsTruncation = msg.content.length > 150;
        return `
            <div class="quick-chat-message ${msg.role}">
                <div class="message-bubble">
                    ${escapeHtml(truncatedContent)}${needsTruncation ? '...' : ''}
                </div>
            </div>
        `;
    }).join('');

    container.scrollTop = container.scrollHeight;
}

function getContextualLoadingMessage(message) {
    const msg = message.toLowerCase();

    // Contextual loading messages based on conversation topic
    if (msg.includes('recipe') || msg.includes('how do i make') || msg.includes('how to cook')) {
        const recipes = ['Looking through my recipe collection...', 'Finding the perfect recipe for you...', 'Checking my recipe notes...'];
        return recipes[Math.floor(Math.random() * recipes.length)];
    } else if (msg.includes('plan') || msg.includes('week') || msg.includes('meal')) {
        const planning = ['Planning your meals...', 'Looking at your schedule...', 'Creating your meal plan...'];
        return planning[Math.floor(Math.random() * planning.length)];
    } else if (msg.includes('shopping') || msg.includes('grocery') || msg.includes('buy')) {
        const shopping = ['Preparing your shopping list...', 'Checking what you need...', 'Organizing your groceries...'];
        return shopping[Math.floor(Math.random() * shopping.length)];
    } else if (msg.includes('pantry') || msg.includes('ingredient') || msg.includes('have')) {
        const pantry = ['Looking through your pantry...', 'Checking your ingredients...', 'Seeing what you have...'];
        return pantry[Math.floor(Math.random() * pantry.length)];
    } else if (msg.includes('health') || msg.includes('nutrition') || msg.includes('flare') || msg.includes('crohn')) {
        const health = ['Finding gentle options for you...', 'Checking health-friendly recipes...', 'Looking at nutrition info...'];
        return health[Math.floor(Math.random() * health.length)];
    } else if (msg.includes('family') || msg.includes('share')) {
        const family = ['Thinking about your family favorites...', 'Finding shareable recipes...', 'Looking through family options...'];
        return family[Math.floor(Math.random() * family.length)];
    } else {
        const general = ['Thinking...', 'Let me help you with that...', 'One moment, cara...', 'Checking my notes...'];
        return general[Math.floor(Math.random() * general.length)];
    }
}

async function sendQuickChatMessage() {
    const input = document.getElementById('quick-chat-input');
    if (!input) return;

    const message = input.value.trim();
    if (!message || state.isProcessing) return;

    input.value = '';

    // Add user message
    const userMsg = {
        role: 'user',
        content: message,
        timestamp: new Date().toISOString()
    };
    state.chatHistory.push(userMsg);
    saveChatHistory();
    renderQuickChatMessages();

    // Show contextual typing indicator
    const container = document.getElementById('quick-chat-messages');
    if (container) {
        container.innerHTML += `
            <div class="quick-chat-message assistant" id="typing-indicator">
                <div class="message-bubble">${getContextualLoadingMessage(message)}</div>
            </div>
        `;
        container.scrollTop = container.scrollHeight;
    }

    try {
        state.isProcessing = true;
        const response = await callAPI(message);

        // Remove typing indicator
        document.getElementById('typing-indicator')?.remove();

        state.chatHistory.push({
            role: 'assistant',
            content: response,
            timestamp: new Date().toISOString()
        });
        saveChatHistory();
        renderQuickChatMessages();

    } catch (error) {
        console.error('Quick chat error:', error);
        document.getElementById('typing-indicator')?.remove();
        showToast('Could not reach Nonna', 'warning');
    } finally {
        state.isProcessing = false;
    }
}

function openFullChat() {
    closeQuickChat();
    navigateTo('nonna');
}

// Dedicated Nonna Page Functions
function renderNonnaView() {
    const container = document.getElementById('chat-messages-nonna');
    if (!container) return;

    container.innerHTML = '';

    if (state.chatHistory.length === 0) {
        container.innerHTML = `
            <div style="text-align:center;padding:48px 24px;color:var(--gray-text);">
                <i data-lucide="message-circle" style="width:48px;height:48px;margin-bottom:16px;color:var(--cerulean)"></i>
                <h3 style="margin:0 0 8px 0;color:var(--navy)">Start chatting with Nonna</h3>
                <p style="margin:0;">Ask about recipes, meal planning, or anything food-related!</p>
            </div>
        `;
        refreshIcons();
        renderNonnaConversationList();
        return;
    }

    state.chatHistory.forEach(msg => {
        const msgEl = createMessageElement(msg);
        container.appendChild(msgEl);
    });

    container.scrollTop = container.scrollHeight;
    renderNonnaConversationList();
    refreshIcons();
}

function createMessageElement(msg) {
    const div = document.createElement('div');
    div.className = `message message-${msg.role}`;

    // Check if message contains recipe
    if (msg.role === 'assistant' && containsRecipe(msg.content)) {
        const recipes = parseRecipes(msg.content);
        let recipeHTML = '';

        // Include non-recipe text if any
        const nonRecipeText = extractNonRecipeText(msg.content);
        if (nonRecipeText.trim()) {
            recipeHTML = `<div class="message-bubble">${formatMessageContent(nonRecipeText)}</div>`;
        }

        recipes.forEach((recipe, index) => {
            recipeHTML += renderRecipeCard(recipe, index);
        });

        div.innerHTML = recipeHTML;
    } else {
        div.innerHTML = `<div class="message-bubble">${formatMessageContent(msg.content)}</div>`;
    }

    return div;
}

function containsRecipe(content) {
    return content.includes('RECIPE:') || content.includes('=== RECIPE:') ||
           (content.includes('INGREDIENTS:') && content.includes('INSTRUCTIONS:'));
}

function extractNonRecipeText(content) {
    // Remove recipe sections and return remaining text
    return content.split(/===?\s*RECIPE:/)[0].trim();
}

function parseRecipes(content) {
    const recipes = [];
    const recipePattern = /===?\s*RECIPE:\s*(.+?)(?====?\s*RECIPE:|$)/gs;
    const matches = [...content.matchAll(recipePattern)];

    matches.forEach(match => {
        const recipeText = match[1];

        // Extract title - try different patterns
        let title = extractField(recipeText, 'RECIPE:', '\n');
        if (!title) {
            // Try first line if RECIPE: marker not found
            const firstLine = recipeText.split('\n')[0]?.trim();
            title = firstLine?.replace(/^#+\s*/, '') || 'Recipe from Nonna';
        }

        const recipe = {
            title: title.trim(),
            servings: extractField(recipeText, 'Serves?:', '\n') || '4',
            prepTime: extractField(recipeText, 'Prep:', '\n') || '15 min',
            cookTime: extractField(recipeText, 'Cook:|Total:', '\n') || '30 min',
            difficulty: extractField(recipeText, 'Difficulty:', '\n') || 'Medium',
            tags: extractTags(recipeText),
            ingredients: extractList(recipeText, 'INGREDIENTS:', 'INSTRUCTIONS:'),
            instructions: extractList(recipeText, 'INSTRUCTIONS:', '(?:NUTRITION:|TAGS:|$)'),
            nutrition: extractNutrition(recipeText)
        };
        recipes.push(recipe);
    });

    return recipes.length > 0 ? recipes : [parseSimpleRecipe(content)];
}

function extractField(text, startPattern, endPattern) {
    const regex = new RegExp(`${startPattern}\\s*(.+?)${endPattern}`, 'is');
    const match = text.match(regex);
    return match ? match[1].trim() : '';
}

function extractTags(text) {
    const tags = { health: [], dietary: [], cuisine: [] };
    const tagSection = extractField(text, 'TAGS?:', '(?:INGREDIENTS:|INSTRUCTIONS:|$)');

    if (tagSection) {
        const tagList = tagSection.split(',').map(t => t.trim());
        tagList.forEach(tag => {
            const lower = tag.toLowerCase();
            if (lower.includes('anti-inflammatory') || lower.includes('gut-friendly') || lower.includes('heart')) {
                tags.health.push(tag);
            } else if (lower.includes('dairy') || lower.includes('gluten') || lower.includes('vegan')) {
                tags.dietary.push(tag);
            } else {
                tags.cuisine.push(tag);
            }
        });
    }

    return tags;
}

function extractList(text, startMarker, endMarker) {
    const regex = new RegExp(`${startMarker}([\\s\\S]*?)(?=${endMarker})`, 'i');
    const match = text.match(regex);

    if (!match) return [];

    return match[1]
        .split('\n')
        .map(line => line.trim())
        .filter(line => line && (line.startsWith('-') || line.startsWith('â€¢') || /^\d+\./.test(line)))
        .map(line => line.replace(/^[-â€¢]\s*/, '').replace(/^\d+\.\s*/, ''));
}

function extractNutrition(text) {
    const nutrition = {};
    const nutritionSection = extractField(text, 'NUTRITION:', '(?:$|TAGS:)');

    if (nutritionSection) {
        const pairs = nutritionSection.split(',');
        pairs.forEach(pair => {
            const [key, value] = pair.split(':').map(s => s.trim());
            if (key && value) {
                nutrition[key] = value;
            }
        });
    }

    return nutrition;
}

function parseSimpleRecipe(content) {
    // Fallback parser for recipes without explicit markers
    const ingredients = extractList(content, 'INGREDIENTS:', 'INSTRUCTIONS:');
    const instructions = extractList(content, 'INSTRUCTIONS:', '$');

    // Try to extract title from first line or use default
    const lines = content.split('\n').map(l => l.trim()).filter(l => l);
    const title = lines[0]?.replace(/^#+\s*/, '').replace(/^RECIPE:\s*/i, '') || 'Recipe from Nonna';

    return {
        title,
        servings: '4',
        prepTime: '15 min',
        cookTime: '30 min',
        difficulty: 'Medium',
        tags: { health: [], dietary: [], cuisine: [] },
        ingredients,
        instructions,
        nutrition: {}
    };
}

function renderRecipeCard(recipe, index) {
    const cardId = `recipe-card-${Date.now()}-${index}`;
    const hasNutrition = Object.keys(recipe.nutrition).length > 0;

    // Store recipe data globally so action buttons can access it
    if (!window.chatRecipes) window.chatRecipes = {};
    window.chatRecipes[cardId] = recipe;

    const tagsHTML = [...recipe.tags.health, ...recipe.tags.dietary, ...recipe.tags.cuisine]
        .map(tag => {
            const type = recipe.tags.health.includes(tag) ? 'health' :
                        recipe.tags.dietary.includes(tag) ? 'dietary' : 'cuisine';
            return `<span class="recipe-tag ${type}">${tag}</span>`;
        }).join('');

    const ingredientsHTML = recipe.ingredients
        .map(ing => `<li>${escapeHtml(ing)}</li>`)
        .join('');

    const instructionsHTML = recipe.instructions
        .map((inst, i) => `<li data-step="${i + 1}">${escapeHtml(inst)}</li>`)
        .join('');

    const nutritionHTML = hasNutrition ? `
        <div class="recipe-nutrition">
            <div class="recipe-nutrition-toggle" onclick="toggleNutrition('${cardId}')">
                <span>Nutrition Information</span>
                <i data-lucide="chevron-down"></i>
            </div>
            <div class="recipe-nutrition-content hidden" id="${cardId}-nutrition">
                ${Object.entries(recipe.nutrition).map(([key, val]) =>
                    `<div><strong>${key}:</strong> ${val}</div>`
                ).join('')}
            </div>
        </div>` : '';

    return `
        <div class="chat-recipe-card" id="${cardId}">
            <div class="recipe-card-header">
                <h3 class="recipe-card-title">${escapeHtml(recipe.title)}</h3>
            </div>

            <div class="recipe-metadata">
                <div class="recipe-metadata-item">
                    <i data-lucide="clock"></i>
                    <span>Prep: ${escapeHtml(recipe.prepTime)}</span>
                </div>
                <div class="recipe-metadata-item">
                    <i data-lucide="timer"></i>
                    <span>Cook: ${escapeHtml(recipe.cookTime)}</span>
                </div>
                <div class="recipe-metadata-item">
                    <i data-lucide="users"></i>
                    <span>Serves ${escapeHtml(recipe.servings)}</span>
                </div>
                <div class="recipe-metadata-item">
                    <i data-lucide="chef-hat"></i>
                    <span>${escapeHtml(recipe.difficulty)}</span>
                </div>
            </div>

            ${tagsHTML ? `<div class="recipe-tags">${tagsHTML}</div>` : ''}

            ${nutritionHTML}

            <div class="recipe-section">
                <h4 class="recipe-section-title">Ingredients</h4>
                <ul class="recipe-ingredients">${ingredientsHTML}</ul>
            </div>

            <div class="recipe-section">
                <h4 class="recipe-section-title">Instructions</h4>
                <ol class="recipe-instructions">${instructionsHTML}</ol>
            </div>

            <div class="recipe-actions">
                <div class="recipe-action-primary">
                    <button class="btn btn-primary" onclick="toggleDayDropdown('${cardId}')">
                        <i data-lucide="calendar-plus"></i> Add to Plan
                    </button>
                    <div class="recipe-day-dropdown" id="${cardId}-dropdown">
                        ${['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday']
                            .map(day => `<div class="recipe-day-option" onclick="addRecipeToDay('${cardId}', '${day}')">${day}</div>`)
                            .join('')}
                    </div>
                </div>
                <button class="btn btn-secondary" onclick="saveRecipeFromChat('${cardId}')">
                    <i data-lucide="bookmark"></i> Save to Recipes
                </button>
                <button class="btn btn-ghost" onclick="shareRecipeToFamily('${cardId}')">
                    <i data-lucide="users"></i> Share to Family
                </button>
            </div>
        </div>
    `;
}

function formatMessageContent(content) {
    // Basic markdown-like formatting
    let formatted = escapeHtml(content);

    // Bold: **text**
    formatted = formatted.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');

    // Italic: *text*
    formatted = formatted.replace(/\*(.+?)\*/g, '<em>$1</em>');

    // Line breaks
    formatted = formatted.replace(/\n/g, '<br>');

    return formatted;
}

function toggleNutrition(cardId) {
    const content = document.getElementById(`${cardId}-nutrition`);
    if (content) {
        content.classList.toggle('hidden');
    }
    refreshIcons();
}

function toggleDayDropdown(cardId) {
    const dropdown = document.getElementById(`${cardId}-dropdown`);
    if (dropdown) {
        // Close all other dropdowns
        document.querySelectorAll('.recipe-day-dropdown').forEach(d => {
            if (d.id !== `${cardId}-dropdown`) d.classList.remove('active');
        });
        dropdown.classList.toggle('active');
    }
}

function addRecipeToDay(cardId, day) {
    const dropdown = document.getElementById(`${cardId}-dropdown`);
    if (dropdown) dropdown.classList.remove('active');

    // Get recipe data from the card
    const card = document.getElementById(cardId);
    if (!card) return;

    const recipeData = window.chatRecipes?.[cardId];
    if (!recipeData) {
        showToast('Could not find recipe data', 'warning');
        return;
    }

    // First save to library if not already saved
    const savedRecipe = saveRecipeFromChat(cardId, true);
    if (!savedRecipe) return;

    // Get the date for the selected day
    const weekDates = getWeekDates(state.currentWeekOffset);
    const dayIndex = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'].indexOf(day);
    const dateStr = weekDates[dayIndex];

    if (!dateStr) {
        showToast('Invalid day selected', 'warning');
        return;
    }

    // Add to meal plan
    const mealPlans = getStorage(STORAGE.MEAL_PLANS) || {};
    if (!mealPlans[dateStr]) mealPlans[dateStr] = {};
    mealPlans[dateStr].dinner = {
        title: savedRecipe.title,
        calories: savedRecipe.nutrition?.calories || null,
        recipeId: savedRecipe.id,
        status: 'planned'
    };
    setStorage(STORAGE.MEAL_PLANS, mealPlans);

    showToast(`Recipe added to ${day}!`, 'success');
}

function saveRecipeFromChat(cardId, silent = false) {
    const recipeData = window.chatRecipes?.[cardId];
    if (!recipeData) {
        if (!silent) showToast('Could not find recipe data', 'warning');
        return null;
    }

    // Create a proper recipe object
    const recipe = {
        id: `recipe_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
        title: recipeData.title,
        ingredients: recipeData.ingredients,
        instructions: recipeData.instructions,
        metadata: {
            servings: recipeData.servings,
            prepTime: recipeData.prepTime,
            cookTime: recipeData.cookTime,
            difficulty: recipeData.difficulty,
            tags: [...recipeData.tags.health, ...recipeData.tags.dietary, ...recipeData.tags.cuisine]
        },
        nutrition: recipeData.nutrition,
        source: 'Nonna Chat',
        createdAt: new Date().toISOString(),
        timesCooked: 0,
        rating: 0
    };

    // Save to library
    const result = saveRecipeToLibrary(recipe);

    if (!silent) {
        showToast('Recipe saved to My Recipes!', 'success');

        // Update button to show it's saved
        const saveBtn = document.querySelector(`#${cardId} .recipe-actions .btn-secondary`);
        if (saveBtn) {
            saveBtn.innerHTML = '<i data-lucide="check"></i> Saved!';
            saveBtn.disabled = true;
            saveBtn.classList.add('disabled');
            refreshIcons();
        }
    }

    return recipe;
}

function shareRecipeToFamily(cardId) {
    const recipeData = window.chatRecipes?.[cardId];
    if (!recipeData) {
        showToast('Could not find recipe data', 'warning');
        return;
    }

    // First save to library
    const savedRecipe = saveRecipeFromChat(cardId, true);
    if (!savedRecipe) return;

    // Share to family (using existing family share functionality)
    if (typeof shareToFamily === 'function') {
        shareToFamily(savedRecipe.id);
    } else {
        showToast('Recipe shared to Family Tavola!', 'success');
    }
}

async function sendNonnaMessage() {
    const input = document.getElementById('chat-input-nonna');
    if (!input) return;

    const message = input.value.trim();
    if (!message || state.isProcessing) return;

    input.value = '';

    // Add user message
    const userMsg = {
        role: 'user',
        content: message,
        timestamp: new Date().toISOString()
    };
    state.chatHistory.push(userMsg);
    saveChatHistory();
    renderNonnaView();

    try {
        state.isProcessing = true;

        // Show contextual typing indicator
        const container = document.getElementById('chat-messages-nonna');
        if (container) {
            const typingDiv = document.createElement('div');
            typingDiv.className = 'message message-assistant';
            typingDiv.id = 'typing-indicator-nonna';
            typingDiv.innerHTML = `<div class="message-bubble">${getContextualLoadingMessage(message)}</div>`;
            container.appendChild(typingDiv);
            container.scrollTop = container.scrollHeight;
        }

        const response = await callAPI(message);

        // Remove typing indicator
        document.getElementById('typing-indicator-nonna')?.remove();

        state.chatHistory.push({
            role: 'assistant',
            content: response,
            timestamp: new Date().toISOString()
        });
        saveChatHistory();
        renderNonnaView();

    } catch (error) {
        console.error('Nonna chat error:', error);
        document.getElementById('typing-indicator-nonna')?.remove();
        showToast('Could not reach Nonna', 'warning');
    } finally {
        state.isProcessing = false;
    }
}

function toggleNonnaVoice() {
    const btn = document.getElementById('nonna-voice-btn');
    if (!btn) return;

    if (state.isListening) {
        stopVoiceRecognition();
        btn.classList.remove('recording');
    } else {
        startVoiceRecognition('nonna');
        btn.classList.add('recording');
    }
}

function startVoiceRecognition(context = 'nonna') {
    if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
        showToast('Voice input not supported in this browser', 'warning');
        return;
    }

    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    const recognition = new SpeechRecognition();

    recognition.continuous = false;
    recognition.interimResults = false;
    recognition.lang = 'en-US';

    recognition.onresult = (event) => {
        const transcript = event.results[0][0].transcript;
        const input = document.getElementById('chat-input-nonna');
        if (input) {
            input.value = transcript;
            input.focus();
        }
        state.isListening = false;
        const btn = document.getElementById('nonna-voice-btn');
        if (btn) btn.classList.remove('recording');
    };

    recognition.onerror = (event) => {
        console.error('Speech recognition error:', event.error);
        state.isListening = false;
        const btn = document.getElementById('nonna-voice-btn');
        if (btn) btn.classList.remove('recording');
        showToast('Voice recognition error', 'warning');
    };

    recognition.onend = () => {
        state.isListening = false;
        const btn = document.getElementById('nonna-voice-btn');
        if (btn) btn.classList.remove('recording');
    };

    try {
        recognition.start();
        state.isListening = true;
        showToast('Listening...', 'info');
    } catch (error) {
        console.error('Could not start recognition:', error);
        state.isListening = false;
    }
}

function stopVoiceRecognition() {
    state.isListening = false;
}

function renderNonnaConversationList() {
    const listEl = document.getElementById('nonna-conversation-list');
    if (!listEl) return;

    const conversations = getStorage(STORAGE.CONVERSATIONS) || [];

    // Update context and quick actions
    renderConversationContext();
    renderConversationQuickActions();

    if (conversations.length === 0) {
        listEl.innerHTML = `
            <div style="padding:24px;text-align:center;color:var(--gray-text);font-size:0.85rem">
                <p>No saved conversations yet</p>
            </div>
        `;
        return;
    }

    // Show max 20 conversations
    const recent = conversations.slice(0, 20);

    listEl.innerHTML = recent.map(conv => {
        const date = new Date(conv.updatedAt || conv.startedAt);
        const dateStr = date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
        const isActive = conv.id === state.currentConversationId;
        const preview = conv.messages?.find(m => m.role === 'assistant')?.content?.substring(0, 60) || '';

        return `
            <div class="conversation-item${isActive ? ' active' : ''}" onclick="loadNonnaConversation('${conv.id}')">
                <div class="conversation-item-title">${escapeHtml(conv.title.substring(0, 50))}${conv.title.length >= 50 ? '...' : ''}</div>
                <div class="conversation-item-time">${dateStr}</div>
                ${preview ? `<div class="conversation-item-preview">${escapeHtml(preview)}...</div>` : ''}
            </div>
        `;
    }).join('');

    refreshIcons();
}

function renderConversationContext() {
    const contextEl = document.getElementById('conversation-context');
    if (!contextEl) return;

    // Only show context if there's an active conversation
    if (!state.chatHistory || state.chatHistory.length === 0) {
        contextEl.classList.add('hidden');
        return;
    }

    contextEl.classList.remove('hidden');

    // Analyze conversation to determine context
    const context = analyzeConversationContext();

    contextEl.innerHTML = `
        <div class="conversation-context-title">Current Topic</div>
        <div class="conversation-context-summary">
            <i data-lucide="${context.icon}" style="width:14px;height:14px;vertical-align:middle;margin-right:4px;color:var(--seafoam)"></i>
            ${context.summary}
        </div>
    `;

    refreshIcons();
}

function analyzeConversationContext() {
    const userMessages = state.chatHistory.filter(m => m.role === 'user').map(m => m.content.toLowerCase());
    const allText = userMessages.join(' ');

    // Detect main topics
    if (allText.includes('recipe') || allText.includes('cook') || allText.includes('make')) {
        return {
            icon: 'chef-hat',
            summary: 'Recipe ideas and cooking tips'
        };
    } else if (allText.includes('plan') || allText.includes('week') || allText.includes('meal')) {
        return {
            icon: 'calendar',
            summary: 'Meal planning and weekly menus'
        };
    } else if (allText.includes('pantry') || allText.includes('ingredients') || allText.includes('shopping')) {
        return {
            icon: 'shopping-bag',
            summary: 'Pantry and shopping lists'
        };
    } else if (allText.includes('health') || allText.includes('nutrition') || allText.includes('flare')) {
        return {
            icon: 'heart-pulse',
            summary: 'Health and nutrition guidance'
        };
    } else if (allText.includes('family') || allText.includes('share')) {
        return {
            icon: 'users',
            summary: 'Family recipes and sharing'
        };
    } else {
        return {
            icon: 'message-circle',
            summary: 'General cooking conversation'
        };
    }
}

function renderConversationQuickActions() {
    const actionsEl = document.getElementById('conversation-quick-actions');
    if (!actionsEl) return;

    // Only show actions if there's an active conversation
    if (!state.chatHistory || state.chatHistory.length === 0) {
        actionsEl.classList.add('hidden');
        return;
    }

    actionsEl.classList.remove('hidden');

    const context = analyzeConversationContext();
    const actions = getContextualQuickActions(context);

    actionsEl.innerHTML = actions.map(action => `
        <button class="quick-action-btn" onclick="${action.onClick}">
            <i data-lucide="${action.icon}"></i>
            <span>${action.label}</span>
        </button>
    `).join('');

    refreshIcons();
}

function getContextualQuickActions(context) {
    const baseActions = [
        { icon: 'bookmark', label: 'Save conversation', onClick: 'saveCurrentConversation()' }
    ];

    // Add context-specific actions
    if (context.summary.includes('Recipe')) {
        baseActions.unshift({ icon: 'book-open', label: 'View my recipes', onClick: "navigateTo('recipes')" });
        baseActions.unshift({ icon: 'chef-hat', label: 'Add to meal plan', onClick: "navigateTo('week')" });
    } else if (context.summary.includes('Meal planning')) {
        baseActions.unshift({ icon: 'calendar-days', label: 'View week plan', onClick: "navigateTo('week')" });
        baseActions.unshift({ icon: 'shopping-cart', label: 'Create shopping list', onClick: "navigateTo('pantry'); switchPantryTab('shopping')" });
    } else if (context.summary.includes('Pantry')) {
        baseActions.unshift({ icon: 'package', label: 'View pantry', onClick: "navigateTo('pantry')" });
        baseActions.unshift({ icon: 'shopping-cart', label: 'Shopping list', onClick: "navigateTo('pantry'); switchPantryTab('shopping')" });
    } else if (context.summary.includes('Health')) {
        baseActions.unshift({ icon: 'heart', label: 'Flare mode recipes', onClick: "openFlareModeFilter()" });
        baseActions.unshift({ icon: 'activity', label: 'View workouts', onClick: "navigateTo('workouts')" });
    } else if (context.summary.includes('Family')) {
        baseActions.unshift({ icon: 'users', label: 'Family recipes', onClick: "navigateTo('recipes'); showFamilyRecipes()" });
    }

    return baseActions.slice(0, 3); // Max 3 actions
}

function loadNonnaConversation(convId) {
    // Save current conversation first
    if (state.chatHistory.length > 0 && state.currentConversationId !== convId) {
        saveCurrentConversation();
    }

    const conversations = getStorage(STORAGE.CONVERSATIONS) || [];
    const conv = conversations.find(c => c.id === convId);
    if (!conv) return;

    state.chatHistory = conv.messages || [];
    state.currentConversationId = convId;
    saveChatHistory();
    renderNonnaView();
    updateConversationTopics();
}

function startNewConversation() {
    // Save current conversation if it has messages
    if (state.chatHistory.length > 0) {
        saveCurrentConversation();
    }

    // Start fresh
    state.chatHistory = [];
    state.currentConversationId = 'conv_' + Date.now();
    saveChatHistory();
    renderNonnaView();

    showToast('Started new conversation', 'success');
}

// Helper function for HTML escaping (if not already defined)
function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// Add Enter key handler for quick chat
document.addEventListener('DOMContentLoaded', function() {
    const quickChatInput = document.getElementById('quick-chat-input');
    if (quickChatInput) {
        quickChatInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendQuickChatMessage();
            }
        });
    }

    const nonnaChatInput = document.getElementById('chat-input-nonna');
    if (nonnaChatInput) {
        nonnaChatInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendNonnaMessage();
            }
        });
    }
});

// Active Plan Bar
function updateActivePlanBar() {
    const bar = document.getElementById('active-plan-bar');
    if (!bar) return;
    const plans = getStorage(STORAGE.MEAL_PLANS) || {};
    // Find current week plan
    const keys = Object.keys(plans);
    if (keys.length === 0) { bar.style.display = 'none'; return; }

    const latestKey = keys[keys.length - 1];
    const plan = plans[latestKey];
    if (!plan) { bar.style.display = 'none'; return; }

    // Count planned days
    const days = ['monday','tuesday','wednesday','thursday','friday','saturday','sunday'];
    const filledDays = days.filter(d => plan[d] && (plan[d].meals || plan[d].dinner || plan[d].lunch)).length;

    if (filledDays > 0) {
        document.getElementById('plan-bar-summary').textContent = `${filledDays} days planned`;
        bar.style.display = 'flex';
        refreshIcons();
    } else {
        bar.style.display = 'none';
    }
}

async function callAPI(userMessage) {
    const profile = getStorage(STORAGE.PROFILE);
    const profileText = formatProfileForAPI(profile);
    const history = getStorage(STORAGE.HISTORY) || [];
    const recentMeals = history.slice(0, 5).map(h => `${h.title} (${formatRelativeDate(h.date)})`).join(', ');
    const recipeRatings = formatRecipeRatingsForAPI();
    const workoutData = formatWorkoutDataForAPI();
    const pantryData = formatPantryForAPI();
    const gardenData = formatGardenForAPI();

    const messages = state.chatHistory.slice(-10).map(m => ({
        role: m.role,
        content: m.content
    }));

    if (!messages.length || messages[messages.length - 1].content !== userMessage) {
        messages.push({ role: 'user', content: userMessage });
    }

    state.abortController = new AbortController();
    const response = await fetch('/.netlify/functions/chat', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ messages, profileText, flareMode: state.flareMode, recentMeals, recipeRatings, workoutData, pantryData, gardenData }),
        signal: state.abortController.signal
    });

    if (!response.ok) {
        const err = await response.json().catch(() => ({}));
        throw new Error(err.error || `API error: ${response.status}`);
    }

    const data = await response.json();
    return data.content;
}

function formatProfileForAPI(profile) {
    if (!profile) return 'No profile configured.';

    const conditions = profile.conditions || [];
    let text = 'HEALTH CONDITIONS:\n';

    // Digestive conditions
    if (conditions.includes('crohns')) {
        text += `- Crohn's Disease: ${profile.crohnsSeverity || 'severity not specified'}`;
        if (profile.crohnsTriggers) text += `. Triggers: ${profile.crohnsTriggers}`;
        text += '\n  â†’ Prioritize: low-fiber when flaring, well-cooked vegetables, lean proteins, bone broth\n  â†’ Avoid: raw vegetables, nuts, seeds, high-fiber foods during flares\n';
    }
    if (conditions.includes('uc')) {
        text += `- Ulcerative Colitis: ${profile.ucSeverity || 'severity not specified'}\n  â†’ Similar to Crohn's: low-fiber during flares, gentle foods\n`;
    }
    if (conditions.includes('ibs')) {
        text += `- IBS: ${profile.ibsType || 'type not specified'}\n  â†’ Consider low-FODMAP options, avoid trigger foods\n`;
    }
    if (conditions.includes('celiac')) {
        text += '- Celiac/Gluten Sensitivity: ALL recipes must be gluten-free\n';
    }
    if (conditions.includes('lactose')) {
        text += '- Lactose Intolerance: Avoid or limit dairy, suggest lactose-free alternatives\n';
    }
    if (conditions.includes('gerd')) {
        text += '- GERD/Acid Reflux: Avoid tomatoes, citrus, spicy foods, large meals. Smaller portions.\n';
    }

    // Cardiovascular conditions
    if (conditions.includes('highCholesterol')) {
        text += `- High Cholesterol: Goal is ${profile.cholesterolGoal || 'general improvement'}\n  â†’ Prioritize: olive oil, fish (omega-3), oats, nuts, legumes, vegetables\n  â†’ Limit: saturated fat, red meat, full-fat dairy\n`;
    }
    if (conditions.includes('highBP')) {
        text += `- High Blood Pressure: Sodium restriction ${profile.sodiumRestriction || 'moderate'}\n  â†’ Prioritize: DASH diet, potassium-rich foods, herbs instead of salt\n  â†’ Limit: salt, processed foods, canned goods (unless low-sodium)\n`;
    }
    if (conditions.includes('diabetes')) {
        text += `- Type 2 Diabetes: Carb management ${profile.carbManagement || 'moderate'}\n  â†’ Prioritize: complex carbs, high fiber, protein, healthy fats, low-glycemic foods\n  â†’ Always include carb counts in recipes, note glycemic impact\n`;
    }
    if (conditions.includes('heartDisease')) {
        text += '- Heart Disease: Heart-healthy focus, limit sodium and saturated fat\n';
    }
    if (conditions.includes('kidney')) {
        const kidneyRestrictions = profile.kidneyRestrictions?.join(', ') || 'general';
        text += `- Kidney Disease: Restrictions: ${kidneyRestrictions}\n  â†’ May need to limit: protein, sodium, potassium, phosphorus based on stage\n`;
    }

    // Autoimmune conditions
    if (conditions.includes('fibromyalgia')) {
        text += `- Fibromyalgia: Energy level ${profile.fibroEnergy || 'variable'}\n  â†’ Suggest easy, low-effort recipes on low-energy days. Anti-inflammatory focus.\n`;
    }
    if (conditions.includes('rheumatoid') || conditions.includes('lupus') || conditions.includes('psoriatic') || conditions.includes('ms')) {
        const autoimmune = [];
        if (conditions.includes('rheumatoid')) autoimmune.push('Rheumatoid Arthritis');
        if (conditions.includes('lupus')) autoimmune.push('Lupus');
        if (conditions.includes('psoriatic')) autoimmune.push('Psoriatic Arthritis');
        if (conditions.includes('ms')) autoimmune.push('MS');
        text += `- Autoimmune (${autoimmune.join(', ')}): Anti-inflammatory diet essential\n  â†’ Prioritize: omega-3 rich fish, colorful vegetables, turmeric, ginger, olive oil\n  â†’ Limit: processed foods, refined sugars, potential inflammatory triggers\n`;
    }
    if (conditions.includes('hashimotos')) {
        text += `- Hashimoto's/Thyroid: ${profile.thyroidType || 'thyroid condition'}\n  â†’ Consider: selenium-rich foods, limit goitrogens if indicated\n`;
    }

    // Food allergies
    if (profile.foodAllergies) {
        text += `\nFOOD ALLERGIES (CRITICAL - NEVER include these): ${profile.foodAllergies}\n`;
    }

    // Dietary goals
    if (profile.dietaryGoals?.length > 0) {
        const goalDescriptions = {
            'weightLoss': 'Weight Loss (calorie-conscious, high protein)',
            'weightGain': 'Weight Gain/Muscle Building (calorie-dense, high protein)',
            'antiInflammatory': 'Anti-Inflammatory Focus',
            'heartHealthy': 'Heart-Healthy (Mediterranean)',
            'bloodSugar': 'Blood Sugar Management',
            'gutHealth': 'Gut Health Restoration',
            'energy': 'Increased Energy'
        };
        text += `\nDIETARY GOALS: ${profile.dietaryGoals.map(g => goalDescriptions[g] || g).join(', ')}\n`;
    }

    // Other notes
    if (profile.otherConditions) {
        text += `\nOTHER NOTES: ${profile.otherConditions}\n`;
    }

    // Standard profile info
    text += `
PROTEINS EATEN: ${profile.proteins?.join(', ') || 'Not specified'}
FOODS TO AVOID: ${profile.foodsToAvoid || 'None specified'}
FAVORITE FLAVORS: ${profile.favoriteFlavors || 'Not specified'}

GARDEN: ${profile.currentlyGrowing || 'Nothing growing'}
Zone: ${profile.growingZone || 'Not specified'}, Season: ${profile.currentSeason || 'Not specified'}

COOKING PREFERENCES:
- Energy Level: ${profile.energyLevel || 'Not specified'}
- Time Available: ${profile.cookingTime || 'Not specified'}
- Budget: $${profile.weeklyBudget || 'Not specified'}/week
- Shopping Priority: ${profile.shoppingPriority || 'Not specified'}`;

    if (profile.cookingForTwo) {
        text += `

COOKING FOR TWO:
Partner: ${profile.partnerName || 'Partner'}
Their Restrictions: ${profile.partnerRestrictions?.join(', ') || 'None'}
Their Allergies: ${profile.partnerAllergies || 'None'}
Foods They Love: ${profile.partnerLoves || 'Not specified'}`;
    }

    return text.trim();
}

function formatRecipeRatingsForAPI() {
    const library = getRecipeLibrary();
    if (!library || library.length === 0) return 'No recipes saved yet.';

    // Get favorites and highly rated recipes
    const favorites = library.filter(r => r.favorited);
    const highRated = library.filter(r => (r.averageRating || r.rating || 0) >= 4);
    const lowRated = library.filter(r => (r.averageRating || r.rating || 0) > 0 && (r.averageRating || r.rating || 0) <= 2);
    const mostCooked = library.filter(r => (r.timesCooked || 0) >= 3).sort((a, b) => b.timesCooked - a.timesCooked);

    let text = '';

    if (favorites.length > 0) {
        text += `FAVORITES (${favorites.length}): ${favorites.slice(0, 5).map(r => r.title).join(', ')}`;
        if (favorites.length > 5) text += `, and ${favorites.length - 5} more`;
        text += '\n';
    }

    if (highRated.length > 0) {
        text += `HIGHLY RATED (4-5 stars): ${highRated.slice(0, 5).map(r => `${r.title} (${r.averageRating || r.rating}â˜…)`).join(', ')}\n`;
    }

    if (mostCooked.length > 0) {
        text += `FREQUENTLY COOKED: ${mostCooked.slice(0, 3).map(r => `${r.title} (${r.timesCooked}x)`).join(', ')}\n`;
    }

    if (lowRated.length > 0) {
        text += `LOWER RATED (avoid suggesting unless asked): ${lowRated.map(r => r.title).join(', ')}\n`;
    }

    return text || 'No recipes rated yet.';
}

function formatPantryForAPI() {
    const pantry = getStorage(STORAGE.PANTRY) || [];
    if (!pantry || pantry.length === 0) return 'Pantry is empty - no ingredients tracked.';

    // Group by category
    const categories = {};
    pantry.forEach(item => {
        const cat = item.category || 'Other';
        if (!categories[cat]) categories[cat] = [];
        categories[cat].push(item);
    });

    let text = 'Available ingredients:\n';

    // Sort categories for consistent output
    const catOrder = ['Proteins', 'Produce', 'Dairy', 'Grains', 'Pantry Staples', 'Frozen', 'Other'];
    catOrder.forEach(cat => {
        if (categories[cat] && categories[cat].length > 0) {
            text += `**${cat}:** `;
            text += categories[cat].map(item => {
                let itemText = item.name;
                if (item.quantity) itemText += ` (${item.quantity})`;
                if (item.expirationConcern) itemText += ' ' + icon('alert-triangle',14) + 'USE SOON';
                return itemText;
            }).join(', ');
            text += '\n';
        }
    });

    // Check for items expiring soon
    const expiringItems = pantry.filter(i => i.expirationConcern);
    if (expiringItems.length > 0) {
        text += `\n${icon('alert-triangle',14)} USE SOON: ${expiringItems.map(i => i.name).join(', ')}`;
    }

    return text;
}

function formatGardenForAPI() {
    const profile = getStorage(STORAGE.PROFILE);
    const garden = getStorage(STORAGE.GARDEN) || [];

    let text = '';

    // Check profile for currently growing
    if (profile?.currentlyGrowing) {
        const growing = profile.currentlyGrowing.split(',').map(s => s.trim()).filter(s => s);
        if (growing.length > 0) {
            text += `Currently growing: ${growing.join(', ')}\n`;
        }
    }

    // Check garden data for ready to harvest
    const readyToHarvest = garden.filter(g => g.status === 'ready' || g.readyToHarvest);
    if (readyToHarvest.length > 0) {
        text += `READY TO HARVEST: ${readyToHarvest.map(g => g.name).join(', ')}\n`;
        text += '(Prioritize these fresh ingredients in recipes!)';
    }

    return text || 'No garden data available.';
}

// ========================================
// VOICE INPUT
// ========================================
function initVoiceRecognition() {
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    if (SpeechRecognition) {
        state.recognition = new SpeechRecognition();
        state.recognition.continuous = false;
        state.recognition.interimResults = false;
        state.recognition.lang = 'en-US';

        state.recognition.onresult = (event) => {
            const text = event.results[0][0].transcript;
            document.getElementById('chat-input').value = text;
            stopRecording();
        };
        state.recognition.onerror = () => stopRecording();
        state.recognition.onend = () => stopRecording();
    } else {
        const btn = document.getElementById('voice-btn');
        if (btn) btn.style.display = 'none';
    }
}

function toggleVoiceInput() {
    if (state.isRecording) stopRecording();
    else startRecording();
}

function startRecording() {
    if (!state.recognition) return;
    state.isRecording = true;
    document.getElementById('voice-btn').classList.add('recording');
    state.recognition.start();
}

function stopRecording() {
    state.isRecording = false;
    const btn = document.getElementById('voice-btn');
    if (btn) btn.classList.remove('recording');
    if (state.recognition) {
        try { state.recognition.stop(); } catch (e) {}
    }
}

// ========================================
// RECIPE LIBRARY
// ========================================
function saveRecipeToLibrary(recipe) {
    const library = getStorage(STORAGE.RECIPES) || [];

    // Check for exact ID match first
    const existingById = library.findIndex(r => r.id === recipe.id);
    if (existingById >= 0) {
        library[existingById] = { ...library[existingById], ...recipe };
        setStorage(STORAGE.RECIPES, library);
        return { updated: true, id: recipe.id };
    }

    // Check for duplicate by normalized title (fuzzy matching)
    const normalizedTitle = normalizeRecipeTitle(recipe.title);
    const duplicateIdx = library.findIndex(r => normalizeRecipeTitle(r.title) === normalizedTitle);

    if (duplicateIdx >= 0) {
        // Update existing recipe instead of creating duplicate
        const existingRecipe = library[duplicateIdx];
        library[duplicateIdx] = {
            ...existingRecipe,
            ...recipe,
            id: existingRecipe.id, // Keep original ID
            timesCooked: existingRecipe.timesCooked || 0,
            rating: existingRecipe.rating || recipe.rating || 0,
            averageRating: existingRecipe.averageRating || 0,
            cookingHistory: existingRecipe.cookingHistory || [],
            favorited: existingRecipe.favorited || recipe.favorited,
            dateGenerated: existingRecipe.dateGenerated // Keep original date
        };
        setStorage(STORAGE.RECIPES, library);
        return { updated: true, id: existingRecipe.id };
    }

    // No duplicate found, add as new
    library.unshift(recipe);
    setStorage(STORAGE.RECIPES, library);
    return { updated: false, id: recipe.id };
}

function normalizeRecipeTitle(title) {
    if (!title) return '';
    // Remove common suffixes like (COMPLETE), (UPDATED), (FINAL), (PERFECT VERSION), etc.
    return title
        .replace(/\s*\((?:COMPLETE|UPDATED|FINAL|PERFECT|NEW|REVISED|V\d+|VERSION\s*\d*)\)\s*$/i, '')
        .replace(/\s*-\s*(?:COMPLETE|UPDATED|FINAL|PERFECT|NEW|REVISED)$/i, '')
        .replace(/\s+/g, ' ')
        .trim()
        .toLowerCase();
}

// Save recipe explicitly from chat (when user clicks Save button)
function saveRecipeFromChat(recipeId) {
    const pendingRecipe = window.pendingRecipes?.[recipeId];
    if (!pendingRecipe) {
        showToast('Recipe not found');
        return;
    }

    const result = saveRecipeToLibrary(pendingRecipe);

    // Update button to show saved state
    const saveBtn = document.getElementById(`save-btn-${recipeId}`);
    if (saveBtn) {
        saveBtn.innerHTML = icon('check-circle',14) + ' Saved!';
        saveBtn.disabled = true;
        saveBtn.classList.remove('btn-primary');
        saveBtn.classList.add('btn-ghost');
    }

    if (result.updated) {
        showToast('Recipe updated in library!');
    } else {
        showToast('Recipe saved to library!');
    }
}

// Favorite recipe from chat (saves and favorites)
function favoriteRecipeFromChat(recipeId) {
    const pendingRecipe = window.pendingRecipes?.[recipeId];
    if (!pendingRecipe) {
        // Maybe already saved, try to favorite existing
        toggleFavoriteFromCard(recipeId, null);
        return;
    }

    pendingRecipe.favorited = true;
    saveRecipeToLibrary(pendingRecipe);

    // Update save button
    const saveBtn = document.getElementById(`save-btn-${recipeId}`);
    if (saveBtn) {
        saveBtn.innerHTML = icon('check-circle',14) + ' Saved!';
        saveBtn.disabled = true;
        saveBtn.classList.remove('btn-primary');
        saveBtn.classList.add('btn-ghost');
    }

    showToast(`${icon('heart',14)} Recipe favorited and saved!`);
}

// Add to week from chat (saves and opens week modal)
function addToWeekFromChat(recipeId) {
    const pendingRecipe = window.pendingRecipes?.[recipeId];
    if (pendingRecipe) {
        saveRecipeToLibrary(pendingRecipe);

        // Update save button
        const saveBtn = document.getElementById(`save-btn-${recipeId}`);
        if (saveBtn) {
            saveBtn.innerHTML = icon('check-circle',14) + ' Saved!';
            saveBtn.disabled = true;
            saveBtn.classList.remove('btn-primary');
            saveBtn.classList.add('btn-ghost');
        }
    }

    openAddToWeekModal(recipeId);
}

function getRecipeLibrary() {
    return getStorage(STORAGE.RECIPES) || [];
}

function renderRecipeLibrary() {
    const library = getRecipeLibrary();
    const grid = document.getElementById('recipes-grid');
    const empty = document.getElementById('recipes-empty');

    // Populate tag filter chips
    populateTagFilterChips();

    if (library.length === 0) {
        grid.innerHTML = '';
        empty.classList.remove('hidden');
        return;
    }

    empty.classList.add('hidden');
    filterRecipeLibrary(); // Use filter function to respect any active filters
}

function renderLibraryCard(recipe) {
    const meta = recipe.metadata || {};
    const avgRating = recipe.averageRating || recipe.rating || 0;
    const timesCooked = recipe.timesCooked || 0;
    const nutrition = recipe.nutrition || {};

    // Generate star display
    const starDisplay = avgRating > 0 ? renderStarsDisplay(avgRating) : '';
    const cookedText = timesCooked > 0 ? `Cooked ${timesCooked}x` : '';

    // Get tags and apply styling
    const tags = meta.tags || [];
    const tagsHtml = tags.slice(0, 4).map(tag => {
        const tagClass = getTagClass(tag);
        return `<span class="tag ${tagClass}">${tag}</span>`;
    }).join('');

    // Nutrition display
    const caloriesHtml = nutrition.calories ? `<span class="card-calories">${icon('flame',14)} ${nutrition.calories} cal</span>` : '';
    const macrosHtml = (nutrition.protein || nutrition.carbs || nutrition.fat) ?
        `<div class="card-macros">${nutrition.protein ? nutrition.protein + 'g protein' : ''}${nutrition.carbs ? ' Â· ' + nutrition.carbs + 'g carbs' : ''}${nutrition.fat ? ' Â· ' + nutrition.fat + 'g fat' : ''}</div>` : '';

    const isEditMode = state.recipeEditMode;
    const isSelected = state.selectedRecipes?.has(recipe.id);
    const editModeClass = isEditMode ? 'edit-mode' : '';
    const selectedClass = isSelected ? 'selected' : '';
    const clickHandler = isEditMode ? `toggleRecipeSelection('${recipe.id}')` : `viewRecipeDetail('${recipe.id}')`;

    return `
        <div class="library-card ${editModeClass} ${selectedClass}" onclick="${clickHandler}" data-recipe-id="${recipe.id}">
            <div class="library-card-banner">
                ${icon('utensils',14)}
                ${recipe.favorited ? `<span class="library-card-favorite">${icon('heart',14,'color:var(--accent-warm);fill:var(--accent-warm)')}</span>` : ''}
                ${caloriesHtml}
            </div>
            <div class="library-card-body">
                <div class="library-card-title">${recipe.title}</div>
                ${starDisplay ? `<div class="library-card-rating">${starDisplay}</div>` : ''}
                <div class="library-card-meta">
                    <span>${icon('timer',14)} ${meta.totalTime || 30}min</span>
                    <span>${icon('utensils',14)} ${meta.serves || 2}</span>
                    ${cookedText ? `<span>${icon('chef-hat',14)} ${cookedText}</span>` : ''}
                </div>
                ${macrosHtml}
                <div class="library-card-tags">
                    ${tagsHtml || '<span class="tag tag-mediterranean">Mediterranean</span>'}
                </div>
            </div>
        </div>
    `;
}

function renderStarsDisplay(rating) {
    const fullStars = Math.floor(rating);
    const hasHalf = rating % 1 >= 0.5;
    const emptyStars = 5 - fullStars - (hasHalf ? 1 : 0);

    let stars = 'â˜…'.repeat(fullStars);
    if (hasHalf) stars += 'Â½';
    stars += 'â˜†'.repeat(emptyStars);

    return `${stars} (${rating.toFixed(1)})`;
}

function filterRecipeLibrary() {
    const search = document.getElementById('recipes-search').value.toLowerCase();
    const sort = document.getElementById('recipes-sort').value;
    const protein = document.getElementById('recipes-protein').value;
    const time = document.getElementById('recipes-time').value;

    let library = getRecipeLibrary();

    // Filter by search
    if (search) {
        library = library.filter(r => r.title.toLowerCase().includes(search) ||
            r.ingredients?.some(i => i.toLowerCase().includes(search)));
    }

    // Filter by protein
    if (protein) {
        library = library.filter(r => r.metadata?.proteinType === protein);
    }

    // Filter by time
    if (time) {
        library = library.filter(r => {
            const t = r.metadata?.totalTime || 30;
            if (time === 'quick') return t < 30;
            if (time === 'standard') return t >= 30 && t <= 60;
            if (time === 'long') return t > 60;
            return true;
        });
    }

    // Filter by tags
    if (state.selectedTagFilters.size > 0) {
        library = library.filter(r => {
            const recipeTags = r.metadata?.tags || [];
            // Recipe must have ALL selected tags
            return Array.from(state.selectedTagFilters).every(tag =>
                recipeTags.some(t => t.toLowerCase() === tag.toLowerCase())
            );
        });
    }

    // Sort
    if (sort === 'rating') {
        // Use averageRating first, then single rating for backwards compatibility
        library.sort((a, b) => (b.averageRating || b.rating || 0) - (a.averageRating || a.rating || 0));
    } else if (sort === 'cooked') {
        library.sort((a, b) => (b.timesCooked || 0) - (a.timesCooked || 0));
    } else if (sort === 'time') {
        library.sort((a, b) => (a.metadata?.totalTime || 30) - (b.metadata?.totalTime || 30));
    } else if (sort === 'name') {
        library.sort((a, b) => a.title.localeCompare(b.title));
    } else {
        library.sort((a, b) => new Date(b.dateGenerated) - new Date(a.dateGenerated));
    }

    const grid = document.getElementById('recipes-grid');
    grid.innerHTML = library.map(recipe => renderLibraryCard(recipe)).join('');

    const empty = document.getElementById('recipes-empty');
    empty.classList.toggle('hidden', library.length > 0);
}

function populateTagFilterChips() {
    const library = getRecipeLibrary();
    const allTags = new Map(); // tag -> count

    // Collect all tags from all recipes
    library.forEach(recipe => {
        const tags = recipe.metadata?.tags || [];
        tags.forEach(tag => {
            allTags.set(tag, (allTags.get(tag) || 0) + 1);
        });
    });

    // Sort by frequency, then alphabetically
    const sortedTags = Array.from(allTags.entries())
        .sort((a, b) => b[1] - a[1] || a[0].localeCompare(b[0]))
        .slice(0, 15); // Limit to 15 most common tags

    const container = document.getElementById('tag-filter-chips');
    if (!container) return;

    container.innerHTML = sortedTags.map(([tag, count]) => {
        const isActive = state.selectedTagFilters.has(tag);
        return `<span class="tag-filter-chip ${isActive ? 'active' : ''}" onclick="toggleTagFilter('${tag}')">${tag} (${count})</span>`;
    }).join('');

    // Show/hide clear button
    const clearBtn = document.getElementById('tag-filter-clear');
    if (clearBtn) {
        clearBtn.classList.toggle('visible', state.selectedTagFilters.size > 0);
    }
}

function toggleTagFilter(tag) {
    if (state.selectedTagFilters.has(tag)) {
        state.selectedTagFilters.delete(tag);
    } else {
        state.selectedTagFilters.add(tag);
    }
    populateTagFilterChips();
    filterRecipeLibrary();
}

function clearTagFilters() {
    state.selectedTagFilters.clear();
    populateTagFilterChips();
    filterRecipeLibrary();
}

function toggleFilterDropdown() {
    document.getElementById('recipe-filters').classList.toggle('open');
}

// ========================================
// BULK RECIPE MANAGEMENT
// ========================================
function toggleRecipeEditMode() {
    state.recipeEditMode = !state.recipeEditMode;
    state.selectedRecipes = new Set();

    const editBtn = document.getElementById('recipes-edit-btn');
    const bulkBar = document.getElementById('recipes-bulk-bar');

    if (state.recipeEditMode) {
        editBtn.textContent = 'Done';
        editBtn.classList.add('btn-primary');
        editBtn.classList.remove('btn-ghost');
        bulkBar.classList.remove('hidden');
    } else {
        editBtn.textContent = 'Edit';
        editBtn.classList.remove('btn-primary');
        editBtn.classList.add('btn-ghost');
        bulkBar.classList.add('hidden');
    }

    filterRecipeLibrary(); // Re-render cards with edit mode
    updateBulkCount();
}

function toggleRecipeSelection(recipeId) {
    if (state.selectedRecipes.has(recipeId)) {
        state.selectedRecipes.delete(recipeId);
    } else {
        state.selectedRecipes.add(recipeId);
    }

    // Update card visual
    const card = document.querySelector(`.library-card[data-recipe-id="${recipeId}"]`);
    if (card) {
        card.classList.toggle('selected', state.selectedRecipes.has(recipeId));
    }

    updateBulkCount();
}

function updateBulkCount() {
    const countEl = document.getElementById('bulk-selected-count');
    if (countEl) {
        countEl.textContent = state.selectedRecipes.size;
    }
}

function bulkSelectAll() {
    const library = getRecipeLibrary();
    library.forEach(r => state.selectedRecipes.add(r.id));
    filterRecipeLibrary();
    updateBulkCount();
}

function bulkDeselectAll() {
    state.selectedRecipes.clear();
    filterRecipeLibrary();
    updateBulkCount();
}

function bulkAddToFavorites() {
    if (state.selectedRecipes.size === 0) {
        showToast('No recipes selected');
        return;
    }

    const library = getRecipeLibrary();
    let count = 0;
    state.selectedRecipes.forEach(id => {
        const recipe = library.find(r => r.id === id);
        if (recipe && !recipe.favorited) {
            recipe.favorited = true;
            count++;
        }
    });

    setStorage(STORAGE.RECIPES, library);
    filterRecipeLibrary();
    renderFavorites();
    showToast(`${icon('heart',14)} ${count} recipe${count !== 1 ? 's' : ''} added to favorites`);
}

function bulkRemoveFromFavorites() {
    if (state.selectedRecipes.size === 0) {
        showToast('No recipes selected');
        return;
    }

    const library = getRecipeLibrary();
    let count = 0;
    state.selectedRecipes.forEach(id => {
        const recipe = library.find(r => r.id === id);
        if (recipe && recipe.favorited) {
            recipe.favorited = false;
            count++;
        }
    });

    setStorage(STORAGE.RECIPES, library);
    filterRecipeLibrary();
    renderFavorites();
    showToast(`${count} recipe${count !== 1 ? 's' : ''} removed from favorites`);
}

function bulkDeleteRecipes() {
    if (state.selectedRecipes.size === 0) {
        showToast('No recipes selected');
        return;
    }

    const count = state.selectedRecipes.size;

    // Check if any are planned
    const mealPlans = getStorage(STORAGE.MEAL_PLANS) || {};
    const weekDates = getWeekDates(state.currentWeekOffset);
    const plannedIds = new Set(weekDates.map(d => mealPlans[d]?.recipeId).filter(Boolean));

    const plannedSelection = [...state.selectedRecipes].filter(id => plannedIds.has(id));

    if (plannedSelection.length > 0) {
        openModal(`
            <div class="modal-header">
                <h2 class="modal-title">Cannot Delete All</h2>
                <button class="modal-close" onclick="closeModal()">Ã—</button>
            </div>
            <div class="modal-body">
                <p>${plannedSelection.length} of the selected recipes are planned for this week. Remove them from your meal plan first.</p>
            </div>
            <div class="modal-footer">
                <button class="btn btn-primary" onclick="closeModal()">OK</button>
            </div>
        `);
        return;
    }

    openModal(`
        <div class="modal-header">
            <h2 class="modal-title">Delete ${count} Recipe${count !== 1 ? 's' : ''}?</h2>
            <button class="modal-close" onclick="closeModal()">Ã—</button>
        </div>
        <div class="modal-body">
            <p>This will permanently delete <strong>${count} recipe${count !== 1 ? 's' : ''}</strong> from your library.</p>
            <p class="text-muted mt-8">This action cannot be undone. All ratings and cooking history will be lost.</p>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
            <button class="btn btn-primary" style="background: var(--danger);" onclick="confirmBulkDelete()">Delete ${count} Recipe${count !== 1 ? 's' : ''}</button>
        </div>
    `);
}

function confirmBulkDelete() {
    let library = getRecipeLibrary();
    const deletedCount = state.selectedRecipes.size;

    // Store for potential undo
    const deletedRecipes = library.filter(r => state.selectedRecipes.has(r.id));

    library = library.filter(r => !state.selectedRecipes.has(r.id));
    setStorage(STORAGE.RECIPES, library);

    state.selectedRecipes.clear();
    closeModal();
    filterRecipeLibrary();
    renderFavorites();
    updateBulkCount();

    showToast(`${icon('trash-2',14)} ${deletedCount} recipe${deletedCount !== 1 ? 's' : ''} deleted`);
}

function viewRecipeDetail(recipeId) {
    const library = getRecipeLibrary();
    const recipe = library.find(r => r.id === recipeId);
    if (!recipe) return;

    const meta = recipe.metadata || {};
    const nutrition = recipe.nutrition || {};
    const tags = meta.tags || recipe.tags || [];
    const rating = recipe.averageRating || recipe.rating || 0;
    const privacyBadge = recipe.privacy === 'family'
        ? `<span class="badge badge-family">${icon('users',14)} Family</span>`
        : `<span class="badge badge-private">${icon('lock',14)} Private</span>`;

    openModal(`
        <div class="modal-header">
            <div>
                <h2 class="modal-title" id="modal-title-label">${recipe.title}</h2>
                <div class="recipe-modal-meta">
                    ${privacyBadge}
                    ${rating > 0 ? `<span class="badge badge-success">${renderStarsDisplay(rating)}</span>` : ''}
                    ${recipe.timesCooked > 0 ? `<span class="badge">${icon('chef-hat',14)} Cooked ${recipe.timesCooked}x</span>` : ''}
                </div>
            </div>
            <button class="modal-close" onclick="closeModal()" aria-label="Close modal">Ã—</button>
        </div>
        <div class="recipe-detail-body" id="recipe-print-area">
            ${renderRecipeDetailContent(recipe)}
        </div>
        <div class="recipe-detail-footer">
            <button class="btn btn-ghost btn-sm" onclick="printRecipe('${recipeId}')">
                <i data-lucide="printer"></i> Print
            </button>
            <button class="btn btn-ghost btn-sm" onclick="toggleFavoriteFromCard('${recipeId}')" title="${recipe.favorited ? 'Remove from favorites' : 'Add to favorites'}">
                ${recipe.favorited ? icon('heart',14,'color:var(--accent-warm);fill:var(--accent-warm)') : icon('heart',14)} Favorite
            </button>
            <button class="btn btn-ghost btn-sm" onclick="openShareRecipeModal('${recipeId}')">
                <i data-lucide="share-2"></i> Share
            </button>
            <button class="btn btn-secondary btn-sm" onclick="closeModal(); assignRecipeToSlotFromLibrary('${recipeId}')">
                <i data-lucide="calendar"></i> Add to Week
            </button>
            ${recipe.instructions && recipe.instructions.length > 0 ? `
                <button class="btn btn-primary btn-sm" onclick="startCookMode('${recipeId}')">
                    <i data-lucide="chef-hat"></i> Cook Now
                </button>
            ` : ''}
        </div>
    `, { maxWidth: '700px' });
}

// Render the inner content of a recipe detail modal
function renderRecipeDetailContent(recipe) {
    const meta = recipe.metadata || {};
    const nutrition = recipe.nutrition || {};
    const ingredients = recipe.ingredients || [];
    const instructions = recipe.instructions || [];
    const tags = meta.tags || recipe.tags || [];

    // If we only have rawContent and no parsed data, show parsed card
    if ((!ingredients.length && !instructions.length) && recipe.rawContent) {
        return parseRecipeToCard(recipe.rawContent);
    }

    // Meta info bar
    const metaHTML = `
        <div class="recipe-detail-meta">
            <div class="meta-item"><i data-lucide="clock"></i> ${meta.totalTime || meta.cookTime || 30} min total</div>
            <div class="meta-item"><i data-lucide="users"></i> Serves ${meta.serves || recipe.servings || 2}</div>
            ${meta.prepTime ? `<div class="meta-item"><i data-lucide="timer"></i> ${meta.prepTime} min prep</div>` : ''}
            ${meta.cookTime ? `<div class="meta-item"><i data-lucide="flame"></i> ${meta.cookTime} min cook</div>` : ''}
            ${meta.proteinType ? `<div class="meta-item"><i data-lucide="beef"></i> ${meta.proteinType}</div>` : ''}
        </div>
    `;

    // Tags
    const tagsHTML = tags.length > 0 ? `
        <div class="recipe-detail-tags">
            ${tags.map(tag => `<span class="tag ${getTagClass(tag)}">${tag}</span>`).join('')}
        </div>
    ` : '';

    // Nutrition grid
    const nutritionHTML = (nutrition.calories || nutrition.protein) ? `
        <div class="recipe-detail-section">
            <h3 class="section-title"><i data-lucide="activity"></i> Nutrition <small style="font-weight:normal;color:var(--gray-text)">(per serving)</small></h3>
            <div class="nutrition-grid">
                ${nutrition.calories ? `<div class="nutrition-card"><div class="nutrition-value">${nutrition.calories}</div><div class="nutrition-label">Calories</div></div>` : ''}
                ${nutrition.protein ? `<div class="nutrition-card"><div class="nutrition-value">${nutrition.protein}g</div><div class="nutrition-label">Protein</div></div>` : ''}
                ${nutrition.carbs ? `<div class="nutrition-card"><div class="nutrition-value">${nutrition.carbs}g</div><div class="nutrition-label">Carbs</div></div>` : ''}
                ${nutrition.fat ? `<div class="nutrition-card"><div class="nutrition-value">${nutrition.fat}g</div><div class="nutrition-label">Fat</div></div>` : ''}
                ${nutrition.fiber ? `<div class="nutrition-card"><div class="nutrition-value">${nutrition.fiber}g</div><div class="nutrition-label">Fiber</div></div>` : ''}
                ${nutrition.sodium ? `<div class="nutrition-card"><div class="nutrition-value">${nutrition.sodium}mg</div><div class="nutrition-label">Sodium</div></div>` : ''}
            </div>
        </div>
    ` : '';

    // Ingredients
    const ingredientsHTML = ingredients.length > 0 ? `
        <div class="recipe-detail-section">
            <h3 class="section-title"><i data-lucide="shopping-basket"></i> Ingredients</h3>
            <ul class="ingredients-list">
                ${ingredients.map(ing => `<li>${typeof ing === 'object' ? `${ing.amount || ''} ${ing.unit || ''} ${ing.name || ing}`.trim() : ing}</li>`).join('')}
            </ul>
        </div>
    ` : '';

    // Instructions
    const instructionsHTML = instructions.length > 0 ? `
        <div class="recipe-detail-section">
            <h3 class="section-title"><i data-lucide="list-ordered"></i> Instructions</h3>
            <ol class="instructions-list">
                ${instructions.map(step => `<li>${step}</li>`).join('')}
            </ol>
        </div>
    ` : '';

    // Health benefits
    const healthHTML = recipe.healthBenefits ? `
        <div class="recipe-detail-section health-benefits-section">
            <h3 class="section-title"><i data-lucide="heart-pulse"></i> Health Benefits</h3>
            <p style="margin:0;line-height:1.7">${recipe.healthBenefits}</p>
        </div>
    ` : '';

    // Modifications
    const modsHTML = recipe.modifications ? `
        <div class="recipe-detail-section">
            <h3 class="section-title"><i data-lucide="repeat"></i> Modifications</h3>
            <p style="margin:0;line-height:1.7">${recipe.modifications.replace(/\n/g, '<br>')}</p>
        </div>
    ` : '';

    // Notes
    const notesHTML = recipe.notes ? `
        <div class="recipe-detail-section">
            <h3 class="section-title"><i data-lucide="file-text"></i> Personal Notes</h3>
            <p style="margin:0;line-height:1.7;color:var(--gray-text)">${recipe.notes}</p>
        </div>
    ` : '';

    return `
        ${metaHTML}
        ${tagsHTML}
        ${nutritionHTML}
        ${ingredientsHTML}
        ${instructionsHTML}
        ${healthHTML}
        ${modsHTML}
        ${notesHTML}
    `;
}

// ========================================
// SHARE RECIPE MODAL
// ========================================
const ALL_RECIPE_TAGS = {
    health: ["Anti-Inflammatory", "Heart-Healthy", "Low-Sodium", "Crohn's-Friendly", "High-Protein", "Gut-Friendly", "Diabetic-Friendly"],
    dietary: ["Vegetarian", "Vegan", "Gluten-Free", "Dairy-Free", "Low-Carb", "Mediterranean"],
    cuisine: ["Spanish", "Italian", "Greek", "Levantine", "North African", "American"],
    mealType: ["Breakfast", "Lunch", "Dinner", "Snack", "Dessert", "Batch Cooking", "Quick Meals"],
    method: ["One-Pot", "Sheet Pan", "Slow Cooker", "Instant Pot", "Grill", "Air Fryer"]
};

function openShareRecipeModal(recipeId) {
    const library = getRecipeLibrary();
    const recipe = library.find(r => r.id === recipeId);
    if (!recipe) return;

    const recipeTags = recipe.metadata?.tags || recipe.tags || [];

    function renderTagGroup(label, tags) {
        return `
            <div style="margin-bottom:12px">
                <div style="font-weight:500;font-size:0.85rem;margin-bottom:6px;color:var(--olive-green)">${label}</div>
                <div class="tag-selection-grid">
                    ${tags.map(tag => {
                        const checked = recipeTags.includes(tag);
                        return `<label class="tag-selection-chip ${checked ? 'selected' : ''}">
                            <input type="checkbox" value="${tag}" ${checked ? 'checked' : ''} onchange="this.parentElement.classList.toggle('selected',this.checked)">
                            <span>${tag}</span>
                        </label>`;
                    }).join('')}
                </div>
            </div>
        `;
    }

    openModal(`
        <div class="modal-header">
            <h2 class="modal-title" id="modal-title-label">Share "${recipe.title}"</h2>
            <button class="modal-close" onclick="closeModal()" aria-label="Close">Ã—</button>
        </div>
        <div class="modal-body" style="max-height:65vh;overflow-y:auto">
            <div class="form-group" style="margin-bottom:20px">
                <label style="font-weight:600;margin-bottom:8px;display:block">Privacy</label>
                <div class="radio-group">
                    <label class="radio-item">
                        <input type="radio" name="share-privacy" value="private" ${recipe.privacy !== 'family' ? 'checked' : ''}>
                        <div>
                            <div class="radio-label">${icon('lock',14)} Private</div>
                            <div class="radio-desc">Only you can see this recipe</div>
                        </div>
                    </label>
                    <label class="radio-item">
                        <input type="radio" name="share-privacy" value="family" ${recipe.privacy === 'family' ? 'checked' : ''}>
                        <div>
                            <div class="radio-label">${icon('users',14)} Family Tavola</div>
                            <div class="radio-desc">Share with your family: everyone can see, rate, and cook it</div>
                        </div>
                    </label>
                </div>
            </div>

            <div class="form-group" style="margin-bottom:20px">
                <label style="font-weight:600;margin-bottom:8px;display:block">Tags</label>
                <div id="share-tag-selection">
                    ${renderTagGroup('Health', ALL_RECIPE_TAGS.health)}
                    ${renderTagGroup('Dietary', ALL_RECIPE_TAGS.dietary)}
                    ${renderTagGroup('Cuisine', ALL_RECIPE_TAGS.cuisine)}
                    ${renderTagGroup('Meal Type', ALL_RECIPE_TAGS.mealType)}
                    ${renderTagGroup('Cooking Method', ALL_RECIPE_TAGS.method)}
                </div>
            </div>

            <div class="form-group">
                <label style="font-weight:600;margin-bottom:8px;display:block">Personal Note (optional)</label>
                <textarea class="form-input" id="share-personal-note" rows="3" placeholder="Why you love this recipe, tips for your family..."
                    style="width:100%;resize:vertical">${recipe.shareNotes || ''}</textarea>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
            <button class="btn btn-primary" onclick="saveShareSettings('${recipeId}')">
                <i data-lucide="save"></i> Save
            </button>
        </div>
    `, { maxWidth: '650px' });
}

function saveShareSettings(recipeId) {
    const library = getRecipeLibrary();
    const recipe = library.find(r => r.id === recipeId);
    if (!recipe) return;

    // Get privacy selection
    const privacy = document.querySelector('input[name="share-privacy"]:checked')?.value || 'private';

    // Get selected tags
    const selectedTags = Array.from(document.querySelectorAll('#share-tag-selection input[type="checkbox"]:checked'))
        .map(cb => cb.value);

    // Get personal note
    const note = document.getElementById('share-personal-note')?.value?.trim() || '';

    // Update recipe
    recipe.privacy = privacy;
    recipe.shareNotes = note;
    if (!recipe.metadata) recipe.metadata = {};
    recipe.metadata.tags = selectedTags;
    recipe.tags = selectedTags;
    recipe.updatedAt = new Date().toISOString();

    // Add sharedBy info if sharing to family
    if (privacy === 'family' && state.user) {
        recipe.sharedBy = {
            userId: state.user.uid,
            displayName: state.user.displayName || state.user.email?.split('@')[0] || 'Family Member',
            email: state.user.email
        };
        recipe.sharedAt = new Date().toISOString();
    }

    setStorage(STORAGE.RECIPES, library);

    // Sync to family Firestore collection if sharing
    if (privacy === 'family' && state.user) {
        syncRecipeToFamily(recipe);
        showToast(`Shared to Family Tavola! ${icon('sparkles',14)}`, 'success');
    } else {
        showToast('Recipe settings saved', 'success');
    }

    closeModal();
    renderRecipeLibrary();
}

// Enhanced print recipe
function printRecipe(recipeId) {
    // Focus on recipe-print-area if it exists, then print
    const printArea = document.getElementById('recipe-print-area');
    if (printArea) {
        window.print();
    }
}

// ========================================
// FAVORITES
// ========================================
function getFavorites() {
    const library = getRecipeLibrary();
    return library.filter(r => r.favorited);
}

function toggleFavoriteFromCard(recipeId, btn) {
    const library = getRecipeLibrary();
    const recipe = library.find(r => r.id === recipeId);
    if (!recipe) return;

    recipe.favorited = !recipe.favorited;
    setStorage(STORAGE.RECIPES, library);

    if (btn) btn.classList.toggle('favorited', recipe.favorited);

    showToast(recipe.favorited ? `${icon('heart',14)} Added to favorites!` : 'Removed from favorites');
}

function renderFavorites() {
    const favorites = getFavorites();
    const grid = document.getElementById('favorites-grid');
    const empty = document.getElementById('favorites-empty');

    if (favorites.length === 0) {
        grid.innerHTML = '';
        empty.classList.remove('hidden');
        return;
    }

    empty.classList.add('hidden');
    grid.innerHTML = favorites.map(recipe => renderLibraryCard(recipe)).join('');
}

function filterFavorites() {
    const search = document.getElementById('favorites-search').value.toLowerCase();
    let favorites = getFavorites();
    if (search) {
        favorites = favorites.filter(f => f.title.toLowerCase().includes(search));
    }
    const grid = document.getElementById('favorites-grid');
    grid.innerHTML = favorites.map(recipe => renderLibraryCard(recipe)).join('');
}

function sortFavorites() {
    renderFavorites();
}

// ========================================
// FAMILY TAVOLA - SHARED RECIPE LIBRARY
// ========================================

let familyTagFilters = new Set();

function switchRecipesTab(tab) {
    state.currentRecipesTab = tab;

    // Update tab buttons
    document.getElementById('tab-my-recipes').classList.toggle('active', tab === 'my');
    document.getElementById('tab-family-recipes').classList.toggle('active', tab === 'family');

    // Show/hide headers
    document.getElementById('recipes-header-my').style.display = tab === 'my' ? '' : 'none';
    document.getElementById('recipes-header-family').style.display = tab === 'family' ? '' : 'none';

    // Show/hide tab content
    document.getElementById('recipes-tab-my').style.display = tab === 'my' ? '' : 'none';
    document.getElementById('recipes-tab-family').style.display = tab === 'family' ? '' : 'none';

    if (tab === 'family') {
        renderFamilyRecipes();
    } else {
        renderRecipeLibrary();
    }
}

// Sync a recipe to the shared Firestore "recipes" collection
async function syncRecipeToFamily(recipe) {
    if (!state.user || recipe.privacy !== 'family') return;

    try {
        await waitForFirebase();
        const familyRecipeRef = window.firestoreDoc(window.firebaseDb, 'recipes', recipe.id);
        await window.firestoreSetDoc(familyRecipeRef, {
            ...recipe,
            sharedBy: recipe.sharedBy || {
                userId: state.user.uid,
                displayName: state.user.displayName || state.user.email?.split('@')[0] || 'Family Member',
                email: state.user.email
            },
            sharedAt: recipe.sharedAt || new Date().toISOString(),
            updatedAt: new Date().toISOString()
        });
        console.log('Recipe synced to Family Tavola:', recipe.title);
    } catch (error) {
        console.error('Failed to sync recipe to family:', error);
        showToast('Could not share to Family Tavola', 'error');
    }
}

// Load all family recipes from Firestore
async function loadFamilyRecipes() {
    if (!state.user) return [];

    try {
        await waitForFirebase();
        const recipesRef = window.firestoreCollection(window.firebaseDb, 'recipes');
        const q = window.firestoreQuery(recipesRef, window.firestoreWhere('privacy', '==', 'family'));
        const snapshot = await window.firestoreGetDocs(q);

        const familyRecipes = [];
        snapshot.forEach(doc => {
            const data = doc.data();
            familyRecipes.push({
                ...data,
                id: doc.id,
                isShared: true,
                isOwner: data.sharedBy?.userId === state.user.uid
            });
        });
        return familyRecipes;
    } catch (error) {
        console.error('Failed to load family recipes:', error);
        return [];
    }
}

// Set up real-time listener for family recipes
function setupFamilyRecipesListener() {
    if (!state.user || state._familyListenerActive) return;

    try {
        const recipesRef = window.firestoreCollection(window.firebaseDb, 'recipes');
        const q = window.firestoreQuery(recipesRef, window.firestoreWhere('privacy', '==', 'family'));

        window.firestoreOnSnapshot(q, (snapshot) => {
            if (!state.familyRecipes) state.familyRecipes = [];

            snapshot.docChanges().forEach(change => {
                const data = change.doc.data();
                const recipe = { ...data, id: change.doc.id, isShared: true, isOwner: data.sharedBy?.userId === state.user?.uid };

                if (change.type === 'added' || change.type === 'modified') {
                    const idx = state.familyRecipes.findIndex(r => r.id === recipe.id);
                    if (idx >= 0) state.familyRecipes[idx] = recipe;
                    else state.familyRecipes.push(recipe);
                } else if (change.type === 'removed') {
                    state.familyRecipes = state.familyRecipes.filter(r => r.id !== change.doc.id);
                }
            });

            // Refresh view if on Family tab
            if (state.currentRecipesTab === 'family') {
                displayFamilyRecipes(state.familyRecipes);
            }
        });

        state._familyListenerActive = true;
        console.log('Family recipes listener active');
    } catch (error) {
        console.error('Failed to setup family listener:', error);
    }
}

// Render family recipes (with loading state)
async function renderFamilyRecipes() {
    const grid = document.getElementById('family-recipes-grid');
    const empty = document.getElementById('family-recipes-empty');
    if (!grid) return;

    // Show loading skeletons
    grid.innerHTML = Array(4).fill('<div class="skeleton skeleton-card"></div>').join('');
    empty.style.display = 'none';

    // Use cached data if available, otherwise load
    if (!state.familyRecipes) {
        state.familyRecipes = await loadFamilyRecipes();
    }

    displayFamilyRecipes(state.familyRecipes);
    populateFamilyTagFilters();
}

function displayFamilyRecipes(recipes) {
    const grid = document.getElementById('family-recipes-grid');
    const empty = document.getElementById('family-recipes-empty');
    if (!grid) return;

    // Apply filters
    let filtered = applyFamilyFilters(recipes);

    if (filtered.length === 0) {
        grid.innerHTML = '';
        empty.style.display = '';
        return;
    }

    empty.style.display = 'none';
    grid.innerHTML = filtered.map(recipe => renderFamilyRecipeCard(recipe)).join('');
    refreshIcons();
}

function applyFamilyFilters(recipes) {
    const search = document.getElementById('family-search')?.value?.toLowerCase() || '';
    const sort = document.getElementById('family-sort')?.value || 'recent';

    let filtered = [...recipes];

    // Search
    if (search) {
        filtered = filtered.filter(r =>
            r.title?.toLowerCase().includes(search) ||
            r.ingredients?.some(i => (typeof i === 'string' ? i : i.name || '').toLowerCase().includes(search))
        );
    }

    // Tag filters
    if (familyTagFilters.size > 0) {
        filtered = filtered.filter(r => {
            const tags = (r.metadata?.tags || r.tags || []).map(t => t.toLowerCase());
            return Array.from(familyTagFilters).every(f => tags.includes(f.toLowerCase()));
        });
    }

    // Sort
    switch(sort) {
        case 'rating':
            filtered.sort((a, b) => (b.averageRating || b.rating || 0) - (a.averageRating || a.rating || 0));
            break;
        case 'popular':
            filtered.sort((a, b) => (b.timesCooked || 0) - (a.timesCooked || 0));
            break;
        case 'name':
            filtered.sort((a, b) => (a.title || '').localeCompare(b.title || ''));
            break;
        default: // recent
            filtered.sort((a, b) => new Date(b.sharedAt || b.dateGenerated || 0) - new Date(a.sharedAt || a.dateGenerated || 0));
    }

    return filtered;
}

function renderFamilyRecipeCard(recipe) {
    const meta = recipe.metadata || {};
    const nutrition = recipe.nutrition || {};
    const tags = (meta.tags || recipe.tags || []).slice(0, 3);
    const rating = recipe.averageRating || recipe.rating || 0;
    const sharedByName = recipe.sharedBy?.displayName || recipe.sharedBy?.email?.split('@')[0] || 'Family Member';

    return `
        <div class="library-card" onclick="viewFamilyRecipeDetail('${recipe.id}')" style="cursor:pointer">
            <div class="library-card-banner">
                ${icon('utensils',14)}
                <span class="card-calories">${nutrition.calories ? icon('flame',14) + ' ' + nutrition.calories + ' cal' : icon('users',14) + ' Family'}</span>
            </div>
            <div class="library-card-body">
                <div class="library-card-title">${recipe.title}</div>
                ${rating > 0 ? `<div style="color:var(--star-gold);font-size:0.85rem">${'â˜…'.repeat(Math.round(rating))}${'â˜†'.repeat(5-Math.round(rating))} (${rating.toFixed?.(1) || rating})</div>` : ''}
                <div class="library-card-meta">
                    <span>${icon('timer',14)} ${meta.totalTime || meta.cookTime || 30}min</span>
                    <span>${icon('utensils',14)} ${meta.serves || recipe.servings || 2}</span>
                    ${recipe.timesCooked > 0 ? `<span>${icon('chef-hat',14)} ${recipe.timesCooked}x</span>` : ''}
                </div>
                <div class="family-recipe-shared-by">
                    <i data-lucide="user"></i> Shared by ${sharedByName}
                </div>
                <div class="library-card-tags" style="margin-top:6px">
                    ${tags.map(tag => `<span class="tag ${getTagClass(tag)}">${tag}</span>`).join('')}
                </div>
            </div>
        </div>
    `;
}

// View full family recipe with ratings
async function viewFamilyRecipeDetail(recipeId) {
    // Show loading modal
    openModal(`
        <div style="padding:40px;text-align:center">
            <div class="loading-spinner" style="margin:0 auto 16px"></div>
            <p style="color:var(--gray-text)">Loading recipe...</p>
        </div>
    `);

    // Load recipe with ratings
    const recipe = await loadFamilyRecipeWithRatings(recipeId);
    if (!recipe) {
        closeModal();
        showToast('Recipe not found', 'error');
        return;
    }

    const familyRatings = recipe.familyRatings || [];
    const userRating = familyRatings.find(r => r.userId === state.user?.uid);
    const sharedByName = recipe.sharedBy?.displayName || recipe.sharedBy?.email?.split('@')[0] || 'Family Member';

    openModal(`
        <div class="modal-header">
            <div>
                <h2 class="modal-title" id="modal-title-label">${recipe.title}</h2>
                <div class="recipe-modal-meta">
                    <span class="badge badge-family">${icon('users',14)} Family</span>
                    ${recipe.averageRating > 0 ? `<span class="badge badge-success">${renderStarsDisplay(recipe.averageRating)}</span>` : ''}
                    <span style="font-size:0.85rem;color:var(--gray-text)"><i data-lucide="user"></i> by ${sharedByName}</span>
                </div>
            </div>
            <button class="modal-close" onclick="closeModal()" aria-label="Close">Ã—</button>
        </div>
        <div class="recipe-detail-body" id="recipe-print-area">
            ${renderRecipeDetailContent(recipe)}

            ${recipe.shareNotes ? `
                <div class="recipe-detail-section" style="background:var(--cream);padding:12px 16px;border-radius:var(--radius)">
                    <p style="margin:0;font-style:italic;color:var(--gray-text)">"${recipe.shareNotes}" â€” ${sharedByName}</p>
                </div>
            ` : ''}

            <!-- Family Ratings Section -->
            <div class="recipe-detail-section">
                <h3 class="section-title"><i data-lucide="message-square"></i> Family Reviews (${familyRatings.length})</h3>

                <!-- User rating form -->
                <div class="family-rating-form">
                    <h4>${userRating ? 'Update Your Review' : 'Add Your Review'}</h4>
                    <div class="form-group" style="margin-bottom:12px">
                        <label style="font-size:0.85rem;margin-bottom:4px;display:block">Rating</label>
                        <div class="star-rating" id="user-rating-stars">
                            ${[1,2,3,4,5].map(n => `<span class="star ${(userRating?.rating || 0) >= n ? 'filled' : ''}" onclick="setFamilyRatingStars(${n})">â˜…</span>`).join('')}
                        </div>
                    </div>
                    <div class="form-group" style="margin-bottom:12px">
                        <label style="font-size:0.85rem;margin-bottom:4px;display:block">Comment (optional)</label>
                        <textarea class="form-input" id="family-rating-comment" rows="2" placeholder="What did you think?" style="width:100%;resize:vertical">${userRating?.comment || ''}</textarea>
                    </div>
                    <div class="form-group" style="margin-bottom:12px">
                        <label style="font-size:0.85rem;margin-bottom:4px;display:block">Your Modifications (optional)</label>
                        <textarea class="form-input" id="family-rating-mod" rows="2" placeholder="Any changes you made?" style="width:100%;resize:vertical">${userRating?.modification || ''}</textarea>
                    </div>
                    <button class="btn btn-primary btn-sm" onclick="submitFamilyRating('${recipeId}')">
                        ${userRating ? 'Update Review' : 'Submit Review'}
                    </button>
                </div>

                <!-- Other family ratings -->
                ${familyRatings.filter(r => r.userId !== state.user?.uid).length > 0 ? `
                    <div class="family-ratings-list">
                        ${familyRatings.filter(r => r.userId !== state.user?.uid).map(r => `
                            <div class="family-rating-item">
                                <div class="rating-header">
                                    <span class="rating-user"><i data-lucide="user"></i> ${r.userName || 'Family Member'}</span>
                                    <span class="rating-stars">${'â˜…'.repeat(r.rating)}${'â˜†'.repeat(5 - r.rating)}</span>
                                </div>
                                ${r.comment ? `<p class="rating-comment">${r.comment}</p>` : ''}
                                ${r.modification ? `<div class="rating-modification"><strong>Their twist:</strong> ${r.modification}</div>` : ''}
                            </div>
                        `).join('')}
                    </div>
                ` : '<p style="color:var(--gray-text);font-size:0.9rem">Be the first to review this recipe!</p>'}
            </div>
        </div>
        <div class="recipe-detail-footer">
            <button class="btn btn-ghost btn-sm" onclick="printRecipe('${recipeId}')"><i data-lucide="printer"></i> Print</button>
            ${!recipe.isOwner ? `<button class="btn btn-secondary btn-sm" onclick="saveFamilyToMyRecipes('${recipeId}')"><i data-lucide="download"></i> Save to My Recipes</button>` : ''}
            <button class="btn btn-primary btn-sm" onclick="closeModal(); assignRecipeToSlotFromLibrary('${recipeId}')"><i data-lucide="calendar"></i> Add to Week</button>
        </div>
    `, { maxWidth: '700px' });
}

// Family rating helpers
let _currentFamilyRating = 0;

function setFamilyRatingStars(rating) {
    _currentFamilyRating = rating;
    document.querySelectorAll('#user-rating-stars .star').forEach((star, i) => {
        star.classList.toggle('filled', i < rating);
    });
}

async function submitFamilyRating(recipeId) {
    if (_currentFamilyRating === 0) {
        showToast('Please select a rating', 'warning');
        return;
    }

    const comment = document.getElementById('family-rating-comment')?.value?.trim() || '';
    const modification = document.getElementById('family-rating-mod')?.value?.trim() || '';

    try {
        await waitForFirebase();
        const ratingRef = window.firestoreDoc(window.firebaseDb, `recipes/${recipeId}/ratings`, state.user.uid);
        await window.firestoreSetDoc(ratingRef, {
            userId: state.user.uid,
            userName: state.user.displayName || state.user.email?.split('@')[0] || 'Family Member',
            rating: _currentFamilyRating,
            comment: comment,
            modification: modification,
            createdAt: window.firestoreServerTimestamp()
        });

        showToast('Review saved!', 'success');

        // Reload to show updated ratings
        _currentFamilyRating = 0;
        viewFamilyRecipeDetail(recipeId);
    } catch (error) {
        console.error('Failed to save rating:', error);
        showToast('Could not save review', 'error');
    }
}

// Load a family recipe with its ratings sub-collection
async function loadFamilyRecipeWithRatings(recipeId) {
    if (!state.user) return null;

    try {
        await waitForFirebase();

        // Get recipe
        const recipeRef = window.firestoreDoc(window.firebaseDb, 'recipes', recipeId);
        const recipeSnap = await window.firestoreGetDoc(recipeRef);
        if (!recipeSnap.exists()) {
            // Maybe it's a local recipe
            const library = getRecipeLibrary();
            return library.find(r => r.id === recipeId) || null;
        }

        const recipe = { ...recipeSnap.data(), id: recipeSnap.id, isOwner: recipeSnap.data().sharedBy?.userId === state.user.uid };

        // Get ratings
        const ratingsRef = window.firestoreCollection(window.firebaseDb, `recipes/${recipeId}/ratings`);
        const ratingsSnap = await window.firestoreGetDocs(ratingsRef);
        const ratings = [];
        ratingsSnap.forEach(doc => ratings.push({ ...doc.data(), id: doc.id }));

        recipe.familyRatings = ratings;
        recipe.averageRating = ratings.length > 0
            ? ratings.reduce((sum, r) => sum + r.rating, 0) / ratings.length
            : 0;

        return recipe;
    } catch (error) {
        console.error('Failed to load recipe with ratings:', error);
        return null;
    }
}

// Save a family recipe to your personal library
function saveFamilyToMyRecipes(recipeId) {
    const familyRecipe = state.familyRecipes?.find(r => r.id === recipeId);
    if (!familyRecipe) return;

    const library = getRecipeLibrary();

    // Check for duplicates
    if (library.find(r => r.title === familyRecipe.title)) {
        showToast('You already have a recipe with this name', 'info');
        return;
    }

    const newRecipe = {
        ...familyRecipe,
        id: 'recipe_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9),
        privacy: 'private',
        originalFamilyRecipeId: recipeId,
        dateGenerated: new Date().toISOString(),
        timesCooked: 0,
        rating: 0,
        favorited: false,
        isShared: false,
        isOwner: true
    };

    library.push(newRecipe);
    setStorage(STORAGE.RECIPES, library);
    showToast('Saved to your recipe library!', 'success');
    closeModal();
}

// Populate tag filter chips for family recipes
function populateFamilyTagFilters() {
    if (!state.familyRecipes) return;

    const allTags = new Map();
    state.familyRecipes.forEach(recipe => {
        const tags = recipe.metadata?.tags || recipe.tags || [];
        tags.forEach(tag => allTags.set(tag, (allTags.get(tag) || 0) + 1));
    });

    const sorted = Array.from(allTags.entries())
        .sort((a, b) => b[1] - a[1])
        .slice(0, 15);

    const container = document.getElementById('family-tag-filter-chips');
    const clearBtn = document.getElementById('family-tag-filter-clear');
    if (!container) return;

    container.innerHTML = sorted.map(([tag, count]) => {
        const active = familyTagFilters.has(tag);
        return `<span class="chip ${active ? 'active' : ''}" onclick="toggleFamilyTagFilter('${tag.replace(/'/g, "\\'")}')">${tag} <span class="chip-count">(${count})</span></span>`;
    }).join('');

    if (clearBtn) {
        clearBtn.style.display = familyTagFilters.size > 0 ? 'inline' : 'none';
    }
}

function toggleFamilyTagFilter(tag) {
    if (familyTagFilters.has(tag)) familyTagFilters.delete(tag);
    else familyTagFilters.add(tag);
    displayFamilyRecipes(state.familyRecipes || []);
    populateFamilyTagFilters();
}

function clearFamilyTagFilters() {
    familyTagFilters.clear();
    displayFamilyRecipes(state.familyRecipes || []);
    populateFamilyTagFilters();
}

function filterFamilyRecipes() {
    displayFamilyRecipes(state.familyRecipes || []);
}

// ========================================
// WEEK PLANNER - DATE BUG FIX
// ========================================
function getWeekDates(offset = 0) {
    const dates = [];
    const today = new Date();

    // Get Monday of current week - FIX: Use local date properly
    const dayOfWeek = today.getDay();
    const mondayOffset = dayOfWeek === 0 ? -6 : 1 - dayOfWeek; // Sunday is 0

    const monday = new Date(today);
    monday.setDate(today.getDate() + mondayOffset + (offset * 7));

    for (let i = 0; i < 7; i++) {
        const date = new Date(monday);
        date.setDate(monday.getDate() + i);
        // FIX: Format date in local timezone, not UTC
        const year = date.getFullYear();
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const day = String(date.getDate()).padStart(2, '0');
        dates.push(`${year}-${month}-${day}`);
    }
    return dates;
}

function getWeekTitle(offset = 0) {
    const dates = getWeekDates(offset);
    const start = new Date(dates[0] + 'T12:00:00'); // Add noon to avoid timezone issues
    const end = new Date(dates[6] + 'T12:00:00');

    const options = { month: 'short', day: 'numeric' };
    const startStr = start.toLocaleDateString('en-US', options);
    const endStr = end.toLocaleDateString('en-US', { ...options, year: 'numeric' });

    if (offset === 0) return `This Week (${startStr} - ${endStr})`;
    if (offset === -1) return `Last Week (${startStr} - ${endStr})`;
    if (offset === 1) return `Next Week (${startStr} - ${endStr})`;
    return `${startStr} - ${endStr}`;
}

function changeWeek(direction) {
    state.currentWeekOffset += direction;
    renderWeekPlanner();
}

function renderWeekPlanner() {
    const container = document.getElementById('week-planner');
    const empty = document.getElementById('week-empty');
    const days = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'];
    const mealPlans = getStorage(STORAGE.MEAL_PLANS) || {};
    const workouts = getStorage(STORAGE.WORKOUTS) || [];
    const weekDates = getWeekDates(state.currentWeekOffset);

    // Update title
    document.getElementById('week-title').textContent = getWeekTitle(state.currentWeekOffset);

    const mealTypes = [
        { key: 'breakfast', icon: icon('sunrise'), label: 'Breakfast' },
        { key: 'lunch', icon: icon('sun'), label: 'Lunch' },
        { key: 'dinner', icon: icon('moon'), label: 'Dinner' },
        { key: 'snacks', icon: icon('apple'), label: 'Snacks' }
    ];

    let hasAnyMeals = false;
    let html = '';

    days.forEach((day, i) => {
        const dateStr = weekDates[i];
        const dateObj = new Date(dateStr + 'T12:00:00');
        let dayMeals = mealPlans[dateStr] || {};

        // Support legacy single-meal format (migrate to dinner)
        // Legacy format has title directly on the object, not in a meal slot
        if (dayMeals.title && typeof dayMeals.title === 'string' && !dayMeals.dinner && !dayMeals.breakfast && !dayMeals.lunch) {
            // This is legacy format - migrate it
            const legacyTitle = dayMeals.title;
            const legacyCalories = dayMeals.calories;
            const legacyRecipeId = dayMeals.recipeId;
            const legacyStatus = dayMeals.status;

            // Create new format
            dayMeals = {
                dinner: {
                    title: legacyTitle,
                    calories: legacyCalories || null,
                    recipeId: legacyRecipeId || null,
                    status: legacyStatus || 'planned'
                }
            };

            // Save migrated data
            mealPlans[dateStr] = dayMeals;
            setStorage(STORAGE.MEAL_PLANS, mealPlans);
        }

        const dateDisplay = dateObj.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });

        // Calculate day totals - also try to get calories from linked recipes
        let dayCalories = 0;
        mealTypes.forEach(mt => {
            const meal = dayMeals[mt.key];
            if (meal?.title) {
                hasAnyMeals = true;
                // First try meal's stored calories
                if (meal.calories) {
                    dayCalories += parseInt(meal.calories) || 0;
                } else if (meal.recipeId) {
                    // Try to get calories from linked recipe
                    const library = getRecipeLibrary();
                    const recipe = library.find(r => r.id === meal.recipeId);
                    if (recipe?.nutrition?.calories) {
                        dayCalories += parseInt(recipe.nutrition.calories) || 0;
                    }
                }
            }
        });

        // Get workout calories for this day
        const dayWorkouts = workouts.filter(w => w.date === dateStr);
        const workoutCalories = dayWorkouts.reduce((sum, w) => sum + (w.caloriesBurned || 0), 0);
        const netCalories = dayCalories - workoutCalories;

        // Build meal slots
        let mealSlotsHtml = '';
        mealTypes.forEach(mt => {
            const meal = dayMeals[mt.key];
            // Only show meal if it has a real title (not empty, not just whitespace, not a date fragment)
            const hasValidTitle = meal?.title && meal.title.trim() && !meal.title.match(/^[\s,]*[A-Z][a-z]{2}\s+\d/);
            if (hasValidTitle) {
                // Get calories from meal or linked recipe
                let displayCalories = meal.calories;
                if (!displayCalories && meal.recipeId) {
                    const library = getRecipeLibrary();
                    const recipe = library.find(r => r.id === meal.recipeId);
                    displayCalories = recipe?.nutrition?.calories;
                }

                const isConfirmed = meal.status === 'confirmed';
                mealSlotsHtml += `
                    <div class="week-meal-slot ${isConfirmed ? 'confirmed' : ''}">
                        <span class="meal-slot-icon">${mt.icon}</span>
                        <span class="meal-slot-type">${mt.label}</span>
                        <div class="meal-slot-content">
                            <div class="meal-slot-title">${meal.title}</div>
                            ${displayCalories ? `<span class="meal-slot-calories">${displayCalories} cal</span>` : ''}
                            ${isConfirmed ? '<span class="meal-confirmed-badge">âœ“ Cooked</span>' : ''}
                        </div>
                        <div class="meal-slot-actions">
                            ${meal.recipeId ? `<button class="icon-btn" onclick="viewRecipeDetail('${meal.recipeId}')" title="View">${icon('eye',14)}</button>` : ''}
                            ${!isConfirmed && meal.recipeId ? `<button class="icon-btn confirm-btn" onclick="confirmMealCooked('${dateStr}', '${mt.key}')" title="Mark as Cooked">âœ“</button>` : ''}
                            <button class="icon-btn" onclick="openAddMealSlot('${dateStr}', '${mt.key}', '${day}')" title="Change">${icon('pencil',14)}</button>
                            <button class="icon-btn" onclick="removeMealSlot('${dateStr}', '${mt.key}')" title="Remove">${icon('trash-2',14)}</button>
                        </div>
                    </div>
                `;
            } else {
                mealSlotsHtml += `
                    <div class="week-meal-slot empty" onclick="openAddMealSlot('${dateStr}', '${mt.key}', '${day}')">
                        <span class="meal-slot-icon">${mt.icon}</span>
                        <span class="meal-slot-type">${mt.label}</span>
                        <span class="meal-slot-add">+ Add ${mt.label}</span>
                    </div>
                `;
            }
        });

        // Day summary with improved display - NEW FORMAT
        // Base TDEE = 2000 cal/day
        const baseTDEE = 2000;
        const totalDailyBurn = baseTDEE + workoutCalories;
        const deficit = totalDailyBurn - dayCalories;
        const isDeficit = deficit > 0;

        const summaryHtml = (dayCalories > 0 || workoutCalories > 0) ? `
            <div class="week-day-summary">
                <span class="day-total-calories">${icon('flame',14)} Daily Burn: ${totalDailyBurn.toLocaleString()} cal (${baseTDEE} base${workoutCalories > 0 ? ' + ' + workoutCalories + ' workout' : ''})</span>
                <span class="day-consumed">${icon('utensils',14)} Consumed: ${dayCalories} cal</span>
                <span class="day-net-calories ${isDeficit ? 'deficit' : 'surplus'}">${icon('check-circle',14)} Net ${isDeficit ? 'Deficit' : 'Surplus'}: ${Math.abs(deficit).toLocaleString()} cal ${isDeficit ? icon('flame',14) : icon('alert-triangle',14)}</span>
            </div>
        ` : '';

        html += `
            <div class="week-day">
                <div class="week-day-header">
                    <span class="week-day-name">${day}</span>
                    <span class="week-day-date">${dateDisplay}</span>
                </div>
                <div class="week-day-meals">
                    ${mealSlotsHtml}
                </div>
                ${summaryHtml}
            </div>
        `;
    });

    container.innerHTML = html;
    empty.classList.toggle('hidden', hasAnyMeals || state.currentWeekOffset !== 0);
}

function openAddMealSlot(dateStr, mealType, dayName) {
    const mealLabels = { breakfast: 'Breakfast', lunch: 'Lunch', dinner: 'Dinner', snacks: 'Snacks' };
    const label = mealLabels[mealType] || mealType;

    openModal(`
        <div class="modal-header">
            <h2 class="modal-title">Add ${label} for ${dayName}</h2>
            <button class="modal-close" onclick="closeModal()">Ã—</button>
        </div>
        <div class="modal-body">
            <div class="more-menu">
                <button class="more-menu-item" onclick="closeModal(); askNonnaForMealSlot('${dateStr}', '${mealType}', '${dayName}');">
                    <span class="icon"><i data-lucide="bot" style="width:14px;height:14px"></i></span>
                    <div class="more-menu-item-content">
                        <div class="more-menu-item-title">Ask Nonna</div>
                        <div class="more-menu-item-desc">Get a ${label.toLowerCase()} suggestion</div>
                    </div>
                </button>
                <button class="more-menu-item" onclick="closeModal(); openChooseFromLibraryForSlot('${dateStr}', '${mealType}');">
                    <span class="icon">${icon('book-open',14)}</span>
                    <div class="more-menu-item-content">
                        <div class="more-menu-item-title">From Library</div>
                        <div class="more-menu-item-desc">Choose a saved recipe</div>
                    </div>
                </button>
                <button class="more-menu-item" onclick="closeModal(); openManualMealSlotEntry('${dateStr}', '${mealType}');">
                    <span class="icon">${icon('pencil',14)}</span>
                    <div class="more-menu-item-content">
                        <div class="more-menu-item-title">Quick Entry</div>
                        <div class="more-menu-item-desc">Type meal name & calories</div>
                    </div>
                </button>
            </div>
        </div>
    `);
}

function askNonnaForMealSlot(dateStr, mealType, dayName) {
    const mealLabels = { breakfast: 'breakfast', lunch: 'lunch', dinner: 'dinner', snacks: 'snack ideas' };
    navigateTo('nonna');
    setTimeout(() => {
        const input = document.getElementById('chat-input');
        input.value = `Suggest a healthy ${mealLabels[mealType]} for ${dayName}. Check my pantry and use ingredients I have.`;
        sendMessage();
    }, 100);
}

function openChooseFromLibraryForSlot(dateStr, mealType) {
    const library = getRecipeLibrary();
    if (library.length === 0) {
        showToast('No recipes in library yet. Ask Nonna for suggestions!');
        return;
    }

    const recipeList = library.slice(0, 20).map(r => `
        <button class="more-menu-item" onclick="assignRecipeToSlot('${r.id}', '${dateStr}', '${mealType}')">
            <span class="icon">${icon('utensils',14)}</span>
            <div class="more-menu-item-content">
                <div class="more-menu-item-title">${r.title}</div>
                <div class="more-menu-item-desc">${r.nutrition?.calories ? r.nutrition.calories + ' cal' : ''} ${r.metadata?.totalTime ? 'Â· ' + r.metadata.totalTime + 'min' : ''}</div>
            </div>
        </button>
    `).join('');

    openModal(`
        <div class="modal-header">
            <h2 class="modal-title">Choose Recipe</h2>
            <button class="modal-close" onclick="closeModal()">Ã—</button>
        </div>
        <div class="modal-body" style="max-height: 60vh; overflow-y: auto;">
            <div class="more-menu">
                ${recipeList}
            </div>
        </div>
    `);
}

function assignRecipeToSlot(recipeId, dateStr, mealType) {
    const library = getRecipeLibrary();
    const recipe = library.find(r => r.id === recipeId);
    if (!recipe) return;

    const mealPlans = getStorage(STORAGE.MEAL_PLANS) || {};
    if (!mealPlans[dateStr]) mealPlans[dateStr] = {};

    mealPlans[dateStr][mealType] = {
        title: recipe.title,
        recipeId: recipe.id,
        calories: recipe.nutrition?.calories || null,
        status: 'planned'
    };

    setStorage(STORAGE.MEAL_PLANS, mealPlans);
    closeModal();
    showToast(`Added ${recipe.title} to ${mealType}`);
    renderWeekPlanner();
}

function openManualMealSlotEntry(dateStr, mealType) {
    const mealLabels = { breakfast: 'Breakfast', lunch: 'Lunch', dinner: 'Dinner', snacks: 'Snacks' };
    openModal(`
        <div class="modal-header">
            <h2 class="modal-title">Add ${mealLabels[mealType]}</h2>
            <button class="modal-close" onclick="closeModal()">Ã—</button>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label>Meal Name</label>
                <input type="text" class="form-input" id="manual-meal-name" placeholder="e.g., Greek Yogurt with Berries">
            </div>
            <div class="form-group">
                <label>Calories (optional)</label>
                <div class="calorie-input-row">
                    <input type="number" class="form-input" id="manual-meal-calories" placeholder="e.g., 350">
                    <button type="button" class="estimate-btn" id="estimate-calories-btn" onclick="estimateCalories('manual-meal-name', 'manual-meal-calories')">
                        ${icon('bot',14)} Estimate
                    </button>
                </div>
                <div id="calorie-estimate-result"></div>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
            <button class="btn btn-primary" onclick="saveManualMealSlot('${dateStr}', '${mealType}')">Add</button>
        </div>
    `);
    setTimeout(() => document.getElementById('manual-meal-name')?.focus(), 100);
}

function saveManualMealSlot(dateStr, mealType) {
    const title = document.getElementById('manual-meal-name')?.value.trim();
    const calories = document.getElementById('manual-meal-calories')?.value;

    if (!title) {
        showToast('Please enter a meal name');
        return;
    }

    const mealPlans = getStorage(STORAGE.MEAL_PLANS) || {};
    if (!mealPlans[dateStr]) mealPlans[dateStr] = {};

    mealPlans[dateStr][mealType] = {
        title: title,
        calories: calories ? parseInt(calories) : null,
        recipeId: null,
        status: 'planned'
    };

    setStorage(STORAGE.MEAL_PLANS, mealPlans);
    closeModal();
    showToast(`Added ${title}`);
    renderWeekPlanner();

    // Prompt to save as recipe (with short delay so toast shows first)
    setTimeout(() => {
        promptSaveAsRecipe(title, calories ? parseInt(calories) : null, dateStr, mealType);
    }, 400);
}

// ========================================
// AUTO-RECIPE FROM MANUAL MEAL ENTRY
// ========================================
function promptSaveAsRecipe(mealTitle, calories, dateStr, mealType) {
    openModal(`
        <div class="modal-header">
            <h2 class="modal-title" id="modal-title-label">${icon('lightbulb',14)} Save as Recipe?</h2>
            <button class="modal-close" onclick="closeModal()" aria-label="Close">Ã—</button>
        </div>
        <div class="modal-body" style="text-align:center;padding:24px">
            <p style="font-size:1.05rem;margin-bottom:8px"><strong>"${mealTitle}"</strong></p>
            <p style="color:var(--gray-text);margin-bottom:24px">Create a full recipe so you can cook it again, track ingredients, and share with family.</p>
            <div class="prompt-actions">
                <button class="btn btn-secondary" onclick="closeModal()">Not Now</button>
                <button class="btn btn-primary" onclick="openCreateRecipeFromMeal('${encodeURIComponent(mealTitle)}', ${calories || 'null'}, '${dateStr}', '${mealType}')">
                    <i data-lucide="book-plus"></i> Create Recipe
                </button>
            </div>
        </div>
    `, { maxWidth: '440px' });
}

function openCreateRecipeFromMeal(encodedTitle, calories, dateStr, mealType) {
    const mealTitle = decodeURIComponent(encodedTitle);
    const mealLabels = { breakfast: 'Breakfast', lunch: 'Lunch', dinner: 'Dinner', snacks: 'Snack' };

    openModal(`
        <div class="modal-header">
            <h2 class="modal-title" id="modal-title-label">Create Recipe</h2>
            <button class="modal-close" onclick="closeModal()" aria-label="Close">Ã—</button>
        </div>
        <div class="modal-body create-recipe-form">
            <div class="form-group">
                <label>Recipe Name *</label>
                <input type="text" class="form-input" id="new-recipe-title" value="${mealTitle}">
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label>Servings</label>
                    <input type="number" class="form-input" id="new-recipe-servings" value="2" min="1">
                </div>
                <div class="form-group">
                    <label>Meal Type</label>
                    <select class="form-select" id="new-recipe-meal-type">
                        ${Object.entries(mealLabels).map(([k, v]) => `<option value="${k}" ${k === mealType ? 'selected' : ''}>${v}</option>`).join('')}
                    </select>
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label>Prep Time (min)</label>
                    <input type="number" class="form-input" id="new-recipe-prep" value="10" min="0">
                </div>
                <div class="form-group">
                    <label>Cook Time (min)</label>
                    <input type="number" class="form-input" id="new-recipe-cook" value="20" min="0">
                </div>
            </div>

            <!-- Ingredients -->
            <div class="form-group">
                <label>Ingredients *</label>
                <div id="new-recipe-ingredients-list">
                    <div class="ingredient-input-row">
                        <input type="text" class="form-input" placeholder="e.g., 2 cups rice">
                        <button class="btn-icon" onclick="this.parentElement.remove()" title="Remove"><i data-lucide="x"></i></button>
                    </div>
                    <div class="ingredient-input-row">
                        <input type="text" class="form-input" placeholder="e.g., 1 tbsp olive oil">
                        <button class="btn-icon" onclick="this.parentElement.remove()" title="Remove"><i data-lucide="x"></i></button>
                    </div>
                    <div class="ingredient-input-row">
                        <input type="text" class="form-input" placeholder="e.g., 1 lb chicken breast">
                        <button class="btn-icon" onclick="this.parentElement.remove()" title="Remove"><i data-lucide="x"></i></button>
                    </div>
                </div>
                <button class="btn btn-ghost btn-sm" onclick="addNewRecipeIngredient()" style="margin-top:6px">
                    <i data-lucide="plus"></i> Add Ingredient
                </button>
            </div>

            <!-- Instructions -->
            <div class="form-group">
                <label>Instructions *</label>
                <div id="new-recipe-instructions-list">
                    <div class="instruction-input-row">
                        <span class="step-num">1.</span>
                        <textarea class="form-input" placeholder="Describe this step..." rows="2" style="resize:vertical"></textarea>
                        <button class="btn-icon" onclick="removeNewRecipeStep(this)" title="Remove"><i data-lucide="x"></i></button>
                    </div>
                </div>
                <button class="btn btn-ghost btn-sm" onclick="addNewRecipeStep()" style="margin-top:6px">
                    <i data-lucide="plus"></i> Add Step
                </button>
            </div>

            <!-- Nutrition -->
            <div class="form-group">
                <label>Nutrition per serving (optional)</label>
                <div class="nutrition-inputs">
                    <input type="number" class="form-input-small" id="new-recipe-cal" placeholder="Calories" value="${calories || ''}">
                    <input type="number" class="form-input-small" id="new-recipe-protein" placeholder="Protein (g)">
                    <input type="number" class="form-input-small" id="new-recipe-carbs" placeholder="Carbs (g)">
                    <input type="number" class="form-input-small" id="new-recipe-fat" placeholder="Fat (g)">
                </div>
            </div>

            <!-- Tags -->
            <div class="form-group">
                <label>Tags (optional)</label>
                <div class="tag-selection-grid" id="new-recipe-tags">
                    ${Object.values(ALL_RECIPE_TAGS).flat().slice(0, 18).map(tag =>
                        `<label class="tag-selection-chip"><input type="checkbox" value="${tag}" onchange="this.parentElement.classList.toggle('selected',this.checked)"><span>${tag}</span></label>`
                    ).join('')}
                </div>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
            <button class="btn btn-primary" onclick="saveNewRecipeFromMeal('${dateStr}', '${mealType}')">
                <i data-lucide="save"></i> Save Recipe
            </button>
        </div>
    `, { maxWidth: '650px' });
}

function addNewRecipeIngredient() {
    const container = document.getElementById('new-recipe-ingredients-list');
    const div = document.createElement('div');
    div.className = 'ingredient-input-row';
    div.innerHTML = `
        <input type="text" class="form-input" placeholder="e.g., 1 tsp cumin">
        <button class="btn-icon" onclick="this.parentElement.remove()" title="Remove"><i data-lucide="x"></i></button>
    `;
    container.appendChild(div);
    refreshIcons();
    div.querySelector('input').focus();
}

function addNewRecipeStep() {
    const container = document.getElementById('new-recipe-instructions-list');
    const count = container.children.length + 1;
    const div = document.createElement('div');
    div.className = 'instruction-input-row';
    div.innerHTML = `
        <span class="step-num">${count}.</span>
        <textarea class="form-input" placeholder="Describe this step..." rows="2" style="resize:vertical"></textarea>
        <button class="btn-icon" onclick="removeNewRecipeStep(this)" title="Remove"><i data-lucide="x"></i></button>
    `;
    container.appendChild(div);
    refreshIcons();
    div.querySelector('textarea').focus();
}

function removeNewRecipeStep(btn) {
    btn.parentElement.remove();
    // Renumber
    const container = document.getElementById('new-recipe-instructions-list');
    Array.from(container.children).forEach((row, i) => {
        const num = row.querySelector('.step-num');
        if (num) num.textContent = `${i + 1}.`;
    });
}

function saveNewRecipeFromMeal(dateStr, mealType) {
    const title = document.getElementById('new-recipe-title')?.value?.trim();
    if (!title) { showToast('Please enter a recipe name', 'warning'); return; }

    // Gather ingredients
    const ingredients = Array.from(document.querySelectorAll('#new-recipe-ingredients-list input'))
        .map(i => i.value.trim()).filter(Boolean);
    if (ingredients.length === 0) { showToast('Please add at least one ingredient', 'warning'); return; }

    // Gather instructions
    const instructions = Array.from(document.querySelectorAll('#new-recipe-instructions-list textarea'))
        .map(t => t.value.trim()).filter(Boolean);
    if (instructions.length === 0) { showToast('Please add at least one instruction step', 'warning'); return; }

    const servings = parseInt(document.getElementById('new-recipe-servings')?.value) || 2;
    const prepTime = parseInt(document.getElementById('new-recipe-prep')?.value) || 10;
    const cookTime = parseInt(document.getElementById('new-recipe-cook')?.value) || 20;

    // Nutrition
    const nutrition = {
        calories: document.getElementById('new-recipe-cal')?.value || '',
        protein: document.getElementById('new-recipe-protein')?.value || '',
        carbs: document.getElementById('new-recipe-carbs')?.value || '',
        fat: document.getElementById('new-recipe-fat')?.value || '',
        fiber: '',
        sodium: ''
    };

    // Tags
    const selectedTags = Array.from(document.querySelectorAll('#new-recipe-tags input[type="checkbox"]:checked'))
        .map(cb => cb.value);

    const recipeId = 'recipe_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
    const recipe = {
        id: recipeId,
        title: title,
        ingredients: ingredients,
        instructions: instructions,
        nutrition: nutrition,
        servings: servings,
        metadata: {
            prepTime: prepTime,
            cookTime: cookTime,
            totalTime: prepTime + cookTime,
            serves: servings,
            tags: selectedTags,
            proteinType: ''
        },
        tags: selectedTags,
        dateGenerated: new Date().toISOString(),
        timesCooked: 0,
        rating: 0,
        favorited: false,
        privacy: 'private',
        source: 'manual-entry'
    };

    // Save to library
    const library = getRecipeLibrary();
    library.push(recipe);
    setStorage(STORAGE.RECIPES, library);

    // Link to meal plan
    const mealPlans = getStorage(STORAGE.MEAL_PLANS) || {};
    if (mealPlans[dateStr] && mealPlans[dateStr][mealType]) {
        mealPlans[dateStr][mealType].recipeId = recipeId;
        setStorage(STORAGE.MEAL_PLANS, mealPlans);
    }

    closeModal();
    showToast(`"${title}" saved to your recipe library!`, 'success');
    renderWeekPlanner();
}

function removeMealSlot(dateStr, mealType) {
    const mealPlans = getStorage(STORAGE.MEAL_PLANS) || {};
    if (mealPlans[dateStr] && mealPlans[dateStr][mealType]) {
        delete mealPlans[dateStr][mealType];
        // Clean up empty day
        if (Object.keys(mealPlans[dateStr]).length === 0) {
            delete mealPlans[dateStr];
        }
        setStorage(STORAGE.MEAL_PLANS, mealPlans);
        renderWeekPlanner();
        showToast('Meal removed');
    }
}

// ========================================
// PANTRY INTEGRATION - CONFIRM MEAL COOKED
// ========================================
function confirmMealCooked(dateStr, mealType) {
    const mealPlans = getStorage(STORAGE.MEAL_PLANS) || {};
    const meal = mealPlans[dateStr]?.[mealType];

    if (!meal || !meal.recipeId) {
        showToast('No recipe linked to this meal');
        return;
    }

    // Get the recipe
    const library = getRecipeLibrary();
    const recipe = library.find(r => r.id === meal.recipeId);

    if (!recipe) {
        showToast('Recipe not found');
        return;
    }

    // Show confirmation modal with ingredient deduction preview
    const ingredients = recipe.ingredients || [];
    const pantry = getStorage(STORAGE.PANTRY) || [];

    let deductionHtml = '';
    let missingItems = [];
    let deductionPlan = [];

    ingredients.forEach(ing => {
        const { name, qty } = parseIngredient(ing);
        const pantryItem = pantry.find(p =>
            p.name.toLowerCase().includes(name.toLowerCase()) ||
            name.toLowerCase().includes(p.name.toLowerCase())
        );

        if (pantryItem) {
            deductionPlan.push({ pantryItem, qty, originalIng: ing });
            deductionHtml += `<div class="deduction-item have">${icon('check-circle',14)} ${ing}</div>`;
        } else {
            missingItems.push(ing);
            deductionHtml += `<div class="deduction-item missing">${icon('x-circle',14)} ${ing} (not in pantry)</div>`;
        }
    });

    openModal(`
        <div class="modal-header">
            <h2 class="modal-title">âœ“ Confirm Meal Cooked</h2>
            <button class="modal-close" onclick="closeModal()">Ã—</button>
        </div>
        <div class="modal-body">
            <div class="confirm-meal-recipe">
                <strong>${recipe.title}</strong>
                <div class="text-muted">${dateStr} Â· ${mealType}</div>
            </div>

            <div class="confirm-meal-section">
                <div class="confirm-meal-section-title">${icon('package',14)} Pantry Deductions</div>
                <p class="text-muted mb-12">These ingredients will be marked as used:</p>
                ${deductionHtml}
            </div>

            ${missingItems.length > 0 ? `
                <div class="confirm-meal-section">
                    <div class="confirm-meal-section-title">${icon('shopping-cart',14)} Add Missing to Shopping List?</div>
                    <label class="checkbox-item">
                        <input type="checkbox" id="add-missing-to-shopping" checked>
                        <span>Add ${missingItems.length} missing item(s) to shopping list</span>
                    </label>
                </div>
            ` : ''}

            <div class="confirm-meal-section">
                <label class="checkbox-item">
                    <input type="checkbox" id="update-recipe-cooked" checked>
                    <span>Update recipe's "times cooked" counter</span>
                </label>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
            <button class="btn btn-primary" onclick="executeMealConfirmation('${dateStr}', '${mealType}', '${meal.recipeId}')">
                âœ“ Confirm & Update Pantry
            </button>
        </div>
    `);
}

function parseIngredient(ingredientStr) {
    // Parse quantity and ingredient name from strings like "2 cups flour" or "1 lb chicken"
    const match = ingredientStr.match(/^([\dÂ½Â¼Â¾â…“â…”\.\/\s-]+)?\s*(cups?|tbsp?|tsp?|oz|lbs?|pounds?|cloves?|heads?|bunch|can|jar|container|package)?\s*(.+)/i);

    if (match) {
        return {
            qty: (match[1] || '').trim(),
            unit: (match[2] || '').trim(),
            name: (match[3] || '').trim().replace(/,.*$/, '') // Remove anything after comma
        };
    }

    return { qty: '', unit: '', name: ingredientStr.trim() };
}

function executeMealConfirmation(dateStr, mealType, recipeId) {
    const addMissingToShopping = document.getElementById('add-missing-to-shopping')?.checked;
    const updateRecipeCooked = document.getElementById('update-recipe-cooked')?.checked;

    const library = getRecipeLibrary();
    const recipe = library.find(r => r.id === recipeId);
    const pantry = getStorage(STORAGE.PANTRY) || [];
    const mealPlans = getStorage(STORAGE.MEAL_PLANS) || {};

    if (!recipe) {
        closeModal();
        showToast('Recipe not found');
        return;
    }

    const ingredients = recipe.ingredients || [];
    let deducted = 0;
    let missingItems = [];

    // Process each ingredient
    ingredients.forEach(ing => {
        const { name } = parseIngredient(ing);
        const pantryIndex = pantry.findIndex(p =>
            p.name.toLowerCase().includes(name.toLowerCase()) ||
            name.toLowerCase().includes(p.name.toLowerCase())
        );

        if (pantryIndex >= 0) {
            // Mark as used/low or remove from pantry
            const item = pantry[pantryIndex];
            if (item.qty) {
                // If quantity tracked, reduce it
                const currentQty = parseFloat(item.qty) || 1;
                item.qty = Math.max(0, currentQty - 1).toString();
                if (parseFloat(item.qty) <= 0) {
                    pantry.splice(pantryIndex, 1);
                } else {
                    item.status = 'low';
                }
            } else {
                // No quantity, just mark as used
                item.status = 'used';
            }
            deducted++;
        } else {
            missingItems.push(ing);
        }
    });

    // Save updated pantry
    setStorage(STORAGE.PANTRY, pantry);

    // Add missing items to shopping list if checked
    if (addMissingToShopping && missingItems.length > 0) {
        const shopping = getStorage(STORAGE.SHOPPING) || { weekly: [] };
        missingItems.forEach(ing => {
            const { name } = parseIngredient(ing);
            if (!shopping.weekly.find(i => i.name.toLowerCase() === name.toLowerCase())) {
                shopping.weekly.push({
                    name: ing,
                    category: categorizeIngredient(name),
                    checked: false,
                    source: 'meal-confirm'
                });
            }
        });
        setStorage(STORAGE.SHOPPING, shopping);
    }

    // Update recipe times cooked if checked
    if (updateRecipeCooked) {
        recipe.timesCooked = (recipe.timesCooked || 0) + 1;
        recipe.lastCooked = dateStr;
        setStorage(STORAGE.RECIPES, library);
    }

    // Mark meal as confirmed/cooked
    if (mealPlans[dateStr] && mealPlans[dateStr][mealType]) {
        mealPlans[dateStr][mealType].status = 'confirmed';
        setStorage(STORAGE.MEAL_PLANS, mealPlans);
    }

    closeModal();
    renderWeekPlanner();

    // Show summary toast
    let message = `${icon('check-circle',14)} ${recipe.title} confirmed!`;
    if (deducted > 0) message += ` ${deducted} pantry items updated.`;
    if (missingItems.length > 0 && addMissingToShopping) message += ` ${missingItems.length} added to shopping.`;
    showToast(message);
}

function openAddMealForDay(dateStr, dayName) {
    openModal(`
        <div class="modal-header">
            <h2 class="modal-title">Add Meal for ${dayName}</h2>
            <button class="modal-close" onclick="closeModal()">Ã—</button>
        </div>
        <div class="modal-body">
            <div class="more-menu">
                <button class="more-menu-item" onclick="closeModal(); askNonna('Suggest a meal for ${dayName}');">
                    <span class="icon"><i data-lucide="bot" style="width:14px;height:14px"></i></span>
                    <div class="more-menu-item-content">
                        <div class="more-menu-item-title">Ask Nonna</div>
                        <div class="more-menu-item-desc">Get a suggestion</div>
                    </div>
                </button>
                <button class="more-menu-item" onclick="closeModal(); openChooseFromFavorites('${dateStr}');">
                    <span class="icon"><i data-lucide="heart" style="width:14px;height:14px"></i></span>
                    <div class="more-menu-item-content">
                        <div class="more-menu-item-title">From Favorites</div>
                        <div class="more-menu-item-desc">Choose a saved recipe</div>
                    </div>
                </button>
                <button class="more-menu-item" onclick="closeModal(); openChooseFromLibrary('${dateStr}');">
                    <span class="icon">${icon('book-open',14)}</span>
                    <div class="more-menu-item-content">
                        <div class="more-menu-item-title">From Library</div>
                        <div class="more-menu-item-desc">Browse all recipes</div>
                    </div>
                </button>
                <button class="more-menu-item" onclick="closeModal(); openManualMealEntry('${dateStr}');">
                    <span class="icon">${icon('pencil',14)}</span>
                    <div class="more-menu-item-content">
                        <div class="more-menu-item-title">Manual Entry</div>
                        <div class="more-menu-item-desc">Type a meal name</div>
                    </div>
                </button>
            </div>
        </div>
    `);
}

function openManualMealEntry(dateStr) {
    openModal(`
        <div class="modal-header">
            <h2 class="modal-title">Add Meal</h2>
            <button class="modal-close" onclick="closeModal()">Ã—</button>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label>Meal Name</label>
                <input type="text" class="form-input" id="manual-meal-input" placeholder="e.g., Grilled Salmon">
            </div>
            <div class="form-group">
                <label>Calories (optional)</label>
                <div class="calorie-input-row">
                    <input type="number" class="form-input" id="manual-meal-input-calories" placeholder="e.g., 350">
                    <button type="button" class="estimate-btn" onclick="estimateCalories('manual-meal-input', 'manual-meal-input-calories')">
                        ${icon('bot',14)} Estimate
                    </button>
                </div>
                <div id="calorie-estimate-result-manual"></div>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
            <button class="btn btn-primary" onclick="saveManualMeal('${dateStr}')">Add</button>
        </div>
    `);
    setTimeout(() => document.getElementById('manual-meal-input').focus(), 100);
}

function saveManualMeal(dateStr) {
    const input = document.getElementById('manual-meal-input');
    const caloriesInput = document.getElementById('manual-meal-input-calories');
    const title = input.value.trim();
    const calories = caloriesInput?.value;
    if (!title) return;

    const mealPlans = getStorage(STORAGE.MEAL_PLANS) || {};
    if (!mealPlans[dateStr]) mealPlans[dateStr] = {};
    // Default to dinner slot for legacy manual entry
    mealPlans[dateStr].dinner = {
        title,
        calories: calories ? parseInt(calories) : null,
        recipeId: null,
        status: 'planned'
    };
    setStorage(STORAGE.MEAL_PLANS, mealPlans);
    closeModal();
    renderWeekPlanner();
    showToast(`${icon('check-circle',14)} Meal added!`);
}

function openChooseFromLibrary(dateStr) {
    const library = getRecipeLibrary();
    if (library.length === 0) {
        showToast('No recipes in library. Chat with Nonna first!');
        return;
    }

    openModal(`
        <div class="modal-header">
            <h2 class="modal-title">Choose Recipe</h2>
            <button class="modal-close" onclick="closeModal()">Ã—</button>
        </div>
        <div class="modal-body" style="max-height: 60vh; overflow-y: auto;">
            ${library.map(r => `
                <div class="more-menu-item" style="margin-bottom: 8px;" onclick="addRecipeToDay('${dateStr}', '${r.id}')">
                    <span class="icon">${icon('utensils',14)}</span>
                    <div class="more-menu-item-content">
                        <div class="more-menu-item-title">${r.title}</div>
                        <div class="more-menu-item-desc">${r.metadata?.totalTime || 30} min</div>
                    </div>
                </div>
            `).join('')}
        </div>
    `);
}

function openChooseFromFavorites(dateStr) {
    const favorites = getFavorites();
    if (favorites.length === 0) {
        showToast('No favorites yet. Heart some recipes first!');
        return;
    }
    openModal(`
        <div class="modal-header">
            <h2 class="modal-title">Choose Favorite</h2>
            <button class="modal-close" onclick="closeModal()">Ã—</button>
        </div>
        <div class="modal-body" style="max-height: 60vh; overflow-y: auto;">
            ${favorites.map(r => `
                <div class="more-menu-item" style="margin-bottom: 8px;" onclick="addRecipeToDay('${dateStr}', '${r.id}')">
                    <span class="icon"><i data-lucide="heart" style="width:14px;height:14px"></i></span>
                    <div class="more-menu-item-content">
                        <div class="more-menu-item-title">${r.title}</div>
                    </div>
                </div>
            `).join('')}
        </div>
    `);
}

function addRecipeToDay(dateStr, recipeId) {
    const library = getRecipeLibrary();
    const recipe = library.find(r => r.id === recipeId);
    if (!recipe) return;

    const mealPlans = getStorage(STORAGE.MEAL_PLANS) || {};
    if (!mealPlans[dateStr]) mealPlans[dateStr] = {};
    // Default to dinner slot for legacy add-to-day
    mealPlans[dateStr].dinner = {
        title: recipe.title,
        calories: recipe.nutrition?.calories || null,
        recipeId: recipeId,
        status: 'planned'
    };
    setStorage(STORAGE.MEAL_PLANS, mealPlans);
    closeModal();
    renderWeekPlanner();
    showToast(`${icon('check-circle',14)} Added to plan!`);
}

function openAddToWeekModal(recipeId) {
    const library = getRecipeLibrary();
    const recipe = library.find(r => r.id === recipeId);
    if (!recipe) return;

    const weekDates = getWeekDates(state.currentWeekOffset);
    const days = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];

    openModal(`
        <div class="modal-header">
            <h2 class="modal-title">Add to Week</h2>
            <button class="modal-close" onclick="closeModal()">Ã—</button>
        </div>
        <div class="modal-body">
            <p class="mb-16">Add "${recipe.title}" to which day?</p>
            <div class="day-picker">
                ${weekDates.map((dateStr, i) => {
                    const d = new Date(dateStr + 'T12:00:00');
                    return `
                        <div class="day-picker-item" onclick="addRecipeToDay('${dateStr}', '${recipeId}')">
                            <div class="day-name">${days[i]}</div>
                            <div class="day-num">${d.getDate()}</div>
                        </div>
                    `;
                }).join('')}
            </div>
        </div>
    `);
}

function removeMealForDay(dateStr) {
    const mealPlans = getStorage(STORAGE.MEAL_PLANS) || {};
    delete mealPlans[dateStr];
    setStorage(STORAGE.MEAL_PLANS, mealPlans);
    renderWeekPlanner();
    showToast('Meal removed');
}

function viewMealForDay(dateStr) {
    const mealPlans = getStorage(STORAGE.MEAL_PLANS) || {};
    const meal = mealPlans[dateStr];
    if (!meal) return;

    if (meal.recipeId) {
        viewRecipeDetail(meal.recipeId);
    } else {
        showToast(`Planned: ${meal.title}`);
    }
}

function changeMealForDay(dateStr) {
    const d = new Date(dateStr + 'T12:00:00');
    const dayName = d.toLocaleDateString('en-US', { weekday: 'long' });
    openAddMealForDay(dateStr, dayName);
}

function askNonnaForWeekPlan() {
    // Open planning mode selection modal
    openPlanningModeModal();
}

function openPlanningModeModal() {
    const pantry = getStorage(STORAGE.PANTRY) || [];
    const garden = getStorage(STORAGE.GARDEN) || [];
    const profile = getStorage(STORAGE.PROFILE) || {};

    // Build pantry summary
    let pantrySummary = '';
    if (pantry.length > 0) {
        const categories = {};
        pantry.forEach(item => {
            const cat = item.category || categorizeIngredient(item.name);
            if (!categories[cat]) categories[cat] = [];
            categories[cat].push(item.name);
        });

        const categoryList = Object.entries(categories).map(([cat, items]) =>
            `<strong>${cat}:</strong> ${items.slice(0, 4).join(', ')}${items.length > 4 ? '...' : ''}`
        ).join('<br>');

        pantrySummary = categoryList;
    } else {
        pantrySummary = '<em>Pantry is empty. Add items to enable pantry-aware planning.</em>';
    }

    // Garden summary
    let gardenSummary = '';
    if (garden && garden.length > 0) {
        const gardenItems = garden.map(g => typeof g === 'string' ? g : g.name).slice(0, 5);
        gardenSummary = `<br><strong>${icon('sprout',14)} Garden Ready:</strong> ${gardenItems.join(', ')}${garden.length > 5 ? '...' : ''}`;
    }

    openModal(`
        <div class="modal-header">
            <h2 class="modal-title">${icon('calendar',14)} Plan This Week</h2>
            <button class="modal-close" onclick="closeModal()">Ã—</button>
        </div>
        <div class="modal-body">
            <p class="text-muted mb-16">How should Nonna plan your meals?</p>

            <div class="planning-mode-selector">
                <label class="planning-mode-option" onclick="selectPlanningMode('use-pantry')">
                    <input type="radio" name="planning-mode" value="use-pantry">
                    <div class="planning-mode-content">
                        <div class="planning-mode-title">${icon('home',14)} Use What I Have</div>
                        <div class="planning-mode-desc">Minimize shopping - prioritize pantry ingredients. Best when you want to use up what you have.</div>
                    </div>
                </label>

                <label class="planning-mode-option selected" onclick="selectPlanningMode('balanced')">
                    <input type="radio" name="planning-mode" value="balanced" checked>
                    <div class="planning-mode-content">
                        <div class="planning-mode-title">${icon('scale',14)} Balanced (Recommended)</div>
                        <div class="planning-mode-desc">Mix pantry items + fresh ingredients. Good variety with moderate shopping.</div>
                    </div>
                </label>

                <label class="planning-mode-option" onclick="selectPlanningMode('shop-freely')">
                    <input type="radio" name="planning-mode" value="shop-freely">
                    <div class="planning-mode-content">
                        <div class="planning-mode-title">${icon('shopping-cart',14)} Shop Freely</div>
                        <div class="planning-mode-desc">Ignore pantry - suggest optimal recipes based only on health goals and preferences.</div>
                    </div>
                </label>
            </div>

            <div class="planning-pantry-summary">
                <h4>${icon('package',14)} Currently in your pantry:</h4>
                <div style="font-size: 0.85rem; color: var(--gray-dark);">
                    ${pantrySummary}
                    ${gardenSummary}
                </div>
            </div>

            <div class="form-group mt-16">
                <label>Meals to plan</label>
                <div class="grid grid-2" style="gap: 8px;">
                    <label class="checkbox-item"><input type="checkbox" id="plan-breakfast"> Breakfast</label>
                    <label class="checkbox-item"><input type="checkbox" id="plan-lunch"> Lunch</label>
                    <label class="checkbox-item"><input type="checkbox" id="plan-dinner" checked> Dinner</label>
                    <label class="checkbox-item"><input type="checkbox" id="plan-snacks"> Snacks</label>
                </div>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
            <button class="btn btn-primary" onclick="executePlanningMode()">Ask Nonna to Plan</button>
        </div>
    `);
}

function selectPlanningMode(mode) {
    // Update visual selection
    document.querySelectorAll('.planning-mode-option').forEach(opt => {
        opt.classList.remove('selected');
    });
    document.querySelector(`input[value="${mode}"]`).closest('.planning-mode-option').classList.add('selected');
    document.querySelector(`input[value="${mode}"]`).checked = true;
}

function executePlanningMode() {
    const mode = document.querySelector('input[name="planning-mode"]:checked').value;
    const weekDates = getWeekDates(state.currentWeekOffset);
    const startDate = new Date(weekDates[0] + 'T12:00:00');
    const endDate = new Date(weekDates[6] + 'T12:00:00');
    const startStr = startDate.toLocaleDateString('en-US', { month: 'long', day: 'numeric' });
    const endStr = endDate.toLocaleDateString('en-US', { month: 'long', day: 'numeric' });

    // Get selected meal types
    const mealTypes = [];
    if (document.getElementById('plan-breakfast')?.checked) mealTypes.push('breakfast');
    if (document.getElementById('plan-lunch')?.checked) mealTypes.push('lunch');
    if (document.getElementById('plan-dinner')?.checked) mealTypes.push('dinner');
    if (document.getElementById('plan-snacks')?.checked) mealTypes.push('snacks');

    if (mealTypes.length === 0) {
        mealTypes.push('dinner'); // Default to dinner
    }

    const pantry = getStorage(STORAGE.PANTRY) || [];
    const garden = getStorage(STORAGE.GARDEN) || [];
    const profile = getStorage(STORAGE.PROFILE) || {};

    // Build the prompt based on mode
    let prompt = `Plan my meals for the week of ${startStr} to ${endStr}. Give me a complete 7-day plan for ${mealTypes.join(', ')}.`;

    if (mode === 'use-pantry') {
        const pantryItems = pantry.map(p => `${p.name} (${p.qty || 'some'})`).join(', ');
        const gardenItems = garden.length > 0
            ? garden.map(g => typeof g === 'string' ? g : g.name).join(', ')
            : '';

        prompt += `

IMPORTANT: I want to minimize shopping this week. Please create meals using primarily these pantry items:
${pantryItems}
${gardenItems ? `\nGarden ready to harvest: ${gardenItems}` : ''}

Goal: Use at least 70% of ingredients from my current inventory. Only suggest buying 5-10 fresh items maximum.`;
    } else if (mode === 'balanced') {
        const pantryItems = pantry.map(p => p.name).join(', ');
        const gardenItems = garden.length > 0
            ? garden.map(g => typeof g === 'string' ? g : g.name).join(', ')
            : '';

        prompt += `

I'd like a balanced plan that uses some of my pantry items while adding fresh ingredients.
Current pantry: ${pantryItems || 'minimal pantry staples'}
${gardenItems ? `Garden ready: ${gardenItems}` : ''}

Goal: Good variety with moderate shopping (15-20 items). Use some pantry items to reduce waste.`;
    } else {
        // shop-freely mode
        prompt += `

Create optimal meal plans based on health goals and variety. Don't worry about what I currently have - suggest the best recipes for my goals.`;
    }

    // Add health context if available
    if (profile.healthConditions) {
        prompt += `\n\nHealth note: I have ${profile.healthConditions}, so please keep meals appropriate.`;
    }
    if (profile.dietaryPrefs) {
        prompt += `\nDietary preferences: ${profile.dietaryPrefs}`;
    }

    closeModal();
    askNonna(prompt);
}

function generateWeekShoppingList() {
    const mealPlans = getStorage(STORAGE.MEAL_PLANS) || {};
    const weekDates = getWeekDates(state.currentWeekOffset);
    const library = getRecipeLibrary();
    const ingredients = [];

    weekDates.forEach(dateStr => {
        const meal = mealPlans[dateStr];
        if (meal && meal.recipeId) {
            const recipe = library.find(r => r.id === meal.recipeId);
            if (recipe && recipe.ingredients) {
                ingredients.push(...recipe.ingredients);
            }
        }
    });

    if (ingredients.length === 0) {
        showToast('No recipes with ingredients in your plan');
        return;
    }

    // Save as shopping list
    const shoppingLists = getStorage(STORAGE.SHOPPING) || { weekly: [] };
    shoppingLists['week-plan'] = ingredients.map(ing => ({ name: ing, checked: false }));
    setStorage(STORAGE.SHOPPING, shoppingLists);

    navigateTo('more');
    switchMoreTab('kitchen');
    setTimeout(() => {
        document.getElementById('shopping-list-select').value = 'week-plan';
        loadShoppingList();
    }, 100);
    showToast(`${icon('shopping-cart',14)} Shopping list created from meal plan!`);
}

function showPrepChecklist() {
    askNonna('Create a batch cooking prep checklist for my planned meals this week. What can I prepare ahead of time on Sunday?');
}

// ========================================
// KITCHEN - PANTRY
// ========================================
function renderPantry() {
    const pantry = getStorage(STORAGE.PANTRY) || [];
    const container = document.getElementById('pantry-list');
    const empty = document.getElementById('pantry-empty');

    // Render alerts first
    if (typeof renderPantryAlerts === 'function') {
        renderPantryAlerts();
    }

    if (pantry.length === 0) {
        container.innerHTML = '';
        empty.classList.remove('hidden');
        return;
    }

    empty.classList.add('hidden');

    // Group items by category
    const grouped = {};
    pantry.forEach((item, index) => {
        const cat = item.category || 'other';
        if (!grouped[cat]) grouped[cat] = [];
        grouped[cat].push({ ...item, index });
    });

    // Category metadata
    const categoryMeta = {
        produce: { name: 'Produce', icon: 'leaf', order: 1 },
        proteins: { name: 'Proteins', icon: 'drumstick', order: 2 },
        dairy: { name: 'Dairy', icon: 'milk', order: 3 },
        grains: { name: 'Grains', icon: 'wheat', order: 4 },
        canned: { name: 'Canned Goods', icon: 'package', order: 5 },
        condiments: { name: 'Condiments', icon: 'droplet', order: 6 },
        spices: { name: 'Spices', icon: 'sparkles', order: 7 },
        oils: { name: 'Oils & Vinegars', icon: 'droplets', order: 8 },
        snacks: { name: 'Snacks', icon: 'cookie', order: 9 },
        beverages: { name: 'Beverages', icon: 'wine', order: 10 },
        baking: { name: 'Baking', icon: 'cake-slice', order: 11 },
        frozen: { name: 'Frozen', icon: 'snowflake', order: 12 },
        other: { name: 'Other', icon: 'package', order: 99 }
    };

    // Sort categories: low-stock categories first, then by order
    const sortedCategories = Object.keys(grouped).sort((a, b) => {
        const hasLowA = grouped[a].some(item => isItemLowOrOut(item));
        const hasLowB = grouped[b].some(item => isItemLowOrOut(item));
        if (hasLowA && !hasLowB) return -1;
        if (!hasLowA && hasLowB) return 1;
        return (categoryMeta[a]?.order || 99) - (categoryMeta[b]?.order || 99);
    });

    // Render grouped categories
    container.innerHTML = sortedCategories.map(cat => {
        const meta = categoryMeta[cat] || { name: cat, icon: 'package', order: 99 };
        const items = grouped[cat];
        const hasLowStock = items.some(item => isItemLowOrOut(item));

        const categoryHTML = `
            <div class="pantry-category" data-category="${cat}">
                <div class="pantry-category-header ${hasLowStock ? 'has-alerts' : ''}" onclick="togglePantryCategory('${cat}')">
                    <div class="pantry-category-header-left">
                        <i data-lucide="${meta.icon}" style="width:20px;height:20px"></i>
                        <span class="pantry-category-name">${meta.name}</span>
                        <span class="pantry-category-count">${items.length} item${items.length !== 1 ? 's' : ''}</span>
                    </div>
                    <i data-lucide="chevron-down" class="pantry-category-arrow" style="width:18px;height:18px"></i>
                </div>
                <div class="pantry-category-items" id="pantry-cat-${cat}">
                    ${items.map(item => renderPantryCard(item)).join('')}
                </div>
            </div>
        `;
        return categoryHTML;
    }).join('');

    refreshIcons();
}

function isItemLowOrOut(item) {
    const qtyStr = (item.qty || '').toLowerCase();
    const isLow = item.status === 'use-soon' || item.status === 'low' || qtyStr.includes('low') || qtyStr.includes('almost') || qtyStr.includes('last');
    const isOut = item.status === 'out' || qtyStr === '0' || qtyStr === '' || qtyStr.includes('out');
    return isLow || isOut;
}

function renderPantryCard(item) {
    const qtyStr = (item.qty || '').toLowerCase();
    const isLow = item.status === 'use-soon' || item.status === 'low' || qtyStr.includes('low') || qtyStr.includes('almost') || qtyStr.includes('last');
    const isOut = item.status === 'out' || qtyStr === '0' || qtyStr === '' || qtyStr.includes('out');

    let statusBadge = '';
    let statusClass = '';
    if (isOut) {
        statusBadge = '<span class="pantry-card-status status-critical"><i data-lucide="circle-x"></i> Critical</span>';
        statusClass = 'status-critical';
    } else if (isLow) {
        statusBadge = '<span class="pantry-card-status status-low"><i data-lucide="circle-alert"></i> Running low</span>';
        statusClass = 'status-low';
    } else {
        statusBadge = '<span class="pantry-card-status status-stocked"><i data-lucide="circle-check"></i> Well stocked</span>';
        statusClass = 'status-stocked';
    }

    const locationIcon = item.location === 'fridge' ? '<i data-lucide="refrigerator"></i>' :
                         item.location === 'freezer' ? '<i data-lucide="snowflake"></i>' : '';

    return `
        <div class="pantry-card ${statusClass}">
            <div class="pantry-card-icon">${item.icon || getCategoryIcon(item.category)}</div>
            <div class="pantry-card-name">${item.name}</div>
            <div class="pantry-card-qty">${item.qty || 'No quantity'} ${locationIcon}</div>
            ${statusBadge}
            <div class="pantry-card-actions">
                <button class="btn-icon-sm" onclick="editPantryItemModal(${item.index})" title="Edit">
                    <i data-lucide="pencil"></i>
                </button>
                <button class="btn-icon-sm" onclick="removePantryItem(${item.index})" title="Remove">
                    <i data-lucide="trash-2"></i>
                </button>
            </div>
        </div>
    `;
}

function togglePantryCategory(cat) {
    const items = document.getElementById(`pantry-cat-${cat}`);
    const header = items?.previousElementSibling;
    const arrow = header?.querySelector('.pantry-category-arrow');

    if (items && header) {
        const isExpanded = items.classList.contains('expanded');
        if (isExpanded) {
            items.classList.remove('expanded');
            header.classList.remove('expanded');
        } else {
            items.classList.add('expanded');
            header.classList.add('expanded');
        }
    }
    refreshIcons();
}

const CATEGORY_ICONS = {
    produce: 'leaf', proteins: 'beef', dairy: 'milk',
    grains: 'wheat', spices: 'flask-round', oils: 'droplets',
    canned: 'package', frozen: 'snowflake', condiments: 'flask-round',
    baking: 'cake-slice', beverages: 'cup-soda', snacks: 'cookie',
    herbs: 'leaf', other: 'package'
};

function getCategoryIcon(category) {
    return icon(CATEGORY_ICONS[category?.toLowerCase()] || 'package');
}

function openAddPantryModal() {
    openModal(`
        <div class="modal-header">
            <h2 class="modal-title" id="modal-title-label">Add Pantry Item</h2>
            <button class="modal-close" onclick="closeModal()" aria-label="Close">Ã—</button>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label>Item Name *</label>
                <input type="text" class="form-input" id="pantry-item-name" placeholder="e.g., Olive oil">
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label>Quantity</label>
                    <input type="text" class="form-input" id="pantry-item-qty" placeholder="e.g., 2 bottles">
                </div>
                <div class="form-group">
                    <label>Category</label>
                    <select class="form-select" id="pantry-item-category">
                        <option value="">Select...</option>
                        <option value="produce">Produce</option>
                        <option value="proteins">Proteins</option>
                        <option value="dairy">Dairy</option>
                        <option value="grains">Grains</option>
                        <option value="spices">Spices</option>
                        <option value="oils">Oils & Vinegars</option>
                        <option value="canned">Canned Goods</option>
                        <option value="frozen">Frozen</option>
                        <option value="condiments">Condiments</option>
                        <option value="baking">Baking</option>
                        <option value="beverages">Beverages</option>
                        <option value="snacks">Snacks</option>
                    </select>
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label>Location</label>
                    <select class="form-select" id="pantry-item-location">
                        <option value="pantry">Pantry</option>
                        <option value="fridge">Fridge</option>
                        <option value="freezer">Freezer</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Status</label>
                    <select class="form-select" id="pantry-item-status">
                        <option value="fresh">Well Stocked</option>
                        <option value="low">Running Low</option>
                        <option value="use-soon">Use Soon</option>
                    </select>
                </div>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
            <button class="btn btn-primary" onclick="savePantryItem()"><i data-lucide="plus"></i> Add Item</button>
        </div>
    `);
}

function savePantryItem() {
    const name = document.getElementById('pantry-item-name').value.trim();
    const qty = document.getElementById('pantry-item-qty').value.trim();
    const category = document.getElementById('pantry-item-category')?.value || '';
    const location = document.getElementById('pantry-item-location')?.value || 'pantry';
    const status = document.getElementById('pantry-item-status')?.value || 'fresh';
    if (!name) { showToast('Please enter an item name', 'warning'); return; }

    const pantry = getStorage(STORAGE.PANTRY) || [];
    pantry.push({
        name, qty, category, location, status,
        icon: getCategoryIcon(category),
        addedAt: new Date().toISOString()
    });
    setStorage(STORAGE.PANTRY, pantry);
    closeModal();
    renderPantry();
    showToast(`${name} added to pantry!`, 'success');
}

function editPantryItemModal(index) {
    const pantry = getStorage(STORAGE.PANTRY) || [];
    const item = pantry[index];
    if (!item) return;

    openModal(`
        <div class="modal-header">
            <h2 class="modal-title" id="modal-title-label">Edit: ${item.name}</h2>
            <button class="modal-close" onclick="closeModal()" aria-label="Close">Ã—</button>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label>Item Name</label>
                <input type="text" class="form-input" id="edit-pantry-name" value="${item.name}">
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label>Quantity</label>
                    <input type="text" class="form-input" id="edit-pantry-qty" value="${item.qty || ''}">
                </div>
                <div class="form-group">
                    <label>Category</label>
                    <select class="form-select" id="edit-pantry-category">
                        <option value="">Select...</option>
                        ${['produce','proteins','dairy','grains','spices','oils','canned','frozen','condiments','baking','beverages','snacks'].map(c =>
                            `<option value="${c}" ${item.category === c ? 'selected' : ''}>${getCategoryIcon(c)} ${c.charAt(0).toUpperCase() + c.slice(1)}</option>`
                        ).join('')}
                    </select>
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label>Location</label>
                    <select class="form-select" id="edit-pantry-location">
                        <option value="pantry" ${item.location === 'pantry' || !item.location ? 'selected' : ''}>${icon('home',14)} Pantry</option>
                        <option value="fridge" ${item.location === 'fridge' ? 'selected' : ''}>${icon('refrigerator',14)} Fridge</option>
                        <option value="freezer" ${item.location === 'freezer' ? 'selected' : ''}>${icon('snowflake',14)} Freezer</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Status</label>
                    <select class="form-select" id="edit-pantry-status">
                        <option value="fresh" ${item.status === 'fresh' || !item.status ? 'selected' : ''}>Well Stocked</option>
                        <option value="low" ${item.status === 'low' ? 'selected' : ''}>Running Low</option>
                        <option value="use-soon" ${item.status === 'use-soon' ? 'selected' : ''}>Use Soon</option>
                        <option value="out" ${item.status === 'out' ? 'selected' : ''}>Out of Stock</option>
                    </select>
                </div>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
            <button class="btn btn-primary" onclick="updatePantryItem(${index})"><i data-lucide="save"></i> Save</button>
        </div>
    `);
}

function updatePantryItem(index) {
    const pantry = getStorage(STORAGE.PANTRY) || [];
    if (!pantry[index]) return;

    pantry[index] = {
        ...pantry[index],
        name: document.getElementById('edit-pantry-name')?.value?.trim() || pantry[index].name,
        qty: document.getElementById('edit-pantry-qty')?.value?.trim() || '',
        category: document.getElementById('edit-pantry-category')?.value || '',
        location: document.getElementById('edit-pantry-location')?.value || 'pantry',
        status: document.getElementById('edit-pantry-status')?.value || 'fresh',
        icon: getCategoryIcon(document.getElementById('edit-pantry-category')?.value || ''),
        updatedAt: new Date().toISOString()
    };

    setStorage(STORAGE.PANTRY, pantry);
    closeModal();
    renderPantry();
    showToast('Pantry item updated', 'success');
}

function removePantryItem(index) {
    const pantry = getStorage(STORAGE.PANTRY) || [];
    pantry.splice(index, 1);
    setStorage(STORAGE.PANTRY, pantry);
    renderPantry();
}

function askNonnaWithPantry() {
    const pantry = getStorage(STORAGE.PANTRY) || [];
    if (pantry.length === 0) {
        askNonna('What are some pantry staples I should keep for Mediterranean cooking?');
    } else {
        const items = pantry.map(p => p.name).join(', ');
        askNonna(`What can I make with these pantry items: ${items}?`);
    }
}

// ========================================
// PANTRY ALERTS & STATUS
// ========================================

function checkPantryStatus() {
    const pantry = getStorage(STORAGE.PANTRY) || [];
    const needsAttention = {
        runningLow: [],
        expiringSoon: [],
        outOfStock: []
    };

    // Define typical quantities for staples
    const stapleThresholds = {
        'olive oil': { min: 0.25, unit: 'bottles' },
        'lemons': { min: 2, unit: 'count' },
        'garlic': { min: 4, unit: 'cloves' },
        'cherry tomatoes': { min: 1, unit: 'containers' },
        'eggs': { min: 4, unit: 'count' },
        'butter': { min: 0.5, unit: 'sticks' }
    };

    pantry.forEach(item => {
        // Check if staple and quantity indicator suggests low
        const qtyStr = (item.qty || '').toLowerCase();
        const isLow = qtyStr.includes('low') ||
                      qtyStr.includes('running') ||
                      qtyStr.includes('almost') ||
                      qtyStr.includes('last') ||
                      qtyStr === '0' ||
                      qtyStr === '';

        // Check expiration/status
        if (item.status === 'use-soon') {
            needsAttention.expiringSoon.push(item);
        } else if (item.status === 'check') {
            needsAttention.expiringSoon.push(item);
        }

        // Check for low quantities based on common patterns
        if (isLow && !needsAttention.expiringSoon.includes(item)) {
            needsAttention.runningLow.push(item);
        }
    });

    return needsAttention;
}

function renderPantryAlerts() {
    const alertsContainer = document.getElementById('pantry-alerts');
    if (!alertsContainer) return;

    const status = checkPantryStatus();
    const hasAlerts = status.runningLow.length > 0 || status.expiringSoon.length > 0;

    if (!hasAlerts) {
        alertsContainer.innerHTML = '';
        return;
    }

    let html = '';

    // Expiring soon (urgent)
    if (status.expiringSoon.length > 0) {
        html += `
            <div class="pantry-alert-card urgent">
                <div class="pantry-alert-header">
                    <span>${icon('circle-x',14,'color:var(--danger)')}</span> Use Soon / Expiring (${status.expiringSoon.length})
                </div>
                <ul class="pantry-alert-list">
                    ${status.expiringSoon.map(item => `
                        <li>
                            <span>${item.name}${item.qty ? ` (${item.qty})` : ''}</span>
                            <span style="font-size: 0.8rem; color: var(--gray-text);">${item.status === 'check' ? 'Check date' : 'Use soon'}</span>
                        </li>
                    `).join('')}
                </ul>
            </div>
        `;
    }

    // Running low
    if (status.runningLow.length > 0) {
        html += `
            <div class="pantry-alert-card">
                <div class="pantry-alert-header">
                    <span>${icon('circle-alert',14,'color:orange')}</span> Running Low (${status.runningLow.length})
                </div>
                <ul class="pantry-alert-list">
                    ${status.runningLow.map(item => `
                        <li>
                            <span>${item.name}${item.qty ? ` (${item.qty})` : ''}</span>
                        </li>
                    `).join('')}
                </ul>
            </div>
        `;
    }

    // Add to shopping list button
    const allAlertItems = [...status.expiringSoon, ...status.runningLow];
    if (allAlertItems.length > 0) {
        html += `
            <button class="btn btn-secondary btn-block mt-8" onclick="addPantryAlertsToShopping()">
                ${icon('shopping-cart',14)} Add All to Shopping List
            </button>
        `;
    }

    alertsContainer.innerHTML = html;
}

function addPantryAlertsToShopping() {
    const status = checkPantryStatus();
    const allItems = [...status.expiringSoon, ...status.runningLow];

    if (allItems.length === 0) {
        showToast('No items need restocking');
        return;
    }

    const lists = getStorage(STORAGE.SHOPPING) || { weekly: [] };
    const listId = 'pantry-restock';

    // Create or update the restock list
    lists[listId] = {
        name: 'Pantry Restock',
        generatedFrom: 'pantry-alerts',
        createdAt: new Date().toISOString(),
        items: allItems.map(item => ({
            name: item.name,
            quantity: 'Restock',
            category: item.category || categorizeIngredient(item.name),
            checked: false,
            pantryStatus: item.status === 'use-soon' || item.status === 'check' ? 'Expiring soon' : 'Running low',
            pantryStatusType: 'missing'
        }))
    };

    setStorage(STORAGE.SHOPPING, lists);

    // Navigate to shopping list
    switchKitchenTab('shopping');
    setTimeout(() => {
        updateShoppingListDropdown();
        document.getElementById('shopping-list-select').value = listId;
        loadEnhancedShoppingList(listId);
    }, 100);

    showToast(`Added ${allItems.length} items to Pantry Restock list`);
}

// ========================================
// WHAT CAN I MAKE? (Enhanced)
// ========================================

function openWhatCanIMakeModal() {
    const pantry = getStorage(STORAGE.PANTRY) || [];
    const garden = getStorage(STORAGE.GARDEN) || [];

    if (pantry.length === 0) {
        showToast('Add items to your pantry first!');
        openAddPantryModal();
        return;
    }

    // Build ingredient summary
    const categories = {};
    pantry.forEach(item => {
        const cat = item.category || categorizeIngredient(item.name);
        if (!categories[cat]) categories[cat] = [];
        categories[cat].push(item.name);
    });

    let inventorySummary = '';
    Object.keys(categories).forEach(cat => {
        inventorySummary += `<strong>${cat}:</strong> ${categories[cat].join(', ')}<br>`;
    });

    // Add garden items if available
    if (garden && garden.length > 0) {
        const gardenItems = garden.map(g => typeof g === 'string' ? g : g.name).join(', ');
        inventorySummary += `<strong>Garden Ready:</strong> ${gardenItems}<br>`;
    }

    openModal(`
        <div class="modal-header">
            <h2 class="modal-title">${icon('chef-hat',14)} What Can I Make?</h2>
            <button class="modal-close" onclick="closeModal()">Ã—</button>
        </div>
        <div class="modal-body">
            <p class="text-muted mb-16">Nonna will suggest recipes using only what you have on hand.</p>

            <div class="card" style="padding: 12px; margin-bottom: 16px; background: var(--seafoam-light);">
                <div style="font-weight: 600; margin-bottom: 8px;">${icon('package',14)} Your Current Inventory</div>
                <div style="font-size: 0.85rem; color: var(--gray-dark);">
                    ${inventorySummary}
                </div>
            </div>

            <div class="form-group">
                <label>Recipe preferences (optional)</label>
                <div class="grid grid-2" style="gap: 8px;">
                    <label class="checkbox-item"><input type="checkbox" id="wcim-quick" value="quick"> Quick (under 30 min)</label>
                    <label class="checkbox-item"><input type="checkbox" id="wcim-easy" value="easy"> Easy prep</label>
                    <label class="checkbox-item"><input type="checkbox" id="wcim-lowcal" value="lowcal"> Low calorie</label>
                    <label class="checkbox-item"><input type="checkbox" id="wcim-protein" value="protein"> High protein</label>
                </div>
            </div>

            <div class="form-group">
                <label>Meal type</label>
                <select class="form-select" id="wcim-meal-type">
                    <option value="any">Any meal</option>
                    <option value="breakfast">Breakfast</option>
                    <option value="lunch">Lunch</option>
                    <option value="dinner">Dinner</option>
                    <option value="snack">Snack</option>
                </select>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
            <button class="btn btn-primary" onclick="askWhatCanIMake()">Ask Nonna</button>
        </div>
    `);
}

function askWhatCanIMake() {
    const pantry = getStorage(STORAGE.PANTRY) || [];
    const garden = getStorage(STORAGE.GARDEN) || [];
    const profile = getStorage(STORAGE.PROFILE) || {};

    // Get preferences
    const isQuick = document.getElementById('wcim-quick')?.checked;
    const isEasy = document.getElementById('wcim-easy')?.checked;
    const isLowCal = document.getElementById('wcim-lowcal')?.checked;
    const isHighProtein = document.getElementById('wcim-protein')?.checked;
    const mealType = document.getElementById('wcim-meal-type')?.value || 'any';

    // Build ingredient list
    const ingredients = pantry.map(item => `${item.name} (${item.qty || 'some'})`).join(', ');
    const gardenItems = garden.length > 0
        ? garden.map(g => typeof g === 'string' ? g : g.name).join(', ')
        : '';

    // Build preferences string
    const prefs = [];
    if (isQuick) prefs.push('quick (under 30 minutes)');
    if (isEasy) prefs.push('easy to prepare');
    if (isLowCal) prefs.push('lower calorie');
    if (isHighProtein) prefs.push('high protein');

    let prompt = `I want to cook using only what I have in my pantry. Here's my current inventory:

PANTRY: ${ingredients}
${gardenItems ? `GARDEN (ready to harvest): ${gardenItems}` : ''}

Suggest 5-7 recipes I can make using ONLY these ingredients (plus common staples like olive oil, salt, pepper, basic spices).

${mealType !== 'any' ? `Looking specifically for ${mealType} ideas.` : ''}
${prefs.length > 0 ? `Preferences: ${prefs.join(', ')}.` : ''}
${profile.healthConditions ? `Note: I have ${profile.healthConditions}, so keep recipes appropriate.` : ''}

For each recipe:
1. Recipe name
2. Brief description (1-2 sentences)
3. Which of my pantry items it uses
4. Estimated prep + cook time
5. Calorie estimate per serving

Present as a numbered list. Make them Mediterranean-focused when possible.`;

    closeModal();
    askNonna(prompt);
}

// ========================================
// QUICK ADD FROM DELIVERY
// ========================================

function toggleQuickAddSection() {
    const content = document.getElementById('quick-add-content');
    const header = document.querySelector('.quick-add-header .accordion-icon');
    if (content) {
        content.classList.toggle('open');
        if (header) {
            header.style.transform = content.classList.contains('open') ? 'rotate(180deg)' : 'rotate(0deg)';
        }
    }
}

const DELIVERY_TEMPLATES = {
    misfits: {
        name: 'Misfits Market Box',
        icon: icon('leaf',14),
        items: [
            { name: 'Cherry tomatoes', qty: '1 container', category: 'Produce' },
            { name: 'Mixed greens', qty: '1 bag', category: 'Produce' },
            { name: 'Bell peppers', qty: '3-4', category: 'Produce' },
            { name: 'Zucchini', qty: '2-3', category: 'Produce' },
            { name: 'Lemons', qty: '4-6', category: 'Produce' },
            { name: 'Carrots', qty: '1 bag', category: 'Produce' },
            { name: 'Potatoes', qty: '2 lbs', category: 'Produce' },
            { name: 'Onions', qty: '3-4', category: 'Produce' },
            { name: 'Apples', qty: '4-5', category: 'Produce' },
            { name: 'Sweet potatoes', qty: '2-3', category: 'Produce' }
        ]
    },
    wholefoods: {
        name: 'Whole Foods Order',
        icon: icon('shopping-cart',14),
        items: [
            { name: 'Salmon fillet', qty: '1 lb', category: 'Proteins' },
            { name: 'Chicken breast', qty: '1.5 lbs', category: 'Proteins' },
            { name: 'Greek yogurt', qty: '32 oz', category: 'Dairy' },
            { name: 'Feta cheese', qty: '8 oz', category: 'Dairy' },
            { name: 'Baby spinach', qty: '1 container', category: 'Produce' },
            { name: 'Avocados', qty: '3-4', category: 'Produce' },
            { name: 'Olive oil', qty: '1 bottle', category: 'Pantry' },
            { name: 'Hummus', qty: '1 container', category: 'Pantry' },
            { name: 'Whole grain bread', qty: '1 loaf', category: 'Grains' },
            { name: 'Eggs', qty: '1 dozen', category: 'Proteins' }
        ]
    },
    csa: {
        name: 'CSA Pickup',
        icon: icon('sprout',14),
        items: [
            { name: 'Tomatoes', qty: '1 lb', category: 'Produce' },
            { name: 'Lettuce', qty: '1 head', category: 'Produce' },
            { name: 'Cucumbers', qty: '2-3', category: 'Produce' },
            { name: 'Kale', qty: '1 bunch', category: 'Produce' },
            { name: 'Fresh herbs', qty: '1 bunch', category: 'Produce' },
            { name: 'Squash', qty: '2-3', category: 'Produce' },
            { name: 'Beets', qty: '1 bunch', category: 'Produce' },
            { name: 'Green beans', qty: '1/2 lb', category: 'Produce' }
        ]
    },
    custom: {
        name: 'Custom Delivery',
        icon: icon('plus',14),
        items: []
    }
};

function openDeliveryQuickAdd(deliveryType) {
    const template = DELIVERY_TEMPLATES[deliveryType];
    if (!template) return;

    if (deliveryType === 'custom') {
        // Open custom multi-add modal
        openCustomDeliveryModal();
        return;
    }

    const itemsHtml = template.items.map((item, i) => `
        <label class="scan-item" style="cursor: pointer;">
            <input type="checkbox" class="scan-item-checkbox" id="delivery-item-${i}" checked>
            <div class="scan-item-info">
                <div class="scan-item-name">${item.name}</div>
                <div class="scan-item-details">${item.qty} | ${item.category}</div>
            </div>
        </label>
    `).join('');

    openModal(`
        <div class="modal-header">
            <h2 class="modal-title">${template.icon} Add ${template.name} Items</h2>
            <button class="modal-close" onclick="closeModal()">Ã—</button>
        </div>
        <div class="modal-body" style="max-height: 400px; overflow-y: auto;">
            <p class="text-muted mb-16">Check what you received:</p>

            <div class="flex gap-8 mb-16">
                <button class="btn btn-sm btn-secondary" onclick="selectAllDeliveryItems(true)">Select All</button>
                <button class="btn btn-sm btn-secondary" onclick="selectAllDeliveryItems(false)">Clear</button>
            </div>

            <div id="delivery-items-list">
                ${itemsHtml}
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
            <button class="btn btn-primary" onclick="saveDeliveryItems('${deliveryType}')">Add to Pantry</button>
        </div>
        <div class="modal-footer" style="border-top: none; padding-top: 0;">
            <button class="btn btn-secondary btn-block" onclick="whatCanIMakeWithDelivery('${deliveryType}')">
                ${icon('chef-hat',14)} What Can I Make With These?
            </button>
        </div>
    `);
}

function selectAllDeliveryItems(selectAll) {
    document.querySelectorAll('[id^="delivery-item-"]').forEach(checkbox => {
        checkbox.checked = selectAll;
    });
}

function saveDeliveryItems(deliveryType) {
    const template = DELIVERY_TEMPLATES[deliveryType];
    if (!template) return;

    const pantry = getStorage(STORAGE.PANTRY) || [];
    let addedCount = 0;

    const categoryIcons = {
        'Produce': icon('leaf',14),
        'Proteins': icon('beef',14),
        'Dairy': icon('milk',14),
        'Pantry': icon('package',14),
        'Grains': icon('wheat',14)
    };

    template.items.forEach((item, i) => {
        const checkbox = document.getElementById(`delivery-item-${i}`);
        if (checkbox && checkbox.checked) {
            // Check for duplicates
            const existing = pantry.find(p =>
                p.name.toLowerCase() === item.name.toLowerCase()
            );

            if (!existing) {
                pantry.push({
                    name: item.name,
                    qty: item.qty,
                    icon: categoryIcons[item.category] || icon('package',14),
                    status: 'fresh',
                    category: item.category
                });
                addedCount++;
            } else {
                // Update quantity
                existing.qty = item.qty;
                existing.status = 'fresh';
            }
        }
    });

    setStorage(STORAGE.PANTRY, pantry);
    closeModal();
    renderPantry();
    renderPantryAlerts();

    showToast(`Added ${addedCount} items to pantry!`);
}

function whatCanIMakeWithDelivery(deliveryType) {
    const template = DELIVERY_TEMPLATES[deliveryType];
    if (!template) return;

    // Get selected items
    const selectedItems = [];
    template.items.forEach((item, i) => {
        const checkbox = document.getElementById(`delivery-item-${i}`);
        if (checkbox && checkbox.checked) {
            selectedItems.push(item.name);
        }
    });

    if (selectedItems.length === 0) {
        showToast('Select some items first');
        return;
    }

    closeModal();

    const prompt = `I just received these ingredients in my ${template.name}:

${selectedItems.join(', ')}

Suggest 3-5 quick Mediterranean recipes I can make this week using these fresh items. Focus on using them before they spoil. Include:
1. Recipe name
2. Which delivery items it uses
3. What else I might need (staples only)
4. Prep + cook time
5. Calorie estimate`;

    askNonna(prompt);
}

function openCustomDeliveryModal() {
    openModal(`
        <div class="modal-header">
            <h2 class="modal-title">${icon('plus',14)} Add Multiple Items</h2>
            <button class="modal-close" onclick="closeModal()">Ã—</button>
        </div>
        <div class="modal-body">
            <p class="text-muted mb-16">Enter items one per line (name, quantity - optional):</p>

            <textarea class="form-input" id="custom-delivery-items" rows="10" placeholder="Example:
Tomatoes, 2 lbs
Chicken breast
Olive oil, 1 bottle
Feta cheese, 8 oz"></textarea>

            <div class="form-group mt-16">
                <label>Default category</label>
                <select class="form-select" id="custom-delivery-category">
                    <option value="Produce">Produce</option>
                    <option value="Proteins">Proteins</option>
                    <option value="Dairy">Dairy</option>
                    <option value="Pantry">Pantry</option>
                    <option value="Grains">Grains</option>
                    <option value="Other">Other</option>
                </select>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
            <button class="btn btn-primary" onclick="saveCustomDeliveryItems()">Add to Pantry</button>
        </div>
    `);
}

function saveCustomDeliveryItems() {
    const textarea = document.getElementById('custom-delivery-items');
    const defaultCategory = document.getElementById('custom-delivery-category').value;

    if (!textarea || !textarea.value.trim()) {
        showToast('Enter some items first');
        return;
    }

    const lines = textarea.value.trim().split('\n');
    const pantry = getStorage(STORAGE.PANTRY) || [];
    let addedCount = 0;

    const categoryIcons = {
        'Produce': icon('leaf',14),
        'Proteins': icon('beef',14),
        'Dairy': icon('milk',14),
        'Pantry': icon('package',14),
        'Grains': icon('wheat',14),
        'Other': icon('package',14)
    };

    lines.forEach(line => {
        const trimmed = line.trim();
        if (!trimmed) return;

        // Parse "name, qty" or just "name"
        const parts = trimmed.split(',').map(p => p.trim());
        const name = parts[0];
        const qty = parts[1] || '';

        if (name) {
            const category = categorizeIngredient(name) || defaultCategory;
            const existing = pantry.find(p =>
                p.name.toLowerCase() === name.toLowerCase()
            );

            if (!existing) {
                pantry.push({
                    name: name,
                    qty: qty,
                    icon: categoryIcons[category] || icon('package',14),
                    status: 'fresh',
                    category: category
                });
                addedCount++;
            }
        }
    });

    setStorage(STORAGE.PANTRY, pantry);
    closeModal();
    renderPantry();
    renderPantryAlerts();

    showToast(`Added ${addedCount} items to pantry!`);
}

// Update renderPantry to also render alerts
const originalRenderPantry = renderPantry;

// ========================================
// PANTRY PHOTO SCANNING
// ========================================
let pantryScanState = {
    imageData: null,
    imageType: null,
    detectedItems: [],
    selectedItems: new Set()
};

function openPantryScanModal() {
    pantryScanState = {
        imageData: null,
        imageType: null,
        detectedItems: [],
        selectedItems: new Set()
    };

    openModal(`
        <div class="modal-header">
            <h2 class="modal-title">${icon('camera',14)} Scan Your Pantry</h2>
            <button class="modal-close" onclick="closeModal()">Ã—</button>
        </div>
        <div class="modal-body" id="scan-modal-body">
            <p class="text-muted mb-16">Take a photo or upload an image of your fridge, pantry, or spice rack. Nonna will identify the items for you!</p>

            <div class="scan-upload-area" id="scan-upload-area" onclick="document.getElementById('pantry-image-input').click()">
                <div class="scan-upload-icon">${icon('camera',14)}</div>
                <div class="scan-upload-text">Tap to take photo or upload</div>
                <div class="scan-upload-hint">Supports: JPG, PNG, WebP</div>
            </div>

            <input type="file" id="pantry-image-input" accept="image/*" capture="environment" style="display: none;" onchange="handlePantryImageSelect(event)">

            <img id="scan-preview" class="scan-preview hidden" alt="Preview">

            <div class="nonna-tip mt-16">
                <div class="nonna-tip-header">${icon('lightbulb',14)} Tips for best results</div>
                <div class="nonna-tip-text">
                    â€¢ Use good lighting<br>
                    â€¢ Capture labels when possible<br>
                    â€¢ Take multiple photos for different areas
                </div>
            </div>

            <p class="text-muted mt-16" style="font-size: 0.8rem;">${icon('lock',14)} Photos are analyzed securely and not stored.</p>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
            <button class="btn btn-primary" id="scan-analyze-btn" onclick="analyzePantryImage()" disabled>Analyze Photo</button>
        </div>
    `);

    // Set up drag and drop
    setTimeout(() => {
        const uploadArea = document.getElementById('scan-upload-area');
        if (uploadArea) {
            uploadArea.addEventListener('dragover', handleDragOver);
            uploadArea.addEventListener('dragleave', handleDragLeave);
            uploadArea.addEventListener('drop', handleDrop);
        }
    }, 100);
}

function handleDragOver(e) {
    e.preventDefault();
    e.currentTarget.classList.add('dragover');
}

function handleDragLeave(e) {
    e.currentTarget.classList.remove('dragover');
}

function handleDrop(e) {
    e.preventDefault();
    e.currentTarget.classList.remove('dragover');

    const files = e.dataTransfer.files;
    if (files.length > 0 && files[0].type.startsWith('image/')) {
        processImageFile(files[0]);
    }
}

function handlePantryImageSelect(event) {
    const file = event.target.files[0];
    if (file) {
        processImageFile(file);
    }
}

function processImageFile(file) {
    // Validate file type
    const allowedTypes = ['image/jpeg', 'image/png', 'image/gif', 'image/webp'];
    if (!allowedTypes.includes(file.type)) {
        showToast('Please use JPG, PNG, or WebP images');
        return;
    }

    // Validate file size (max 10MB)
    if (file.size > 10 * 1024 * 1024) {
        showToast('Image too large. Max 10MB.');
        return;
    }

    pantryScanState.imageType = file.type;

    const reader = new FileReader();
    reader.onload = (e) => {
        const base64Full = e.target.result;
        pantryScanState.imageData = base64Full.split(',')[1]; // Remove data:image/xxx;base64, prefix

        // Show preview
        const preview = document.getElementById('scan-preview');
        if (preview) {
            preview.src = base64Full;
            preview.classList.remove('hidden');
        }

        // Update upload area
        const uploadArea = document.getElementById('scan-upload-area');
        if (uploadArea) {
            uploadArea.innerHTML = `
                <div class="scan-upload-icon">${icon('check-circle',14)}</div>
                <div class="scan-upload-text">Photo ready!</div>
                <div class="scan-upload-hint">Tap to change photo</div>
            `;
        }

        // Enable analyze button
        const btn = document.getElementById('scan-analyze-btn');
        if (btn) {
            btn.disabled = false;
        }
    };
    reader.readAsDataURL(file);
}

async function analyzePantryImage() {
    if (!pantryScanState.imageData) {
        showToast('Please select an image first');
        return;
    }

    // Show loading state
    const modalBody = document.getElementById('scan-modal-body');
    modalBody.innerHTML = `
        <div class="scan-loading">
            <div class="scan-loading-icon">${icon('search',14)}</div>
            <div class="scan-loading-text">
                <strong>Nonna is scanning your kitchen...</strong><br>
                <span class="text-muted">Identifying items and quantities</span>
            </div>
        </div>
    `;

    // Disable buttons during processing
    const analyzeBtn = document.getElementById('scan-analyze-btn');
    if (analyzeBtn) analyzeBtn.disabled = true;

    try {
        const response = await fetch('/.netlify/functions/analyze-pantry-image', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                image: pantryScanState.imageData,
                imageType: pantryScanState.imageType
            })
        });

        const data = await response.json();

        if (!response.ok) {
            throw new Error(data.error || 'Failed to analyze image');
        }

        if (data.items && data.items.length > 0) {
            pantryScanState.detectedItems = data.items;
            // Select all items by default
            pantryScanState.selectedItems = new Set(data.items.map((_, i) => i));
            showScanResults();
        } else {
            showScanError(data.message || 'No items detected. Try a clearer photo with better lighting.');
        }

    } catch (error) {
        console.error('Scan error:', error);
        showScanError(error.message || 'Failed to analyze image. Please try again.');
    }
}

function showScanError(message) {
    const modalBody = document.getElementById('scan-modal-body');
    modalBody.innerHTML = `
        <div class="empty-state">
            <div class="empty-state-icon">${icon('frown',14)}</div>
            <div class="empty-state-title">Couldn't detect items</div>
            <p>${message}</p>
            <button class="btn btn-primary mt-16" onclick="openPantryScanModal()">Try Again</button>
        </div>
    `;

    // Update footer
    const modal = document.querySelector('.modal');
    const footer = modal.querySelector('.modal-footer');
    if (footer) {
        footer.innerHTML = `
            <button class="btn btn-secondary" onclick="closeModal()">Close</button>
        `;
    }
}

function showScanResults() {
    const items = pantryScanState.detectedItems;

    // Group items by category
    const categories = {};
    items.forEach((item, index) => {
        const cat = item.category || 'Other';
        if (!categories[cat]) categories[cat] = [];
        categories[cat].push({ ...item, index });
    });

    // Category icons
    const categoryIcons = {
        'Produce': icon('leaf',14),
        'Proteins': icon('beef',14),
        'Dairy': icon('milk',14),
        'Grains': icon('wheat',14),
        'Canned Goods': icon('package',14),
        'Spices': icon('flask-round',14),
        'Condiments': icon('flask-round',14),
        'Frozen': icon('snowflake',14),
        'Beverages': icon('cup-soda',14),
        'Snacks': icon('cookie',14),
        'Other': icon('package',14)
    };

    // Status badge helper
    const getStatusBadge = (status) => {
        const statusMap = {
            'Fresh': { class: 'fresh', text: icon('circle-check',12,'color:var(--success)') + ' Fresh' },
            'Use Soon': { class: 'use-soon', text: icon('circle-alert',12,'color:orange') + ' Use Soon' },
            'Check Date': { class: 'check', text: icon('circle-x',12,'color:var(--danger)') + ' Check Date' }
        };
        const s = statusMap[status] || statusMap['Fresh'];
        return `<span class="scan-item-badge ${s.class}">${s.text}</span>`;
    };

    // Build HTML
    let html = `
        <div class="scan-results-header">
            <span class="scan-results-count">âœ“ Found ${items.length} items!</span>
            <div>
                <button class="btn btn-sm btn-ghost" onclick="selectAllScanItems(true)">Select All</button>
                <button class="btn btn-sm btn-ghost" onclick="selectAllScanItems(false)">Deselect All</button>
            </div>
        </div>
        <p class="text-muted mb-16">Review and uncheck any incorrect items before adding.</p>
    `;

    // Render by category
    Object.keys(categories).sort().forEach(cat => {
        const catItems = categories[cat];
        html += `<div class="scan-category-header">${categoryIcons[cat] || icon('package',14)} ${cat} (${catItems.length})</div>`;

        catItems.forEach(item => {
            const checked = pantryScanState.selectedItems.has(item.index) ? 'checked' : '';
            html += `
                <div class="scan-item" id="scan-item-${item.index}">
                    <input type="checkbox" class="scan-item-checkbox" ${checked} onchange="toggleScanItem(${item.index})">
                    <div class="scan-item-info">
                        <div class="scan-item-name">${item.name}</div>
                        <div class="scan-item-details">
                            ${item.quantity} Â· ${item.location || 'Pantry'}
                            ${getStatusBadge(item.expirationConcern)}
                            ${item.confidence === 'low' ? `<span class="scan-item-badge">${icon('help-circle',12)} Verify</span>` : ''}
                        </div>
                    </div>
                    <div class="scan-item-actions">
                        <button class="icon-btn" onclick="editScanItem(${item.index})" title="Edit">${icon('pencil',14)}</button>
                        <button class="icon-btn" onclick="removeScanItem(${item.index})" title="Remove">${icon('trash-2',14)}</button>
                    </div>
                </div>
            `;
        });
    });

    html += `
        <button class="btn btn-ghost btn-block mt-16" onclick="addManualScanItem()">+ Add item manually</button>
    `;

    const modalBody = document.getElementById('scan-modal-body');
    modalBody.innerHTML = html;

    // Update footer
    const modal = document.querySelector('.modal');
    const footer = modal.querySelector('.modal-footer');
    if (footer) {
        footer.innerHTML = `
            <button class="btn btn-secondary" onclick="openPantryScanModal()">Scan Another</button>
            <button class="btn btn-primary" onclick="addScannedItemsToPantry()">Add ${pantryScanState.selectedItems.size} Items</button>
        `;
    }
}

function toggleScanItem(index) {
    if (pantryScanState.selectedItems.has(index)) {
        pantryScanState.selectedItems.delete(index);
    } else {
        pantryScanState.selectedItems.add(index);
    }
    updateScanFooter();
}

function selectAllScanItems(selectAll) {
    if (selectAll) {
        pantryScanState.detectedItems.forEach((_, i) => pantryScanState.selectedItems.add(i));
    } else {
        pantryScanState.selectedItems.clear();
    }

    // Update checkboxes
    document.querySelectorAll('.scan-item-checkbox').forEach((cb, i) => {
        cb.checked = selectAll;
    });

    updateScanFooter();
}

function updateScanFooter() {
    const addBtn = document.querySelector('.modal-footer .btn-primary');
    if (addBtn) {
        addBtn.textContent = `Add ${pantryScanState.selectedItems.size} Items`;
        addBtn.disabled = pantryScanState.selectedItems.size === 0;
    }
}

function editScanItem(index) {
    const item = pantryScanState.detectedItems[index];

    openModal(`
        <div class="modal-header">
            <h2 class="modal-title">Edit Item</h2>
            <button class="modal-close" onclick="showScanResultsModal()">Ã—</button>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label>Name</label>
                <input type="text" class="form-input" id="edit-scan-name" value="${item.name}">
            </div>
            <div class="form-group">
                <label>Quantity</label>
                <input type="text" class="form-input" id="edit-scan-qty" value="${item.quantity}">
            </div>
            <div class="form-group">
                <label>Category</label>
                <select class="form-select" id="edit-scan-category">
                    <option value="Produce" ${item.category === 'Produce' ? 'selected' : ''}>Produce</option>
                    <option value="Proteins" ${item.category === 'Proteins' ? 'selected' : ''}>Proteins</option>
                    <option value="Dairy" ${item.category === 'Dairy' ? 'selected' : ''}>Dairy</option>
                    <option value="Grains" ${item.category === 'Grains' ? 'selected' : ''}>Grains</option>
                    <option value="Canned Goods" ${item.category === 'Canned Goods' ? 'selected' : ''}>Canned Goods</option>
                    <option value="Spices" ${item.category === 'Spices' ? 'selected' : ''}>Spices</option>
                    <option value="Condiments" ${item.category === 'Condiments' ? 'selected' : ''}>Condiments</option>
                    <option value="Frozen" ${item.category === 'Frozen' ? 'selected' : ''}>Frozen</option>
                    <option value="Beverages" ${item.category === 'Beverages' ? 'selected' : ''}>Beverages</option>
                    <option value="Snacks" ${item.category === 'Snacks' ? 'selected' : ''}>Snacks</option>
                    <option value="Other" ${item.category === 'Other' ? 'selected' : ''}>Other</option>
                </select>
            </div>
            <div class="form-group">
                <label>Location</label>
                <select class="form-select" id="edit-scan-location">
                    <option value="Fridge" ${item.location === 'Fridge' ? 'selected' : ''}>Fridge</option>
                    <option value="Pantry" ${item.location === 'Pantry' ? 'selected' : ''}>Pantry</option>
                    <option value="Freezer" ${item.location === 'Freezer' ? 'selected' : ''}>Freezer</option>
                    <option value="Spice Rack" ${item.location === 'Spice Rack' ? 'selected' : ''}>Spice Rack</option>
                </select>
            </div>
            <div class="form-group">
                <label>Status</label>
                <select class="form-select" id="edit-scan-status">
                    <option value="Fresh" ${item.expirationConcern === 'Fresh' ? 'selected' : ''}>Fresh</option>
                    <option value="Use Soon" ${item.expirationConcern === 'Use Soon' ? 'selected' : ''}>Use Soon</option>
                    <option value="Check Date" ${item.expirationConcern === 'Check Date' ? 'selected' : ''}>Check Date</option>
                </select>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="showScanResultsModal()">Cancel</button>
            <button class="btn btn-primary" onclick="saveScanItemEdit(${index})">Save</button>
        </div>
    `);
}

function saveScanItemEdit(index) {
    const item = pantryScanState.detectedItems[index];
    item.name = document.getElementById('edit-scan-name').value.trim();
    item.quantity = document.getElementById('edit-scan-qty').value.trim();
    item.category = document.getElementById('edit-scan-category').value;
    item.location = document.getElementById('edit-scan-location').value;
    item.expirationConcern = document.getElementById('edit-scan-status').value;

    showScanResultsModal();
}

function removeScanItem(index) {
    pantryScanState.detectedItems.splice(index, 1);
    pantryScanState.selectedItems.delete(index);

    // Reindex selected items
    const newSelected = new Set();
    pantryScanState.selectedItems.forEach(i => {
        if (i < index) newSelected.add(i);
        else if (i > index) newSelected.add(i - 1);
    });
    pantryScanState.selectedItems = newSelected;

    if (pantryScanState.detectedItems.length === 0) {
        showScanError('All items removed. Scan another photo or add manually.');
    } else {
        showScanResults();
    }
}

function addManualScanItem() {
    openModal(`
        <div class="modal-header">
            <h2 class="modal-title">Add Item</h2>
            <button class="modal-close" onclick="showScanResultsModal()">Ã—</button>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label>Name</label>
                <input type="text" class="form-input" id="add-scan-name" placeholder="e.g., Roma tomatoes">
            </div>
            <div class="form-group">
                <label>Quantity</label>
                <input type="text" class="form-input" id="add-scan-qty" placeholder="e.g., 4 tomatoes">
            </div>
            <div class="form-group">
                <label>Category</label>
                <select class="form-select" id="add-scan-category">
                    <option value="Produce">Produce</option>
                    <option value="Proteins">Proteins</option>
                    <option value="Dairy">Dairy</option>
                    <option value="Grains">Grains</option>
                    <option value="Canned Goods">Canned Goods</option>
                    <option value="Spices">Spices</option>
                    <option value="Condiments">Condiments</option>
                    <option value="Frozen">Frozen</option>
                    <option value="Beverages">Beverages</option>
                    <option value="Snacks">Snacks</option>
                    <option value="Other" selected>Other</option>
                </select>
            </div>
            <div class="form-group">
                <label>Location</label>
                <select class="form-select" id="add-scan-location">
                    <option value="Pantry" selected>Pantry</option>
                    <option value="Fridge">Fridge</option>
                    <option value="Freezer">Freezer</option>
                    <option value="Spice Rack">Spice Rack</option>
                </select>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="showScanResultsModal()">Cancel</button>
            <button class="btn btn-primary" onclick="saveManualScanItem()">Add</button>
        </div>
    `);
}

function saveManualScanItem() {
    const name = document.getElementById('add-scan-name').value.trim();
    const qty = document.getElementById('add-scan-qty').value.trim() || '1';
    const category = document.getElementById('add-scan-category').value;
    const location = document.getElementById('add-scan-location').value;

    if (!name) {
        showToast('Please enter an item name');
        return;
    }

    const newIndex = pantryScanState.detectedItems.length;
    pantryScanState.detectedItems.push({
        name,
        quantity: qty,
        category,
        location,
        expirationConcern: 'Fresh',
        confidence: 'high'
    });
    pantryScanState.selectedItems.add(newIndex);

    showScanResultsModal();
}

function showScanResultsModal() {
    openModal(`
        <div class="modal-header">
            <h2 class="modal-title">${icon('camera',14)} Scan Results</h2>
            <button class="modal-close" onclick="closeModal()">Ã—</button>
        </div>
        <div class="modal-body" id="scan-modal-body"></div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="openPantryScanModal()">Scan Another</button>
            <button class="btn btn-primary" onclick="addScannedItemsToPantry()">Add ${pantryScanState.selectedItems.size} Items</button>
        </div>
    `);

    setTimeout(() => showScanResults(), 50);
}

function addScannedItemsToPantry() {
    if (pantryScanState.selectedItems.size === 0) {
        showToast('No items selected');
        return;
    }

    const pantry = getStorage(STORAGE.PANTRY) || [];

    // Category to icon mapping
    const categoryIcons = {
        'Produce': icon('leaf',14),
        'Proteins': icon('beef',14),
        'Dairy': icon('milk',14),
        'Grains': icon('wheat',14),
        'Canned Goods': icon('package',14),
        'Spices': icon('flask-round',14),
        'Condiments': icon('flask-round',14),
        'Frozen': icon('snowflake',14),
        'Beverages': icon('cup-soda',14),
        'Snacks': icon('cookie',14),
        'Other': icon('package',14)
    };

    // Status mapping
    const statusMap = {
        'Fresh': 'fresh',
        'Use Soon': 'use-soon',
        'Check Date': 'check'
    };

    let addedCount = 0;
    let duplicateCount = 0;

    pantryScanState.selectedItems.forEach(index => {
        const item = pantryScanState.detectedItems[index];

        // Check for duplicates (case-insensitive name match)
        const existingIndex = pantry.findIndex(p =>
            p.name.toLowerCase() === item.name.toLowerCase()
        );

        if (existingIndex >= 0) {
            // Update existing item's quantity
            pantry[existingIndex].qty = item.quantity;
            pantry[existingIndex].status = statusMap[item.expirationConcern] || 'fresh';
            duplicateCount++;
        } else {
            // Add new item
            pantry.push({
                name: item.name,
                qty: item.quantity,
                icon: categoryIcons[item.category] || icon('package',14),
                status: statusMap[item.expirationConcern] || 'fresh',
                category: item.category,
                location: item.location
            });
            addedCount++;
        }
    });

    setStorage(STORAGE.PANTRY, pantry);
    closeModal();
    renderPantry();

    // Show confirmation
    let message = `${icon('check-circle',14)} ${addedCount} items added to pantry!`;
    if (duplicateCount > 0) {
        message += ` (${duplicateCount} updated)`;
    }
    showToast(message);
}

// ========================================
// KITCHEN - SHOPPING
// ========================================
function loadShoppingList() {
    const listName = document.getElementById('shopping-list-select').value;
    const lists = getStorage(STORAGE.SHOPPING) || { weekly: [] };
    const items = lists[listName] || [];
    const container = document.getElementById('shopping-list');
    const empty = document.getElementById('shopping-empty');

    if (items.length === 0) {
        container.innerHTML = '';
        empty.classList.remove('hidden');
        return;
    }

    empty.classList.add('hidden');
    container.innerHTML = items.map((item, i) => `
        <div class="shopping-item ${item.checked ? 'checked' : ''}">
            <input type="checkbox" class="shopping-item-checkbox" ${item.checked ? 'checked' : ''} onchange="toggleShoppingItem('${listName}', ${i})">
            <span class="shopping-item-name">${item.name}</span>
        </div>
    `).join('');
}

function toggleShoppingItem(listName, index) {
    const lists = getStorage(STORAGE.SHOPPING) || {};
    if (lists[listName] && lists[listName][index]) {
        lists[listName][index].checked = !lists[listName][index].checked;
        setStorage(STORAGE.SHOPPING, lists);
        loadShoppingList();
    }
}

function openAddShoppingModal() {
    openModal(`
        <div class="modal-header">
            <h2 class="modal-title">Add Item</h2>
            <button class="modal-close" onclick="closeModal()">Ã—</button>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label>Item</label>
                <input type="text" class="form-input" id="shopping-item-input" placeholder="e.g., 2 lbs salmon">
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
            <button class="btn btn-primary" onclick="saveShoppingItem()">Add</button>
        </div>
    `);
}

function saveShoppingItem() {
    const name = document.getElementById('shopping-item-input').value.trim();
    if (!name) return;

    const listName = document.getElementById('shopping-list-select').value;
    const lists = getStorage(STORAGE.SHOPPING) || { weekly: [] };
    if (!lists[listName]) lists[listName] = [];
    lists[listName].push({ name, checked: false });
    setStorage(STORAGE.SHOPPING, lists);
    closeModal();
    loadShoppingList();
}

function clearCheckedItems() {
    const listName = document.getElementById('shopping-list-select').value;
    const lists = getStorage(STORAGE.SHOPPING) || {};
    if (lists[listName]) {
        lists[listName] = lists[listName].filter(item => !item.checked);
        setStorage(STORAGE.SHOPPING, lists);
        loadShoppingList();
    }
}

function printShoppingList() {
    window.print();
}

// ========================================
// SMART SHOPPING LIST GENERATOR
// ========================================

// Price database for Asheville area (estimated prices)
const PRICE_DATABASE = {
    // Produce
    'tomatoes': { price: 3.99, unit: 'lb', category: 'Produce' },
    'roma tomatoes': { price: 2.99, unit: 'lb', category: 'Produce' },
    'cherry tomatoes': { price: 4.99, unit: 'container', category: 'Produce' },
    'spinach': { price: 4.99, unit: 'bag', category: 'Produce' },
    'baby spinach': { price: 5.99, unit: 'bag', category: 'Produce' },
    'bell peppers': { price: 1.49, unit: 'each', category: 'Produce' },
    'red bell pepper': { price: 1.49, unit: 'each', category: 'Produce' },
    'onion': { price: 0.99, unit: 'each', category: 'Produce' },
    'onions': { price: 0.99, unit: 'each', category: 'Produce' },
    'garlic': { price: 0.79, unit: 'bulb', category: 'Produce' },
    'lemons': { price: 0.79, unit: 'each', category: 'Produce' },
    'lemon': { price: 0.79, unit: 'each', category: 'Produce' },
    'zucchini': { price: 1.99, unit: 'each', category: 'Produce' },
    'cucumber': { price: 1.29, unit: 'each', category: 'Produce' },
    'carrots': { price: 2.49, unit: 'bag', category: 'Produce' },
    'avocado': { price: 1.99, unit: 'each', category: 'Produce' },
    'potatoes': { price: 3.99, unit: 'bag', category: 'Produce' },
    'sweet potato': { price: 1.49, unit: 'each', category: 'Produce' },
    'kale': { price: 2.99, unit: 'bunch', category: 'Produce' },
    'mixed greens': { price: 5.99, unit: 'container', category: 'Produce' },
    'herbs': { price: 2.99, unit: 'bunch', category: 'Produce' },
    'basil': { price: 2.99, unit: 'bunch', category: 'Produce' },
    'parsley': { price: 1.99, unit: 'bunch', category: 'Produce' },
    'cilantro': { price: 1.49, unit: 'bunch', category: 'Produce' },

    // Proteins
    'chicken breast': { price: 6.99, unit: 'lb', category: 'Proteins' },
    'chicken breasts': { price: 6.99, unit: 'lb', category: 'Proteins' },
    'chicken thighs': { price: 4.99, unit: 'lb', category: 'Proteins' },
    'salmon': { price: 12.99, unit: 'lb', category: 'Proteins' },
    'salmon fillet': { price: 12.99, unit: 'lb', category: 'Proteins' },
    'cod': { price: 10.99, unit: 'lb', category: 'Proteins' },
    'cod fillet': { price: 10.99, unit: 'lb', category: 'Proteins' },
    'shrimp': { price: 11.99, unit: 'lb', category: 'Proteins' },
    'ground beef': { price: 7.99, unit: 'lb', category: 'Proteins' },
    'ground turkey': { price: 6.99, unit: 'lb', category: 'Proteins' },
    'eggs': { price: 4.99, unit: 'dozen', category: 'Proteins' },
    'tofu': { price: 3.49, unit: 'block', category: 'Proteins' },

    // Dairy
    'greek yogurt': { price: 5.99, unit: 'container', category: 'Dairy' },
    'feta cheese': { price: 5.99, unit: 'container', category: 'Dairy' },
    'parmesan': { price: 7.99, unit: 'wedge', category: 'Dairy' },
    'mozzarella': { price: 4.99, unit: 'ball', category: 'Dairy' },
    'milk': { price: 4.49, unit: 'gallon', category: 'Dairy' },
    'butter': { price: 5.49, unit: 'lb', category: 'Dairy' },

    // Pantry Items
    'olive oil': { price: 12.99, unit: 'bottle', category: 'Pantry' },
    'chickpeas': { price: 1.49, unit: 'can', category: 'Pantry' },
    'canned tomatoes': { price: 1.99, unit: 'can', category: 'Pantry' },
    'diced tomatoes': { price: 1.99, unit: 'can', category: 'Pantry' },
    'pasta': { price: 2.49, unit: 'box', category: 'Pantry' },
    'rice': { price: 3.99, unit: 'bag', category: 'Pantry' },
    'quinoa': { price: 6.99, unit: 'bag', category: 'Pantry' },
    'lentils': { price: 2.99, unit: 'bag', category: 'Pantry' },
    'beans': { price: 1.49, unit: 'can', category: 'Pantry' },
    'black beans': { price: 1.49, unit: 'can', category: 'Pantry' },
    'white beans': { price: 1.49, unit: 'can', category: 'Pantry' },
    'tahini': { price: 7.99, unit: 'jar', category: 'Pantry' },
    'honey': { price: 8.99, unit: 'jar', category: 'Pantry' },
    'maple syrup': { price: 12.99, unit: 'bottle', category: 'Pantry' },
    'bread': { price: 4.99, unit: 'loaf', category: 'Pantry' },
    'pita': { price: 3.49, unit: 'pack', category: 'Pantry' },
    'tortillas': { price: 3.99, unit: 'pack', category: 'Pantry' }
};

// Category icons for shopping list display
// CATEGORY_ICONS defined at line ~9925, getCategoryIcon() at ~9933

// Typical Mediterranean staples to suggest
const TYPICAL_STAPLES = [
    { name: 'Lemons', category: 'Produce', quantity: '4-6' },
    { name: 'Olive oil', category: 'Pantry', quantity: '1 bottle' },
    { name: 'Garlic', category: 'Produce', quantity: '2 bulbs' },
    { name: 'Cherry tomatoes', category: 'Produce', quantity: '1 container' },
    { name: 'Fresh herbs (basil/parsley)', category: 'Produce', quantity: '1 bunch' },
    { name: 'Greek yogurt', category: 'Dairy', quantity: '1 container' },
    { name: 'Feta cheese', category: 'Dairy', quantity: '1 container' }
];

// ========================================
// WINE PAIRING GUIDE
// ========================================
const WINE_PAIRINGS = {
    proteins: {
        chicken: {
            default: { style: 'Unoaked Chardonnay or Pinot Grigio', reason: 'Light, crisp wines complement grilled/roasted chicken', bottles: ['Barefoot Chardonnay ($8)', 'Santa Margherita Pinot Grigio ($14)'] },
            lemon: { style: 'Sauvignon Blanc or AlbariÃ±o', reason: 'Citrus notes in the wine echo the lemon flavors', bottles: ['Kim Crawford Sauvignon Blanc ($12)', 'Martin Codax AlbariÃ±o ($11)'] },
            tomato: { style: 'Chianti or Tempranillo', reason: 'Tomato-based dishes pair with medium Italian/Spanish reds', bottles: ['Ruffino Chianti ($10)', 'Campo Viejo Tempranillo ($9)'] },
            creamy: { style: 'Oaked Chardonnay', reason: 'Rich, buttery wine matches creamy sauces', bottles: ['Kendall-Jackson Chardonnay ($13)', 'La Crema Chardonnay ($15)'] },
            spicy: { style: 'Off-dry Riesling', reason: 'Slight sweetness tames the heat', bottles: ['Dr. Loosen Riesling ($11)', 'Chateau Ste. Michelle Riesling ($9)'] }
        },
        fish: {
            default: { style: 'Pinot Grigio or Vinho Verde', reason: 'Light, crisp wines let delicate fish shine', bottles: ['Ecco Domani Pinot Grigio ($10)', 'Casal Garcia Vinho Verde ($8)'] },
            salmon: { style: 'Light Pinot Noir or RosÃ©', reason: 'Salmon\'s richness can handle lighter reds or dry rosÃ©', bottles: ['Meiomi Pinot Noir ($15)', 'Whispering Angel RosÃ© ($14)'] },
            shellfish: { style: 'AlbariÃ±o or Muscadet', reason: 'Mineral wines from coastal regions pair perfectly', bottles: ['Martin Codax AlbariÃ±o ($11)', 'Domaine de la PÃ©piÃ¨re Muscadet ($12)'] },
            grilled: { style: 'Vermentino or Assyrtiko', reason: 'Herbal notes complement grilled seafood', bottles: ['Argiolas Vermentino ($12)', 'Sigalas Assyrtiko ($15)'] }
        },
        lamb: {
            default: { style: 'Syrah or Cabernet Sauvignon', reason: 'Bold reds stand up to lamb\'s richness', bottles: ['19 Crimes Shiraz ($10)', 'Josh Cellars Cabernet ($13)'] },
            herb: { style: 'Bordeaux blend or Rioja', reason: 'Herbal notes in the wine complement rosemary and thyme', bottles: ['Mouton Cadet Bordeaux ($12)', 'MarquÃ©s de CÃ¡ceres Rioja ($11)'] },
            braised: { style: 'CÃ´tes du RhÃ´ne or Aglianico', reason: 'Rustic, earthy wines for slow-cooked dishes', bottles: ['E. Guigal CÃ´tes du RhÃ´ne ($12)', 'Feudi di San Gregorio Aglianico ($14)'] }
        },
        pork: {
            default: { style: 'Pinot Noir or Spanish Garnacha', reason: 'Medium-bodied reds complement pork\'s sweetness', bottles: ['Meiomi Pinot Noir ($15)', 'Garnacha de Fuego ($8)'] },
            spicy: { style: 'Zinfandel or Malbec', reason: 'Fruit-forward wines balance spiced pork', bottles: ['Ravenswood Zinfandel ($11)', 'Alamos Malbec ($10)'] }
        },
        vegetarian: {
            default: { style: 'RosÃ© or Light Red', reason: 'Versatile wines work with diverse vegetable dishes', bottles: ['CÃ´tes de Provence RosÃ© ($12)', 'Beaujolais Villages ($11)'] },
            grilled: { style: 'Vermentino or GrÃ¼ner Veltliner', reason: 'Herbal, fresh wines enhance grilled vegetables', bottles: ['Argiolas Vermentino ($12)', 'Hugl GrÃ¼ner Veltliner ($11)'] }
        }
    },
    cuisines: {
        spanish: { style: 'Spanish wines - Tempranillo, Garnacha, AlbariÃ±o', bottles: ['Campo Viejo Tempranillo ($9)', 'Borsao Garnacha ($8)'] },
        greek: { style: 'Greek wines - Assyrtiko, Moschofilero', bottles: ['Sigalas Assyrtiko ($15)', 'Boutari Moschofilero ($12)'] },
        italian: { style: 'Italian wines - Chianti, Montepulciano, Vermentino', bottles: ['Ruffino Chianti ($10)', 'Masciarelli Montepulciano ($11)'] },
        moroccan: { style: 'CÃ´tes du RhÃ´ne or off-dry Riesling', reason: 'Complex spices need versatile wines', bottles: ['E. Guigal CÃ´tes du RhÃ´ne ($12)', 'Dr. Loosen Riesling ($11)'] },
        lebanese: { style: 'Lebanese reds or RosÃ©', bottles: ['ChÃ¢teau Musar ($18)', 'ChÃ¢teau Kefraya RosÃ© ($14)'] }
    },
    sauces: {
        tomato: { style: 'Italian reds - Chianti, Sangiovese', bottles: ['Ruffino Chianti ($10)', 'Antinori Santa Cristina ($11)'] },
        citrus: { style: 'Sauvignon Blanc or Verdicchio', bottles: ['Kim Crawford Sauvignon Blanc ($12)', 'Bucci Verdicchio ($13)'] },
        creamy: { style: 'Oaked Chardonnay or White Rioja', bottles: ['Kendall-Jackson Chardonnay ($13)', 'CVNE Monopole ($12)'] },
        spicy: { style: 'Off-dry Riesling or GewÃ¼rztraminer', bottles: ['Dr. Loosen Riesling ($11)', 'Trimbach GewÃ¼rztraminer ($15)'] }
    },
    universal: {
        rosÃ©: { style: 'Provence RosÃ©', reason: 'Works with almost anything Mediterranean', bottles: ['AIX RosÃ© ($15)', 'Whispering Angel ($14)'] },
        white: { style: 'AlbariÃ±o', reason: 'Versatile white that pairs with seafood and chicken', bottles: ['Martin Codax AlbariÃ±o ($11)', 'Burgans AlbariÃ±o ($12)'] },
        red: { style: 'CÃ´tes du RhÃ´ne', reason: 'Food-friendly blend for meats and hearty dishes', bottles: ['E. Guigal CÃ´tes du RhÃ´ne ($12)', 'M. Chapoutier Belleruche ($11)'] }
    }
};

function getWinePairing(recipe) {
    const title = (recipe.title || '').toLowerCase();
    const ingredients = (recipe.ingredients || []).join(' ').toLowerCase();
    const tags = (recipe.tags || []).map(t => t.toLowerCase());
    const combined = title + ' ' + ingredients + ' ' + tags.join(' ');

    let protein = null;
    let sauce = null;
    let cuisine = null;

    // Detect protein
    if (/chicken|pollo/.test(combined)) protein = 'chicken';
    else if (/salmon|cod|branzino|fish|seafood|shrimp|scallop|tuna/.test(combined)) protein = 'fish';
    else if (/lamb/.test(combined)) protein = 'lamb';
    else if (/pork/.test(combined)) protein = 'pork';
    else if (/vegetarian|vegan|tofu|bean|lentil|chickpea/.test(combined)) protein = 'vegetarian';

    // Detect sauce/flavor profile
    if (/lemon|citrus|lime/.test(combined)) sauce = 'lemon';
    else if (/tomato|marinara/.test(combined)) sauce = 'tomato';
    else if (/cream|creamy|butter/.test(combined)) sauce = 'creamy';
    else if (/harissa|spicy|chili/.test(combined)) sauce = 'spicy';
    else if (/herb|rosemary|thyme/.test(combined)) sauce = 'herb';

    // Detect cuisine
    if (/spanish|paella|chorizo|tapas/.test(combined)) cuisine = 'spanish';
    else if (/greek|feta|tzatziki|moussaka/.test(combined)) cuisine = 'greek';
    else if (/italian|pasta|risotto|pesto/.test(combined)) cuisine = 'italian';
    else if (/moroccan|tagine|harissa/.test(combined)) cuisine = 'moroccan';
    else if (/lebanese|falafel|hummus|za'atar/.test(combined)) cuisine = 'lebanese';

    // Get the best pairing
    let pairing = null;

    if (protein && WINE_PAIRINGS.proteins[protein]) {
        const proteinPairings = WINE_PAIRINGS.proteins[protein];
        if (sauce && proteinPairings[sauce]) {
            pairing = proteinPairings[sauce];
        } else {
            pairing = proteinPairings.default;
        }
    } else if (cuisine && WINE_PAIRINGS.cuisines[cuisine]) {
        pairing = WINE_PAIRINGS.cuisines[cuisine];
    } else if (sauce && WINE_PAIRINGS.sauces[sauce]) {
        pairing = WINE_PAIRINGS.sauces[sauce];
    } else {
        // Default to rosÃ© as universal pairing
        pairing = WINE_PAIRINGS.universal.rosÃ©;
    }

    return {
        style: pairing.style,
        reason: pairing.reason || `A versatile choice that complements Mediterranean flavors.`,
        bottles: pairing.bottles || WINE_PAIRINGS.universal.rosÃ©.bottles,
        cuisine: cuisine,
        protein: protein
    };
}

function renderWinePairingSection(recipe) {
    const pairing = getWinePairing(recipe);
    return `
        <div class="wine-pairing-section">
            <div class="wine-pairing-header" onclick="toggleWinePairing(this)">
                <span class="wine-pairing-icon">${icon('wine',14)}</span>
                <span class="wine-pairing-title">Wine Pairing Suggestion</span>
                <span class="wine-pairing-toggle">â–¼</span>
            </div>
            <div class="wine-pairing-content hidden">
                <div class="wine-style">
                    <strong>Recommended:</strong> ${pairing.style}
                </div>
                <div class="wine-reason">
                    <em>${pairing.reason}</em>
                </div>
                <div class="wine-bottles">
                    <div class="wine-bottles-title">Budget-Friendly Options ($10-15):</div>
                    ${pairing.bottles.map(b => `<div class="wine-bottle">${icon('wine',14)} ${b}</div>`).join('')}
                </div>
            </div>
        </div>
    `;
}

function toggleWinePairing(header) {
    const content = header.nextElementSibling;
    const toggle = header.querySelector('.wine-pairing-toggle');
    content.classList.toggle('hidden');
    toggle.textContent = content.classList.contains('hidden') ? 'â–¼' : 'â–²';
}

// ========================================
// SHARE RECIPE
// ========================================
function shareRecipe(recipeId) {
    // Try to find recipe in pending or library
    let recipe = window.pendingRecipes?.[recipeId];
    if (!recipe) {
        const library = getRecipeLibrary();
        recipe = library.find(r => r.id === recipeId);
    }

    if (!recipe) {
        showToast('Recipe not found - save it first!');
        return;
    }

    // Get health profile modifications
    const profile = getStorage(STORAGE.PROFILE);
    const modifications = profile?.healthConditions?.length > 0 ?
        `HEALTH MODIFICATIONS:\n${generateHealthModifications(profile)}` : '';

    // Format recipe for sharing
    const shareText = formatRecipeForSharing(recipe, modifications);

    // Try to copy to clipboard
    if (navigator.clipboard) {
        navigator.clipboard.writeText(shareText)
            .then(() => showToast(`${icon('clipboard',14)} Recipe copied to clipboard!`))
            .catch(() => showShareModal(shareText));
    } else {
        showShareModal(shareText);
    }
}

function formatRecipeForSharing(recipe, modifications) {
    const ingredients = recipe.ingredients || [];
    const instructions = recipe.instructions || [];
    const nutrition = recipe.nutrition || {};
    const prepTime = recipe.metadata?.prepTime || 'N/A';
    const cookTime = recipe.metadata?.cookTime || 'N/A';
    const servings = recipe.servings || 'N/A';

    let text = `${icon('clipboard',14)} ${recipe.title}\n`;
    text += `${'â•'.repeat(40)}\n\n`;
    text += `Prep: ${prepTime} min | Cook: ${cookTime} min | Servings: ${servings}\n`;
    if (nutrition.calories) {
        text += `Calories: ${nutrition.calories} per serving\n`;
    }
    text += `\n`;

    text += `INGREDIENTS:\n`;
    text += `${'-'.repeat(20)}\n`;
    ingredients.forEach(ing => {
        text += `â€¢ ${ing}\n`;
    });
    text += `\n`;

    text += `INSTRUCTIONS:\n`;
    text += `${'-'.repeat(20)}\n`;
    instructions.forEach((step, i) => {
        text += `${i + 1}. ${step}\n\n`;
    });

    if (modifications) {
        text += `\n${modifications}\n`;
    }

    // Wine pairing
    const pairing = getWinePairing(recipe);
    text += `\nWINE PAIRING:\n`;
    text += `${'-'.repeat(20)}\n`;
    text += `${pairing.style}\n`;
    text += `Budget picks: ${pairing.bottles.join(', ')}\n`;

    text += `\n${'â•'.repeat(40)}\n`;
    text += `Created with Tavola\n`;
    text += `Mediterranean meal planning made easy.\n`;

    return text;
}

function showShareModal(shareText) {
    openModal(`
        <div class="modal-header">
            <h2 class="modal-title">${icon('share-2',14)} Share Recipe</h2>
            <button class="modal-close" onclick="closeModal()">Ã—</button>
        </div>
        <div class="modal-body">
            <p class="mb-16">Copy the recipe below to share:</p>
            <textarea class="form-input" style="height: 300px; font-family: monospace; font-size: 0.85rem;" readonly>${shareText.replace(/</g, '&lt;').replace(/>/g, '&gt;')}</textarea>
            <button class="btn btn-primary btn-block mt-16" onclick="copyShareText()">${icon('clipboard',14)} Copy to Clipboard</button>
        </div>
    `);
}

function copyShareText() {
    const textarea = document.querySelector('.modal-body textarea');
    if (textarea) {
        textarea.select();
        document.execCommand('copy');
        showToast(`${icon('clipboard',14)} Copied to clipboard!`);
        closeModal();
    }
}

// ========================================
// SAVE MANUAL RECIPE TO LIBRARY
// ========================================
function openSaveManualRecipeModal() {
    openModal(`
        <div class="modal-header">
            <h2 class="modal-title">${icon('file-text',14)} Create Recipe</h2>
            <button class="modal-close" onclick="closeModal()">Ã—</button>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label>Recipe Name *</label>
                <input type="text" class="form-input" id="manual-recipe-title" placeholder="e.g., Mom's Greek Chicken">
            </div>
            <div class="form-group">
                <label>Servings</label>
                <input type="number" class="form-input" id="manual-recipe-servings" placeholder="4" value="4">
            </div>
            <div class="grid grid-2">
                <div class="form-group">
                    <label>Prep Time (min)</label>
                    <input type="number" class="form-input" id="manual-recipe-prep" placeholder="15">
                </div>
                <div class="form-group">
                    <label>Cook Time (min)</label>
                    <input type="number" class="form-input" id="manual-recipe-cook" placeholder="30">
                </div>
            </div>
            <div class="form-group">
                <label>Calories (per serving)</label>
                <input type="number" class="form-input" id="manual-recipe-calories" placeholder="450">
            </div>
            <div class="form-group">
                <label>Ingredients (one per line) *</label>
                <textarea class="form-input" id="manual-recipe-ingredients" rows="6" placeholder="2 lbs chicken thighs
1 lemon, juiced
3 cloves garlic, minced
2 tbsp olive oil"></textarea>
            </div>
            <div class="form-group">
                <label>Instructions (one step per line) *</label>
                <textarea class="form-input" id="manual-recipe-instructions" rows="6" placeholder="Preheat oven to 400Â°F
Mix lemon juice, garlic, and olive oil
Season chicken and arrange in baking dish
Bake for 35-40 minutes until golden"></textarea>
            </div>
            <div class="form-group">
                <label>Tags (comma-separated)</label>
                <input type="text" class="form-input" id="manual-recipe-tags" placeholder="chicken, greek, easy, weeknight">
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
            <button class="btn btn-primary" onclick="saveManualRecipeToLibrary()">${icon('save',14)} Save Recipe</button>
        </div>
    `);
}

function saveManualRecipeToLibrary() {
    const title = document.getElementById('manual-recipe-title')?.value.trim();
    const servings = document.getElementById('manual-recipe-servings')?.value || '4';
    const prepTime = document.getElementById('manual-recipe-prep')?.value || '';
    const cookTime = document.getElementById('manual-recipe-cook')?.value || '';
    const calories = document.getElementById('manual-recipe-calories')?.value || '';
    const ingredientsText = document.getElementById('manual-recipe-ingredients')?.value.trim();
    const instructionsText = document.getElementById('manual-recipe-instructions')?.value.trim();
    const tagsText = document.getElementById('manual-recipe-tags')?.value.trim();

    // Validation
    if (!title) {
        showToast('Please enter a recipe name');
        return;
    }
    if (!ingredientsText) {
        showToast('Please enter ingredients');
        return;
    }
    if (!instructionsText) {
        showToast('Please enter instructions');
        return;
    }

    // Parse inputs
    const ingredients = ingredientsText.split('\n').map(i => i.trim()).filter(i => i);
    const instructions = instructionsText.split('\n').map(i => i.trim()).filter(i => i);
    const tags = tagsText ? tagsText.split(',').map(t => t.trim().toLowerCase()).filter(t => t) : [];

    // Create recipe object
    const recipe = {
        id: 'recipe_' + Date.now(),
        title: title,
        servings: servings,
        ingredients: ingredients,
        instructions: instructions,
        tags: tags,
        metadata: {
            prepTime: prepTime,
            cookTime: cookTime,
            totalTime: (parseInt(prepTime) || 0) + (parseInt(cookTime) || 0)
        },
        nutrition: {
            calories: calories
        },
        dateGenerated: new Date().toISOString(),
        source: 'manual',
        favorited: false,
        timesCooked: 0
    };

    // Save to library
    const result = saveRecipeToLibrary(recipe);
    if (result.saved) {
        closeModal();
        showToast(`${icon('check-circle',14)} "${title}" saved to your recipe library!`);
    } else {
        showToast(result.message);
    }
}

// Categorize an ingredient based on name
function categorizeIngredient(ingredientName) {
    const name = ingredientName.toLowerCase();

    // Proteins
    if (/chicken|salmon|cod|fish|shrimp|beef|turkey|pork|lamb|tofu|eggs?|protein/.test(name)) {
        return 'Proteins';
    }
    // Dairy
    if (/milk|cheese|yogurt|butter|cream|feta|parmesan|mozzarella/.test(name)) {
        return 'Dairy';
    }
    // Produce - Vegetables
    if (/tomato|spinach|pepper|onion|garlic|zucchini|cucumber|carrot|potato|kale|lettuce|greens|celery|broccoli|cauliflower|mushroom|eggplant|squash|cabbage|asparagus/.test(name)) {
        return 'Produce';
    }
    // Produce - Fruits
    if (/lemon|lime|orange|apple|banana|berry|grape|melon|avocado/.test(name)) {
        return 'Produce';
    }
    // Produce - Herbs
    if (/basil|parsley|cilantro|mint|dill|rosemary|thyme|oregano|sage|herb/.test(name)) {
        return 'Produce';
    }
    // Grains
    if (/rice|pasta|quinoa|bread|tortilla|pita|oat|wheat|grain|flour|couscous/.test(name)) {
        return 'Grains';
    }
    // Canned Goods
    if (/canned|can of|chickpea|bean|lentil|diced tomato/.test(name)) {
        return 'Canned Goods';
    }
    // Spices
    if (/spice|cumin|paprika|turmeric|cinnamon|pepper|salt|seasoning/.test(name)) {
        return 'Spices';
    }
    // Condiments/Oils
    if (/oil|vinegar|sauce|tahini|honey|maple|mustard|mayo/.test(name)) {
        return 'Pantry';
    }

    return 'Other';
}

// Parse quantity from string (returns number or null)
function parseQuantityNumber(qtyStr) {
    if (!qtyStr) return null;
    const str = qtyStr.toString().toLowerCase();

    // Extract first number found
    const match = str.match(/(\d+\.?\d*)/);
    if (match) {
        return parseFloat(match[1]);
    }

    // Handle text quantities
    if (str.includes('running low') || str.includes('low')) return 0.25;
    if (str.includes('half') || str.includes('1/2')) return 0.5;
    if (str.includes('quarter') || str.includes('1/4')) return 0.25;

    return null;
}

// Check if ingredient names match (fuzzy match)
function ingredientsMatch(ing1, ing2) {
    const name1 = ing1.toLowerCase().trim();
    const name2 = ing2.toLowerCase().trim();

    // Direct match
    if (name1 === name2) return true;

    // One contains the other
    if (name1.includes(name2) || name2.includes(name1)) return true;

    // Remove common suffixes/prefixes and compare
    const clean1 = name1.replace(/\b(fresh|dried|chopped|diced|minced|sliced|whole|large|small|medium)\b/g, '').trim();
    const clean2 = name2.replace(/\b(fresh|dried|chopped|diced|minced|sliced|whole|large|small|medium)\b/g, '').trim();

    if (clean1 === clean2) return true;
    if (clean1.includes(clean2) || clean2.includes(clean1)) return true;

    return false;
}

// Estimate cost for an item
function estimateItemCost(itemName, quantity) {
    const name = itemName.toLowerCase();

    // Try to find a match in the price database
    for (const [key, priceInfo] of Object.entries(PRICE_DATABASE)) {
        if (name.includes(key) || key.includes(name)) {
            const qty = parseQuantityNumber(quantity) || 1;
            return {
                unitPrice: priceInfo.price,
                unit: priceInfo.unit,
                totalCost: Math.round(priceInfo.price * qty * 100) / 100
            };
        }
    }

    // Default estimate based on category
    const category = categorizeIngredient(itemName);
    const defaults = {
        'Produce': 3.99,
        'Proteins': 8.99,
        'Dairy': 5.99,
        'Pantry': 3.99,
        'Grains': 3.99,
        'Canned Goods': 1.99,
        'Spices': 4.99,
        'Other': 4.99
    };

    return {
        unitPrice: defaults[category] || 4.99,
        unit: 'item',
        totalCost: defaults[category] || 4.99
    };
}

// Get week dates for current week offset
function getCurrentWeekDates() {
    const today = new Date();
    const dayOfWeek = today.getDay();
    const monday = new Date(today);
    monday.setDate(today.getDate() - dayOfWeek + (dayOfWeek === 0 ? -6 : 1) + (state.currentWeekOffset * 7));

    const dates = [];
    for (let i = 0; i < 7; i++) {
        const date = new Date(monday);
        date.setDate(monday.getDate() + i);
        dates.push(getLocalDateStr(date));
    }
    return dates;
}

// Main smart shopping list generator
function generateSmartShoppingList() {
    const mealPlans = getStorage(STORAGE.MEAL_PLANS) || {};
    const pantry = getStorage(STORAGE.PANTRY) || [];
    const library = getRecipeLibrary();
    const garden = getStorage(STORAGE.GARDEN) || [];

    // Get current week dates
    const weekDates = getCurrentWeekDates();

    // 1. Extract all ingredients from all planned meals
    const allIngredients = [];
    const mealTypes = ['breakfast', 'lunch', 'dinner', 'snacks'];

    weekDates.forEach(dateStr => {
        const dayPlan = mealPlans[dateStr];
        if (!dayPlan) return;

        // Handle both old format (single meal) and new format (multi-meal)
        if (dayPlan.recipeId) {
            // Old format - single meal
            const recipe = library.find(r => r.id === dayPlan.recipeId);
            if (recipe && recipe.ingredients) {
                recipe.ingredients.forEach(ing => {
                    allIngredients.push({
                        name: typeof ing === 'string' ? ing : ing.name || ing,
                        source: recipe.title,
                        date: dateStr
                    });
                });
            }
        } else {
            // New format - multi-meal
            mealTypes.forEach(mealType => {
                if (dayPlan[mealType]?.recipeId) {
                    const recipe = library.find(r => r.id === dayPlan[mealType].recipeId);
                    if (recipe && recipe.ingredients) {
                        recipe.ingredients.forEach(ing => {
                            allIngredients.push({
                                name: typeof ing === 'string' ? ing : ing.name || ing,
                                source: recipe.title,
                                date: dateStr,
                                mealType: mealType
                            });
                        });
                    }
                }
            });
        }
    });

    if (allIngredients.length === 0) {
        showToast('No recipes with ingredients in your meal plan. Plan some meals first!');
        return;
    }

    // 2. Consolidate duplicate ingredients
    const consolidatedIngredients = [];
    allIngredients.forEach(ing => {
        const existing = consolidatedIngredients.find(ci => ingredientsMatch(ci.name, ing.name));
        if (existing) {
            existing.sources.push(ing.source);
            existing.count++;
        } else {
            consolidatedIngredients.push({
                name: ing.name,
                sources: [ing.source],
                count: 1
            });
        }
    });

    // 3. Cross-reference with pantry
    const shoppingItems = [];
    const skippedItems = []; // Items already in pantry

    consolidatedIngredients.forEach(ingredient => {
        const inPantry = pantry.find(item => ingredientsMatch(item.name, ingredient.name));
        const inGarden = garden.find && garden.find(item => ingredientsMatch(item.name || item, ingredient.name));

        if (inGarden) {
            skippedItems.push({
                name: ingredient.name,
                reason: 'Available in garden'
            });
        } else if (!inPantry) {
            // Not in pantry - add to shopping list
            const category = categorizeIngredient(ingredient.name);
            const costInfo = estimateItemCost(ingredient.name, '1');

            shoppingItems.push({
                name: ingredient.name,
                quantity: ingredient.count > 1 ? `Need for ${ingredient.count} recipes` : '',
                category: category,
                pantryStatus: 'Not in pantry',
                pantryStatusType: 'missing',
                needed: true,
                sources: ingredient.sources,
                estimatedCost: costInfo.totalCost
            });
        } else {
            // In pantry - check status
            const status = inPantry.status || 'fresh';
            if (status === 'use-soon' || status === 'check') {
                shoppingItems.push({
                    name: ingredient.name,
                    quantity: 'Restock recommended',
                    category: categorizeIngredient(ingredient.name),
                    pantryStatus: `Have ${inPantry.qty || 'some'}, running low`,
                    pantryStatusType: 'has-some',
                    needed: true,
                    sources: ingredient.sources,
                    estimatedCost: estimateItemCost(ingredient.name, '1').totalCost
                });
            } else {
                skippedItems.push({
                    name: ingredient.name,
                    reason: `In pantry: ${inPantry.qty || 'available'}`
                });
            }
        }
    });

    // 4. Add items running low from pantry (even if not in meal plan)
    pantry.forEach(item => {
        if ((item.status === 'use-soon' || item.status === 'check') &&
            !shoppingItems.find(si => ingredientsMatch(si.name, item.name))) {
            shoppingItems.push({
                name: item.name,
                quantity: 'Restock',
                category: item.category || categorizeIngredient(item.name),
                pantryStatus: 'Running low in pantry',
                pantryStatusType: 'missing',
                needed: true,
                sources: ['Pantry restock'],
                estimatedCost: estimateItemCost(item.name, '1').totalCost
            });
        }
    });

    // 5. Generate suggestions (staples not in list or pantry)
    const suggestions = [];
    TYPICAL_STAPLES.forEach(staple => {
        const inList = shoppingItems.find(si => ingredientsMatch(si.name, staple.name));
        const inPantry = pantry.find(pi => ingredientsMatch(pi.name, staple.name));

        if (!inList && !inPantry) {
            suggestions.push({
                name: staple.name,
                quantity: staple.quantity,
                category: staple.category,
                pantryStatus: 'Typical staple - consider adding',
                pantryStatusType: 'suggestion',
                needed: false,
                estimatedCost: estimateItemCost(staple.name, staple.quantity).totalCost
            });
        }
    });

    // 6. Calculate estimated total
    const estimatedTotal = shoppingItems.reduce((sum, item) => sum + (item.estimatedCost || 0), 0);

    // 7. Group by category
    const groupedItems = {};
    shoppingItems.forEach(item => {
        if (!groupedItems[item.category]) {
            groupedItems[item.category] = [];
        }
        groupedItems[item.category].push(item);
    });

    // 8. Create list name with date
    const startDate = new Date(weekDates[0]);
    const listName = `Week of ${startDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric' })}`;

    // 9. Save to localStorage
    const lists = getStorage(STORAGE.SHOPPING) || { weekly: [] };
    const listId = `smart-${Date.now()}`;

    lists[listId] = {
        name: listName,
        generatedFrom: 'meal-plan',
        createdAt: new Date().toISOString(),
        estimatedTotal: Math.round(estimatedTotal * 100) / 100,
        suggestions: suggestions,
        skippedItems: skippedItems,
        items: shoppingItems.map(item => ({
            ...item,
            checked: false
        }))
    };

    setStorage(STORAGE.SHOPPING, lists);

    // 10. Update the dropdown and display
    updateShoppingListDropdown();
    document.getElementById('shopping-list-select').value = listId;
    loadEnhancedShoppingList(listId);

    showToast(`Shopping list created with ${shoppingItems.length} items!`);
}

// Update the shopping list dropdown with all lists
function updateShoppingListDropdown() {
    const lists = getStorage(STORAGE.SHOPPING) || { weekly: [] };
    const select = document.getElementById('shopping-list-select');

    // Clear existing options
    select.innerHTML = '<option value="weekly">Weekly Groceries</option>';

    // Add other lists
    Object.keys(lists).forEach(key => {
        if (key !== 'weekly') {
            const list = lists[key];
            const name = list.name || key;
            const option = document.createElement('option');
            option.value = key;
            option.textContent = name;
            select.appendChild(option);
        }
    });
}

// Enhanced shopping list display with pantry status
function loadEnhancedShoppingList(listId) {
    const lists = getStorage(STORAGE.SHOPPING) || { weekly: [] };
    const listData = lists[listId];

    if (!listData || !listData.items) {
        // Fall back to regular loading for simple lists
        loadShoppingList();
        return;
    }

    const container = document.getElementById('shopping-list');
    const empty = document.getElementById('shopping-empty');
    const items = listData.items;

    if (items.length === 0) {
        container.innerHTML = '';
        empty.classList.remove('hidden');
        return;
    }

    empty.classList.add('hidden');

    let html = '';

    // Summary section
    if (listData.estimatedTotal) {
        html += `
            <div class="shopping-list-summary">
                <span>Estimated Total</span>
                <span class="shopping-summary-cost">$${listData.estimatedTotal.toFixed(2)}</span>
            </div>
        `;
    }

    // Suggestions section
    if (listData.suggestions && listData.suggestions.length > 0) {
        html += `
            <div class="shopping-suggestions">
                <div class="shopping-suggestions-header">
                    <span>${icon('lightbulb',14)}</span> Smart Suggestions (optional)
                </div>
                ${listData.suggestions.map((sug, i) => `
                    <div class="shopping-suggestion-item">
                        <div>
                            <div style="font-weight: 500;">${sug.name}</div>
                            <div style="font-size: 0.8rem; color: var(--gray-text);">${sug.quantity} - ${sug.pantryStatus}</div>
                        </div>
                        <button class="suggestion-add-btn" onclick="addSuggestionToList('${listId}', ${i})">+ Add</button>
                    </div>
                `).join('')}
            </div>
        `;
    }

    // Group items by category
    const grouped = {};
    items.forEach((item, index) => {
        const cat = item.category || 'Other';
        if (!grouped[cat]) grouped[cat] = [];
        grouped[cat].push({ ...item, index });
    });

    // Render by category
    const categoryOrder = ['Produce', 'Proteins', 'Dairy', 'Grains', 'Canned Goods', 'Pantry', 'Spices', 'Other'];
    categoryOrder.forEach(category => {
        if (grouped[category] && grouped[category].length > 0) {
            const catIcon = getCategoryIcon(category);
            html += `
                <div class="shopping-category-header">
                    <span>${catIcon}</span>
                    <span>${category.toUpperCase()}</span>
                    <span style="font-weight: normal; color: var(--gray-text);">(${grouped[category].length})</span>
                </div>
            `;

            grouped[category].forEach(item => {
                const statusClass = item.pantryStatusType || '';
                html += `
                    <div class="shopping-item-enhanced ${item.checked ? 'checked' : ''}">
                        <input type="checkbox" class="shopping-item-checkbox"
                            ${item.checked ? 'checked' : ''}
                            onchange="toggleEnhancedShoppingItem('${listId}', ${item.index})">
                        <div class="shopping-item-content">
                            <div class="shopping-item-name-row">
                                <span class="shopping-item-name">${item.name}</span>
                                ${item.estimatedCost ? `<span class="shopping-item-qty">~$${item.estimatedCost.toFixed(2)}</span>` : ''}
                            </div>
                            ${item.pantryStatus ? `<div class="shopping-item-pantry-status ${statusClass}">${item.pantryStatusType === 'missing' ? icon('alert-triangle',14) : icon('map-pin',14)} ${item.pantryStatus}</div>` : ''}
                        </div>
                    </div>
                `;
            });
        }
    });

    // Handle categories not in the order list
    Object.keys(grouped).forEach(category => {
        if (!categoryOrder.includes(category) && grouped[category].length > 0) {
            const catIcon = getCategoryIcon(category);
            html += `
                <div class="shopping-category-header">
                    <span>${catIcon}</span>
                    <span>${category.toUpperCase()}</span>
                    <span style="font-weight: normal; color: var(--gray-text);">(${grouped[category].length})</span>
                </div>
            `;

            grouped[category].forEach(item => {
                html += `
                    <div class="shopping-item-enhanced ${item.checked ? 'checked' : ''}">
                        <input type="checkbox" class="shopping-item-checkbox"
                            ${item.checked ? 'checked' : ''}
                            onchange="toggleEnhancedShoppingItem('${listId}', ${item.index})">
                        <div class="shopping-item-content">
                            <div class="shopping-item-name-row">
                                <span class="shopping-item-name">${item.name}</span>
                            </div>
                            ${item.pantryStatus ? `<div class="shopping-item-pantry-status">${item.pantryStatus}</div>` : ''}
                        </div>
                    </div>
                `;
            });
        }
    });

    container.innerHTML = html;
}

// Toggle item in enhanced shopping list
function toggleEnhancedShoppingItem(listId, index) {
    const lists = getStorage(STORAGE.SHOPPING) || {};
    if (lists[listId] && lists[listId].items && lists[listId].items[index]) {
        lists[listId].items[index].checked = !lists[listId].items[index].checked;
        setStorage(STORAGE.SHOPPING, lists);
        loadEnhancedShoppingList(listId);
    }
}

// Add a suggestion to the shopping list
function addSuggestionToList(listId, suggestionIndex) {
    const lists = getStorage(STORAGE.SHOPPING) || {};
    if (lists[listId] && lists[listId].suggestions) {
        const suggestion = lists[listId].suggestions[suggestionIndex];
        if (suggestion) {
            // Add to items
            lists[listId].items.push({
                ...suggestion,
                checked: false,
                needed: true
            });

            // Remove from suggestions
            lists[listId].suggestions.splice(suggestionIndex, 1);

            // Update estimated total
            lists[listId].estimatedTotal = (lists[listId].estimatedTotal || 0) + (suggestion.estimatedCost || 0);

            setStorage(STORAGE.SHOPPING, lists);
            loadEnhancedShoppingList(listId);
            showToast(`Added ${suggestion.name} to list`);
        }
    }
}

// Override loadShoppingList to handle both old and new format
const originalLoadShoppingList = loadShoppingList;
function loadShoppingList() {
    const listId = document.getElementById('shopping-list-select').value;
    const lists = getStorage(STORAGE.SHOPPING) || { weekly: [] };

    // Check if this is an enhanced list (has items array with objects)
    if (lists[listId] && lists[listId].items && typeof lists[listId].items[0] === 'object' && lists[listId].items[0] !== null && lists[listId].items[0].category) {
        loadEnhancedShoppingList(listId);
    } else {
        // Use original simple list rendering
        const items = Array.isArray(lists[listId]) ? lists[listId] : (lists[listId]?.items || []);
        const container = document.getElementById('shopping-list');
        const empty = document.getElementById('shopping-empty');

        if (!items || items.length === 0) {
            container.innerHTML = '';
            empty.classList.remove('hidden');
            return;
        }

        empty.classList.add('hidden');
        container.innerHTML = items.map((item, i) => {
            const name = typeof item === 'string' ? item : (item.name || item);
            const checked = typeof item === 'object' ? item.checked : false;
            return `
                <div class="shopping-item ${checked ? 'checked' : ''}">
                    <input type="checkbox" class="shopping-item-checkbox" ${checked ? 'checked' : ''} onchange="toggleShoppingItem('${listId}', ${i})">
                    <span class="shopping-item-name">${name}</span>
                </div>
            `;
        }).join('');
    }
}

// ========================================
// KITCHEN - BATCH COOKING
// ========================================

// Typical ingredients needed for each batch cooking category
const BATCH_COOKING_INGREDIENTS = {
    chicken: [
        { name: 'Chicken breast', qty: '2 lbs', alternatives: ['Chicken thighs'] },
        { name: 'Olive oil', qty: '2 tbsp', alternatives: [] },
        { name: 'Garlic', qty: '4 cloves', alternatives: ['Garlic powder'] },
        { name: 'Lemon', qty: '1', alternatives: ['Lemon juice'] },
        { name: 'Herbs (rosemary/thyme)', qty: '1 bunch', alternatives: ['Dried herbs'] }
    ],
    fish: [
        { name: 'Salmon or Cod', qty: '1.5 lbs', alternatives: ['Any white fish'] },
        { name: 'Olive oil', qty: '2 tbsp', alternatives: [] },
        { name: 'Lemon', qty: '2', alternatives: ['Lemon juice'] },
        { name: 'Dill or parsley', qty: '1 bunch', alternatives: ['Dried herbs'] },
        { name: 'Capers', qty: '2 tbsp', alternatives: [] }
    ],
    grains: [
        { name: 'Quinoa or Rice', qty: '2 cups dry', alternatives: ['Farro', 'Couscous'] },
        { name: 'Broth', qty: '4 cups', alternatives: ['Water + salt'] },
        { name: 'Olive oil', qty: '1 tbsp', alternatives: ['Butter'] }
    ],
    vegetables: [
        { name: 'Bell peppers', qty: '3-4', alternatives: [] },
        { name: 'Zucchini', qty: '2-3', alternatives: ['Yellow squash'] },
        { name: 'Onion', qty: '2', alternatives: ['Shallots'] },
        { name: 'Cherry tomatoes', qty: '1 container', alternatives: ['Roma tomatoes'] },
        { name: 'Olive oil', qty: '3 tbsp', alternatives: [] },
        { name: 'Garlic', qty: '4 cloves', alternatives: [] }
    ],
    sauce: [
        { name: 'Canned tomatoes', qty: '2 cans', alternatives: ['Fresh tomatoes'] },
        { name: 'Onion', qty: '1', alternatives: [] },
        { name: 'Garlic', qty: '6 cloves', alternatives: [] },
        { name: 'Olive oil', qty: '3 tbsp', alternatives: [] },
        { name: 'Basil', qty: '1 bunch', alternatives: ['Dried basil'] },
        { name: 'Red wine', qty: '1/2 cup', alternatives: ['Balsamic vinegar'] }
    ],
    soup: [
        { name: 'Chicken or vegetable broth', qty: '6 cups', alternatives: [] },
        { name: 'Onion', qty: '1', alternatives: [] },
        { name: 'Carrots', qty: '3', alternatives: [] },
        { name: 'Celery', qty: '3 stalks', alternatives: [] },
        { name: 'Garlic', qty: '4 cloves', alternatives: [] },
        { name: 'Potatoes or beans', qty: '2 cups', alternatives: ['Lentils'] }
    ]
};

// State to track missing items for batch cooking
let batchMissingItems = [];

function checkBatchIngredients() {
    const selectedItems = Array.from(document.querySelectorAll('[name="batchItems"]:checked')).map(c => c.value);
    const checkContainer = document.getElementById('batch-ingredient-check');
    const listContainer = document.getElementById('batch-ingredient-list');
    const missingContainer = document.getElementById('batch-missing-items');
    const missingList = document.getElementById('batch-missing-list');

    if (selectedItems.length === 0) {
        checkContainer.style.display = 'none';
        return;
    }

    checkContainer.style.display = 'block';

    const pantry = getStorage(STORAGE.PANTRY) || [];
    const results = [];
    batchMissingItems = [];

    // Check each selected category
    selectedItems.forEach(category => {
        const ingredients = BATCH_COOKING_INGREDIENTS[category] || [];

        ingredients.forEach(ing => {
            // Check if ingredient or any alternative is in pantry
            const inPantry = pantry.find(p =>
                ingredientsMatch(p.name, ing.name) ||
                ing.alternatives.some(alt => ingredientsMatch(p.name, alt))
            );

            const status = inPantry ? 'have' : 'missing';
            const pantryInfo = inPantry ? `Have ${inPantry.qty || 'some'}` : 'Need to buy';

            // Avoid duplicates
            const existing = results.find(r => ingredientsMatch(r.name, ing.name));
            if (!existing) {
                results.push({
                    name: ing.name,
                    qty: ing.qty,
                    status: status,
                    pantryInfo: pantryInfo,
                    category: category
                });

                if (status === 'missing') {
                    batchMissingItems.push({
                        name: ing.name,
                        qty: ing.qty,
                        category: categorizeIngredient(ing.name)
                    });
                }
            }
        });
    });

    // Render ingredient list
    listContainer.innerHTML = results.map(item => `
        <div class="batch-ingredient-item">
            <span class="batch-ingredient-status">${item.status === 'have' ? icon('check-circle',14) : icon('x-circle',14)}</span>
            <span style="flex: 1;">${item.name} (${item.qty})</span>
            <span style="font-size: 0.8rem; color: var(--gray-text);">${item.pantryInfo}</span>
        </div>
    `).join('');

    // Show missing items section if any
    if (batchMissingItems.length > 0) {
        missingContainer.style.display = 'block';
        missingList.innerHTML = batchMissingItems.map(item => `
            <div style="font-size: 0.9rem; padding: 4px 0;">â€¢ ${item.name} (${item.qty})</div>
        `).join('');
    } else {
        missingContainer.style.display = 'none';
    }
}

function addBatchMissingToShopping() {
    if (batchMissingItems.length === 0) {
        showToast('No missing items to add');
        return;
    }

    const lists = getStorage(STORAGE.SHOPPING) || { weekly: [] };
    const listId = 'batch-prep';

    lists[listId] = {
        name: 'Batch Prep Shopping',
        generatedFrom: 'batch-cooking',
        createdAt: new Date().toISOString(),
        items: batchMissingItems.map(item => ({
            name: item.name,
            quantity: item.qty,
            category: item.category,
            checked: false,
            pantryStatus: 'Needed for batch cooking',
            pantryStatusType: 'missing'
        }))
    };

    setStorage(STORAGE.SHOPPING, lists);

    // Navigate to shopping
    switchKitchenTab('shopping');
    setTimeout(() => {
        updateShoppingListDropdown();
        document.getElementById('shopping-list-select').value = listId;
        loadEnhancedShoppingList(listId);
    }, 100);

    showToast(`Added ${batchMissingItems.length} items to Batch Prep Shopping list`);
}

function generateBatchPlan() {
    const items = Array.from(document.querySelectorAll('[name="batchItems"]:checked')).map(c => c.value);
    const time = document.getElementById('batch-time').value;

    if (items.length === 0) {
        showToast('Select items to prep');
        return;
    }

    // Include pantry context in the request
    const pantry = getStorage(STORAGE.PANTRY) || [];
    const pantryContext = pantry.length > 0
        ? `\n\nMy current pantry includes: ${pantry.map(p => p.name).join(', ')}.`
        : '';

    // Check for missing items warning
    const missingWarning = batchMissingItems.length > 0
        ? `\n\nNote: I may need to buy these items first: ${batchMissingItems.map(i => i.name).join(', ')}.`
        : '';

    askNonna(`Create a batch cooking plan for: ${items.join(', ')}. I have ${time} hours available. Give me a step-by-step timeline with specific recipes and instructions.${pantryContext}${missingWarning}`);
}

// ========================================
// CALORIE ESTIMATION
// ========================================

// Store last estimate for details display
let lastCalorieEstimate = null;

async function estimateCalories(mealInputId, calorieInputId) {
    const mealInput = document.getElementById(mealInputId);
    const calorieInput = document.getElementById(calorieInputId);
    const mealName = mealInput?.value.trim();

    if (!mealName || mealName.length < 3) {
        showToast('Please enter a meal description first');
        return;
    }

    // Find the estimate button and result container
    const estimateBtn = mealInput.closest('.modal-body').querySelector('.estimate-btn');
    const resultContainer = mealInput.closest('.modal-body').querySelector('[id^="calorie-estimate-result"]');

    // Show loading state
    if (estimateBtn) {
        estimateBtn.disabled = true;
        estimateBtn.classList.add('loading');
        estimateBtn.innerHTML = 'â³ Estimating...';
    }

    try {
        const response = await fetch('/.netlify/functions/chat', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                messages: [{
                    role: 'user',
                    content: `Estimate the calories in this meal: "${mealName}". Return ONLY valid JSON with no markdown formatting or code blocks.`
                }],
                systemPrompt: `You are a nutritional estimation assistant. Given a meal description, estimate calories and macros.

Return ONLY this JSON structure (no markdown, no code blocks, no explanation, just raw JSON):
{
  "calories": <number>,
  "confidence": "high" | "medium" | "low",
  "breakdown": ["Item 1: ~X cal", "Item 2: ~Y cal"],
  "protein": "<number>g",
  "carbs": "<number>g",
  "fat": "<number>g",
  "notes": "optional explanation for low confidence or vague descriptions"
}

Standard portion sizes to use:
- Banana: medium (105 cal)
- Apple: medium (95 cal)
- Tablespoon: 15ml
- Teaspoon: 5ml
- Cup: 240ml
- Ounce: 28g
- Chicken breast: 6oz raw (~280 cal)
- Salmon fillet: 6oz (~350 cal)
- Pasta: 1 cup cooked (~200 cal)
- Rice: 1 cup cooked (~200 cal)
- Bread slice: 1 slice (~80 cal)
- Egg: large (70 cal)
- Greek yogurt: 1 cup (~130 cal)
- Olive oil: 1 tbsp (120 cal)
- Butter: 1 tbsp (100 cal)
- Honey: 1 tbsp (64 cal)
- Cheese: 1 oz (~110 cal)

Guidelines:
- Be conservative with estimates
- Round to nearest 5 calories
- For vague descriptions like "salad" or "sandwich", assume medium portions
- Set confidence to "low" for vague descriptions and add explanatory notes
- Set confidence to "high" for specific, detailed descriptions
- Set confidence to "medium" for reasonably clear descriptions with some ambiguity`
            })
        });

        if (!response.ok) {
            throw new Error('API request failed');
        }

        const data = await response.json();
        let content = data.content?.[0]?.text || data.message || '';

        // Clean up response - remove markdown code blocks if present
        content = content.replace(/```json\s*/gi, '').replace(/```\s*/gi, '').trim();

        // Parse JSON from response
        const jsonMatch = content.match(/\{[\s\S]*\}/);
        if (!jsonMatch) {
            throw new Error('Invalid response format');
        }

        const estimate = JSON.parse(jsonMatch[0]);
        lastCalorieEstimate = estimate;

        // Update calorie input
        if (calorieInput) {
            calorieInput.value = estimate.calories;
            calorieInput.classList.add('calorie-input-estimated');
        }

        // Update button to show details
        if (estimateBtn) {
            estimateBtn.disabled = false;
            estimateBtn.classList.remove('loading');
            estimateBtn.innerHTML = icon('info',14) + ' Details';
            estimateBtn.onclick = () => showCalorieEstimateDetails(estimate);
        }

        // Show result summary
        if (resultContainer) {
            const confidenceClass = estimate.confidence || 'medium';
            resultContainer.innerHTML = `
                <div class="estimate-result">
                    <div class="estimate-result-header">
                        <span class="estimate-result-text">
                            ${icon('lightbulb',14)} Estimated: ~${estimate.calories} cal
                            <span class="confidence">(${estimate.confidence} confidence)</span>
                        </span>
                        <span class="confidence-badge ${confidenceClass}">${estimate.confidence}</span>
                    </div>
                    ${estimate.notes ? `<div style="margin-top: 6px; font-size: 0.8rem; color: var(--gray-text);">${estimate.notes}</div>` : ''}
                </div>
            `;
        }

        showToast(`Estimated: ~${estimate.calories} calories`);

    } catch (error) {
        console.error('Calorie estimation error:', error);

        // Reset button
        if (estimateBtn) {
            estimateBtn.disabled = false;
            estimateBtn.classList.remove('loading');
            estimateBtn.innerHTML = icon('bot',14) + ' Estimate';
        }

        // Show error in result container
        if (resultContainer) {
            resultContainer.innerHTML = `
                <div style="margin-top: 8px; padding: 8px; background: #ffebee; border-radius: var(--radius-sm); font-size: 0.85rem; color: #c62828;">
                    Unable to estimate. Please enter calories manually.
                </div>
            `;
        }

        showToast('Unable to estimate. Please enter manually.');
    }
}

function showCalorieEstimateDetails(estimate) {
    if (!estimate) {
        estimate = lastCalorieEstimate;
    }

    if (!estimate) {
        showToast('No estimate available');
        return;
    }

    const breakdownHtml = estimate.breakdown && estimate.breakdown.length > 0
        ? `<ul>${estimate.breakdown.map(item => `<li>${item}</li>`).join('')}</ul>`
        : '<p style="color: var(--gray-text);">No detailed breakdown available</p>';

    openModal(`
        <div class="modal-header">
            <h2 class="modal-title">Calorie Breakdown</h2>
            <button class="modal-close" onclick="closeModal()">Ã—</button>
        </div>
        <div class="modal-body">
            <div class="estimate-breakdown">
                <h4>Total: ~${estimate.calories} calories</h4>
                ${breakdownHtml}

                <div class="estimate-macros">
                    <span>Protein: <strong>${estimate.protein || 'â€”'}</strong></span>
                    <span>Carbs: <strong>${estimate.carbs || 'â€”'}</strong></span>
                    <span>Fat: <strong>${estimate.fat || 'â€”'}</strong></span>
                </div>
            </div>

            <div style="margin-top: 16px; padding: 12px; background: var(--gray-light); border-radius: var(--radius-sm);">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <span style="font-size: 0.85rem; color: var(--gray-text);">Confidence Level</span>
                    <span class="confidence-badge ${estimate.confidence || 'medium'}">${estimate.confidence || 'medium'}</span>
                </div>
                <p style="margin-top: 8px; font-size: 0.8rem; color: var(--gray-text);">
                    ${getConfidenceExplanation(estimate.confidence)}
                </p>
                ${estimate.notes ? `<p style="margin-top: 8px; font-size: 0.8rem; color: var(--gray-dark);"><strong>Note:</strong> ${estimate.notes}</p>` : ''}
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-primary" onclick="closeModal()">Close</button>
        </div>
    `);
}

function getConfidenceExplanation(confidence) {
    switch (confidence) {
        case 'high':
            return 'The meal description was detailed and specific, allowing for accurate estimation.';
        case 'medium':
            return 'Based on standard portion sizes. Actual calories may vary by Â±15%.';
        case 'low':
            return 'The description was vague. Consider adding more details for a better estimate.';
        default:
            return 'Based on standard portion sizes.';
    }
}

// ========================================
// KITCHEN - SUBSTITUTIONS
// ========================================
function searchSubstitutions() {
    const query = document.getElementById('subs-search').value.toLowerCase();
    const resultsDiv = document.getElementById('subs-results');

    if (!query) {
        resultsDiv.innerHTML = '';
        return;
    }

    const subs = {
        'butter': 'Olive oil (use 3/4 the amount), coconut oil, or avocado',
        'milk': 'Oat milk, almond milk, or coconut milk',
        'cream': 'Coconut cream or cashew cream',
        'lemon': 'Lime juice or white wine vinegar with a pinch of sugar',
        'garlic': '1/4 tsp garlic powder per clove, or shallots',
        'onion': 'Shallots, leeks, or 1 tsp onion powder',
        'tomato': 'Red bell pepper puree or pumpkin puree',
        'basil': 'Oregano, parsley, or mint',
        'chicken broth': 'Vegetable broth or water with miso',
        'wine': 'Broth + splash of vinegar',
        'parmesan': 'Pecorino romano or nutritional yeast',
        'feta': 'Goat cheese or ricotta salata',
        'egg': 'Flax egg (1 tbsp ground flax + 3 tbsp water)'
    };

    const matches = Object.entries(subs).filter(([key]) => key.includes(query));

    if (matches.length > 0) {
        resultsDiv.innerHTML = matches.map(([key, value]) => `
            <div class="card" style="padding: 12px; margin-bottom: 8px;">
                <strong>${key}</strong> â†’ ${value}
            </div>
        `).join('');
    } else {
        resultsDiv.innerHTML = '<p class="text-muted">No substitution found. Ask Nonna!</p>';
    }
}

function toggleAccordion(header) {
    header.parentElement.classList.toggle('open');
}

function switchKitchenTab(tab) {
    document.querySelectorAll('#more-kitchen .tab').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('#more-kitchen .tab-content').forEach(c => c.classList.remove('active'));

    const tabBtn = Array.from(document.querySelectorAll('#more-kitchen .tab')).find(t => t.textContent.toLowerCase().includes(tab));
    if (tabBtn) tabBtn.classList.add('active');

    document.getElementById(`kitchen-${tab}`).classList.add('active');

    if (tab === 'pantry') renderPantry();
    if (tab === 'shopping') loadShoppingList();
    if (tab === 'collections') renderCollections();
}

// ========================================
// GARDEN
// ========================================
function renderGarden() {
    const profile = getStorage(STORAGE.PROFILE);
    const container = document.getElementById('garden-plants');

    if (!profile || !profile.currentlyGrowing) {
        container.innerHTML = '<p class="text-muted">No plants added. Update your profile or add plants here.</p>';
        return;
    }

    const plants = profile.currentlyGrowing.split(',').map(p => p.trim()).filter(p => p);
    container.innerHTML = plants.map(plant => `
        <div class="pantry-item">
            <span class="pantry-item-icon">${icon('sprout',14)}</span>
            <div class="pantry-item-info">
                <div class="pantry-item-name">${plant}</div>
            </div>
        </div>
    `).join('');
}

function openAddPlantModal() {
    openModal(`
        <div class="modal-header">
            <h2 class="modal-title">Add Plant</h2>
            <button class="modal-close" onclick="closeModal()">Ã—</button>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label>Plant Name</label>
                <input type="text" class="form-input" id="plant-name-input" placeholder="e.g., Tomatoes">
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
            <button class="btn btn-primary" onclick="savePlant()">Add</button>
        </div>
    `);
}

function savePlant() {
    const name = document.getElementById('plant-name-input').value.trim();
    if (!name) return;

    const profile = getStorage(STORAGE.PROFILE) || {};
    const current = profile.currentlyGrowing || '';
    profile.currentlyGrowing = current ? `${current}, ${name}` : name;
    setStorage(STORAGE.PROFILE, profile);
    closeModal();
    renderGarden();
    showToast('Plant added!');
}

function askNonnaWithGarden() {
    const profile = getStorage(STORAGE.PROFILE);
    if (profile && profile.currentlyGrowing) {
        askNonna(`What recipes can I make with these garden items: ${profile.currentlyGrowing}?`);
    } else {
        askNonna('What should I plant in my Mediterranean herb garden?');
    }
}

function switchGardenTab(tab) {
    document.querySelectorAll('#more-garden .tab').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('#more-garden .tab-content').forEach(c => c.classList.remove('active'));

    const tabBtn = Array.from(document.querySelectorAll('#more-garden .tab')).find(t => t.textContent.toLowerCase().includes(tab.substring(0, 4)));
    if (tabBtn) tabBtn.classList.add('active');

    document.getElementById(`garden-${tab}`).classList.add('active');
}

function openLogHarvestModal() {
    openModal(`
        <div class="modal-header">
            <h2 class="modal-title">Log Harvest</h2>
            <button class="modal-close" onclick="closeModal()">Ã—</button>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label>What did you harvest?</label>
                <input type="text" class="form-input" id="harvest-item" placeholder="e.g., Tomatoes">
            </div>
            <div class="form-group">
                <label>Amount</label>
                <input type="text" class="form-input" id="harvest-amount" placeholder="e.g., 2 lbs">
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
            <button class="btn btn-primary" onclick="saveHarvest()">Log</button>
        </div>
    `);
}

function saveHarvest() {
    const item = document.getElementById('harvest-item').value.trim();
    const amount = document.getElementById('harvest-amount').value.trim();
    if (!item) return;

    const garden = getStorage(STORAGE.GARDEN) || { harvests: [] };
    garden.harvests.push({ item, amount, date: new Date().toISOString() });
    setStorage(STORAGE.GARDEN, garden);
    closeModal();
    showToast('Harvest logged!');
}

// ========================================
// CROHN'S CARE
// ========================================
function activateFlareMode() {
    state.flareMode = true;
    const prefs = getStorage(STORAGE.PREFS) || {};
    prefs.flareMode = true;
    setStorage(STORAGE.PREFS, prefs);
    updateFlareUI();
    showToast(`${icon('thermometer',14)} Flare mode activated. Nonna will suggest gentle meals.`);
    navigateTo('nonna');
    askNonna("I'm having a Crohn's flare. Give me some gentle meal options for today.");
}

function deactivateFlareMode() {
    state.flareMode = false;
    const prefs = getStorage(STORAGE.PREFS) || {};
    prefs.flareMode = false;
    setStorage(STORAGE.PREFS, prefs);
    updateFlareUI();
    showToast('Flare mode deactivated');
}

function updateFlareUI() {
    const banner = document.getElementById('flare-mode-banner');
    const homeBanner = document.getElementById('home-flare-banner');
    if (banner) banner.classList.toggle('hidden', !state.flareMode);
    if (homeBanner) homeBanner.classList.toggle('hidden', !state.flareMode);
}

// ========================================
// MEAL HISTORY
// ========================================
function renderHistory() {
    const history = getStorage(STORAGE.HISTORY) || [];
    const container = document.getElementById('history-list');
    const empty = document.getElementById('history-empty');

    // Stats
    const now = new Date();
    const weekAgo = new Date(now - 7 * 24 * 60 * 60 * 1000);
    const monthAgo = new Date(now - 30 * 24 * 60 * 60 * 1000);

    const weekCount = history.filter(h => new Date(h.date) > weekAgo).length;
    const monthCount = history.filter(h => new Date(h.date) > monthAgo).length;

    document.getElementById('stat-week').textContent = weekCount;
    document.getElementById('stat-month').textContent = monthCount;

    if (history.length === 0) {
        container.innerHTML = '';
        empty.classList.remove('hidden');
        return;
    }

    empty.classList.add('hidden');
    container.innerHTML = history.slice(0, 20).map(item => `
        <div class="activity-item">
            <span class="activity-icon">${icon('utensils',14)}</span>
            <div class="activity-content">
                <div class="activity-title">${item.title}</div>
                <div class="activity-time">${formatRelativeDate(item.date)}</div>
            </div>
            ${item.rating ? `<span style="color: var(--star-gold);">${'â­'.repeat(item.rating)}</span>` : ''}
        </div>
    `).join('');
}

function markAsCooked(recipeId, title) {
    // Open rating modal instead of directly marking
    openRatingModal(recipeId, title);
}

function openRatingModal(recipeId, title) {
    openModal(`
        <div class="modal-header">
            <h2 class="modal-title">How was it?</h2>
            <button class="modal-close" onclick="closeModal()">Ã—</button>
        </div>
        <div class="modal-body text-center">
            <p style="margin-bottom: 8px; font-size: 1.1rem;">${title}</p>
            <p class="text-muted mb-16">Rate this recipe so Nonna can remember your favorites!</p>

            <div class="star-rating" id="rating-stars" data-rating="0">
                <span class="star" data-value="1" onclick="setRatingStars(1)" onmouseover="previewRating(1)" onmouseout="resetRatingPreview()">â˜…</span>
                <span class="star" data-value="2" onclick="setRatingStars(2)" onmouseover="previewRating(2)" onmouseout="resetRatingPreview()">â˜…</span>
                <span class="star" data-value="3" onclick="setRatingStars(3)" onmouseover="previewRating(3)" onmouseout="resetRatingPreview()">â˜…</span>
                <span class="star" data-value="4" onclick="setRatingStars(4)" onmouseover="previewRating(4)" onmouseout="resetRatingPreview()">â˜…</span>
                <span class="star" data-value="5" onclick="setRatingStars(5)" onmouseover="previewRating(5)" onmouseout="resetRatingPreview()">â˜…</span>
            </div>

            <div class="form-group mt-16">
                <label style="text-align: left; display: block;">Notes (optional)</label>
                <textarea class="recipe-notes-input" id="rating-notes" placeholder="Any thoughts? Modifications you made? Tips for next time..."></textarea>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-ghost" onclick="submitRating('${recipeId}', '${title.replace(/'/g, "\\'")}', true)">Skip</button>
            <button class="btn btn-primary" onclick="submitRating('${recipeId}', '${title.replace(/'/g, "\\'")}', false)">Save Rating</button>
        </div>
    `);
}

let currentRatingValue = 0;

function setRatingStars(value) {
    currentRatingValue = value;
    const container = document.getElementById('rating-stars');
    container.dataset.rating = value;
    updateStarDisplay(value);
}

function previewRating(value) {
    updateStarDisplay(value);
}

function resetRatingPreview() {
    updateStarDisplay(currentRatingValue);
}

function updateStarDisplay(value) {
    const stars = document.querySelectorAll('#rating-stars .star');
    stars.forEach((star, index) => {
        star.classList.toggle('filled', index < value);
    });
}

function submitRating(recipeId, title, skipped) {
    const rating = skipped ? 0 : currentRatingValue;
    const notes = document.getElementById('rating-notes')?.value.trim() || '';
    const now = new Date().toISOString();

    // Add to meal history
    const history = getStorage(STORAGE.HISTORY) || [];
    history.unshift({
        type: 'cooked',
        title: title,
        recipeId: recipeId,
        date: now,
        rating: rating,
        notes: notes
    });
    setStorage(STORAGE.HISTORY, history);

    // Update recipe with cooking history and rating
    const library = getRecipeLibrary();
    const recipe = library.find(r => r.id === recipeId);
    if (recipe) {
        // Initialize cooking history if needed
        if (!recipe.cookingHistory) {
            recipe.cookingHistory = [];
        }

        // Add this cook to history
        recipe.cookingHistory.unshift({
            date: now,
            rating: rating,
            notes: notes
        });

        // Update aggregate stats
        recipe.timesCooked = (recipe.timesCooked || 0) + 1;
        recipe.lastCooked = now;

        // Calculate average rating from all rated cooks
        const ratedCooks = recipe.cookingHistory.filter(c => c.rating > 0);
        if (ratedCooks.length > 0) {
            const sum = ratedCooks.reduce((acc, c) => acc + c.rating, 0);
            recipe.averageRating = Math.round((sum / ratedCooks.length) * 10) / 10;
        }

        // Also keep single rating field for backwards compatibility
        if (rating > 0) {
            recipe.rating = rating;
        }

        setStorage(STORAGE.RECIPES, library);
    }

    closeModal();
    currentRatingValue = 0;

    if (skipped) {
        showToast(`${icon('check-circle',14)} Marked as cooked!`);
    } else if (rating >= 4) {
        showToast(`${icon('check-circle',14)} Wonderful! Glad you enjoyed it, cara!`);
    } else if (rating >= 2) {
        showToast(`${icon('check-circle',14)} Thanks for the feedback! Nonna will remember.`);
    } else {
        showToast(`${icon('check-circle',14)} Noted. Nonna will suggest something better next time!`);
    }

    // Refresh views if they're visible
    renderRecipeLibrary();
    renderFavorites();
    renderHistory();
}

function openAddMealModal() {
    openModal(`
        <div class="modal-header">
            <h2 class="modal-title">Log Meal</h2>
            <button class="modal-close" onclick="closeModal()">Ã—</button>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label>What did you eat?</label>
                <input type="text" class="form-input" id="log-meal-input" placeholder="e.g., Grilled chicken salad">
            </div>
            <div class="form-group">
                <label>Calories (optional)</label>
                <div class="calorie-input-row">
                    <input type="number" class="form-input" id="log-meal-calories" placeholder="e.g., 350">
                    <button type="button" class="estimate-btn" id="estimate-calories-btn-log" onclick="estimateCalories('log-meal-input', 'log-meal-calories')">
                        ${icon('bot',14)} Estimate
                    </button>
                </div>
                <div id="calorie-estimate-result-log"></div>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
            <button class="btn btn-primary" onclick="logMealManual()">Log</button>
        </div>
    `);
}

function logMealManual() {
    const title = document.getElementById('log-meal-input').value.trim();
    const calories = document.getElementById('log-meal-calories')?.value;
    if (!title) return;

    const history = getStorage(STORAGE.HISTORY) || [];
    history.unshift({
        type: 'cooked',
        title: title,
        calories: calories ? parseInt(calories) : null,
        date: new Date().toISOString()
    });
    setStorage(STORAGE.HISTORY, history);
    closeModal();
    renderHistory();
    showToast('Meal logged!');
}

function addActivity(type, title) {
    const history = getStorage(STORAGE.HISTORY) || [];
    history.unshift({ type, title, date: new Date().toISOString() });
    setStorage(STORAGE.HISTORY, history.slice(0, 100)); // Keep last 100
}

// ========================================
// MODALS
// ========================================
// ========================================
// MODAL SYSTEM (Enhanced with accessibility)
// ========================================
let _previousFocusElement = null;

function openModal(content, options = {}) {
    _previousFocusElement = document.activeElement;
    const overlay = document.getElementById('modal-overlay');
    const modal = document.getElementById('modal-content');
    modal.innerHTML = content;

    // Set max-width if provided
    if (options.maxWidth) {
        modal.style.maxWidth = options.maxWidth;
    } else {
        modal.style.maxWidth = '';
    }

    overlay.classList.add('active');

    // Initialize Lucide icons in modal content
    if (window.lucide) {
        try { lucide.createIcons(); } catch(e) {}
    }

    // Trap focus
    trapFocus(modal);

    // ESC to close
    document.addEventListener('keydown', _modalEscHandler);
}

function closeModal() {
    const overlay = document.getElementById('modal-overlay');
    overlay.classList.remove('active');
    document.removeEventListener('keydown', _modalEscHandler);

    // Restore focus
    if (_previousFocusElement && _previousFocusElement.focus) {
        _previousFocusElement.focus();
    }
}

function _modalEscHandler(e) {
    if (e.key === 'Escape') closeModal();
}

function closeModalOnOverlay(event) {
    if (event.target.id === 'modal-overlay') closeModal();
}

// Focus trap utility
function trapFocus(element) {
    const focusableSelectors = 'button:not([disabled]), [href], input:not([disabled]), select:not([disabled]), textarea:not([disabled]), [tabindex]:not([tabindex="-1"])';
    const focusableElements = element.querySelectorAll(focusableSelectors);
    if (focusableElements.length === 0) return;

    const firstElement = focusableElements[0];
    const lastElement = focusableElements[focusableElements.length - 1];

    // Focus the first focusable element
    setTimeout(() => firstElement.focus(), 50);

    element._trapHandler = function(e) {
        if (e.key !== 'Tab') return;
        if (e.shiftKey) {
            if (document.activeElement === firstElement) {
                e.preventDefault();
                lastElement.focus();
            }
        } else {
            if (document.activeElement === lastElement) {
                e.preventDefault();
                firstElement.focus();
            }
        }
    };
    element.addEventListener('keydown', element._trapHandler);
}

// Confirmation modal helper
function showConfirmation({ icon: iconParam, iconType, title, message, confirmText, confirmClass, onConfirm }) {
    const defaultIcon = icon('alert-triangle',14);
    openModal(`
        <div class="confirmation-modal-content">
            <span class="confirmation-icon ${iconType || 'warning'}">${iconParam || defaultIcon}</span>
            <div class="confirmation-title">${title || 'Are you sure?'}</div>
            <div class="confirmation-message">${message || 'This action cannot be undone.'}</div>
            <div class="confirmation-actions">
                <button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
                <button class="btn ${confirmClass || 'btn-primary'}" id="confirm-action-btn">${confirmText || 'Confirm'}</button>
            </div>
        </div>
    `, { maxWidth: '420px' });

    document.getElementById('confirm-action-btn').addEventListener('click', () => {
        closeModal();
        if (onConfirm) onConfirm();
    });
}

// ========================================
// TOAST SYSTEM (Enhanced with types & stacking)
// ========================================
const TOAST_ICONS = {
    success: icon('check-circle'),
    error: icon('x-circle'),
    warning: icon('alert-triangle'),
    info: icon('info')
};

function showToast(message, type = 'success', duration = 3000) {
    // Also support legacy single-arg call
    const container = document.getElementById('toast-container');
    if (!container) {
        // Fallback to legacy toast
        const toast = document.getElementById('toast');
        if (toast) {
            toast.textContent = message;
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), 3000);
        }
        return;
    }

    const toastEl = document.createElement('div');
    toastEl.className = `toast-item toast-${type}`;
    toastEl.innerHTML = `
        <span class="toast-icon">${TOAST_ICONS[type] || icon('check-circle')}</span>
        <span class="toast-message">${message}</span>
        <button class="toast-close" onclick="this.parentElement.remove()" aria-label="Dismiss">&times;</button>
    `;

    container.appendChild(toastEl);

    // Trigger animation
    requestAnimationFrame(() => {
        toastEl.classList.add('show');
    });

    // Auto-dismiss
    setTimeout(() => {
        toastEl.classList.remove('show');
        setTimeout(() => toastEl.remove(), 300);
    }, duration);
}

// ========================================
// HELPERS
// ========================================
function formatDate(dateStr) {
    const date = new Date(dateStr);
    return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
}

function formatRelativeDate(dateStr) {
    const date = new Date(dateStr);
    const now = new Date();
    const diffMs = now - date;
    const diffDays = Math.floor(diffMs / (24 * 60 * 60 * 1000));

    if (diffDays === 0) return 'Today';
    if (diffDays === 1) return 'Yesterday';
    if (diffDays < 7) return `${diffDays} days ago`;
    return formatDate(dateStr);
}

// ========================================
// GLOBAL SEARCH
// ========================================
function handleGlobalSearch(event) {
    if (event.key === 'Enter') {
        const query = event.target.value.trim();
        if (query) {
            navigateTo('recipes');
            document.getElementById('recipes-search').value = query;
            filterRecipeLibrary();
        }
    }
}

// ========================================
// DATA MANAGEMENT
// ========================================
function exportAllData() {
    const data = {
        profile: getStorage(STORAGE.PROFILE),
        recipes: getStorage(STORAGE.RECIPES),
        favorites: getStorage(STORAGE.FAVORITES),
        mealPlans: getStorage(STORAGE.MEAL_PLANS),
        history: getStorage(STORAGE.HISTORY),
        pantry: getStorage(STORAGE.PANTRY),
        shopping: getStorage(STORAGE.SHOPPING),
        garden: getStorage(STORAGE.GARDEN),
        prefs: getStorage(STORAGE.PREFS),
        exportDate: new Date().toISOString()
    };

    const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `tavola-backup-${new Date().toISOString().split('T')[0]}.json`;
    a.click();
    URL.revokeObjectURL(url);
    showToast('Data exported!');
}

function importData() {
    const input = document.createElement('input');
    input.type = 'file';
    input.accept = '.json';
    input.onchange = async (e) => {
        const file = e.target.files[0];
        if (!file) return;

        try {
            const text = await file.text();
            const data = JSON.parse(text);

            if (data.profile) setStorage(STORAGE.PROFILE, data.profile);
            if (data.recipes) setStorage(STORAGE.RECIPES, data.recipes);
            if (data.mealPlans) setStorage(STORAGE.MEAL_PLANS, data.mealPlans);
            if (data.history) setStorage(STORAGE.HISTORY, data.history);
            if (data.pantry) setStorage(STORAGE.PANTRY, data.pantry);
            if (data.shopping) setStorage(STORAGE.SHOPPING, data.shopping);
            if (data.garden) setStorage(STORAGE.GARDEN, data.garden);
            if (data.prefs) setStorage(STORAGE.PREFS, data.prefs);

            showToast('Data imported! Refreshing...');
            setTimeout(() => location.reload(), 1000);
        } catch (err) {
            showToast('Error importing data');
        }
    };
    input.click();
}

function confirmClearAllData() {
    openModal(`
        <div class="modal-header">
            <h2 class="modal-title">${icon('alert-triangle',14)} Clear All Data?</h2>
            <button class="modal-close" onclick="closeModal()">Ã—</button>
        </div>
        <div class="modal-body">
            <p>This will delete all your recipes, meal plans, history, and settings. This cannot be undone.</p>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
            <button class="btn" style="background: var(--danger); color: white;" onclick="clearAllData()">Delete Everything</button>
        </div>
    `);
}

function clearAllData() {
    Object.values(STORAGE).forEach(key => localStorage.removeItem(key));
    closeModal();
    location.reload();
}

// ========================================
// ONBOARDING
// ========================================
const onboardingSteps = [
    { icon: icon('hand', 32), title: 'Welcome to Tavola!', text: 'Let me show you around - it\'ll just take a minute!' },
    { icon: icon('home', 32), title: 'Dashboard', text: 'This is your home base. Quick access to everything you need.' },
    { icon: icon('calendar-days', 32), title: 'This Week', text: 'Plan your weekly meals here. Nonna can generate a complete plan based on your health profile.' },
    { icon: icon('book-open', 32), title: 'Recipe Library', text: 'Every recipe Nonna creates is saved here. Favorite the ones you love!' },
    { icon: icon('message-circle', 32), title: 'Chat with Nonna', text: 'Ask me anything! "What should I make with my tomatoes?" or "I\'m having a flare, give me gentle meals."' }
];

let onboardingStep = 0;

function startOnboarding() {
    onboardingStep = 0;
    document.getElementById('onboarding-overlay').classList.add('active');
    renderOnboardingStep();
}

function restartTutorial() {
    // Clear the onboarding flag so it can be shown again
    setStorage(STORAGE.ONBOARDING, false);
    const user = firebase.auth().currentUser;
    if (user) {
        firebase.firestore().collection('users').doc(user.uid).set(
            { hasCompletedOnboarding: false },
            { merge: true }
        ).catch(e => console.log('Failed to reset onboarding flag:', e));
    }
    // Navigate to home and start the tour
    navigateTo('home');
    setTimeout(() => startOnboarding(), 300);
}

function renderOnboardingStep() {
    const step = onboardingSteps[onboardingStep];
    const card = document.getElementById('onboarding-card');

    card.innerHTML = `
        <div class="onboarding-icon">${step.icon}</div>
        <h2 class="onboarding-title">${step.title}</h2>
        <p class="onboarding-text">${step.text}</p>
        <div class="onboarding-dots">
            ${onboardingSteps.map((_, i) => `<div class="onboarding-dot ${i === onboardingStep ? 'active' : ''}"></div>`).join('')}
        </div>
        <div class="onboarding-actions">
            ${onboardingStep > 0 ? '<button class="btn btn-ghost" onclick="prevOnboarding()">Back</button>' : ''}
            ${onboardingStep < onboardingSteps.length - 1 ?
                '<button class="btn btn-primary" onclick="nextOnboarding()">Next â†’</button>' :
                '<button class="btn btn-primary" onclick="finishOnboarding()">Get Started!</button>'
            }
        </div>
        <button class="btn btn-ghost" onclick="skipOnboarding()" style="margin-top: 12px; font-size: 0.85rem;">Skip tour</button>
    `;
}

function nextOnboarding() {
    if (onboardingStep < onboardingSteps.length - 1) {
        onboardingStep++;
        renderOnboardingStep();
    }
}

function prevOnboarding() {
    if (onboardingStep > 0) {
        onboardingStep--;
        renderOnboardingStep();
    }
}

function finishOnboarding() {
    setStorage(STORAGE.ONBOARDING, true);
    document.getElementById('onboarding-overlay').classList.remove('active');
    // Persist to Firestore so it doesn't show on other devices
    const user = firebase.auth().currentUser;
    if (user) {
        firebase.firestore().collection('users').doc(user.uid).set(
            { hasCompletedOnboarding: true },
            { merge: true }
        ).catch(e => console.log('Failed to save onboarding flag:', e));
    }
}

function skipOnboarding() {
    setStorage(STORAGE.ONBOARDING, true);
    document.getElementById('onboarding-overlay').classList.remove('active');
    // Persist to Firestore
    const user = firebase.auth().currentUser;
    if (user) {
        firebase.firestore().collection('users').doc(user.uid).set(
            { hasCompletedOnboarding: true },
            { merge: true }
        ).catch(e => console.log('Failed to save onboarding flag:', e));
    }
}

// ========================================
// COOK MODE
// ========================================
function startCookMode(recipeId) {
    const library = getRecipeLibrary();
    const recipe = library.find(r => r.id === recipeId);
    if (!recipe || !recipe.instructions || recipe.instructions.length === 0) {
        showToast('No instructions available for cook mode');
        return;
    }

    state.cookMode = { active: true, recipe, currentStep: 0 };
    document.getElementById('cook-mode-overlay').classList.add('active');
    renderCookModeStep();
}

function renderCookModeStep() {
    const { recipe, currentStep } = state.cookMode;
    const body = document.getElementById('cook-mode-body');
    const progress = document.getElementById('cook-mode-progress');

    progress.textContent = `Step ${currentStep + 1} of ${recipe.instructions.length}`;

    body.innerHTML = `
        <details class="cook-mode-ingredients">
            <summary>${icon('file-text',14)} Ingredients (tap to expand)</summary>
            <ul style="margin-top: 12px; padding-left: 20px;">
                ${recipe.ingredients.map(i => `<li>${i}</li>`).join('')}
            </ul>
        </details>
        <div class="cook-mode-step">
            <div class="cook-mode-step-check">
                <input type="checkbox" id="step-check-${currentStep}">
                <label for="step-check-${currentStep}">${recipe.instructions[currentStep]}</label>
            </div>
            ${recipe.instructions[currentStep].match(/\d+\s*(min|minute)/i) ?
                `<div class="cook-mode-timer" onclick="startTimer()">${icon('timer',14)} Start Timer</div>` : ''}
        </div>
    `;

    // Update nav buttons
    document.getElementById('cook-prev-btn').disabled = currentStep === 0;
    document.getElementById('cook-next-btn').textContent = currentStep === recipe.instructions.length - 1 ? 'Finish' : 'Next â†’';
}

function cookModeNext() {
    const { recipe, currentStep } = state.cookMode;
    if (currentStep < recipe.instructions.length - 1) {
        state.cookMode.currentStep++;
        renderCookModeStep();
    } else {
        exitCookMode();
        markAsCooked(recipe.id, recipe.title);
    }
}

function cookModePrev() {
    if (state.cookMode.currentStep > 0) {
        state.cookMode.currentStep--;
        renderCookModeStep();
    }
}

function exitCookMode() {
    state.cookMode = { active: false, recipe: null, currentStep: 0 };
    document.getElementById('cook-mode-overlay').classList.remove('active');
}

function startTimer() {
    showToast(`${icon('timer',14)} Timer feature coming soon!`);
}

// ========================================
// RECIPE CARD MORE MENU
// ========================================
function openRecipeMoreMenu(recipeId) {
    const library = getRecipeLibrary();
    const recipe = library.find(r => r.id === recipeId);
    const isFavorited = recipe?.favorited;

    openModal(`
        <div class="modal-header">
            <h2 class="modal-title">Recipe Options</h2>
            <button class="modal-close" onclick="closeModal()">Ã—</button>
        </div>
        <div class="modal-body">
            <div class="more-menu">
                <button class="more-menu-item" onclick="closeModal(); openRatingModal('${recipeId}', '${recipe?.title?.replace(/'/g, "\\'") || 'Recipe'}');">
                    <span class="icon">â­</span>
                    <div class="more-menu-item-content">
                        <div class="more-menu-item-title">Rate Recipe</div>
                        <div class="more-menu-item-desc">Mark as cooked and rate</div>
                    </div>
                </button>
                <button class="more-menu-item" onclick="closeModal(); viewCookingHistory('${recipeId}');">
                    <span class="icon">${icon('clipboard',14)}</span>
                    <div class="more-menu-item-content">
                        <div class="more-menu-item-title">Cooking History</div>
                        <div class="more-menu-item-desc">View past ratings and notes</div>
                    </div>
                </button>
                <button class="more-menu-item" onclick="closeModal(); addIngredientsToShopping('${recipeId}');">
                    <span class="icon">${icon('shopping-cart',14)}</span>
                    <div class="more-menu-item-content">
                        <div class="more-menu-item-title">Add to Shopping List</div>
                    </div>
                </button>
                <button class="more-menu-item" onclick="closeModal(); startCookMode('${recipeId}');">
                    <span class="icon">${icon('chef-hat',14)}</span>
                    <div class="more-menu-item-content">
                        <div class="more-menu-item-title">Start Cook Mode</div>
                    </div>
                </button>
                <button class="more-menu-item" onclick="closeModal(); printRecipe('${recipeId}');">
                    <span class="icon">${icon('printer',14)}</span>
                    <div class="more-menu-item-content">
                        <div class="more-menu-item-title">Print Recipe</div>
                    </div>
                </button>
                ${isFavorited ? `
                <button class="more-menu-item" onclick="closeModal(); removeFromFavorites('${recipeId}');">
                    <span class="icon"><i data-lucide="heart-off" style="width:14px;height:14px"></i></span>
                    <div class="more-menu-item-content">
                        <div class="more-menu-item-title">Remove from Favorites</div>
                        <div class="more-menu-item-desc">Keep in library</div>
                    </div>
                </button>
                ` : ''}
                <button class="more-menu-item" onclick="closeModal(); confirmDeleteRecipe('${recipeId}');">
                    <span class="icon">${icon('trash-2',14)}</span>
                    <div class="more-menu-item-content">
                        <div class="more-menu-item-title">Delete from Library</div>
                        <div class="more-menu-item-desc">Permanently remove</div>
                    </div>
                </button>
            </div>
        </div>
    `);
}

function viewCookingHistory(recipeId) {
    const library = getRecipeLibrary();
    const recipe = library.find(r => r.id === recipeId);
    if (!recipe) return;

    const history = recipe.cookingHistory || [];

    let historyHtml = '';
    if (history.length === 0) {
        historyHtml = `
            <div class="empty-state">
                <div class="empty-state-icon"><i data-lucide="book-open" style="width:32px;height:32px;color:var(--gray-text)"></i></div>
                <div class="empty-state-title">No cooking history yet</div>
                <p>Rate this recipe after cooking to track your history.</p>
            </div>
        `;
    } else {
        historyHtml = history.map(entry => {
            const date = new Date(entry.date).toLocaleDateString('en-US', {
                month: 'short', day: 'numeric', year: 'numeric'
            });
            const stars = entry.rating > 0 ? 'â˜…'.repeat(entry.rating) + 'â˜†'.repeat(5 - entry.rating) : 'Not rated';

            return `
                <div class="cooking-history-item">
                    <div>
                        <div class="cooking-history-date">${date}</div>
                        ${entry.notes ? `<div class="cooking-history-notes">"${entry.notes}"</div>` : ''}
                    </div>
                    <div class="cooking-history-rating">${stars}</div>
                </div>
            `;
        }).join('');
    }

    const avgRating = recipe.averageRating ? `${recipe.averageRating.toFixed(1)} average` : '';
    const timesCooked = recipe.timesCooked || 0;

    openModal(`
        <div class="modal-header">
            <h2 class="modal-title">Cooking History</h2>
            <button class="modal-close" onclick="closeModal()">Ã—</button>
        </div>
        <div class="modal-body">
            <h3 style="margin-bottom: 8px;">${recipe.title}</h3>
            <p class="text-muted mb-16">
                Cooked ${timesCooked} time${timesCooked !== 1 ? 's' : ''}
                ${avgRating ? ` Â· ${avgRating}` : ''}
            </p>
            <div class="cooking-history">
                ${historyHtml}
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeModal()">Close</button>
            <button class="btn btn-primary" onclick="closeModal(); openRatingModal('${recipeId}', '${recipe.title.replace(/'/g, "\\'")}')">Rate Again</button>
        </div>
    `);
}

function removeFromFavorites(recipeId) {
    const library = getRecipeLibrary();
    const recipe = library.find(r => r.id === recipeId);
    if (recipe) {
        recipe.favorited = false;
        setStorage(STORAGE.RECIPES, library);
        showToast('Removed from favorites');
        renderRecipeLibrary();
        renderFavorites();
    }
}

function confirmDeleteRecipe(recipeId) {
    const library = getRecipeLibrary();
    const recipe = library.find(r => r.id === recipeId);
    if (!recipe) return;

    // Check if recipe is in current week's meal plan
    const mealPlans = getStorage(STORAGE.MEAL_PLANS) || {};
    const weekDates = getWeekDates(state.currentWeekOffset);
    const isPlanned = weekDates.some(date => mealPlans[date]?.recipeId === recipeId);

    if (isPlanned) {
        openModal(`
            <div class="modal-header">
                <h2 class="modal-title">Cannot Delete</h2>
                <button class="modal-close" onclick="closeModal()">Ã—</button>
            </div>
            <div class="modal-body">
                <p>This recipe is planned for this week. Remove it from your meal plan first before deleting.</p>
            </div>
            <div class="modal-footer">
                <button class="btn btn-primary" onclick="closeModal()">OK</button>
            </div>
        `);
        return;
    }

    openModal(`
        <div class="modal-header">
            <h2 class="modal-title">Delete Recipe?</h2>
            <button class="modal-close" onclick="closeModal()">Ã—</button>
        </div>
        <div class="modal-body">
            <p><strong>${recipe.title}</strong> will be permanently deleted from your library.</p>
            <p class="text-muted mt-8">This action cannot be undone. All ratings and cooking history will be lost.</p>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
            <button class="btn btn-primary" style="background: var(--danger);" onclick="deleteRecipe('${recipeId}')">Delete</button>
        </div>
    `);
}

function addIngredientsToShopping(recipeId) {
    const library = getRecipeLibrary();
    const recipe = library.find(r => r.id === recipeId);
    if (!recipe || !recipe.ingredients) return;

    const lists = getStorage(STORAGE.SHOPPING) || { weekly: [] };
    recipe.ingredients.forEach(ing => {
        lists.weekly.push({ name: ing, checked: false });
    });
    setStorage(STORAGE.SHOPPING, lists);
    showToast(`${icon('shopping-cart',14)} Ingredients added to shopping list!`);
}

let lastDeletedRecipe = null;

function deleteRecipe(recipeId) {
    const library = getRecipeLibrary();
    const index = library.findIndex(r => r.id === recipeId);
    if (index >= 0) {
        // Store for undo
        lastDeletedRecipe = { ...library[index] };

        library.splice(index, 1);
        setStorage(STORAGE.RECIPES, library);
        closeModal();
        renderRecipeLibrary();
        renderFavorites();

        // Show toast with undo option
        showUndoToast('Recipe deleted', undoDeleteRecipe);
    }
}

function undoDeleteRecipe() {
    if (lastDeletedRecipe) {
        const library = getRecipeLibrary();
        library.unshift(lastDeletedRecipe);
        setStorage(STORAGE.RECIPES, library);
        lastDeletedRecipe = null;
        renderRecipeLibrary();
        renderFavorites();
        showToast('Recipe restored!');
    }
}

function showUndoToast(message, undoCallback) {
    // Remove existing toast
    const existingToast = document.querySelector('.toast');
    if (existingToast) existingToast.remove();

    const toast = document.createElement('div');
    toast.className = 'toast';
    toast.innerHTML = `
        ${message}
        <button onclick="this.parentElement.remove(); (${undoCallback.toString()})();" style="margin-left: 12px; background: none; border: none; color: var(--seafoam); cursor: pointer; font-weight: 600;">Undo</button>
    `;
    document.body.appendChild(toast);

    setTimeout(() => toast.classList.add('show'), 10);
    setTimeout(() => {
        toast.classList.remove('show');
        setTimeout(() => toast.remove(), 300);
    }, 5000);
}

// Close filter dropdown when clicking outside
document.addEventListener('click', (e) => {
    const dropdown = document.getElementById('recipe-filters');
    if (dropdown && !dropdown.contains(e.target)) {
        dropdown.classList.remove('open');
    }
});

// ========================================
// WORKOUT TRACKING
// ========================================

// MET values for calorie calculations (Metabolic Equivalent of Task)
const WORKOUT_TYPES = {
    vrboxing: { name: 'VR Boxing', icon: icon('swords'), met: 8.5 },
    kettlebells: { name: 'Kettlebells', icon: icon('dumbbell'), met: 7.0 },
    resistancebands: { name: 'Resistance Bands', icon: icon('stretch-horizontal'), met: 4.0 },
    walking: { name: 'Walking', icon: icon('footprints'), met: 3.5 },
    running: { name: 'Running', icon: icon('footprints'), met: 9.8 },
    cycling: { name: 'Cycling', icon: icon('bike'), met: 7.5 },
    swimming: { name: 'Swimming', icon: icon('waves'), met: 8.0 },
    strength: { name: 'Strength Training', icon: icon('dumbbell'), met: 6.0 },
    yoga: { name: 'Yoga', icon: icon('stretch-horizontal'), met: 3.0 },
    hiit: { name: 'HIIT', icon: icon('zap'), met: 12.0 },
    dancing: { name: 'Dancing', icon: icon('music'), met: 6.5 },
    hiking: { name: 'Hiking', icon: icon('mountain'), met: 6.0 },
    pilates: { name: 'Pilates', icon: icon('stretch-horizontal'), met: 3.5 },
    rowing: { name: 'Rowing', icon: icon('ship'), met: 7.0 },
    other: { name: 'Other', icon: icon('trophy'), met: 5.0 }
};

function getWorkouts() {
    return getStorage(STORAGE.WORKOUTS) || [];
}

function saveWorkout(workout) {
    const workouts = getWorkouts();
    workouts.push(workout);
    setStorage(STORAGE.WORKOUTS, workouts);
}

function calculateCaloriesBurned(workoutType, durationMinutes, userWeight = 70) {
    // Get user weight from profile if available
    const profile = getStorage(STORAGE.PROFILE);
    const weight = profile?.weight || userWeight; // in kg

    const met = WORKOUT_TYPES[workoutType]?.met || 5.0;
    // Formula: Calories = MET Ã— weight (kg) Ã— duration (hours)
    return Math.round(met * weight * (durationMinutes / 60));
}

function getTodayStr() {
    return getLocalDateStr(new Date());
}

// Get YYYY-MM-DD in local timezone (not UTC!) to fix off-by-one date bugs
function getLocalDateStr(date) {
    const year = date.getFullYear();
    const month = String(date.getMonth() + 1).padStart(2, '0');
    const day = String(date.getDate()).padStart(2, '0');
    return `${year}-${month}-${day}`;
}

function getWeekStartStr() {
    const now = new Date();
    const dayOfWeek = now.getDay();
    const diff = dayOfWeek === 0 ? 6 : dayOfWeek - 1; // Monday as start
    const weekStart = new Date(now);
    weekStart.setDate(now.getDate() - diff);
    return getLocalDateStr(weekStart);
}

function getTodaysWorkouts() {
    const today = getTodayStr();
    return getWorkouts().filter(w => w.date === today);
}

function getWeekWorkouts() {
    const weekStart = getWeekStartStr();
    return getWorkouts().filter(w => w.date >= weekStart);
}

function getTodaysCaloriesIn() {
    // Get calories from today's logged meals
    const today = getTodayStr();
    const mealHistory = getStorage(STORAGE.HISTORY) || [];
    const todaysMeals = mealHistory.filter(m => m.date?.startsWith(today));

    // Sum up calories from meals
    let totalCalories = 0;
    todaysMeals.forEach(meal => {
        // Try to get calories from the linked recipe
        if (meal.recipeId) {
            const library = getRecipeLibrary();
            const recipe = library.find(r => r.id === meal.recipeId);
            if (recipe?.nutrition?.calories) {
                totalCalories += parseInt(recipe.nutrition.calories) || 0;
            }
        }
    });

    // Also check meal plans for today if meals are marked as cooked
    const mealPlans = getStorage(STORAGE.MEAL_PLANS) || {};
    if (mealPlans[today]?.status === 'cooked' && mealPlans[today]?.recipeId) {
        const library = getRecipeLibrary();
        const recipe = library.find(r => r.id === mealPlans[today].recipeId);
        if (recipe?.nutrition?.calories) {
            totalCalories += parseInt(recipe.nutrition.calories) || 0;
        }
    }

    return totalCalories;
}

function getTodaysCaloriesOut() {
    return getTodaysWorkouts().reduce((sum, w) => sum + (w.caloriesBurned || 0), 0);
}

function calculateStreak() {
    const workouts = getWorkouts();
    if (workouts.length === 0) return 0;

    // Get unique workout dates
    const workoutDates = [...new Set(workouts.map(w => w.date))].sort().reverse();

    const today = getTodayStr();
    const yesterday = new Date();
    yesterday.setDate(yesterday.getDate() - 1);
    const yesterdayStr = getLocalDateStr(yesterday);

    // Check if there's a workout today or yesterday to continue streak
    if (workoutDates[0] !== today && workoutDates[0] !== yesterdayStr) {
        return 0;
    }

    let streak = 0;
    let currentDate = new Date(workoutDates[0] + 'T12:00:00');

    for (const dateStr of workoutDates) {
        const checkDate = getLocalDateStr(currentDate);
        if (dateStr === checkDate) {
            streak++;
            currentDate.setDate(currentDate.getDate() - 1);
        } else {
            break;
        }
    }

    return streak;
}

function renderWorkoutsView() {
    renderCalorieBalance();
    renderWeekStats();
    renderWorkoutCalendar();
    renderTodaysWorkouts();
}

function renderCalorieBalance() {
    const caloriesIn = getTodaysCaloriesIn();
    const workoutCalories = getTodaysCaloriesOut();

    // NEW FORMAT: Base TDEE + workout = total daily burn
    const baseTDEE = 2000;
    const totalDailyBurn = baseTDEE + workoutCalories;
    const deficit = totalDailyBurn - caloriesIn;
    const isDeficit = deficit > 0;

    // Update values with new labels
    document.getElementById('calories-in-value').textContent = caloriesIn;
    document.getElementById('calories-out-value').textContent = totalDailyBurn;

    // Update the labels via inner elements
    const inLabel = document.querySelector('#calories-in-bar')?.closest('.calorie-balance-item')?.querySelector('.calorie-balance-label');
    const outLabel = document.querySelector('#calories-out-bar')?.closest('.calorie-balance-item')?.querySelector('.calorie-balance-label');
    if (inLabel) inLabel.innerHTML = `${icon('utensils',14)} Consumed`;
    if (outLabel) outLabel.innerHTML = `${icon('flame',14)} Daily Burn (${baseTDEE}${workoutCalories > 0 ? '+' + workoutCalories : ''})`;

    // Update net display - show as POSITIVE deficit
    const netEl = document.getElementById('calorie-net');
    netEl.innerHTML = `${isDeficit ? icon('check-circle',14) : icon('alert-triangle',14)} ${Math.abs(deficit).toLocaleString()} cal ${isDeficit ? 'deficit' : 'surplus'}`;
    netEl.className = 'calorie-balance-net';
    if (isDeficit) netEl.classList.add('deficit');
    else netEl.classList.add('surplus');

    // Update bars (scale to total daily burn for better visualization)
    const maxCal = Math.max(totalDailyBurn, caloriesIn, 2500);
    const inPercent = Math.min((caloriesIn / maxCal) * 100, 100);
    const outPercent = Math.min((totalDailyBurn / maxCal) * 100, 100);

    document.getElementById('calories-in-bar').style.width = `${inPercent}%`;
    document.getElementById('calories-out-bar').style.width = `${outPercent}%`;
}

function renderWeekStats() {
    const weekWorkouts = getWeekWorkouts();

    // Count unique workout days
    const workoutDays = new Set(weekWorkouts.map(w => w.date)).size;

    // Total minutes
    const totalMinutes = weekWorkouts.reduce((sum, w) => sum + (w.duration || 0), 0);

    // Total calories burned
    const totalCalories = weekWorkouts.reduce((sum, w) => sum + (w.caloriesBurned || 0), 0);

    // Streak
    const streak = calculateStreak();

    document.getElementById('workout-count-week').textContent = workoutDays;
    document.getElementById('workout-minutes-week').textContent = totalMinutes;
    document.getElementById('workout-calories-week').textContent = totalCalories;
    document.getElementById('workout-streak').textContent = streak;
}

function renderWorkoutCalendar() {
    const container = document.getElementById('workout-calendar-grid');
    const today = new Date();
    const dayOfWeek = today.getDay();
    const diff = dayOfWeek === 0 ? 6 : dayOfWeek - 1;
    const weekStart = new Date(today);
    weekStart.setDate(today.getDate() - diff);

    const workouts = getWorkouts();
    const days = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];

    let html = days.map(d => `<div class="workout-day-header">${d}</div>`).join('');

    for (let i = 0; i < 7; i++) {
        const date = new Date(weekStart);
        date.setDate(weekStart.getDate() + i);
        const dateStr = getLocalDateStr(date);
        const isToday = dateStr === getTodayStr();
        const dayWorkouts = workouts.filter(w => w.date === dateStr);
        const hasWorkout = dayWorkouts.length > 0;

        html += `
            <div class="workout-day ${isToday ? 'today' : ''} ${hasWorkout ? 'has-workout' : ''}" onclick="showDayWorkouts('${dateStr}')">
                <span class="workout-day-date">${date.getDate()}</span>
                <span class="workout-day-indicator">${dayWorkouts.length > 0 ? dayWorkouts.length + ' ' + icon('dumbbell',12) : ''}</span>
            </div>
        `;
    }

    container.innerHTML = html;
}

function renderTodaysWorkouts() {
    const container = document.getElementById('workout-list-today');
    const todaysWorkouts = getTodaysWorkouts();

    if (todaysWorkouts.length === 0) {
        container.innerHTML = `
            <div class="empty-state" style="padding: 20px;">
                <div class="empty-state-icon"><i data-lucide="footprints" style="width:32px;height:32px;color:var(--gray-text)"></i></div>
                <div class="empty-state-title">No workouts logged today</div>
                <p class="empty-state-text">Log a workout to track your calorie burn!</p>
            </div>
        `;
        return;
    }

    container.innerHTML = todaysWorkouts.map(workout => {
        const type = WORKOUT_TYPES[workout.type] || WORKOUT_TYPES.other;
        return `
            <div class="workout-item">
                <div class="workout-item-icon">${type.icon}</div>
                <div class="workout-item-details">
                    <div class="workout-item-name">${type.name}</div>
                    <div class="workout-item-meta">${workout.duration} min${workout.notes ? ' Â· ' + workout.notes : ''}</div>
                </div>
                <div class="workout-item-calories">-${workout.caloriesBurned} cal</div>
                <div class="workout-item-actions">
                    <button class="icon-btn" onclick="deleteWorkout('${workout.id}')" title="Delete">${icon('trash-2',14)}</button>
                </div>
            </div>
        `;
    }).join('');
}

function quickLogWorkout(type, duration) {
    const workout = {
        id: 'workout_' + Date.now(),
        type: type,
        duration: duration,
        caloriesBurned: calculateCaloriesBurned(type, duration),
        date: getTodayStr(),
        time: new Date().toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' }),
        notes: ''
    };

    saveWorkout(workout);
    showToast(`${WORKOUT_TYPES[type]?.icon || icon('medal',14)} Logged ${duration}min ${WORKOUT_TYPES[type]?.name || type}! (-${workout.caloriesBurned} cal)`);
    renderWorkoutsView();
}

function openWorkoutLogModal() {
    const typeButtons = Object.entries(WORKOUT_TYPES).map(([key, val]) => `
        <button type="button" class="workout-type-btn" data-type="${key}" onclick="selectWorkoutType('${key}')">
            <span class="workout-type-icon">${val.icon}</span>
            <span class="workout-type-name">${val.name}</span>
        </button>
    `).join('');

    openModal(`
        <div class="modal-header">
            <h2 class="modal-title">Log Workout</h2>
            <button class="modal-close" onclick="closeModal()">Ã—</button>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label>Workout Type</label>
                <div class="workout-type-grid">${typeButtons}</div>
            </div>
            <div class="form-group">
                <label>Duration (minutes)</label>
                <input type="number" class="form-input" id="workout-duration" value="30" min="1" max="300">
            </div>
            <div class="form-group">
                <label>Notes (optional)</label>
                <input type="text" class="form-input" id="workout-notes" placeholder="e.g., Morning jog, felt great">
            </div>
            <div id="workout-calorie-preview" class="text-center text-muted mb-16">
                Select a workout type to see estimated calories
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
            <button class="btn btn-primary" onclick="submitWorkoutLog()">Log Workout</button>
        </div>
    `);
}

let selectedWorkoutType = null;

function selectWorkoutType(type) {
    selectedWorkoutType = type;

    // Update button styles
    document.querySelectorAll('.workout-type-btn').forEach(btn => {
        btn.classList.toggle('selected', btn.dataset.type === type);
    });

    // Update calorie preview
    updateCaloriePreview();
}

function updateCaloriePreview() {
    const preview = document.getElementById('workout-calorie-preview');
    const duration = parseInt(document.getElementById('workout-duration')?.value) || 30;

    if (selectedWorkoutType && preview) {
        const calories = calculateCaloriesBurned(selectedWorkoutType, duration);
        preview.innerHTML = `<strong style="color: var(--success);">Estimated burn: ~${calories} calories</strong>`;
    }
}

// Update preview when duration changes
document.addEventListener('input', (e) => {
    if (e.target.id === 'workout-duration') {
        updateCaloriePreview();
    }
});

function submitWorkoutLog() {
    if (!selectedWorkoutType) {
        showToast('Please select a workout type');
        return;
    }

    const duration = parseInt(document.getElementById('workout-duration').value);
    const notes = document.getElementById('workout-notes').value.trim();

    if (!duration || duration < 1) {
        showToast('Please enter a valid duration');
        return;
    }

    const workout = {
        id: 'workout_' + Date.now(),
        type: selectedWorkoutType,
        duration: duration,
        caloriesBurned: calculateCaloriesBurned(selectedWorkoutType, duration),
        date: getTodayStr(),
        time: new Date().toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' }),
        notes: notes
    };

    saveWorkout(workout);
    selectedWorkoutType = null;
    closeModal();
    showToast(`${WORKOUT_TYPES[workout.type]?.icon || icon('medal',14)} Workout logged! (-${workout.caloriesBurned} cal)`);
    renderWorkoutsView();
}

function deleteWorkout(workoutId) {
    const workouts = getWorkouts();
    const index = workouts.findIndex(w => w.id === workoutId);
    if (index >= 0) {
        workouts.splice(index, 1);
        setStorage(STORAGE.WORKOUTS, workouts);
        showToast('Workout deleted');
        renderWorkoutsView();
    }
}

function showDayWorkouts(dateStr) {
    const workouts = getWorkouts().filter(w => w.date === dateStr);
    const date = new Date(dateStr + 'T12:00:00'); // Add time to avoid timezone issues
    const dateDisplay = date.toLocaleDateString('en-US', { weekday: 'long', month: 'short', day: 'numeric' });

    const totalCalories = workouts.reduce((sum, w) => sum + (w.caloriesBurned || 0), 0);
    const totalMinutes = workouts.reduce((sum, w) => sum + (w.duration || 0), 0);

    const workoutList = workouts.length > 0 ? workouts.map(w => {
        const type = WORKOUT_TYPES[w.type] || WORKOUT_TYPES.other;
        return `
            <div class="workout-item">
                <div class="workout-item-icon">${type.icon}</div>
                <div class="workout-item-details">
                    <div class="workout-item-name">${type.name}</div>
                    <div class="workout-item-meta">${w.duration} min${w.time ? ' at ' + w.time : ''}${w.notes ? ' Â· ' + w.notes : ''}</div>
                </div>
                <div class="workout-item-calories">-${w.caloriesBurned} cal</div>
                <button class="icon-btn" onclick="deleteDayWorkout('${w.id}', '${dateStr}')" title="Delete">${icon('trash-2',14)}</button>
            </div>
        `;
    }).join('') : '<p class="text-center text-muted" style="padding: 16px 0;">No workouts logged yet.</p>';

    const statsHtml = workouts.length > 0 ? `
        <div class="workout-stats" style="margin-bottom: 16px;">
            <div class="workout-stat">
                <div class="workout-stat-value">${workouts.length}</div>
                <div class="workout-stat-label">Workouts</div>
            </div>
            <div class="workout-stat">
                <div class="workout-stat-value">${totalMinutes}</div>
                <div class="workout-stat-label">Minutes</div>
            </div>
            <div class="workout-stat">
                <div class="workout-stat-value">${totalCalories}</div>
                <div class="workout-stat-label">Calories</div>
            </div>
        </div>
    ` : '';

    openModal(`
        <div class="modal-header">
            <h2 class="modal-title">${dateDisplay}</h2>
            <button class="modal-close" onclick="closeModal()">Ã—</button>
        </div>
        <div class="modal-body">
            ${statsHtml}
            ${workoutList}
            <hr style="margin: 16px 0; border: none; border-top: 1px solid var(--gray-medium);">
            <button class="btn btn-primary btn-block" onclick="openWorkoutLogModalForDate('${dateStr}')">+ Log Workout for This Day</button>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeModal()">Close</button>
        </div>
    `);
}

function deleteDayWorkout(workoutId, dateStr) {
    const workouts = getWorkouts();
    const index = workouts.findIndex(w => w.id === workoutId);
    if (index >= 0) {
        workouts.splice(index, 1);
        setStorage(STORAGE.WORKOUTS, workouts);
        showToast('Workout deleted');
        showDayWorkouts(dateStr); // Refresh the modal
        renderWorkoutsView();
    }
}

function openWorkoutLogModalForDate(dateStr) {
    const date = new Date(dateStr + 'T12:00:00');
    const dateDisplay = date.toLocaleDateString('en-US', { weekday: 'long', month: 'short', day: 'numeric' });

    const typeButtons = Object.entries(WORKOUT_TYPES).map(([key, val]) => `
        <button type="button" class="workout-type-btn" data-type="${key}" onclick="selectWorkoutType('${key}')">
            <span class="workout-type-icon">${val.icon}</span>
            <span class="workout-type-name">${val.name}</span>
        </button>
    `).join('');

    openModal(`
        <div class="modal-header">
            <h2 class="modal-title">Log Workout - ${dateDisplay}</h2>
            <button class="modal-close" onclick="closeModal()">Ã—</button>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label>Workout Type</label>
                <div class="workout-type-grid">${typeButtons}</div>
            </div>
            <div class="form-group">
                <label>Duration (minutes)</label>
                <input type="number" class="form-input" id="workout-duration" value="30" min="1" max="300">
            </div>
            <div class="form-group">
                <label>Notes (optional)</label>
                <input type="text" class="form-input" id="workout-notes" placeholder="e.g., Morning session, felt great">
            </div>
            <div id="workout-calorie-preview" class="text-center text-muted mb-16">
                Select a workout type to see estimated calories
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="showDayWorkouts('${dateStr}')">Back</button>
            <button class="btn btn-primary" onclick="submitWorkoutLogForDate('${dateStr}')">Log Workout</button>
        </div>
    `);
}

function submitWorkoutLogForDate(dateStr) {
    if (!selectedWorkoutType) {
        showToast('Please select a workout type');
        return;
    }

    const duration = parseInt(document.getElementById('workout-duration').value);
    const notes = document.getElementById('workout-notes').value.trim();

    if (!duration || duration < 1) {
        showToast('Please enter a valid duration');
        return;
    }

    const workout = {
        id: 'workout_' + Date.now(),
        type: selectedWorkoutType,
        duration: duration,
        caloriesBurned: calculateCaloriesBurned(selectedWorkoutType, duration),
        date: dateStr,
        time: '',
        notes: notes
    };

    saveWorkout(workout);
    selectedWorkoutType = null;
    showToast(`${WORKOUT_TYPES[workout.type]?.icon || icon('medal',14)} Workout logged! (-${workout.caloriesBurned} cal)`);
    showDayWorkouts(dateStr); // Go back to the day view
    renderWorkoutsView();
}

// ========================================
// WORKOUT INTEGRATION WITH NONNA
// ========================================
function formatWorkoutDataForAPI() {
    const weekWorkouts = getWeekWorkouts();
    if (weekWorkouts.length === 0) return '';

    const totalCalories = weekWorkouts.reduce((sum, w) => sum + (w.caloriesBurned || 0), 0);
    const totalMinutes = weekWorkouts.reduce((sum, w) => sum + (w.duration || 0), 0);
    const workoutDays = new Set(weekWorkouts.map(w => w.date)).size;
    const streak = calculateStreak();

    // Get activity breakdown
    const activityCounts = {};
    weekWorkouts.forEach(w => {
        activityCounts[w.type] = (activityCounts[w.type] || 0) + 1;
    });

    const activities = Object.entries(activityCounts)
        .map(([type, count]) => `${WORKOUT_TYPES[type]?.name || type}: ${count}x`)
        .join(', ');

    return `
## Workout Activity This Week
- Workouts: ${workoutDays} days, ${weekWorkouts.length} sessions
- Total active time: ${totalMinutes} minutes
- Estimated calories burned: ${totalCalories} cal
- Activities: ${activities}
- Current streak: ${streak} days
${streak >= 3 ? '(Great consistency! Consider celebrating this with a nutritious reward.)' : ''}
${totalCalories > 1500 ? '(High activity level - may need extra protein and calories for recovery.)' : ''}`;
}

// ========================================
// INITIALIZE LUCIDE ICONS
// ========================================
document.addEventListener('DOMContentLoaded', function() {
    if (window.lucide) {
        try { lucide.createIcons(); } catch(e) { console.warn('Lucide init:', e); }
    }
});

// Lucide icon helper for use in template literals
function icon(name, size = 16, extraStyle = '') {
    return `<i data-lucide="${name}" style="width:${size}px;height:${size}px;vertical-align:middle;display:inline-block;${extraStyle}"></i>`;
}

// Re-initialize Lucide after dynamic content updates
function refreshIcons() {
    if (window.lucide) {
        try { lucide.createIcons(); } catch(e) {}
    }
}

// ========================================
// PHASE 3: SMART SUBSTITUTIONS DATABASE
// ========================================
const SUBSTITUTIONS = {
    'butter': [
        { sub: 'Olive oil', ratio: '3/4 the amount', notes: 'Best for sauteing, not baking', tags: ['dairy-free','vegan'] },
        { sub: 'Coconut oil', ratio: '1:1', notes: 'Slight coconut flavor', tags: ['dairy-free','vegan'] },
        { sub: 'Ghee', ratio: '1:1', notes: 'Lactose-free, rich nutty flavor', tags: ['lactose-free'] }
    ],
    'greek yogurt': [
        { sub: 'Labneh', ratio: '1:1', notes: 'Thicker, tangier', tags: [] },
        { sub: 'Coconut yogurt', ratio: '1:1', notes: 'Dairy-free option', tags: ['dairy-free','vegan'] },
        { sub: 'Sour cream', ratio: '1:1', notes: 'Richer flavor', tags: [] }
    ],
    'feta': [
        { sub: 'Goat cheese', ratio: '1:1', notes: 'Milder, creamier', tags: [] },
        { sub: 'Cottage cheese', ratio: '1:1 crumbled', notes: 'Lower fat option', tags: ['low-fat'] },
        { sub: 'Ricotta salata', ratio: '1:1', notes: 'Firmer, milder', tags: [] }
    ],
    'parmesan': [
        { sub: 'Pecorino Romano', ratio: '1:1', notes: 'Sharper, saltier', tags: [] },
        { sub: 'Nutritional yeast', ratio: '2 tbsp per 1/4 cup', notes: 'Vegan, cheesy flavor', tags: ['dairy-free','vegan'] }
    ],
    'heavy cream': [
        { sub: 'Coconut cream', ratio: '1:1', notes: 'Rich, slight coconut flavor', tags: ['dairy-free','vegan'] },
        { sub: 'Cashew cream', ratio: '1:1', notes: 'Neutral flavor, blend soaked cashews', tags: ['dairy-free','vegan'] },
        { sub: 'Evaporated milk', ratio: '1:1', notes: 'Lower fat option', tags: ['low-fat'] }
    ],
    'chicken breast': [
        { sub: 'Chicken thighs', ratio: '1:1', notes: 'More flavor, slightly more fat, cheaper', tags: ['budget'] },
        { sub: 'Turkey breast', ratio: '1:1', notes: 'Leaner option', tags: ['low-fat'] },
        { sub: 'Firm tofu', ratio: '1:1 pressed', notes: 'Press 30 min, marinate well', tags: ['vegan','budget'] }
    ],
    'salmon': [
        { sub: 'Trout', ratio: '1:1', notes: 'Similar flavor and texture', tags: [] },
        { sub: 'Arctic char', ratio: '1:1', notes: 'Milder, sustainable', tags: [] },
        { sub: 'Sardines', ratio: 'Adjust portions', notes: 'Higher omega-3, budget-friendly', tags: ['budget'] }
    ],
    'chickpeas': [
        { sub: 'White beans (cannellini)', ratio: '1:1', notes: 'Creamier texture', tags: [] },
        { sub: 'Lentils', ratio: '1:1', notes: 'Cook faster, more protein', tags: ['budget'] },
        { sub: 'Edamame', ratio: '1:1', notes: 'Higher protein', tags: [] }
    ],
    'pasta': [
        { sub: 'Zucchini noodles', ratio: '2 zucchini per serving', notes: 'Low-carb, salt and drain first', tags: ['low-carb','gluten-free'] },
        { sub: 'Rice noodles', ratio: '1:1', notes: 'Gluten-free option', tags: ['gluten-free'] },
        { sub: 'Whole wheat pasta', ratio: '1:1', notes: 'More fiber, nuttier flavor', tags: ['high-fiber'] }
    ],
    'rice': [
        { sub: 'Cauliflower rice', ratio: '1:1', notes: 'Low-carb, sautÃ© 5 min', tags: ['low-carb','keto'] },
        { sub: 'Quinoa', ratio: '1:1', notes: 'Complete protein, nuttier', tags: ['high-protein'] },
        { sub: 'Couscous', ratio: '1:1', notes: 'Cooks faster', tags: [] }
    ],
    'saffron': [
        { sub: 'Turmeric', ratio: '1/4 tsp per pinch saffron', notes: 'For color, milder flavor', tags: ['budget'] },
        { sub: 'Paprika + turmeric', ratio: 'Pinch of each', notes: 'Better color match', tags: ['budget'] }
    ],
    'white wine': [
        { sub: 'Chicken broth + vinegar', ratio: '1 cup broth + 1 tsp vinegar', notes: 'Non-alcoholic', tags: ['alcohol-free'] },
        { sub: 'White grape juice + vinegar', ratio: '3/4 cup juice + 1/4 cup vinegar', notes: 'Sweeter', tags: ['alcohol-free'] }
    ],
    'lemon juice': [
        { sub: 'White wine vinegar', ratio: '1:1 + pinch sugar', notes: 'Similar acidity', tags: [] },
        { sub: 'Lime juice', ratio: '1:1', notes: 'Slightly different flavor', tags: [] }
    ],
    'fresh herbs': [
        { sub: 'Dried herbs', ratio: '1/3 the amount', notes: 'Add earlier in cooking', tags: [] }
    ],
    'basil': [
        { sub: 'Oregano', ratio: '1:1', notes: 'Earthier flavor', tags: [] },
        { sub: 'Parsley + mint', ratio: '3/4 parsley + 1/4 mint', notes: 'Closer to fresh basil flavor', tags: [] }
    ],
    'olive oil': [
        { sub: 'Avocado oil', ratio: '1:1', notes: 'Higher smoke point, neutral flavor', tags: [] },
        { sub: 'Grapeseed oil', ratio: '1:1', notes: 'Lighter, neutral', tags: ['budget'] }
    ],
    'eggs': [
        { sub: 'Flax egg', ratio: '1 tbsp ground flax + 3 tbsp water per egg', notes: 'Let sit 5 min, best for baking', tags: ['vegan'] },
        { sub: 'Chia egg', ratio: '1 tbsp chia + 3 tbsp water per egg', notes: 'Similar to flax, slightly thicker', tags: ['vegan'] }
    ],
    'bread crumbs': [
        { sub: 'Almond flour', ratio: '1:1', notes: 'Gluten-free, nuttier', tags: ['gluten-free','low-carb'] },
        { sub: 'Crushed crackers', ratio: '1:1', notes: 'Check for gluten-free options', tags: [] },
        { sub: 'Oat flour', ratio: '1:1', notes: 'Blend oats, softer coating', tags: [] }
    ],
    'flour': [
        { sub: 'Almond flour', ratio: '1:1 for coating, 3/4 for baking', notes: 'Gluten-free, denser', tags: ['gluten-free','low-carb'] },
        { sub: 'Oat flour', ratio: '1:1', notes: 'Blend oats finely', tags: ['gluten-free'] },
        { sub: 'Coconut flour', ratio: '1/4 the amount + more liquid', notes: 'Very absorbent', tags: ['gluten-free','low-carb'] }
    ],
    'sugar': [
        { sub: 'Honey', ratio: '3/4 cup per 1 cup sugar', notes: 'Reduce liquid by 1/4 cup', tags: [] },
        { sub: 'Maple syrup', ratio: '3/4 cup per 1 cup sugar', notes: 'Distinct flavor, reduce liquid', tags: ['vegan'] },
        { sub: 'Stevia', ratio: '1 tsp per 1 cup sugar', notes: 'Zero calorie, very sweet', tags: ['diabetic-friendly','low-carb'] }
    ],
    'tomatoes': [
        { sub: 'Canned tomatoes', ratio: '1 can per 3-4 fresh', notes: 'Often more flavorful for cooking', tags: ['budget'] },
        { sub: 'Roasted red peppers', ratio: '1:1 for sauces', notes: 'Sweeter, nightshade-free if needed', tags: [] }
    ],
    'spinach': [
        { sub: 'Kale', ratio: '1:1 chopped', notes: 'Remove stems, massage if raw', tags: [] },
        { sub: 'Swiss chard', ratio: '1:1', notes: 'Slightly earthier', tags: [] },
        { sub: 'Arugula', ratio: '1:1', notes: 'Peppery flavor', tags: [] }
    ]
};

function findSubstitution(ingredientText) {
    const lower = ingredientText.toLowerCase();
    return Object.keys(SUBSTITUTIONS).find(key => lower.includes(key));
}

function showIngredientSubs(ingredient) {
    const subs = SUBSTITUTIONS[ingredient];
    if (!subs) return;
    openModal(`
        <div class="modal-header">
            <h2 class="modal-title" id="modal-title-label">${icon('arrow-right-left')} Substitutions for ${ingredient}</h2>
            <button class="modal-close" onclick="closeModal()" aria-label="Close">&times;</button>
        </div>
        <div class="modal-body">
            ${subs.map(s => `
                <div class="card" style="padding:12px; margin-bottom:8px;">
                    <div style="display:flex; justify-content:space-between; align-items:start;">
                        <div>
                            <strong>${s.sub}</strong> <span class="text-muted">(${s.ratio})</span>
                            ${s.notes ? `<p class="text-muted" style="font-size:0.85rem; margin-top:4px;">${s.notes}</p>` : ''}
                        </div>
                    </div>
                    ${s.tags.length ? `<div style="margin-top:6px;">${s.tags.map(t => `<span class="tag" style="font-size:0.75rem;">${t}</span>`).join(' ')}</div>` : ''}
                </div>
            `).join('')}
            <div class="text-muted" style="text-align:center; margin-top:12px; font-size:0.85rem;">
                Need something else? <a href="#" onclick="askNonna('What can I substitute for ${ingredient}?'); closeModal(); return false;">Ask Nonna!</a>
            </div>
        </div>
    `);
    refreshIcons();
}

// ========================================
// PHASE 4: SEASONAL PRODUCE ALERTS
// ========================================
const SEASONAL_PRODUCE = {
    1:  ['citrus', 'kale', 'turnips', 'sweet potatoes', 'winter squash', 'cabbage', 'collards'],
    2:  ['citrus', 'kale', 'turnips', 'sweet potatoes', 'spinach', 'arugula'],
    3:  ['asparagus', 'lettuce', 'radishes', 'strawberries', 'peas', 'spinach', 'ramps'],
    4:  ['asparagus', 'strawberries', 'lettuce', 'radishes', 'peas', 'spring onions', 'rhubarb'],
    5:  ['strawberries', 'blueberries', 'snap peas', 'zucchini', 'cucumbers', 'fresh herbs'],
    6:  ['blueberries', 'blackberries', 'peaches', 'tomatoes', 'corn', 'peppers', 'green beans'],
    7:  ['tomatoes', 'peaches', 'corn', 'okra', 'peppers', 'eggplant', 'melons', 'figs'],
    8:  ['tomatoes', 'peppers', 'corn', 'figs', 'muscadine grapes', 'okra', 'apples'],
    9:  ['apples', 'pears', 'sweet potatoes', 'winter squash', 'turnips', 'muscadine grapes'],
    10: ['apples', 'pears', 'sweet potatoes', 'winter squash', 'kale', 'turnips', 'pumpkin'],
    11: ['sweet potatoes', 'winter squash', 'kale', 'collards', 'turnips', 'persimmons'],
    12: ['citrus', 'kale', 'collards', 'sweet potatoes', 'winter squash', 'turnips']
};

function updateSeasonalCard() {
    const month = new Date().getMonth() + 1;
    const items = SEASONAL_PRODUCE[month] || [];
    const card = document.getElementById('seasonal-card');
    if (!card || items.length === 0) return;

    const pantry = getStorage(STORAGE.PANTRY) || [];
    const pantryNames = pantry.map(p => p.name.toLowerCase());

    card.style.display = '';
    document.getElementById('seasonal-items').innerHTML = `
        <div class="flex gap-8" style="flex-wrap:wrap; margin-bottom:12px;">
            ${items.map(item => {
                const inPantry = pantryNames.some(p => p.includes(item));
                return `<span class="tag" style="background:${inPantry ? 'var(--seafoam-light)' : 'var(--gray-light)'}; color:var(--charcoal); border:1px solid ${inPantry ? 'var(--seafoam)' : 'var(--border-light)'}; padding:4px 10px; border-radius:20px; font-size:0.85rem;">
                    ${inPantry ? icon('check', 12) + ' ' : ''}${item}
                </span>`;
            }).join('')}
        </div>
        <p class="text-muted" style="font-size:0.8rem; margin-bottom:8px;">
            ${icon('map-pin', 12)} Western North Carolina &middot; ${new Date().toLocaleString('default', { month: 'long' })}
        </p>
    `;
    refreshIcons();
}

function askNonnaWithSeasonal() {
    const month = new Date().getMonth() + 1;
    const items = SEASONAL_PRODUCE[month] || [];
    askNonna(`It's ${new Date().toLocaleString('default', { month: 'long' })} in Western North Carolina. These items are in season at local farmers markets: ${items.join(', ')}. Suggest Mediterranean recipes featuring seasonal produce. Prioritize items I have in my pantry.`);
}

// ========================================
// PHASE 5: VOICE INPUT FOR PANTRY
// ========================================
function startPantryVoice() {
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    if (!SpeechRecognition) {
        showToast('Voice input not supported in this browser', 'warning');
        return;
    }

    const recognition = new SpeechRecognition();
    recognition.continuous = false;
    recognition.interimResults = false;
    recognition.lang = 'en-US';

    const btn = document.getElementById('pantry-voice-btn');
    if (btn) btn.classList.add('recording');
    showToast('Listening... speak now', 'info');

    recognition.onresult = function(event) {
        const text = event.results[0][0].transcript;
        if (btn) btn.classList.remove('recording');
        parsePantryVoiceInput(text);
    };
    recognition.onerror = function() {
        if (btn) btn.classList.remove('recording');
        showToast('Could not understand. Try again.', 'warning');
    };
    recognition.onend = function() {
        if (btn) btn.classList.remove('recording');
    };
    recognition.start();
}

function parsePantryVoiceInput(text) {
    // Enhanced multi-item parsing: Split by commas or "and"
    const rawItems = text.split(/,\s*|\s+and\s+/i);
    const parsedItems = rawItems.map(item => parseVoiceItem(item.trim())).filter(i => i !== null);

    if (parsedItems.length === 0) {
        showToast('Could not understand. Try again.', 'warning');
        return;
    }

    showVoicePantryReviewModal(text, parsedItems);
}

function parseVoiceItem(text) {
    // Normalize fractions and word numbers
    text = normalizeFractions(text);
    text = normalizeWordNumbers(text);

    // Pattern 1: qty + unit + name
    const p1 = /^(?:add\s+)?(\d+\.?\d*)\s+(cups?|tbsp|tsp|oz|lbs?|pounds?|cans?|bottles?|bags?|bunches?|jars?)\s+(?:of\s+)?(.+)/i;
    let match = text.match(p1);
    if (match) return { qty: match[1], unit: match[2].toLowerCase(), name: match[3].trim() };

    // Pattern 2: qty + name (no unit)
    const p2 = /^(?:add\s+)?(\d+\.?\d*)\s+(.+)/i;
    match = text.match(p2);
    if (match) return { qty: match[1], unit: 'count', name: match[2].trim() };

    // Pattern 3: name only (default qty 1)
    const p3 = /^(?:add\s+)?(.+)/i;
    match = text.match(p3);
    if (match) return { qty: '1', unit: 'count', name: match[1].trim() };

    return null;
}

function normalizeFractions(text) {
    const fractionMap = {
        'half': '0.5', 'a half': '0.5',
        'quarter': '0.25', 'a quarter': '0.25',
        'one and a half': '1.5', 'two and a half': '2.5',
        'three and a half': '3.5', 'four and a half': '4.5'
    };
    for (const [word, num] of Object.entries(fractionMap)) {
        const regex = new RegExp(`\\b${word}\\b`, 'gi');
        text = text.replace(regex, num);
    }
    return text;
}

function normalizeWordNumbers(text) {
    const numberMap = {
        'one': '1', 'two': '2', 'three': '3', 'four': '4', 'five': '5',
        'six': '6', 'seven': '7', 'eight': '8', 'nine': '9', 'ten': '10'
    };
    for (const [word, num] of Object.entries(numberMap)) {
        const regex = new RegExp(`\\b${word}\\b`, 'gi');
        text = text.replace(regex, num);
    }
    return text;
}

function showVoicePantryReviewModal(transcript, items) {
    const tableRows = items.map((item, idx) => {
        const category = guessCategory(item.name);
        return `
            <tr id="voice-row-${idx}">
                <td><input type="text" class="form-input form-input-sm" value="${item.qty}" id="voice-qty-${idx}" style="width:60px;"></td>
                <td><select class="form-select form-select-sm" id="voice-unit-${idx}">${getUnitOptions(item.unit)}</select></td>
                <td><input type="text" class="form-input form-input-sm" value="${escapeHtml(item.name)}" id="voice-name-${idx}"></td>
                <td><select class="form-select form-select-sm" id="voice-cat-${idx}">${getCategoryOptions(category)}</select></td>
                <td><button class="btn btn-sm btn-secondary" onclick="removeVoiceRow(${idx})">${icon('x')}</button></td>
            </tr>
        `;
    }).join('');

    openModal(`
        <div class="modal-header">
            <h2 class="modal-title">${icon('mic')} Review Items</h2>
            <button class="modal-close" onclick="closeModal()">&times;</button>
        </div>
        <div class="modal-body">
            <p class="text-muted">I heard: "<strong>${escapeHtml(transcript)}</strong>"</p>
            <table class="voice-pantry-table">
                <thead>
                    <tr>
                        <th>Qty</th>
                        <th>Unit</th>
                        <th>Item</th>
                        <th>Category</th>
                        <th></th>
                    </tr>
                </thead>
                <tbody id="voice-items-tbody">
                    ${tableRows}
                </tbody>
            </table>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
            <button class="btn btn-primary" onclick="confirmVoicePantryAddAll()">
                ${icon('plus')} Add ${items.length} Item${items.length > 1 ? 's' : ''}
            </button>
        </div>
    `, { maxWidth: '800px' });
    refreshIcons();
}

function getUnitOptions(selected) {
    const units = ['count', 'cups', 'tbsp', 'tsp', 'oz', 'lbs', 'cans', 'bottles', 'bags', 'jars', 'bunches'];
    return units.map(u => `<option value="${u}" ${u === selected ? 'selected' : ''}>${u}</option>`).join('');
}

function getCategoryOptions(selected) {
    const cats = ['produce', 'proteins', 'dairy', 'grains', 'oils', 'spices', 'canned', 'frozen', 'beverages'];
    return cats.map(c => `<option value="${c}" ${c === selected ? 'selected' : ''}>${c.charAt(0).toUpperCase() + c.slice(1)}</option>`).join('');
}

function removeVoiceRow(idx) {
    const row = document.getElementById(`voice-row-${idx}`);
    if (row) row.remove();

    const remainingRows = document.querySelectorAll('#voice-items-tbody tr').length;
    const addButton = document.querySelector('.modal-footer .btn-primary');
    if (addButton) {
        addButton.innerHTML = `${icon('plus')} Add ${remainingRows} Item${remainingRows > 1 ? 's' : ''}`;
        refreshIcons();
    }
}

function confirmVoicePantryAddAll() {
    const rows = document.querySelectorAll('#voice-items-tbody tr');
    const pantry = getStorage(STORAGE.PANTRY) || [];
    let added = 0;

    rows.forEach((_, idx) => {
        const nameInput = document.getElementById(`voice-name-${idx}`);
        if (!nameInput) return;

        const name = nameInput.value.trim();
        if (!name) return;

        const qty = document.getElementById(`voice-qty-${idx}`)?.value || '1';
        const unit = document.getElementById(`voice-unit-${idx}`)?.value || 'count';
        const cat = document.getElementById(`voice-cat-${idx}`)?.value || 'produce';

        pantry.push({
            name,
            qty: unit !== 'count' ? `${qty} ${unit}` : qty,
            category: cat,
            location: 'pantry',
            status: 'fresh',
            addedAt: new Date().toISOString()
        });
        added++;
    });

    setStorage(STORAGE.PANTRY, pantry);
    closeModal();
    renderPantry();
    showToast(`${added} item${added > 1 ? 's' : ''} added!`, 'success');
}

function guessCategory(name) {
    const lower = name.toLowerCase();
    const rules = {
        produce: /lettuce|tomato|onion|garlic|pepper|cucumber|carrot|celery|spinach|kale|zucchini|squash|potato|broccoli|cauliflower|mushroom|avocado|corn/,
        proteins: /chicken|beef|pork|fish|salmon|shrimp|tofu|egg|lamb|turkey|tuna|sausage|bacon/,
        dairy: /milk|cheese|yogurt|butter|cream|feta|mozzarella|parmesan|ricotta/,
        grains: /rice|pasta|bread|flour|oat|quinoa|couscous|noodle|tortilla|cereal/,
        oils: /olive oil|oil|vinegar|sesame/,
        spices: /salt|pepper|cumin|paprika|oregano|cinnamon|turmeric|chili|garlic powder|thyme|rosemary|basil/,
        canned: /can of|canned|tomato sauce|broth|stock|beans|chickpea|lentil/,
        frozen: /frozen/,
        beverages: /water|juice|coffee|tea|wine|beer|soda/
    };
    for (const [cat, regex] of Object.entries(rules)) {
        if (regex.test(lower)) return cat;
    }
    return 'produce';
}

function confirmVoicePantryAdd() {
    const name = document.getElementById('voice-pantry-name').value.trim();
    if (!name) { showToast('Please enter an item name', 'warning'); return; }

    const item = {
        name: name,
        qty: document.getElementById('voice-pantry-qty').value.trim() || '1',
        category: document.getElementById('voice-pantry-cat').value,
        location: 'pantry',
        status: 'fresh',
        addedAt: new Date().toISOString()
    };
    const pantry = getStorage(STORAGE.PANTRY) || [];
    pantry.push(item);
    setStorage(STORAGE.PANTRY, pantry);
    closeModal();
    renderPantry();
    showToast(`${name} added to pantry!`, 'success');
}

// ========================================
// PHASE 6: LEFTOVER TRANSFORMER
// ========================================
function openLeftoverTransformer() {
    const pantry = getStorage(STORAGE.PANTRY) || [];
    const pantryItems = pantry.map(p => p.name).slice(0, 20);

    openModal(`
        <div class="modal-header">
            <h2 class="modal-title" id="modal-title-label">${icon('refresh-cw')} Leftover Transformer</h2>
            <button class="modal-close" onclick="closeModal()" aria-label="Close">&times;</button>
        </div>
        <div class="modal-body">
            <p class="text-muted" style="margin-bottom:12px;">Tell Nonna what leftovers you have, and she'll suggest creative new meals.</p>
            <div class="form-group">
                <label>What leftovers do you have?</label>
                <textarea class="form-textarea" id="leftover-input" rows="3" placeholder="e.g., leftover roasted chicken, half a lemon, some cooked rice, wilting spinach"></textarea>
            </div>
            ${pantryItems.length > 0 ? `
                <div class="form-group">
                    <label>Quick add from pantry:</label>
                    <div class="flex gap-8" style="flex-wrap:wrap;">
                        ${pantryItems.map(item => `
                            <span class="tag" style="cursor:pointer; padding:4px 10px;" onclick="addLeftoverItem('${item.replace(/'/g, "\\'")}')">${item}</span>
                        `).join('')}
                    </div>
                </div>
            ` : ''}
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
            <button class="btn btn-primary" onclick="transformLeftovers()">${icon('bot')} Ask Nonna</button>
        </div>
    `);
    refreshIcons();
}

function addLeftoverItem(item) {
    const input = document.getElementById('leftover-input');
    if (!input) return;
    const current = input.value.trim();
    input.value = current ? `${current}, ${item}` : item;
}

function transformLeftovers() {
    const leftovers = document.getElementById('leftover-input').value.trim();
    if (!leftovers) { showToast('Please enter some leftover ingredients', 'warning'); return; }
    closeModal();
    askNonna(`I have these leftovers I need to use up: ${leftovers}. Please suggest 3-5 creative Mediterranean-inspired recipes to transform these leftovers into new meals. For each suggestion, give the recipe name, a brief description, which leftovers it uses, estimated time, and difficulty level. Prioritize recipes that use multiple leftovers at once and minimize waste.`);
}

// ========================================
// PHASE 7: RECIPE COLLECTIONS
// ========================================
function getCollections() {
    return getStorage('tavola_collections') || [];
}

function saveCollections(collections) {
    setStorage('tavola_collections', collections);
}

function renderCollections() {
    const collections = getCollections();
    const grid = document.getElementById('collections-grid');
    const empty = document.getElementById('collections-empty');
    if (!grid) return;

    if (collections.length === 0) {
        grid.innerHTML = '';
        if (empty) empty.style.display = '';
        return;
    }
    if (empty) empty.style.display = 'none';

    const library = getStorage(STORAGE.RECIPES) || [];
    grid.innerHTML = collections.map(col => {
        const recipeCount = col.recipeIds?.length || 0;
        return `
            <div class="card library-card" onclick="viewCollection('${col.id}')" style="cursor:pointer;">
                <div class="card-title">${icon('library')} ${col.name}</div>
                ${col.description ? `<p class="text-muted" style="font-size:0.85rem;">${col.description}</p>` : ''}
                <div class="text-muted" style="font-size:0.8rem; margin-top:4px;">${recipeCount} recipe${recipeCount !== 1 ? 's' : ''}</div>
            </div>
        `;
    }).join('');
    refreshIcons();
}

function openCreateCollectionModal() {
    openModal(`
        <div class="modal-header">
            <h2 class="modal-title" id="modal-title-label">${icon('library')} New Collection</h2>
            <button class="modal-close" onclick="closeModal()" aria-label="Close">&times;</button>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label>Name</label>
                <input type="text" class="form-input" id="col-name" placeholder="e.g., Weeknight Dinners">
            </div>
            <div class="form-group">
                <label>Description (optional)</label>
                <textarea class="form-textarea" id="col-desc" rows="2" placeholder="What's this collection about?"></textarea>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
            <button class="btn btn-primary" onclick="saveNewCollection()">${icon('save')} Create</button>
        </div>
    `);
    refreshIcons();
}

function saveNewCollection() {
    const name = document.getElementById('col-name').value.trim();
    if (!name) { showToast('Please enter a name', 'warning'); return; }
    const collections = getCollections();
    collections.push({
        id: 'col_' + Date.now(),
        name,
        description: document.getElementById('col-desc').value.trim(),
        recipeIds: [],
        createdAt: new Date().toISOString()
    });
    saveCollections(collections);
    closeModal();
    renderCollections();
    showToast('Collection created!', 'success');
}

function viewCollection(colId) {
    const collections = getCollections();
    const col = collections.find(c => c.id === colId);
    if (!col) return;

    const library = getStorage(STORAGE.RECIPES) || [];
    const recipes = library.filter(r => (col.recipeIds || []).includes(r.id));

    openModal(`
        <div class="modal-header">
            <div>
                <h2 class="modal-title" id="modal-title-label">${col.name}</h2>
                <p class="text-muted">${col.description || ''} &middot; ${recipes.length} recipes</p>
            </div>
            <button class="modal-close" onclick="closeModal()" aria-label="Close">&times;</button>
        </div>
        <div class="modal-body">
            <div style="margin-bottom:12px;">
                <button class="btn btn-sm btn-primary" onclick="openAddRecipeToCollection('${colId}')">${icon('plus')} Add Recipes</button>
                <button class="btn btn-sm" style="background:var(--danger);color:white;" onclick="deleteCollection('${colId}')">${icon('trash-2')} Delete</button>
            </div>
            ${recipes.length > 0 ? recipes.map(r => `
                <div class="card" style="padding:10px; margin-bottom:8px; display:flex; justify-content:space-between; align-items:center;">
                    <div>
                        <strong>${r.title}</strong>
                        <div class="text-muted" style="font-size:0.8rem;">${r.metadata?.totalTime || 30} min</div>
                    </div>
                    <div>
                        <button class="btn btn-ghost btn-sm" onclick="viewRecipeDetail('${r.id}')">${icon('eye')}</button>
                        <button class="btn btn-ghost btn-sm" onclick="removeFromCollection('${colId}', '${r.id}')">${icon('x')}</button>
                    </div>
                </div>
            `).join('') : '<p class="text-muted" style="text-align:center; padding:16px;">No recipes yet. Add some!</p>'}
        </div>
    `);
    refreshIcons();
}

function openAddRecipeToCollection(colId) {
    const library = getStorage(STORAGE.RECIPES) || [];
    const collections = getCollections();
    const col = collections.find(c => c.id === colId);
    if (!col) return;
    const existingIds = new Set(col.recipeIds || []);

    openModal(`
        <div class="modal-header">
            <h2 class="modal-title" id="modal-title-label">${icon('plus')} Add to ${col.name}</h2>
            <button class="modal-close" onclick="closeModal()" aria-label="Close">&times;</button>
        </div>
        <div class="modal-body">
            ${library.length > 0 ? library.map(r => `
                <label class="toggle" style="padding:8px 0; border-bottom:1px solid var(--border-light); display:flex; align-items:center; gap:8px;">
                    <input type="checkbox" value="${r.id}" ${existingIds.has(r.id) ? 'checked' : ''} onchange="toggleRecipeInCollection('${colId}', '${r.id}', this.checked)">
                    <span>${r.title}</span>
                </label>
            `).join('') : '<p class="text-muted">No recipes in your library yet.</p>'}
        </div>
    `);
}

function toggleRecipeInCollection(colId, recipeId, add) {
    const collections = getCollections();
    const col = collections.find(c => c.id === colId);
    if (!col) return;
    if (!col.recipeIds) col.recipeIds = [];
    if (add && !col.recipeIds.includes(recipeId)) {
        col.recipeIds.push(recipeId);
    } else if (!add) {
        col.recipeIds = col.recipeIds.filter(id => id !== recipeId);
    }
    saveCollections(collections);
}

function removeFromCollection(colId, recipeId) {
    toggleRecipeInCollection(colId, recipeId, false);
    viewCollection(colId);
    showToast('Removed from collection', 'success');
}

function deleteCollection(colId) {
    const collections = getCollections().filter(c => c.id !== colId);
    saveCollections(collections);
    closeModal();
    renderCollections();
    showToast('Collection deleted', 'success');
}

// ========================================
// PHASE 8: RECIPE IMPORT FROM URL
// ========================================
function openImportRecipeModal() {
    openModal(`
        <div class="modal-header">
            <h2 class="modal-title" id="modal-title-label">${icon('link')} Import Recipe from URL</h2>
            <button class="modal-close" onclick="closeModal()" aria-label="Close">&times;</button>
        </div>
        <div class="modal-body">
            <p class="text-muted" style="margin-bottom:12px;">Paste a URL from any recipe website (AllRecipes, Food Network, NYT Cooking, etc.)</p>
            <div class="form-group">
                <input type="url" class="form-input" id="import-url" placeholder="https://www.example.com/recipe/...">
            </div>
            <div id="import-status"></div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
            <button class="btn btn-primary" id="import-btn" onclick="importRecipeFromUrl()">${icon('download')} Import</button>
        </div>
    `);
    refreshIcons();
}

async function importRecipeFromUrl() {
    const url = document.getElementById('import-url').value.trim();
    if (!url) { showToast('Please enter a URL', 'warning'); return; }

    const btn = document.getElementById('import-btn');
    const status = document.getElementById('import-status');
    btn.disabled = true;
    btn.textContent = 'Importing...';
    status.innerHTML = `<div class="text-muted" style="text-align:center; padding:16px;">${icon('loader', 20)} Fetching and parsing recipe...</div>`;
    refreshIcons();

    try {
        const response = await fetch('/.netlify/functions/import-recipe', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ url })
        });
        const data = await response.json();

        if (data.error) {
            status.innerHTML = `<p style="color:var(--danger);">${icon('alert-triangle')} ${data.error}. Try adding the recipe manually instead.</p>`;
            btn.disabled = false;
            btn.innerHTML = `${icon('download')} Import`;
            refreshIcons();
            return;
        }
        showImportPreview(data.recipe, url);
    } catch (error) {
        status.innerHTML = `<p style="color:var(--danger);">${icon('alert-triangle')} Import failed: ${error.message}. The recipe import service may not be set up yet.</p>`;
        btn.disabled = false;
        btn.innerHTML = `${icon('download')} Import`;
        refreshIcons();
    }
}

function showImportPreview(recipe, sourceUrl) {
    openModal(`
        <div class="modal-header">
            <h2 class="modal-title" id="modal-title-label">${icon('check-circle')} Recipe Imported</h2>
            <button class="modal-close" onclick="closeModal()" aria-label="Close">&times;</button>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label>Title</label>
                <input type="text" class="form-input" id="import-title" value="${(recipe.title || '').replace(/"/g, '&quot;')}">
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label>Servings</label>
                    <input type="number" class="form-input" id="import-servings" value="${recipe.servings || 4}">
                </div>
                <div class="form-group">
                    <label>Prep (min)</label>
                    <input type="number" class="form-input" id="import-prep" value="${recipe.metadata?.prepTime || 0}">
                </div>
                <div class="form-group">
                    <label>Cook (min)</label>
                    <input type="number" class="form-input" id="import-cook" value="${recipe.metadata?.cookTime || 0}">
                </div>
            </div>
            <div class="form-group">
                <label>Ingredients (one per line)</label>
                <textarea class="form-textarea" id="import-ingredients" rows="8">${(recipe.ingredients || []).join('\n')}</textarea>
            </div>
            <div class="form-group">
                <label>Instructions (one per line)</label>
                <textarea class="form-textarea" id="import-instructions" rows="8">${(recipe.instructions || []).join('\n')}</textarea>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
            <button class="btn btn-primary" onclick="saveImportedRecipe('${sourceUrl.replace(/'/g, "\\'")}')">${icon('save')} Save to Library</button>
        </div>
    `);
    refreshIcons();
}

function saveImportedRecipe(sourceUrl) {
    const title = document.getElementById('import-title').value.trim();
    if (!title) { showToast('Please enter a title', 'warning'); return; }

    const prepTime = parseInt(document.getElementById('import-prep').value) || 0;
    const cookTime = parseInt(document.getElementById('import-cook').value) || 0;
    const recipe = {
        id: 'recipe_' + Date.now(),
        title,
        ingredients: document.getElementById('import-ingredients').value.split('\n').filter(l => l.trim()),
        instructions: document.getElementById('import-instructions').value.split('\n').filter(l => l.trim()),
        servings: parseInt(document.getElementById('import-servings').value) || 4,
        metadata: {
            prepTime, cookTime,
            totalTime: prepTime + cookTime,
            serves: parseInt(document.getElementById('import-servings').value) || 4,
            sourceUrl
        },
        nutrition: {},
        tags: ['imported'],
        dateGenerated: new Date().toISOString(),
        timesCooked: 0, rating: 0, favorited: false
    };

    const library = getStorage(STORAGE.RECIPES) || [];
    library.push(recipe);
    setStorage(STORAGE.RECIPES, library);
    closeModal();
    renderRecipeLibrary();
    showToast(`"${title}" imported successfully!`, 'success');
}
</script>
</body>
</html>
