<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tavola - Mediterranean Meal Planning</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Dancing+Script:wght@600;700&family=Lora:wght@400;500;600&family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">
    <style>
        :root {
            --cerulean: #007BA7;
            --cerulean-dark: #006691;
            --cerulean-light: #3399bf;
            --seafoam: #7FD8BE;
            --seafoam-light: #b8e8d8;
            --seafoam-dark: #5cb89a;
            --navy: #1A2332;
            --cream: #FFF8E7;
            --white: #FFFFFF;
            --gray-light: #f5f5f5;
            --gray-medium: #e0e0e0;
            --gray-text: #666;
            --warning: #ff9800;
            --danger: #cc4444;
            --success: #4caf50;
            --shadow: 0 2px 8px rgba(26, 35, 50, 0.08);
            --shadow-lg: 0 4px 16px rgba(26, 35, 50, 0.12);
            --radius: 12px;
            --radius-sm: 8px;
            --radius-lg: 16px;
        }
        .dark-mode {
            --cream: #1A1A1A;
            --white: #2A2A2A;
            --navy: #E8E8E8;
            --gray-light: #333;
            --gray-medium: #444;
            --gray-text: #aaa;
            --cerulean: #3399bf;
            --shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
            --shadow-lg: 0 4px 16px rgba(0, 0, 0, 0.4);
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background-color: var(--cream);
            color: var(--navy);
            line-height: 1.6;
            min-height: 100vh;
            padding-bottom: 80px;
        }
        .container { max-width: 900px; margin: 0 auto; padding: 0 16px; }
        h1, h2, h3 { font-family: 'Lora', serif; font-weight: 500; }
        .logo { font-family: 'Dancing Script', cursive; font-size: 2rem; font-weight: 700; color: var(--cerulean); text-decoration: none; }

        /* Header */
        .header {
            background: var(--white);
            border-bottom: 1px solid var(--gray-medium);
            padding: 12px 0;
            position: sticky;
            top: 0;
            z-index: 100;
        }
        .header-content { display: flex; justify-content: space-between; align-items: center; }
        .header-right { display: flex; align-items: center; gap: 8px; }
        .header-search {
            display: flex;
            align-items: center;
            background: var(--gray-light);
            border-radius: 20px;
            padding: 6px 12px;
            gap: 8px;
            max-width: 200px;
        }
        .header-search input {
            border: none;
            background: transparent;
            outline: none;
            font-size: 0.9rem;
            width: 100%;
            color: var(--navy);
        }
        .icon-btn {
            background: none;
            border: none;
            padding: 8px;
            border-radius: var(--radius-sm);
            cursor: pointer;
            color: var(--navy);
            font-size: 1.2rem;
            transition: background 0.2s;
        }
        .icon-btn:hover { background: var(--gray-light); }

        /* Bottom Navigation - 5 tabs */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--white);
            border-top: 1px solid var(--gray-medium);
            display: flex;
            justify-content: space-around;
            padding: 6px 0 max(6px, env(safe-area-inset-bottom));
            z-index: 100;
        }
        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 6px 8px;
            border: none;
            background: none;
            color: var(--gray-text);
            font-size: 0.65rem;
            font-family: inherit;
            cursor: pointer;
            border-radius: var(--radius-sm);
            transition: all 0.2s;
            min-width: 56px;
        }
        .nav-item span.icon { font-size: 1.4rem; margin-bottom: 2px; }
        .nav-item.active { color: var(--cerulean); background: var(--seafoam-light); }
        .nav-item:hover:not(.active) { background: var(--gray-light); }

        /* Buttons */
        .btn {
            padding: 12px 24px;
            border-radius: var(--radius);
            font-family: inherit;
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            border: none;
            min-height: 44px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        .btn-primary { background: var(--cerulean); color: white; }
        .btn-primary:hover { background: var(--cerulean-dark); }
        .btn-secondary { background: var(--white); color: var(--cerulean); border: 2px solid var(--cerulean); }
        .btn-secondary:hover { background: var(--seafoam-light); }
        .btn-ghost { background: transparent; color: var(--cerulean); }
        .btn-ghost:hover { background: var(--seafoam-light); }
        .btn-sm { padding: 8px 16px; font-size: 0.9rem; min-height: 36px; }
        .btn-block { width: 100%; }

        /* Cards */
        .card {
            background: var(--white);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            padding: 20px;
            margin-bottom: 16px;
        }
        .card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; }
        .card-title { font-size: 1.1rem; color: var(--cerulean); }

        /* Quick Action Tiles */
        .action-tiles { display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; margin-bottom: 20px; }
        .action-tile {
            background: var(--white);
            border-radius: var(--radius);
            padding: 20px 16px;
            text-align: center;
            cursor: pointer;
            box-shadow: var(--shadow);
            transition: all 0.2s;
            border: 2px solid transparent;
        }
        .action-tile:hover { transform: translateY(-2px); box-shadow: var(--shadow-lg); border-color: var(--cerulean); }
        .action-tile-icon { font-size: 2rem; margin-bottom: 8px; }
        .action-tile-title { font-weight: 600; color: var(--navy); margin-bottom: 4px; }
        .action-tile-desc { font-size: 0.8rem; color: var(--gray-text); }

        /* Stats Bar */
        .stats-bar {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
            background: var(--white);
            border-radius: var(--radius);
            padding: 12px;
            margin-bottom: 16px;
            box-shadow: var(--shadow);
        }
        @media (min-width: 640px) { .stats-bar { grid-template-columns: repeat(4, 1fr); } }
        .stat-item { display: flex; align-items: center; gap: 8px; font-size: 0.85rem; }
        .stat-item .icon { font-size: 1.1rem; }

        /* Forms */
        .form-group { margin-bottom: 16px; }
        .form-group label { display: block; font-weight: 500; margin-bottom: 6px; font-size: 0.95rem; }
        .form-input, .form-select, .form-textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--gray-medium);
            border-radius: var(--radius-sm);
            font-family: inherit;
            font-size: 1rem;
            color: var(--navy);
            background: var(--white);
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        .form-input:focus, .form-select:focus, .form-textarea:focus {
            outline: none;
            border-color: var(--cerulean);
            box-shadow: 0 0 0 3px rgba(0, 123, 167, 0.15);
        }
        .form-textarea { min-height: 80px; resize: vertical; }
        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
        @media (max-width: 600px) { .form-row { grid-template-columns: 1fr; } }
        .checkbox-item, .radio-item { display: flex; align-items: center; gap: 10px; padding: 8px 0; cursor: pointer; }
        .checkbox-item input, .radio-item input { width: 20px; height: 20px; accent-color: var(--cerulean); cursor: pointer; }

        /* Tags */
        .tag {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 500;
            background: var(--seafoam-light);
            color: var(--navy);
            margin-right: 6px;
            margin-bottom: 6px;
        }
        .tag-crohns { background: #e8f5e9; color: #2e7d32; }
        .tag-quick { background: #fff3e0; color: #ef6c00; }
        .tag-mediterranean { background: #e3f2fd; color: #1565c0; }

        /* Sections */
        .section { padding: 20px 0; }
        .section-title {
            font-family: 'Lora', serif;
            font-size: 1.4rem;
            color: var(--cerulean);
            margin-bottom: 16px;
            padding-bottom: 8px;
            border-bottom: 2px solid var(--seafoam);
        }

        /* Views */
        .view { display: none; }
        .view.active { display: block; }

        /* Welcome Screen */
        .welcome-screen {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: calc(100vh - 100px);
            text-align: center;
            padding: 40px 20px;
        }
        .welcome-logo { font-family: 'Dancing Script', cursive; font-size: 4rem; color: var(--cerulean); margin-bottom: 8px; }
        .welcome-subtitle { font-family: 'Lora', serif; font-size: 1.3rem; color: var(--navy); margin-bottom: 8px; }
        .welcome-tagline { color: var(--gray-text); margin-bottom: 32px; max-width: 400px; }

        /* Chat Interface */
        .chat-container { display: flex; flex-direction: column; height: calc(100vh - 180px); }
        .chat-messages { flex: 1; overflow-y: auto; padding: 16px 0; }
        .message { margin-bottom: 16px; animation: fadeIn 0.3s ease; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .message-user { display: flex; justify-content: flex-end; }
        .message-user .message-bubble {
            background: var(--seafoam);
            color: var(--navy);
            border-radius: var(--radius) var(--radius) 4px var(--radius);
            max-width: 85%;
            padding: 12px 16px;
        }
        .message-assistant { display: flex; justify-content: flex-start; }
        .message-assistant .message-bubble {
            background: var(--white);
            border: 1px solid var(--seafoam);
            border-radius: var(--radius) var(--radius) var(--radius) 4px;
            max-width: 90%;
            padding: 16px;
            box-shadow: var(--shadow);
        }
        .chat-input-area { background: var(--white); border-top: 1px solid var(--gray-medium); padding: 12px 0; }
        .chat-input-wrapper { display: flex; gap: 8px; align-items: flex-end; }
        .chat-input {
            flex: 1;
            border: 1px solid var(--gray-medium);
            border-radius: var(--radius);
            padding: 12px;
            font-family: inherit;
            font-size: 1rem;
            resize: none;
            min-height: 48px;
            max-height: 120px;
        }
        .chat-input:focus { outline: none; border-color: var(--cerulean); }
        .voice-btn {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            border: none;
            background: var(--gray-light);
            color: var(--navy);
            font-size: 1.3rem;
            cursor: pointer;
            transition: all 0.2s;
        }
        .voice-btn:hover { background: var(--gray-medium); }
        .voice-btn.recording { background: var(--danger); color: white; animation: pulse 1s infinite; }
        @keyframes pulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.05); } }
        .send-btn {
            width: 48px;
            height: 48px;
            border-radius: var(--radius);
            border: none;
            background: var(--cerulean);
            color: white;
            font-size: 1.2rem;
            cursor: pointer;
            transition: background 0.2s;
        }
        .send-btn:hover { background: var(--cerulean-dark); }
        .send-btn:disabled { opacity: 0.5; cursor: not-allowed; }

        /* Quick Actions */
        .quick-actions { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 12px; }
        .quick-action {
            background: var(--white);
            border: 1px solid var(--seafoam);
            padding: 8px 14px;
            border-radius: 20px;
            font-size: 0.85rem;
            color: var(--navy);
            cursor: pointer;
            transition: all 0.2s;
        }
        .quick-action:hover { background: var(--seafoam-light); border-color: var(--cerulean); }

        /* Thinking Animation - Nonna themed */
        .thinking { display: flex; align-items: center; gap: 12px; color: var(--gray-text); padding: 16px; }
        .thinking-animation {
            font-size: 2rem;
            animation: cook 1.5s ease-in-out infinite;
        }
        @keyframes cook { 0%, 100% { transform: rotate(-5deg); } 50% { transform: rotate(5deg); } }
        .thinking-text { font-style: italic; }

        /* Recipe Card */
        .recipe-card {
            background: var(--white);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-lg);
            overflow: hidden;
            margin: 16px 0;
        }
        .recipe-header {
            background: linear-gradient(135deg, var(--cerulean) 0%, var(--seafoam-dark) 100%);
            color: white;
            padding: 20px;
            position: relative;
        }
        .recipe-title { font-family: 'Lora', serif; font-size: 1.5rem; margin-bottom: 8px; padding-right: 100px; }
        .recipe-actions { position: absolute; top: 12px; right: 12px; display: flex; gap: 8px; }
        .recipe-action-btn {
            background: rgba(255,255,255,0.2);
            border: none;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            color: white;
            cursor: pointer;
            transition: background 0.2s;
            font-size: 1rem;
        }
        .recipe-action-btn:hover { background: rgba(255,255,255,0.3); }
        .recipe-action-btn.favorited { background: var(--danger); }
        .recipe-meta { display: flex; flex-wrap: wrap; gap: 16px; margin-top: 12px; font-size: 0.9rem; }
        .recipe-meta-item { display: flex; align-items: center; gap: 4px; }
        .recipe-tags { padding: 12px 20px; background: var(--gray-light); }
        .recipe-body { padding: 20px; }
        .recipe-section { margin-bottom: 24px; }
        .recipe-section-title {
            font-family: 'Lora', serif;
            font-size: 1.1rem;
            color: var(--cerulean);
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .ingredient-item {
            display: flex;
            align-items: flex-start;
            gap: 10px;
            padding: 8px 0;
            border-bottom: 1px solid var(--gray-light);
        }
        .ingredient-item:last-child { border-bottom: none; }
        .ingredient-checkbox { width: 22px; height: 22px; accent-color: var(--cerulean); cursor: pointer; flex-shrink: 0; margin-top: 2px; }
        .ingredient-text.checked { text-decoration: line-through; color: var(--gray-text); }
        .instruction-step { display: flex; gap: 12px; padding: 12px 0; border-bottom: 1px solid var(--gray-light); }
        .instruction-step:last-child { border-bottom: none; }
        .step-number {
            width: 28px;
            height: 28px;
            background: var(--cerulean);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 0.9rem;
            flex-shrink: 0;
        }
        .recipe-notes {
            background: var(--seafoam-light);
            border-radius: var(--radius);
            padding: 16px;
            margin-top: 16px;
        }
        .recipe-notes-title { font-weight: 600; margin-bottom: 8px; color: var(--cerulean); }

        /* Recipe Card Actions Bar */
        .recipe-card-actions {
            display: flex;
            gap: 8px;
            padding: 16px 20px;
            border-top: 1px solid var(--gray-light);
            background: var(--gray-light);
        }
        .recipe-card-actions .btn { flex: 1; }

        /* Nonna's Tip */
        .nonna-tip {
            background: linear-gradient(135deg, var(--cream) 0%, var(--seafoam-light) 100%);
            border-left: 4px solid var(--cerulean);
            border-radius: 0 var(--radius) var(--radius) 0;
            padding: 16px;
            margin: 16px 0;
        }
        .nonna-tip-header { display: flex; align-items: center; gap: 8px; margin-bottom: 8px; font-weight: 600; color: var(--cerulean); }
        .nonna-tip-text { font-style: italic; color: var(--navy); }
        .nonna-tip-signature { text-align: right; margin-top: 8px; color: var(--gray-text); font-size: 0.9rem; }

        /* Tabs */
        .tabs {
            display: flex;
            gap: 4px;
            background: var(--gray-light);
            padding: 4px;
            border-radius: var(--radius);
            margin-bottom: 16px;
            overflow-x: auto;
        }
        .tab {
            flex: 1;
            padding: 10px 16px;
            border: none;
            background: transparent;
            font-family: inherit;
            font-size: 0.9rem;
            font-weight: 500;
            color: var(--gray-text);
            cursor: pointer;
            border-radius: var(--radius-sm);
            white-space: nowrap;
            transition: all 0.2s;
        }
        .tab.active { background: var(--white); color: var(--cerulean); box-shadow: var(--shadow); }
        .tab:hover:not(.active) { color: var(--navy); }
        .tab-content { display: none; }
        .tab-content.active { display: block; }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 48px 24px;
            color: var(--gray-text);
        }
        .empty-state-icon { font-size: 3.5rem; margin-bottom: 16px; opacity: 0.7; }
        .empty-state-title { font-family: 'Lora', serif; font-size: 1.3rem; color: var(--navy); margin-bottom: 8px; }
        .empty-state-text { margin-bottom: 20px; max-width: 300px; margin-left: auto; margin-right: auto; }

        /* Grid */
        .grid { display: grid; gap: 16px; }
        .grid-2 { grid-template-columns: repeat(2, 1fr); }
        .grid-3 { grid-template-columns: repeat(3, 1fr); }
        @media (max-width: 768px) { .grid-2, .grid-3 { grid-template-columns: 1fr; } }
        @media (min-width: 769px) and (max-width: 1024px) { .grid-3 { grid-template-columns: repeat(2, 1fr); } }

        /* Recipe Library Card */
        .library-card {
            background: var(--white);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            overflow: hidden;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            position: relative;
        }
        .library-card:hover { transform: translateY(-2px); box-shadow: var(--shadow-lg); }
        .library-card-banner {
            height: 80px;
            background: linear-gradient(135deg, var(--cerulean) 0%, var(--seafoam-dark) 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            position: relative;
        }
        .library-card-favorite {
            position: absolute;
            top: 8px;
            right: 8px;
            font-size: 1.2rem;
        }
        .library-card-body { padding: 12px; }
        .library-card-title { font-weight: 600; font-size: 0.95rem; margin-bottom: 4px; color: var(--navy); }
        .library-card-meta { font-size: 0.8rem; color: var(--gray-text); display: flex; gap: 12px; margin-bottom: 6px; }
        .library-card-tags { display: flex; flex-wrap: wrap; gap: 4px; }
        .library-card-tags .tag { font-size: 0.65rem; padding: 2px 6px; margin: 0; }
        .library-card-rating { color: #ffc107; font-size: 0.85rem; margin-top: 4px; }

        /* Week Planner */
        .week-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
            flex-wrap: wrap;
            gap: 12px;
        }
        .week-nav { display: flex; align-items: center; gap: 12px; }
        .week-nav-btn { background: var(--gray-light); border: none; padding: 8px 12px; border-radius: var(--radius-sm); cursor: pointer; font-size: 1rem; }
        .week-nav-btn:hover { background: var(--gray-medium); }
        .week-title { font-family: 'Lora', serif; font-size: 1.2rem; color: var(--navy); }
        .week-actions { display: flex; gap: 8px; flex-wrap: wrap; }

        .week-day {
            background: var(--white);
            border-radius: var(--radius);
            padding: 16px;
            margin-bottom: 12px;
            box-shadow: var(--shadow);
        }
        .week-day-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
        .week-day-name { font-weight: 600; color: var(--cerulean); }
        .week-day-date { font-size: 0.85rem; color: var(--gray-text); }
        .week-day-meal {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            background: var(--gray-light);
            border-radius: var(--radius-sm);
        }
        .week-day-meal-info { flex: 1; }
        .week-day-meal-title { font-weight: 500; }
        .week-day-meal-meta { font-size: 0.8rem; color: var(--gray-text); }
        .week-day-meal-actions { display: flex; gap: 4px; }
        .week-day-empty {
            padding: 24px;
            text-align: center;
            color: var(--gray-text);
            border: 2px dashed var(--gray-medium);
            border-radius: var(--radius-sm);
            cursor: pointer;
            transition: all 0.2s;
        }
        .week-day-empty:hover { border-color: var(--cerulean); color: var(--cerulean); }

        /* Week Plan Summary Card */
        .week-plan-card {
            background: linear-gradient(135deg, var(--cerulean) 0%, var(--seafoam-dark) 100%);
            color: white;
            border-radius: var(--radius);
            padding: 20px;
            margin: 16px 0;
        }
        .week-plan-card h3 { margin-bottom: 12px; }
        .week-plan-item { padding: 8px 0; border-bottom: 1px solid rgba(255,255,255,0.2); display: flex; justify-content: space-between; }
        .week-plan-item:last-child { border-bottom: none; }
        .week-plan-actions { display: flex; gap: 12px; margin-top: 16px; }
        .week-plan-actions .btn { flex: 1; background: rgba(255,255,255,0.2); border: none; }
        .week-plan-actions .btn:hover { background: rgba(255,255,255,0.3); }

        /* Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(26, 35, 50, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 20px;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s, visibility 0.3s;
        }
        .modal-overlay.active { opacity: 1; visibility: visible; }
        .modal {
            background: var(--white);
            border-radius: var(--radius-lg);
            width: 100%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: var(--shadow-lg);
        }
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 20px;
            border-bottom: 1px solid var(--gray-medium);
            position: sticky;
            top: 0;
            background: var(--white);
            z-index: 1;
        }
        .modal-title { font-family: 'Lora', serif; font-size: 1.2rem; }
        .modal-close { background: none; border: none; font-size: 1.5rem; color: var(--gray-text); cursor: pointer; padding: 4px; }
        .modal-body { padding: 20px; }
        .modal-footer {
            padding: 16px 20px;
            border-top: 1px solid var(--gray-medium);
            display: flex;
            justify-content: flex-end;
            gap: 12px;
        }

        /* Day Picker */
        .day-picker { display: grid; grid-template-columns: repeat(7, 1fr); gap: 8px; margin: 16px 0; }
        .day-picker-item {
            padding: 12px 8px;
            text-align: center;
            background: var(--gray-light);
            border-radius: var(--radius-sm);
            cursor: pointer;
            transition: all 0.2s;
            border: 2px solid transparent;
        }
        .day-picker-item:hover { border-color: var(--cerulean); }
        .day-picker-item.selected { background: var(--cerulean); color: white; }
        .day-picker-item .day-name { font-size: 0.7rem; text-transform: uppercase; }
        .day-picker-item .day-num { font-weight: 600; }

        /* Toggle Switch */
        .toggle { display: flex; align-items: center; gap: 12px; cursor: pointer; }
        .toggle-switch {
            width: 50px;
            height: 28px;
            background: var(--gray-medium);
            border-radius: 14px;
            position: relative;
            transition: background 0.3s;
        }
        .toggle-switch::after {
            content: '';
            position: absolute;
            top: 3px;
            left: 3px;
            width: 22px;
            height: 22px;
            background: white;
            border-radius: 50%;
            transition: transform 0.3s;
        }
        .toggle input { display: none; }
        .toggle input:checked + .toggle-switch { background: var(--cerulean); }
        .toggle input:checked + .toggle-switch::after { transform: translateX(22px); }

        /* Flare Mode Banner */
        .flare-banner {
            background: linear-gradient(135deg, #fff3e0 0%, #ffecb3 100%);
            border-left: 4px solid #ff9800;
            padding: 16px;
            margin-bottom: 16px;
            border-radius: 0 var(--radius) var(--radius) 0;
        }
        .flare-banner-title { font-weight: 600; color: #e65100; margin-bottom: 4px; }
        .flare-banner-text { font-size: 0.9rem; color: #bf360c; }

        /* More Menu */
        .more-menu { display: grid; gap: 8px; }
        .more-menu-item {
            display: flex;
            align-items: center;
            gap: 16px;
            padding: 16px;
            background: var(--white);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            cursor: pointer;
            transition: all 0.2s;
            border: none;
            width: 100%;
            text-align: left;
            font-family: inherit;
            font-size: 1rem;
            color: var(--navy);
        }
        .more-menu-item:hover { transform: translateX(4px); box-shadow: var(--shadow-lg); }
        .more-menu-item .icon { font-size: 1.5rem; width: 40px; text-align: center; }
        .more-menu-item-content { flex: 1; }
        .more-menu-item-title { font-weight: 500; }
        .more-menu-item-desc { font-size: 0.85rem; color: var(--gray-text); }

        /* Activity List */
        .activity-list { margin-top: 16px; }
        .activity-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 0;
            border-bottom: 1px solid var(--gray-light);
        }
        .activity-item:last-child { border-bottom: none; }
        .activity-icon { font-size: 1.2rem; }
        .activity-content { flex: 1; }
        .activity-title { font-size: 0.9rem; }
        .activity-time { font-size: 0.8rem; color: var(--gray-text); }

        /* Accordion */
        .accordion-item { border: 1px solid var(--gray-medium); border-radius: var(--radius-sm); margin-bottom: 8px; overflow: hidden; }
        .accordion-header {
            padding: 14px 16px;
            background: var(--gray-light);
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: 500;
        }
        .accordion-header:hover { background: var(--gray-medium); }
        .accordion-icon { transition: transform 0.3s; }
        .accordion-item.open .accordion-icon { transform: rotate(180deg); }
        .accordion-body { padding: 16px; display: none; }
        .accordion-item.open .accordion-body { display: block; }

        /* Toast */
        .toast {
            position: fixed;
            bottom: 100px;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background: var(--navy);
            color: white;
            padding: 12px 24px;
            border-radius: var(--radius);
            box-shadow: var(--shadow-lg);
            z-index: 2000;
            opacity: 0;
            transition: all 0.3s ease;
        }
        .toast.show { transform: translateX(-50%) translateY(0); opacity: 1; }

        /* Onboarding */
        .onboarding-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(26, 35, 50, 0.8);
            z-index: 2000;
            display: none;
        }
        .onboarding-overlay.active { display: flex; align-items: center; justify-content: center; }
        .onboarding-card {
            background: var(--white);
            border-radius: var(--radius-lg);
            max-width: 400px;
            width: 90%;
            padding: 32px 24px;
            text-align: center;
        }
        .onboarding-icon { font-size: 3rem; margin-bottom: 16px; }
        .onboarding-title { font-family: 'Lora', serif; font-size: 1.5rem; margin-bottom: 12px; }
        .onboarding-text { color: var(--gray-text); margin-bottom: 24px; }
        .onboarding-dots { display: flex; justify-content: center; gap: 8px; margin-bottom: 24px; }
        .onboarding-dot { width: 8px; height: 8px; border-radius: 50%; background: var(--gray-medium); }
        .onboarding-dot.active { background: var(--cerulean); }
        .onboarding-actions { display: flex; gap: 12px; justify-content: center; }

        /* Cook Mode */
        .cook-mode-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--cream);
            z-index: 1500;
            display: none;
            flex-direction: column;
        }
        .cook-mode-overlay.active { display: flex; }
        .cook-mode-header {
            background: var(--cerulean);
            color: white;
            padding: 16px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .cook-mode-progress { font-size: 1.1rem; }
        .cook-mode-close { background: rgba(255,255,255,0.2); border: none; padding: 8px 16px; border-radius: var(--radius-sm); color: white; cursor: pointer; }
        .cook-mode-body { flex: 1; overflow-y: auto; padding: 24px 20px; }
        .cook-mode-step {
            background: var(--white);
            border-radius: var(--radius);
            padding: 24px;
            margin-bottom: 16px;
            font-size: 1.2rem;
            line-height: 1.8;
        }
        .cook-mode-step-check {
            display: flex;
            align-items: flex-start;
            gap: 16px;
        }
        .cook-mode-step-check input { width: 28px; height: 28px; margin-top: 4px; }
        .cook-mode-timer {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            background: var(--warning);
            color: white;
            padding: 8px 16px;
            border-radius: var(--radius-sm);
            margin-top: 12px;
            cursor: pointer;
        }
        .cook-mode-ingredients {
            background: var(--white);
            border-radius: var(--radius);
            padding: 16px;
            margin-bottom: 16px;
        }
        .cook-mode-ingredients summary { cursor: pointer; font-weight: 600; color: var(--cerulean); }
        .cook-mode-footer {
            background: var(--white);
            border-top: 1px solid var(--gray-medium);
            padding: 16px 20px;
            display: flex;
            gap: 12px;
        }
        .cook-mode-footer .btn { flex: 1; }

        /* Utilities */
        .hidden { display: none !important; }
        .text-center { text-align: center; }
        .text-muted { color: var(--gray-text); }
        .mb-0 { margin-bottom: 0; }
        .mb-8 { margin-bottom: 8px; }
        .mb-16 { margin-bottom: 16px; }
        .mt-8 { margin-top: 8px; }
        .mt-16 { margin-top: 16px; }
        .flex { display: flex; }
        .flex-between { justify-content: space-between; }
        .flex-center { align-items: center; }
        .gap-8 { gap: 8px; }
        .gap-12 { gap: 12px; }
        .gap-16 { gap: 16px; }

        /* Search Results Highlight */
        .search-highlight { background: yellow; padding: 0 2px; }

        /* Filter Dropdown */
        .filter-dropdown {
            position: relative;
            display: inline-block;
        }
        .filter-dropdown-content {
            display: none;
            position: absolute;
            right: 0;
            top: 100%;
            background: var(--white);
            border-radius: var(--radius);
            box-shadow: var(--shadow-lg);
            min-width: 200px;
            z-index: 100;
            padding: 12px;
        }
        .filter-dropdown.open .filter-dropdown-content { display: block; }

        /* Print Styles */
        @media print {
            .header, .bottom-nav, .chat-input-area, .recipe-actions, .btn, .recipe-card-actions { display: none !important; }
            body { padding: 0; background: white; }
            .recipe-card { box-shadow: none; border: 1px solid #ddd; }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="header hidden" id="app-header">
        <div class="container header-content">
            <a href="#" class="logo" onclick="navigateTo('home'); return false;">Tavola</a>
            <div class="header-right">
                <div class="header-search" id="global-search">
                    <span>üîç</span>
                    <input type="text" placeholder="Search..." id="global-search-input" onkeyup="handleGlobalSearch(event)">
                </div>
            </div>
        </div>
    </header>

    <!-- Welcome Screen -->
    <main class="welcome-screen" id="welcome-screen">
        <h1 class="welcome-logo">Tavola</h1>
        <p class="welcome-subtitle">Mediterranean Meal Planning</p>
        <p class="welcome-tagline">Gentle, delicious meals designed for your health. Meet Nonna, your personal cooking companion.</p>
        <button class="btn btn-primary" onclick="showIntakeForm()">Get Started</button>
    </main>

    <!-- Intake Form -->
    <main class="view" id="intake-form">
        <div class="container section">
            <div class="text-center mb-16">
                <h1 class="section-title" style="border: none; text-align: center;">Let's Get to Know You</h1>
                <p class="text-muted">This helps Nonna suggest meals that work for your body</p>
            </div>
            <form id="profile-form" onsubmit="saveProfile(event)">
                <!-- Health Conditions -->
                <div class="card">
                    <h2 class="card-title">ü©∫ Health Conditions</h2>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Crohn's Severity</label>
                            <select class="form-select" name="crohnsSeverity">
                                <option value="">Select...</option>
                                <option value="mild">Mild</option>
                                <option value="moderate">Moderate</option>
                                <option value="severe">Severe</option>
                                <option value="remission">In Remission</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Crohn's Triggers</label>
                            <input type="text" class="form-input" name="crohnsTriggers" placeholder="e.g., raw veggies, nuts, dairy">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Fibromyalgia Energy</label>
                            <select class="form-select" name="fibroEnergy">
                                <option value="">Select...</option>
                                <option value="low">Low</option>
                                <option value="moderate">Moderate</option>
                                <option value="variable">Variable</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Thyroid Condition</label>
                            <input type="text" class="form-input" name="thyroidType" placeholder="e.g., Hashimoto's">
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Other Conditions or Notes</label>
                        <textarea class="form-textarea" name="otherConditions" placeholder="Anything else Nonna should know..."></textarea>
                    </div>
                </div>

                <!-- Cooking for Two -->
                <div class="card">
                    <h2 class="card-title">üë• Cooking for Two</h2>
                    <label class="toggle mb-16">
                        <input type="checkbox" name="cookingForTwo" id="cookingForTwoToggle" onchange="toggleCookingForTwo()">
                        <span class="toggle-switch"></span>
                        <span>I'm cooking for someone else too</span>
                    </label>
                    <div id="cookingForTwoFields" class="hidden">
                        <div class="form-group">
                            <label>Their Name or Relationship</label>
                            <input type="text" class="form-input" name="partnerName" placeholder="e.g., John, Partner, Mom">
                        </div>
                        <div class="form-group">
                            <label>Their Dietary Restrictions</label>
                            <div class="grid grid-2">
                                <label class="checkbox-item"><input type="checkbox" name="partnerRestrictions" value="diabetes"> Diabetes</label>
                                <label class="checkbox-item"><input type="checkbox" name="partnerRestrictions" value="heart"> Heart Disease</label>
                                <label class="checkbox-item"><input type="checkbox" name="partnerRestrictions" value="glutenFree"> Gluten-Free</label>
                                <label class="checkbox-item"><input type="checkbox" name="partnerRestrictions" value="lactose"> Lactose Intolerant</label>
                                <label class="checkbox-item"><input type="checkbox" name="partnerRestrictions" value="vegetarian"> Vegetarian</label>
                                <label class="checkbox-item"><input type="checkbox" name="partnerRestrictions" value="none"> No Restrictions</label>
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Their Allergies</label>
                            <input type="text" class="form-input" name="partnerAllergies" placeholder="e.g., shellfish, tree nuts">
                        </div>
                        <div class="form-group">
                            <label>Foods They Love</label>
                            <input type="text" class="form-input" name="partnerLoves" placeholder="e.g., spicy food, cheese, garlic">
                        </div>
                    </div>
                </div>

                <!-- Protein Preferences -->
                <div class="card">
                    <h2 class="card-title">ü•© Protein Preferences</h2>
                    <p class="text-muted mb-16">Check all proteins you eat</p>
                    <div class="grid grid-2">
                        <label class="checkbox-item"><input type="checkbox" name="proteins" value="white-fish"> White Fish</label>
                        <label class="checkbox-item"><input type="checkbox" name="proteins" value="fatty-fish"> Fatty Fish (salmon)</label>
                        <label class="checkbox-item"><input type="checkbox" name="proteins" value="shellfish"> Shellfish</label>
                        <label class="checkbox-item"><input type="checkbox" name="proteins" value="chicken"> Chicken</label>
                        <label class="checkbox-item"><input type="checkbox" name="proteins" value="turkey"> Turkey</label>
                        <label class="checkbox-item"><input type="checkbox" name="proteins" value="pork"> Pork</label>
                        <label class="checkbox-item"><input type="checkbox" name="proteins" value="beef"> Beef</label>
                        <label class="checkbox-item"><input type="checkbox" name="proteins" value="lamb"> Lamb</label>
                        <label class="checkbox-item"><input type="checkbox" name="proteins" value="eggs"> Eggs</label>
                        <label class="checkbox-item"><input type="checkbox" name="proteins" value="legumes"> Legumes</label>
                        <label class="checkbox-item"><input type="checkbox" name="proteins" value="tofu"> Tofu/Tempeh</label>
                        <label class="checkbox-item"><input type="checkbox" name="proteins" value="dairy"> Greek Yogurt/Cheese</label>
                    </div>
                </div>

                <!-- Garden -->
                <div class="card">
                    <h2 class="card-title">üå± Your Garden</h2>
                    <div class="form-group">
                        <label>What's Currently Growing?</label>
                        <textarea class="form-textarea" name="currentlyGrowing" placeholder="e.g., tomatoes, zucchini, basil, peppers..."></textarea>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Growing Zone</label>
                            <input type="text" class="form-input" name="growingZone" placeholder="e.g., 7b">
                        </div>
                        <div class="form-group">
                            <label>Current Season</label>
                            <select class="form-select" name="currentSeason">
                                <option value="spring">Spring</option>
                                <option value="summer">Summer</option>
                                <option value="fall">Fall</option>
                                <option value="winter">Winter</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Cooking Capacity -->
                <div class="card">
                    <h2 class="card-title">‚è∞ Cooking Capacity</h2>
                    <div class="form-group">
                        <label>Energy Level for Cooking</label>
                        <select class="form-select" name="energyLevel">
                            <option value="low">Low (simple meals)</option>
                            <option value="moderate">Moderate</option>
                            <option value="good">Good</option>
                            <option value="variable" selected>Variable (changes daily)</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Preferred Cooking Time</label>
                        <select class="form-select" name="cookingTime">
                            <option value="quick">Quick (15-30 min)</option>
                            <option value="standard" selected>Standard (30-60 min)</option>
                            <option value="batch">Batch Cooking</option>
                        </select>
                    </div>
                </div>

                <!-- Budget -->
                <div class="card">
                    <h2 class="card-title">üí∞ Budget</h2>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Weekly Grocery Budget</label>
                            <select class="form-select" name="weeklyBudget">
                                <option value="50-75">$50-75</option>
                                <option value="75-100">$75-100</option>
                                <option value="100-150" selected>$100-150</option>
                                <option value="150-200">$150-200</option>
                                <option value="200+">$200+</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Priority</label>
                            <select class="form-select" name="shoppingPriority">
                                <option value="quality">Quality ingredients</option>
                                <option value="budget">Budget-friendly</option>
                                <option value="balance" selected>Balance both</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Dietary Notes -->
                <div class="card">
                    <h2 class="card-title">üìù Dietary Notes</h2>
                    <div class="form-group">
                        <label>Foods to Avoid</label>
                        <textarea class="form-textarea" name="foodsToAvoid" placeholder="Specific triggers or dislikes..."></textarea>
                    </div>
                    <div class="form-group">
                        <label>Favorite Flavors</label>
                        <textarea class="form-textarea" name="favoriteFlavors" placeholder="e.g., lemon, garlic, fresh herbs..."></textarea>
                    </div>
                </div>

                <button type="submit" class="btn btn-primary btn-block">Save & Meet Nonna</button>
            </form>
        </div>
    </main>

    <!-- Main App Container -->
    <main class="view" id="app-main">
        <div class="container">
            <!-- HOME/DASHBOARD View (NEW) -->
            <div class="view active" id="view-home">
                <!-- Flare Mode Banner (shown when active) -->
                <div class="flare-banner hidden" id="home-flare-banner">
                    <div class="flare-banner-title">üå°Ô∏è Flare Mode Active</div>
                    <div class="flare-banner-text">Nonna will suggest gentle, easy-to-digest meals.</div>
                </div>

                <!-- Stats Bar -->
                <div class="stats-bar" id="dashboard-stats">
                    <div class="stat-item"><span class="icon">üçΩÔ∏è</span> <span>Meals: <strong id="stat-meals-planned">0/7</strong></span></div>
                    <div class="stat-item"><span class="icon">‚ù§Ô∏è</span> <span>Favorites: <strong id="stat-favorites">0</strong></span></div>
                    <div class="stat-item"><span class="icon">üå±</span> <span>Garden: <strong id="stat-garden">-</strong></span></div>
                    <div class="stat-item"><span class="icon">üìö</span> <span>Recipes: <strong id="stat-recipes">0</strong></span></div>
                </div>

                <!-- Quick Action Tiles -->
                <div class="action-tiles">
                    <div class="action-tile" onclick="navigateTo('week'); askNonnaForWeekPlan();">
                        <div class="action-tile-icon">üìÖ</div>
                        <div class="action-tile-title">Plan This Week</div>
                        <div class="action-tile-desc">Get your weekly meal plan</div>
                    </div>
                    <div class="action-tile" onclick="navigateTo('favorites')">
                        <div class="action-tile-icon">‚ù§Ô∏è</div>
                        <div class="action-tile-title">View Favorites</div>
                        <div class="action-tile-desc">Browse saved recipes</div>
                    </div>
                    <div class="action-tile" onclick="navigateTo('chat')">
                        <div class="action-tile-icon">üí¨</div>
                        <div class="action-tile-title">Chat with Nonna</div>
                        <div class="action-tile-desc">Ask about meals & recipes</div>
                    </div>
                    <div class="action-tile" onclick="navigateTo('more'); switchMoreTab('garden');">
                        <div class="action-tile-icon">üå±</div>
                        <div class="action-tile-title">Check Garden</div>
                        <div class="action-tile-desc">What's ready to harvest</div>
                    </div>
                </div>

                <!-- Recent Activity -->
                <div class="card">
                    <h3 class="card-title">üìã Recent Activity</h3>
                    <div class="activity-list" id="recent-activity">
                        <div class="empty-state" style="padding: 24px;">
                            <p class="text-muted">No recent activity yet. Start by chatting with Nonna!</p>
                        </div>
                    </div>
                </div>

                <!-- Nonna's Tip of the Day -->
                <div class="nonna-tip" id="nonna-tip-daily">
                    <div class="nonna-tip-header">üí° Nonna's Tip</div>
                    <div class="nonna-tip-text" id="nonna-tip-text">"Always finish with good olive oil - it makes everything taste better, cara."</div>
                    <div class="nonna-tip-signature">‚Äî Nonna</div>
                </div>

                <!-- Empty State for New Users -->
                <div class="card hidden" id="new-user-welcome">
                    <div class="text-center" style="padding: 24px;">
                        <div style="font-size: 3rem; margin-bottom: 16px;">üëã</div>
                        <h3 style="color: var(--cerulean); margin-bottom: 8px;">Welcome to Tavola!</h3>
                        <p class="text-muted mb-16">Nonna helps you plan Mediterranean meals tailored to your health needs.</p>
                        <button class="btn btn-primary" onclick="navigateTo('chat')">üí¨ Start Chatting with Nonna</button>
                    </div>
                </div>
            </div>

            <!-- THIS WEEK View -->
            <div class="view" id="view-week">
                <div class="week-header">
                    <div class="week-nav">
                        <button class="week-nav-btn" onclick="changeWeek(-1)">‚óÄ</button>
                        <span class="week-title" id="week-title">This Week</span>
                        <button class="week-nav-btn" onclick="changeWeek(1)">‚ñ∂</button>
                    </div>
                    <div class="week-actions">
                        <button class="btn btn-primary btn-sm" onclick="askNonnaForWeekPlan()">ü§ñ Plan Week</button>
                        <button class="btn btn-secondary btn-sm" onclick="generateWeekShoppingList()">üõí Shopping</button>
                        <button class="btn btn-secondary btn-sm" onclick="showPrepChecklist()">üìã Prep</button>
                    </div>
                </div>
                <div id="week-planner"></div>
                <div class="empty-state hidden" id="week-empty">
                    <div class="empty-state-icon">üìÖ</div>
                    <div class="empty-state-title">Your week is empty</div>
                    <p class="empty-state-text">Let's fill it with delicious, healthy meals! Nonna can create a complete weekly plan based on your preferences.</p>
                    <button class="btn btn-primary" onclick="askNonnaForWeekPlan()">ü§ñ Ask Nonna to Plan This Week</button>
                </div>
            </div>

            <!-- RECIPES LIBRARY View (NEW) -->
            <div class="view" id="view-recipes">
                <h2 class="section-title">üìö Recipe Library</h2>
                <div class="flex flex-between flex-center mb-16 gap-8" style="flex-wrap: wrap;">
                    <input type="text" class="form-input" id="recipes-search" placeholder="Search recipes..." style="max-width: 250px; flex: 1;" oninput="filterRecipeLibrary()">
                    <div class="filter-dropdown" id="recipe-filters">
                        <button class="btn btn-secondary btn-sm" onclick="toggleFilterDropdown()">Filters ‚ñæ</button>
                        <div class="filter-dropdown-content">
                            <div class="form-group">
                                <label>Sort by</label>
                                <select class="form-select" id="recipes-sort" onchange="filterRecipeLibrary()">
                                    <option value="recent">Recent</option>
                                    <option value="rating">Rating</option>
                                    <option value="time">Cook Time</option>
                                    <option value="name">Name A-Z</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Protein</label>
                                <select class="form-select" id="recipes-protein" onchange="filterRecipeLibrary()">
                                    <option value="">All</option>
                                    <option value="fish">Fish</option>
                                    <option value="chicken">Chicken</option>
                                    <option value="pork">Pork</option>
                                    <option value="beef">Beef</option>
                                    <option value="vegetarian">Vegetarian</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Time</label>
                                <select class="form-select" id="recipes-time" onchange="filterRecipeLibrary()">
                                    <option value="">All</option>
                                    <option value="quick">Quick (&lt;30min)</option>
                                    <option value="standard">Standard (30-60min)</option>
                                    <option value="long">Long (60+min)</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="grid grid-2" id="recipes-grid"></div>
                <div class="empty-state" id="recipes-empty">
                    <div class="empty-state-icon">üìö</div>
                    <div class="empty-state-title">Your recipe library is empty</div>
                    <p class="empty-state-text">Chat with Nonna to get personalized Mediterranean recipes tailored to your health needs!</p>
                    <button class="btn btn-primary" onclick="navigateTo('chat')">üí¨ Ask Nonna for Recipe Ideas</button>
                </div>
            </div>

            <!-- CHAT View -->
            <div class="view" id="view-chat">
                <div class="chat-container">
                    <div class="chat-messages" id="chat-messages"></div>
                    <div class="chat-input-area">
                        <div class="chat-input-wrapper">
                            <button class="voice-btn" id="voice-btn" onclick="toggleVoiceInput()" title="Voice input">üé§</button>
                            <textarea class="chat-input" id="chat-input" placeholder="Ask Nonna anything..." rows="1"></textarea>
                            <button class="send-btn" id="send-btn" onclick="sendMessage()">‚û§</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- MORE View -->
            <div class="view" id="view-more">
                <h2 class="section-title">‚öôÔ∏è More</h2>

                <!-- More Menu Items -->
                <div class="more-menu" id="more-menu-main">
                    <button class="more-menu-item" onclick="switchMoreTab('kitchen')">
                        <span class="icon">üç≥</span>
                        <div class="more-menu-item-content">
                            <div class="more-menu-item-title">Kitchen Tools</div>
                            <div class="more-menu-item-desc">Pantry, shopping lists, batch cooking</div>
                        </div>
                    </button>
                    <button class="more-menu-item" onclick="switchMoreTab('garden')">
                        <span class="icon">üå±</span>
                        <div class="more-menu-item-content">
                            <div class="more-menu-item-title">Garden</div>
                            <div class="more-menu-item-desc">Track what's growing</div>
                        </div>
                    </button>
                    <button class="more-menu-item" onclick="switchMoreTab('crohns')">
                        <span class="icon">ü©∫</span>
                        <div class="more-menu-item-content">
                            <div class="more-menu-item-title">Crohn's Care</div>
                            <div class="more-menu-item-desc">Flare mode & gentle meal options</div>
                        </div>
                    </button>
                    <button class="more-menu-item" onclick="switchMoreTab('history')">
                        <span class="icon">üìñ</span>
                        <div class="more-menu-item-content">
                            <div class="more-menu-item-title">Meal History</div>
                            <div class="more-menu-item-desc">Track what you've cooked</div>
                        </div>
                    </button>
                    <button class="more-menu-item" onclick="switchMoreTab('settings')">
                        <span class="icon">‚öôÔ∏è</span>
                        <div class="more-menu-item-content">
                            <div class="more-menu-item-title">Settings</div>
                            <div class="more-menu-item-desc">Profile, appearance, data</div>
                        </div>
                    </button>
                </div>

                <!-- Kitchen Sub-View -->
                <div class="hidden" id="more-kitchen">
                    <button class="btn btn-ghost mb-16" onclick="showMoreMenu()">‚Üê Back</button>
                    <h2 class="section-title">üç≥ Kitchen</h2>
                    <div class="tabs">
                        <button class="tab active" onclick="switchKitchenTab('pantry')">Pantry</button>
                        <button class="tab" onclick="switchKitchenTab('shopping')">Shopping</button>
                        <button class="tab" onclick="switchKitchenTab('batch')">Batch Prep</button>
                        <button class="tab" onclick="switchKitchenTab('subs')">Substitutions</button>
                    </div>
                    <div class="tab-content active" id="kitchen-pantry">
                        <div class="flex flex-between flex-center mb-16">
                            <span class="text-muted">Track your ingredients</span>
                            <button class="btn btn-sm btn-primary" onclick="openAddPantryModal()">+ Add</button>
                        </div>
                        <div id="pantry-list"></div>
                        <div class="empty-state" id="pantry-empty">
                            <div class="empty-state-icon">ü•´</div>
                            <div class="empty-state-title">Pantry is empty</div>
                            <p>Add items to track your inventory.</p>
                        </div>
                        <button class="btn btn-secondary mt-16 btn-block" onclick="askNonnaWithPantry()">üç≥ What can I make?</button>
                    </div>
                    <div class="tab-content" id="kitchen-shopping">
                        <div class="flex flex-between flex-center mb-16">
                            <select class="form-select" id="shopping-list-select" style="max-width: 200px;" onchange="loadShoppingList()">
                                <option value="weekly">Weekly Groceries</option>
                            </select>
                            <button class="btn btn-sm btn-primary" onclick="openAddShoppingModal()">+ Add</button>
                        </div>
                        <div id="shopping-list"></div>
                        <div class="empty-state" id="shopping-empty">
                            <div class="empty-state-icon">üõí</div>
                            <div class="empty-state-title">List is empty</div>
                            <p>Add items or generate from meal plan.</p>
                        </div>
                        <div class="flex gap-8 mt-16">
                            <button class="btn btn-secondary" onclick="printShoppingList()" style="flex: 1;">üñ®Ô∏è Print</button>
                            <button class="btn btn-secondary" onclick="clearCheckedItems()" style="flex: 1;">Clear Done</button>
                        </div>
                    </div>
                    <div class="tab-content" id="kitchen-batch">
                        <div class="card">
                            <h3 class="card-title">Plan Batch Cooking</h3>
                            <div class="form-group">
                                <label>What to prep?</label>
                                <div class="grid grid-2">
                                    <label class="checkbox-item"><input type="checkbox" name="batchItems" value="chicken"> Chicken</label>
                                    <label class="checkbox-item"><input type="checkbox" name="batchItems" value="fish"> Fish</label>
                                    <label class="checkbox-item"><input type="checkbox" name="batchItems" value="grains"> Grains</label>
                                    <label class="checkbox-item"><input type="checkbox" name="batchItems" value="vegetables"> Veggies</label>
                                    <label class="checkbox-item"><input type="checkbox" name="batchItems" value="sauce"> Sauces</label>
                                    <label class="checkbox-item"><input type="checkbox" name="batchItems" value="soup"> Soup</label>
                                </div>
                            </div>
                            <div class="form-group">
                                <label>Time available</label>
                                <select class="form-select" id="batch-time">
                                    <option value="1">1 hour</option>
                                    <option value="2" selected>2 hours</option>
                                    <option value="3">3+ hours</option>
                                </select>
                            </div>
                            <button class="btn btn-primary btn-block" onclick="generateBatchPlan()">Generate Plan</button>
                        </div>
                        <div id="batch-plan-output"></div>
                    </div>
                    <div class="tab-content" id="kitchen-subs">
                        <div class="form-group">
                            <input type="text" class="form-input" id="subs-search" placeholder="I'm out of..." oninput="searchSubstitutions()">
                        </div>
                        <div id="subs-results"></div>
                        <div id="subs-categories">
                            <div class="accordion-item">
                                <div class="accordion-header" onclick="toggleAccordion(this)">
                                    <span>üßÄ Dairy</span><span class="accordion-icon">‚ñº</span>
                                </div>
                                <div class="accordion-body">
                                    <p><strong>Greek Yogurt ‚Üí</strong> Labneh, sour cream</p>
                                    <p><strong>Feta ‚Üí</strong> Goat cheese, ricotta salata</p>
                                    <p><strong>Parmesan ‚Üí</strong> Pecorino, nutritional yeast</p>
                                </div>
                            </div>
                            <div class="accordion-item">
                                <div class="accordion-header" onclick="toggleAccordion(this)">
                                    <span>üåø Herbs</span><span class="accordion-icon">‚ñº</span>
                                </div>
                                <div class="accordion-body">
                                    <p><strong>Fresh herbs ‚Üí</strong> Dried at 1/3 amount</p>
                                    <p><strong>Basil ‚Üí</strong> Oregano, parsley</p>
                                    <p><strong>Dill ‚Üí</strong> Fennel fronds, tarragon</p>
                                </div>
                            </div>
                            <div class="accordion-item">
                                <div class="accordion-header" onclick="toggleAccordion(this)">
                                    <span>üçã Acids</span><span class="accordion-icon">‚ñº</span>
                                </div>
                                <div class="accordion-body">
                                    <p><strong>Lemon juice ‚Üí</strong> White wine vinegar + sugar</p>
                                    <p><strong>Red wine vinegar ‚Üí</strong> Balsamic, sherry vinegar</p>
                                    <p><strong>White wine ‚Üí</strong> Broth + vinegar splash</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Garden Sub-View -->
                <div class="hidden" id="more-garden">
                    <button class="btn btn-ghost mb-16" onclick="showMoreMenu()">‚Üê Back</button>
                    <h2 class="section-title">üå± Garden</h2>
                    <div class="tabs">
                        <button class="tab active" onclick="switchGardenTab('inventory')">My Garden</button>
                        <button class="tab" onclick="switchGardenTab('planting')">Planting</button>
                        <button class="tab" onclick="switchGardenTab('harvest')">Harvest</button>
                    </div>
                    <div class="tab-content active" id="garden-inventory">
                        <div class="flex flex-between flex-center mb-16">
                            <span class="text-muted">What's growing</span>
                            <button class="btn btn-sm btn-primary" onclick="openAddPlantModal()">+ Add</button>
                        </div>
                        <div id="garden-plants"></div>
                        <button class="btn btn-secondary mt-16 btn-block" onclick="askNonnaWithGarden()">üçÖ Recipes with my harvest</button>
                    </div>
                    <div class="tab-content" id="garden-planting">
                        <div class="card">
                            <h3 class="card-title">üå± Plant Now</h3>
                            <p class="text-muted mb-16">Recommendations for your zone</p>
                            <div id="planting-suggestions"></div>
                        </div>
                    </div>
                    <div class="tab-content" id="garden-harvest">
                        <div class="flex flex-between flex-center mb-16">
                            <span class="text-muted">Harvest log</span>
                            <button class="btn btn-sm btn-primary" onclick="openLogHarvestModal()">+ Log</button>
                        </div>
                        <div id="harvest-log"></div>
                    </div>
                </div>

                <!-- Crohn's Care Sub-View -->
                <div class="hidden" id="more-crohns">
                    <button class="btn btn-ghost mb-16" onclick="showMoreMenu()">‚Üê Back</button>
                    <h2 class="section-title">ü©∫ Crohn's Care</h2>
                    <button class="btn btn-primary btn-block" style="padding: 20px; font-size: 1.1rem; margin-bottom: 20px;" onclick="activateFlareMode()">
                        üòî I'm Having a Flare - Help Me
                    </button>
                    <div class="flare-banner hidden" id="flare-mode-banner">
                        <div class="flare-banner-title">üå°Ô∏è Flare Mode Active</div>
                        <div class="flare-banner-text">Nonna will only suggest gentle meals.</div>
                        <button class="btn btn-sm btn-ghost mt-8" onclick="deactivateFlareMode()">Exit Flare Mode</button>
                    </div>
                    <div class="card">
                        <h3 class="card-title">üíö Gentle Meal Ideas</h3>
                        <div class="quick-actions">
                            <button class="quick-action" onclick="askNonna('Give me a gentle soup recipe for a flare day')">Soothing Soup</button>
                            <button class="quick-action" onclick="askNonna('Easy-to-digest dinner')">Easy Dinner</button>
                            <button class="quick-action" onclick="askNonna('Simple breakfast for low energy')">Simple Breakfast</button>
                        </div>
                    </div>
                    <div class="card">
                        <h3 class="card-title">üö´ Avoid During Flare</h3>
                        <ul style="padding-left: 20px; color: var(--gray-text); font-size: 0.9rem;">
                            <li>Raw vegetables</li>
                            <li>High-fiber foods</li>
                            <li>Spicy foods</li>
                            <li>Dairy (if intolerant)</li>
                            <li>Nuts and seeds</li>
                            <li>Fried foods</li>
                        </ul>
                    </div>
                </div>

                <!-- History Sub-View -->
                <div class="hidden" id="more-history">
                    <button class="btn btn-ghost mb-16" onclick="showMoreMenu()">‚Üê Back</button>
                    <h2 class="section-title">üìñ Meal History</h2>
                    <div class="card">
                        <h3 class="card-title">üìä Stats</h3>
                        <div class="grid grid-2">
                            <div><strong>This Week:</strong> <span id="stat-week">0</span> meals</div>
                            <div><strong>This Month:</strong> <span id="stat-month">0</span> meals</div>
                        </div>
                    </div>
                    <div class="flex flex-between flex-center mb-16 mt-16">
                        <span class="text-muted">Recent meals</span>
                        <button class="btn btn-sm btn-secondary" onclick="openAddMealModal()">+ Add</button>
                    </div>
                    <div id="history-list"></div>
                    <div class="empty-state" id="history-empty">
                        <div class="empty-state-icon">üìñ</div>
                        <div class="empty-state-title">No meals logged</div>
                        <p>Mark recipes as cooked to track history.</p>
                    </div>
                </div>

                <!-- Settings Sub-View -->
                <div class="hidden" id="more-settings">
                    <button class="btn btn-ghost mb-16" onclick="showMoreMenu()">‚Üê Back</button>
                    <h2 class="section-title">‚öôÔ∏è Settings</h2>
                    <div class="card">
                        <h3 class="card-title">üé® Appearance</h3>
                        <label class="toggle">
                            <input type="checkbox" id="dark-mode-toggle" onchange="toggleDarkMode()">
                            <span class="toggle-switch"></span>
                            <span>üåô Dark Mode</span>
                        </label>
                    </div>
                    <div class="card">
                        <h3 class="card-title">üë§ Profile</h3>
                        <button class="btn btn-secondary btn-block" onclick="editProfile()">Edit Health Profile</button>
                    </div>
                    <div class="card">
                        <h3 class="card-title">üéì Help</h3>
                        <button class="btn btn-secondary btn-block mb-8" onclick="startOnboarding()">Take App Tour</button>
                    </div>
                    <div class="card">
                        <h3 class="card-title">üíæ Data</h3>
                        <div class="flex gap-8" style="flex-wrap: wrap;">
                            <button class="btn btn-secondary btn-sm" onclick="exportAllData()">Export</button>
                            <button class="btn btn-secondary btn-sm" onclick="importData()">Import</button>
                            <button class="btn btn-sm" style="background: var(--danger); color: white;" onclick="confirmClearAllData()">Clear All</button>
                        </div>
                    </div>
                    <div class="card">
                        <h3 class="card-title">‚ÑπÔ∏è About</h3>
                        <p class="text-muted">Tavola v3.0</p>
                        <p class="text-muted" style="font-size: 0.85rem;">Made with ‚ù§Ô∏è for chronic illness warriors</p>
                    </div>
                </div>
            </div>

            <!-- FAVORITES View -->
            <div class="view" id="view-favorites">
                <h2 class="section-title">‚ù§Ô∏è Favorites</h2>
                <div class="flex flex-between flex-center mb-16">
                    <input type="text" class="form-input" id="favorites-search" placeholder="Search..." style="max-width: 200px;" oninput="filterFavorites()">
                    <select class="form-select" id="favorites-sort" style="max-width: 140px;" onchange="sortFavorites()">
                        <option value="recent">Recent</option>
                        <option value="rating">Rating</option>
                        <option value="name">Name A-Z</option>
                    </select>
                </div>
                <div class="grid grid-2" id="favorites-grid"></div>
                <div class="empty-state" id="favorites-empty">
                    <div class="empty-state-icon">‚ù§Ô∏è</div>
                    <div class="empty-state-title">No favorites yet</div>
                    <p class="empty-state-text">Browse your recipe library or ask Nonna for suggestions, then tap ‚ù§Ô∏è to save favorites here!</p>
                    <button class="btn btn-primary" onclick="navigateTo('recipes')">üìö Browse Recipe Library</button>
                </div>
            </div>
        </div>
    </main>

    <!-- Bottom Navigation (5 tabs) -->
    <nav class="bottom-nav hidden" id="bottom-nav">
        <button class="nav-item active" onclick="navigateTo('home')" data-view="home">
            <span class="icon">üè†</span>
            <span>Home</span>
        </button>
        <button class="nav-item" onclick="navigateTo('week')" data-view="week">
            <span class="icon">üìÖ</span>
            <span>Week</span>
        </button>
        <button class="nav-item" onclick="navigateTo('recipes')" data-view="recipes">
            <span class="icon">üìö</span>
            <span>Recipes</span>
        </button>
        <button class="nav-item" onclick="navigateTo('chat')" data-view="chat">
            <span class="icon">üí¨</span>
            <span>Chat</span>
        </button>
        <button class="nav-item" onclick="navigateTo('more')" data-view="more">
            <span class="icon">‚ãÆ</span>
            <span>More</span>
        </button>
    </nav>

    <!-- Modal Container -->
    <div class="modal-overlay" id="modal-overlay" onclick="closeModalOnOverlay(event)">
        <div class="modal" id="modal-content"></div>
    </div>

    <!-- Toast -->
    <div class="toast" id="toast"></div>

    <!-- Onboarding Overlay -->
    <div class="onboarding-overlay" id="onboarding-overlay">
        <div class="onboarding-card" id="onboarding-card"></div>
    </div>

    <!-- Cook Mode Overlay -->
    <div class="cook-mode-overlay" id="cook-mode-overlay">
        <div class="cook-mode-header">
            <span class="cook-mode-progress" id="cook-mode-progress">Step 1 of 5</span>
            <button class="cook-mode-close" onclick="exitCookMode()">‚úï Exit</button>
        </div>
        <div class="cook-mode-body" id="cook-mode-body"></div>
        <div class="cook-mode-footer">
            <button class="btn btn-secondary" id="cook-prev-btn" onclick="cookModePrev()">‚Üê Previous</button>
            <button class="btn btn-primary" id="cook-next-btn" onclick="cookModeNext()">Next ‚Üí</button>
        </div>
    </div>

<!-- HTML STRUCTURE COMPLETE - JavaScript follows -->
<script>
// ========================================
// STORAGE KEYS
// ========================================
const STORAGE = {
    PROFILE: 'tavola_profile',
    CHAT: 'tavola_chat_history',
    FAVORITES: 'tavola_favorites',
    RECIPES: 'tavola_recipe_library',
    PANTRY: 'tavola_pantry',
    SHOPPING: 'tavola_shopping_lists',
    MEAL_PLANS: 'tavola_meal_plans',
    GARDEN: 'tavola_garden',
    HISTORY: 'tavola_meal_history',
    PREFS: 'tavola_preferences',
    ONBOARDING: 'tavola_onboarding_done'
};

// ========================================
// APP STATE
// ========================================
let state = {
    currentView: 'home',
    currentWeekOffset: 0,
    chatHistory: [],
    isProcessing: false,
    isRecording: false,
    flareMode: false,
    recognition: null,
    cookMode: { active: false, recipe: null, currentStep: 0 }
};

// Nonna's Tips
const NONNA_TIPS = [
    "Always finish with good olive oil - it makes everything taste better, cara.",
    "Cook with love, and the food will love you back.",
    "A little lemon brightens everything - just like a smile!",
    "Rest is an ingredient too. Take breaks when you need them.",
    "Fresh herbs are medicine for the soul and the body.",
    "Simple food, made well, is the best food of all.",
    "Batch cooking on good days saves you on hard days.",
    "The Mediterranean way is not a diet - it's a way of life.",
    "Olive oil, garlic, lemon - the holy trinity of healing.",
    "Gentle on the stomach, generous with flavor."
];

// ========================================
// INITIALIZATION
// ========================================
document.addEventListener('DOMContentLoaded', () => {
    initApp();
});

function initApp() {
    const profile = getStorage(STORAGE.PROFILE);
    if (profile) {
        showApp();
        loadChatHistory();
        if (state.chatHistory.length === 0) {
            addWelcomeMessage();
        }
        checkOnboarding();
    } else {
        showWelcome();
    }
    initVoiceRecognition();
    initChatInput();
    loadPreferences();
    setDailyTip();
}

function checkOnboarding() {
    const done = getStorage(STORAGE.ONBOARDING);
    if (!done) {
        setTimeout(() => startOnboarding(), 500);
    }
}

// ========================================
// STORAGE HELPERS
// ========================================
function getStorage(key) {
    try {
        const data = localStorage.getItem(key);
        return data ? JSON.parse(data) : null;
    } catch (e) {
        console.error('Storage read error:', e);
        return null;
    }
}

function setStorage(key, value) {
    try {
        localStorage.setItem(key, JSON.stringify(value));
        return true;
    } catch (e) {
        console.error('Storage write error:', e);
        return false;
    }
}

// ========================================
// VIEW MANAGEMENT
// ========================================
function showWelcome() {
    document.getElementById('welcome-screen').style.display = 'flex';
    document.getElementById('intake-form').classList.remove('active');
    document.getElementById('app-main').classList.remove('active');
    document.getElementById('app-header').classList.add('hidden');
    document.getElementById('bottom-nav').classList.add('hidden');
}

function showIntakeForm() {
    document.getElementById('welcome-screen').style.display = 'none';
    document.getElementById('intake-form').classList.add('active');
    document.getElementById('app-main').classList.remove('active');
}

function showApp() {
    document.getElementById('welcome-screen').style.display = 'none';
    document.getElementById('intake-form').classList.remove('active');
    document.getElementById('app-main').classList.add('active');
    document.getElementById('app-header').classList.remove('hidden');
    document.getElementById('bottom-nav').classList.remove('hidden');
    navigateTo('home');
}

function navigateTo(view) {
    state.currentView = view;

    // Update views
    document.querySelectorAll('#app-main > .container > .view').forEach(v => v.classList.remove('active'));
    const targetView = document.getElementById(`view-${view}`);
    if (targetView) targetView.classList.add('active');

    // Update bottom nav
    document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
    const navItem = document.querySelector(`.nav-item[data-view="${view}"]`);
    if (navItem) navItem.classList.add('active');

    // Show More menu if going to more
    if (view === 'more') showMoreMenu();

    // Load view-specific data
    if (view === 'home') updateDashboard();
    if (view === 'favorites') renderFavorites();
    if (view === 'week') renderWeekPlanner();
    if (view === 'recipes') renderRecipeLibrary();
}

function showMoreMenu() {
    document.getElementById('more-menu-main').classList.remove('hidden');
    document.getElementById('more-kitchen').classList.add('hidden');
    document.getElementById('more-garden').classList.add('hidden');
    document.getElementById('more-crohns').classList.add('hidden');
    document.getElementById('more-history').classList.add('hidden');
    document.getElementById('more-settings').classList.add('hidden');
}

function switchMoreTab(tab) {
    document.getElementById('more-menu-main').classList.add('hidden');
    document.querySelectorAll('[id^="more-"]').forEach(el => el.classList.add('hidden'));
    document.getElementById(`more-${tab}`).classList.remove('hidden');

    // Load data
    if (tab === 'kitchen') renderPantry();
    if (tab === 'garden') renderGarden();
    if (tab === 'history') renderHistory();
    if (tab === 'crohns') updateFlareUI();
}

// ========================================
// DASHBOARD
// ========================================
function updateDashboard() {
    const favorites = getStorage(STORAGE.FAVORITES) || [];
    const recipes = getStorage(STORAGE.RECIPES) || [];
    const mealPlans = getStorage(STORAGE.MEAL_PLANS) || {};
    const profile = getStorage(STORAGE.PROFILE);

    // Count planned meals this week
    const weekDates = getWeekDates(0);
    let plannedCount = 0;
    weekDates.forEach(d => {
        if (mealPlans[d]) plannedCount++;
    });

    document.getElementById('stat-meals-planned').textContent = `${plannedCount}/7`;
    document.getElementById('stat-favorites').textContent = favorites.length;
    document.getElementById('stat-recipes').textContent = recipes.length;

    // Garden stat
    if (profile && profile.currentlyGrowing) {
        const plants = profile.currentlyGrowing.split(',').filter(p => p.trim());
        document.getElementById('stat-garden').textContent = plants.length > 0 ? `${plants.length} plants` : '-';
    }

    // Recent activity
    updateRecentActivity();

    // Flare mode indicator
    const flareBanner = document.getElementById('home-flare-banner');
    if (state.flareMode) {
        flareBanner.classList.remove('hidden');
    } else {
        flareBanner.classList.add('hidden');
    }
}

function updateRecentActivity() {
    const history = getStorage(STORAGE.HISTORY) || [];
    const container = document.getElementById('recent-activity');

    if (history.length === 0) {
        container.innerHTML = '<div class="empty-state" style="padding: 24px;"><p class="text-muted">No recent activity. Start chatting with Nonna!</p></div>';
        return;
    }

    const recent = history.slice(0, 3);
    container.innerHTML = recent.map(item => `
        <div class="activity-item">
            <span class="activity-icon">${item.type === 'cooked' ? 'üçΩÔ∏è' : 'üí¨'}</span>
            <div class="activity-content">
                <div class="activity-title">${item.title}</div>
                <div class="activity-time">${formatRelativeDate(item.date)}</div>
            </div>
        </div>
    `).join('');
}

function setDailyTip() {
    const dayOfYear = Math.floor((new Date() - new Date(new Date().getFullYear(), 0, 0)) / 86400000);
    const tip = NONNA_TIPS[dayOfYear % NONNA_TIPS.length];
    document.getElementById('nonna-tip-text').textContent = `"${tip}"`;
}

// ========================================
// PROFILE MANAGEMENT
// ========================================
function toggleCookingForTwo() {
    const toggle = document.getElementById('cookingForTwoToggle');
    const fields = document.getElementById('cookingForTwoFields');
    fields.classList.toggle('hidden', !toggle.checked);
}

function saveProfile(e) {
    e.preventDefault();
    const form = e.target;

    const profile = {
        crohnsSeverity: form.crohnsSeverity.value,
        crohnsTriggers: form.crohnsTriggers.value,
        fibroEnergy: form.fibroEnergy.value,
        thyroidType: form.thyroidType.value,
        otherConditions: form.otherConditions.value,
        cookingForTwo: form.cookingForTwo.checked,
        partnerName: form.partnerName?.value || '',
        partnerRestrictions: Array.from(form.querySelectorAll('[name="partnerRestrictions"]:checked')).map(c => c.value),
        partnerAllergies: form.partnerAllergies?.value || '',
        partnerLoves: form.partnerLoves?.value || '',
        proteins: Array.from(form.querySelectorAll('[name="proteins"]:checked')).map(c => c.value),
        currentlyGrowing: form.currentlyGrowing.value,
        growingZone: form.growingZone.value,
        currentSeason: form.currentSeason.value,
        energyLevel: form.energyLevel.value,
        cookingTime: form.cookingTime.value,
        weeklyBudget: form.weeklyBudget.value,
        shoppingPriority: form.shoppingPriority.value,
        foodsToAvoid: form.foodsToAvoid.value,
        favoriteFlavors: form.favoriteFlavors.value,
        createdAt: new Date().toISOString()
    };

    setStorage(STORAGE.PROFILE, profile);
    showApp();
}

function editProfile() {
    const profile = getStorage(STORAGE.PROFILE);
    showIntakeForm();

    if (profile) {
        setTimeout(() => {
            const form = document.getElementById('profile-form');
            Object.keys(profile).forEach(key => {
                const el = form.querySelector(`[name="${key}"]`);
                if (el) {
                    if (el.type === 'checkbox') {
                        el.checked = profile[key];
                        if (key === 'cookingForTwo') toggleCookingForTwo();
                    } else {
                        el.value = profile[key];
                    }
                }
            });
            if (profile.proteins) {
                profile.proteins.forEach(p => {
                    const cb = form.querySelector(`[name="proteins"][value="${p}"]`);
                    if (cb) cb.checked = true;
                });
            }
        }, 100);
    }
}

function loadPreferences() {
    const prefs = getStorage(STORAGE.PREFS) || {};
    if (prefs.darkMode) {
        document.body.classList.add('dark-mode');
        const toggle = document.getElementById('dark-mode-toggle');
        if (toggle) toggle.checked = true;
    }
    state.flareMode = prefs.flareMode || false;
}

function toggleDarkMode() {
    const toggle = document.getElementById('dark-mode-toggle');
    document.body.classList.toggle('dark-mode', toggle.checked);
    const prefs = getStorage(STORAGE.PREFS) || {};
    prefs.darkMode = toggle.checked;
    setStorage(STORAGE.PREFS, prefs);
}

// ========================================
// CHAT FUNCTIONALITY
// ========================================
function initChatInput() {
    const input = document.getElementById('chat-input');
    if (!input) return;
    input.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            sendMessage();
        }
    });
    input.addEventListener('input', () => {
        input.style.height = 'auto';
        input.style.height = Math.min(input.scrollHeight, 120) + 'px';
    });
}

function loadChatHistory() {
    state.chatHistory = getStorage(STORAGE.CHAT) || [];
    renderChatHistory();
}

function saveChatHistory() {
    setStorage(STORAGE.CHAT, state.chatHistory);
}

function addWelcomeMessage() {
    const profile = getStorage(STORAGE.PROFILE);
    let text = "Ciao, cara! I'm Nonna, your Mediterranean cooking companion. ";
    if (profile) {
        text += "I've looked at your profile and I'm ready to help you plan delicious, gentle meals. ";
    }
    text += "What would you like to cook today?";

    const msg = { role: 'assistant', content: text, timestamp: new Date().toISOString() };
    state.chatHistory.push(msg);
    saveChatHistory();
    renderMessage(msg, true);
    renderQuickActions();
}

function renderChatHistory() {
    const container = document.getElementById('chat-messages');
    if (!container) return;
    container.innerHTML = '';
    state.chatHistory.forEach(msg => renderMessage(msg, false));
    if (state.chatHistory.length <= 1) renderQuickActions();
}

function renderMessage(message, animate = true) {
    const container = document.getElementById('chat-messages');
    if (!container) return;

    const div = document.createElement('div');
    div.className = `message message-${message.role}`;
    if (!animate) div.style.animation = 'none';

    const bubble = document.createElement('div');
    bubble.className = 'message-bubble';

    // Check for recipe or weekly plan
    if (message.role === 'assistant') {
        if (message.content.includes('=== RECIPE:') || message.content.includes('RECIPE:')) {
            bubble.innerHTML = parseRecipeToCard(message.content);
        } else if (message.content.includes('Your Week is Planned') || message.content.includes('WEEKLY MEAL PLAN')) {
            bubble.innerHTML = parseWeekPlanToCard(message.content);
        } else {
            bubble.innerHTML = formatMessageContent(message.content);
        }
    } else {
        bubble.innerHTML = formatMessageContent(message.content);
    }

    div.appendChild(bubble);
    container.appendChild(div);
    scrollToBottom();
}

function formatMessageContent(content) {
    return content
        .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
        .replace(/^### (.*$)/gm, '<h3 style="color: var(--cerulean); margin: 12px 0 8px;">$1</h3>')
        .replace(/^## (.*$)/gm, '<h2 style="color: var(--cerulean); margin: 16px 0 8px;">$1</h2>')
        .replace(/^- (.*$)/gm, '<li>$1</li>')
        .replace(/^(\d+)\. (.*$)/gm, '<li>$2</li>')
        .replace(/‚òê (.*$)/gm, '<span style="display: block;">‚òê $1</span>')
        .replace(/\n\n/g, '</p><p>')
        .replace(/\n/g, '<br>');
}

function parseRecipeToCard(content) {
    // Extract recipe components
    const titleMatch = content.match(/(?:===\s*)?RECIPE:\s*(.+?)(?:\s*===|\n|$)/i);
    const servesMatch = content.match(/Serves:\s*(\d+)/i);
    const timeMatch = content.match(/Total(?:\s*Time)?:\s*(\d+)\s*min/i);
    const prepMatch = content.match(/Prep:\s*(\d+)\s*min/i);
    const cookMatch = content.match(/Cook:\s*(\d+)\s*min/i);

    // Extract ingredients
    const ingredientsMatch = content.match(/\*?\*?INGREDIENTS\*?\*?:?([\s\S]*?)(?=\*?\*?INSTRUCTIONS|$)/i);
    const ingredients = ingredientsMatch ?
        ingredientsMatch[1].trim().split('\n').filter(l => l.trim().startsWith('-')).map(l => l.replace(/^-\s*/, '').trim()) : [];

    // Extract instructions
    const instructionsMatch = content.match(/\*?\*?INSTRUCTIONS\*?\*?:?([\s\S]*?)(?=\*?\*?FLARE|GARDEN|STORAGE|CROHN|NUTRITIONAL|---|$)/i);
    const instructions = instructionsMatch ?
        instructionsMatch[1].trim().split('\n').filter(l => /^\d+\./.test(l.trim())).map(l => l.replace(/^\d+\.\s*/, '').trim()) : [];

    // Extract flare mods
    const flareMatch = content.match(/\*?\*?FLARE\s*MODIFICATIONS?\*?\*?:?([\s\S]*?)(?=\*?\*?GARDEN|STORAGE|---|$)/i);
    const flareMods = flareMatch ? flareMatch[1].trim() : '';

    const title = titleMatch ? titleMatch[1].trim().replace(/===\s*$/, '').trim() : 'Recipe';
    const serves = servesMatch ? servesMatch[1] : '2';
    const totalTime = timeMatch ? timeMatch[1] : '30';
    const prepTime = prepMatch ? prepMatch[1] : '10';
    const cookTime = cookMatch ? cookMatch[1] : '20';

    // Generate unique ID and save to library
    const recipeId = 'recipe_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);

    // Determine protein type
    const proteinTypes = { fish: /fish|cod|salmon|tilapia|shrimp/i, chicken: /chicken/i, pork: /pork/i, beef: /beef/i, vegetarian: /vegetarian|vegan|tofu/i };
    let proteinType = 'other';
    for (const [type, regex] of Object.entries(proteinTypes)) {
        if (regex.test(content)) { proteinType = type; break; }
    }

    // Auto-save to recipe library
    const recipeData = {
        id: recipeId,
        title: title,
        ingredients: ingredients,
        instructions: instructions,
        flareMods: flareMods,
        metadata: {
            prepTime: parseInt(prepTime),
            cookTime: parseInt(cookTime),
            totalTime: parseInt(totalTime),
            serves: parseInt(serves),
            proteinType: proteinType,
            tags: ['Mediterranean']
        },
        dateGenerated: new Date().toISOString(),
        timesCooked: 0,
        rating: 0,
        favorited: false,
        rawContent: content
    };
    saveRecipeToLibrary(recipeData);

    return `
        <div class="recipe-card" data-recipe-id="${recipeId}">
            <div class="recipe-header">
                <div class="recipe-title">${title}</div>
                <div class="recipe-actions">
                    <button class="recipe-action-btn ${recipeData.favorited ? 'favorited' : ''}" onclick="toggleFavoriteFromCard('${recipeId}', this)" title="Favorite">‚ù§Ô∏è</button>
                    <button class="recipe-action-btn" onclick="printRecipe('${recipeId}')" title="Print">üñ®Ô∏è</button>
                </div>
                <div class="recipe-meta">
                    <div class="recipe-meta-item">‚è±Ô∏è ${totalTime} min</div>
                    <div class="recipe-meta-item">üçΩÔ∏è Serves ${serves}</div>
                </div>
            </div>
            <div class="recipe-tags">
                <span class="tag tag-mediterranean">Mediterranean</span>
                ${parseInt(totalTime) <= 30 ? '<span class="tag tag-quick">Quick</span>' : ''}
            </div>
            <div class="recipe-body">
                <div class="recipe-section">
                    <div class="recipe-section-title">üìù Ingredients</div>
                    ${ingredients.map((ing, i) => `
                        <div class="ingredient-item">
                            <input type="checkbox" class="ingredient-checkbox" id="ing_${recipeId}_${i}" onchange="toggleIngredient(this)">
                            <label class="ingredient-text" for="ing_${recipeId}_${i}">${ing}</label>
                        </div>
                    `).join('')}
                </div>
                <div class="recipe-section">
                    <div class="recipe-section-title">üë©‚Äçüç≥ Instructions</div>
                    ${instructions.map((step, i) => `
                        <div class="instruction-step">
                            <div class="step-number">${i + 1}</div>
                            <div>${step}</div>
                        </div>
                    `).join('')}
                </div>
                ${flareMods ? `
                    <div class="recipe-notes">
                        <div class="recipe-notes-title">ü©∫ Flare Modifications</div>
                        <p>${flareMods.replace(/\n/g, '<br>').replace(/^-\s*/gm, '‚Ä¢ ')}</p>
                    </div>
                ` : ''}
            </div>
            <div class="recipe-card-actions">
                <button class="btn btn-secondary btn-sm" onclick="toggleFavoriteFromCard('${recipeId}', null)">‚ù§Ô∏è Favorite</button>
                <button class="btn btn-secondary btn-sm" onclick="openAddToWeekModal('${recipeId}')">üìÖ Add to Week</button>
                <button class="btn btn-sm btn-ghost" onclick="openRecipeMoreMenu('${recipeId}')">‚ãÆ</button>
            </div>
        </div>
    `;
}

function parseWeekPlanToCard(content) {
    // Extract days and meals from the content
    const days = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'];
    const mealPlan = {};

    days.forEach(day => {
        const regex = new RegExp(`\\*?\\*?${day}\\*?\\*?[:\\s]*([^\\n]+)`, 'i');
        const match = content.match(regex);
        if (match) {
            mealPlan[day.toLowerCase()] = match[1].replace(/^[-:*\s]+/, '').trim();
        }
    });

    // Save to meal plans
    const weekDates = getWeekDates(state.currentWeekOffset);
    const savedPlans = getStorage(STORAGE.MEAL_PLANS) || {};

    days.forEach((day, i) => {
        const dateStr = weekDates[i];
        const meal = mealPlan[day.toLowerCase()];
        if (meal && meal.length > 0) {
            savedPlans[dateStr] = {
                title: meal,
                recipeId: null,
                status: 'planned'
            };
        }
    });
    setStorage(STORAGE.MEAL_PLANS, savedPlans);

    return `
        <div class="week-plan-card">
            <h3>‚úÖ Your Week is Planned!</h3>
            ${days.map(day => {
                const meal = mealPlan[day.toLowerCase()];
                return meal ? `<div class="week-plan-item"><span>${day}</span><span>${meal}</span></div>` : '';
            }).join('')}
            <div class="week-plan-actions">
                <button class="btn" onclick="navigateTo('week')">üìÖ View This Week</button>
                <button class="btn" onclick="generateWeekShoppingList()">üõí Shopping List</button>
            </div>
        </div>
    `;
}

function toggleIngredient(checkbox) {
    const label = checkbox.nextElementSibling;
    label.classList.toggle('checked', checkbox.checked);
}

function renderQuickActions() {
    const container = document.getElementById('chat-messages');
    if (!container) return;

    const existing = container.querySelector('.quick-actions');
    if (existing) existing.remove();

    const actions = document.createElement('div');
    actions.className = 'quick-actions';
    actions.innerHTML = `
        <button class="quick-action" onclick="askNonna('Plan my meals for this week')">üóìÔ∏è Plan My Week</button>
        <button class="quick-action" onclick="askNonna('What can I make with what\\'s in my garden?')">üå± Use My Garden</button>
        <button class="quick-action" onclick="askNonna('Give me a quick, easy dinner idea')">‚ö° Quick Dinner</button>
        <button class="quick-action" onclick="askNonna('I need a gentle meal - not feeling great')">ü©∫ Gentle Meal</button>
    `;
    container.appendChild(actions);
    scrollToBottom();
}

function scrollToBottom() {
    const container = document.getElementById('chat-messages');
    if (container) setTimeout(() => container.scrollTop = container.scrollHeight, 50);
}

function showThinking() {
    const container = document.getElementById('chat-messages');
    if (!container) return;

    const animations = ['ü•ò', 'ü´í', 'üçã', 'üåø', 'üìñ'];
    const texts = ['Nonna is cooking up ideas...', 'Drizzling olive oil on thoughts...', 'Squeezing fresh inspiration...', 'Chopping fresh ideas...', 'Flipping through recipes...'];
    const idx = Math.floor(Math.random() * animations.length);

    const div = document.createElement('div');
    div.className = 'message message-assistant';
    div.id = 'thinking-message';
    div.innerHTML = `
        <div class="thinking">
            <div class="thinking-animation">${animations[idx]}</div>
            <span class="thinking-text">${texts[idx]}</span>
        </div>
    `;
    container.appendChild(div);
    scrollToBottom();
}

function hideThinking() {
    const el = document.getElementById('thinking-message');
    if (el) el.remove();
}

async function sendMessage() {
    if (state.isProcessing) return;

    const input = document.getElementById('chat-input');
    const message = input.value.trim();
    if (!message) return;

    input.value = '';
    input.style.height = 'auto';

    // Remove quick actions
    document.querySelectorAll('.quick-actions').forEach(el => el.remove());

    // Add user message
    const userMsg = { role: 'user', content: message, timestamp: new Date().toISOString() };
    state.chatHistory.push(userMsg);
    saveChatHistory();
    renderMessage(userMsg);

    // Call API
    state.isProcessing = true;
    document.getElementById('send-btn').disabled = true;
    showThinking();

    try {
        const response = await callAPI(message);
        hideThinking();

        const assistantMsg = { role: 'assistant', content: response, timestamp: new Date().toISOString() };
        state.chatHistory.push(assistantMsg);
        saveChatHistory();
        renderMessage(assistantMsg);

        // Add to activity
        addActivity('chat', `Chat: ${message.substring(0, 30)}...`);
    } catch (error) {
        hideThinking();
        const errorMsg = { role: 'assistant', content: `Mi dispiace, I had trouble: ${error.message}. Let's try again, cara.`, timestamp: new Date().toISOString() };
        state.chatHistory.push(errorMsg);
        saveChatHistory();
        renderMessage(errorMsg);
    }

    state.isProcessing = false;
    document.getElementById('send-btn').disabled = false;
}

function askNonna(text) {
    navigateTo('chat');
    document.getElementById('chat-input').value = text;
    setTimeout(() => sendMessage(), 100);
}

async function callAPI(userMessage) {
    const profile = getStorage(STORAGE.PROFILE);
    const profileText = formatProfileForAPI(profile);
    const history = getStorage(STORAGE.HISTORY) || [];
    const recentMeals = history.slice(0, 5).map(h => `${h.title} (${formatRelativeDate(h.date)})`).join(', ');

    const messages = state.chatHistory.slice(-10).map(m => ({
        role: m.role,
        content: m.content
    }));

    if (!messages.length || messages[messages.length - 1].content !== userMessage) {
        messages.push({ role: 'user', content: userMessage });
    }

    const response = await fetch('/.netlify/functions/chat', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ messages, profileText, flareMode: state.flareMode, recentMeals })
    });

    if (!response.ok) {
        const err = await response.json().catch(() => ({}));
        throw new Error(err.error || `API error: ${response.status}`);
    }

    const data = await response.json();
    return data.content;
}

function formatProfileForAPI(profile) {
    if (!profile) return 'No profile configured.';

    let text = `
HEALTH PROFILE:
- Crohn's: ${profile.crohnsSeverity || 'Not specified'} severity
- Triggers: ${profile.crohnsTriggers || 'None specified'}
- Fibromyalgia Energy: ${profile.fibroEnergy || 'Not specified'}
- Thyroid: ${profile.thyroidType || 'Not specified'}
- Other: ${profile.otherConditions || 'None'}

PROTEINS: ${profile.proteins?.join(', ') || 'Not specified'}

GARDEN: ${profile.currentlyGrowing || 'Nothing specified'}
Zone: ${profile.growingZone || 'Not specified'}, Season: ${profile.currentSeason}

COOKING: Energy ${profile.energyLevel}, Time preference ${profile.cookingTime}
BUDGET: $${profile.weeklyBudget}, Priority: ${profile.shoppingPriority}
AVOID: ${profile.foodsToAvoid || 'None'}
LOVES: ${profile.favoriteFlavors || 'Not specified'}`;

    if (profile.cookingForTwo) {
        text += `

COOKING FOR TWO:
Partner: ${profile.partnerName || 'Partner'}
Restrictions: ${profile.partnerRestrictions?.join(', ') || 'None'}
Allergies: ${profile.partnerAllergies || 'None'}
Loves: ${profile.partnerLoves || 'Not specified'}`;
    }

    return text.trim();
}

// ========================================
// VOICE INPUT
// ========================================
function initVoiceRecognition() {
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    if (SpeechRecognition) {
        state.recognition = new SpeechRecognition();
        state.recognition.continuous = false;
        state.recognition.interimResults = false;
        state.recognition.lang = 'en-US';

        state.recognition.onresult = (event) => {
            const text = event.results[0][0].transcript;
            document.getElementById('chat-input').value = text;
            stopRecording();
        };
        state.recognition.onerror = () => stopRecording();
        state.recognition.onend = () => stopRecording();
    } else {
        const btn = document.getElementById('voice-btn');
        if (btn) btn.style.display = 'none';
    }
}

function toggleVoiceInput() {
    if (state.isRecording) stopRecording();
    else startRecording();
}

function startRecording() {
    if (!state.recognition) return;
    state.isRecording = true;
    document.getElementById('voice-btn').classList.add('recording');
    state.recognition.start();
}

function stopRecording() {
    state.isRecording = false;
    const btn = document.getElementById('voice-btn');
    if (btn) btn.classList.remove('recording');
    if (state.recognition) {
        try { state.recognition.stop(); } catch (e) {}
    }
}

// ========================================
// RECIPE LIBRARY
// ========================================
function saveRecipeToLibrary(recipe) {
    const library = getStorage(STORAGE.RECIPES) || [];
    const existing = library.findIndex(r => r.id === recipe.id);
    if (existing >= 0) {
        library[existing] = { ...library[existing], ...recipe };
    } else {
        library.unshift(recipe);
    }
    setStorage(STORAGE.RECIPES, library);
}

function getRecipeLibrary() {
    return getStorage(STORAGE.RECIPES) || [];
}

function renderRecipeLibrary() {
    const library = getRecipeLibrary();
    const grid = document.getElementById('recipes-grid');
    const empty = document.getElementById('recipes-empty');

    if (library.length === 0) {
        grid.innerHTML = '';
        empty.classList.remove('hidden');
        return;
    }

    empty.classList.add('hidden');
    grid.innerHTML = library.map(recipe => renderLibraryCard(recipe)).join('');
}

function renderLibraryCard(recipe) {
    const meta = recipe.metadata || {};
    return `
        <div class="library-card" onclick="viewRecipeDetail('${recipe.id}')">
            <div class="library-card-banner">
                üçΩÔ∏è
                ${recipe.favorited ? '<span class="library-card-favorite">‚ù§Ô∏è</span>' : ''}
            </div>
            <div class="library-card-body">
                <div class="library-card-title">${recipe.title}</div>
                <div class="library-card-meta">
                    <span>‚è±Ô∏è ${meta.totalTime || 30}min</span>
                    <span>üçΩÔ∏è ${meta.serves || 2}</span>
                </div>
                <div class="library-card-tags">
                    ${(meta.tags || []).slice(0, 2).map(t => `<span class="tag">${t}</span>`).join('')}
                </div>
                ${recipe.rating ? `<div class="library-card-rating">${'‚≠ê'.repeat(recipe.rating)}</div>` : ''}
            </div>
        </div>
    `;
}

function filterRecipeLibrary() {
    const search = document.getElementById('recipes-search').value.toLowerCase();
    const sort = document.getElementById('recipes-sort').value;
    const protein = document.getElementById('recipes-protein').value;
    const time = document.getElementById('recipes-time').value;

    let library = getRecipeLibrary();

    // Filter by search
    if (search) {
        library = library.filter(r => r.title.toLowerCase().includes(search) ||
            r.ingredients?.some(i => i.toLowerCase().includes(search)));
    }

    // Filter by protein
    if (protein) {
        library = library.filter(r => r.metadata?.proteinType === protein);
    }

    // Filter by time
    if (time) {
        library = library.filter(r => {
            const t = r.metadata?.totalTime || 30;
            if (time === 'quick') return t < 30;
            if (time === 'standard') return t >= 30 && t <= 60;
            if (time === 'long') return t > 60;
            return true;
        });
    }

    // Sort
    if (sort === 'rating') library.sort((a, b) => (b.rating || 0) - (a.rating || 0));
    else if (sort === 'time') library.sort((a, b) => (a.metadata?.totalTime || 30) - (b.metadata?.totalTime || 30));
    else if (sort === 'name') library.sort((a, b) => a.title.localeCompare(b.title));
    else library.sort((a, b) => new Date(b.dateGenerated) - new Date(a.dateGenerated));

    const grid = document.getElementById('recipes-grid');
    grid.innerHTML = library.map(recipe => renderLibraryCard(recipe)).join('');

    const empty = document.getElementById('recipes-empty');
    empty.classList.toggle('hidden', library.length > 0);
}

function toggleFilterDropdown() {
    document.getElementById('recipe-filters').classList.toggle('open');
}

function viewRecipeDetail(recipeId) {
    const library = getRecipeLibrary();
    const recipe = library.find(r => r.id === recipeId);
    if (!recipe) return;

    openModal(`
        <div class="modal-header">
            <h2 class="modal-title">${recipe.title}</h2>
            <button class="modal-close" onclick="closeModal()">√ó</button>
        </div>
        <div class="modal-body" style="padding: 0;">
            ${recipe.rawContent ? parseRecipeToCard(recipe.rawContent) : `
                <div class="recipe-card">
                    <div class="recipe-header">
                        <div class="recipe-title">${recipe.title}</div>
                    </div>
                    <div class="recipe-body">
                        <p>Recipe details not available.</p>
                    </div>
                </div>
            `}
        </div>
    `);
}

// ========================================
// FAVORITES
// ========================================
function getFavorites() {
    const library = getRecipeLibrary();
    return library.filter(r => r.favorited);
}

function toggleFavoriteFromCard(recipeId, btn) {
    const library = getRecipeLibrary();
    const recipe = library.find(r => r.id === recipeId);
    if (!recipe) return;

    recipe.favorited = !recipe.favorited;
    setStorage(STORAGE.RECIPES, library);

    if (btn) btn.classList.toggle('favorited', recipe.favorited);

    showToast(recipe.favorited ? '‚ù§Ô∏è Added to favorites!' : 'Removed from favorites');
}

function renderFavorites() {
    const favorites = getFavorites();
    const grid = document.getElementById('favorites-grid');
    const empty = document.getElementById('favorites-empty');

    if (favorites.length === 0) {
        grid.innerHTML = '';
        empty.classList.remove('hidden');
        return;
    }

    empty.classList.add('hidden');
    grid.innerHTML = favorites.map(recipe => renderLibraryCard(recipe)).join('');
}

function filterFavorites() {
    const search = document.getElementById('favorites-search').value.toLowerCase();
    let favorites = getFavorites();
    if (search) {
        favorites = favorites.filter(f => f.title.toLowerCase().includes(search));
    }
    const grid = document.getElementById('favorites-grid');
    grid.innerHTML = favorites.map(recipe => renderLibraryCard(recipe)).join('');
}

function sortFavorites() {
    renderFavorites();
}

// ========================================
// WEEK PLANNER - DATE BUG FIX
// ========================================
function getWeekDates(offset = 0) {
    const dates = [];
    const today = new Date();

    // Get Monday of current week - FIX: Use local date properly
    const dayOfWeek = today.getDay();
    const mondayOffset = dayOfWeek === 0 ? -6 : 1 - dayOfWeek; // Sunday is 0

    const monday = new Date(today);
    monday.setDate(today.getDate() + mondayOffset + (offset * 7));

    for (let i = 0; i < 7; i++) {
        const date = new Date(monday);
        date.setDate(monday.getDate() + i);
        // FIX: Format date in local timezone, not UTC
        const year = date.getFullYear();
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const day = String(date.getDate()).padStart(2, '0');
        dates.push(`${year}-${month}-${day}`);
    }
    return dates;
}

function getWeekTitle(offset = 0) {
    const dates = getWeekDates(offset);
    const start = new Date(dates[0] + 'T12:00:00'); // Add noon to avoid timezone issues
    const end = new Date(dates[6] + 'T12:00:00');

    const options = { month: 'short', day: 'numeric' };
    const startStr = start.toLocaleDateString('en-US', options);
    const endStr = end.toLocaleDateString('en-US', { ...options, year: 'numeric' });

    if (offset === 0) return `This Week (${startStr} - ${endStr})`;
    if (offset === -1) return `Last Week (${startStr} - ${endStr})`;
    if (offset === 1) return `Next Week (${startStr} - ${endStr})`;
    return `${startStr} - ${endStr}`;
}

function changeWeek(direction) {
    state.currentWeekOffset += direction;
    renderWeekPlanner();
}

function renderWeekPlanner() {
    const container = document.getElementById('week-planner');
    const empty = document.getElementById('week-empty');
    const days = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'];
    const mealPlans = getStorage(STORAGE.MEAL_PLANS) || {};
    const weekDates = getWeekDates(state.currentWeekOffset);

    // Update title
    document.getElementById('week-title').textContent = getWeekTitle(state.currentWeekOffset);

    let hasAnyMeals = false;
    let html = '';

    days.forEach((day, i) => {
        const dateStr = weekDates[i];
        const dateObj = new Date(dateStr + 'T12:00:00'); // Add noon for timezone safety
        const meal = mealPlans[dateStr];

        if (meal) hasAnyMeals = true;

        const dateDisplay = dateObj.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });

        html += `
            <div class="week-day">
                <div class="week-day-header">
                    <span class="week-day-name">${day}</span>
                    <span class="week-day-date">${dateDisplay}</span>
                </div>
                ${meal ? `
                    <div class="week-day-meal">
                        <span style="font-size: 1.5rem;">üçΩÔ∏è</span>
                        <div class="week-day-meal-info">
                            <div class="week-day-meal-title">${meal.title}</div>
                            <div class="week-day-meal-meta">${meal.status === 'cooked' ? '‚úÖ Cooked' : 'Planned'}</div>
                        </div>
                        <div class="week-day-meal-actions">
                            <button class="icon-btn" onclick="viewMealForDay('${dateStr}')" title="View">üëÅÔ∏è</button>
                            <button class="icon-btn" onclick="changeMealForDay('${dateStr}')" title="Change">‚úèÔ∏è</button>
                            <button class="icon-btn" onclick="removeMealForDay('${dateStr}')" title="Remove">üóëÔ∏è</button>
                        </div>
                    </div>
                ` : `
                    <div class="week-day-empty" onclick="openAddMealForDay('${dateStr}', '${day}')">
                        + Add Meal
                    </div>
                `}
            </div>
        `;
    });

    container.innerHTML = html;
    empty.classList.toggle('hidden', hasAnyMeals || state.currentWeekOffset !== 0);
}

function openAddMealForDay(dateStr, dayName) {
    openModal(`
        <div class="modal-header">
            <h2 class="modal-title">Add Meal for ${dayName}</h2>
            <button class="modal-close" onclick="closeModal()">√ó</button>
        </div>
        <div class="modal-body">
            <div class="more-menu">
                <button class="more-menu-item" onclick="closeModal(); askNonna('Suggest a meal for ${dayName}');">
                    <span class="icon">ü§ñ</span>
                    <div class="more-menu-item-content">
                        <div class="more-menu-item-title">Ask Nonna</div>
                        <div class="more-menu-item-desc">Get a suggestion</div>
                    </div>
                </button>
                <button class="more-menu-item" onclick="closeModal(); openChooseFromFavorites('${dateStr}');">
                    <span class="icon">‚ù§Ô∏è</span>
                    <div class="more-menu-item-content">
                        <div class="more-menu-item-title">From Favorites</div>
                        <div class="more-menu-item-desc">Choose a saved recipe</div>
                    </div>
                </button>
                <button class="more-menu-item" onclick="closeModal(); openChooseFromLibrary('${dateStr}');">
                    <span class="icon">üìö</span>
                    <div class="more-menu-item-content">
                        <div class="more-menu-item-title">From Library</div>
                        <div class="more-menu-item-desc">Browse all recipes</div>
                    </div>
                </button>
                <button class="more-menu-item" onclick="closeModal(); openManualMealEntry('${dateStr}');">
                    <span class="icon">‚úèÔ∏è</span>
                    <div class="more-menu-item-content">
                        <div class="more-menu-item-title">Manual Entry</div>
                        <div class="more-menu-item-desc">Type a meal name</div>
                    </div>
                </button>
            </div>
        </div>
    `);
}

function openManualMealEntry(dateStr) {
    openModal(`
        <div class="modal-header">
            <h2 class="modal-title">Add Meal</h2>
            <button class="modal-close" onclick="closeModal()">√ó</button>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label>Meal Name</label>
                <input type="text" class="form-input" id="manual-meal-input" placeholder="e.g., Grilled Salmon">
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
            <button class="btn btn-primary" onclick="saveManualMeal('${dateStr}')">Add</button>
        </div>
    `);
    setTimeout(() => document.getElementById('manual-meal-input').focus(), 100);
}

function saveManualMeal(dateStr) {
    const input = document.getElementById('manual-meal-input');
    const title = input.value.trim();
    if (!title) return;

    const mealPlans = getStorage(STORAGE.MEAL_PLANS) || {};
    mealPlans[dateStr] = { title, recipeId: null, status: 'planned' };
    setStorage(STORAGE.MEAL_PLANS, mealPlans);
    closeModal();
    renderWeekPlanner();
    showToast('‚úÖ Meal added!');
}

function openChooseFromLibrary(dateStr) {
    const library = getRecipeLibrary();
    if (library.length === 0) {
        showToast('No recipes in library. Chat with Nonna first!');
        return;
    }

    openModal(`
        <div class="modal-header">
            <h2 class="modal-title">Choose Recipe</h2>
            <button class="modal-close" onclick="closeModal()">√ó</button>
        </div>
        <div class="modal-body" style="max-height: 60vh; overflow-y: auto;">
            ${library.map(r => `
                <div class="more-menu-item" style="margin-bottom: 8px;" onclick="addRecipeToDay('${dateStr}', '${r.id}')">
                    <span class="icon">üçΩÔ∏è</span>
                    <div class="more-menu-item-content">
                        <div class="more-menu-item-title">${r.title}</div>
                        <div class="more-menu-item-desc">${r.metadata?.totalTime || 30} min</div>
                    </div>
                </div>
            `).join('')}
        </div>
    `);
}

function openChooseFromFavorites(dateStr) {
    const favorites = getFavorites();
    if (favorites.length === 0) {
        showToast('No favorites yet. Heart some recipes first!');
        return;
    }
    openModal(`
        <div class="modal-header">
            <h2 class="modal-title">Choose Favorite</h2>
            <button class="modal-close" onclick="closeModal()">√ó</button>
        </div>
        <div class="modal-body" style="max-height: 60vh; overflow-y: auto;">
            ${favorites.map(r => `
                <div class="more-menu-item" style="margin-bottom: 8px;" onclick="addRecipeToDay('${dateStr}', '${r.id}')">
                    <span class="icon">‚ù§Ô∏è</span>
                    <div class="more-menu-item-content">
                        <div class="more-menu-item-title">${r.title}</div>
                    </div>
                </div>
            `).join('')}
        </div>
    `);
}

function addRecipeToDay(dateStr, recipeId) {
    const library = getRecipeLibrary();
    const recipe = library.find(r => r.id === recipeId);
    if (!recipe) return;

    const mealPlans = getStorage(STORAGE.MEAL_PLANS) || {};
    mealPlans[dateStr] = { title: recipe.title, recipeId: recipeId, status: 'planned' };
    setStorage(STORAGE.MEAL_PLANS, mealPlans);
    closeModal();
    renderWeekPlanner();
    showToast('‚úÖ Added to plan!');
}

function openAddToWeekModal(recipeId) {
    const library = getRecipeLibrary();
    const recipe = library.find(r => r.id === recipeId);
    if (!recipe) return;

    const weekDates = getWeekDates(state.currentWeekOffset);
    const days = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];

    openModal(`
        <div class="modal-header">
            <h2 class="modal-title">Add to Week</h2>
            <button class="modal-close" onclick="closeModal()">√ó</button>
        </div>
        <div class="modal-body">
            <p class="mb-16">Add "${recipe.title}" to which day?</p>
            <div class="day-picker">
                ${weekDates.map((dateStr, i) => {
                    const d = new Date(dateStr + 'T12:00:00');
                    return `
                        <div class="day-picker-item" onclick="addRecipeToDay('${dateStr}', '${recipeId}')">
                            <div class="day-name">${days[i]}</div>
                            <div class="day-num">${d.getDate()}</div>
                        </div>
                    `;
                }).join('')}
            </div>
        </div>
    `);
}

function removeMealForDay(dateStr) {
    const mealPlans = getStorage(STORAGE.MEAL_PLANS) || {};
    delete mealPlans[dateStr];
    setStorage(STORAGE.MEAL_PLANS, mealPlans);
    renderWeekPlanner();
    showToast('Meal removed');
}

function viewMealForDay(dateStr) {
    const mealPlans = getStorage(STORAGE.MEAL_PLANS) || {};
    const meal = mealPlans[dateStr];
    if (!meal) return;

    if (meal.recipeId) {
        viewRecipeDetail(meal.recipeId);
    } else {
        showToast(`Planned: ${meal.title}`);
    }
}

function changeMealForDay(dateStr) {
    const d = new Date(dateStr + 'T12:00:00');
    const dayName = d.toLocaleDateString('en-US', { weekday: 'long' });
    openAddMealForDay(dateStr, dayName);
}

function askNonnaForWeekPlan() {
    const weekDates = getWeekDates(state.currentWeekOffset);
    const startDate = new Date(weekDates[0] + 'T12:00:00');
    const endDate = new Date(weekDates[6] + 'T12:00:00');
    const startStr = startDate.toLocaleDateString('en-US', { month: 'long', day: 'numeric' });
    const endStr = endDate.toLocaleDateString('en-US', { month: 'long', day: 'numeric' });

    askNonna(`Plan my meals for the week of ${startStr} to ${endStr}. Give me a complete 7-day dinner plan.`);
}

function generateWeekShoppingList() {
    const mealPlans = getStorage(STORAGE.MEAL_PLANS) || {};
    const weekDates = getWeekDates(state.currentWeekOffset);
    const library = getRecipeLibrary();
    const ingredients = [];

    weekDates.forEach(dateStr => {
        const meal = mealPlans[dateStr];
        if (meal && meal.recipeId) {
            const recipe = library.find(r => r.id === meal.recipeId);
            if (recipe && recipe.ingredients) {
                ingredients.push(...recipe.ingredients);
            }
        }
    });

    if (ingredients.length === 0) {
        showToast('No recipes with ingredients in your plan');
        return;
    }

    // Save as shopping list
    const shoppingLists = getStorage(STORAGE.SHOPPING) || { weekly: [] };
    shoppingLists['week-plan'] = ingredients.map(ing => ({ name: ing, checked: false }));
    setStorage(STORAGE.SHOPPING, shoppingLists);

    navigateTo('more');
    switchMoreTab('kitchen');
    setTimeout(() => {
        document.getElementById('shopping-list-select').value = 'week-plan';
        loadShoppingList();
    }, 100);
    showToast('üõí Shopping list created from meal plan!');
}

function showPrepChecklist() {
    askNonna('Create a batch cooking prep checklist for my planned meals this week. What can I prepare ahead of time on Sunday?');
}

// ========================================
// KITCHEN - PANTRY
// ========================================
function renderPantry() {
    const pantry = getStorage(STORAGE.PANTRY) || [];
    const container = document.getElementById('pantry-list');
    const empty = document.getElementById('pantry-empty');

    if (pantry.length === 0) {
        container.innerHTML = '';
        empty.classList.remove('hidden');
        return;
    }

    empty.classList.add('hidden');
    container.innerHTML = pantry.map((item, i) => `
        <div class="pantry-item">
            <span class="pantry-item-icon">${item.icon || 'ü•´'}</span>
            <div class="pantry-item-info">
                <div class="pantry-item-name">${item.name}</div>
                <div class="pantry-item-qty">${item.qty || ''}</div>
            </div>
            <span class="pantry-status ${item.status || 'fresh'}"></span>
            <button class="icon-btn" onclick="removePantryItem(${i})">üóëÔ∏è</button>
        </div>
    `).join('');
}

function openAddPantryModal() {
    openModal(`
        <div class="modal-header">
            <h2 class="modal-title">Add Pantry Item</h2>
            <button class="modal-close" onclick="closeModal()">√ó</button>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label>Item Name</label>
                <input type="text" class="form-input" id="pantry-item-name" placeholder="e.g., Olive oil">
            </div>
            <div class="form-group">
                <label>Quantity (optional)</label>
                <input type="text" class="form-input" id="pantry-item-qty" placeholder="e.g., 1 bottle">
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
            <button class="btn btn-primary" onclick="savePantryItem()">Add</button>
        </div>
    `);
}

function savePantryItem() {
    const name = document.getElementById('pantry-item-name').value.trim();
    const qty = document.getElementById('pantry-item-qty').value.trim();
    if (!name) return;

    const pantry = getStorage(STORAGE.PANTRY) || [];
    pantry.push({ name, qty, icon: 'ü•´', status: 'fresh' });
    setStorage(STORAGE.PANTRY, pantry);
    closeModal();
    renderPantry();
    showToast('Item added!');
}

function removePantryItem(index) {
    const pantry = getStorage(STORAGE.PANTRY) || [];
    pantry.splice(index, 1);
    setStorage(STORAGE.PANTRY, pantry);
    renderPantry();
}

function askNonnaWithPantry() {
    const pantry = getStorage(STORAGE.PANTRY) || [];
    if (pantry.length === 0) {
        askNonna('What are some pantry staples I should keep for Mediterranean cooking?');
    } else {
        const items = pantry.map(p => p.name).join(', ');
        askNonna(`What can I make with these pantry items: ${items}?`);
    }
}

// ========================================
// KITCHEN - SHOPPING
// ========================================
function loadShoppingList() {
    const listName = document.getElementById('shopping-list-select').value;
    const lists = getStorage(STORAGE.SHOPPING) || { weekly: [] };
    const items = lists[listName] || [];
    const container = document.getElementById('shopping-list');
    const empty = document.getElementById('shopping-empty');

    if (items.length === 0) {
        container.innerHTML = '';
        empty.classList.remove('hidden');
        return;
    }

    empty.classList.add('hidden');
    container.innerHTML = items.map((item, i) => `
        <div class="shopping-item ${item.checked ? 'checked' : ''}">
            <input type="checkbox" class="shopping-item-checkbox" ${item.checked ? 'checked' : ''} onchange="toggleShoppingItem('${listName}', ${i})">
            <span class="shopping-item-name">${item.name}</span>
        </div>
    `).join('');
}

function toggleShoppingItem(listName, index) {
    const lists = getStorage(STORAGE.SHOPPING) || {};
    if (lists[listName] && lists[listName][index]) {
        lists[listName][index].checked = !lists[listName][index].checked;
        setStorage(STORAGE.SHOPPING, lists);
        loadShoppingList();
    }
}

function openAddShoppingModal() {
    openModal(`
        <div class="modal-header">
            <h2 class="modal-title">Add Item</h2>
            <button class="modal-close" onclick="closeModal()">√ó</button>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label>Item</label>
                <input type="text" class="form-input" id="shopping-item-input" placeholder="e.g., 2 lbs salmon">
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
            <button class="btn btn-primary" onclick="saveShoppingItem()">Add</button>
        </div>
    `);
}

function saveShoppingItem() {
    const name = document.getElementById('shopping-item-input').value.trim();
    if (!name) return;

    const listName = document.getElementById('shopping-list-select').value;
    const lists = getStorage(STORAGE.SHOPPING) || { weekly: [] };
    if (!lists[listName]) lists[listName] = [];
    lists[listName].push({ name, checked: false });
    setStorage(STORAGE.SHOPPING, lists);
    closeModal();
    loadShoppingList();
}

function clearCheckedItems() {
    const listName = document.getElementById('shopping-list-select').value;
    const lists = getStorage(STORAGE.SHOPPING) || {};
    if (lists[listName]) {
        lists[listName] = lists[listName].filter(item => !item.checked);
        setStorage(STORAGE.SHOPPING, lists);
        loadShoppingList();
    }
}

function printShoppingList() {
    window.print();
}

// ========================================
// KITCHEN - BATCH COOKING
// ========================================
function generateBatchPlan() {
    const items = Array.from(document.querySelectorAll('[name="batchItems"]:checked')).map(c => c.value);
    const time = document.getElementById('batch-time').value;

    if (items.length === 0) {
        showToast('Select items to prep');
        return;
    }

    askNonna(`Create a batch cooking plan for: ${items.join(', ')}. I have ${time} hours available. Give me a step-by-step timeline.`);
}

// ========================================
// KITCHEN - SUBSTITUTIONS
// ========================================
function searchSubstitutions() {
    const query = document.getElementById('subs-search').value.toLowerCase();
    const resultsDiv = document.getElementById('subs-results');

    if (!query) {
        resultsDiv.innerHTML = '';
        return;
    }

    const subs = {
        'butter': 'Olive oil (use 3/4 the amount), coconut oil, or avocado',
        'milk': 'Oat milk, almond milk, or coconut milk',
        'cream': 'Coconut cream or cashew cream',
        'lemon': 'Lime juice or white wine vinegar with a pinch of sugar',
        'garlic': '1/4 tsp garlic powder per clove, or shallots',
        'onion': 'Shallots, leeks, or 1 tsp onion powder',
        'tomato': 'Red bell pepper puree or pumpkin puree',
        'basil': 'Oregano, parsley, or mint',
        'chicken broth': 'Vegetable broth or water with miso',
        'wine': 'Broth + splash of vinegar',
        'parmesan': 'Pecorino romano or nutritional yeast',
        'feta': 'Goat cheese or ricotta salata',
        'egg': 'Flax egg (1 tbsp ground flax + 3 tbsp water)'
    };

    const matches = Object.entries(subs).filter(([key]) => key.includes(query));

    if (matches.length > 0) {
        resultsDiv.innerHTML = matches.map(([key, value]) => `
            <div class="card" style="padding: 12px; margin-bottom: 8px;">
                <strong>${key}</strong> ‚Üí ${value}
            </div>
        `).join('');
    } else {
        resultsDiv.innerHTML = '<p class="text-muted">No substitution found. Ask Nonna!</p>';
    }
}

function toggleAccordion(header) {
    header.parentElement.classList.toggle('open');
}

function switchKitchenTab(tab) {
    document.querySelectorAll('#more-kitchen .tab').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('#more-kitchen .tab-content').forEach(c => c.classList.remove('active'));

    const tabBtn = Array.from(document.querySelectorAll('#more-kitchen .tab')).find(t => t.textContent.toLowerCase().includes(tab));
    if (tabBtn) tabBtn.classList.add('active');

    document.getElementById(`kitchen-${tab}`).classList.add('active');

    if (tab === 'pantry') renderPantry();
    if (tab === 'shopping') loadShoppingList();
}

// ========================================
// GARDEN
// ========================================
function renderGarden() {
    const profile = getStorage(STORAGE.PROFILE);
    const container = document.getElementById('garden-plants');

    if (!profile || !profile.currentlyGrowing) {
        container.innerHTML = '<p class="text-muted">No plants added. Update your profile or add plants here.</p>';
        return;
    }

    const plants = profile.currentlyGrowing.split(',').map(p => p.trim()).filter(p => p);
    container.innerHTML = plants.map(plant => `
        <div class="pantry-item">
            <span class="pantry-item-icon">üå±</span>
            <div class="pantry-item-info">
                <div class="pantry-item-name">${plant}</div>
            </div>
        </div>
    `).join('');
}

function openAddPlantModal() {
    openModal(`
        <div class="modal-header">
            <h2 class="modal-title">Add Plant</h2>
            <button class="modal-close" onclick="closeModal()">√ó</button>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label>Plant Name</label>
                <input type="text" class="form-input" id="plant-name-input" placeholder="e.g., Tomatoes">
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
            <button class="btn btn-primary" onclick="savePlant()">Add</button>
        </div>
    `);
}

function savePlant() {
    const name = document.getElementById('plant-name-input').value.trim();
    if (!name) return;

    const profile = getStorage(STORAGE.PROFILE) || {};
    const current = profile.currentlyGrowing || '';
    profile.currentlyGrowing = current ? `${current}, ${name}` : name;
    setStorage(STORAGE.PROFILE, profile);
    closeModal();
    renderGarden();
    showToast('Plant added!');
}

function askNonnaWithGarden() {
    const profile = getStorage(STORAGE.PROFILE);
    if (profile && profile.currentlyGrowing) {
        askNonna(`What recipes can I make with these garden items: ${profile.currentlyGrowing}?`);
    } else {
        askNonna('What should I plant in my Mediterranean herb garden?');
    }
}

function switchGardenTab(tab) {
    document.querySelectorAll('#more-garden .tab').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('#more-garden .tab-content').forEach(c => c.classList.remove('active'));

    const tabBtn = Array.from(document.querySelectorAll('#more-garden .tab')).find(t => t.textContent.toLowerCase().includes(tab.substring(0, 4)));
    if (tabBtn) tabBtn.classList.add('active');

    document.getElementById(`garden-${tab}`).classList.add('active');
}

function openLogHarvestModal() {
    openModal(`
        <div class="modal-header">
            <h2 class="modal-title">Log Harvest</h2>
            <button class="modal-close" onclick="closeModal()">√ó</button>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label>What did you harvest?</label>
                <input type="text" class="form-input" id="harvest-item" placeholder="e.g., Tomatoes">
            </div>
            <div class="form-group">
                <label>Amount</label>
                <input type="text" class="form-input" id="harvest-amount" placeholder="e.g., 2 lbs">
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
            <button class="btn btn-primary" onclick="saveHarvest()">Log</button>
        </div>
    `);
}

function saveHarvest() {
    const item = document.getElementById('harvest-item').value.trim();
    const amount = document.getElementById('harvest-amount').value.trim();
    if (!item) return;

    const garden = getStorage(STORAGE.GARDEN) || { harvests: [] };
    garden.harvests.push({ item, amount, date: new Date().toISOString() });
    setStorage(STORAGE.GARDEN, garden);
    closeModal();
    showToast('Harvest logged!');
}

// ========================================
// CROHN'S CARE
// ========================================
function activateFlareMode() {
    state.flareMode = true;
    const prefs = getStorage(STORAGE.PREFS) || {};
    prefs.flareMode = true;
    setStorage(STORAGE.PREFS, prefs);
    updateFlareUI();
    showToast('üå°Ô∏è Flare mode activated. Nonna will suggest gentle meals.');
    navigateTo('chat');
    askNonna("I'm having a Crohn's flare. Give me some gentle meal options for today.");
}

function deactivateFlareMode() {
    state.flareMode = false;
    const prefs = getStorage(STORAGE.PREFS) || {};
    prefs.flareMode = false;
    setStorage(STORAGE.PREFS, prefs);
    updateFlareUI();
    showToast('Flare mode deactivated');
}

function updateFlareUI() {
    const banner = document.getElementById('flare-mode-banner');
    const homeBanner = document.getElementById('home-flare-banner');
    if (banner) banner.classList.toggle('hidden', !state.flareMode);
    if (homeBanner) homeBanner.classList.toggle('hidden', !state.flareMode);
}

// ========================================
// MEAL HISTORY
// ========================================
function renderHistory() {
    const history = getStorage(STORAGE.HISTORY) || [];
    const container = document.getElementById('history-list');
    const empty = document.getElementById('history-empty');

    // Stats
    const now = new Date();
    const weekAgo = new Date(now - 7 * 24 * 60 * 60 * 1000);
    const monthAgo = new Date(now - 30 * 24 * 60 * 60 * 1000);

    const weekCount = history.filter(h => new Date(h.date) > weekAgo).length;
    const monthCount = history.filter(h => new Date(h.date) > monthAgo).length;

    document.getElementById('stat-week').textContent = weekCount;
    document.getElementById('stat-month').textContent = monthCount;

    if (history.length === 0) {
        container.innerHTML = '';
        empty.classList.remove('hidden');
        return;
    }

    empty.classList.add('hidden');
    container.innerHTML = history.slice(0, 20).map(item => `
        <div class="activity-item">
            <span class="activity-icon">üçΩÔ∏è</span>
            <div class="activity-content">
                <div class="activity-title">${item.title}</div>
                <div class="activity-time">${formatRelativeDate(item.date)}</div>
            </div>
            ${item.rating ? `<span style="color: #ffc107;">${'‚≠ê'.repeat(item.rating)}</span>` : ''}
        </div>
    `).join('');
}

function markAsCooked(recipeId, title) {
    const history = getStorage(STORAGE.HISTORY) || [];
    history.unshift({
        type: 'cooked',
        title: title,
        recipeId: recipeId,
        date: new Date().toISOString(),
        rating: 0
    });
    setStorage(STORAGE.HISTORY, history);

    // Update recipe times cooked
    const library = getRecipeLibrary();
    const recipe = library.find(r => r.id === recipeId);
    if (recipe) {
        recipe.timesCooked = (recipe.timesCooked || 0) + 1;
        recipe.lastCooked = new Date().toISOString();
        setStorage(STORAGE.RECIPES, library);
    }

    showToast('‚úÖ Marked as cooked! Great job, cara!');
}

function openAddMealModal() {
    openModal(`
        <div class="modal-header">
            <h2 class="modal-title">Log Meal</h2>
            <button class="modal-close" onclick="closeModal()">√ó</button>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label>What did you eat?</label>
                <input type="text" class="form-input" id="log-meal-input" placeholder="e.g., Grilled chicken salad">
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
            <button class="btn btn-primary" onclick="logMealManual()">Log</button>
        </div>
    `);
}

function logMealManual() {
    const title = document.getElementById('log-meal-input').value.trim();
    if (!title) return;

    const history = getStorage(STORAGE.HISTORY) || [];
    history.unshift({
        type: 'cooked',
        title: title,
        date: new Date().toISOString()
    });
    setStorage(STORAGE.HISTORY, history);
    closeModal();
    renderHistory();
    showToast('Meal logged!');
}

function addActivity(type, title) {
    const history = getStorage(STORAGE.HISTORY) || [];
    history.unshift({ type, title, date: new Date().toISOString() });
    setStorage(STORAGE.HISTORY, history.slice(0, 100)); // Keep last 100
}

// ========================================
// MODALS
// ========================================
function openModal(content) {
    document.getElementById('modal-content').innerHTML = content;
    document.getElementById('modal-overlay').classList.add('active');
}

function closeModal() {
    document.getElementById('modal-overlay').classList.remove('active');
}

function closeModalOnOverlay(event) {
    if (event.target.id === 'modal-overlay') closeModal();
}

// ========================================
// TOAST
// ========================================
function showToast(message) {
    const toast = document.getElementById('toast');
    toast.textContent = message;
    toast.classList.add('show');
    setTimeout(() => toast.classList.remove('show'), 3000);
}

// ========================================
// HELPERS
// ========================================
function formatDate(dateStr) {
    const date = new Date(dateStr);
    return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
}

function formatRelativeDate(dateStr) {
    const date = new Date(dateStr);
    const now = new Date();
    const diffMs = now - date;
    const diffDays = Math.floor(diffMs / (24 * 60 * 60 * 1000));

    if (diffDays === 0) return 'Today';
    if (diffDays === 1) return 'Yesterday';
    if (diffDays < 7) return `${diffDays} days ago`;
    return formatDate(dateStr);
}

// ========================================
// GLOBAL SEARCH
// ========================================
function handleGlobalSearch(event) {
    if (event.key === 'Enter') {
        const query = event.target.value.trim();
        if (query) {
            navigateTo('recipes');
            document.getElementById('recipes-search').value = query;
            filterRecipeLibrary();
        }
    }
}

// ========================================
// DATA MANAGEMENT
// ========================================
function exportAllData() {
    const data = {
        profile: getStorage(STORAGE.PROFILE),
        recipes: getStorage(STORAGE.RECIPES),
        favorites: getStorage(STORAGE.FAVORITES),
        mealPlans: getStorage(STORAGE.MEAL_PLANS),
        history: getStorage(STORAGE.HISTORY),
        pantry: getStorage(STORAGE.PANTRY),
        shopping: getStorage(STORAGE.SHOPPING),
        garden: getStorage(STORAGE.GARDEN),
        prefs: getStorage(STORAGE.PREFS),
        exportDate: new Date().toISOString()
    };

    const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `tavola-backup-${new Date().toISOString().split('T')[0]}.json`;
    a.click();
    URL.revokeObjectURL(url);
    showToast('Data exported!');
}

function importData() {
    const input = document.createElement('input');
    input.type = 'file';
    input.accept = '.json';
    input.onchange = async (e) => {
        const file = e.target.files[0];
        if (!file) return;

        try {
            const text = await file.text();
            const data = JSON.parse(text);

            if (data.profile) setStorage(STORAGE.PROFILE, data.profile);
            if (data.recipes) setStorage(STORAGE.RECIPES, data.recipes);
            if (data.mealPlans) setStorage(STORAGE.MEAL_PLANS, data.mealPlans);
            if (data.history) setStorage(STORAGE.HISTORY, data.history);
            if (data.pantry) setStorage(STORAGE.PANTRY, data.pantry);
            if (data.shopping) setStorage(STORAGE.SHOPPING, data.shopping);
            if (data.garden) setStorage(STORAGE.GARDEN, data.garden);
            if (data.prefs) setStorage(STORAGE.PREFS, data.prefs);

            showToast('Data imported! Refreshing...');
            setTimeout(() => location.reload(), 1000);
        } catch (err) {
            showToast('Error importing data');
        }
    };
    input.click();
}

function confirmClearAllData() {
    openModal(`
        <div class="modal-header">
            <h2 class="modal-title">‚ö†Ô∏è Clear All Data?</h2>
            <button class="modal-close" onclick="closeModal()">√ó</button>
        </div>
        <div class="modal-body">
            <p>This will delete all your recipes, meal plans, history, and settings. This cannot be undone.</p>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
            <button class="btn" style="background: var(--danger); color: white;" onclick="clearAllData()">Delete Everything</button>
        </div>
    `);
}

function clearAllData() {
    Object.values(STORAGE).forEach(key => localStorage.removeItem(key));
    closeModal();
    location.reload();
}

// ========================================
// ONBOARDING
// ========================================
const onboardingSteps = [
    { icon: 'üëã', title: 'Welcome to Tavola!', text: 'Let me show you around - it\'ll just take a minute!' },
    { icon: 'üè†', title: 'Dashboard', text: 'This is your home base. Quick access to everything you need.' },
    { icon: 'üìÖ', title: 'This Week', text: 'Plan your weekly meals here. Nonna can generate a complete plan based on your health profile.' },
    { icon: 'üìö', title: 'Recipe Library', text: 'Every recipe Nonna creates is saved here. Favorite the ones you love!' },
    { icon: 'üí¨', title: 'Chat with Nonna', text: 'Ask me anything! "What should I make with my tomatoes?" or "I\'m having a flare, give me gentle meals."' }
];

let onboardingStep = 0;

function startOnboarding() {
    onboardingStep = 0;
    document.getElementById('onboarding-overlay').classList.add('active');
    renderOnboardingStep();
}

function renderOnboardingStep() {
    const step = onboardingSteps[onboardingStep];
    const card = document.getElementById('onboarding-card');

    card.innerHTML = `
        <div class="onboarding-icon">${step.icon}</div>
        <h2 class="onboarding-title">${step.title}</h2>
        <p class="onboarding-text">${step.text}</p>
        <div class="onboarding-dots">
            ${onboardingSteps.map((_, i) => `<div class="onboarding-dot ${i === onboardingStep ? 'active' : ''}"></div>`).join('')}
        </div>
        <div class="onboarding-actions">
            ${onboardingStep > 0 ? '<button class="btn btn-ghost" onclick="prevOnboarding()">Back</button>' : ''}
            ${onboardingStep < onboardingSteps.length - 1 ?
                '<button class="btn btn-primary" onclick="nextOnboarding()">Next ‚Üí</button>' :
                '<button class="btn btn-primary" onclick="finishOnboarding()">Get Started!</button>'
            }
        </div>
        <button class="btn btn-ghost" onclick="skipOnboarding()" style="margin-top: 12px; font-size: 0.85rem;">Skip tour</button>
    `;
}

function nextOnboarding() {
    if (onboardingStep < onboardingSteps.length - 1) {
        onboardingStep++;
        renderOnboardingStep();
    }
}

function prevOnboarding() {
    if (onboardingStep > 0) {
        onboardingStep--;
        renderOnboardingStep();
    }
}

function finishOnboarding() {
    setStorage(STORAGE.ONBOARDING, true);
    document.getElementById('onboarding-overlay').classList.remove('active');
}

function skipOnboarding() {
    setStorage(STORAGE.ONBOARDING, true);
    document.getElementById('onboarding-overlay').classList.remove('active');
}

// ========================================
// COOK MODE
// ========================================
function startCookMode(recipeId) {
    const library = getRecipeLibrary();
    const recipe = library.find(r => r.id === recipeId);
    if (!recipe || !recipe.instructions || recipe.instructions.length === 0) {
        showToast('No instructions available for cook mode');
        return;
    }

    state.cookMode = { active: true, recipe, currentStep: 0 };
    document.getElementById('cook-mode-overlay').classList.add('active');
    renderCookModeStep();
}

function renderCookModeStep() {
    const { recipe, currentStep } = state.cookMode;
    const body = document.getElementById('cook-mode-body');
    const progress = document.getElementById('cook-mode-progress');

    progress.textContent = `Step ${currentStep + 1} of ${recipe.instructions.length}`;

    body.innerHTML = `
        <details class="cook-mode-ingredients">
            <summary>üìù Ingredients (tap to expand)</summary>
            <ul style="margin-top: 12px; padding-left: 20px;">
                ${recipe.ingredients.map(i => `<li>${i}</li>`).join('')}
            </ul>
        </details>
        <div class="cook-mode-step">
            <div class="cook-mode-step-check">
                <input type="checkbox" id="step-check-${currentStep}">
                <label for="step-check-${currentStep}">${recipe.instructions[currentStep]}</label>
            </div>
            ${recipe.instructions[currentStep].match(/\d+\s*(min|minute)/i) ?
                `<div class="cook-mode-timer" onclick="startTimer()">‚è±Ô∏è Start Timer</div>` : ''}
        </div>
    `;

    // Update nav buttons
    document.getElementById('cook-prev-btn').disabled = currentStep === 0;
    document.getElementById('cook-next-btn').textContent = currentStep === recipe.instructions.length - 1 ? 'Finish' : 'Next ‚Üí';
}

function cookModeNext() {
    const { recipe, currentStep } = state.cookMode;
    if (currentStep < recipe.instructions.length - 1) {
        state.cookMode.currentStep++;
        renderCookModeStep();
    } else {
        exitCookMode();
        markAsCooked(recipe.id, recipe.title);
    }
}

function cookModePrev() {
    if (state.cookMode.currentStep > 0) {
        state.cookMode.currentStep--;
        renderCookModeStep();
    }
}

function exitCookMode() {
    state.cookMode = { active: false, recipe: null, currentStep: 0 };
    document.getElementById('cook-mode-overlay').classList.remove('active');
}

function startTimer() {
    showToast('‚è±Ô∏è Timer feature coming soon!');
}

// ========================================
// RECIPE CARD MORE MENU
// ========================================
function openRecipeMoreMenu(recipeId) {
    openModal(`
        <div class="modal-header">
            <h2 class="modal-title">Recipe Options</h2>
            <button class="modal-close" onclick="closeModal()">√ó</button>
        </div>
        <div class="modal-body">
            <div class="more-menu">
                <button class="more-menu-item" onclick="closeModal(); addIngredientsToShopping('${recipeId}');">
                    <span class="icon">üõí</span>
                    <div class="more-menu-item-content">
                        <div class="more-menu-item-title">Add to Shopping List</div>
                    </div>
                </button>
                <button class="more-menu-item" onclick="closeModal(); startCookMode('${recipeId}');">
                    <span class="icon">üë®‚Äçüç≥</span>
                    <div class="more-menu-item-content">
                        <div class="more-menu-item-title">Start Cook Mode</div>
                    </div>
                </button>
                <button class="more-menu-item" onclick="closeModal(); printRecipe('${recipeId}');">
                    <span class="icon">üñ®Ô∏è</span>
                    <div class="more-menu-item-content">
                        <div class="more-menu-item-title">Print Recipe</div>
                    </div>
                </button>
                <button class="more-menu-item" onclick="closeModal(); deleteRecipe('${recipeId}');">
                    <span class="icon">üóëÔ∏è</span>
                    <div class="more-menu-item-content">
                        <div class="more-menu-item-title">Delete from Library</div>
                    </div>
                </button>
            </div>
        </div>
    `);
}

function addIngredientsToShopping(recipeId) {
    const library = getRecipeLibrary();
    const recipe = library.find(r => r.id === recipeId);
    if (!recipe || !recipe.ingredients) return;

    const lists = getStorage(STORAGE.SHOPPING) || { weekly: [] };
    recipe.ingredients.forEach(ing => {
        lists.weekly.push({ name: ing, checked: false });
    });
    setStorage(STORAGE.SHOPPING, lists);
    showToast('üõí Ingredients added to shopping list!');
}

function printRecipe(recipeId) {
    window.print();
}

function deleteRecipe(recipeId) {
    const library = getRecipeLibrary();
    const index = library.findIndex(r => r.id === recipeId);
    if (index >= 0) {
        library.splice(index, 1);
        setStorage(STORAGE.RECIPES, library);
        showToast('Recipe deleted');
        renderRecipeLibrary();
    }
}

// Close filter dropdown when clicking outside
document.addEventListener('click', (e) => {
    const dropdown = document.getElementById('recipe-filters');
    if (dropdown && !dropdown.contains(e.target)) {
        dropdown.classList.remove('open');
    }
});
</script>
</body>
</html>
